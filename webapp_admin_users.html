<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitleTag">Пользователи — Aaadviser Admin</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { background: #f8f9fa; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .container { max-width: 420px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(102,126,234,0.10); padding: 32px 20px 24px 20px; text-align: center; }
        .admin-title { font-size: 1.3em; font-weight: bold; margin-bottom: 18px; color: #333; }
        .stats-block { background: #f8f9fa; border-radius: 12px; padding: 18px 16px; margin: 18px 0; text-align: left; box-shadow: 0 2px 8px rgba(102,126,234,0.07); }
        .stats-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 10px; }
        .stats-list { font-size: 1em; color: #222; line-height: 1.7; }
        .nav-btn-row { display: flex; gap: 10px; margin-top: 28px; }
        .nav-btn { flex: 1; padding: 14px 0; border: none; border-radius: 10px; font-size: 1em; font-weight: 500; cursor: pointer; background: #f1f1f1; color: #333; transition: background 0.2s; }
        .nav-btn:hover { background: #e2e2e2; }
        .nav-btn-main { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .nav-btn-main:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .loading { color: #888; margin: 30px 0; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .toast { background: #fff; border-radius: 8px; padding: 12px 18px; margin-bottom: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); border-left: 4px solid #28a745; display: flex; align-items: center; gap: 8px; animation: fadeIn 0.4s; }
        .toast.error { border-left-color: #dc3545; }
        .toast.info { border-left-color: #007bff; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-title" id="adminTitle">Статистика пользователей</div>
        <div class="stats-block">
            <div class="stats-title" id="generalStatsTitle">Общая статистика</div>
            <div class="stats-list" id="generalStats">
                <div class="loading" id="loadingText">Загрузка...</div>
            </div>
        </div>
        <div class="stats-block">
            <div class="stats-title" id="reportsStatsTitle">Отчёты пользователей</div>
            <div class="stats-list" id="reportsStats">
                <div class="loading" id="loadingText2">Загрузка...</div>
            </div>
        </div>
        <div class="nav-btn-row">
            <button class="nav-btn" onclick="goBack()" id="backBtn">Назад</button>
            <button class="nav-btn nav-btn-main" onclick="goToMainMenu()" id="mainMenuBtn">В главное меню</button>
        </div>
    </div>
    <div id="toastContainer" class="toast-container"></div>
    <script>
        function goBack() { window.history.back(); }
        function goToMainMenu() { window.location.href = '/webapp'; }
        function showToast(message, type = 'success', duration = 2500) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, duration);
        }
        // Динамическая загрузка статистики
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/admin_users_stats')
                .then(res => res.json())
                .then(data => {
                                    if (!data || data.error) {
                    document.getElementById('generalStats').innerHTML = `<div class="loading">${getText('statsLoadError')}</div>`;
                    document.getElementById('reportsStats').innerHTML = `<div class="loading">${getText('statsLoadError')}</div>`;
                    showToast(getText('statsLoadError'), 'error');
                    return;
                }
                showToast(getText('statsLoadSuccess'), 'success');
                    document.getElementById('generalStats').innerHTML = `
                        <b>${getText('totalUsers')}</b> ${data.total_users}<br>
                        <b>${getText('newUsersWeek')}</b> ${data.new_users_week}<br>
                        <b>${getText('newUsersMonth')}</b> ${data.new_users_month}<br>
                        <b>${getText('newUsersQuarter')}</b> ${data.new_users_quarter}<br>
                        <b>${getText('newUsersYear')}</b> ${data.new_users_year}<br>
                        <b>${getText('totalBalance')}</b> $${data.total_balance}<br>
                        <b>${getText('expiredBalance')}</b> $${data.expired_balance}<br>
                        <b>${getText('activeBalance')}</b> $${data.active_balance}<br>
                        <b>${getText('adminCount')}</b> ${data.admin_count}
                    `;
                    document.getElementById('reportsStats').innerHTML = `
                        <b>${getText('reportsWeek')}</b> ${data.reports_week}<br>
                        <b>${getText('reportsMonth')}</b> ${data.reports_month}<br>
                        <b>${getText('reportsQuarter')}</b> ${data.reports_quarter}<br>
                        <b>${getText('reportsYear')}</b> ${data.reports_year}<br>
                        <b>${getText('deletedReports')}</b> ${data.deleted_reports}<br>
                        <b>${getText('expiredReportsCount')}</b> ${data.expired_reports_count}<br>
                        <b>${getText('avgExpiredReports')}</b> ${data.avg_expired_reports.toFixed(2)}<br>
                        <b>${getText('activeReportsCount')}</b> ${data.active_reports_count}<br>
                        <b>${getText('activeReportsCost')}</b> $${data.active_reports_cost}
                    `;
                })
                .catch(() => {
                    document.getElementById('generalStats').innerHTML = `<div class="loading">${getText('networkError')}</div>`;
                    document.getElementById('reportsStats').innerHTML = `<div class="loading">${getText('networkError')}</div>`;
                    showToast(getText('networkError'), 'error');
                });
        });
    </script>

    <!-- Локализация -->
    <script>
        let currentLanguage = 'ru';
        
        // Получаем данные пользователя из Telegram
        async function getUserData() {
            try {
                const userData = window.Telegram.WebApp.initDataUnsafe.user;
                if (!userData) {
                    console.warn('Данные пользователя Telegram недоступны');
                    return null;
                }
                return userData;
            } catch (error) {
                console.error('Ошибка получения данных пользователя:', error);
                return null;
            }
        }
        
        // Словари локализации
        const locales = {
            ru: {
                pageTitleTag: 'Пользователи — Aaadviser Admin',
                adminTitle: 'Статистика пользователей',
                generalStatsTitle: 'Общая статистика',
                reportsStatsTitle: 'Отчёты пользователей',
                backBtn: 'Назад',
                mainMenuBtn: 'В главное меню',
                loadingText: 'Загрузка...',
                statsLoadError: 'Ошибка загрузки статистики',
                statsLoadSuccess: 'Статистика успешно загружена!',
                networkError: 'Ошибка сети',
                totalUsers: 'Всего пользователей:',
                newUsersWeek: 'Новых за неделю:',
                newUsersMonth: 'Новых за месяц:',
                newUsersQuarter: 'Новых за квартал:',
                newUsersYear: 'Новых за год:',
                totalBalance: 'Общий баланс:',
                expiredBalance: 'Баланс с period_end < сегодня или null:',
                activeBalance: 'Баланс остальных пользователей:',
                adminCount: 'Админов:',
                reportsWeek: 'Отчётов за неделю:',
                reportsMonth: 'Отчётов за месяц:',
                reportsQuarter: 'Отчётов за квартал:',
                reportsYear: 'Отчётов за год:',
                deletedReports: 'Удалённых отчётов:',
                expiredReportsCount: 'Отчётов пользователей с period_end < сегодня или null:',
                avgExpiredReports: 'Среднее отчётов на такого пользователя:',
                activeReportsCount: 'Отчётов остальных пользователей:',
                activeReportsCost: 'Потрачено денег (full):'
            },
            en: {
                pageTitleTag: 'Users — Aaadviser Admin',
                adminTitle: 'User Statistics',
                generalStatsTitle: 'General Statistics',
                reportsStatsTitle: 'User Reports',
                backBtn: 'Back',
                mainMenuBtn: 'To Main Menu',
                loadingText: 'Loading...',
                statsLoadError: 'Error loading statistics',
                statsLoadSuccess: 'Statistics loaded successfully!',
                networkError: 'Network error',
                totalUsers: 'Total users:',
                newUsersWeek: 'New this week:',
                newUsersMonth: 'New this month:',
                newUsersQuarter: 'New this quarter:',
                newUsersYear: 'New this year:',
                totalBalance: 'Total balance:',
                expiredBalance: 'Balance with period_end < today or null:',
                activeBalance: 'Balance of other users:',
                adminCount: 'Admins:',
                reportsWeek: 'Reports this week:',
                reportsMonth: 'Reports this month:',
                reportsQuarter: 'Reports this quarter:',
                reportsYear: 'Reports this year:',
                deletedReports: 'Deleted reports:',
                expiredReportsCount: 'Reports of users with period_end < today or null:',
                avgExpiredReports: 'Average reports per such user:',
                activeReportsCount: 'Reports of other users:',
                activeReportsCost: 'Money spent (full):'
            },
            de: {
                pageTitleTag: 'Benutzer — Aaadviser Admin',
                adminTitle: 'Benutzerstatistik',
                generalStatsTitle: 'Allgemeine Statistiken',
                reportsStatsTitle: 'Benutzerberichte',
                backBtn: 'Zurück',
                mainMenuBtn: 'Zum Hauptmenü',
                loadingText: 'Laden...',
                statsLoadError: 'Fehler beim Laden der Statistiken',
                statsLoadSuccess: 'Statistiken erfolgreich geladen!',
                networkError: 'Netzwerkfehler',
                totalUsers: 'Gesamte Benutzer:',
                newUsersWeek: 'Neu diese Woche:',
                newUsersMonth: 'Neu diesen Monat:',
                newUsersQuarter: 'Neu dieses Quartal:',
                newUsersYear: 'Neu dieses Jahr:',
                totalBalance: 'Gesamtes Guthaben:',
                expiredBalance: 'Guthaben mit period_end < heute oder null:',
                activeBalance: 'Guthaben anderer Benutzer:',
                adminCount: 'Admins:',
                reportsWeek: 'Berichte diese Woche:',
                reportsMonth: 'Berichte diesen Monat:',
                reportsQuarter: 'Berichte dieses Quartal:',
                reportsYear: 'Berichte dieses Jahr:',
                deletedReports: 'Gelöschte Berichte:',
                expiredReportsCount: 'Berichte von Benutzern mit period_end < heute oder null:',
                avgExpiredReports: 'Durchschnittliche Berichte pro solchem Benutzer:',
                activeReportsCount: 'Berichte anderer Benutzer:',
                activeReportsCost: 'Ausgegebenes Geld (voll):'
            },
            fr: {
                pageTitleTag: 'Utilisateurs — Aaadviser Admin',
                adminTitle: 'Statistiques des utilisateurs',
                generalStatsTitle: 'Statistiques générales',
                reportsStatsTitle: 'Rapports des utilisateurs',
                backBtn: 'Retour',
                mainMenuBtn: 'Au menu principal',
                loadingText: 'Chargement...',
                statsLoadError: 'Erreur de chargement des statistiques',
                statsLoadSuccess: 'Statistiques chargées avec succès !',
                networkError: 'Erreur réseau',
                totalUsers: 'Total des utilisateurs:',
                newUsersWeek: 'Nouveaux cette semaine:',
                newUsersMonth: 'Nouveaux ce mois:',
                newUsersQuarter: 'Nouveaux ce trimestre:',
                newUsersYear: 'Nouveaux cette année:',
                totalBalance: 'Solde total:',
                expiredBalance: 'Solde avec period_end < aujourd\'hui ou null:',
                activeBalance: 'Solde des autres utilisateurs:',
                adminCount: 'Admins:',
                reportsWeek: 'Rapports cette semaine:',
                reportsMonth: 'Rapports ce mois:',
                reportsQuarter: 'Rapports ce trimestre:',
                reportsYear: 'Rapports cette année:',
                deletedReports: 'Rapports supprimés:',
                expiredReportsCount: 'Rapports des utilisateurs avec period_end < aujourd\'hui ou null:',
                avgExpiredReports: 'Moyenne des rapports par tel utilisateur:',
                activeReportsCount: 'Rapports des autres utilisateurs:',
                activeReportsCost: 'Argent dépensé (complet):'
            },
            tr: {
                pageTitleTag: 'Kullanıcılar — Aaadviser Admin',
                adminTitle: 'Kullanıcı İstatistikleri',
                generalStatsTitle: 'Genel İstatistikler',
                reportsStatsTitle: 'Kullanıcı Raporları',
                backBtn: 'Geri',
                mainMenuBtn: 'Ana Menüye',
                loadingText: 'Yükleniyor...',
                statsLoadError: 'İstatistik yükleme hatası',
                statsLoadSuccess: 'İstatistikler başarıyla yüklendi!',
                networkError: 'Ağ hatası',
                totalUsers: 'Toplam kullanıcı:',
                newUsersWeek: 'Bu hafta yeni:',
                newUsersMonth: 'Bu ay yeni:',
                newUsersQuarter: 'Bu çeyrek yeni:',
                newUsersYear: 'Bu yıl yeni:',
                totalBalance: 'Toplam bakiye:',
                expiredBalance: 'period_end < bugün veya null olan bakiye:',
                activeBalance: 'Diğer kullanıcıların bakiyesi:',
                adminCount: 'Admin:',
                reportsWeek: 'Bu hafta raporlar:',
                reportsMonth: 'Bu ay raporlar:',
                reportsQuarter: 'Bu çeyrek raporlar:',
                reportsYear: 'Bu yıl raporlar:',
                deletedReports: 'Silinen raporlar:',
                expiredReportsCount: 'period_end < bugün veya null olan kullanıcıların raporları:',
                avgExpiredReports: 'Böyle kullanıcı başına ortalama rapor:',
                activeReportsCount: 'Diğer kullanıcıların raporları:',
                activeReportsCost: 'Harcanan para (tam):'
            }
        };
        
        // Функция получения текста по ключу
        function getText(key) {
            return locales[currentLanguage][key] || key;
        }
        
        // Функция обновления текста на странице
        function updatePageText() {
            // Обновляем title
            document.getElementById('pageTitleTag').textContent = getText('pageTitleTag');
            
            // Обновляем основные элементы
            const elements = [
                'adminTitle', 'generalStatsTitle', 'reportsStatsTitle', 'backBtn', 'mainMenuBtn'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = getText(id);
                }
            });
            
            // Обновляем текст загрузки
            const loadingElements = ['loadingText', 'loadingText2'];
            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = getText('loadingText');
                }
            });
        }
        
        // Функция инициализации локализации
        async function initLocalization() {
            try {
                const userData = await getUserData();
                if (userData && userData.language_code) {
                    // Проверяем, является ли пользователь админом
                    const response = await fetch('/api/user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            telegram_id: userData.id,
                            username: userData.username,
                            tg_name: userData.first_name,
                            last_name: userData.last_name,
                            language_code: userData.language_code
                        })
                    });
                    
                    if (response.ok) {
                        const userInfo = await response.json();
                        
                        // Устанавливаем язык в зависимости от статуса пользователя
                        if (userInfo.user_status === 'admin' && userInfo.language) {
                            // Для админов используем язык из базы данных
                            currentLanguage = userInfo.language;
                        } else if (userData.language_code) {
                            // Для обычных пользователей используем язык из Telegram
                            currentLanguage = userData.language_code;
                        }
                        
                        // Обновляем текст на странице с новым языком
                        updatePageText();
                    }
                }
            } catch (error) {
                console.error('Ошибка инициализации локализации:', error);
                // Используем русский язык по умолчанию
                currentLanguage = 'ru';
                updatePageText();
            }
        }
        
        // Инициализируем локализацию при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            initLocalization();
        });
    </script>
    <script src="/i18n-manager.js"></script>
</body>
</html> 