# üîç –ê–Ω–∞–ª–∏–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ –ª–æ–≥–∞–º

### ‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase –∫–ª–∏–µ–Ω—Ç–∞** (—Å—Ç—Ä–æ–∫–∏ 72-81 –≤ app.py):
   ```python
   supabase: Client = create_client(supabase_url, supabase_key)
   logger.info("‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ")
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ** (—Å—Ç—Ä–æ–∫–∏ 222-232 –≤ app.py):
   ```python
   logger.info("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase...")
   test_result = safe_db_operation(
       lambda: supabase.table('users').select('id').limit(1).execute()
   )
   ```

3. **–§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** `safe_db_operation` (—Å—Ç—Ä–æ–∫–∏ 173-219):
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç retry –ª–æ–≥–∏–∫—É (5 –ø–æ–ø—ã—Ç–æ–∫)
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã –∏ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏
   - –õ–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—É—é –ø–æ–ø—ã—Ç–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## üöÄ –ê–ª–≥–æ—Ä–∏—Ç–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞

### 1. **Frontend –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è** (`webapp_object_evaluation.html`):

```javascript
// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', init);

async function init() {
    // 1. –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await getUserLanguage();
    currentLanguage = userLanguage;
    
    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é
    updatePageText();
    
    // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω—ã
    loadCountries();
    
    // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
    // ...
}
```

### 2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**:

```javascript
async function getUserLanguage() {
    const response = await fetch('/api/user/language', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            telegram_id: user.id,
            language_code: user.language_code
        })
    });
}
```

### 3. **Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —è–∑—ã–∫–∞** (`/api/user/language`):

```python
@app.route('/api/user/language', methods=['POST'])
def api_user_language():
    # 1. –ü–æ–ª—É—á–∞–µ–º telegram_id –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
    telegram_id = data.get('telegram_id')
    
    # 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —á–µ—Ä–µ–∑ safe_db_operation
    result = safe_db_operation(
        lambda: supabase.table('users').select('language, user_status')
                .eq('telegram_id', telegram_id).execute()
    )
    
    # 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—É—é –ª–æ–≥–∏–∫—É
    user_language = determine_user_language(user, telegram_lang)
```

### 4. **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞** (`/api/region_data`):

```python
@app.route('/api/region_data', methods=['POST'])
def api_region_data():
    # 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ª–æ–∫–∞—Ü–∏–∏
    # 2. –ó–∞–ø—Ä–æ—Å—ã –∫ —Ç–∞–±–ª–∏—Ü–∞–º –ë–î:
    #    - general_data
    #    - house_type_data  
    #    - floor_segment_data
    #    - age_data
    #    - heating_data
    # 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
    # 4. –í–æ–∑–≤—Ä–∞—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

## üîÑ –°–∏—Å—Ç–µ–º–∞ retry –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### **safe_db_operation —Ñ—É–Ω–∫—Ü–∏—è:**

- **5 –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 5 —Å–µ–∫—É–Ω–¥
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤**: SSL/Network timeouts  
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏**: `üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î 1/5`
- **–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**: `‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ 1`

### **–¢–∏–ø—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –æ—à–∏–±–æ–∫:**
- `TimeoutException` - —Ç–∞–π–º–∞—É—Ç—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- `ConnectTimeout` - —Ç–∞–π–º–∞—É—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è  
- `ConnectionError` - –æ—à–∏–±–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- `OSError` - —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏

## üìà –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### **–ò–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –ª–æ–≥–∞ –≤–∏–¥–Ω–æ:**

1. **‚úÖ –Ø–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:**
   ```
   ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —è–∑—ã–∫ –∏–∑ –ë–î: de
   üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1952374904: user_status=None, telegram_lang=ru, determined_lang=de
   ```

2. **‚úÖ –î–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ:**
   ```
   üîç –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞: country_id=1, city_id=7, county_id=1126, district_id=179951
   üìä –ü–æ–ª—É—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö: general=1, house_type=4, floor_segment=7, age=4, heating=4
   ```

3. **‚úÖ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è:**
   ```
   üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç...
   ‚úÖ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã
   ```

4. **‚úÖ AI –∞–Ω–∞–ª–∏–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   ```
   üß† –ó–∞–ø—Ä–æ—Å AI-–≤—ã–≤–æ–¥–∞ –¥–ª—è —è–∑—ã–∫–∞: de
   ‚úÖ AI-–≤—ã–≤–æ–¥ –ø–æ–ª—É—á–µ–Ω: Der Immobilienmarkt in diesem Bezirk zeigt...
   ```

5. **‚úÖ –í—Å–µ HTTP –∑–∞–ø—Ä–æ—Å—ã —É—Å–ø–µ—à–Ω—ã:** `HTTP/1.1 200 OK`

6. **‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î —Ä–∞–±–æ—Ç–∞—é—Ç:**
   ```
   üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î 1/5
   ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ 1
   ```

## üéØ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

### **–ù–ï–¢ –ü–†–û–ë–õ–ï–ú –° –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï–ú –ö –ë–î!**

**–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –ª–æ–≥–∞:**
```
üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î 1/5
```

**–≠—Ç–æ –ù–ï –æ—à–∏–±–∫–∞!** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø—Ä–µ—Ä–≤–∞–Ω –≤ –ª–æ–≥–µ. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:

- ‚úÖ **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase** - —É—Å–ø–µ—à–Ω–∞
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ** - —É—Å–ø–µ—à–Ω–∞  
- ‚úÖ **–ê–ª–≥–æ—Ä–∏—Ç–º –æ—Ü–µ–Ω–∫–∏ –æ–±—ä–µ–∫—Ç–∞** - —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é
- ‚úÖ **–í—Å–µ API endpoints** - –æ—Ç–≤–µ—á–∞—é—Ç 200 OK
- ‚úÖ **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è** - —Ä–∞–±–æ—Ç–∞–µ—Ç (de —è–∑—ã–∫)
- ‚úÖ **Retry –ª–æ–≥–∏–∫–∞** - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üîß **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ (–ø–æ–ø—ã—Ç–∫–∞ 1/5)

**–ê–ª–≥–æ—Ä–∏—Ç–º –æ—Ü–µ–Ω–∫–∏ –æ–±—ä–µ–∫—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω!** üöÄ
