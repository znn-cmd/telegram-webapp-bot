# Административная панель Aaadviser

## Обзор

Административная панель предоставляет полный контроль над системой Aaadviser через веб-интерфейс. Доступ к панели имеют только пользователи со статусом `admin` в таблице `users`.

## Функциональность

### 1. Главная админ панель (`/webapp_admin`)
- **Логотип**: Отображается `logo-flt.png` в верхней части
- **Кнопка "Сделать баланс 100"**: Устанавливает баланс текущего пользователя в 100
- **Раздел "Пользователи"**: Переход к статистике пользователей
- **Раздел "Публикация"**: Переход к отправке сообщений
- **Раздел "Настройки"**: Переход к управлению API ключами

### 2. Статистика пользователей (`/webapp_admin_users`)
- Общее количество пользователей
- Новые пользователи за неделю/месяц/квартал/год
- Общий баланс всех пользователей (исключая админов)
- Баланс пользователей с истекшим периодом
- Баланс активных пользователей
- Статистика отчетов по периодам
- Количество удаленных отчетов
- Статистика по пользователям с истекшим периодом
- Статистика по активным пользователям и потраченным деньгам

### 3. Публикации (`/webapp_admin_publications`)
- Текстовое поле для ввода сообщения
- Поддержка форматирования Markdown
- Поддержка эмодзи и смайлов
- Отправка всем пользователям через Telegram Bot API
- Логирование количества админов и обычных пользователей

### 4. Настройки (`/webapp_admin_settings`)
- Управление Google Maps API Key
- Управление Telegram Bot Token
- Управление Supabase URL
- Управление Supabase Anon Key
- Безопасное хранение ключей в базе данных

## Установка

### 1. Создание таблиц базы данных

Выполните SQL скрипт `create_admin_tables.sql` в вашей базе данных:

```sql
-- Выполните содержимое файла create_admin_tables.sql
```

### 2. Настройка прав администратора

Добавьте пользователю статус `admin` в таблице `users`:

```sql
UPDATE users SET user_status = 'admin' WHERE telegram_id = YOUR_TELEGRAM_ID;
```

### 3. Настройка API ключей

Через админ панель или напрямую в базе данных добавьте необходимые API ключи:

```sql
INSERT INTO api_keys (key_name, key_value) VALUES 
    ('google_maps_key', 'YOUR_GOOGLE_MAPS_API_KEY'),
    ('telegram_bot_token', 'YOUR_TELEGRAM_BOT_TOKEN'),
    ('supabase_url', 'YOUR_SUPABASE_URL'),
    ('supabase_anon_key', 'YOUR_SUPABASE_ANON_KEY');
```

## API Эндпоинты

### Проверка статуса администратора
```
POST /api/check_admin
{
    "telegram_id": 123456789
}
```

### Установка баланса в 100
```
POST /api/admin/set_balance_100
{
    "telegram_id": 123456789
}
```

### Получение статистики пользователей
```
POST /api/admin/user_stats
{
    "telegram_id": 123456789
}
```

### Отправка публикации
```
POST /api/admin/send_publication
{
    "telegram_id": 123456789,
    "text": "Текст публикации"
}
```

### Получение настроек
```
POST /api/admin/get_settings
{
    "telegram_id": 123456789
}
```

### Сохранение настроек
```
POST /api/admin/save_settings
{
    "telegram_id": 123456789,
    "settings": {
        "google_maps_key": "key_value",
        "telegram_bot_token": "token_value",
        "supabase_url": "url_value",
        "supabase_anon_key": "key_value"
    }
}
```

## Структура базы данных

### Таблица `api_keys`
```sql
CREATE TABLE api_keys (
    id SERIAL PRIMARY KEY,
    key_name VARCHAR(100) NOT NULL UNIQUE,
    key_value TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Поле `user_status` в таблице `users`
```sql
ALTER TABLE users ADD COLUMN user_status VARCHAR(20) DEFAULT 'user';
```

### Представления для статистики
- `user_statistics` - статистика пользователей
- `report_statistics` - статистика отчетов

## Безопасность

1. **Проверка прав**: Все админ функции проверяют статус `admin`
2. **Валидация данных**: Все входные данные валидируются
3. **Логирование**: Все действия администраторов логируются
4. **Шифрование**: API ключи должны храниться в зашифрованном виде

## Использование

### Доступ к админ панели
1. Откройте WebApp в Telegram
2. Если у вас есть права администратора, появится кнопка "Администратор"
3. Нажмите на кнопку для перехода в админ панель

### Отправка публикаций
1. Перейдите в раздел "Публикация"
2. Введите текст сообщения (поддерживается Markdown)
3. Нажмите "Отправить публикацию"
4. Сообщение будет отправлено всем пользователям

### Управление настройками
1. Перейдите в раздел "Настройки"
2. Введите необходимые API ключи
3. Нажмите "Сохранить настройки"
4. Ключи будут сохранены в базе данных

## Логирование

Все действия администраторов логируются с указанием:
- Telegram ID администратора
- Выполненное действие
- Результат выполнения
- Количество затронутых пользователей

## Устранение неполадок

### Кнопка администратора не появляется
1. Проверьте, что у пользователя статус `admin` в таблице `users`
2. Проверьте, что API эндпоинт `/api/check_admin` работает
3. Проверьте консоль браузера на наличие ошибок

### Ошибки при отправке публикаций
1. Проверьте, что Telegram Bot Token настроен правильно
2. Проверьте, что бот имеет права на отправку сообщений
3. Проверьте логи сервера

### Ошибки при получении статистики
1. Проверьте, что представления `user_statistics` и `report_statistics` созданы
2. Проверьте, что таблицы `users` и `user_reports` существуют
3. Проверьте права доступа к базе данных

## Разработка

### Добавление новых функций
1. Создайте HTML страницу в папке проекта
2. Добавьте маршрут в `app.py`
3. Создайте API эндпоинт с проверкой прав администратора
4. Обновите документацию

### Изменение дизайна
1. Отредактируйте CSS в соответствующих HTML файлах
2. Сохраните единый стиль с основным приложением
3. Протестируйте на мобильных устройствах

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Проверьте консоль браузера
3. Убедитесь, что все таблицы созданы
4. Проверьте права доступа к базе данных 