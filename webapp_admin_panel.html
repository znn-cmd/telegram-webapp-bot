<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å | Aaadviser</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .admin-logo {
            width: 120px;
            display: block;
            margin: 0 auto 18px auto;
        }
        .admin-btn {
            width: 100%;
            padding: 22px 20px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            margin: 18px 0;
            border: none;
            cursor: pointer;
            transition: all 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 16px rgba(102,126,234,0.13);
        }
        .admin-btn-yellow {
            background: linear-gradient(135deg, #ffe066 0%, #ffd700 100%);
            color: #333;
        }
        .admin-btn-blue {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .admin-btn:hover {
            box-shadow: 0 8px 32px rgba(102,126,234,0.18);
            filter: brightness(1.04);
            transform: translateY(-2px) scale(1.02);
        }
        .admin-btn:active {
            transform: translateY(1px) scale(0.98);
        }
        .admin-section-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 22px;
            color: #333;
        }
        .admin-nav-row {
            display: flex;
            gap: 14px;
            margin-top: 28px;
            justify-content: center;
        }
        .admin-nav-btn {
            background: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 13px 24px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.3s;
            box-shadow: 0 2px 8px rgba(102,126,234,0.10);
        }
        .admin-nav-btn:hover {
            background: #e2e2e2;
            box-shadow: 0 4px 16px rgba(102,126,234,0.13);
        }
        .fade-in {
            animation: fadeInAnim 0.45s cubic-bezier(.4,0,.2,1);
        }
        .fade-out {
            animation: fadeOutAnim 0.35s cubic-bezier(.4,0,.2,1);
        }
        @keyframes fadeInAnim {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOutAnim {
            from { opacity: 1; transform: translateY(0); }
            to   { opacity: 0; transform: translateY(20px); }
        }
        .admin-toast {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 9999;
            padding: 14px 22px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(102,126,234,0.18);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            min-width: 220px;
            opacity: 1;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .admin-toast.success {
            background: #4CAF50; /* Green */
            color: white;
        }
        .admin-toast.error {
            background: #F44336; /* Red */
            color: white;
        }
        .admin-toast.info {
            background: #2196F3; /* Blue */
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –õ–æ–≥–æ—Ç–∏–ø –∏ –∫–Ω–æ–ø–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div style="display:flex;flex-direction:column;align-items:center;margin-top:18px;margin-bottom:10px;">
            <img src="logo-sqv.png" alt="Aaadviser Logo" style="width:110px;height:auto;display:block;margin-bottom:8px;cursor:pointer;" onclick="goToMainMenu()" />
            <div style="font-size:15px;color:#888;font-style:italic;">Aaadviser ‚Äî –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            <button class="menu-btn" style="margin-top:18px;width:100%;max-width:320px;" onclick="goToMainMenu()">
                <span class="menu-btn-icon">üè†</span>
                <span class="menu-btn-text">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</span>
            </button>
        </div>
        <div id="adminMenu">
            <button class="menu-btn admin-btn-yellow" style="color:#333;font-weight:bold;background: linear-gradient(135deg, #ffe066 0%, #ffd700 100%);" onclick="openAdminSection('balance')">–°–¥–µ–ª–∞—Ç—å –±–∞–ª–∞–Ω—Å 100</button>
            <button class="menu-btn" onclick="openAdminSection('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
            <button class="menu-btn" onclick="openAdminSection('publish')">–ü—É–±–ª–∏–∫–∞—Ü–∏—è</button>
            <button class="menu-btn" onclick="openAdminSection('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        <div class="admin-nav-row" id="adminNavRow" style="display:none;">
            <button class="admin-nav-btn" onclick="backToAdminMenu()">–ù–∞–∑–∞–¥</button>
        </div>
        <div id="adminContent" style="margin-top:30px;"></div>
        <div id="adminToastContainer" style="position:fixed;top:30px;right:30px;z-index:9999;"></div>
    </div>
    <script>
        let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        let userData = null;
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userData = tg.initDataUnsafe.user;
        } else {
            try {
                const stored = localStorage.getItem('aaadviser_user');
                if (stored) userData = JSON.parse(stored);
            } catch (e) {}
        }
        function goToMainMenu() {
            window.location.href = '/webapp';
        }
        function openAdminSection(section) {
            document.getElementById('adminMenu').style.display = 'none';
            document.getElementById('adminNavRow').style.display = 'flex';
            const content = document.getElementById('adminContent');
            content.className = '';
            content.innerHTML = '';
            setTimeout(() => { content.classList.add('fade-in'); }, 10);
            localStorage.setItem('admin_section', section);
            if (section === 'balance') makeBalance100();
            if (section === 'users') showUsersStats();
            if (section === 'publish') showPublication();
            if (section === 'settings') showSettings();
        }
        function backToAdminMenu() {
            const content = document.getElementById('adminContent');
            content.classList.remove('fade-in');
            content.classList.add('fade-out');
            setTimeout(() => {
                document.getElementById('adminMenu').style.display = '';
                document.getElementById('adminNavRow').style.display = 'none';
                content.innerHTML = '';
                content.className = '';
                window.scrollTo({ top: 0, behavior: 'smooth' });
                localStorage.removeItem('admin_section');
            }, 350);
        }
        window.addEventListener('DOMContentLoaded', () => {
            const savedSection = localStorage.getItem('admin_section');
            if (savedSection) {
                openAdminSection(savedSection);
            }
        });
        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('adminToastContainer');
            const toast = document.createElement('div');
            toast.className = 'admin-toast ' + type;
            toast.style = 'background:#fff;padding:14px 22px;border-radius:10px;box-shadow:0 4px 16px rgba(102,126,234,0.18);margin-bottom:10px;display:flex;align-items:center;gap:10px;font-size:15px;min-width:220px;';
            toast.innerHTML = `<span>${type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ÑπÔ∏è'}</span><span style='flex:1;'>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(-10px)'; }, duration-300);
            setTimeout(() => { toast.remove(); }, duration);
        }
        async function makeBalance100() {
            if (!userData || !userData.id) {
                document.getElementById('adminContent').innerHTML = '<div class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</div>';
                showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω', 'error');
                return;
            }
            document.getElementById('adminContent').innerHTML = '<div class="loading">–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å...</div>';
            try {
                const resp = await fetch('/api/admin_set_balance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id })
                });
                const data = await resp.json();
                if (data.success) {
                    document.getElementById('adminContent').innerHTML = '<div style="color:green;font-weight:bold;">–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $100</div>';
                    showToast('–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $100', 'success');
                } else {
                    document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å') + '</div>';
                    showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å'), 'error');
                }
            } catch (e) {
                document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }
        async function showUsersStats() {
            if (!userData || !userData.id) {
                document.getElementById('adminContent').innerHTML = '<div class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</div>';
                return;
            }
            document.getElementById('adminContent').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';
            try {
                const resp = await fetch('/api/admin_user_stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id })
                });
                const data = await resp.json();
                if (data.error) {
                    document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É') + '</div>';
                    return;
                }
                let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:16px;'>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>`;
                html += `<table style='width:100%;border-collapse:collapse;'>`;
                html += `<tr><td>üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</td><td><b>${data.total_users}</b></td></tr>`;
                html += `<tr><td>üÜï –ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é:</td><td>${data.new_week}</td></tr>`;
                html += `<tr><td>üìÖ –ù–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü:</td><td>${data.new_month}</td></tr>`;
                html += `<tr><td>üìä –ù–æ–≤—ã—Ö –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª:</td><td>${data.new_quarter}</td></tr>`;
                html += `<tr><td>üìà –ù–æ–≤—ã—Ö –∑–∞ –≥–æ–¥:</td><td>${data.new_year}</td></tr>`;
                html += `<tr><td>üí∞ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å:</td><td>$${data.total_balance}</td></tr>`;
                html += `<tr><td>‚è≥ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å period_end < —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ null:</td><td>$${data.expired_balance}</td></tr>`;
                html += `<tr><td>üü¢ –ë–∞–ª–∞–Ω—Å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</td><td>$${data.active_balance}</td></tr>`;
                html += `<tr><td>üìë –û—Ç—á–µ—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é:</td><td>${data.reports_week}</td></tr>`;
                html += `<tr><td>üìë –û—Ç—á–µ—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü:</td><td>${data.reports_month}</td></tr>`;
                html += `<tr><td>üìë –û—Ç—á–µ—Ç–æ–≤ –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª:</td><td>${data.reports_quarter}</td></tr>`;
                html += `<tr><td>üìë –û—Ç—á–µ—Ç–æ–≤ –∑–∞ –≥–æ–¥:</td><td>${data.reports_year}</td></tr>`;
                html += `<tr><td>üóëÔ∏è –£–¥–∞–ª—ë–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤:</td><td>${data.deleted_reports}</td></tr>`;
                html += `<tr><td>‚è≥ –û—Ç—á–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å period_end < —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ null:</td><td>${data.expired_reports_count}</td></tr>`;
                html += `<tr><td>üìâ –°—Ä–µ–¥–Ω–µ–µ –æ—Ç—á–µ—Ç–æ–≤ –Ω–∞ —Ç–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</td><td>${data.avg_expired_reports.toFixed(2)}</td></tr>`;
                html += `<tr><td>üü¢ –û—Ç—á–µ—Ç–æ–≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</td><td>${data.active_reports_count}</td></tr>`;
                html += `<tr><td>üí∏ –°—É–º–º–∞ –¥–µ–Ω–µ–≥ –∑–∞ –∏—Ö –æ—Ç—á–µ—Ç—ã:</td><td>$${data.active_reports_money}</td></tr>`;
                html += `</table>`;
                document.getElementById('adminContent').innerHTML = html;
            } catch (e) {
                document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
            }
        }
        async function showPublication() {
            if (!userData || !userData.id) {
                document.getElementById('adminContent').innerHTML = '<div class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</div>';
                showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω', 'error');
                return;
            }
            document.getElementById('adminContent').innerHTML = `
                <div style='font-size:18px;font-weight:bold;margin-bottom:16px;'>–ü—É–±–ª–∏–∫–∞—Ü–∏—è</div>
                <textarea id='publishText' maxlength='4096' style='width:100%;min-height:120px;font-size:15px;padding:10px;border-radius:8px;border:1px solid #ccc;margin-bottom:8px;' placeholder='–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML, —ç–º–æ–¥–∑–∏, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ)' oninput='updatePublishCounter()'></textarea>
                <div style='font-size:13px;color:#888;margin-bottom:8px;'><span id='publishCounter'>0</span>/4096 —Å–∏–º–≤–æ–ª–æ–≤</div>
                <button class='admin-btn admin-btn-blue' style='width:100%;' id='publishBtn' onclick='sendPublication()'>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º</button>
                <div id='publishResult' style='margin-top:16px;'></div>
                <div style='font-size:13px;color:#888;margin-top:10px;'>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ: <b>HTML</b> (–∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, —Å—Å—ã–ª–∫–∏, —ç–º–æ–¥–∑–∏ –∏ —Ç.–¥.)</div>
            `;
            updatePublishCounter();
        }
        function updatePublishCounter() {
            const textarea = document.getElementById('publishText');
            const counter = document.getElementById('publishCounter');
            const btn = document.getElementById('publishBtn');
            const len = textarea.value.length;
            counter.textContent = len;
            if (len > 4096) {
                counter.style.color = 'red';
                btn.disabled = true;
                btn.style.opacity = 0.6;
            } else {
                counter.style.color = '';
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        }
        async function sendPublication() {
            const text = document.getElementById('publishText').value.trim();
            if (!text) {
                document.getElementById('publishResult').innerHTML = '<span style="color:red;">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</span>';
                showToast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'error');
                return;
            }
            if (text.length > 4096) {
                document.getElementById('publishResult').innerHTML = '<span style="color:red;">–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤ (4096)</span>';
                showToast('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤ (4096)', 'error');
                return;
            }
            document.getElementById('publishResult').innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            try {
                const resp = await fetch('/api/admin_publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id, text })
                });
                const data = await resp.json();
                if (data.success) {
                    document.getElementById('publishResult').innerHTML = `<span style='color:green;'>–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!<br>–û–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <b>${data.users}</b><br>–ê–¥–º–∏–Ω–æ–≤: <b>${data.admins}</b></span>`;
                    showToast('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', 'success');
                } else {
                    document.getElementById('publishResult').innerHTML = `<span style='color:red;'>–û—à–∏–±–∫–∞: ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é'}</span>`;
                    showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é'), 'error');
                }
            } catch (e) {
                document.getElementById('publishResult').innerHTML = '<span style="color:red;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>';
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }
        async function showSettings() {
            if (!userData || !userData.id) {
                document.getElementById('adminContent').innerHTML = '<div class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</div>';
                return;
            }
            document.getElementById('adminContent').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</div>';
            try {
                const resp = await fetch('/api/admin_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id })
                });
                const data = await resp.json();
                if (data.error) {
                    document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏') + '</div>';
                    return;
                }
                let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:16px;'>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>`;
                html += `<form id="settingsForm">`;
                html += `<div class="form-group">`;
                html += `<label for="min_balance">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>`;
                html += `<input type="number" id="min_balance" name="min_balance" value="${data.min_balance}" class="admin-input">`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="max_reports_per_day">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤ –≤ –¥–µ–Ω—å:</label>`;
                html += `<input type="number" id="max_reports_per_day" name="max_reports_per_day" value="${data.max_reports_per_day}" class="admin-input">`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="report_interval">–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–æ–≤ (–≤ –º–∏–Ω—É—Ç–∞—Ö):</label>`;
                html += `<input type="number" id="report_interval" name="report_interval" value="${data.report_interval}" class="admin-input">`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="max_users_per_day">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –¥–µ–Ω—å:</label>`;
                html += `<input type="number" id="max_users_per_day" name="max_users_per_day" value="${data.max_users_per_day}" class="admin-input">`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="max_publications_per_day">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ –¥–µ–Ω—å:</label>`;
                html += `<input type="number" id="max_publications_per_day" name="max_publications_per_day" value="${data.max_publications_per_day}" class="admin-input">`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="max_reports_per_month">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤ –≤ –º–µ—Å—è—Ü:</label>`;
                html += `<input type="number" id="max_reports_per_month" name="max_reports_per_month" value="${data.max_reports_per_month}" class="admin-input">`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="max_reports_per_quarter">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤ –≤ –∫–≤–∞—Ä—Ç–∞–ª:</label>`;
                html += `<input type="number" id="max_reports_per_quarter" name="max_reports_per_quarter" value="${data.max_reports_per_quarter}" class="admin-input">`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="max_reports_per_year">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤ –≤ –≥–æ–¥:</label>`;
                html += `<input type="number" id="max_reports_per_year" name="max_reports_per_year" value="${data.max_reports_per_year}" class="admin-input">`;
                html += `</div>`;
                html += `<button type="submit" class="admin-btn admin-btn-blue">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>`;
                html += `</form>`;
                document.getElementById('adminContent').innerHTML = html;
                document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const settings = {};
                    formData.forEach((value, key) => {
                        settings[key] = value;
                    });
                    try {
                        const resp = await fetch('/api/admin_update_settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ telegram_id: userData.id, settings: settings })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            document.getElementById('adminContent').innerHTML = '<div style="color:green;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>';
                            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                        } else {
                            document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏') + '</div>';
                            showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏'), 'error');
                        }
                    } catch (e) {
                        document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
                        showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                    }
                });
            } catch (e) {
                document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
            }
        }
        async function editPublication(id) {
            if (!userData || !userData.id) {
                document.getElementById('adminContent').innerHTML = '<div class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</div>';
                return;
            }
            document.getElementById('adminContent').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏...</div>';
            try {
                const resp = await fetch(`/api/admin_publication/${id}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await resp.json();
                if (data.error) {
                    document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é') + '</div>';
                    return;
                }
                let html = `<div style='font-size:18px;font-weight:bold;margin-bottom:16px;'>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</div>`;
                html += `<form id="editPublicationForm">`;
                html += `<input type="hidden" name="id" value="${data.id}">`;
                html += `<div class="form-group">`;
                html += `<label for="edit_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>`;
                html += `<input type="text" id="edit_title" name="title" value="${data.title}" class="admin-input">`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="edit_content">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:</label>`;
                html += `<textarea id="edit_content" name="content" class="admin-input">${data.content}</textarea>`;
                html += `</div>`;
                html += `<div class="form-group">`;
                html += `<label for="edit_date">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</label>`;
                html += `<input type="date" id="edit_date" name="date" value="${data.date}" class="admin-input">`;
                html += `</div>`;
                html += `<button type="submit" class="admin-btn admin-btn-blue">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>`;
                html += `</form>`;
                document.getElementById('adminContent').innerHTML = html;
                document.getElementById('editPublicationForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const publication = {};
                    formData.forEach((value, key) => {
                        publication[key] = value;
                    });
                    try {
                        const resp = await fetch(`/api/admin_publication/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ telegram_id: userData.id, publication: publication })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            document.getElementById('adminContent').innerHTML = '<div style="color:green;">–ü—É–±–ª–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</div>';
                            showToast('–ü—É–±–ª–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                            showPublication(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
                        } else {
                            document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é') + '</div>';
                            showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é'), 'error');
                        }
                    } catch (e) {
                        document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
                        showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                    }
                });
            } catch (e) {
                document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
            }
        }
        async function deletePublication(id) {
            if (!userData || !userData.id) {
                document.getElementById('adminContent').innerHTML = '<div class="loading">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</div>';
                return;
            }
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é?')) {
                return;
            }
            document.getElementById('adminContent').innerHTML = '<div class="loading">–£–¥–∞–ª—è–µ–º –ø—É–±–ª–∏–∫–∞—Ü–∏—é...</div>';
            try {
                const resp = await fetch(`/api/admin_publication/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id })
                });
                const data = await resp.json();
                if (data.success) {
                    document.getElementById('adminContent').innerHTML = '<div style="color:green;">–ü—É–±–ª–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!</div>';
                    showToast('–ü—É–±–ª–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!', 'success');
                    showPublication(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
                } else {
                    document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é') + '</div>';
                    showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é'), 'error');
                }
            } catch (e) {
                document.getElementById('adminContent').innerHTML = '<div style="color:red;">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }
        function copyKeyValue(keyName) {
            const val = document.getElementById('keyval_' + keyName).textContent;
            navigator.clipboard.writeText(val).then(() => {
                showToast('–ö–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
            }, () => {
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error');
            });
        }
    </script>
</body>
</html> 