<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест расчета исторических цен</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-description {
            margin-bottom: 15px;
            color: #666;
            line-height: 1.5;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result-area {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .trends-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        .trends-table th {
            background: #28a745;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
        }
        .trends-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }
        .trends-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .current-month-row {
            background-color: #e8f4fd !important;
            font-weight: 500;
        }
        .forecast-row {
            background-color: #f0f8ff !important;
        }
        .historical-row {
            background-color: #fff3cd !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Тест расчета исторических цен для таблицы трендов</h1>
        
        <div class="test-section">
            <div class="test-title">Тест 1: Базовая логика расчета</div>
            <div class="test-description">
                Проверяем основную логику расчета исторических цен:
                - Для текущего месяца (август 2025) используем средние цены
                - Для будущих месяцев используем оригинальные значения
                - Для исторических месяцев рассчитываем цены рекурсивно
            </div>
            <button class="test-button" onclick="testBasicCalculation()">Запустить тест</button>
            <div class="result-area" id="basicResult"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">Тест 2: Расчет исторических цен</div>
            <div class="test-description">
                Проверяем расчет цен для исторических месяцев:
                - Июль 2025: цена августа минус процент изменения августа
                - Июнь 2025: цена июля (рассчитанная) минус процент изменения июля
                - И так далее для всех исторических месяцев
            </div>
            <button class="test-button" onclick="testHistoricalCalculation()">Запустить тест</button>
            <div class="result-area" id="historicalResult"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">Тест 3: Отображение таблицы</div>
            <div class="test-description">
                Проверяем корректное отображение таблицы с рассчитанными ценами
            </div>
            <button class="test-button" onclick="testTableDisplay()">Запустить тест</button>
            <div id="tableResult"></div>
        </div>
    </div>

    <script>
        // Имитация данных трендов (август 2025 - текущий месяц)
        const mockTrends = [
            {
                date: '2025-02-01',
                property_year: 2025,
                property_month: 2,
                unit_price_for_sale: 53200,
                unit_price_for_rent: 264.05,
                price_change_sale: 2.20,
                price_change_rent: 2.04,
                yield: 5.96
            },
            {
                date: '2025-03-01',
                property_year: 2025,
                property_month: 3,
                unit_price_for_sale: 54330,
                unit_price_for_rent: 270.11,
                price_change_sale: 2.12,
                price_change_rent: 2.30,
                yield: 5.97
            },
            {
                date: '2025-04-01',
                property_year: 2025,
                property_month: 4,
                unit_price_for_sale: 55921,
                unit_price_for_rent: 274.56,
                price_change_sale: 2.93,
                price_change_rent: 1.65,
                yield: 5.89
            },
            {
                date: '2025-05-01',
                property_year: 2025,
                property_month: 5,
                unit_price_for_sale: 57464,
                unit_price_for_rent: 280.06,
                price_change_sale: 2.76,
                price_change_rent: 2.00,
                yield: 5.85
            },
            {
                date: '2025-06-01',
                property_year: 2025,
                property_month: 6,
                unit_price_for_sale: 58990,
                unit_price_for_rent: 288.40,
                price_change_sale: 2.66,
                price_change_rent: 2.98,
                yield: 5.87
            },
            {
                date: '2025-07-01',
                property_year: 2025,
                property_month: 7,
                unit_price_for_sale: 60441,
                unit_price_for_rent: 295.72,
                price_change_sale: 2.46,
                price_change_rent: 2.54,
                yield: 5.87
            },
            {
                date: '2025-08-01',
                property_year: 2025,
                property_month: 8,
                unit_price_for_sale: 65753,
                unit_price_for_rent: 328.00,
                price_change_sale: 2.25,
                price_change_rent: 2.38,
                yield: 5.88
            },
            {
                date: '2025-09-01',
                property_year: 2025,
                property_month: 9,
                unit_price_for_sale: 62794,
                unit_price_for_rent: 310.37,
                price_change_sale: 1.60,
                price_change_rent: 2.51,
                yield: 5.93
            }
        ];

        // Средние цены для текущего месяца (август 2025)
        const averagePrices = {
            avgSalePrice: 65753,
            avgRentPrice: 328.00
        };

        // Функция для расчета цены для исторического месяца
        function calculateHistoricalPrice(basePrice, percentageChange) {
            const changeMultiplier = 1 + (percentageChange / 100);
            return Math.round(basePrice / changeMultiplier);
        }

        // Функция для фильтрации трендов по диапазону дат
        function filterTrendsByDateRange(trends) {
            if (!trends || trends.length === 0) return [];
            
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            // Фильтруем тренды за текущий год (2025)
            const currentYearTrends = trends.filter(trend => trend.property_year === currentYear);
            
            if (currentYearTrends.length === 0) {
                return trends.slice(0, 8);
            }
            
            // Вычисляем диапазон месяцев: 6 месяцев назад от текущего + 1 месяц вперед
            const startMonth = currentMonth - 6;
            const endMonth = currentMonth + 1;
            
            // Фильтруем тренды по диапазону месяцев
            const filteredTrends = currentYearTrends.filter(trend => {
                const month = trend.property_month;
                
                if (startMonth <= 0) {
                    return month >= (12 + startMonth) || month <= endMonth;
                } else {
                    return month >= startMonth && month <= endMonth;
                }
            });
            
            // Сортируем по месяцу (будущие месяцы сверху, текущий в середине, прошедшие снизу)
            filteredTrends.sort((a, b) => {
                const monthA = a.property_month;
                const monthB = b.property_month;
                
                if (monthA > currentMonth && monthB > currentMonth) {
                    return monthA - monthB;
                } else if (monthA < currentMonth && monthB < currentMonth) {
                    return monthB - monthA;
                } else if (monthA > currentMonth && monthB === currentMonth) {
                    return -1;
                } else if (monthA === currentMonth && monthB > currentMonth) {
                    return 1;
                } else if (monthA > currentMonth && monthB < currentMonth) {
                    return -1;
                } else if (monthA < currentMonth && monthB > currentMonth) {
                    return 1;
                } else if (monthA === currentMonth && monthB < currentMonth) {
                    return -1;
                } else if (monthA < currentMonth && monthB === currentMonth) {
                    return 1;
                }
                
                return 0;
            });
            
            return filteredTrends.slice(0, 8);
        }

        // Тест 1: Базовая логика расчета
        function testBasicCalculation() {
            const result = document.getElementById('basicResult');
            result.innerHTML = 'Запуск теста базовой логики...\n\n';
            
            try {
                const filteredTrends = filterTrendsByDateRange(mockTrends);
                result.innerHTML += `Отфильтровано трендов: ${filteredTrends.length}\n`;
                
                // Сортируем тренды по дате для правильного расчета исторических цен
                const sortedTrendsForCalculation = [...filteredTrends].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
                
                result.innerHTML += `\nТренды для расчета (по возрастанию даты):\n`;
                sortedTrendsForCalculation.forEach((trend, index) => {
                    result.innerHTML += `${index + 1}. ${trend.date} (${trend.property_month}/${trend.property_year})\n`;
                });
                
                result.innerHTML += '\n✅ Базовая логика работает корректно!\n';
                
            } catch (error) {
                result.innerHTML += `❌ Ошибка: ${error.message}\n`;
            }
        }

        // Тест 2: Расчет исторических цен
        function testHistoricalCalculation() {
            const result = document.getElementById('historicalResult');
            result.innerHTML = 'Запуск теста расчета исторических цен...\n\n';
            
            try {
                const filteredTrends = filterTrendsByDateRange(mockTrends);
                
                // Сортируем тренды по дате для правильного расчета исторических цен
                const sortedTrendsForCalculation = [...filteredTrends].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
                
                // Создаем кэш для рассчитанных цен
                const calculatedPrices = new Map();
                
                result.innerHTML += 'Расчет цен для каждого месяца:\n\n';
                
                // Сначала рассчитываем цены для всех месяцев, начиная с текущего
                sortedTrendsForCalculation.forEach((trend, index) => {
                    const trendDate = new Date(trend.date);
                    const trendYear = trendDate.getFullYear();
                    const trendMonth = trendDate.getMonth() + 1;
                    
                    const currentYear = new Date().getFullYear();
                    const currentMonth = new Date().getMonth() + 1;
                    
                    const isCurrentMonth = trendYear === currentYear && trendMonth === currentMonth;
                    const isFutureMonth = trendYear > currentYear || (trendYear === currentYear && trendMonth > currentMonth);
                    const isHistoricalMonth = trendYear < currentYear || (trendYear === currentYear && trendMonth < currentMonth);
                    
                    let salePrice, rentPrice;
                    
                    if (isCurrentMonth) {
                        // Для текущего месяца используем средние цены
                        salePrice = averagePrices.avgSalePrice;
                        rentPrice = averagePrices.avgRentPrice;
                        result.innerHTML += `📅 ${trend.date} (ТЕКУЩИЙ МЕСЯЦ):\n`;
                        result.innerHTML += `   Продажа: ${salePrice} ₺/м² (средняя цена)\n`;
                        result.innerHTML += `   Аренда: ${rentPrice} ₺/м² (средняя цена)\n\n`;
                    } else if (isFutureMonth) {
                        // Для будущих месяцев используем оригинальные значения
                        salePrice = trend.unit_price_for_sale;
                        rentPrice = trend.unit_price_for_rent;
                        result.innerHTML += `📅 ${trend.date} (БУДУЩИЙ МЕСЯЦ):\n`;
                        result.innerHTML += `   Продажа: ${salePrice} ₺/м² (оригинальная цена)\n`;
                        result.innerHTML += `   Аренда: ${rentPrice} ₺/м² (оригинальная цена)\n\n`;
                    } else if (isHistoricalMonth) {
                        // Для исторических месяцев рассчитываем цены
                        let nextMonthTrend = null;
                        for (let i = index + 1; i < sortedTrendsForCalculation.length; i++) {
                            const nextTrend = sortedTrendsForCalculation[i];
                            const nextTrendDate = new Date(nextTrend.date);
                            const nextTrendYear = nextTrendDate.getFullYear();
                            const nextTrendMonth = nextTrendDate.getMonth() + 1;
                            
                            if (nextTrendYear > trendYear || (nextTrendYear === trendYear && nextTrendMonth > trendMonth)) {
                                nextMonthTrend = nextTrend;
                                break;
                            }
                        }
                        
                        if (nextMonthTrend) {
                            // Используем цену следующего месяца и процент изменения для расчета
                            const nextMonthSalePrice = calculatedPrices.get(nextMonthTrend.date + '_sale') || nextMonthTrend.unit_price_for_sale;
                            const nextMonthRentPrice = calculatedPrices.get(nextMonthTrend.date + '_rent') || nextMonthTrend.unit_price_for_rent;
                            
                            salePrice = calculateHistoricalPrice(nextMonthSalePrice, nextMonthTrend.price_change_sale);
                            rentPrice = calculateHistoricalPrice(nextMonthRentPrice, nextMonthTrend.price_change_rent);
                            
                            result.innerHTML += `📅 ${trend.date} (ИСТОРИЧЕСКИЙ МЕСЯЦ):\n`;
                            result.innerHTML += `   Следующий месяц: ${nextMonthTrend.date}\n`;
                            result.innerHTML += `   Цена продажи: ${salePrice} ₺/м² (рассчитана из ${nextMonthSalePrice} - ${nextMonthTrend.price_change_sale}%)\n`;
                            result.innerHTML += `   Цена аренды: ${rentPrice} ₺/м² (рассчитана из ${nextMonthRentPrice} - ${nextMonthTrend.price_change_rent}%)\n\n`;
                        } else {
                            salePrice = trend.unit_price_for_sale;
                            rentPrice = trend.unit_price_for_rent;
                            result.innerHTML += `📅 ${trend.date} (ИСТОРИЧЕСКИЙ МЕСЯЦ):\n`;
                            result.innerHTML += `   Продажа: ${salePrice} ₺/м² (оригинальная цена, нет следующего месяца)\n`;
                            result.innerHTML += `   Аренда: ${rentPrice} ₺/м² (оригинальная цена, нет следующего месяца)\n\n`;
                        }
                    }
                    
                    // Сохраняем рассчитанные цены в кэш
                    calculatedPrices.set(trend.date + '_sale', salePrice);
                    calculatedPrices.set(trend.date + '_rent', rentPrice);
                });
                
                result.innerHTML += '✅ Расчет исторических цен завершен успешно!\n';
                
            } catch (error) {
                result.innerHTML += `❌ Ошибка: ${error.message}\n`;
            }
        }

        // Тест 3: Отображение таблицы
        function testTableDisplay() {
            const result = document.getElementById('tableResult');
            result.innerHTML = '<div class="test-title">Результат отображения таблицы:</div>';
            
            try {
                const filteredTrends = filterTrendsByDateRange(mockTrends);
                
                // Сортируем тренды по дате для правильного расчета исторических цен
                const sortedTrendsForCalculation = [...filteredTrends].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
                
                // Создаем кэш для рассчитанных цен
                const calculatedPrices = new Map();
                
                // Сначала рассчитываем цены для всех месяцев
                sortedTrendsForCalculation.forEach((trend, index) => {
                    const trendDate = new Date(trend.date);
                    const trendYear = trendDate.getFullYear();
                    const trendMonth = trendDate.getMonth() + 1;
                    
                    const currentYear = new Date().getFullYear();
                    const currentMonth = new Date().getMonth() + 1;
                    
                    const isCurrentMonth = trendYear === currentYear && trendMonth === currentMonth;
                    const isFutureMonth = trendYear > currentYear || (trendYear === currentYear && trendMonth > currentMonth);
                    const isHistoricalMonth = trendYear < currentYear || (trendYear === currentYear && trendMonth < currentMonth);
                    
                    let salePrice, rentPrice;
                    
                    if (isCurrentMonth) {
                        salePrice = averagePrices.avgSalePrice;
                        rentPrice = averagePrices.avgRentPrice;
                    } else if (isFutureMonth) {
                        salePrice = trend.unit_price_for_sale;
                        rentPrice = trend.unit_price_for_rent;
                    } else if (isHistoricalMonth) {
                        let nextMonthTrend = null;
                        for (let i = index + 1; i < sortedTrendsForCalculation.length; i++) {
                            const nextTrend = sortedTrendsForCalculation[i];
                            const nextTrendDate = new Date(nextTrend.date);
                            const nextTrendYear = nextTrendDate.getFullYear();
                            const nextTrendMonth = nextTrendDate.getMonth() + 1;
                            
                            if (nextTrendYear > trendYear || (nextTrendYear === trendYear && nextTrendMonth > trendMonth)) {
                                nextMonthTrend = nextTrend;
                                break;
                            }
                        }
                        
                        if (nextMonthTrend) {
                            const nextMonthSalePrice = calculatedPrices.get(nextMonthTrend.date + '_sale') || nextMonthTrend.unit_price_for_sale;
                            const nextMonthRentPrice = calculatedPrices.get(nextMonthTrend.date + '_rent') || nextMonthTrend.unit_price_for_rent;
                            
                            salePrice = calculateHistoricalPrice(nextMonthSalePrice, nextMonthTrend.price_change_sale);
                            rentPrice = calculateHistoricalPrice(nextMonthRentPrice, nextMonthTrend.price_change_rent);
                        } else {
                            salePrice = trend.unit_price_for_sale;
                            rentPrice = trend.unit_price_for_rent;
                        }
                    }
                    
                    calculatedPrices.set(trend.date + '_sale', salePrice);
                    calculatedPrices.set(trend.date + '_rent', rentPrice);
                });
                
                // Создаем таблицу
                let tableHTML = '<table class="trends-table">';
                tableHTML += '<thead><tr>';
                tableHTML += '<th>Дата</th>';
                tableHTML += '<th>Продажа<br>(₺/м²)</th>';
                tableHTML += '<th>Изм-ие цены<br>продажи</th>';
                tableHTML += '<th>Аренда<br>(₺/м²)</th>';
                tableHTML += '<th>Изм-ие цены<br>аренды</th>';
                tableHTML += '<th>Доходность</th>';
                tableHTML += '</tr></thead><tbody>';
                
                // Добавляем информацию о фильтрации
                tableHTML += '<tr><td colspan="6" style="text-align: center; font-size: 10px; color: #666; background: #f8f9fa; padding: 4px;">';
                tableHTML += `Показано ${filteredTrends.length} из ${mockTrends.length} трендов`;
                tableHTML += '</td></tr>';
                
                // Отображаем тренды в правильном порядке (новые сверху)
                filteredTrends.forEach((trend) => {
                    const trendDate = new Date(trend.date);
                    const trendYear = trendDate.getFullYear();
                    const trendMonth = trendDate.getMonth() + 1;
                    
                    const currentYear = new Date().getFullYear();
                    const currentMonth = new Date().getMonth() + 1;
                    
                    const isCurrentMonth = trendYear === currentYear && trendMonth === currentMonth;
                    const isFutureMonth = trendYear > currentYear || (trendYear === currentYear && trendMonth > currentMonth);
                    const isHistoricalMonth = trendYear < currentYear || (trendYear === currentYear && trendMonth < currentMonth);
                    
                    let rowClass = '';
                    if (isCurrentMonth) {
                        rowClass = 'current-month-row';
                    } else if (isFutureMonth) {
                        rowClass = 'forecast-row';
                    } else if (isHistoricalMonth) {
                        rowClass = 'historical-row';
                    }
                    
                    const salePrice = calculatedPrices.get(trend.date + '_sale') || trend.unit_price_for_sale;
                    const rentPrice = calculatedPrices.get(trend.date + '_rent') || trend.unit_price_for_rent;
                    
                    tableHTML += `<tr class="${rowClass}">`;
                    tableHTML += `<td>${trend.date}</td>`;
                    tableHTML += `<td>${salePrice.toLocaleString('ru-RU')}</td>`;
                    tableHTML += `<td>${trend.price_change_sale > 0 ? '+' : ''}${trend.price_change_sale}%</td>`;
                    tableHTML += `<td>${rentPrice.toFixed(2)}</td>`;
                    tableHTML += `<td>${trend.price_change_rent > 0 ? '+' : ''}${trend.price_change_rent}%</td>`;
                    tableHTML += `<td>${trend.yield}%</td>`;
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table>';
                
                result.innerHTML += tableHTML;
                result.innerHTML += '<div style="margin-top: 15px; color: #666; font-size: 12px;">';
                result.innerHTML += '<strong>Цветовая схема:</strong><br>';
                result.innerHTML += '🔵 Синий - текущий месяц (август 2025)<br>';
                result.innerHTML += '🟡 Желтый - исторические месяцы (февраль-июль 2025)<br>';
                result.innerHTML += '⚪ Белый - будущие месяцы (сентябрь 2025)<br>';
                result.innerHTML += '</div>';
                
            } catch (error) {
                result.innerHTML += `<div class="result-area">❌ Ошибка: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
