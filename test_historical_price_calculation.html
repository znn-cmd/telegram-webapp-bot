<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-description {
            margin-bottom: 15px;
            color: #666;
            line-height: 1.5;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result-area {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .trends-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        .trends-table th {
            background: #28a745;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
        }
        .trends-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }
        .trends-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .current-month-row {
            background-color: #e8f4fd !important;
            font-weight: 500;
        }
        .forecast-row {
            background-color: #f0f8ff !important;
        }
        .historical-row {
            background-color: #fff3cd !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã —Ç—Ä–µ–Ω–¥–æ–≤</h1>
        
        <div class="test-section">
            <div class="test-title">–¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω:
                - –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–∞–≤–≥—É—Å—Ç 2025) –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã
                - –î–ª—è –±—É–¥—É—â–∏—Ö –º–µ—Å—è—Ü–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                - –î–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—è—Ü–µ–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
            </div>
            <button class="test-button" onclick="testBasicCalculation()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div class="result-area" id="basicResult"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">–¢–µ—Å—Ç 2: –†–∞—Å—á–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—è—Ü–µ–≤:
                - –ò—é–ª—å 2025: —Ü–µ–Ω–∞ –∞–≤–≥—É—Å—Ç–∞ –º–∏–Ω—É—Å –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–≥—É—Å—Ç–∞
                - –ò—é–Ω—å 2025: —Ü–µ–Ω–∞ –∏—é–ª—è (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è) –º–∏–Ω—É—Å –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—é–ª—è
                - –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—è—Ü–µ–≤
            </div>
            <button class="test-button" onclick="testHistoricalCalculation()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div class="result-area" id="historicalResult"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">–¢–µ—Å—Ç 3: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
            </div>
            <button class="test-button" onclick="testTableDisplay()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="tableResult"></div>
        </div>
    </div>

    <script>
        // –ò–º–∏—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ (–∞–≤–≥—É—Å—Ç 2025 - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü)
        const mockTrends = [
            {
                date: '2025-02-01',
                property_year: 2025,
                property_month: 2,
                unit_price_for_sale: 53200,
                unit_price_for_rent: 264.05,
                price_change_sale: 2.20,
                price_change_rent: 2.04,
                yield: 5.96
            },
            {
                date: '2025-03-01',
                property_year: 2025,
                property_month: 3,
                unit_price_for_sale: 54330,
                unit_price_for_rent: 270.11,
                price_change_sale: 2.12,
                price_change_rent: 2.30,
                yield: 5.97
            },
            {
                date: '2025-04-01',
                property_year: 2025,
                property_month: 4,
                unit_price_for_sale: 55921,
                unit_price_for_rent: 274.56,
                price_change_sale: 2.93,
                price_change_rent: 1.65,
                yield: 5.89
            },
            {
                date: '2025-05-01',
                property_year: 2025,
                property_month: 5,
                unit_price_for_sale: 57464,
                unit_price_for_rent: 280.06,
                price_change_sale: 2.76,
                price_change_rent: 2.00,
                yield: 5.85
            },
            {
                date: '2025-06-01',
                property_year: 2025,
                property_month: 6,
                unit_price_for_sale: 58990,
                unit_price_for_rent: 288.40,
                price_change_sale: 2.66,
                price_change_rent: 2.98,
                yield: 5.87
            },
            {
                date: '2025-07-01',
                property_year: 2025,
                property_month: 7,
                unit_price_for_sale: 60441,
                unit_price_for_rent: 295.72,
                price_change_sale: 2.46,
                price_change_rent: 2.54,
                yield: 5.87
            },
            {
                date: '2025-08-01',
                property_year: 2025,
                property_month: 8,
                unit_price_for_sale: 65753,
                unit_price_for_rent: 328.00,
                price_change_sale: 2.25,
                price_change_rent: 2.38,
                yield: 5.88
            },
            {
                date: '2025-09-01',
                property_year: 2025,
                property_month: 9,
                unit_price_for_sale: 62794,
                unit_price_for_rent: 310.37,
                price_change_sale: 1.60,
                price_change_rent: 2.51,
                yield: 5.93
            }
        ];

        // –°—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–∞–≤–≥—É—Å—Ç 2025)
        const averagePrices = {
            avgSalePrice: 65753,
            avgRentPrice: 328.00
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –º–µ—Å—è—Ü–∞
        function calculateHistoricalPrice(basePrice, percentageChange) {
            const changeMultiplier = 1 + (percentageChange / 100);
            return Math.round(basePrice / changeMultiplier);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–¥–æ–≤ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç
        function filterTrendsByDateRange(trends) {
            if (!trends || trends.length === 0) return [];
            
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç—Ä–µ–Ω–¥—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –≥–æ–¥ (2025)
            const currentYearTrends = trends.filter(trend => trend.property_year === currentYear);
            
            if (currentYearTrends.length === 0) {
                return trends.slice(0, 8);
            }
            
            // –í—ã—á–∏—Å–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –º–µ—Å—è—Ü–µ–≤: 6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ + 1 –º–µ—Å—è—Ü –≤–ø–µ—Ä–µ–¥
            const startMonth = currentMonth - 6;
            const endMonth = currentMonth + 1;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç—Ä–µ–Ω–¥—ã –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –º–µ—Å—è—Ü–µ–≤
            const filteredTrends = currentYearTrends.filter(trend => {
                const month = trend.property_month;
                
                if (startMonth <= 0) {
                    return month >= (12 + startMonth) || month <= endMonth;
                } else {
                    return month >= startMonth && month <= endMonth;
                }
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –º–µ—Å—è—Ü—É (–±—É–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã —Å–≤–µ—Ä—Ö—É, —Ç–µ–∫—É—â–∏–π –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ, –ø—Ä–æ—à–µ–¥—à–∏–µ —Å–Ω–∏–∑—É)
            filteredTrends.sort((a, b) => {
                const monthA = a.property_month;
                const monthB = b.property_month;
                
                if (monthA > currentMonth && monthB > currentMonth) {
                    return monthA - monthB;
                } else if (monthA < currentMonth && monthB < currentMonth) {
                    return monthB - monthA;
                } else if (monthA > currentMonth && monthB === currentMonth) {
                    return -1;
                } else if (monthA === currentMonth && monthB > currentMonth) {
                    return 1;
                } else if (monthA > currentMonth && monthB < currentMonth) {
                    return -1;
                } else if (monthA < currentMonth && monthB > currentMonth) {
                    return 1;
                } else if (monthA === currentMonth && monthB < currentMonth) {
                    return -1;
                } else if (monthA < currentMonth && monthB === currentMonth) {
                    return 1;
                }
                
                return 0;
            });
            
            return filteredTrends.slice(0, 8);
        }

        // –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞
        function testBasicCalculation() {
            const result = document.getElementById('basicResult');
            result.innerHTML = '–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –±–∞–∑–æ–≤–æ–π –ª–æ–≥–∏–∫–∏...\n\n';
            
            try {
                const filteredTrends = filterTrendsByDateRange(mockTrends);
                result.innerHTML += `–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Ç—Ä–µ–Ω–¥–æ–≤: ${filteredTrends.length}\n`;
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—Ä–µ–Ω–¥—ã –ø–æ –¥–∞—Ç–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω
                const sortedTrendsForCalculation = [...filteredTrends].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
                
                result.innerHTML += `\n–¢—Ä–µ–Ω–¥—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –¥–∞—Ç—ã):\n`;
                sortedTrendsForCalculation.forEach((trend, index) => {
                    result.innerHTML += `${index + 1}. ${trend.date} (${trend.property_month}/${trend.property_year})\n`;
                });
                
                result.innerHTML += '\n‚úÖ –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!\n';
                
            } catch (error) {
                result.innerHTML += `‚ùå –û—à–∏–±–∫–∞: ${error.message}\n`;
            }
        }

        // –¢–µ—Å—Ç 2: –†–∞—Å—á–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω
        function testHistoricalCalculation() {
            const result = document.getElementById('historicalResult');
            result.innerHTML = '–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω...\n\n';
            
            try {
                const filteredTrends = filterTrendsByDateRange(mockTrends);
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—Ä–µ–Ω–¥—ã –ø–æ –¥–∞—Ç–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω
                const sortedTrendsForCalculation = [...filteredTrends].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
                
                // –°–æ–∑–¥–∞–µ–º –∫—ç—à –¥–ª—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
                const calculatedPrices = new Map();
                
                result.innerHTML += '–†–∞—Å—á–µ—Ç —Ü–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞:\n\n';
                
                // –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –º–µ—Å—è—Ü–µ–≤, –Ω–∞—á–∏–Ω–∞—è —Å —Ç–µ–∫—É—â–µ–≥–æ
                sortedTrendsForCalculation.forEach((trend, index) => {
                    const trendDate = new Date(trend.date);
                    const trendYear = trendDate.getFullYear();
                    const trendMonth = trendDate.getMonth() + 1;
                    
                    const currentYear = new Date().getFullYear();
                    const currentMonth = new Date().getMonth() + 1;
                    
                    const isCurrentMonth = trendYear === currentYear && trendMonth === currentMonth;
                    const isFutureMonth = trendYear > currentYear || (trendYear === currentYear && trendMonth > currentMonth);
                    const isHistoricalMonth = trendYear < currentYear || (trendYear === currentYear && trendMonth < currentMonth);
                    
                    let salePrice, rentPrice;
                    
                    if (isCurrentMonth) {
                        // –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã
                        salePrice = averagePrices.avgSalePrice;
                        rentPrice = averagePrices.avgRentPrice;
                        result.innerHTML += `üìÖ ${trend.date} (–¢–ï–ö–£–©–ò–ô –ú–ï–°–Ø–¶):\n`;
                        result.innerHTML += `   –ü—Ä–æ–¥–∞–∂–∞: ${salePrice} ‚Ç∫/–º¬≤ (—Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞)\n`;
                        result.innerHTML += `   –ê—Ä–µ–Ω–¥–∞: ${rentPrice} ‚Ç∫/–º¬≤ (—Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞)\n\n`;
                    } else if (isFutureMonth) {
                        // –î–ª—è –±—É–¥—É—â–∏—Ö –º–µ—Å—è—Ü–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                        salePrice = trend.unit_price_for_sale;
                        rentPrice = trend.unit_price_for_rent;
                        result.innerHTML += `üìÖ ${trend.date} (–ë–£–î–£–©–ò–ô –ú–ï–°–Ø–¶):\n`;
                        result.innerHTML += `   –ü—Ä–æ–¥–∞–∂–∞: ${salePrice} ‚Ç∫/–º¬≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞)\n`;
                        result.innerHTML += `   –ê—Ä–µ–Ω–¥–∞: ${rentPrice} ‚Ç∫/–º¬≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞)\n\n`;
                    } else if (isHistoricalMonth) {
                        // –î–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—è—Ü–µ–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã
                        let nextMonthTrend = null;
                        for (let i = index + 1; i < sortedTrendsForCalculation.length; i++) {
                            const nextTrend = sortedTrendsForCalculation[i];
                            const nextTrendDate = new Date(nextTrend.date);
                            const nextTrendYear = nextTrendDate.getFullYear();
                            const nextTrendMonth = nextTrendDate.getMonth() + 1;
                            
                            if (nextTrendYear > trendYear || (nextTrendYear === trendYear && nextTrendMonth > trendMonth)) {
                                nextMonthTrend = nextTrend;
                                break;
                            }
                        }
                        
                        if (nextMonthTrend) {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
                            const nextMonthSalePrice = calculatedPrices.get(nextMonthTrend.date + '_sale') || nextMonthTrend.unit_price_for_sale;
                            const nextMonthRentPrice = calculatedPrices.get(nextMonthTrend.date + '_rent') || nextMonthTrend.unit_price_for_rent;
                            
                            salePrice = calculateHistoricalPrice(nextMonthSalePrice, nextMonthTrend.price_change_sale);
                            rentPrice = calculateHistoricalPrice(nextMonthRentPrice, nextMonthTrend.price_change_rent);
                            
                            result.innerHTML += `üìÖ ${trend.date} (–ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô –ú–ï–°–Ø–¶):\n`;
                            result.innerHTML += `   –°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü: ${nextMonthTrend.date}\n`;
                            result.innerHTML += `   –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: ${salePrice} ‚Ç∫/–º¬≤ (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∏–∑ ${nextMonthSalePrice} - ${nextMonthTrend.price_change_sale}%)\n`;
                            result.innerHTML += `   –¶–µ–Ω–∞ –∞—Ä–µ–Ω–¥—ã: ${rentPrice} ‚Ç∫/–º¬≤ (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∏–∑ ${nextMonthRentPrice} - ${nextMonthTrend.price_change_rent}%)\n\n`;
                        } else {
                            salePrice = trend.unit_price_for_sale;
                            rentPrice = trend.unit_price_for_rent;
                            result.innerHTML += `üìÖ ${trend.date} (–ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô –ú–ï–°–Ø–¶):\n`;
                            result.innerHTML += `   –ü—Ä–æ–¥–∞–∂–∞: ${salePrice} ‚Ç∫/–º¬≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞, –Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞)\n`;
                            result.innerHTML += `   –ê—Ä–µ–Ω–¥–∞: ${rentPrice} ‚Ç∫/–º¬≤ (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞, –Ω–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞)\n\n`;
                        }
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –≤ –∫—ç—à
                    calculatedPrices.set(trend.date + '_sale', salePrice);
                    calculatedPrices.set(trend.date + '_rent', rentPrice);
                });
                
                result.innerHTML += '‚úÖ –†–∞—Å—á–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n';
                
            } catch (error) {
                result.innerHTML += `‚ùå –û—à–∏–±–∫–∞: ${error.message}\n`;
            }
        }

        // –¢–µ—Å—Ç 3: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function testTableDisplay() {
            const result = document.getElementById('tableResult');
            result.innerHTML = '<div class="test-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:</div>';
            
            try {
                const filteredTrends = filterTrendsByDateRange(mockTrends);
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—Ä–µ–Ω–¥—ã –ø–æ –¥–∞—Ç–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω
                const sortedTrendsForCalculation = [...filteredTrends].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateA - dateB;
                });
                
                // –°–æ–∑–¥–∞–µ–º –∫—ç—à –¥–ª—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
                const calculatedPrices = new Map();
                
                // –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö –º–µ—Å—è—Ü–µ–≤
                sortedTrendsForCalculation.forEach((trend, index) => {
                    const trendDate = new Date(trend.date);
                    const trendYear = trendDate.getFullYear();
                    const trendMonth = trendDate.getMonth() + 1;
                    
                    const currentYear = new Date().getFullYear();
                    const currentMonth = new Date().getMonth() + 1;
                    
                    const isCurrentMonth = trendYear === currentYear && trendMonth === currentMonth;
                    const isFutureMonth = trendYear > currentYear || (trendYear === currentYear && trendMonth > currentMonth);
                    const isHistoricalMonth = trendYear < currentYear || (trendYear === currentYear && trendMonth < currentMonth);
                    
                    let salePrice, rentPrice;
                    
                    if (isCurrentMonth) {
                        salePrice = averagePrices.avgSalePrice;
                        rentPrice = averagePrices.avgRentPrice;
                    } else if (isFutureMonth) {
                        salePrice = trend.unit_price_for_sale;
                        rentPrice = trend.unit_price_for_rent;
                    } else if (isHistoricalMonth) {
                        let nextMonthTrend = null;
                        for (let i = index + 1; i < sortedTrendsForCalculation.length; i++) {
                            const nextTrend = sortedTrendsForCalculation[i];
                            const nextTrendDate = new Date(nextTrend.date);
                            const nextTrendYear = nextTrendDate.getFullYear();
                            const nextTrendMonth = nextTrendDate.getMonth() + 1;
                            
                            if (nextTrendYear > trendYear || (nextTrendYear === trendYear && nextTrendMonth > trendMonth)) {
                                nextMonthTrend = nextTrend;
                                break;
                            }
                        }
                        
                        if (nextMonthTrend) {
                            const nextMonthSalePrice = calculatedPrices.get(nextMonthTrend.date + '_sale') || nextMonthTrend.unit_price_for_sale;
                            const nextMonthRentPrice = calculatedPrices.get(nextMonthTrend.date + '_rent') || nextMonthTrend.unit_price_for_rent;
                            
                            salePrice = calculateHistoricalPrice(nextMonthSalePrice, nextMonthTrend.price_change_sale);
                            rentPrice = calculateHistoricalPrice(nextMonthRentPrice, nextMonthTrend.price_change_rent);
                        } else {
                            salePrice = trend.unit_price_for_sale;
                            rentPrice = trend.unit_price_for_rent;
                        }
                    }
                    
                    calculatedPrices.set(trend.date + '_sale', salePrice);
                    calculatedPrices.set(trend.date + '_rent', rentPrice);
                });
                
                // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                let tableHTML = '<table class="trends-table">';
                tableHTML += '<thead><tr>';
                tableHTML += '<th>–î–∞—Ç–∞</th>';
                tableHTML += '<th>–ü—Ä–æ–¥–∞–∂–∞<br>(‚Ç∫/–º¬≤)</th>';
                tableHTML += '<th>–ò–∑–º-–∏–µ —Ü–µ–Ω—ã<br>–ø—Ä–æ–¥–∞–∂–∏</th>';
                tableHTML += '<th>–ê—Ä–µ–Ω–¥–∞<br>(‚Ç∫/–º¬≤)</th>';
                tableHTML += '<th>–ò–∑–º-–∏–µ —Ü–µ–Ω—ã<br>–∞—Ä–µ–Ω–¥—ã</th>';
                tableHTML += '<th>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</th>';
                tableHTML += '</tr></thead><tbody>';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                tableHTML += '<tr><td colspan="6" style="text-align: center; font-size: 10px; color: #666; background: #f8f9fa; padding: 4px;">';
                tableHTML += `–ü–æ–∫–∞–∑–∞–Ω–æ ${filteredTrends.length} –∏–∑ ${mockTrends.length} —Ç—Ä–µ–Ω–¥–æ–≤`;
                tableHTML += '</td></tr>';
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç—Ä–µ–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                filteredTrends.forEach((trend) => {
                    const trendDate = new Date(trend.date);
                    const trendYear = trendDate.getFullYear();
                    const trendMonth = trendDate.getMonth() + 1;
                    
                    const currentYear = new Date().getFullYear();
                    const currentMonth = new Date().getMonth() + 1;
                    
                    const isCurrentMonth = trendYear === currentYear && trendMonth === currentMonth;
                    const isFutureMonth = trendYear > currentYear || (trendYear === currentYear && trendMonth > currentMonth);
                    const isHistoricalMonth = trendYear < currentYear || (trendYear === currentYear && trendMonth < currentMonth);
                    
                    let rowClass = '';
                    if (isCurrentMonth) {
                        rowClass = 'current-month-row';
                    } else if (isFutureMonth) {
                        rowClass = 'forecast-row';
                    } else if (isHistoricalMonth) {
                        rowClass = 'historical-row';
                    }
                    
                    const salePrice = calculatedPrices.get(trend.date + '_sale') || trend.unit_price_for_sale;
                    const rentPrice = calculatedPrices.get(trend.date + '_rent') || trend.unit_price_for_rent;
                    
                    tableHTML += `<tr class="${rowClass}">`;
                    tableHTML += `<td>${trend.date}</td>`;
                    tableHTML += `<td>${salePrice.toLocaleString('ru-RU')}</td>`;
                    tableHTML += `<td>${trend.price_change_sale > 0 ? '+' : ''}${trend.price_change_sale}%</td>`;
                    tableHTML += `<td>${rentPrice.toFixed(2)}</td>`;
                    tableHTML += `<td>${trend.price_change_rent > 0 ? '+' : ''}${trend.price_change_rent}%</td>`;
                    tableHTML += `<td>${trend.yield}%</td>`;
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table>';
                
                result.innerHTML += tableHTML;
                result.innerHTML += '<div style="margin-top: 15px; color: #666; font-size: 12px;">';
                result.innerHTML += '<strong>–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞:</strong><br>';
                result.innerHTML += 'üîµ –°–∏–Ω–∏–π - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü (–∞–≤–≥—É—Å—Ç 2025)<br>';
                result.innerHTML += 'üü° –ñ–µ–ª—Ç—ã–π - –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –º–µ—Å—è—Ü—ã (—Ñ–µ–≤—Ä–∞–ª—å-–∏—é–ª—å 2025)<br>';
                result.innerHTML += '‚ö™ –ë–µ–ª—ã–π - –±—É–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã (—Å–µ–Ω—Ç—è–±—Ä—å 2025)<br>';
                result.innerHTML += '</div>';
                
            } catch (error) {
                result.innerHTML += `<div class="result-area">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
