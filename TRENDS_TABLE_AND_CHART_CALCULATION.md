# Расчет значений для таблицы "Детальные данные трендов" и графика трендов

## Общий процесс

Таблица "Детальные данные трендов" и график трендов формируются в отчете "Оценка объекта" на основе данных из нескольких источников:

### 1. Источники данных

#### 1.1. Таблица `property_trends` (основной источник)
Содержит исторические и прогнозные данные по ценам недвижимости:
- `unit_price_for_sale` - цена продажи за м²
- `unit_price_for_rent` - цена аренды за м²
- `price_change_sale` - процент изменения цены продажи (месяц к месяцу)
- `price_change_rent` - процент изменения цены аренды (месяц к месяцу)
- `yield` - доходность
- `property_year`, `property_month` - год и месяц данных

#### 1.2. Таблицы для базовых цен (используются для текущего месяца)
- `age_data` - данные по возрасту зданий
- `floor_segment_data` - данные по этажности
- `heating_data` - данные по отоплению
- `house_type_data` - данные по типам домов

Каждая содержит:
- `min_unit_price_for_sale`, `max_unit_price_for_sale` - мин/макс цены продажи
- `min_unit_price_for_rent`, `max_unit_price_for_rent` - мин/макс цены аренды

### 2. Алгоритм расчета цен

#### 2.1. Для текущего месяца

1. **Получение базовых цен через API `/api/base_prices`:**
   ```javascript
   // Запрашиваются данные из 4 таблиц для выбранной локации
   // Для каждой таблицы:
   // - Извлекаются все записи для локации
   // - Рассчитывается среднее значение min и max цен
   
   // Итоговые базовые цены:
   base_sale_price = (avg_min_sale + avg_max_sale) / 2
   base_rent_price = (avg_min_rent + avg_max_rent) / 2
   ```

2. **Эти базовые цены используются как цены текущего месяца в таблице**

#### 2.2. Для исторических месяцев (прошлое)

Цены рассчитываются **рекурсивно** от текущего месяца назад:

```javascript
// Формула для исторической цены:
historical_price = next_month_price / (1 + price_change_percentage)

// Где:
// - next_month_price - цена следующего месяца (уже рассчитанная)
// - price_change_percentage - процент изменения из property_trends
```

**Пример:**
- Текущий месяц (сентябрь 2025): 50,836 ₺/м² (базовая цена)
- Август 2025: 50,836 / (1 + 0.0447) = 50,836 / 1.0447 = 48,661 ₺/м²
- Июль 2025: 48,661 / (1 + 0.0443) = 48,661 / 1.0443 = 46,598 ₺/м²

#### 2.3. Для будущих месяцев (прогноз)

Цены рассчитываются **прогрессивно** от текущего месяца вперед:

```javascript
// Формула для будущей цены:
future_price = previous_month_price * (1 + price_change_percentage)

// Где:
// - previous_month_price - цена предыдущего месяца
// - price_change_percentage - процент изменения из property_trends
```

### 3. Фильтрация данных

#### 3.1. Для таблицы
- **Обычные пользователи**: видят 8 месяцев назад + текущий + 1 месяц вперед (всего 10 месяцев)
- **Администраторы**: видят все доступные данные без ограничений

#### 3.2. Для графика
- **Обычные пользователи**: данные с января 2021 года и позже
- **Администраторы**: все доступные данные

### 4. Формирование таблицы

Функция `generateTrendsTable`:
1. Получает статус пользователя (админ/обычный)
2. Подготавливает данные с рассчитанными ценами
3. Фильтрует по диапазону дат
4. Сортирует в обратном хронологическом порядке (новые сверху)
5. Форматирует данные для отображения:
   - Дата: формат "мес. год" (например, "сен. 2025")
   - Цены: с разделителями тысяч
   - Проценты: со знаком + или -
   - Доходность: в процентах

### 5. Формирование графика

Функция `initializeTrendsChart`:
1. Фильтрует данные до текущего месяца + 1 месяц вперед
2. Применяет дополнительную фильтрацию для обычных пользователей
3. Использует рассчитанные цены (как в таблице)
4. Отображает линейный график с точками
5. Позволяет переключаться между ценами продажи и аренды

### 6. Блок "Вывод по тренду"

Функция `generateTrendsAnalysis`:
1. Анализирует последние 12 месяцев исторических данных
2. Рассчитывает общий рост цен (первый vs последний месяц)
3. Определяет диапазон доходности
4. Формирует текстовый анализ на основе трендов

## Ключевые особенности

1. **Согласованность данных**: Все цены в таблице логически связаны через проценты изменения
2. **Двунаправленный расчет**: От текущего месяца назад (история) и вперед (прогноз)
3. **Базовые цены**: Для текущего месяца используются усредненные данные из 4 таблиц
4. **Контроль доступа**: Разные уровни видимости данных для обычных пользователей и админов
5. **Визуализация**: Текущий месяц выделяется голубым фоном в таблице

## Пример данных из скриншота

Из таблицы видно:
- Сентябрь 2025 (текущий): 50,836 ₺/м² продажа, 199.54 ₺/м² аренда
- Август 2025: рассчитано как 50,836 / 1.0447 = 48,661 ₺/м²
- Изменения цен берутся из property_trends (например, +4.47% для августа)
- Доходность также берется из property_trends