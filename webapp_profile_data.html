<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî Aaadviser</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; margin: 0; }
        .container { max-width: 400px; margin: 20px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(102,126,234,0.10); padding: 24px 20px 20px 20px; text-align: center; }
        .title { font-size: 1.3em; font-weight: bold; margin-bottom: 16px; color: #333; }
        .profile-field-block { background: #f8f9fa; border-radius: 10px; padding: 12px 14px; margin-bottom: 12px; text-align: left; box-shadow: 0 2px 8px rgba(102,126,234,0.06); display: flex; align-items: center; justify-content: space-between; }
        .avatar-section { text-align: center; margin-bottom: 20px; }
        .avatar-container { position: relative; display: inline-block; margin-bottom: 15px; }
        .avatar-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #667eea; box-shadow: 0 4px 12px rgba(102,126,234,0.15); }
        .avatar-placeholder { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; border: 4px solid #667eea; }
        .avatar-upload-btn { position: absolute; bottom: -5px; right: -5px; width: 36px; height: 36px; border-radius: 50%; background: #667eea; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 8px rgba(102,126,234,0.3); }
        .avatar-upload-btn:hover { background: #5a6fd8; }
        .file-input { display: none; }
        .profile-field-content { flex: 1; }
        .profile-field-label { font-size: 14px; color: #667eea; font-weight: 600; margin-bottom: 2px; }
        .profile-field-value { font-size: 15px; color: #222; }
        .profile-field-empty { color: #999; font-style: italic; opacity: 0.8; }
        .edit-btn { background: transparent; color: #667eea; border: 2px solid #667eea; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; min-width: 40px; height: 40px; justify-content: center; }
        .edit-btn:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border-color: #764ba2; }
        .back-btn { margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 10px; padding: 14px 28px; font-size: 1em; font-weight: 500; cursor: pointer; transition: background 0.2s; width: 100%; }
        .back-btn:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.25); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal { background: #fff; border-radius: 14px; box-shadow: 0 4px 24px rgba(102,126,234,0.18); padding: 28px 22px 22px 22px; min-width: 280px; max-width: 90vw; text-align: left; box-sizing: border-box; }
        .modal-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 14px; }
        .modal-input { width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; margin-bottom: 18px; background: #f8f9fa; box-sizing: border-box; }
        .modal-textarea { width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; margin-bottom: 18px; background: #f8f9fa; box-sizing: border-box; min-height: 80px; resize: vertical; font-family: inherit; }
        .modal-btn-row { display: flex; gap: 12px; }
        .modal-btn { flex: 1; padding: 12px 0; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .modal-btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .modal-btn-primary:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .modal-btn-secondary { background: #f1f1f1; color: #333; border: 1px solid #ddd; }
        .modal-btn-secondary:hover { background: #e2e2e2; }
        .toast { background: #fff; border-radius: 10px; padding: 14px 18px; color: #333; box-shadow: 0 2px 8px rgba(102,126,234,0.10); position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; font-size: 15px; font-weight: 500; display: none; }
        .toast.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="title" data-i18n="profile_data.title">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
        
        <!-- Avatar Section -->
        <div class="avatar-section">
            <div class="avatar-container">
                <div id="avatarDisplay" class="avatar-placeholder">üë§</div>
                <button class="avatar-upload-btn" onclick="triggerFileUpload()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
                <input type="file" id="avatarInput" class="file-input" accept="image/*" onchange="handleAvatarUpload(event)">
            </div>
        </div>
        
        <div id="fields"></div>
        <button class="back-btn" onclick="goBack()" data-i18n="common.back">–ù–∞–∑–∞–¥</button>
    </div>
    <div id="modal-bg" class="modal-bg" style="display:none;">
        <div class="modal">
            <div class="modal-title" id="modal-title"></div>
            <input type="text" id="modal-input" class="modal-input" style="display: none;" />
            <textarea id="modal-textarea" class="modal-textarea" style="display: none;"></textarea>
            <div class="modal-btn-row">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()" data-i18n="common.cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" onclick="saveModal()" data-i18n="common.save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
        let currentLanguage = 'en';

        // Localization data
        const locales = {
            'ru': {
                'profile_data.title': '–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
                'profile_data.full_name': '–§–∞–º–∏–ª–∏—è –∏ –∏–º—è',
                'profile_data.position': '–î–æ–ª–∂–Ω–æ—Å—Ç—å',
                'profile_data.company_name': '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏',
                'profile_data.website_url': '–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç',
                'profile_data.about_me': '–û–±–æ –º–Ω–µ',
                'profile_data.phone': '–¢–µ–ª–µ—Ñ–æ–Ω',
                'profile_data.email': '–ü–æ—á—Ç–∞',
                'profile_data.whatsapp_link': 'WhatsApp —Å—Å—ã–ª–∫–∞',
                'profile_data.telegram_link': 'Telegram —Å—Å—ã–ª–∫–∞',
                'profile_data.facebook_link': 'Facebook —Å—Å—ã–ª–∫–∞',
                'profile_data.instagram_link': 'Instagram —Å—Å—ã–ª–∫–∞',
                'profile_data.avatar': '–§–æ—Ç–æ',
                'profile_data.empty': '–ø—É—Å—Ç–æ',
                'profile_data.edit': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                'profile_data.edit_title': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:',
                'profile_data.saved': '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!',
                'profile_data.save_error': '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:',
                'profile_data.connection_error': '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',
                'profile_data.load_error': '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö',
                'profile_data.user_not_found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω',
                'profile_data.avatar_upload_error': '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ',
                'profile_data.avatar_uploaded': '–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!',
                'profile_data.placeholder.full_name': '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á',
                'profile_data.placeholder.position': '–†–∏—ç–ª—Ç–æ—Ä / –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º',
                'profile_data.placeholder.company_name': '–û–û–û "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –ü–ª—é—Å"',
                'profile_data.placeholder.website_url': 'https://mycompany.ru',
                'profile_data.placeholder.about_me': '–û–ø—ã—Ç–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –≤ —Å—Ñ–µ—Ä–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ —Å 5-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º. –ü–æ–º–æ–≥–∞—é –∫–ª–∏–µ–Ω—Ç–∞–º –Ω–∞–π—Ç–∏ –∏–¥–µ–∞–ª—å–Ω–æ–µ –∂–∏–ª—å–µ.',
                'profile_data.placeholder.phone': '+7 (999) 123-45-67',
                'profile_data.placeholder.email': 'ivan.ivanov@example.ru',
                'profile_data.placeholder.whatsapp_link': 'https://wa.me/79991234567',
                'profile_data.placeholder.telegram_link': 'https://t.me/ivan_realtor',
                'profile_data.placeholder.facebook_link': 'https://facebook.com/ivan.realtor',
                'profile_data.placeholder.instagram_link': 'https://instagram.com/ivan_realtor',
                'common.back': '–ù–∞–∑–∞–¥',
                'common.cancel': '–û—Ç–º–µ–Ω–∞',
                'common.save': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'
            },
            'en': {
                'profile_data.title': 'Personal Data',
                'profile_data.full_name': 'Full Name',
                'profile_data.position': 'Position',
                'profile_data.company_name': 'Company Name',
                'profile_data.website_url': 'Website URL',
                'profile_data.about_me': 'About Me',
                'profile_data.phone': 'Phone',
                'profile_data.email': 'Email',
                'profile_data.whatsapp_link': 'WhatsApp Link',
                'profile_data.telegram_link': 'Telegram Link',
                'profile_data.facebook_link': 'Facebook Link',
                'profile_data.instagram_link': 'Instagram Link',
                'profile_data.avatar': 'Photo',
                'profile_data.empty': 'empty',
                'profile_data.edit': 'Edit',
                'profile_data.edit_title': 'Edit:',
                'profile_data.saved': 'Saved!',
                'profile_data.save_error': 'Save error:',
                'profile_data.connection_error': 'Connection error',
                'profile_data.load_error': 'Data loading error',
                'profile_data.user_not_found': 'User not found',
                'profile_data.avatar_upload_error': 'Photo upload error',
                'profile_data.avatar_uploaded': 'Photo uploaded!',
                'profile_data.placeholder.full_name': 'John Smith',
                'profile_data.placeholder.position': 'Real Estate Agent / Sales Manager',
                'profile_data.placeholder.company_name': 'Prime Properties LLC',
                'profile_data.placeholder.website_url': 'https://mycompany.com',
                'profile_data.placeholder.about_me': 'Experienced real estate professional with 5 years of expertise. I help clients find their perfect home.',
                'profile_data.placeholder.phone': '+1 (555) 123-4567',
                'profile_data.placeholder.email': 'john.smith@example.com',
                'profile_data.placeholder.whatsapp_link': 'https://wa.me/15551234567',
                'profile_data.placeholder.telegram_link': 'https://t.me/john_realtor',
                'profile_data.placeholder.facebook_link': 'https://facebook.com/john.realtor',
                'profile_data.placeholder.instagram_link': 'https://instagram.com/john_realtor',
                'common.back': 'Back',
                'common.cancel': 'Cancel',
                'common.save': 'Save'
            },
            'de': {
                'profile_data.title': 'Pers√∂nliche Daten',
                'profile_data.full_name': 'Vollst√§ndiger Name',
                'profile_data.position': 'Position',
                'profile_data.company_name': 'Firmenname',
                'profile_data.website_url': 'Website-URL',
                'profile_data.about_me': '√úber mich',
                'profile_data.phone': 'Telefon',
                'profile_data.email': 'E-Mail',
                'profile_data.whatsapp_link': 'WhatsApp-Link',
                'profile_data.telegram_link': 'Telegram-Link',
                'profile_data.facebook_link': 'Facebook-Link',
                'profile_data.instagram_link': 'Instagram-Link',
                'profile_data.avatar': 'Foto',
                'profile_data.empty': 'leer',
                'profile_data.edit': 'Bearbeiten',
                'profile_data.edit_title': 'Bearbeiten:',
                'profile_data.saved': 'Gespeichert!',
                'profile_data.save_error': 'Speicherfehler:',
                'profile_data.connection_error': 'Verbindungsfehler',
                'profile_data.load_error': 'Datenladefehler',
                'profile_data.user_not_found': 'Benutzer nicht gefunden',
                'profile_data.avatar_upload_error': 'Foto-Upload-Fehler',
                'profile_data.avatar_uploaded': 'Foto hochgeladen!',
                'profile_data.placeholder.full_name': 'Hans M√ºller',
                'profile_data.placeholder.position': 'Immobilienmakler / Verkaufsleiter',
                'profile_data.placeholder.company_name': 'M√ºller Immobilien GmbH',
                'profile_data.placeholder.website_url': 'https://meinefirma.de',
                'profile_data.placeholder.about_me': 'Erfahrener Immobilienspezialist mit 5 Jahren Expertise. Ich helfe Kunden, ihr perfektes Zuhause zu finden.',
                'profile_data.placeholder.phone': '+49 (030) 123-4567',
                'profile_data.placeholder.email': 'hans.mueller@beispiel.de',
                'profile_data.placeholder.whatsapp_link': 'https://wa.me/4930123456',
                'profile_data.placeholder.telegram_link': 'https://t.me/hans_immobilien',
                'profile_data.placeholder.facebook_link': 'https://facebook.com/hans.immobilien',
                'profile_data.placeholder.instagram_link': 'https://instagram.com/hans_immobilien',
                'common.back': 'Zur√ºck',
                'common.cancel': 'Abbrechen',
                'common.save': 'Speichern'
            },
            'fr': {
                'profile_data.title': 'Donn√©es Personnelles',
                'profile_data.full_name': 'Nom complet',
                'profile_data.position': 'Poste',
                'profile_data.company_name': 'Nom de l\'entreprise',
                'profile_data.website_url': 'URL du site web',
                'profile_data.about_me': '√Ä propos de moi',
                'profile_data.phone': 'T√©l√©phone',
                'profile_data.email': 'E-mail',
                'profile_data.whatsapp_link': 'Lien WhatsApp',
                'profile_data.telegram_link': 'Lien Telegram',
                'profile_data.facebook_link': 'Lien Facebook',
                'profile_data.instagram_link': 'Lien Instagram',
                'profile_data.avatar': 'Photo',
                'profile_data.empty': 'vide',
                'profile_data.edit': 'Modifier',
                'profile_data.edit_title': 'Modifier:',
                'profile_data.saved': 'Enregistr√©!',
                'profile_data.save_error': 'Erreur de sauvegarde:',
                'profile_data.connection_error': 'Erreur de connexion',
                'profile_data.load_error': 'Erreur de chargement des donn√©es',
                'profile_data.user_not_found': 'Utilisateur non trouv√©',
                'profile_data.avatar_upload_error': 'Erreur de t√©l√©chargement de photo',
                'profile_data.avatar_uploaded': 'Photo t√©l√©charg√©e!',
                'profile_data.placeholder.full_name': 'Pierre Dubois',
                'profile_data.placeholder.position': 'Agent Immobilier / Directeur Commercial',
                'profile_data.placeholder.company_name': 'Dubois Immobilier SARL',
                'profile_data.placeholder.website_url': 'https://monentreprise.fr',
                'profile_data.placeholder.about_me': 'Professionnel exp√©riment√© de l\'immobilier avec 5 ans d\'expertise. J\'aide mes clients √† trouver leur maison parfaite.',
                'profile_data.placeholder.phone': '+33 1 23 45 67 89',
                'profile_data.placeholder.email': 'pierre.dubois@exemple.fr',
                'profile_data.placeholder.whatsapp_link': 'https://wa.me/33123456789',
                'profile_data.placeholder.telegram_link': 'https://t.me/pierre_immobilier',
                'profile_data.placeholder.facebook_link': 'https://facebook.com/pierre.immobilier',
                'profile_data.placeholder.instagram_link': 'https://instagram.com/pierre_immobilier',
                'common.back': 'Retour',
                'common.cancel': 'Annuler',
                'common.save': 'Enregistrer'
            },
            'tr': {
                'profile_data.title': 'Ki≈üisel Veriler',
                'profile_data.full_name': 'Tam Ad',
                'profile_data.position': 'Pozisyon',
                'profile_data.company_name': '≈ûirket Adƒ±',
                'profile_data.website_url': 'Website URL',
                'profile_data.about_me': 'Hakkƒ±mda',
                'profile_data.phone': 'Telefon',
                'profile_data.email': 'E-posta',
                'profile_data.whatsapp_link': 'WhatsApp Linki',
                'profile_data.telegram_link': 'Telegram Linki',
                'profile_data.facebook_link': 'Facebook Linki',
                'profile_data.instagram_link': 'Instagram Linki',
                'profile_data.avatar': 'Fotoƒüraf',
                'profile_data.empty': 'bo≈ü',
                'profile_data.edit': 'D√ºzenle',
                'profile_data.edit_title': 'D√ºzenle:',
                'profile_data.saved': 'Kaydedildi!',
                'profile_data.save_error': 'Kaydetme hatasƒ±:',
                'profile_data.connection_error': 'Baƒülantƒ± hatasƒ±',
                'profile_data.load_error': 'Veri y√ºkleme hatasƒ±',
                'profile_data.user_not_found': 'Kullanƒ±cƒ± bulunamadƒ±',
                'profile_data.avatar_upload_error': 'Fotoƒüraf y√ºkleme hatasƒ±',
                'profile_data.avatar_uploaded': 'Fotoƒüraf y√ºklendi!',
                'profile_data.placeholder.full_name': 'Ahmet Yƒ±lmaz',
                'profile_data.placeholder.position': 'Emlak Danƒ±≈ümanƒ± / Satƒ±≈ü M√ºd√ºr√º',
                'profile_data.placeholder.company_name': 'Yƒ±lmaz Emlak Ltd. ≈ûti.',
                'profile_data.placeholder.website_url': 'https://sirketim.com.tr',
                'profile_data.placeholder.about_me': '5 yƒ±llƒ±k deneyime sahip emlak uzmanƒ±. M√º≈üterilerime m√ºkemmel ev bulmalarƒ±nda yardƒ±mcƒ± oluyorum.',
                'profile_data.placeholder.phone': '+90 (212) 123-4567',
                'profile_data.placeholder.email': 'ahmet.yilmaz@ornek.com.tr',
                'profile_data.placeholder.whatsapp_link': 'https://wa.me/902121234567',
                'profile_data.placeholder.telegram_link': 'https://t.me/ahmet_emlak',
                'profile_data.placeholder.facebook_link': 'https://facebook.com/ahmet.emlak',
                'profile_data.placeholder.instagram_link': 'https://instagram.com/ahmet_emlak',
                'common.back': 'Geri',
                'common.cancel': 'ƒ∞ptal',
                'common.save': 'Kaydet'
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        function getText(key) {
            const locale = locales[currentLanguage] || locales['en'];
            return locale[key] || key;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function getUserLanguage() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                    try {
                        const response = await fetch('/api/user/language', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                telegram_id: tg.initDataUnsafe.user.id,
                                language_code: tg.initDataUnsafe.user.language_code
                            })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                console.log(`üåê –Ø–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: ${data.language} (—Å—Ç–∞—Ç—É—Å: ${data.user_status})`);
                                return data.language;
                            }
                        }
                    } catch (error) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                    }
                }
            }
            return 'en'; // Default to English
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updatePageText() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key) {
                    element.textContent = getText(key);
                }
            });
        }

        const FIELD_MAP = [
            { key: 'full_name', labelKey: 'profile_data.full_name' },
            { key: 'position', labelKey: 'profile_data.position' },
            { key: 'company_name', labelKey: 'profile_data.company_name' },
            { key: 'website_url', labelKey: 'profile_data.website_url' },
            { key: 'about_me', labelKey: 'profile_data.about_me', isTextarea: true },
            { key: 'phone', labelKey: 'profile_data.phone' },
            { key: 'email', labelKey: 'profile_data.email' },
            { key: 'whatsapp_link', labelKey: 'profile_data.whatsapp_link' },
            { key: 'telegram_link', labelKey: 'profile_data.telegram_link' },
            { key: 'facebook_link', labelKey: 'profile_data.facebook_link' },
            { key: 'instagram_link', labelKey: 'profile_data.instagram_link' }
        ];
        let userData = null;
        let currentEditField = null;

        // Avatar functions
        function triggerFileUpload() {
            document.getElementById('avatarInput').click();
        }

        function updateAvatarDisplay(avatarFilename) {
            const avatarDisplay = document.getElementById('avatarDisplay');
            if (avatarFilename) {
                avatarDisplay.innerHTML = `<img src="/user/${userData.id}/${avatarFilename}" class="avatar-image" alt="Avatar">`;
            } else {
                avatarDisplay.innerHTML = 'üë§';
                avatarDisplay.className = 'avatar-placeholder';
            }
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast(getText('profile_data.avatar_upload_error') + ': ' + 'Invalid file type');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast(getText('profile_data.avatar_upload_error') + ': ' + 'File too large');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', file);
            formData.append('telegram_id', userData.id);

            try {
                const response = await fetch('/api/user_avatar', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    userData.avatar_filename = result.filename;
                    updateAvatarDisplay(result.filename);
                    showToast(getText('profile_data.avatar_uploaded'));
                } else {
                    showToast(getText('profile_data.avatar_upload_error') + ': ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Avatar upload error:', error);
                showToast(getText('profile_data.connection_error'));
            }
        }
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        function goBack() {
            window.location.href = '/webapp_profile';
        }
        function openModal(fieldKey, fieldLabel, currentValue, isTextarea = false) {
            currentEditField = fieldKey;
            document.getElementById('modal-title').textContent = getText('profile_data.edit_title') + ' ' + fieldLabel;
            
            const input = document.getElementById('modal-input');
            const textarea = document.getElementById('modal-textarea');
            
            if (isTextarea) {
                input.style.display = 'none';
                textarea.style.display = 'block';
                textarea.value = currentValue === getText('profile_data.empty') ? '' : currentValue;
                setTimeout(() => textarea.focus(), 100);
            } else {
                textarea.style.display = 'none';
                input.style.display = 'block';
                input.value = currentValue === getText('profile_data.empty') ? '' : currentValue;
                setTimeout(() => input.focus(), 100);
            }
            
            document.getElementById('modal-bg').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('modal-bg').style.display = 'none';
            currentEditField = null;
        }
        function saveModal() {
            const input = document.getElementById('modal-input');
            const textarea = document.getElementById('modal-textarea');
            const value = (textarea.style.display === 'block' ? textarea.value : input.value).trim();
            if (!currentEditField) return;
            updateField(currentEditField, value);
            closeModal();
        }
        function renderFields(data) {
            const fieldsDiv = document.getElementById('fields');
            fieldsDiv.innerHTML = '';
            
            // Update avatar display
            updateAvatarDisplay(data.avatar_filename);
            
            FIELD_MAP.forEach(f => {
                const hasValue = data[f.key] && data[f.key].trim();
                const val = hasValue ? data[f.key] : getText(`profile_data.placeholder.${f.key}`);
                const isEmpty = !hasValue;
                const block = document.createElement('div');
                block.className = 'profile-field-block';
                block.innerHTML = `
                    <div class='profile-field-content'>
                        <div class='profile-field-label'>${getText(f.labelKey)}</div>
                        <div class='profile-field-value${isEmpty ? ' profile-field-empty' : ''}'>${val}</div>
                    </div>
                    <button class='edit-btn' onclick="openModal('${f.key}','${getText(f.labelKey)}','${hasValue ? val.replace(/'/g, "&#39;") : ''}', ${f.isTextarea || false})" title="${getText('profile_data.edit')}">
                        ‚úèÔ∏è
                    </button>
                `;
                fieldsDiv.appendChild(block);
            });
        }
        function updateField(field, value) {
            if (!userData || !userData.id) return;
            fetch('/api/user_profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id, [field]: value })
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                    if (resp.profile) {
                        Object.assign(userData, resp.profile);
                    } else {
                        userData[field] = value;
                    }
                    renderFields(userData);
                    showToast(getText('profile_data.saved'));
                } else {
                    showToast(getText('profile_data.save_error') + ' ' + (resp.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch((error) => {
                console.error('Error updating field:', error);
                showToast(getText('profile_data.connection_error'));
            });
        }
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ –≤ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö)
        (async function init() {
            let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (tg) { tg.ready(); tg.expand && tg.expand(); }
            userData = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
            if (!userData) {
                try { userData = JSON.parse(localStorage.getItem('aaadviser_user')); } catch (e) { userData = null; }
            }
            if (!userData || !userData.id) {
                showToast(getText('profile_data.user_not_found'));
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentLanguage = await getUserLanguage();
            console.log(`üåê –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —è–∑—ã–∫–æ–º: ${currentLanguage}`);
            updatePageText();

            fetch('/api/user_profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            })
            .then(res => res.json())
            .then(resp => {
                if (resp && resp.profile) {
                    Object.assign(userData, resp.profile);
                    renderFields(userData);
                } else {
                    showToast(getText('profile_data.load_error'));
                }
            })
            .catch(() => showToast(getText('profile_data.connection_error')));
        })();
    </script>
</body>
</html> 