<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî Aaadviser</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; margin: 0; }
        .container { max-width: 400px; margin: 20px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(102,126,234,0.10); padding: 24px 20px 20px 20px; text-align: center; }
        .title { font-size: 1.3em; font-weight: bold; margin-bottom: 16px; color: #333; }
        .profile-field-block { background: #f8f9fa; border-radius: 10px; padding: 12px 14px; margin-bottom: 12px; text-align: left; box-shadow: 0 2px 8px rgba(102,126,234,0.06); display: flex; align-items: center; justify-content: space-between; }
        .profile-field-content { flex: 1; }
        .profile-field-label { font-size: 14px; color: #667eea; font-weight: 600; margin-bottom: 2px; }
        .profile-field-value { font-size: 15px; color: #222; }
        .profile-field-empty { color: #bbb; font-style: italic; }
        .edit-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s; box-shadow: 0 2px 8px rgba(102,126,234,0.10); display: flex; align-items: center; gap: 6px; min-width: 40px; height: 40px; justify-content: center; }
        .edit-btn:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .back-btn { margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 10px; padding: 14px 28px; font-size: 1em; font-weight: 500; cursor: pointer; transition: background 0.2s; width: 100%; }
        .back-btn:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.25); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal { background: #fff; border-radius: 14px; box-shadow: 0 4px 24px rgba(102,126,234,0.18); padding: 28px 22px 22px 22px; min-width: 280px; max-width: 90vw; text-align: left; box-sizing: border-box; }
        .modal-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 14px; }
        .modal-input { width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; margin-bottom: 18px; background: #f8f9fa; box-sizing: border-box; }
        .modal-btn-row { display: flex; gap: 12px; }
        .modal-btn { flex: 1; padding: 12px 0; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .modal-btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .modal-btn-primary:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        .modal-btn-secondary { background: #f1f1f1; color: #333; border: 1px solid #ddd; }
        .modal-btn-secondary:hover { background: #e2e2e2; }
        .toast { background: #fff; border-radius: 10px; padding: 14px 18px; color: #333; box-shadow: 0 2px 8px rgba(102,126,234,0.10); position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 2000; font-size: 15px; font-weight: 500; display: none; }
        .toast.show { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div class="title" data-i18n="profile_data.title">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
        <div id="fields"></div>
        <button class="back-btn" onclick="goBack()" data-i18n="common.back">–ù–∞–∑–∞–¥</button>
    </div>
    <div id="modal-bg" class="modal-bg" style="display:none;">
        <div class="modal">
            <div class="modal-title" id="modal-title"></div>
            <input type="text" id="modal-input" class="modal-input" />
            <div class="modal-btn-row">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()" data-i18n="common.cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn modal-btn-primary" onclick="saveModal()" data-i18n="common.save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
        let currentLanguage = 'en';

        // Localization data
        const locales = {
            'ru': {
                'profile_data.title': '–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
                'profile_data.first_name': '–ò–º—è',
                'profile_data.last_name': '–§–∞–º–∏–ª–∏—è',
                'profile_data.phone': '–¢–µ–ª–µ—Ñ–æ–Ω',
                'profile_data.email': 'Email',
                'profile_data.website': 'Website',
                'profile_data.company': '–ö–æ–º–ø–∞–Ω–∏—è',
                'profile_data.about_me': '–û —Å–µ–±–µ',
                'profile_data.empty': '–ø—É—Å—Ç–æ',
                'profile_data.edit': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
                'profile_data.edit_title': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:',
                'profile_data.saved': '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!',
                'profile_data.save_error': '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:',
                'profile_data.connection_error': '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è',
                'profile_data.load_error': '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö',
                'profile_data.user_not_found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω',
                'common.back': '–ù–∞–∑–∞–¥',
                'common.cancel': '–û—Ç–º–µ–Ω–∞',
                'common.save': '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'
            },
            'en': {
                'profile_data.title': 'Personal Data',
                'profile_data.first_name': 'First Name',
                'profile_data.last_name': 'Last Name',
                'profile_data.phone': 'Phone',
                'profile_data.email': 'Email',
                'profile_data.website': 'Website',
                'profile_data.company': 'Company',
                'profile_data.about_me': 'About Me',
                'profile_data.empty': 'empty',
                'profile_data.edit': 'Edit',
                'profile_data.edit_title': 'Edit:',
                'profile_data.saved': 'Saved!',
                'profile_data.save_error': 'Save error:',
                'profile_data.connection_error': 'Connection error',
                'profile_data.load_error': 'Data loading error',
                'profile_data.user_not_found': 'User not found',
                'common.back': 'Back',
                'common.cancel': 'Cancel',
                'common.save': 'Save'
            },
            'de': {
                'profile_data.title': 'Pers√∂nliche Daten',
                'profile_data.first_name': 'Vorname',
                'profile_data.last_name': 'Nachname',
                'profile_data.phone': 'Telefon',
                'profile_data.email': 'E-Mail',
                'profile_data.website': 'Website',
                'profile_data.company': 'Unternehmen',
                'profile_data.about_me': '√úber mich',
                'profile_data.empty': 'leer',
                'profile_data.edit': 'Bearbeiten',
                'profile_data.edit_title': 'Bearbeiten:',
                'profile_data.saved': 'Gespeichert!',
                'profile_data.save_error': 'Speicherfehler:',
                'profile_data.connection_error': 'Verbindungsfehler',
                'profile_data.load_error': 'Datenladefehler',
                'profile_data.user_not_found': 'Benutzer nicht gefunden',
                'common.back': 'Zur√ºck',
                'common.cancel': 'Abbrechen',
                'common.save': 'Speichern'
            },
            'fr': {
                'profile_data.title': 'Donn√©es Personnelles',
                'profile_data.first_name': 'Pr√©nom',
                'profile_data.last_name': 'Nom de famille',
                'profile_data.phone': 'T√©l√©phone',
                'profile_data.email': 'E-mail',
                'profile_data.website': 'Site web',
                'profile_data.company': 'Entreprise',
                'profile_data.about_me': '√Ä propos de moi',
                'profile_data.empty': 'vide',
                'profile_data.edit': 'Modifier',
                'profile_data.edit_title': 'Modifier:',
                'profile_data.saved': 'Enregistr√©!',
                'profile_data.save_error': 'Erreur de sauvegarde:',
                'profile_data.connection_error': 'Erreur de connexion',
                'profile_data.load_error': 'Erreur de chargement des donn√©es',
                'profile_data.user_not_found': 'Utilisateur non trouv√©',
                'common.back': 'Retour',
                'common.cancel': 'Annuler',
                'common.save': 'Enregistrer'
            },
            'tr': {
                'profile_data.title': 'Ki≈üisel Veriler',
                'profile_data.first_name': 'Ad',
                'profile_data.last_name': 'Soyad',
                'profile_data.phone': 'Telefon',
                'profile_data.email': 'E-posta',
                'profile_data.website': 'Web sitesi',
                'profile_data.company': '≈ûirket',
                'profile_data.about_me': 'Hakkƒ±mda',
                'profile_data.empty': 'bo≈ü',
                'profile_data.edit': 'D√ºzenle',
                'profile_data.edit_title': 'D√ºzenle:',
                'profile_data.saved': 'Kaydedildi!',
                'profile_data.save_error': 'Kaydetme hatasƒ±:',
                'profile_data.connection_error': 'Baƒülantƒ± hatasƒ±',
                'profile_data.load_error': 'Veri y√ºkleme hatasƒ±',
                'profile_data.user_not_found': 'Kullanƒ±cƒ± bulunamadƒ±',
                'common.back': 'Geri',
                'common.cancel': 'ƒ∞ptal',
                'common.save': 'Kaydet'
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        function getText(key) {
            const locale = locales[currentLanguage] || locales['en'];
            return locale[key] || key;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function getUserLanguage() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                    try {
                        const response = await fetch('/api/user/language', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                telegram_id: tg.initDataUnsafe.user.id,
                                language_code: tg.initDataUnsafe.user.language_code
                            })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                console.log(`üåê –Ø–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: ${data.language} (—Å—Ç–∞—Ç—É—Å: ${data.user_status})`);
                                return data.language;
                            }
                        }
                    } catch (error) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                    }
                }
            }
            return 'en'; // Default to English
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updatePageText() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key) {
                    element.textContent = getText(key);
                }
            });
        }

        const FIELD_MAP = [
            { key: 'first_name', labelKey: 'profile_data.first_name' },
            { key: 'last_name', labelKey: 'profile_data.last_name' },
            { key: 'phone', labelKey: 'profile_data.phone' },
            { key: 'email', labelKey: 'profile_data.email' },
            { key: 'website', labelKey: 'profile_data.website' },
            { key: 'company', labelKey: 'profile_data.company' },
            { key: 'about_me', labelKey: 'profile_data.about_me' }
        ];
        let userData = null;
        let currentEditField = null;
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        function goBack() {
            window.location.href = '/webapp_profile';
        }
        function openModal(fieldKey, fieldLabel, currentValue) {
            currentEditField = fieldKey;
            document.getElementById('modal-title').textContent = getText('profile_data.edit_title') + ' ' + fieldLabel;
            document.getElementById('modal-input').value = currentValue === getText('profile_data.empty') ? '' : currentValue;
            document.getElementById('modal-bg').style.display = 'flex';
            setTimeout(() => document.getElementById('modal-input').focus(), 100);
        }
        function closeModal() {
            document.getElementById('modal-bg').style.display = 'none';
            currentEditField = null;
        }
        function saveModal() {
            const value = document.getElementById('modal-input').value.trim();
            if (!currentEditField) return;
            updateField(currentEditField, value);
            closeModal();
        }
        function renderFields(data) {
            const fieldsDiv = document.getElementById('fields');
            fieldsDiv.innerHTML = '';
            FIELD_MAP.forEach(f => {
                const val = data[f.key] && data[f.key].trim() ? data[f.key] : getText('profile_data.empty');
                const block = document.createElement('div');
                block.className = 'profile-field-block';
                block.innerHTML = `
                    <div class='profile-field-content'>
                        <div class='profile-field-label'>${getText(f.labelKey)}</div>
                        <div class='profile-field-value${val===getText('profile_data.empty') ? ' profile-field-empty' : ''}'>${val}</div>
                    </div>
                    <button class='edit-btn' onclick="openModal('${f.key}','${getText(f.labelKey)}','${val.replace(/'/g, "&#39;")}')" title="${getText('profile_data.edit')}">
                        ‚úèÔ∏è
                    </button>
                `;
                fieldsDiv.appendChild(block);
            });
        }
        function updateField(field, value) {
            if (!userData || !userData.id) return;
            fetch('/api/user_profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id, [field]: value })
            })
            .then(res => res.json())
            .then(resp => {
                if (resp.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                    if (resp.profile) {
                        Object.assign(userData, resp.profile);
                    } else {
                        userData[field] = value;
                    }
                    renderFields(userData);
                    showToast(getText('profile_data.saved'));
                } else {
                    showToast(getText('profile_data.save_error') + ' ' + (resp.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch((error) => {
                console.error('Error updating field:', error);
                showToast(getText('profile_data.connection_error'));
            });
        }
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–∞–∫ –≤ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö)
        (async function init() {
            let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (tg) { tg.ready(); tg.expand && tg.expand(); }
            userData = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
            if (!userData) {
                try { userData = JSON.parse(localStorage.getItem('aaadviser_user')); } catch (e) { userData = null; }
            }
            if (!userData || !userData.id) {
                showToast(getText('profile_data.user_not_found'));
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentLanguage = await getUserLanguage();
            console.log(`üåê –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —è–∑—ã–∫–æ–º: ${currentLanguage}`);
            updatePageText();

            fetch('/api/user_profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            })
            .then(res => res.json())
            .then(resp => {
                if (resp && resp.profile) {
                    Object.assign(userData, resp.profile);
                    renderFields(userData);
                } else {
                    showToast(getText('profile_data.load_error'));
                }
            })
            .catch(() => showToast(getText('profile_data.connection_error')));
        })();
    </script>
</body>
</html> 