<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - –ò–Ω—Å–∞–π—Ç—ã —Ä—ã–Ω–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #f0f0f0;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .slogan {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #667eea;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6fd8;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .property-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .property-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .property-address {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .property-details {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .property-price {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .button-group-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .report-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .report-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insights {
            margin: 25px 0;
        }

        .insight-item {
            background: #f0f8ff;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            border-left: 3px solid #4CAF50;
        }

        .insight-text {
            font-size: 14px;
            color: #333;
        }

        .balance-info {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .balance-amount {
            font-size: 20px;
            font-weight: bold;
            color: #28a745;
        }

        .hidden {
            display: none;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üè† Aaadviser</div>
            <div class="slogan">–ò–Ω—Å–∞–π—Ç—ã —Ä—ã–Ω–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –ê–Ω—Ç–∞–ª–∏–∏</div>
        </div>

        <!-- –ù–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="initial-screen">
            <div class="form-group">
                <label class="form-label">üìç –ê–¥—Ä–µ—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>
                <input type="text" id="address" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ">
            </div>
            
            <div class="form-group">
                <label class="form-label">üõèÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∞–ª–µ–Ω</label>
                <select id="bedrooms" class="form-input">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∞–ª–µ–Ω</option>
                    <option value="1">1 —Å–ø–∞–ª—å–Ω—è</option>
                    <option value="2">2 —Å–ø–∞–ª—å–Ω–∏</option>
                    <option value="3">3 —Å–ø–∞–ª—å–Ω–∏</option>
                    <option value="4">4 —Å–ø–∞–ª—å–Ω–∏</option>
                    <option value="5">5+ —Å–ø–∞–ª–µ–Ω</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">üí∞ –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ (USD)</label>
                <input type="number" id="price" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö">
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="generateReport()">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-screen" class="hidden">
            <div class="loading">
                <div class="spinner"></div>
                <p>–í–∞—à –æ—Ç—á–µ—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è...</p>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º -->
        <div id="result-screen" class="hidden">
            <div class="property-card">
                <div class="property-address" id="property-address"></div>
                <div class="property-details">
                    <span>üõèÔ∏è <span id="property-bedrooms"></span> —Å–ø–∞–ª–µ–Ω</span>
                    <span>üí∞ <span id="property-price"></span> USD</span>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="showMainMenu()">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
                <button class="btn btn-primary" onclick="copyToClipboard()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä</button>
            </div>
            
            <div class="button-group-vertical">
                <button class="btn btn-success" onclick="getFullReport()">–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ -->
        <div id="full-report-screen" class="hidden">
            <div class="balance-info">
                <div>–í–∞—à –±–∞–ª–∞–Ω—Å: <span class="balance-amount" id="user-balance">$0</span></div>
                <div>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞: $1</div>
            </div>
            
            <div id="full-report-content"></div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="showMainMenu()">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
                <button class="btn btn-success" onclick="generatePDF()">–°–∫–∞—á–∞—Ç—å PDF</button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ -->
        <div id="client-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –∫–ª–∏–µ–Ω—Ç—É</h3>
                    <span class="close" onclick="closeClientModal()">&times;</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="text" id="client-name" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Telegram username –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="text" id="client-telegram" class="form-input" placeholder="@username">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í–∫–ª—é—á–∏—Ç—å –≤ PDF:</label>
                    <div>
                        <input type="checkbox" id="include-macro" checked> <label for="include-macro">–ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</label>
                    </div>
                    <div>
                        <input type="checkbox" id="include-financial" checked> <label for="include-financial">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</label>
                    </div>
                    <div>
                        <input type="checkbox" id="include-regional" checked> <label for="include-regional">–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</label>
                    </div>
                    <div>
                        <input type="checkbox" id="include-tax" checked> <label for="include-tax">–ù–∞–ª–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                    </div>
                    <div>
                        <input type="checkbox" id="include-risk" checked> <label for="include-risk">–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤</label>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="sendPDFToClient()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É</button>
                    <button class="btn btn-secondary" onclick="closeClientModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let currentReport = null;
        let currentProperty = null;
        let userBalance = 0;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
        tg.ready();
        tg.expand();

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function getUserData() {
            try {
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: tg.initDataUnsafe?.user?.id,
                        username: tg.initDataUnsafe?.user?.username,
                        first_name: tg.initDataUnsafe?.user?.first_name,
                        last_name: tg.initDataUnsafe?.user?.last_name
                    })
                });
                const data = await response.json();
                if (data.success) {
                    userBalance = data.balance || 0;
                    document.getElementById('user-balance').textContent = `$${userBalance}`;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        async function generateReport() {
            const address = document.getElementById('address').value;
            const bedrooms = document.getElementById('bedrooms').value;
            const price = document.getElementById('price').value;

            if (!address || !bedrooms || !price) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            showScreen('loading-screen');

            try {
                const response = await fetch('/api/generate_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: address,
                        bedrooms: parseInt(bedrooms),
                        price_usd: parseFloat(price),
                        telegram_id: tg.initDataUnsafe?.user?.id
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentReport = data.report;
                    currentProperty = {
                        address: address,
                        bedrooms: bedrooms,
                        price: price
                    };
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
                    document.getElementById('property-address').textContent = address;
                    document.getElementById('property-bedrooms').textContent = bedrooms;
                    document.getElementById('property-price').textContent = price;
                    
                    showScreen('result-screen');
                } else {
                    alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: ' + data.error);
                    showScreen('initial-screen');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
                showScreen('initial-screen');
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        async function getFullReport() {
            if (userBalance < 1) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ $1 –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞.');
                return;
            }

            showScreen('loading-screen');

            try {
                const response = await fetch('/api/full_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        property_data: currentProperty,
                        telegram_id: tg.initDataUnsafe?.user?.id
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayFullReport(data.report);
                    showScreen('full-report-screen');
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞: ' + data.error);
                    showScreen('result-screen');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞');
                showScreen('result-screen');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        function displayFullReport(report) {
            const container = document.getElementById('full-report-content');
            
            let html = `
                <div class="report-section">
                    <div class="report-title">üìä –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">${report.macroeconomic_data.inflation}%</div>
                            <div class="metric-label">–ò–Ω—Ñ–ª—è—Ü–∏—è</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.macroeconomic_data.currency_rate}</div>
                            <div class="metric-label">–ö—É—Ä—Å USD/TRY</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.macroeconomic_data.interest_rate}%</div>
                            <div class="metric-label">–°—Ç–∞–≤–∫–∞ –¶–ë</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.macroeconomic_data.gdp_growth}%</div>
                            <div class="metric-label">–†–æ—Å—Ç –í–í–ü</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-title">üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">${report.financial_market_data.deposit_rates.TRY}%</div>
                            <div class="metric-label">–î–µ–ø–æ–∑–∏—Ç—ã TRY</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.financial_market_data.deposit_rates.USD}%</div>
                            <div class="metric-label">–î–µ–ø–æ–∑–∏—Ç—ã USD</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.financial_market_data.bond_yields['5_year']}%</div>
                            <div class="metric-label">–û–±–ª–∏–≥–∞—Ü–∏–∏ 5 –ª–µ—Ç</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.financial_market_data.real_estate_funds.PROPERTY_FUND_YIELD}%</div>
                            <div class="metric-label">–§–æ–Ω–¥—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-title">üèòÔ∏è –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ê–Ω—Ç–∞–ª–∏–∏</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">${report.regional_indicators.antalya_property_price_growth}%</div>
                            <div class="metric-label">–†–æ—Å—Ç —Ü–µ–Ω –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.regional_indicators.antalya_rental_yield}%</div>
                            <div class="metric-label">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.regional_indicators.antalya_tourism_growth}%</div>
                            <div class="metric-label">–†–æ—Å—Ç —Ç—É—Ä–∏–∑–º–∞</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.regional_indicators.antalya_gdp_growth}%</div>
                            <div class="metric-label">–†–æ—Å—Ç –í–í–ü —Ä–µ–≥–∏–æ–Ω–∞</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-title">üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">${report.investment_analysis.rental_yield_percentage.toFixed(1)}%</div>
                            <div class="metric-label">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${report.investment_analysis.net_yield_percentage.toFixed(1)}%</div>
                            <div class="metric-label">–ß–∏—Å—Ç–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">$${report.investment_analysis.monthly_rent_estimate.toFixed(0)}</div>
                            <div class="metric-label">–ú–µ—Å—è—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">$${report.investment_analysis.net_annual_income.toFixed(0)}</div>
                            <div class="metric-label">–ì–æ–¥–æ–≤–æ–π –¥–æ—Ö–æ–¥</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-title">‚ö†Ô∏è –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤</div>
                    <div class="insights">
                        <div class="insight-item">
                            <div class="insight-text">–í–∞–ª—é—Ç–Ω—ã–π —Ä–∏—Å–∫: ${report.risk_assessment.currency_risk}</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-text">–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫: ${report.risk_assessment.political_risk}</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-text">–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫: ${report.risk_assessment.economic_risk}</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-text">–û–±—â–∏–π —Ä–∏—Å–∫: ${report.risk_assessment.overall_risk_score}/10</div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <div class="report-title">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                    <div class="insights">
                        ${report.recommendations.map(rec => `
                            <div class="insight-item">
                                <div class="insight-text">${rec}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF
        async function generatePDF() {
            const clientName = document.getElementById('client-name').value;
            const clientTelegram = document.getElementById('client-telegram').value;
            
            if (!clientName || !clientTelegram) {
                document.getElementById('client-modal').style.display = 'block';
                return;
            }

            showScreen('loading-screen');

            try {
                const response = await fetch('/api/generate_pdf_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        property_data: currentProperty,
                        full_report: currentReport,
                        client_name: clientName,
                        client_telegram: clientTelegram,
                        include_macro: document.getElementById('include-macro').checked,
                        include_financial: document.getElementById('include-financial').checked,
                        include_regional: document.getElementById('include-regional').checked,
                        include_tax: document.getElementById('include-tax').checked,
                        include_risk: document.getElementById('include-risk').checked,
                        telegram_id: tg.initDataUnsafe?.user?.id
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // –°–∫–∞—á–∏–≤–∞–µ–º PDF
                    const downloadResponse = await fetch('/api/download_pdf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            pdf_filename: data.pdf_filename,
                            telegram_id: tg.initDataUnsafe?.user?.id
                        })
                    });

                    if (downloadResponse.ok) {
                        const blob = await downloadResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.pdf_filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É
                        showSendToClientButton();
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É
        function showSendToClientButton() {
            const buttonGroup = document.querySelector('#full-report-screen .button-group');
            const sendButton = document.createElement('button');
            sendButton.className = 'btn btn-success';
            sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É';
            sendButton.onclick = sendPDFToClient;
            buttonGroup.appendChild(sendButton);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ PDF –∫–ª–∏–µ–Ω—Ç—É
        async function sendPDFToClient() {
            const clientName = document.getElementById('client-name').value;
            const clientTelegram = document.getElementById('client-telegram').value;
            
            if (!clientName || !clientTelegram) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }

            try {
                const response = await fetch('/api/send_pdf_to_client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_name: clientName,
                        client_telegram: clientTelegram,
                        property_data: currentProperty,
                        telegram_id: tg.initDataUnsafe?.user?.id
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('PDF —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É!');
                    closeClientModal();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ PDF');
            }
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
        function copyToClipboard() {
            const text = `–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å: ${currentProperty.address}\n–°–ø–∞–ª—å–Ω–∏: ${currentProperty.bedrooms}\n–¶–µ–Ω–∞: $${currentProperty.price}`;
            navigator.clipboard.writeText(text).then(() => {
                alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            }).catch(() => {
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        function showMainMenu() {
            showScreen('initial-screen');
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–ª–∏–µ–Ω—Ç–∞
        function closeClientModal() {
            document.getElementById('client-modal').style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
        function showScreen(screenId) {
            const screens = ['initial-screen', 'loading-screen', 'result-screen', 'full-report-screen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            getUserData();
        });
    </script>
</body>
</html> 