<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/static/i18n-manager.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - Новый отчет</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }
        .logo {
            width: 110px;
            height: auto;
            display: block;
            margin: 0 auto 8px auto;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .logo:hover {
            transform: scale(1.05);
        }
        .slogan {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-bottom: 40px;
        }
        .step-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(102,126,234,0.08);
            padding: 32px 24px 28px 24px;
            width: 100%;
            max-width: 360px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
            position: relative;
            z-index: 1;
        }
        .step-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 18px;
            text-align: center;
        }
        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 18px;
            background: #f8f9fa;
            transition: border 0.2s;
            pointer-events: auto;
            position: relative;
            z-index: 10;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        .input-field:focus {
            border: 1.5px solid #667eea;
            outline: none;
        }
        .btn-row {
            display: flex;
            gap: 12px;
            width: 100%;
            margin-top: 10px;
        }
        .btn {
            flex: 1;
            padding: 14px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        .btn-secondary {
            background: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
        }
        .btn-secondary:hover {
            background: #e2e2e2;
        }
        .map-block {
            width: 100%;
            height: 220px;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 18px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
        }
        .report-block {
            background: #f8f9fa;
            border-radius: 14px;
            padding: 22px 16px;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.06);
        }
        .report-title {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
            text-align: center;
        }
        .report-row {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            margin-bottom: 8px;
        }
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 16px;
            margin-top: 30px;
        }
        .error {
            color: #c33;
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 18px;
            text-align: center;
        }

        /* Progress Bar Styles */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            pointer-events: auto;
        }

        .progress-card {
            background: white;
            border-radius: 18px;
            padding: 32px 24px;
            text-align: center;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .progress-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .progress-text {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            max-width: 300px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #667eea;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: #28a745;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast.info {
            border-left-color: #17a2b8;
        }

        /* Client Modal Styles */
        .client-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.25);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .client-modal-content {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(102, 126, 234, 0.18);
            padding: 32px 24px 24px 24px;
            max-width: 340px;
            width: 90vw;
            text-align: center;
        }

        .client-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 18px;
            background: #f8f9fa;
            transition: border 0.2s;
        }

        .client-input:focus {
            border: 1.5px solid #667eea;
            outline: none;
        }

        /* Toast с автоисчезновением и анимацией */
        .toast.fade-out { opacity: 0; transition: opacity 0.4s; }
        #modal-info.fade-out, #modal-confirm.fade-out, #modal-topup.fade-out, #topup-modal.fade-out { opacity: 0; transition: opacity 0.35s; }
    </style>
</head>
<body>
    <div class="container">
        <img src="logo-flt.png" alt="Aaadviser" class="logo" onclick="goToMainMenu()">
        <div class="slogan">Инсайты рынка недвижимости</div>

        <!-- Шаг 1: Ввод адреса -->
        <div id="step-address" class="step-card">
            <div class="step-title">Введите адрес недвижимости</div>
            <input type="text" id="addressInput" class="input-field" placeholder="Например: ул. Ленина, 10, Москва">
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="goToMainMenu()">В главное меню</button>
                <button class="btn btn-primary" onclick="verifyAddress()" data-i18n="common.next" data-i18n="common.next">Далее</button>
            </div>
            <div id="address-error" class="error" style="display:none;"></div>
        </div>

        <!-- Шаг 2: Карта и подтверждение -->
        <div id="step-map" class="step-card" style="display:none;">
            <div class="step-title">Это правильная локация?</div>
            <div class="map-block" id="map"></div>
            <div style="font-size:15px;color:#555;margin-bottom:10px;" id="confirmedAddress"></div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="backToAddress()" data-i18n="common.no" data-i18n="common.no">Нет</button>
                <button class="btn btn-primary" onclick="confirmLocation()" data-i18n="common.yes" data-i18n="common.yes">Да</button>
            </div>
        </div>

        <!-- Шаг 3: Выбор количества спален -->
        <div id="step-bedrooms" class="step-card" style="display:none;">
            <div class="step-title">Выберите количество спален</div>
            <select id="bedroomsSelect" class="input-field">
                <option value="0">0 - студия</option>
                <option value="1">1 спальня</option>
                <option value="2">2 спальни</option>
                <option value="3" selected>3 спальни</option>
                <option value="4">4 спальни</option>
                <option value="5">5+ спален</option>
            </select>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="backToMap()" data-i18n="common.back" data-i18n="common.back">Назад</button>
                <button class="btn btn-primary" onclick="confirmBedrooms()" data-i18n="common.next" data-i18n="common.next">Далее</button>
            </div>
        </div>

        <!-- Шаг 4: Ввод цены -->
        <div id="step-price" class="step-card" style="display:none;">
            <div class="step-title">Введите цену недвижимости</div>
            <input type="number" id="priceInput" class="input-field" placeholder="Цена в евро (например: 500000)" min="10000" step="1000">
            <div style="font-size:14px;color:#666;margin-bottom:15px;">Введите стоимость объекта в евро</div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="backToBedrooms()" data-i18n="common.back" data-i18n="common.back">Назад</button>
                <button class="btn btn-primary" onclick="confirmPrice()">Сформировать отчет</button>
            </div>
            <div id="price-error" class="error" style="display:none;"></div>
        </div>

        <!-- Шаг 5: Отчет -->
        <div id="step-report" class="step-card" style="display:none;">
            <div id="reportResult" class="report-block"></div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="goToMainMenu()">В главное меню</button>
            </div>
        </div>

        <div id="loading" class="loading" style="display:none;" data-i18n="common.loading" data-i18n="common.loading">Загрузка...</div>
    </div>

    <!-- Progress Bar Container -->
    <div id="progress-container" class="progress-container" style="display: none;">
        <div class="progress-card">
            <div class="progress-spinner"></div>
            <div class="progress-text" id="progress-text">Обрабатываем запрос...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrDkDpNKNAIyY147MQ78hchBkeyCAxhEw"></script>
    <script>
        let geoData = null;
        let lastAddress = '';
        // Новые переменные для параметров последнего отчета
        let lastReportAddress = '';
        let lastReportBedrooms = '';
        let lastReportPrice = '';
        let currentReportData = null; // Для хранения данных текущего отчета

        // Progress Bar Functions
        function showProgressBar(text, progress = 0) {
            document.getElementById('progress-text').textContent = text;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-container').style.display = 'flex';
        }

        function updateProgressBar(progress) {
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        function hideProgressBar() {
            document.getElementById('progress-container').style.display = 'none';
        }

        // Toast Notification Functions
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('fade-out');
                setTimeout(() => container.removeChild(toast), 400);
            }, duration);
        }

        // Localization helper
        function getLocalizedText(key) {
            const currentLang = 'ru'; // Можно сделать динамическим
            const texts = {
                'ru': {
                    'progress': {
                        'checking_balance': 'Проверяем баланс...',
                        'generating_report': 'Формируем полный отчет...',
                        'sending_to_client': 'Отправляем отчет клиенту...',
                        'processing_request': 'Обрабатываем запрос...'
                    },
                    'notifications': {
                        'report_copied': 'Данные отчета скопированы в буфер обмена!',
                        'copy_error': 'Ошибка копирования в буфер',
                        'balance_check_error': 'Ошибка проверки баланса',
                        'deduction_error': 'Ошибка списания баланса',
                        'connection_error': 'Ошибка соединения при формировании отчета',
                        'report_generated': 'Полный отчет сформирован!',
                        'report_sent_success': 'Отчет успешно отправлен клиенту!',
                        'report_sent_error': 'Ошибка отправки отчета',
                        'connection_send_error': 'Ошибка соединения при отправке',
                        'fill_all_fields': 'Пожалуйста, заполните все поля',
                        'report_data_error': 'Ошибка: данные отчета не найдены'
                    },
                    'client_modal': {
                        'title': 'Отправить отчет клиенту',
                        'client_name_placeholder': 'Имя клиента',
                        'client_username_placeholder': 'Telegram username (без @)',
                        'cancel': 'Отмена',
                        'send': 'Отправить'
                    }
                }
            };
            
            const lang = texts[currentLang] || texts['ru'];
            const parts = key.split('.');
            let result = lang;
            for (const part of parts) {
                result = result[part];
                if (!result) return key;
            }
            return result;
        }

        function showStep(step) {
            document.getElementById('step-address').style.display = 'none';
            document.getElementById('step-map').style.display = 'none';
            document.getElementById('step-bedrooms').style.display = 'none';
            document.getElementById('step-price').style.display = 'none';
            document.getElementById('step-report').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            if (step === 'address') document.getElementById('step-address').style.display = 'flex';
            if (step === 'map') document.getElementById('step-map').style.display = 'flex';
            if (step === 'bedrooms') document.getElementById('step-bedrooms').style.display = 'flex';
            if (step === 'price') {
                document.getElementById('step-price').style.display = 'flex';
                var priceInput = document.getElementById('priceInput');
                if (priceInput) { priceInput.disabled = false; priceInput.readOnly = false; }
            }
            if (step === 'report') document.getElementById('step-report').style.display = 'flex';
            if (step === 'loading') document.getElementById('loading').style.display = 'block';
        }

        function goToMainMenu() {
            window.location.href = '/webapp';
        }

        function backToAddress() {
            showStep('address');
            document.getElementById('addressInput').value = lastAddress;
        }

        function backToMap() {
            showStep('map');
        }

        function backToBedrooms() {
            showStep('bedrooms');
        }

        async function verifyAddress() {
            const address = document.getElementById('addressInput').value.trim();
            document.getElementById('address-error').style.display = 'none';
            if (!address) {
                showError('address-error', 'Пожалуйста, введите адрес.');
                return;
            }
            showStep('loading');
            try {
                const res = await fetch('/api/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                const data = await res.json();
                if (data.success) {
                    geoData = data;
                    lastAddress = data.formatted_address;
                    showMap(data.lat, data.lng);
                    document.getElementById('confirmedAddress').innerText = data.formatted_address;
                    
                    // Сохраняем коды локаций для использования при генерации отчета
                    if (data.location_codes) {
                        geoData.location_codes = data.location_codes;
                        console.log('Найдены коды локаций:', data.location_codes);
                    } else {
                        console.log('Коды локаций не найдены');
                    }
                    
                    showStep('map');
                } else {
                    showStep('address');
                    showError('address-error', 'Адрес не найден, попробуйте еще раз.');
                }
            } catch (e) {
                showStep('address');
                showError('address-error', 'Ошибка соединения. Попробуйте позже.');
            }
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.style.display = 'block';
        }

        function showMap(lat, lng) {
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '';
            const map = new google.maps.Map(mapDiv, {
                center: { lat, lng },
                zoom: 16,
                disableDefaultUI: true
            });
            new google.maps.Marker({ position: { lat, lng }, map });
        }

        function confirmLocation() {
            showStep('bedrooms');
        }

        function confirmBedrooms() {
            showStep('price');
        }

        async function confirmPrice() {
            const priceInput = document.getElementById('priceInput');
            const price = priceInput.value.trim();
            const bedrooms = document.getElementById('bedroomsSelect').value;
            document.getElementById('price-error').style.display = 'none';

            if (!price || price < 10000) {
                showError('price-error', 'Пожалуйста, введите корректную цену (минимум 10,000 евро).');
                priceInput.disabled = false;
                priceInput.readOnly = false;
                priceInput.focus();
                return;
            }

            showStep('loading');
            try {
                const res = await fetch('/api/generate_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: geoData.formatted_address,
                        lat: geoData.lat,
                        lng: geoData.lng,
                        bedrooms: parseInt(bedrooms),
                        price: parseFloat(price),
                        language: 'ru',
                        location_codes: geoData.location_codes || null,
                        location_components: geoData.location_components || null
                    })
                });
                const data = await res.json();
                if (data.success) {
                    window.lastApiReport = data.report; // Сохраняем отчет для дальнейшего использования
                    renderReport(data.report_text, geoData.formatted_address, bedrooms, price);
                    showStep('report');
                } else {
                    showStep('price');
                    showError('price-error', 'Ошибка генерации отчета.');
                }
            } catch (e) {
                showStep('price');
                showError('price-error', 'Ошибка соединения.');
            }
        }

        // Helper for declension and localization
        function getObjectLabel(count) {
            // Determine language
            let lang = (typeof currentLanguage !== 'undefined') ? currentLanguage : 'ru';
            let words = ['объект', 'объекта', 'объектов'];
            if (lang === 'en') words = ['object', 'objects'];
            if (lang === 'de') words = ['Objekt', 'Objekte'];
            if (lang === 'fr') words = ['objet', 'objets'];
            if (lang === 'tr') words = ['nesne', 'nesne'];
            // Russian declension
            if (lang === 'ru') {
                if (typeof count !== 'number') return '';
                let word = words[2];
                if (count % 10 === 1 && count % 100 !== 11) word = words[0];
                else if ([2,3,4].includes(count % 10) && ![12,13,14].includes(count % 100)) word = words[1];
                return `${count} ${word}`;
            } else {
                // For other languages: singular/plural
                let word = (count === 1) ? words[0] : words[1];
                return `${count} ${word}`;
            }
        }

        function renderReport(reportText, address, bedrooms, price) {
            // Сохраняем параметры для дальнейшего использования в модалке
            lastReportAddress = address;
            lastReportBedrooms = bedrooms;
            lastReportPrice = price;
            currentReportData = { address, bedrooms, price }; // Сохраняем данные отчета
            
            // Оставляем только один крупный заголовок
            let headerHtml = '';
            headerHtml += `<div style='font-size:22px;font-weight:800;color:#667eea;margin-bottom:10px;text-align:center;'>Аналитика по объекту</div>`;
            headerHtml += `<div style='background:#f4f7ff;border-radius:12px;padding:16px 14px 10px 14px;margin-bottom:18px;box-shadow:0 2px 8px rgba(102,126,234,0.08);'>`;
            headerHtml += `<div style='font-size:16px;margin-bottom:6px;word-break:break-word;'><b>Адрес:</b> <span style='color:#333;'>${address}</span></div>`;
            headerHtml += `<div style='font-size:16px;margin-bottom:6px;'><b>Спален:</b> <span style='color:#333;'>${bedrooms}</span></div>`;
            headerHtml += `<div style='font-size:16px;margin-bottom:0;'><b>Цена объекта:</b> <span style='color:#333;'>€${Number(price).toLocaleString('ru-RU')}</span></div>`;
            headerHtml += `</div>`;

            // Парсим отчет по блокам
            const lines = reportText.split('\n');
            function block(title, contentArr) {
                // Добавляем логику для группировки связанных данных
                let groupedContent = [];
                let currentGroup = [];
                
                for (let i = 0; i < contentArr.length; i++) {
                    const line = contentArr[i];
                    
                    // Если строка содержит "---" или начинается с определенных ключевых слов, это начало новой группы
                    if (line.includes('---') || line.startsWith('Количество спален:') || line.startsWith('Возраст здания:') || line.startsWith('Этаж объекта:') || line.startsWith('Система отопления:')) {
                        if (currentGroup.length > 0) {
                            groupedContent.push(currentGroup);
                            currentGroup = [];
                        }
                        currentGroup.push(line);
                    } else if (line.trim() === '') {
                        // Пустая строка - разделитель
                        if (currentGroup.length > 0) {
                            groupedContent.push(currentGroup);
                            currentGroup = [];
                        }
                    } else {
                        currentGroup.push(line);
                    }
                }
                
                // Добавляем последнюю группу
                if (currentGroup.length > 0) {
                    groupedContent.push(currentGroup);
                }
                
                let contentHtml = '';
                groupedContent.forEach((group, index) => {
                    if (group.length > 0) {
                        // Добавляем группу с отступом
                        contentHtml += `<div style='margin-bottom:${index < groupedContent.length - 1 ? '12px' : '0'};'>`;
                        group.forEach((line, lineIndex) => {
                            // Добавляем дополнительный отступ для заголовков групп
                            const isGroupHeader = line.includes('---') || line.startsWith('Количество спален:') || line.startsWith('Возраст здания:') || line.startsWith('Этаж объекта:') || line.startsWith('Система отопления:');
                            const marginBottom = isGroupHeader ? '8px' : '4px';
                            const fontWeight = isGroupHeader ? '600' : '400';
                            const color = isGroupHeader ? '#667eea' : '#222';
                            
                            contentHtml += `<div style='font-size:15px;color:${color};margin-bottom:${marginBottom};font-weight:${fontWeight};'>${line}</div>`;
                        });
                        contentHtml += '</div>';
                        
                        // Добавляем разделитель между группами (кроме последней)
                        if (index < groupedContent.length - 1) {
                            contentHtml += `<div style='height:1px;background:#e0e0e0;margin:8px 0;'></div>`;
                        }
                    }
                });
                
                return `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>
                    <div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>${title}</div>
                    ${contentHtml}
                </div>`;
            }
            
            // Блоки
            let locationCodes = [], propertyData = [], generalTrend = [], houseTypeTrend = [], ageTrend = [], floorTrend = [], heatingTrend = [], googleData = [], nominatimData = [];
            let current = null;
            for (let line of lines) {
                if (line.includes('=== КОДЫ ЛОКАЦИЙ (только для администраторов) ===')) { current = locationCodes; continue; }
                if (line.includes('Данные объекта:')) { current = propertyData; continue; }
                if (line.includes('=== ДАННЫЕ GOOGLE PLACES API (только для администраторов) ===')) { current = googleData; continue; }
                if (line.includes('=== ДАННЫЕ NOMINATIM (OpenStreetMap) (только для администраторов) ===')) { current = nominatimData; continue; }
                if (line.includes('=== ОБЩИЙ ТРЕНД ===')) { current = generalTrend; continue; }
                if (line.includes('=== ТРЕНД ПО КОЛИЧЕСТВУ СПАЛЕН ===')) { current = houseTypeTrend; continue; }
                if (line.includes('=== ТРЕНД ПО ВОЗРАСТУ ОБЪЕКТА ===')) { current = ageTrend; continue; }
                if (line.includes('=== ТРЕНД ПО ЭТАЖУ ОБЪЕКТА ===')) { current = floorTrend; continue; }
                if (line.includes('=== ТРЕНД ПО ТИПУ ОТОПЛЕНИЯ ===')) { current = heatingTrend; continue; }
                if (current && line.trim() !== '') current.push(line);
            }
            
            // Проверяем статус админа и показываем коды локаций только для админов
            checkAdminStatus().then(isAdmin => {
                console.log('🎯 Результат проверки админа:', isAdmin);
                console.log('📋 Коды локаций:', locationCodes);
                console.log('📏 Количество кодов локаций:', locationCodes.length);
                
                let blocksHtml = '';
                
                if (isAdmin && locationCodes.length) {
                    console.log('✅ Показываем коды локаций для админа');
                    blocksHtml += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>
                        <div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>Коды локаций (только для администраторов)</div>
                        ${locationCodes.map((line, index) => {
                            const isHeader = line.includes('Страна:') || line.includes('Город:') || line.includes('Район:') || line.includes('Округ:');
                            const marginBottom = isHeader ? '8px' : '4px';
                            const fontWeight = isHeader ? '600' : '400';
                            return `<div style='font-size:15px;color:#222;margin-bottom:${marginBottom};font-weight:${fontWeight};'>${line}</div>`;
                        }).join('')}
                    </div>`;
                } else {
                    console.log('❌ Не показываем коды локаций:');
                    console.log('  - isAdmin:', isAdmin);
                    console.log('  - locationCodes.length:', locationCodes.length);
                }
                
                if (isAdmin && googleData.length) {
                    console.log('✅ Показываем данные Google Places API для админа');
                    blocksHtml += block('Данные Google Places API (только для администраторов)', googleData);
                } else {
                    console.log('❌ Не показываем данные Google Places API:', isAdmin, googleData.length);
                }
                if (isAdmin && nominatimData.length) {
                    console.log('✅ Показываем данные Nominatim для админа');
                    blocksHtml += block('Данные Nominatim (OpenStreetMap) (только для администраторов)', nominatimData);
                } else {
                    console.log('❌ Не показываем данные Nominatim:', isAdmin, nominatimData.length);
                }
                if (generalTrend.length) blocksHtml += block('Общий тренд', generalTrend);
                if (houseTypeTrend.length) blocksHtml += block('Тренд по количеству спален', houseTypeTrend);
                if (ageTrend.length) blocksHtml += block('Тренд по возрасту объекта', ageTrend);
                if (floorTrend.length) blocksHtml += block('Тренд по этажу объекта', floorTrend);
                if (heatingTrend.length) blocksHtml += block('Тренд по типу отопления', heatingTrend);

                // CTA-блок: призыв сделать полный отчет
                blocksHtml += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 14px; padding: 18px 14px 16px 14px; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(102,126,234,0.10); color: #fff; text-align: center;">
                        <div style="font-size: 18px; font-weight: 800; margin-bottom: 8px;">Хотите узнать больше?</div>
                        <div style="font-size: 15px; font-weight: 400; margin-bottom: 14px;">Получите <b>экспертный анализ объекта</b> — детальную оценку этажа, возраста, системы отопления, динамику изменения цен за несколько лет, сравнение с аналогичными предложениями на рынке и альтернативными финансовыми инструментами. Профессиональные выводы в удобном PDF-формате!</div>
                        <button class="btn btn-primary" style="width: 100%; font-size: 16px; margin-top: 4px; background: #fff; color: #667eea; border: none; font-weight: 700;" onclick="showFullReportStub()">Получить полный отчет</button>
                    </div>
                `;

                // Кнопки
                const buttonsHtml = `
                    <div class="btn-row" style="margin-bottom:10px; justify-content: center; gap: 16px;">
                        <button class="btn btn-primary" style="width:48%;min-width:140px;" onclick="copyReportToClipboard()">Скопировать данные</button>
                    </div>
                `;
                document.getElementById('reportResult').innerHTML = headerHtml + blocksHtml + buttonsHtml;
            });
        }

        function copyReportToClipboard() {
            // Копируем текст отчета, исключая строку кнопки "Скопировать данные в буфер" и строку кнопки "Получить полный отчет"
            const reportBlock = document.getElementById('reportResult');
            let text = reportBlock.innerText;
            // Удаляем последнюю строку, если это "Скопировать данные в буфер"
            text = text.replace(/\n?Скопировать данные в буфер\s*$/,'');
            // Удаляем строку "Получить полный отчет" (кнопка)
            text = text.replace(/\n?Получить полный отчет\s*$/,'');
            // Добавляем ссылку на бота в конец копируемого текста
            text += "\nПолучить экспертный анализ: https://t.me/Aaadviser_bot";
            navigator.clipboard.writeText(text).then(() => {
                showToast(getLocalizedText('notifications.report_copied'), 'success');
            }).catch(() => {
                showToast(getLocalizedText('notifications.copy_error'), 'error');
            });
        }

        // Модальное окно для пополнения баланса
        function showTopupModal() {
            let oldModal = document.getElementById('topup-modal');
            if (oldModal) animateModalClose(oldModal);
            const modal = document.createElement('div');
            modal.id = 'topup-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <iframe id="topup-iframe" src='/webapp_topup' style='width:100%;height:180px;border:none;'></iframe>
                    <div id="topup-iframe-error" style="display:none;color:#c33;margin-top:10px;">Ошибка загрузки страницы пополнения</div>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeTopupModal()" data-i18n="common.close" data-i18n="common.close">Закрыть</button>
                </div>
            `;
            document.body.appendChild(modal);
            const iframe = document.getElementById('topup-iframe');
            iframe.onerror = function() {
                document.getElementById('topup-iframe-error').style.display = 'block';
            };
        }
        function closeTopupModal() {
            let modal = document.getElementById('topup-modal');
            if (modal) animateModalClose(modal);
        }

        // Основная логика для кнопки 'Получить полный отчет'
        async function showFullReportStub() {
            let telegram_id = getTelegramId();
            if (!telegram_id) {
                showToast('Ошибка: не удалось определить telegram_id пользователя. Откройте WebApp из Telegram.', 'error', 6000);
                return;
            }
            showProgressBar('Проверяем доступ...', 20);
            try {
                const res = await fetch('/api/full_report_access', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id })
                });
                if (!res.ok) throw new Error('Ошибка соединения с сервером');
                const data = await res.json();
                hideProgressBar();
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }
                const today = new Date();
                let periodStart = data.period_start ? new Date(data.period_start) : null;
                let periodEnd = data.period_end ? new Date(data.period_end) : null;
                let isFree = false;
                if (periodStart && periodEnd && today >= periodStart && today <= periodEnd) {
                    isFree = true;
                }
                // Только открываем модалку, ничего не списываем!
                showFullReportConfirmModal(lastReportAddress, lastReportBedrooms, lastReportPrice, telegram_id, isFree, data.full_report_price, data.balance);
            } catch (e) {
                hideProgressBar();
                showToast(e.message || 'Ошибка соединения', 'error');
            }
        }

        // Новая функция: вызывается по клику на 'Да, продолжить' в модалке
        async function onConfirmFullReport(address, bedrooms, price, telegram_id, isFree, fullReportPrice, balance) {
            if (isFree) {
                showToast('Для вас отчет бесплатный! Переходим к сбору дополнительных данных...', 'success');
                // Переходим на страницу сбора дополнительных данных
                goToAdditionalDataPage(address, bedrooms, price, telegram_id);
                return;
            }
            if (parseFloat(balance) >= parseFloat(fullReportPrice)) {
                showProgressBar('Списываем средства...', 30);
                try {
                    const deductRes = await fetch('/api/deduct_balance', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegram_id, amount: fullReportPrice })
                    });
                    if (!deductRes.ok) throw new Error('Ошибка соединения с сервером');
                    const deductData = await deductRes.json();
                    hideProgressBar();
                    if (deductData.success) {
                        showToast('Средства успешно списаны. Переходим к сбору дополнительных данных...', 'success');
                        // Переходим на страницу сбора дополнительных данных
                        goToAdditionalDataPage(address, bedrooms, price, telegram_id);
                    } else if (deductData.error === 'Insufficient balance') {
                        showModalTopup(`Недостаточно средств для получения полного отчета.<br>Стоимость: <b>${fullReportPrice} EUR</b>`, () => {
                            closeModalTopup();
                            showTopupModal();
                        }, () => {
                            closeModalTopup();
                        }, balance);
                    } else {
                        showToast('Ошибка списания средств', 'error');
                    }
                } catch (e) {
                    hideProgressBar();
                    showToast(e.message || 'Ошибка списания', 'error');
                }
            } else {
                // Недостаточно средств
                showModalTopup(`Недостаточно средств для получения полного отчета.<br>Стоимость: <b>${fullReportPrice} EUR</b>`, () => {
                    closeModalTopup();
                    showTopupModal();
                }, () => {
                    closeModalTopup();
                }, balance);
            }
        }

        // Функция перехода на страницу сбора дополнительных данных
        function goToAdditionalDataPage(address, bedrooms, price, telegram_id) {
            // Формируем параметры для передачи на страницу дополнительных данных
            const params = new URLSearchParams({
                address: address,
                bedrooms: bedrooms,
                price: price,
                telegram_id: telegram_id,
                lat: geoData.lat,
                lng: geoData.lng,
                location_codes: JSON.stringify(geoData.location_codes || {})
            });
            
            // Переходим на страницу сбора дополнительных данных
            window.location.href = `/webapp_additional_data?${params.toString()}`;
        }

        // Универсальные модалки
        function animateModalClose(modal) {
            modal.classList.add('fade-out');
            setTimeout(() => { if (modal.parentNode) modal.parentNode.removeChild(modal); }, 350);
        }

        function showModalInfo(message, onOk) {
            let oldModal = document.getElementById('modal-info');
            if (oldModal) animateModalClose(oldModal);
            const modal = document.createElement('div');
            modal.id = 'modal-info';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style='font-size:17px;font-weight:600;margin-bottom:18px;'>${message}</div>
                    <button class="btn btn-primary" id="modal-info-ok" style="width:100%;font-size:17px;">ОК</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modal-info-ok').focus();
            document.getElementById('modal-info-ok').onclick = function() {
                animateModalClose(modal);
                if (onOk) onOk();
            };
        }
        function closeModalInfo() {
            let modal = document.getElementById('modal-info');
            if (modal) animateModalClose(modal);
        }
        function showModalConfirm(message, onResult) {
            let oldModal = document.getElementById('modal-confirm');
            if (oldModal) animateModalClose(oldModal);
            const modal = document.createElement('div');
            modal.id = 'modal-confirm';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style='font-size:17px;font-weight:600;margin-bottom:18px;'>${message}</div>
                    <button class="btn btn-primary" id="modal-confirm-yes" style="width:100%;font-size:17px;">Согласен</button>
                    <button class="btn btn-secondary" id="modal-confirm-no" style="width:100%;margin-top:10px;font-size:16px;">Отказаться</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modal-confirm-yes').focus();
            let yesBtn = document.getElementById('modal-confirm-yes');
            let noBtn = document.getElementById('modal-confirm-no');
            yesBtn.onclick = function() {
                yesBtn.disabled = true; noBtn.disabled = true;
                onResult && onResult(true);
            };
            noBtn.onclick = function() {
                yesBtn.disabled = true; noBtn.disabled = true;
                onResult && onResult(false);
                animateModalClose(modal);
            };
        }
        function closeModalConfirm() {
            let modal = document.getElementById('modal-confirm');
            if (modal) animateModalClose(modal);
            window.onResult = null;
        }
        function showModalTopup(message, onTopup, onCancel, balance) {
            let oldModal = document.getElementById('modal-topup');
            if (oldModal) animateModalClose(oldModal);
            const modal = document.createElement('div');
            modal.id = 'modal-topup';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style='font-size:17px;font-weight:600;margin-bottom:18px;'>${message}<br>Ваш баланс: <b>${balance} EUR</b></div>
                    <button class="btn btn-primary" id="modal-topup-pay" style="width:100%;font-size:17px;" data-i18n="profile.top_up" data-i18n="profile.top_up">Пополнить</button>
                    <button class="btn btn-secondary" id="modal-topup-cancel" style="width:100%;margin-top:10px;font-size:16px;">Отказаться</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modal-topup-pay').focus();
            let payBtn = document.getElementById('modal-topup-pay');
            let cancelBtn = document.getElementById('modal-topup-cancel');
            payBtn.onclick = function() {
                payBtn.disabled = true; cancelBtn.disabled = true;
                onTopup && onTopup();
            };
            cancelBtn.onclick = function() {
                payBtn.disabled = true; cancelBtn.disabled = true;
                onCancel && onCancel();
                animateModalClose(modal);
            };
        }
        function closeModalTopup() {
            let modal = document.getElementById('modal-topup');
            if (modal) animateModalClose(modal);
            window.onTopup = null;
            window.onCancel = null;
        }

        // Обновленная функция: принимает параметры напрямую
        function showFullReportConfirmModal(address, bedrooms, price, telegram_id, isFree = false, fullReportPrice = null, balance = null) {
            let oldModal = document.getElementById('full-report-modal');
            if (oldModal) oldModal.remove();
            // Используем цену из параметра, если не бесплатный
            let priceText = isFree ? '0' : (fullReportPrice !== null ? fullReportPrice : '1');
            const modal = document.createElement('div');
            modal.id = 'full-report-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">Подтвердите параметры полного отчета</div>
                    <div style="font-size:16px;color:#333;margin-bottom:10px;word-break:break-word;"><b>Адрес:</b> ${address}</div>
                    <div style="font-size:16px;color:#333;margin-bottom:10px;"><b>Спален:</b> ${bedrooms}</div>
                    <div style="font-size:16px;color:#333;margin-bottom:18px;"><b>Цена объекта:</b> €${Number(price).toLocaleString('ru-RU')}</div>
                    <div style="font-size:15px;color:#555;margin-bottom:18px;">Стоимость полного отчета: <b>${priceText} EUR</b></div>
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="onConfirmFullReport('${address}', '${bedrooms}', '${price}', '${telegram_id}', ${isFree}, '${fullReportPrice}', '${balance}')">Да, продолжить (${priceText} EUR)</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeFullReportModal();goToSimpleReportForm();">Нет, адрес нужно изменить</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function deductAndGenerateFullReport(telegram_id) {
            showProgressBar(getLocalizedText('progress.generating_report'), 0);
            fetch('/api/user_balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id, deduct: true })
            })
            .then(res => res.json())
            .then(data => {
                hideProgressBar();
                if (data.success) {
                    afterFullReportPayment(lastReportAddress, lastReportBedrooms, lastReportPrice, geoData.lat, geoData.lng, telegram_id);
                } else {
                    showToast(getLocalizedText('notifications.deduction_error'), 'error');
                }
            })
            .catch(() => {
                hideProgressBar();
                showToast(getLocalizedText('notifications.deduction_error'), 'error');
            });
        }

        function closeFullReportModal() {
            let modal = document.getElementById('full-report-modal');
            if (modal) modal.remove();
        }

        function showBalanceModal() {
            // Удаляем старое модальное окно если есть
            let oldModal = document.getElementById('balance-modal');
            if (oldModal) oldModal.remove();
            // Создаем модальное окно
            const modal = document.createElement('div');
            modal.id = 'balance-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">Недостаточно баланса</div>
                    <div style="font-size:16px;color:#333;margin-bottom:22px;">Ваш баланс не достаточен для формирования полного отчета, пожалуйста пополните его.</div>
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="closeBalanceModal();alert('Заглушка: переход к пополнению баланса');" data-i18n="profile.balance" data-i18n="profile.balance">Баланс</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeBalanceModal()" data-i18n="common.close" data-i18n="common.close">Закрыть</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        function closeBalanceModal() {
            let modal = document.getElementById('balance-modal');
            if (modal) modal.remove();
        }

        // После успешного списания $1:
        function afterFullReportPayment(address, bedrooms, price, lat, lng, telegram_id) {
            showProgressBar(getLocalizedText('progress.generating_report'), 0);
            fetch('/api/full_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address, bedrooms, price, lat, lng, telegram_id })
            })
            .then(res => res.json())
            .then(data => {
                hideProgressBar();
                if (data.need_update) {
                    showUpdateReportModal(data.created_at, () => {
                        // Пользователь согласился обновить
                        fetch('/api/user_balance', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ telegram_id, deduct: true })
                        })
                        .then(res => res.json())
                        .then(bal => {
                            if (bal.success) {
                                fetch('/api/full_report', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ address, bedrooms, price, lat, lng, telegram_id, force_update: true })
                                })
                                .then(res => res.json())
                                .then(newData => showFullReport(newData.full_report, newData.report_id));
                            } else {
                                showToast(getLocalizedText('notifications.deduction_error'), 'error');
                            }
                        });
                    }, () => {
                        // Пользователь отказался, показываем старый отчёт
                        fetch('/api/full_report', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ address, bedrooms, price, lat, lng, telegram_id })
                        })
                        .then(res => res.json())
                        .then(oldData => showFullReport(oldData.full_report, oldData.report_id));
                    });
                } else {
                    showFullReport(data.full_report, data.report_id);
                }
            })
            .catch(() => {
                hideProgressBar();
                showToast(getLocalizedText('notifications.connection_error'), 'error');
            });
        }
        // Модалка для обновления отчёта
        function showUpdateReportModal(date, onUpdate, onOld) {
            let oldModal = document.getElementById('update-report-modal');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'update-report-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">Наши данные обновились</div>
                    <div style="font-size:16px;color:#333;margin-bottom:18px;">Ваш отчёт был создан ${new Date(date).toLocaleDateString()}. Для актуальности рекомендуем обновить его за $1. Обновить сейчас?</div>
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="closeUpdateReportModal();(${onUpdate.toString()})()">Обновить за $1</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeUpdateReportModal();(${onOld.toString()})()">Показать старый отчёт</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        function closeUpdateReportModal() {
            let modal = document.getElementById('update-report-modal');
            if (modal) modal.remove();
        }
        // showFullReport(report, report_id) — функция для красивого вывода полного отчёта
        function showFullReport(report, report_id) {
            // Закрываем модальное окно подтверждения
            closeFullReportModal();
            
            // Показываем отчет в основном контейнере
            let html = '';
            
            // Заголовок
            html += `<div style='font-size:22px;font-weight:800;color:#667eea;margin-bottom:20px;text-align:center;'>Полный отчет по объекту</div>`;
            
            // Блок: Информация об объекте
            html += `<div style='background:#f4f7ff;border-radius:12px;padding:16px 14px 10px 14px;margin-bottom:18px;box-shadow:0 2px 8px rgba(102,126,234,0.08);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>Информация об объекте</div>`;
            html += `<table style='width:100%;font-size:15px;'><tr><td style='padding:4px 0;'><b>Адрес:</b></td><td style='padding:4px 0;'>${report.object.address}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'><b>Спален:</b></td><td style='padding:4px 0;'>${report.object.bedrooms}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'><b>Цена объекта:</b></td><td style='padding:4px 0;'>€${Number(report.object.purchase_price).toLocaleString('ru-RU')}</td></tr></table>`;
            html += `</div>`;
            
            // Блок: ROI
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>Инвестиционный анализ (ROI)</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>Тип инвестиции</th><th style='text-align:right;padding:4px 0;'>ROI</th><th style='text-align:right;padding:4px 0;'>Доход</th><th style='text-align:right;padding:4px 0;'>Итоговая стоимость</th></tr>`;
            html += `<tr><td style='padding:4px 0;'>Краткосрочная аренда</td><td style='text-align:right;padding:4px 0;'>${report.roi.short_term.roi}%</td><td style='text-align:right;padding:4px 0;'>€${report.roi.short_term.five_year_income.toLocaleString('ru-RU')}</td><td style='text-align:right;padding:4px 0;'>€${report.roi.short_term.final_value.toLocaleString('ru-RU')}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Долгосрочная аренда</td><td style='text-align:right;padding:4px 0;'>${report.roi.long_term.roi}%</td><td style='text-align:right;padding:4px 0;'>€${report.roi.long_term.five_year_income.toLocaleString('ru-RU')}</td><td style='text-align:right;padding:4px 0;'>€${report.roi.long_term.final_value.toLocaleString('ru-RU')}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Без аренды</td><td style='text-align:right;padding:4px 0;'>${report.roi.no_rent.roi}%</td><td style='text-align:right;padding:4px 0;'>-</td><td style='text-align:right;padding:4px 0;'>€${report.roi.no_rent.final_value.toLocaleString('ru-RU')}</td></tr></table>`;
            html += `</div>`;
            
            // Блок: Альтернативы
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>Сравнение с альтернативами (5 лет)</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>Инструмент</th><th style='text-align:right;padding:4px 0;'>Доходность</th></tr>`;
            report.alternatives.forEach(alt => {
                html += `<tr><td style='padding:4px 0;'>${alt.name}</td><td style='text-align:right;padding:4px 0;'>${(alt.yield*100).toFixed(1)}%</td></tr>`;
            });
            html += `</table></div>`;
            
            // Блок: Макроэкономика
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>Макроэкономические показатели</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>Показатель</th><th style='text-align:right;padding:4px 0;'>Значение</th></tr>`;
            html += `<tr><td style='padding:4px 0;'>Инфляция</td><td style='text-align:right;padding:4px 0;'>${report.macro.inflation}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Курс EUR/TRY</td><td style='text-align:right;padding:4px 0;'>${report.macro.eur_try}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Ключевая ставка</td><td style='text-align:right;padding:4px 0;'>${report.macro.refi_rate}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Рост ВВП</td><td style='text-align:right;padding:4px 0;'>${report.macro.gdp_growth}%</td></tr></table>`;
            html += `</div>`;
            
            // Блок: Налоги и сборы
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>Налоги и сборы</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>Тип налога</th><th style='text-align:right;padding:4px 0;'>Ставка</th></tr>`;
            html += `<tr><td style='padding:4px 0;'>Налог на перевод</td><td style='text-align:right;padding:4px 0;'>${report.taxes.transfer_tax*100}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Гербовый сбор</td><td style='text-align:right;padding:4px 0;'>${report.taxes.stamp_duty*100}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Нотариус</td><td style='text-align:right;padding:4px 0;'>€${report.taxes.notary}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Налог на имущество</td><td style='text-align:right;padding:4px 0;'>${report.taxes.annual_property_tax*100}% - ${report.taxes.annual_property_tax_max*100}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Подоходный налог с аренды</td><td style='text-align:right;padding:4px 0;'>${report.taxes.rental_income_tax}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Налог на прирост капитала</td><td style='text-align:right;padding:4px 0;'>${report.taxes.capital_gains_tax}</td></tr></table>`;
            html += `</div>`;
            
            // Блок: Профессиональные метрики
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>Профессиональные метрики</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>Метрика</th><th style='text-align:right;padding:4px 0;'>Значение</th></tr>`;
            html += `<tr><td style='padding:4px 0;'>Yield</td><td style='text-align:right;padding:4px 0;'>${(report.yield*100).toFixed(1)}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Индекс цен</td><td style='text-align:right;padding:4px 0;'>${report.price_index}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Ипотечная ставка</td><td style='text-align:right;padding:4px 0;'>${(report.mortgage_rate*100).toFixed(1)}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Глобальный индекс цен</td><td style='text-align:right;padding:4px 0;'>${report.global_house_price_index}</td></tr></table>`;
            html += `</div>`;
            
            // Блок: Риски и развитие района
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>Риски и развитие района</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>Категория</th><th style='text-align:left;padding:4px 0;' data-i18n="balance.description">Описание</th></tr>`;
            report.risks.forEach((risk, index) => {
                html += `<tr><td style='padding:4px 0;'>Риск ${index + 1}</td><td style='padding:4px 0;'>${risk}</td></tr>`;
            });
            html += `<tr><td style='padding:4px 0;' data-i18n="reports.liquidity">Ликвидность</td><td style='padding:4px 0;'>${report.liquidity}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>Развитие района</td><td style='padding:4px 0;'>${report.district}</td></tr></table>`;
            html += `</div>`;
            
            // Итог/summary
            html += `<div style='background:#f4f7ff;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);font-size:15px;color:#222;'>${report.summary}</div>`;
            
            // Кнопки действий
            html += `<div style="margin-bottom:10px;">
                <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="downloadPDF()">Скачать PDF</button>
            </div>`;
            
            document.getElementById('reportResult').innerHTML = html;
            
            // Сохраняем данные отчета для отправки клиенту
            currentReportData = {
                address: report.object.address,
                bedrooms: report.object.bedrooms,
                price: report.object.purchase_price,
                report: report,
                id: report_id // Сохраняем ID отчета если он есть
            };
            
            showToast(getLocalizedText('notifications.report_generated'), 'success');
        }
        

        
        function showClientModal() {
            // Удаляем старое модальное окно если есть
            let oldModal = document.getElementById('client-modal');
            if (oldModal) oldModal.remove();
            
            // Создаем модальное окно
            const modal = document.createElement('div');
            modal.id = 'client-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">Отправить отчет клиенту</div>
                    <div style="font-size:16px;color:#333;margin-bottom:22px;">Введите данные клиента для отправки отчета</div>
                    <input type="text" id="client-name" placeholder="Имя клиента" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px;font-size:16px;">
                    <input type="text" id="client-username" placeholder="Telegram username (без @)" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:20px;font-size:16px;">
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="sendReportToClient()">Отправить</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeClientModal()" data-i18n="common.cancel" data-i18n="common.cancel">Отмена</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeClientModal() {
            let modal = document.getElementById('client-modal');
            if (modal) modal.remove();
        }
        
        function sendReportToClient() {
            const clientName = document.getElementById('client-name').value.trim();
            const clientUsername = document.getElementById('client-username').value.trim();
            
            if (!clientName || !clientUsername) {
                showToast('Пожалуйста, заполните все поля', 'error');
                return;
            }
            
            if (!currentReportData || !currentReportData.report) {
                showToast('Данные отчета не найдены', 'error');
                return;
            }
            
            if (!window._lastPdfPath) {
                showToast('PDF ещё не сгенерирован. Сначала скачайте PDF!', 'error');
                return;
            }
            
            showProgressBar('Отправляем отчет клиенту...', 0);
            
            // Сначала сохраняем отчет, затем отправляем клиенту
            saveReportIfNeededAndGeneratePdf(currentReportData.report, function(reportId) {
                // Генерируем PDF с report_id
                fetch('/api/generate_pdf_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        report: currentReportData.report,
                        add_realtor_contacts: false,
                        add_client_name: false,
                        report_id: reportId
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window._lastPdfPath = data.pdf_path;
                        // Отправляем PDF клиенту
                        fetch('/api/send_pdf_to_client', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                realtor_telegram_id: userData.id,
                                client_name: clientName,
                                client_telegram: clientUsername,
                                pdf_path: window._lastPdfPath
                            })
                        })
                        .then(res => res.json())
                        .then(sendData => {
                            hideProgressBar();
                            closeClientModal();
                            if (sendData.success) {
                                showToast('Отчет успешно отправлен клиенту!', 'success');
                            } else {
                                showToast('Ошибка отправки отчета клиенту', 'error');
                            }
                        })
                        .catch(() => {
                            hideProgressBar();
                            showToast('Ошибка отправки отчета клиенту', 'error');
                        });
                    } else {
                        hideProgressBar();
                        showToast('Ошибка генерации PDF: ' + (data.error || ''), 'error');
                    }
                })
                .catch(() => {
                    hideProgressBar();
                    showToast('Ошибка соединения', 'error');
                });
            });
        }
        
        // Сохраняет отчет если нет id, затем вызывает cb(reportId) — для генерации PDF
        async function saveReportIfNeededAndGeneratePdf(report, cb) {
            // Проверяем наличие ID в currentReportData
            if (currentReportData && currentReportData.id) {
                cb(currentReportData.id);
                return;
            }
            // Проверяем наличие ID в самом отчете
            if (report.id) {
                cb(report.id);
                return;
            }
            // Сохраняем отчет в базу
            const res = await fetch('/api/user_reports/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    telegram_id: userData.id, 
                    full_report: report, 
                    address: report.object.address, 
                    report_type: 'full_report' 
                })
            });
            const data = await res.json();
            if (data.success && data.report_id) {
                // Обновляем ID в currentReportData
                if (currentReportData) {
                    currentReportData.id = data.report_id;
                }
                cb(data.report_id);
            } else {
                showToast('Ошибка сохранения отчета (не получен id)', 'error');
            }
        }

        function downloadPDF() {
            if (!currentReportData || !currentReportData.report) {
                showToast('Данные отчета не найдены', 'error');
                return;
            }
            showProgressBar('Генерируем PDF...', 0);
            fetch('/api/generate_pdf_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    report: currentReportData.report,
                    add_realtor_contacts: false,
                    add_client_name: false,
                    report_id: currentReportData.id,
                    telegram_id: getTelegramId()
                })
            })
            .then(res => res.json())
            .then(data => {
                hideProgressBar();
                if (data.success) {
                    if (data.telegram_send_status === 'sent') {
                        closePdfModal && closePdfModal();
                        showToast('PDF-отчёт отправлен вам в Telegram!', 'success', 6000);
                        setTimeout(() => { goToMainMenu(); }, 2000);
                    } else if (data.telegram_send_status && data.telegram_send_status.startsWith('error')) {
                        showToast('Ошибка отправки PDF через Telegram: ' + data.telegram_send_status, 'error', 8000);
                    } else {
                        showToast('PDF сгенерирован, но не удалось отправить через Telegram.', 'error', 8000);
                    }
                } else {
                    showToast('Ошибка генерации PDF: ' + (data.error || ''), 'error');
                }
            })
            .catch(() => {
                hideProgressBar();
                showToast('Ошибка соединения', 'error');
            });
        }

        function showPdfDownloadModal(pdfUrl) {
            let oldModal = document.getElementById('pdf-modal');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'pdf-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">PDF сформирован</div>
                    <div style="font-size:16px;color:#333;margin-bottom:18px;">Скопируйте ссылку ниже и откройте её в браузере.<br>Если файл не открывается, используйте Telegram Desktop или откройте WebApp в браузере.</div>
                    <div style='word-break:break-all;background:#f4f7ff;padding:10px 8px;border-radius:8px;margin-bottom:16px;font-size:14px;color:#222;'>${location.origin}${pdfUrl}</div>
                    <button class="btn btn-secondary" style="width:100%;font-size:16px;" onclick="closePdfModal();goToMainMenu();">В главное меню</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        function closePdfModal() {
            let modal = document.getElementById('pdf-modal');
            if (modal) modal.remove();
        }
        
        function showPDFSavedModal() {
            const modal = document.createElement('div');
            modal.id = 'pdf-saved-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">PDF сохранен</div>
                    <div style="font-size:16px;color:#333;margin-bottom:22px;">Отчет успешно сохранен в базу данных и скачан на ваше устройство.</div>
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="closePDFSavedModal()">Понятно</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closePDFSavedModal() {
            let modal = document.getElementById('pdf-saved-modal');
            if (modal) modal.remove();
        }
        
        function goToMainMenu() {
            window.location.href = '/webapp';
        }

        let telegram_id = null;
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.id) {
            telegram_id = window.Telegram.WebApp.initDataUnsafe.user.id;
            localStorage.setItem('telegram_id', telegram_id);
        } else {
            telegram_id = localStorage.getItem('telegram_id');
        }

        function getTelegramId() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.id) {
                const telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
                localStorage.setItem('telegram_id', telegramId);
                return telegramId;
            }
            return localStorage.getItem('telegram_id');
        }

        // Функция для проверки статуса администратора
        async function checkAdminStatus() {
            const telegram_id = getTelegramId();
            console.log('🔍 Проверка статуса админа для telegram_id:', telegram_id);
            
            if (!telegram_id) {
                console.log('❌ telegram_id не найден');
                return false;
            }
            
            try {
                const response = await fetch('/api/check_admin_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id })
                });
                
                console.log('📡 Ответ сервера:', response.status, response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 Данные ответа:', data);
                    const isAdmin = data.is_admin || false;
                    console.log('👑 Статус админа:', isAdmin);
                    return isAdmin;
                } else {
                    const errorData = await response.json();
                    console.log('❌ Ошибка сервера:', errorData);
                }
            } catch (error) {
                console.error('❌ Ошибка проверки статуса админа:', error);
            }
            
            return false;
        }



        // Инициализация
        showStep('address');
        
        // Автоматический фокус на поле ввода адреса
        setTimeout(() => {
            const addressInput = document.getElementById('addressInput');
            if (addressInput) {
                addressInput.focus();
                // Убеждаемся, что поле доступно для ввода
                addressInput.disabled = false;
                addressInput.readOnly = false;
                
                // Добавляем обработчики событий для отладки
                addressInput.addEventListener('click', function(e) {
                    console.log('Address input clicked');
                    e.stopPropagation();
                });
                
                addressInput.addEventListener('focus', function() {
                    console.log('Address input focused');
                });
                
                addressInput.addEventListener('input', function() {
                    console.log('Address input value:', this.value);
                });
            }
        }, 100);
    </script>
</body>
</html> 