<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/static/i18n-manager.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - –ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }
        .logo {
            width: 110px;
            height: auto;
            display: block;
            margin: 0 auto 8px auto;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .logo:hover {
            transform: scale(1.05);
        }
        .slogan {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-bottom: 40px;
        }
        .step-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(102,126,234,0.08);
            padding: 32px 24px 28px 24px;
            width: 100%;
            max-width: 360px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
            position: relative;
            z-index: 1;
        }
        .step-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 18px;
            text-align: center;
        }
        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 18px;
            background: #f8f9fa;
            transition: border 0.2s;
            pointer-events: auto;
            position: relative;
            z-index: 10;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        .input-field:focus {
            border: 1.5px solid #667eea;
            outline: none;
        }
        .btn-row {
            display: flex;
            gap: 12px;
            width: 100%;
            margin-top: 10px;
        }
        .btn {
            flex: 1;
            padding: 14px 0;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        .btn-secondary {
            background: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
        }
        .btn-secondary:hover {
            background: #e2e2e2;
        }
        .map-block {
            width: 100%;
            height: 220px;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 18px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
        }
        .report-block {
            background: #f8f9fa;
            border-radius: 14px;
            padding: 22px 16px;
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.06);
        }
        .report-title {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 12px;
            text-align: center;
        }
        .report-row {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            margin-bottom: 8px;
        }
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 16px;
            margin-top: 30px;
        }
        .error {
            color: #c33;
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 18px;
            text-align: center;
        }

        /* Progress Bar Styles */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            pointer-events: auto;
        }

        .progress-card {
            background: white;
            border-radius: 18px;
            padding: 32px 24px;
            text-align: center;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .progress-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .progress-text {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            max-width: 300px;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #667eea;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: #28a745;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast.info {
            border-left-color: #17a2b8;
        }

        /* Client Modal Styles */
        .client-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.25);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .client-modal-content {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(102, 126, 234, 0.18);
            padding: 32px 24px 24px 24px;
            max-width: 340px;
            width: 90vw;
            text-align: center;
        }

        .client-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 18px;
            background: #f8f9fa;
            transition: border 0.2s;
        }

        .client-input:focus {
            border: 1.5px solid #667eea;
            outline: none;
        }

        /* Toast —Å –∞–≤—Ç–æ–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ–º –∏ –∞–Ω–∏–º–∞—Ü–∏–µ–π */
        .toast.fade-out { opacity: 0; transition: opacity 0.4s; }
        #modal-info.fade-out, #modal-confirm.fade-out, #modal-topup.fade-out, #topup-modal.fade-out { opacity: 0; transition: opacity 0.35s; }
    </style>
</head>
<body>
    <div class="container">
        <img src="logo-flt.png" alt="Aaadviser" class="logo" onclick="goToMainMenu()">
        <div class="slogan">–ò–Ω—Å–∞–π—Ç—ã —Ä—ã–Ω–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</div>

        <!-- –®–∞–≥ 1: –í–≤–æ–¥ –∞–¥—Ä–µ—Å–∞ -->
        <div id="step-address" class="step-card">
            <div class="step-title">–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</div>
            <input type="text" id="addressInput" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É–ª. –õ–µ–Ω–∏–Ω–∞, 10, –ú–æ—Å–∫–≤–∞">
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="goToMainMenu()">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
                <button class="btn btn-primary" onclick="verifyAddress()" data-i18n="common.next" data-i18n="common.next">–î–∞–ª–µ–µ</button>
            </div>
            <div id="address-error" class="error" style="display:none;"></div>
        </div>

        <!-- –®–∞–≥ 2: –ö–∞—Ä—Ç–∞ –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
        <div id="step-map" class="step-card" style="display:none;">
            <div class="step-title">–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–∫–∞—Ü–∏—è?</div>
            <div class="map-block" id="map"></div>
            <div style="font-size:15px;color:#555;margin-bottom:10px;" id="confirmedAddress"></div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="backToAddress()" data-i18n="common.no" data-i18n="common.no">–ù–µ—Ç</button>
                <button class="btn btn-primary" onclick="confirmLocation()" data-i18n="common.yes" data-i18n="common.yes">–î–∞</button>
            </div>
        </div>

        <!-- –®–∞–≥ 3: –í—ã–±–æ—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–ø–∞–ª–µ–Ω -->
        <div id="step-bedrooms" class="step-card" style="display:none;">
            <div class="step-title">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∞–ª–µ–Ω</div>
            <select id="bedroomsSelect" class="input-field">
                <option value="0">0 - —Å—Ç—É–¥–∏—è</option>
                <option value="1">1 —Å–ø–∞–ª—å–Ω—è</option>
                <option value="2">2 —Å–ø–∞–ª—å–Ω–∏</option>
                <option value="3" selected>3 —Å–ø–∞–ª—å–Ω–∏</option>
                <option value="4">4 —Å–ø–∞–ª—å–Ω–∏</option>
                <option value="5">5+ —Å–ø–∞–ª–µ–Ω</option>
            </select>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="backToMap()" data-i18n="common.back" data-i18n="common.back">–ù–∞–∑–∞–¥</button>
                <button class="btn btn-primary" onclick="confirmBedrooms()" data-i18n="common.next" data-i18n="common.next">–î–∞–ª–µ–µ</button>
            </div>
        </div>

        <!-- –®–∞–≥ 4: –í–≤–æ–¥ —Ü–µ–Ω—ã -->
        <div id="step-price" class="step-card" style="display:none;">
            <div class="step-title">–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</div>
            <input type="number" id="priceInput" class="input-field" placeholder="–¶–µ–Ω–∞ –≤ –µ–≤—Ä–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 500000)" min="10000" step="1000">
            <div style="font-size:14px;color:#666;margin-bottom:15px;">–í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–∞ –≤ –µ–≤—Ä–æ</div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="backToBedrooms()" data-i18n="common.back" data-i18n="common.back">–ù–∞–∑–∞–¥</button>
                <button class="btn btn-primary" onclick="confirmPrice()">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
            </div>
            <div id="price-error" class="error" style="display:none;"></div>
        </div>

        <!-- –®–∞–≥ 5: –û—Ç—á–µ—Ç -->
        <div id="step-report" class="step-card" style="display:none;">
            <div id="reportResult" class="report-block"></div>
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="goToMainMenu()">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            </div>
        </div>

        <div id="loading" class="loading" style="display:none;" data-i18n="common.loading" data-i18n="common.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- Progress Bar Container -->
    <div id="progress-container" class="progress-container" style="display: none;">
        <div class="progress-card">
            <div class="progress-spinner"></div>
            <div class="progress-text" id="progress-text">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrDkDpNKNAIyY147MQ78hchBkeyCAxhEw"></script>
    <script>
        let geoData = null;
        let lastAddress = '';
        // –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞
        let lastReportAddress = '';
        let lastReportBedrooms = '';
        let lastReportPrice = '';
        let currentReportData = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç—á–µ—Ç–∞

        // Progress Bar Functions
        function showProgressBar(text, progress = 0) {
            document.getElementById('progress-text').textContent = text;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-container').style.display = 'flex';
        }

        function updateProgressBar(progress) {
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        function hideProgressBar() {
            document.getElementById('progress-container').style.display = 'none';
        }

        // Toast Notification Functions
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('fade-out');
                setTimeout(() => container.removeChild(toast), 400);
            }, duration);
        }

        // Localization helper
        function getLocalizedText(key) {
            const currentLang = 'ru'; // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º
            const texts = {
                'ru': {
                    'progress': {
                        'checking_balance': '–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å...',
                        'generating_report': '–§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç...',
                        'sending_to_client': '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –∫–ª–∏–µ–Ω—Ç—É...',
                        'processing_request': '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å...'
                    },
                    'notifications': {
                        'report_copied': '–î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!',
                        'copy_error': '–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä',
                        'balance_check_error': '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞',
                        'deduction_error': '–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞',
                        'connection_error': '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞',
                        'report_generated': '–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω!',
                        'report_sent_success': '–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É!',
                        'report_sent_error': '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞',
                        'connection_send_error': '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ',
                        'fill_all_fields': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è',
                        'report_data_error': '–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
                    },
                    'client_modal': {
                        'title': '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –∫–ª–∏–µ–Ω—Ç—É',
                        'client_name_placeholder': '–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞',
                        'client_username_placeholder': 'Telegram username (–±–µ–∑ @)',
                        'cancel': '–û—Ç–º–µ–Ω–∞',
                        'send': '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'
                    }
                }
            };
            
            const lang = texts[currentLang] || texts['ru'];
            const parts = key.split('.');
            let result = lang;
            for (const part of parts) {
                result = result[part];
                if (!result) return key;
            }
            return result;
        }

        function showStep(step) {
            document.getElementById('step-address').style.display = 'none';
            document.getElementById('step-map').style.display = 'none';
            document.getElementById('step-bedrooms').style.display = 'none';
            document.getElementById('step-price').style.display = 'none';
            document.getElementById('step-report').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            if (step === 'address') document.getElementById('step-address').style.display = 'flex';
            if (step === 'map') document.getElementById('step-map').style.display = 'flex';
            if (step === 'bedrooms') document.getElementById('step-bedrooms').style.display = 'flex';
            if (step === 'price') {
                document.getElementById('step-price').style.display = 'flex';
                var priceInput = document.getElementById('priceInput');
                if (priceInput) { priceInput.disabled = false; priceInput.readOnly = false; }
            }
            if (step === 'report') document.getElementById('step-report').style.display = 'flex';
            if (step === 'loading') document.getElementById('loading').style.display = 'block';
        }

        function goToMainMenu() {
            window.location.href = '/webapp';
        }

        function backToAddress() {
            showStep('address');
            document.getElementById('addressInput').value = lastAddress;
        }

        function backToMap() {
            showStep('map');
        }

        function backToBedrooms() {
            showStep('bedrooms');
        }

        async function verifyAddress() {
            const address = document.getElementById('addressInput').value.trim();
            document.getElementById('address-error').style.display = 'none';
            if (!address) {
                showError('address-error', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å.');
                return;
            }
            showStep('loading');
            try {
                const res = await fetch('/api/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                const data = await res.json();
                if (data.success) {
                    geoData = data;
                    lastAddress = data.formatted_address;
                    showMap(data.lat, data.lng);
                    document.getElementById('confirmedAddress').innerText = data.formatted_address;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥—ã –ª–æ–∫–∞—Ü–∏–π –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
                    if (data.location_codes) {
                        geoData.location_codes = data.location_codes;
                        console.log('–ù–∞–π–¥–µ–Ω—ã –∫–æ–¥—ã –ª–æ–∫–∞—Ü–∏–π:', data.location_codes);
                    } else {
                        console.log('–ö–æ–¥—ã –ª–æ–∫–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    }
                    
                    showStep('map');
                } else {
                    showStep('address');
                    showError('address-error', '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                }
            } catch (e) {
                showStep('address');
                showError('address-error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }

        function showError(id, msg) {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.style.display = 'block';
        }

        function showMap(lat, lng) {
            const mapDiv = document.getElementById('map');
            mapDiv.innerHTML = '';
            const map = new google.maps.Map(mapDiv, {
                center: { lat, lng },
                zoom: 16,
                disableDefaultUI: true
            });
            new google.maps.Marker({ position: { lat, lng }, map });
        }

        function confirmLocation() {
            showStep('bedrooms');
        }

        function confirmBedrooms() {
            showStep('price');
        }

        async function confirmPrice() {
            const priceInput = document.getElementById('priceInput');
            const price = priceInput.value.trim();
            const bedrooms = document.getElementById('bedroomsSelect').value;
            document.getElementById('price-error').style.display = 'none';

            if (!price || price < 10000) {
                showError('price-error', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (–º–∏–Ω–∏–º—É–º 10,000 –µ–≤—Ä–æ).');
                priceInput.disabled = false;
                priceInput.readOnly = false;
                priceInput.focus();
                return;
            }

            showStep('loading');
            try {
                const res = await fetch('/api/generate_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: geoData.formatted_address,
                        lat: geoData.lat,
                        lng: geoData.lng,
                        bedrooms: parseInt(bedrooms),
                        price: parseFloat(price),
                        language: 'ru',
                        location_codes: geoData.location_codes || null,
                        location_components: geoData.location_components || null
                    })
                });
                const data = await res.json();
                if (data.success) {
                    window.lastApiReport = data.report; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    renderReport(data.report_text, geoData.formatted_address, bedrooms, price);
                    showStep('report');
                } else {
                    showStep('price');
                    showError('price-error', '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞.');
                }
            } catch (e) {
                showStep('price');
                showError('price-error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.');
            }
        }

        // Helper for declension and localization
        function getObjectLabel(count) {
            // Determine language
            let lang = (typeof currentLanguage !== 'undefined') ? currentLanguage : 'ru';
            let words = ['–æ–±—ä–µ–∫—Ç', '–æ–±—ä–µ–∫—Ç–∞', '–æ–±—ä–µ–∫—Ç–æ–≤'];
            if (lang === 'en') words = ['object', 'objects'];
            if (lang === 'de') words = ['Objekt', 'Objekte'];
            if (lang === 'fr') words = ['objet', 'objets'];
            if (lang === 'tr') words = ['nesne', 'nesne'];
            // Russian declension
            if (lang === 'ru') {
                if (typeof count !== 'number') return '';
                let word = words[2];
                if (count % 10 === 1 && count % 100 !== 11) word = words[0];
                else if ([2,3,4].includes(count % 10) && ![12,13,14].includes(count % 100)) word = words[1];
                return `${count} ${word}`;
            } else {
                // For other languages: singular/plural
                let word = (count === 1) ? words[0] : words[1];
                return `${count} ${word}`;
            }
        }

        function renderReport(reportText, address, bedrooms, price) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥–∞–ª–∫–µ
            lastReportAddress = address;
            lastReportBedrooms = bedrooms;
            lastReportPrice = price;
            currentReportData = { address, bedrooms, price }; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞
            
            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫—Ä—É–ø–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
            let headerHtml = '';
            headerHtml += `<div style='font-size:22px;font-weight:800;color:#667eea;margin-bottom:10px;text-align:center;'>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ–±—ä–µ–∫—Ç—É</div>`;
            headerHtml += `<div style='background:#f4f7ff;border-radius:12px;padding:16px 14px 10px 14px;margin-bottom:18px;box-shadow:0 2px 8px rgba(102,126,234,0.08);'>`;
            headerHtml += `<div style='font-size:16px;margin-bottom:6px;word-break:break-word;'><b>–ê–¥—Ä–µ—Å:</b> <span style='color:#333;'>${address}</span></div>`;
            headerHtml += `<div style='font-size:16px;margin-bottom:6px;'><b>–°–ø–∞–ª–µ–Ω:</b> <span style='color:#333;'>${bedrooms}</span></div>`;
            headerHtml += `<div style='font-size:16px;margin-bottom:0;'><b>–¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞:</b> <span style='color:#333;'>‚Ç¨${Number(price).toLocaleString('ru-RU')}</span></div>`;
            headerHtml += `</div>`;

            // –ü–∞—Ä—Å–∏–º –æ—Ç—á–µ—Ç –ø–æ –±–ª–æ–∫–∞–º
            const lines = reportText.split('\n');
            function block(title, contentArr) {
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                let groupedContent = [];
                let currentGroup = [];
                
                for (let i = 0; i < contentArr.length; i++) {
                    const line = contentArr[i];
                    
                    // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç "---" –∏–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, —ç—Ç–æ –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã
                    if (line.includes('---') || line.startsWith('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∞–ª–µ–Ω:') || line.startsWith('–í–æ–∑—Ä–∞—Å—Ç –∑–¥–∞–Ω–∏—è:') || line.startsWith('–≠—Ç–∞–∂ –æ–±—ä–µ–∫—Ç–∞:') || line.startsWith('–°–∏—Å—Ç–µ–º–∞ –æ—Ç–æ–ø–ª–µ–Ω–∏—è:')) {
                        if (currentGroup.length > 0) {
                            groupedContent.push(currentGroup);
                            currentGroup = [];
                        }
                        currentGroup.push(line);
                    } else if (line.trim() === '') {
                        // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ - —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                        if (currentGroup.length > 0) {
                            groupedContent.push(currentGroup);
                            currentGroup = [];
                        }
                    } else {
                        currentGroup.push(line);
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≥—Ä—É–ø–ø—É
                if (currentGroup.length > 0) {
                    groupedContent.push(currentGroup);
                }
                
                let contentHtml = '';
                groupedContent.forEach((group, index) => {
                    if (group.length > 0) {
                        // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É —Å –æ—Ç—Å—Ç—É–ø–æ–º
                        contentHtml += `<div style='margin-bottom:${index < groupedContent.length - 1 ? '12px' : '0'};'>`;
                        group.forEach((line, lineIndex) => {
                            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≥—Ä—É–ø–ø
                            const isGroupHeader = line.includes('---') || line.startsWith('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∞–ª–µ–Ω:') || line.startsWith('–í–æ–∑—Ä–∞—Å—Ç –∑–¥–∞–Ω–∏—è:') || line.startsWith('–≠—Ç–∞–∂ –æ–±—ä–µ–∫—Ç–∞:') || line.startsWith('–°–∏—Å—Ç–µ–º–∞ –æ—Ç–æ–ø–ª–µ–Ω–∏—è:');
                            const marginBottom = isGroupHeader ? '8px' : '4px';
                            const fontWeight = isGroupHeader ? '600' : '400';
                            const color = isGroupHeader ? '#667eea' : '#222';
                            
                            contentHtml += `<div style='font-size:15px;color:${color};margin-bottom:${marginBottom};font-weight:${fontWeight};'>${line}</div>`;
                        });
                        contentHtml += '</div>';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏ (–∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π)
                        if (index < groupedContent.length - 1) {
                            contentHtml += `<div style='height:1px;background:#e0e0e0;margin:8px 0;'></div>`;
                        }
                    }
                });
                
                return `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>
                    <div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>${title}</div>
                    ${contentHtml}
                </div>`;
            }
            
            // –ë–ª–æ–∫–∏
            let locationCodes = [], propertyData = [], generalTrend = [], houseTypeTrend = [], ageTrend = [], floorTrend = [], heatingTrend = [], googleData = [], nominatimData = [];
            let current = null;
            for (let line of lines) {
                if (line.includes('=== –ö–û–î–´ –õ–û–ö–ê–¶–ò–ô (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤) ===')) { current = locationCodes; continue; }
                if (line.includes('–î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞:')) { current = propertyData; continue; }
                if (line.includes('=== –î–ê–ù–ù–´–ï GOOGLE PLACES API (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤) ===')) { current = googleData; continue; }
                if (line.includes('=== –î–ê–ù–ù–´–ï NOMINATIM (OpenStreetMap) (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤) ===')) { current = nominatimData; continue; }
                if (line.includes('=== –û–ë–©–ò–ô –¢–†–ï–ù–î ===')) { current = generalTrend; continue; }
                if (line.includes('=== –¢–†–ï–ù–î –ü–û –ö–û–õ–ò–ß–ï–°–¢–í–£ –°–ü–ê–õ–ï–ù ===')) { current = houseTypeTrend; continue; }
                if (line.includes('=== –¢–†–ï–ù–î –ü–û –í–û–ó–†–ê–°–¢–£ –û–ë–™–ï–ö–¢–ê ===')) { current = ageTrend; continue; }
                if (line.includes('=== –¢–†–ï–ù–î –ü–û –≠–¢–ê–ñ–£ –û–ë–™–ï–ö–¢–ê ===')) { current = floorTrend; continue; }
                if (line.includes('=== –¢–†–ï–ù–î –ü–û –¢–ò–ü–£ –û–¢–û–ü–õ–ï–ù–ò–Ø ===')) { current = heatingTrend; continue; }
                if (current && line.trim() !== '') current.push(line);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥—ã –ª–æ–∫–∞—Ü–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
            checkAdminStatus().then(isAdmin => {
                console.log('üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞:', isAdmin);
                console.log('üìã –ö–æ–¥—ã –ª–æ–∫–∞—Ü–∏–π:', locationCodes);
                console.log('üìè –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤ –ª–æ–∫–∞—Ü–∏–π:', locationCodes.length);
                
                let blocksHtml = '';
                
                if (isAdmin && locationCodes.length) {
                    console.log('‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥—ã –ª–æ–∫–∞—Ü–∏–π –¥–ª—è –∞–¥–º–∏–Ω–∞');
                    blocksHtml += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>
                        <div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>–ö–æ–¥—ã –ª–æ–∫–∞—Ü–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)</div>
                        ${locationCodes.map((line, index) => {
                            const isHeader = line.includes('–°—Ç—Ä–∞–Ω–∞:') || line.includes('–ì–æ—Ä–æ–¥:') || line.includes('–†–∞–π–æ–Ω:') || line.includes('–û–∫—Ä—É–≥:');
                            const marginBottom = isHeader ? '8px' : '4px';
                            const fontWeight = isHeader ? '600' : '400';
                            return `<div style='font-size:15px;color:#222;margin-bottom:${marginBottom};font-weight:${fontWeight};'>${line}</div>`;
                        }).join('')}
                    </div>`;
                } else {
                    console.log('‚ùå –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥—ã –ª–æ–∫–∞—Ü–∏–π:');
                    console.log('  - isAdmin:', isAdmin);
                    console.log('  - locationCodes.length:', locationCodes.length);
                }
                
                if (isAdmin && googleData.length) {
                    console.log('‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ Google Places API –¥–ª—è –∞–¥–º–∏–Ω–∞');
                    blocksHtml += block('–î–∞–Ω–Ω—ã–µ Google Places API (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)', googleData);
                } else {
                    console.log('‚ùå –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ Google Places API:', isAdmin, googleData.length);
                }
                if (isAdmin && nominatimData.length) {
                    console.log('‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ Nominatim –¥–ª—è –∞–¥–º–∏–Ω–∞');
                    blocksHtml += block('–î–∞–Ω–Ω—ã–µ Nominatim (OpenStreetMap) (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)', nominatimData);
                } else {
                    console.log('‚ùå –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ Nominatim:', isAdmin, nominatimData.length);
                }
                if (generalTrend.length) blocksHtml += block('–û–±—â–∏–π —Ç—Ä–µ–Ω–¥', generalTrend);
                if (houseTypeTrend.length) blocksHtml += block('–¢—Ä–µ–Ω–¥ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–ø–∞–ª–µ–Ω', houseTypeTrend);
                if (ageTrend.length) blocksHtml += block('–¢—Ä–µ–Ω–¥ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –æ–±—ä–µ–∫—Ç–∞', ageTrend);
                if (floorTrend.length) blocksHtml += block('–¢—Ä–µ–Ω–¥ –ø–æ —ç—Ç–∞–∂—É –æ–±—ä–µ–∫—Ç–∞', floorTrend);
                if (heatingTrend.length) blocksHtml += block('–¢—Ä–µ–Ω–¥ –ø–æ —Ç–∏–ø—É –æ—Ç–æ–ø–ª–µ–Ω–∏—è', heatingTrend);

                // CTA-–±–ª–æ–∫: –ø—Ä–∏–∑—ã–≤ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
                blocksHtml += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 14px; padding: 18px 14px 16px 14px; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(102,126,234,0.10); color: #fff; text-align: center;">
                        <div style="font-size: 18px; font-weight: 800; margin-bottom: 8px;">–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ?</div>
                        <div style="font-size: 15px; font-weight: 400; margin-bottom: 14px;">–ü–æ–ª—É—á–∏—Ç–µ <b>—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞</b> ‚Äî –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —ç—Ç–∞–∂–∞, –≤–æ–∑—Ä–∞—Å—Ç–∞, —Å–∏—Å—Ç–µ–º—ã –æ—Ç–æ–ø–ª–µ–Ω–∏—è, –¥–∏–Ω–∞–º–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–µ—Ç, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –Ω–∞ —Ä—ã–Ω–∫–µ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏. –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã –≤ —É–¥–æ–±–Ω–æ–º PDF-—Ñ–æ—Ä–º–∞—Ç–µ!</div>
                        <button class="btn btn-primary" style="width: 100%; font-size: 16px; margin-top: 4px; background: #fff; color: #667eea; border: none; font-weight: 700;" onclick="showFullReportStub()">–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç</button>
                    </div>
                `;

                // –ö–Ω–æ–ø–∫–∏
                const buttonsHtml = `
                    <div class="btn-row" style="margin-bottom:10px; justify-content: center; gap: 16px;">
                        <button class="btn btn-primary" style="width:48%;min-width:140px;" onclick="copyReportToClipboard()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                    </div>
                `;
                document.getElementById('reportResult').innerHTML = headerHtml + blocksHtml + buttonsHtml;
            });
        }

        function copyReportToClipboard() {
            // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –æ—Ç—á–µ—Ç–∞, –∏—Å–∫–ª—é—á–∞—è —Å—Ç—Ä–æ–∫—É –∫–Ω–æ–ø–∫–∏ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±—É—Ñ–µ—Ä" –∏ —Å—Ç—Ä–æ–∫—É –∫–Ω–æ–ø–∫–∏ "–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç"
            const reportBlock = document.getElementById('reportResult');
            let text = reportBlock.innerText;
            // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ —ç—Ç–æ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±—É—Ñ–µ—Ä"
            text = text.replace(/\n?–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±—É—Ñ–µ—Ä\s*$/,'');
            // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É "–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç" (–∫–Ω–æ–ø–∫–∞)
            text = text.replace(/\n?–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç\s*$/,'');
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –±–æ—Ç–∞ –≤ –∫–æ–Ω–µ—Ü –∫–æ–ø–∏—Ä—É–µ–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            text += "\n–ü–æ–ª—É—á–∏—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑: https://t.me/Aaadviser_bot";
            navigator.clipboard.writeText(text).then(() => {
                showToast(getLocalizedText('notifications.report_copied'), 'success');
            }).catch(() => {
                showToast(getLocalizedText('notifications.copy_error'), 'error');
            });
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
        function showTopupModal() {
            let oldModal = document.getElementById('topup-modal');
            if (oldModal) animateModalClose(oldModal);
            const modal = document.createElement('div');
            modal.id = 'topup-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <iframe id="topup-iframe" src='/webapp_topup' style='width:100%;height:180px;border:none;'></iframe>
                    <div id="topup-iframe-error" style="display:none;color:#c33;margin-top:10px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeTopupModal()" data-i18n="common.close" data-i18n="common.close">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(modal);
            const iframe = document.getElementById('topup-iframe');
            iframe.onerror = function() {
                document.getElementById('topup-iframe-error').style.display = 'block';
            };
        }
        function closeTopupModal() {
            let modal = document.getElementById('topup-modal');
            if (modal) animateModalClose(modal);
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ '–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç'
        async function showFullReportStub() {
            let telegram_id = getTelegramId();
            if (!telegram_id) {
                showToast('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å telegram_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–∫—Ä–æ–π—Ç–µ WebApp –∏–∑ Telegram.', 'error', 6000);
                return;
            }
            showProgressBar('–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø...', 20);
            try {
                const res = await fetch('/api/full_report_access', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id })
                });
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                const data = await res.json();
                hideProgressBar();
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }
                const today = new Date();
                let periodStart = data.period_start ? new Date(data.period_start) : null;
                let periodEnd = data.period_end ? new Date(data.period_end) : null;
                let isFree = false;
                if (periodStart && periodEnd && today >= periodStart && today <= periodEnd) {
                    isFree = true;
                }
                // –¢–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É, –Ω–∏—á–µ–≥–æ –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ–º!
                showFullReportConfirmModal(lastReportAddress, lastReportBedrooms, lastReportPrice, telegram_id, isFree, data.full_report_price, data.balance);
            } catch (e) {
                hideProgressBar();
                showToast(e.message || '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            }
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ '–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å' –≤ –º–æ–¥–∞–ª–∫–µ
        async function onConfirmFullReport(address, bedrooms, price, telegram_id, isFree, fullReportPrice, balance) {
            if (isFree) {
                showToast('–î–ª—è –≤–∞—Å –æ—Ç—á–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–±–æ—Ä—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', 'success');
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                goToAdditionalDataPage(address, bedrooms, price, telegram_id);
                return;
            }
            if (parseFloat(balance) >= parseFloat(fullReportPrice)) {
                showProgressBar('–°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞...', 30);
                try {
                    const deductRes = await fetch('/api/deduct_balance', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegram_id, amount: fullReportPrice })
                    });
                    if (!deductRes.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                    const deductData = await deductRes.json();
                    hideProgressBar();
                    if (deductData.success) {
                        showToast('–°—Ä–µ–¥—Å—Ç–≤–∞ —É—Å–ø–µ—à–Ω–æ —Å–ø–∏—Å–∞–Ω—ã. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–±–æ—Ä—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', 'success');
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                        goToAdditionalDataPage(address, bedrooms, price, telegram_id);
                    } else if (deductData.error === 'Insufficient balance') {
                        showModalTopup(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞.<br>–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>${fullReportPrice} EUR</b>`, () => {
                            closeModalTopup();
                            showTopupModal();
                        }, () => {
                            closeModalTopup();
                        }, balance);
                    } else {
                        showToast('–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤', 'error');
                    }
                } catch (e) {
                    hideProgressBar();
                    showToast(e.message || '–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è', 'error');
                }
            } else {
                // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
                showModalTopup(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞.<br>–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>${fullReportPrice} EUR</b>`, () => {
                    closeModalTopup();
                    showTopupModal();
                }, () => {
                    closeModalTopup();
                }, balance);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function goToAdditionalDataPage(address, bedrooms, price, telegram_id) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const params = new URLSearchParams({
                address: address,
                bedrooms: bedrooms,
                price: price,
                telegram_id: telegram_id,
                lat: geoData.lat,
                lng: geoData.lng,
                location_codes: JSON.stringify(geoData.location_codes || {})
            });
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–±–æ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            window.location.href = `/webapp_additional_data?${params.toString()}`;
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏
        function animateModalClose(modal) {
            modal.classList.add('fade-out');
            setTimeout(() => { if (modal.parentNode) modal.parentNode.removeChild(modal); }, 350);
        }

        function showModalInfo(message, onOk) {
            let oldModal = document.getElementById('modal-info');
            if (oldModal) animateModalClose(oldModal);
            const modal = document.createElement('div');
            modal.id = 'modal-info';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style='font-size:17px;font-weight:600;margin-bottom:18px;'>${message}</div>
                    <button class="btn btn-primary" id="modal-info-ok" style="width:100%;font-size:17px;">–û–ö</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modal-info-ok').focus();
            document.getElementById('modal-info-ok').onclick = function() {
                animateModalClose(modal);
                if (onOk) onOk();
            };
        }
        function closeModalInfo() {
            let modal = document.getElementById('modal-info');
            if (modal) animateModalClose(modal);
        }
        function showModalConfirm(message, onResult) {
            let oldModal = document.getElementById('modal-confirm');
            if (oldModal) animateModalClose(oldModal);
            const modal = document.createElement('div');
            modal.id = 'modal-confirm';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style='font-size:17px;font-weight:600;margin-bottom:18px;'>${message}</div>
                    <button class="btn btn-primary" id="modal-confirm-yes" style="width:100%;font-size:17px;">–°–æ–≥–ª–∞—Å–µ–Ω</button>
                    <button class="btn btn-secondary" id="modal-confirm-no" style="width:100%;margin-top:10px;font-size:16px;">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modal-confirm-yes').focus();
            let yesBtn = document.getElementById('modal-confirm-yes');
            let noBtn = document.getElementById('modal-confirm-no');
            yesBtn.onclick = function() {
                yesBtn.disabled = true; noBtn.disabled = true;
                onResult && onResult(true);
            };
            noBtn.onclick = function() {
                yesBtn.disabled = true; noBtn.disabled = true;
                onResult && onResult(false);
                animateModalClose(modal);
            };
        }
        function closeModalConfirm() {
            let modal = document.getElementById('modal-confirm');
            if (modal) animateModalClose(modal);
            window.onResult = null;
        }
        function showModalTopup(message, onTopup, onCancel, balance) {
            let oldModal = document.getElementById('modal-topup');
            if (oldModal) animateModalClose(oldModal);
            const modal = document.createElement('div');
            modal.id = 'modal-topup';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style='font-size:17px;font-weight:600;margin-bottom:18px;'>${message}<br>–í–∞—à –±–∞–ª–∞–Ω—Å: <b>${balance} EUR</b></div>
                    <button class="btn btn-primary" id="modal-topup-pay" style="width:100%;font-size:17px;" data-i18n="profile.top_up" data-i18n="profile.top_up">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                    <button class="btn btn-secondary" id="modal-topup-cancel" style="width:100%;margin-top:10px;font-size:16px;">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('modal-topup-pay').focus();
            let payBtn = document.getElementById('modal-topup-pay');
            let cancelBtn = document.getElementById('modal-topup-cancel');
            payBtn.onclick = function() {
                payBtn.disabled = true; cancelBtn.disabled = true;
                onTopup && onTopup();
            };
            cancelBtn.onclick = function() {
                payBtn.disabled = true; cancelBtn.disabled = true;
                onCancel && onCancel();
                animateModalClose(modal);
            };
        }
        function closeModalTopup() {
            let modal = document.getElementById('modal-topup');
            if (modal) animateModalClose(modal);
            window.onTopup = null;
            window.onCancel = null;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–ø—Ä—è–º—É—é
        function showFullReportConfirmModal(address, bedrooms, price, telegram_id, isFree = false, fullReportPrice = null, balance = null) {
            let oldModal = document.getElementById('full-report-modal');
            if (oldModal) oldModal.remove();
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞, –µ—Å–ª–∏ –Ω–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π
            let priceText = isFree ? '0' : (fullReportPrice !== null ? fullReportPrice : '1');
            const modal = document.createElement('div');
            modal.id = 'full-report-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞</div>
                    <div style="font-size:16px;color:#333;margin-bottom:10px;word-break:break-word;"><b>–ê–¥—Ä–µ—Å:</b> ${address}</div>
                    <div style="font-size:16px;color:#333;margin-bottom:10px;"><b>–°–ø–∞–ª–µ–Ω:</b> ${bedrooms}</div>
                    <div style="font-size:16px;color:#333;margin-bottom:18px;"><b>–¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞:</b> ‚Ç¨${Number(price).toLocaleString('ru-RU')}</div>
                    <div style="font-size:15px;color:#555;margin-bottom:18px;">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞: <b>${priceText} EUR</b></div>
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="onConfirmFullReport('${address}', '${bedrooms}', '${price}', '${telegram_id}', ${isFree}, '${fullReportPrice}', '${balance}')">–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å (${priceText} EUR)</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeFullReportModal();goToSimpleReportForm();">–ù–µ—Ç, –∞–¥—Ä–µ—Å –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function deductAndGenerateFullReport(telegram_id) {
            showProgressBar(getLocalizedText('progress.generating_report'), 0);
            fetch('/api/user_balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id, deduct: true })
            })
            .then(res => res.json())
            .then(data => {
                hideProgressBar();
                if (data.success) {
                    afterFullReportPayment(lastReportAddress, lastReportBedrooms, lastReportPrice, geoData.lat, geoData.lng, telegram_id);
                } else {
                    showToast(getLocalizedText('notifications.deduction_error'), 'error');
                }
            })
            .catch(() => {
                hideProgressBar();
                showToast(getLocalizedText('notifications.deduction_error'), 'error');
            });
        }

        function closeFullReportModal() {
            let modal = document.getElementById('full-report-modal');
            if (modal) modal.remove();
        }

        function showBalanceModal() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å
            let oldModal = document.getElementById('balance-modal');
            if (oldModal) oldModal.remove();
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.createElement('div');
            modal.id = 'balance-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞</div>
                    <div style="font-size:16px;color:#333;margin-bottom:22px;">–í–∞—à –±–∞–ª–∞–Ω—Å –Ω–µ –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ.</div>
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="closeBalanceModal();alert('–ó–∞–≥–ª—É—à–∫–∞: –ø–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é –±–∞–ª–∞–Ω—Å–∞');" data-i18n="profile.balance" data-i18n="profile.balance">–ë–∞–ª–∞–Ω—Å</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeBalanceModal()" data-i18n="common.close" data-i18n="common.close">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        function closeBalanceModal() {
            let modal = document.getElementById('balance-modal');
            if (modal) modal.remove();
        }

        // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è $1:
        function afterFullReportPayment(address, bedrooms, price, lat, lng, telegram_id) {
            showProgressBar(getLocalizedText('progress.generating_report'), 0);
            fetch('/api/full_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address, bedrooms, price, lat, lng, telegram_id })
            })
            .then(res => res.json())
            .then(data => {
                hideProgressBar();
                if (data.need_update) {
                    showUpdateReportModal(data.created_at, () => {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –æ–±–Ω–æ–≤–∏—Ç—å
                        fetch('/api/user_balance', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ telegram_id, deduct: true })
                        })
                        .then(res => res.json())
                        .then(bal => {
                            if (bal.success) {
                                fetch('/api/full_report', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ address, bedrooms, price, lat, lng, telegram_id, force_update: true })
                                })
                                .then(res => res.json())
                                .then(newData => showFullReport(newData.full_report, newData.report_id));
                            } else {
                                showToast(getLocalizedText('notifications.deduction_error'), 'error');
                            }
                        });
                    }, () => {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –æ—Ç—á—ë—Ç
                        fetch('/api/full_report', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ address, bedrooms, price, lat, lng, telegram_id })
                        })
                        .then(res => res.json())
                        .then(oldData => showFullReport(oldData.full_report, oldData.report_id));
                    });
                } else {
                    showFullReport(data.full_report, data.report_id);
                }
            })
            .catch(() => {
                hideProgressBar();
                showToast(getLocalizedText('notifications.connection_error'), 'error');
            });
        }
        // –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç—á—ë—Ç–∞
        function showUpdateReportModal(date, onUpdate, onOld) {
            let oldModal = document.getElementById('update-report-modal');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'update-report-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">–ù–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å</div>
                    <div style="font-size:16px;color:#333;margin-bottom:18px;">–í–∞—à –æ—Ç—á—ë—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω ${new Date(date).toLocaleDateString()}. –î–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ –∑–∞ $1. –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?</div>
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="closeUpdateReportModal();(${onUpdate.toString()})()">–û–±–Ω–æ–≤–∏—Ç—å –∑–∞ $1</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeUpdateReportModal();(${onOld.toString()})()">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ä—ã–π –æ—Ç—á—ë—Ç</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        function closeUpdateReportModal() {
            let modal = document.getElementById('update-report-modal');
            if (modal) modal.remove();
        }
        // showFullReport(report, report_id) ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞
        function showFullReport(report, report_id) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            closeFullReportModal();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            let html = '';
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            html += `<div style='font-size:22px;font-weight:800;color:#667eea;margin-bottom:20px;text-align:center;'>–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É</div>`;
            
            // –ë–ª–æ–∫: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ
            html += `<div style='background:#f4f7ff;border-radius:12px;padding:16px 14px 10px 14px;margin-bottom:18px;box-shadow:0 2px 8px rgba(102,126,234,0.08);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ</div>`;
            html += `<table style='width:100%;font-size:15px;'><tr><td style='padding:4px 0;'><b>–ê–¥—Ä–µ—Å:</b></td><td style='padding:4px 0;'>${report.object.address}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'><b>–°–ø–∞–ª–µ–Ω:</b></td><td style='padding:4px 0;'>${report.object.bedrooms}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'><b>–¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞:</b></td><td style='padding:4px 0;'>‚Ç¨${Number(report.object.purchase_price).toLocaleString('ru-RU')}</td></tr></table>`;
            html += `</div>`;
            
            // –ë–ª–æ–∫: ROI
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (ROI)</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>–¢–∏–ø –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</th><th style='text-align:right;padding:4px 0;'>ROI</th><th style='text-align:right;padding:4px 0;'>–î–æ—Ö–æ–¥</th><th style='text-align:right;padding:4px 0;'>–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞</td><td style='text-align:right;padding:4px 0;'>${report.roi.short_term.roi}%</td><td style='text-align:right;padding:4px 0;'>‚Ç¨${report.roi.short_term.five_year_income.toLocaleString('ru-RU')}</td><td style='text-align:right;padding:4px 0;'>‚Ç¨${report.roi.short_term.final_value.toLocaleString('ru-RU')}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞</td><td style='text-align:right;padding:4px 0;'>${report.roi.long_term.roi}%</td><td style='text-align:right;padding:4px 0;'>‚Ç¨${report.roi.long_term.five_year_income.toLocaleString('ru-RU')}</td><td style='text-align:right;padding:4px 0;'>‚Ç¨${report.roi.long_term.final_value.toLocaleString('ru-RU')}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ë–µ–∑ –∞—Ä–µ–Ω–¥—ã</td><td style='text-align:right;padding:4px 0;'>${report.roi.no_rent.roi}%</td><td style='text-align:right;padding:4px 0;'>-</td><td style='text-align:right;padding:4px 0;'>‚Ç¨${report.roi.no_rent.final_value.toLocaleString('ru-RU')}</td></tr></table>`;
            html += `</div>`;
            
            // –ë–ª–æ–∫: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏ (5 –ª–µ—Ç)</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th><th style='text-align:right;padding:4px 0;'>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</th></tr>`;
            report.alternatives.forEach(alt => {
                html += `<tr><td style='padding:4px 0;'>${alt.name}</td><td style='text-align:right;padding:4px 0;'>${(alt.yield*100).toFixed(1)}%</td></tr>`;
            });
            html += `</table></div>`;
            
            // –ë–ª–æ–∫: –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>–ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th><th style='text-align:right;padding:4px 0;'>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ò–Ω—Ñ–ª—è—Ü–∏—è</td><td style='text-align:right;padding:4px 0;'>${report.macro.inflation}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ö—É—Ä—Å EUR/TRY</td><td style='text-align:right;padding:4px 0;'>${report.macro.eur_try}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞</td><td style='text-align:right;padding:4px 0;'>${report.macro.refi_rate}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–†–æ—Å—Ç –í–í–ü</td><td style='text-align:right;padding:4px 0;'>${report.macro.gdp_growth}%</td></tr></table>`;
            html += `</div>`;
            
            // –ë–ª–æ–∫: –ù–∞–ª–æ–≥–∏ –∏ —Å–±–æ—Ä—ã
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>–ù–∞–ª–æ–≥–∏ –∏ —Å–±–æ—Ä—ã</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>–¢–∏–ø –Ω–∞–ª–æ–≥–∞</th><th style='text-align:right;padding:4px 0;'>–°—Ç–∞–≤–∫–∞</th></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ù–∞–ª–æ–≥ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥</td><td style='text-align:right;padding:4px 0;'>${report.taxes.transfer_tax*100}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ì–µ—Ä–±–æ–≤—ã–π —Å–±–æ—Ä</td><td style='text-align:right;padding:4px 0;'>${report.taxes.stamp_duty*100}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ù–æ—Ç–∞—Ä–∏—É—Å</td><td style='text-align:right;padding:4px 0;'>‚Ç¨${report.taxes.notary}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ù–∞–ª–æ–≥ –Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ</td><td style='text-align:right;padding:4px 0;'>${report.taxes.annual_property_tax*100}% - ${report.taxes.annual_property_tax_max*100}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ü–æ–¥–æ—Ö–æ–¥–Ω—ã–π –Ω–∞–ª–æ–≥ —Å –∞—Ä–µ–Ω–¥—ã</td><td style='text-align:right;padding:4px 0;'>${report.taxes.rental_income_tax}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–∏—Ä–æ—Å—Ç –∫–∞–ø–∏—Ç–∞–ª–∞</td><td style='text-align:right;padding:4px 0;'>${report.taxes.capital_gains_tax}</td></tr></table>`;
            html += `</div>`;
            
            // –ë–ª–æ–∫: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>–ú–µ—Ç—Ä–∏–∫–∞</th><th style='text-align:right;padding:4px 0;'>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>`;
            html += `<tr><td style='padding:4px 0;'>Yield</td><td style='text-align:right;padding:4px 0;'>${(report.yield*100).toFixed(1)}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ò–Ω–¥–µ–∫—Å —Ü–µ–Ω</td><td style='text-align:right;padding:4px 0;'>${report.price_index}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ò–ø–æ—Ç–µ—á–Ω–∞—è —Å—Ç–∞–≤–∫–∞</td><td style='text-align:right;padding:4px 0;'>${(report.mortgage_rate*100).toFixed(1)}%</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Ü–µ–Ω</td><td style='text-align:right;padding:4px 0;'>${report.global_house_price_index}</td></tr></table>`;
            html += `</div>`;
            
            // –ë–ª–æ–∫: –†–∏—Å–∫–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ä–∞–π–æ–Ω–∞
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:12px;'>–†–∏—Å–∫–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ä–∞–π–æ–Ω–∞</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:8px;'><tr><th style='text-align:left;padding:4px 0;'>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th style='text-align:left;padding:4px 0;' data-i18n="balance.description">–û–ø–∏—Å–∞–Ω–∏–µ</th></tr>`;
            report.risks.forEach((risk, index) => {
                html += `<tr><td style='padding:4px 0;'>–†–∏—Å–∫ ${index + 1}</td><td style='padding:4px 0;'>${risk}</td></tr>`;
            });
            html += `<tr><td style='padding:4px 0;' data-i18n="reports.liquidity">–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å</td><td style='padding:4px 0;'>${report.liquidity}</td></tr>`;
            html += `<tr><td style='padding:4px 0;'>–†–∞–∑–≤–∏—Ç–∏–µ —Ä–∞–π–æ–Ω–∞</td><td style='padding:4px 0;'>${report.district}</td></tr></table>`;
            html += `</div>`;
            
            // –ò—Ç–æ–≥/summary
            html += `<div style='background:#f4f7ff;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);font-size:15px;color:#222;'>${report.summary}</div>`;
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            html += `<div style="margin-bottom:10px;">
                <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="downloadPDF()">–°–∫–∞—á–∞—Ç—å PDF</button>
            </div>`;
            
            document.getElementById('reportResult').innerHTML = html;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç—É
            currentReportData = {
                address: report.object.address,
                bedrooms: report.object.bedrooms,
                price: report.object.purchase_price,
                report: report,
                id: report_id // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç—á–µ—Ç–∞ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            };
            
            showToast(getLocalizedText('notifications.report_generated'), 'success');
        }
        

        
        function showClientModal() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å
            let oldModal = document.getElementById('client-modal');
            if (oldModal) oldModal.remove();
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.createElement('div');
            modal.id = 'client-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç –∫–ª–∏–µ–Ω—Ç—É</div>
                    <div style="font-size:16px;color:#333;margin-bottom:22px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞</div>
                    <input type="text" id="client-name" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px;font-size:16px;">
                    <input type="text" id="client-username" placeholder="Telegram username (–±–µ–∑ @)" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:20px;font-size:16px;">
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="sendReportToClient()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeClientModal()" data-i18n="common.cancel" data-i18n="common.cancel">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeClientModal() {
            let modal = document.getElementById('client-modal');
            if (modal) modal.remove();
        }
        
        function sendReportToClient() {
            const clientName = document.getElementById('client-name').value.trim();
            const clientUsername = document.getElementById('client-username').value.trim();
            
            if (!clientName || !clientUsername) {
                showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (!currentReportData || !currentReportData.report) {
                showToast('–î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
                return;
            }
            
            if (!window._lastPdfPath) {
                showToast('PDF –µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –°–Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∞–π—Ç–µ PDF!', 'error');
                return;
            }
            
            showProgressBar('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –∫–ª–∏–µ–Ω—Ç—É...', 0);
            
            // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É
            saveReportIfNeededAndGeneratePdf(currentReportData.report, function(reportId) {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF —Å report_id
                fetch('/api/generate_pdf_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        report: currentReportData.report,
                        add_realtor_contacts: false,
                        add_client_name: false,
                        report_id: reportId
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window._lastPdfPath = data.pdf_path;
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF –∫–ª–∏–µ–Ω—Ç—É
                        fetch('/api/send_pdf_to_client', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                realtor_telegram_id: userData.id,
                                client_name: clientName,
                                client_telegram: clientUsername,
                                pdf_path: window._lastPdfPath
                            })
                        })
                        .then(res => res.json())
                        .then(sendData => {
                            hideProgressBar();
                            closeClientModal();
                            if (sendData.success) {
                                showToast('–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É!', 'success');
                            } else {
                                showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É', 'error');
                            }
                        })
                        .catch(() => {
                            hideProgressBar();
                            showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É', 'error');
                        });
                    } else {
                        hideProgressBar();
                        showToast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: ' + (data.error || ''), 'error');
                    }
                })
                .catch(() => {
                    hideProgressBar();
                    showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                });
            });
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç—á–µ—Ç –µ—Å–ª–∏ –Ω–µ—Ç id, –∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç cb(reportId) ‚Äî –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF
        async function saveReportIfNeededAndGeneratePdf(report, cb) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ID –≤ currentReportData
            if (currentReportData && currentReportData.id) {
                cb(currentReportData.id);
                return;
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ID –≤ —Å–∞–º–æ–º –æ—Ç—á–µ—Ç–µ
            if (report.id) {
                cb(report.id);
                return;
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –≤ –±–∞–∑—É
            const res = await fetch('/api/user_reports/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    telegram_id: userData.id, 
                    full_report: report, 
                    address: report.object.address, 
                    report_type: 'full_report' 
                })
            });
            const data = await res.json();
            if (data.success && data.report_id) {
                // –û–±–Ω–æ–≤–ª—è–µ–º ID –≤ currentReportData
                if (currentReportData) {
                    currentReportData.id = data.report_id;
                }
                cb(data.report_id);
            } else {
                showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ (–Ω–µ –ø–æ–ª—É—á–µ–Ω id)', 'error');
            }
        }

        function downloadPDF() {
            if (!currentReportData || !currentReportData.report) {
                showToast('–î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
                return;
            }
            showProgressBar('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF...', 0);
            fetch('/api/generate_pdf_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    report: currentReportData.report,
                    add_realtor_contacts: false,
                    add_client_name: false,
                    report_id: currentReportData.id,
                    telegram_id: getTelegramId()
                })
            })
            .then(res => res.json())
            .then(data => {
                hideProgressBar();
                if (data.success) {
                    if (data.telegram_send_status === 'sent') {
                        closePdfModal && closePdfModal();
                        showToast('PDF-–æ—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ Telegram!', 'success', 6000);
                        setTimeout(() => { goToMainMenu(); }, 2000);
                    } else if (data.telegram_send_status && data.telegram_send_status.startsWith('error')) {
                        showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF —á–µ—Ä–µ–∑ Telegram: ' + data.telegram_send_status, 'error', 8000);
                    } else {
                        showToast('PDF —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram.', 'error', 8000);
                    }
                } else {
                    showToast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: ' + (data.error || ''), 'error');
                }
            })
            .catch(() => {
                hideProgressBar();
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
            });
        }

        function showPdfDownloadModal(pdfUrl) {
            let oldModal = document.getElementById('pdf-modal');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'pdf-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">PDF —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω</div>
                    <div style="font-size:16px;color:#333;margin-bottom:18px;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –µ—ë –≤ –±—Ä–∞—É–∑–µ—Ä–µ.<br>–ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram Desktop –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ WebApp –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
                    <div style='word-break:break-all;background:#f4f7ff;padding:10px 8px;border-radius:8px;margin-bottom:16px;font-size:14px;color:#222;'>${location.origin}${pdfUrl}</div>
                    <button class="btn btn-secondary" style="width:100%;font-size:16px;" onclick="closePdfModal();goToMainMenu();">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        function closePdfModal() {
            let modal = document.getElementById('pdf-modal');
            if (modal) modal.remove();
        }
        
        function showPDFSavedModal() {
            const modal = document.createElement('div');
            modal.id = 'pdf-saved-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 24px 24px 24px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:19px;font-weight:700;color:#667eea;margin-bottom:16px;">PDF —Å–æ—Ö—Ä–∞–Ω–µ–Ω</div>
                    <div style="font-size:16px;color:#333;margin-bottom:22px;">–û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ —Å–∫–∞—á–∞–Ω –Ω–∞ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.</div>
                    <button class="btn btn-primary" style="width:100%;font-size:17px;" onclick="closePDFSavedModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closePDFSavedModal() {
            let modal = document.getElementById('pdf-saved-modal');
            if (modal) modal.remove();
        }
        
        function goToMainMenu() {
            window.location.href = '/webapp';
        }

        let telegram_id = null;
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.id) {
            telegram_id = window.Telegram.WebApp.initDataUnsafe.user.id;
            localStorage.setItem('telegram_id', telegram_id);
        } else {
            telegram_id = localStorage.getItem('telegram_id');
        }

        function getTelegramId() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.id) {
                const telegramId = window.Telegram.WebApp.initDataUnsafe.user.id;
                localStorage.setItem('telegram_id', telegramId);
                return telegramId;
            }
            return localStorage.getItem('telegram_id');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        async function checkAdminStatus() {
            const telegram_id = getTelegramId();
            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∞ –¥–ª—è telegram_id:', telegram_id);
            
            if (!telegram_id) {
                console.log('‚ùå telegram_id –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            try {
                const response = await fetch('/api/check_admin_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id })
                });
                
                console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
                    const isAdmin = data.is_admin || false;
                    console.log('üëë –°—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞:', isAdmin);
                    return isAdmin;
                } else {
                    const errorData = await response.json();
                    console.log('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorData);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∞:', error);
            }
            
            return false;
        }



        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showStep('address');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞
        setTimeout(() => {
            const addressInput = document.getElementById('addressInput');
            if (addressInput) {
                addressInput.focus();
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–æ–ª–µ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞
                addressInput.disabled = false;
                addressInput.readOnly = false;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                addressInput.addEventListener('click', function(e) {
                    console.log('Address input clicked');
                    e.stopPropagation();
                });
                
                addressInput.addEventListener('focus', function() {
                    console.log('Address input focused');
                });
                
                addressInput.addEventListener('input', function() {
                    console.log('Address input value:', this.value);
                });
            }
        }, 100);
    </script>
</body>
</html> 