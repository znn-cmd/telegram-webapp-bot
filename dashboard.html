<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 500;
        }

        .stat-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .stat-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .stat-change.neutral {
            background: #e2e3e5;
            color: #383d41;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #667eea;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.1rem;
            color: #fafafa;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: transform 0.2s ease;
            margin: 10px;
        }

        .refresh-btn:hover {
            transform: scale(1.05);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        .controls select {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 1rem;
            margin: 0 10px;
            background: white;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-container h3 {
            color: #667eea;
            font-size: 1.3rem;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤ */
        .regions-section {
            margin-bottom: 30px;
        }

        .regions-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .regions-table-container h3,
        .regions-chart-container h3 {
            color: #667eea;
            font-size: 1.3rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .table-scroll {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .regions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .regions-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
            padding: 12px 8px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .regions-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .regions-table tr:hover {
            background: #f8f9fa;
        }

        .regions-table td:first-child {
            font-weight: bold;
            color: #667eea;
            text-align: center;
            width: 50px;
        }

        .regions-table td:nth-child(3) {
            text-align: center;
            font-weight: bold;
            color: #28a745;
        }

        .regions-chart-container {
            display: flex;
            flex-direction: column;
        }

        .regions-chart-container .chart-wrapper {
            flex: 1;
            min-height: 300px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .regions-container {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 250px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Aaadviser 2.0 Dashboard</h1>
            <p>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
            <div class="controls">
                <button class="refresh-btn" onclick="loadDashboard()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <select id="periodSelect" onchange="loadDashboard()">
                    <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                    <option value="30" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                    <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                </select>
            </div>
        </div>

        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-change" id="usersChange">-</div>
                </div>
                <div class="stat-card">
                    <h3>üìÑ –û—Ç—á–µ—Ç—ã</h3>
                    <div class="stat-value" id="totalReports">-</div>
                    <div class="stat-change" id="reportsChange">-</div>
                </div>
                <div class="stat-card">
                    <h3>üí∞ –î–æ—Ö–æ–¥—ã</h3>
                    <div class="stat-value" id="totalRevenue">-</div>
                    <div class="stat-change" id="revenueChange">-</div>
                </div>
                <div class="stat-card">
                    <h3>üí≥ –ü–ª–∞—Ç–µ–∂–∏</h3>
                    <div class="stat-value" id="totalPayments">-</div>
                    <div class="stat-change" id="paymentsChange">-</div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
                    <div class="stat-value" id="activeSubscriptions">-</div>
                    <div class="stat-change" id="activeSubscriptionsChange">-</div>
                </div>
                <div class="stat-card">
                    <h3>‚ùå –ò—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
                    <div class="stat-value" id="expiredSubscriptions">-</div>
                    <div class="stat-change" id="expiredSubscriptionsChange">-</div>
                </div>
                <div class="stat-card">
                    <h3>üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    <div class="stat-value" id="activeUsers">-</div>
                    <div class="stat-change" id="activeUsersChange">-</div>
                </div>
                <div class="stat-card">
                    <h3>üî¥ –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    <div class="stat-value" id="inactiveUsers">-</div>
                    <div class="stat-change" id="inactiveUsersChange">-</div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫</h3>
                    <div class="chart-wrapper">
                        <canvas id="subscriptionsChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ—Ç—á–µ—Ç–æ–≤</h3>
                    <div class="chart-wrapper">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>üåç –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —è–∑—ã–∫–∞–º</h3>
                    <div class="chart-wrapper">
                        <canvas id="languagesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º -->
            <div class="regions-section">
                <div class="regions-container">
                    <div class="regions-table-container">
                        <h3>üìç –¢–æ–ø-100 —Ä–µ–≥–∏–æ–Ω–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—Ç—á–µ—Ç–æ–≤</h3>
                        <div class="table-scroll">
                            <table class="regions-table">
                                <thead>
                                    <tr>
                                        <th>‚Ññ</th>
                                        <th>–†–µ–≥–∏–æ–Ω</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤</th>
                                    </tr>
                                </thead>
                                <tbody id="regionsTableBody">
                                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="regions-chart-container">
                        <h3>üìä –¢–æ–ø-10 —Ä–µ–≥–∏–æ–Ω–æ–≤</h3>
                        <div class="chart-wrapper">
                            <canvas id="regionsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º —É—Ä–æ–≤–Ω—è–º -->
            <div class="regions-section">
                <div class="regions-container">
                    <div class="regions-table-container">
                        <h3>üåç –¢–æ–ø-10 —Å—Ç—Ä–∞–Ω</h3>
                        <div class="table-scroll">
                            <table class="regions-table">
                                <thead>
                                    <tr>
                                        <th>‚Ññ</th>
                                        <th>–°—Ç—Ä–∞–Ω–∞</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤</th>
                                    </tr>
                                </thead>
                                <tbody id="countriesTableBody">
                                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="regions-chart-container">
                        <h3>üìä –¢–æ–ø-10 —Å—Ç—Ä–∞–Ω</h3>
                        <div class="chart-wrapper">
                            <canvas id="countriesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="regions-section">
                <div class="regions-container">
                    <div class="regions-table-container">
                        <h3>üèõÔ∏è –¢–æ–ø-10 –æ–±–ª–∞—Å—Ç–µ–π/—à—Ç–∞—Ç–æ–≤</h3>
                        <div class="table-scroll">
                            <table class="regions-table">
                                <thead>
                                    <tr>
                                        <th>‚Ññ</th>
                                        <th>–û–±–ª–∞—Å—Ç—å/–®—Ç–∞—Ç</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤</th>
                                    </tr>
                                </thead>
                                <tbody id="statesTableBody">
                                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="regions-chart-container">
                        <h3>üìä –¢–æ–ø-10 –æ–±–ª–∞—Å—Ç–µ–π/—à—Ç–∞—Ç–æ–≤</h3>
                        <div class="chart-wrapper">
                            <canvas id="statesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="regions-section">
                <div class="regions-container">
                    <div class="regions-table-container">
                        <h3>üèôÔ∏è –¢–æ–ø-10 –≥–æ—Ä–æ–¥–æ–≤</h3>
                        <div class="table-scroll">
                            <table class="regions-table">
                                <thead>
                                    <tr>
                                        <th>‚Ññ</th>
                                        <th>–ì–æ—Ä–æ–¥</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤</th>
                                    </tr>
                                </thead>
                                <tbody id="citiesTableBody">
                                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="regions-chart-container">
                        <h3>üìä –¢–æ–ø-10 –≥–æ—Ä–æ–¥–æ–≤</h3>
                        <div class="chart-wrapper">
                            <canvas id="citiesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="regions-section">
                <div class="regions-container">
                    <div class="regions-table-container">
                        <h3>üèòÔ∏è –¢–æ–ø-10 —Ä–∞–π–æ–Ω–æ–≤</h3>
                        <div class="table-scroll">
                            <table class="regions-table">
                                <thead>
                                    <tr>
                                        <th>‚Ññ</th>
                                        <th>–†–∞–π–æ–Ω</th>
                                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤</th>
                                    </tr>
                                </thead>
                                <tbody id="districtsTableBody">
                                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="regions-chart-container">
                        <h3>üìä –¢–æ–ø-10 —Ä–∞–π–æ–Ω–æ–≤</h3>
                        <div class="chart-wrapper">
                            <canvas id="districtsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü—ã —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
            <div class="table-container">
                <h3>üìã –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <table>
                    <thead>
                        <tr>
                            <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                            <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody id="detailedStats">
                        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let dashboardData = {};

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–∞—à–±–æ—Ä–¥–∞
        async function loadDashboard() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            dashboard.style.display = 'none';

            try {
                const period = document.getElementById('periodSelect').value;
                const response = await fetch(`/api/dashboard/stats`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                dashboardData = await response.json();
                
                if (dashboardData.error) {
                    throw new Error(dashboardData.error);
                }
                
                updateDashboard();
                
                loading.style.display = 'none';
                dashboard.style.display = 'block';
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${err.message}`;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞
        function updateDashboard() {
            updateStatsCards();
            updateCharts();
            updateRegionsTable();
            updateCountriesTable();
            updateStatesTable();
            updateCitiesTable();
            updateDistrictsTable();
            updateDetailedStats();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatsCards() {
            const users = dashboardData.users || {};
            const reports = dashboardData.reports || {};
            const payments = dashboardData.payments || {};

            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            document.getElementById('totalUsers').textContent = users.total_users || 0;
            const usersChange = users.new_users_7d || 0;
            const usersChangeEl = document.getElementById('usersChange');
            usersChangeEl.textContent = `+${usersChange} –∑–∞ –Ω–µ–¥–µ–ª—é`;
            usersChangeEl.className = `stat-change ${usersChange > 0 ? 'positive' : 'neutral'}`;

            // –û—Ç—á–µ—Ç—ã
            document.getElementById('totalReports').textContent = reports.total_reports || 0;
            const reportsChange = reports.reports_7d || 0;
            const reportsChangeEl = document.getElementById('reportsChange');
            reportsChangeEl.textContent = `+${reportsChange} –∑–∞ –Ω–µ–¥–µ–ª—é`;
            reportsChangeEl.className = `stat-change ${reportsChange > 0 ? 'positive' : 'neutral'}`;

            // –î–æ—Ö–æ–¥—ã
            const revenue = payments.total_revenue || 0;
            document.getElementById('totalRevenue').textContent = `‚Ç¨${revenue.toFixed(2)}`;
            const revenueChange = payments.payments_30d || 0;
            const revenueChangeEl = document.getElementById('revenueChange');
            revenueChangeEl.textContent = `${revenueChange} –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞ –º–µ—Å—è—Ü`;
            revenueChangeEl.className = `stat-change ${revenueChange > 0 ? 'positive' : 'neutral'}`;

            // –ü–ª–∞—Ç–µ–∂–∏
            document.getElementById('totalPayments').textContent = payments.total_payments || 0;
            const paymentsChange = payments.payments_7d || 0;
            const paymentsChangeEl = document.getElementById('paymentsChange');
            paymentsChangeEl.textContent = `+${paymentsChange} –∑–∞ –Ω–µ–¥–µ–ª—é`;
            paymentsChangeEl.className = `stat-change ${paymentsChange > 0 ? 'positive' : 'neutral'}`;

            // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
            document.getElementById('activeSubscriptions').textContent = users.active_subscriptions || 0;
            const activeSubscriptionsChangeEl = document.getElementById('activeSubscriptionsChange');
            activeSubscriptionsChangeEl.textContent = '–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏';
            activeSubscriptionsChangeEl.className = 'stat-change positive';

            // –ò—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
            document.getElementById('expiredSubscriptions').textContent = users.expired_subscriptions || 0;
            const expiredSubscriptionsChangeEl = document.getElementById('expiredSubscriptionsChange');
            expiredSubscriptionsChangeEl.textContent = '–ò—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏';
            expiredSubscriptionsChangeEl.className = 'stat-change negative';

            // –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            document.getElementById('activeUsers').textContent = users.active_users || 0;
            const activeUsersChangeEl = document.getElementById('activeUsersChange');
            activeUsersChangeEl.textContent = '–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π';
            activeUsersChangeEl.className = 'stat-change positive';

            // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            document.getElementById('inactiveUsers').textContent = users.inactive_users || 0;
            const inactiveUsersChangeEl = document.getElementById('inactiveUsersChange');
            inactiveUsersChangeEl.textContent = '–ë–æ–ª–µ–µ 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥';
            inactiveUsersChangeEl.className = 'stat-change negative';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function updateCharts() {
            updateSubscriptionsChart();
            updateDailyChart();
            updateLanguagesChart();
            updateRegionsChart();
            updateCountriesChart();
            updateStatesChart();
            updateCitiesChart();
            updateDistrictsChart();
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫
        function updateSubscriptionsChart() {
            const ctx = document.getElementById('subscriptionsChart').getContext('2d');
            
            if (charts.subscriptions) {
                charts.subscriptions.destroy();
            }

            const users = dashboardData.users || {};
            const activeSubscriptions = users.active_subscriptions || 0;
            const expiredSubscriptions = users.expired_subscriptions || 0;
            const totalSubscriptions = activeSubscriptions + expiredSubscriptions;

            charts.subscriptions = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏', '–ò—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏'],
                    datasets: [{
                        data: [activeSubscriptions, expiredSubscriptions],
                        backgroundColor: [
                            '#28a745',
                            '#dc3545'
                        ],
                        borderColor: [
                            '#28a745',
                            '#dc3545'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–∏
        function updateDailyChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            if (charts.daily) {
                charts.daily.destroy();
            }

            const dailyData = dashboardData.daily?.daily_stats || [];
            const labels = dailyData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
            }).reverse();

            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                            data: dailyData.map(item => item.users).reverse(),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: '–û—Ç—á–µ—Ç—ã',
                            data: dailyData.map(item => item.reports).reverse(),
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ —è–∑—ã–∫–æ–≤
        function updateLanguagesChart() {
            const ctx = document.getElementById('languagesChart').getContext('2d');
            
            if (charts.languages) {
                charts.languages.destroy();
            }

            const languages = dashboardData.users?.languages || {};
            const labels = Object.keys(languages);
            const data = Object.values(languages);

            charts.languages = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe',
                            '#00f2fe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤
        function updateRegionsChart() {
            const ctx = document.getElementById('regionsChart').getContext('2d');
            
            if (charts.regions) {
                charts.regions.destroy();
            }

            const top10Regions = dashboardData.regions?.top_10_regions || [];
            const labels = top10Regions.map(item => item[0]);
            const data = top10Regions.map(item => item[1]);

            charts.regions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤',
                        data: data,
                        backgroundColor: '#667eea',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç—Ä–∞–Ω
        function updateCountriesChart() {
            const ctx = document.getElementById('countriesChart').getContext('2d');
            
            if (charts.countries) {
                charts.countries.destroy();
            }

            const top10Countries = dashboardData.regions?.top_10_countries || [];
            const labels = top10Countries.map(item => item[0]);
            const data = top10Countries.map(item => item[1]);

            charts.countries = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤',
                        data: data,
                        backgroundColor: '#4facfe',
                        borderColor: '#4facfe',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ –æ–±–ª–∞—Å—Ç–µ–π/—à—Ç–∞—Ç–æ–≤
        function updateStatesChart() {
            const ctx = document.getElementById('statesChart').getContext('2d');
            
            if (charts.states) {
                charts.states.destroy();
            }

            const top10States = dashboardData.regions?.top_10_states || [];
            const labels = top10States.map(item => item[0]);
            const data = top10States.map(item => item[1]);

            charts.states = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤',
                        data: data,
                        backgroundColor: '#00f2fe',
                        borderColor: '#00f2fe',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ –≥–æ—Ä–æ–¥–æ–≤
        function updateCitiesChart() {
            const ctx = document.getElementById('citiesChart').getContext('2d');
            
            if (charts.cities) {
                charts.cities.destroy();
            }

            const top10Cities = dashboardData.regions?.top_10_cities || [];
            const labels = top10Cities.map(item => item[0]);
            const data = top10Cities.map(item => item[1]);

            charts.cities = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤',
                        data: data,
                        backgroundColor: '#f093fb',
                        borderColor: '#f093fb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–π–æ–Ω–æ–≤
        function updateDistrictsChart() {
            const ctx = document.getElementById('districtsChart').getContext('2d');
            
            if (charts.districts) {
                charts.districts.destroy();
            }

            const top10Districts = dashboardData.regions?.top_10_districts || [];
            const labels = top10Districts.map(item => item[0]);
            const data = top10Districts.map(item => item[1]);

            charts.districts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤',
                        data: data,
                        backgroundColor: '#f5576c',
                        borderColor: '#f5576c',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–≥–∏–æ–Ω–æ–≤
        function updateRegionsTable() {
            const tbody = document.getElementById('regionsTableBody');
            tbody.innerHTML = '';

            const top100Regions = dashboardData.regions?.top_100_regions || [];
            
            top100Regions.forEach((region, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${region[0]}</td>
                    <td>${region[1]}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω
        function updateCountriesTable() {
            const tbody = document.getElementById('countriesTableBody');
            tbody.innerHTML = '';

            const top10Countries = dashboardData.regions?.top_10_countries || [];
            
            top10Countries.forEach((country, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${country[0]}</td>
                    <td>${country[1]}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±–ª–∞—Å—Ç–µ–π/—à—Ç–∞—Ç–æ–≤
        function updateStatesTable() {
            const tbody = document.getElementById('statesTableBody');
            tbody.innerHTML = '';

            const top10States = dashboardData.regions?.top_10_states || [];
            
            top10States.forEach((state, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${state[0]}</td>
                    <td>${state[1]}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≥–æ—Ä–æ–¥–æ–≤
        function updateCitiesTable() {
            const tbody = document.getElementById('citiesTableBody');
            tbody.innerHTML = '';

            const top10Cities = dashboardData.regions?.top_10_cities || [];
            
            top10Cities.forEach((city, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${city[0]}</td>
                    <td>${city[1]}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞–π–æ–Ω–æ–≤
        function updateDistrictsTable() {
            const tbody = document.getElementById('districtsTableBody');
            tbody.innerHTML = '';

            const top10Districts = dashboardData.regions?.top_10_districts || [];
            
            top10Districts.forEach((district, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${district[0]}</td>
                    <td>${district[1]}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateDetailedStats() {
            const tbody = document.getElementById('detailedStats');
            tbody.innerHTML = '';

            const stats = [
                { label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', value: dashboardData.users?.active_users || 0, desc: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π' },
                { label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º', value: dashboardData.users?.users_with_balance || 0, desc: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º' },
                { label: '–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏', value: dashboardData.users?.active_subscriptions || 0, desc: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–µ–π—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π' },
                { label: '–ò—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏', value: dashboardData.users?.expired_subscriptions || 0, desc: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π' },
                { label: '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', value: dashboardData.users?.inactive_users || 0, desc: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–æ–ª–µ–µ 30 –¥–Ω–µ–π' },
                { label: '–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –æ—Ç—á–µ—Ç–∞', value: `‚Ç¨${(dashboardData.reports?.avg_price || 0).toFixed(2)}`, desc: '–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞' },
                { label: '–û—Ç—á–µ—Ç—ã –∑–∞ –º–µ—Å—è—Ü', value: dashboardData.reports?.reports_30d || 0, desc: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç—á–µ—Ç–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π' },
                { label: '–û–±—â–∏–π –¥–æ—Ö–æ–¥', value: `‚Ç¨${(dashboardData.payments?.total_revenue || 0).toFixed(2)}`, desc: '–û–±—â–∞—è —Å—É–º–º–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π' },
                { label: '–ü–ª–∞—Ç–µ–∂–∏ –∑–∞ –º–µ—Å—è—Ü', value: dashboardData.payments?.payments_30d || 0, desc: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π' },
                { label: '–í—Å–µ–≥–æ —Ä–µ–≥–∏–æ–Ω–æ–≤', value: dashboardData.regions?.total_regions || 0, desc: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã —Å –æ—Ç—á–µ—Ç–∞–º–∏' },
                { label: '–í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω', value: dashboardData.regions?.total_countries || 0, desc: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã —Å –æ—Ç—á–µ—Ç–∞–º–∏' },
                { label: '–í—Å–µ–≥–æ –æ–±–ª–∞—Å—Ç–µ–π', value: dashboardData.regions?.total_states || 0, desc: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏/—à—Ç–∞—Ç—ã —Å –æ—Ç—á–µ—Ç–∞–º–∏' },
                { label: '–í—Å–µ–≥–æ –≥–æ—Ä–æ–¥–æ–≤', value: dashboardData.regions?.total_cities || 0, desc: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ —Å –æ—Ç—á–µ—Ç–∞–º–∏' },
                { label: '–í—Å–µ–≥–æ —Ä–∞–π–æ–Ω–æ–≤', value: dashboardData.regions?.total_districts || 0, desc: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ä–∞–π–æ–Ω—ã —Å –æ—Ç—á–µ—Ç–∞–º–∏' },
                { label: '–û—Ç—á–µ—Ç—ã —Å –∞–¥—Ä–µ—Å–æ–º', value: dashboardData.regions?.total_reports_with_address || 0, desc: '–û—Ç—á–µ—Ç—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º' }
            ];

            stats.forEach(stat => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stat.label}</td>
                    <td><strong>${stat.value}</strong></td>
                    <td>${stat.desc}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(loadDashboard, 300000);

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
