<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - Мои отчеты</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        .title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 24px;
            text-align: center;
        }
        .report-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .report-card {
            background: #f8f9fa;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            padding: 18px 14px 14px 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .report-address {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 2px;
        }
        .report-meta {
            font-size: 13px;
            color: #555;
        }
        .report-type {
            font-size: 13px;
            color: #764ba2;
            font-weight: 500;
        }
        .btn {
            margin-top: 10px;
            padding: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            transition: background 0.2s;
        }
        .btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        .back-btn {
            margin-top: 30px;
            background: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
        }
        .back-btn:hover {
            background: #e2e2e2;
        }
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 16px;
            margin-top: 30px;
        }
        .empty {
            text-align: center;
            color: #888;
            font-size: 15px;
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">Aaadviser</div>
        <div class="title" id="pageTitle">Мои отчеты</div>
        <div id="loading" class="loading">Загрузка...</div>
        <div id="reportList" class="report-list" style="display:none;"></div>
        <div id="empty" style="display:none;text-align:center;color:#888;font-size:18px;margin-top:40px;">
    <span id="emptyText"></span>
</div>
        <button class="btn back-btn" onclick="goToMainMenu()">В главное меню</button>
    </div>
    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        let userData = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
        // Локализация (можно расширить)
        const locales = {
            'ru': {
                'pageTitle': 'Мои отчеты',
                'loading': 'Загрузка...',
                'empty': 'У вас еще нет сохраненных отчетов, начните с формирования первого и сохраните его для дальнейшей работы.',
                'mainMenu': 'В главное меню',
                'view': 'Посмотреть',
                'full': 'Полный',
                'market_analysis': 'Базовый',
                'download_pdf': 'Скачать PDF',
                'send_to_client': 'Отправить клиенту',
                'delete': 'Удалить',
                'update': 'Обновить',
                'confirm_delete': 'Вы уверены, что хотите удалить этот отчет?',
                'confirm_update': 'Вы уверены, что хотите обновить этот отчет? Это потребует 1$ из вашего баланса.'
            },
            'en': {
                'pageTitle': 'My Reports',
                'loading': 'Loading...',
                'empty': 'You have no saved reports yet. Start by generating your first report and save it for future use.',
                'mainMenu': 'Main menu',
                'view': 'View',
                'full': 'Full',
                'market_analysis': 'Basic',
                'download_pdf': 'Download PDF',
                'send_to_client': 'Send to client',
                'delete': 'Delete',
                'update': 'Update',
                'confirm_delete': 'Are you sure you want to delete this report?',
                'confirm_update': 'Are you sure you want to update this report? This will require 1$ from your balance.'
            }
        };
        let currentLanguage = 'ru';
        if (userData && userData.language_code && locales[userData.language_code]) {
            currentLanguage = userData.language_code;
        }
        function getText(key) {
            return locales[currentLanguage][key] || key;
        }
        document.getElementById('pageTitle').textContent = getText('pageTitle');
        document.getElementById('loading').textContent = getText('loading');
        document.querySelector('.back-btn').textContent = getText('mainMenu');
        function showEmptyMessage() {
            document.getElementById('emptyText').textContent = getText('empty');
            document.getElementById('empty').style.display = '';
            document.getElementById('reportList').style.display = 'none';
        }
        // Загрузка отчетов
        async function loadReports() {
            if (!userData) return;
            document.getElementById('loading').style.display = '';
            document.getElementById('reportList').style.display = 'none';
            document.getElementById('empty').style.display = 'none';
            try {
                const res = await fetch('/api/user_reports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id })
                });
                const data = await res.json();
                if (data.success && data.reports && data.reports.length > 0) {
                    renderReports(data.reports);
                } else {
                    showEmptyMessage();
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (e) {
                showEmptyMessage();
                document.getElementById('loading').style.display = 'none';
            }
            document.getElementById('loading').style.display = 'none';
        }
        function renderReports(reports) {
            const list = document.getElementById('reportList');
            list.innerHTML = '';
            if (!reports || reports.length === 0) {
                showEmptyMessage();
                return;
            }
            document.getElementById('empty').style.display = 'none';
            reports.forEach(r => {
                const card = document.createElement('div');
                card.className = 'report-card';
                const createdAt = new Date(r.created_at);
                const now = new Date();
                const daysAgo = Math.floor((now - createdAt) / (1000*60*60*24));
                const canUpdate = daysAgo > 30;
                card.innerHTML = `
                    <div class="report-address">${r.address || ''}</div>
                    <div class="report-meta">${createdAt.toLocaleString()} | <span class="report-type">${getText(r.report_type) || r.report_type}</span></div>
                    <button class="btn" onclick="viewReport('${r.id || ''}')">${getText('view')}</button>
                    <button class="btn" onclick="downloadPdf('${r.id || ''}')">${getText('download_pdf')}</button>
                    <button class="btn" onclick="sendToClient('${r.id || ''}')">${getText('send_to_client')}</button>
                    <button class="btn" onclick="confirmDeleteReport('${r.id || ''}')">${getText('delete')}</button>
                    <button class="btn" onclick="confirmUpdateReport('${r.id || ''}')" ${canUpdate ? '' : 'disabled'}>${getText('update')} (1$)</button>
                `;
                list.appendChild(card);
            });
            list.style.display = '';
        }
        function goToMainMenu() {
            window.location.href = '/webapp';
        }
        function viewReport(id) {
            // Получаем отчёт по id из /api/user_reports (можно оптимизировать, если список уже есть)
            fetch('/api/user_reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.reports) {
                    const report = data.reports.find(r => r.id == id);
                    if (report && report.report_type === 'full') {
                        showFullReportModal(report.full_report);
                    } else {
                        alert('Детальный просмотр доступен только для полного отчёта.');
                    }
                }
            });
        }
        // Модалка для полного отчёта
        function showFullReportModal(report) {
            let oldModal = document.getElementById('full-report-modal');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'full-report-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;overflow:auto;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 18px 24px 18px;max-width:420px;width:96vw;text-align:left;max-height:90vh;overflow-y:auto;">
                    <div id="fullReportContent"></div>
                    <div style='display:flex;gap:10px;margin-top:18px;'>
                        <button class="btn" onclick="exportPdfFlow()">Скачать PDF</button>
                        <button class="btn" onclick="sendPdfToClientFlow()">Отправить клиенту</button>
                        <button class="btn back-btn" style="background:#f1f1f1;color:#333;" onclick="saveAndExitFullReport()">Сохранить и выйти</button>
                    </div>
                    <button class="btn back-btn" style="margin-top:18px;" onclick="closeFullReportModal()">Закрыть</button>
                </div>
            `;
            document.body.appendChild(modal);
            showFullReport(report, 'fullReportContent');
            window._currentFullReport = report; // для экспорта/отправки
        }
        function closeFullReportModal() {
            let modal = document.getElementById('full-report-modal');
            if (modal) modal.remove();
        }
        // Дублируем showFullReport с webapp_real_data.html (адаптировано для вставки в любой контейнер)
        function showFullReport(report, containerId) {
            let html = '';
            html += `<div style='font-size:22px;font-weight:800;color:#667eea;margin-bottom:10px;text-align:center;'>Полный отчет по объекту</div>`;
            html += `<div style='background:#f4f7ff;border-radius:12px;padding:16px 14px 10px 14px;margin-bottom:18px;box-shadow:0 2px 8px rgba(102,126,234,0.08);'>`;
            html += `<div style='font-size:16px;margin-bottom:6px;'><b>Адрес:</b> <span style='color:#333;'>${report.object.address}</span></div>`;
            html += `<div style='font-size:16px;margin-bottom:6px;'><b>Спален:</b> <span style='color:#333;'>${report.object.bedrooms}</span></div>`;
            html += `<div style='font-size:16px;margin-bottom:6px;'><b>Цена объекта:</b> <span style='color:#333;'>€${Number(report.object.purchase_price).toLocaleString('ru-RU')}</span></div>`;
            html += `<div style='font-size:16px;margin-bottom:0;'><b>Средняя цена за м²:</b> <span style='color:#333;'>€${Number(report.object.avg_price_per_sqm).toLocaleString('ru-RU')}</span></div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>Инвестиционный анализ (ROI)</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>Краткосрочная аренда: ROI ${report.roi.short_term.roi}%<br>Месячный доход: €${report.roi.short_term.monthly_income}, Чистый доход: €${report.roi.short_term.net_income}, 5 лет: €${report.roi.short_term.five_year_income}, Рост стоимости: €${report.roi.short_term.final_value.toLocaleString('ru-RU')}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>Долгосрочная аренда: ROI ${report.roi.long_term.roi}%<br>Годовой доход: €${report.roi.long_term.annual_income}, Чистый доход: €${report.roi.long_term.net_income}, 5 лет: €${report.roi.long_term.five_year_income}, Рост стоимости: €${report.roi.long_term.final_value.toLocaleString('ru-RU')}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>Без аренды (только рост стоимости): ROI ${report.roi.no_rent.roi}%<br>Итоговая стоимость: €${report.roi.no_rent.final_value.toLocaleString('ru-RU')}</div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>Сравнение с альтернативами (5 лет)</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:7px;'><tr><th style='text-align:left;'>Инструмент</th><th style='text-align:right;'>Доходность</th></tr>`;
            report.alternatives.forEach(alt => {
                html += `<tr><td>${alt.name}</td><td style='text-align:right;'>${(alt.yield*100).toFixed(1)}%</td></tr>`;
            });
            html += `</table></div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>Макроэкономика</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>Инфляция: ${report.macro.inflation}%<br>Курс EUR/TRY: ${report.macro.eur_try} (${(report.macro.eur_try_growth*100).toFixed(1)}% за год)<br>Ключевая ставка: ${report.macro.refi_rate}%<br>Рост ВВП: ${report.macro.gdp_growth}%</div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>Налоги и сборы</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>При покупке: налог на перевод ${report.taxes.transfer_tax*100}%<br>Гербовый сбор: ${report.taxes.stamp_duty*100}%<br>Нотариус: €${report.taxes.notary}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>Ежегодно: налог на имущество ${report.taxes.annual_property_tax*100}% - ${report.taxes.annual_property_tax_max*100}%<br>Подоходный налог с аренды: ${report.taxes.rental_income_tax}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>При продаже: налог на прирост: ${report.taxes.capital_gains_tax}</div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>Профессиональные метрики</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>Yield: ${(report.yield*100).toFixed(1)}%<br>Индекс цен: ${report.price_index}<br>Ипотечная ставка: ${(report.mortgage_rate*100).toFixed(1)}%<br>Глобальный индекс цен: ${report.global_house_price_index}</div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>Риски и развитие района</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>${report.risks.join('<br>')}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>${report.liquidity}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>${report.district}</div>`;
            html += `</div>`;
            html += `<div style='background:#f4f7ff;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);font-size:15px;color:#222;'>${report.summary}</div>`;
            document.getElementById(containerId).innerHTML = html;
        }
        // Экспорт в PDF: пошаговая логика
        function exportPdfFlow(reportId) {
            if (!reportId) {
                alert('Ошибка: не удалось получить id отчета для экспорта PDF!');
                return;
            }
            askAddUserContacts(reportId);
        }

        function askAddUserContacts(reportId) {
            showModalQuestion(
                'Добавить ваши контактные данные в PDF?',
                () => checkAndCollectUserContacts(reportId),
                () => askAddClientData(undefined, reportId)
            );
        }

        function askAddClientData(userProfile, reportId) {
            showModalQuestion(
                'Хотите добавить данные получателя (клиента)?',
                () => askClientName(userProfile, reportId),
                () => generatePdfRequest(userProfile, null, reportId)
            );
        }

        function askClientName(userProfile, reportId) {
            showModalInput('Имя получателя (клиента)', (clientName) => {
                generatePdfRequest(userProfile, clientName, reportId);
            });
        }

        function checkAndCollectUserContacts(reportId) {
            // Получаем профиль пользователя
            fetch('/api/user_profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const profile = data.profile;
                    const fields = [
                        { key: 'first_name', label: 'Имя' },
                        { key: 'last_name', label: 'Фамилия' },
                        { key: 'photo_url', label: 'Фото (ссылка)' },
                        { key: 'phone', label: 'Телефон' },
                        { key: 'email', label: 'Email' },
                        { key: 'website', label: 'Сайт' },
                        { key: 'company', label: 'Компания' },
                        { key: 'about_me', label: 'О себе' }
                    ];
                    collectMissingFields(profile, fields, 0, (filledProfile) => {
                        // После сбора всех данных спрашиваем про клиента
                        askAddClientData(filledProfile, reportId);
                    });
                } else {
                    alert('Ошибка загрузки профиля');
                }
            });
        }

        function collectMissingFields(profile, fields, idx, cb) {
            if (idx >= fields.length) {
                cb(profile);
                return;
            }
            const field = fields[idx];
            if (profile[field.key]) {
                collectMissingFields(profile, fields, idx + 1, cb);
            } else {
                showModalInput(field.label + ' (можно пропустить)', (val) => {
                    if (val) profile[field.key] = val;
                    // Сохраняем в базу
                    const update = {};
                    update[field.key] = val;
                    fetch('/api/user_profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegram_id: userData.id, ...update })
                    });
                    collectMissingFields(profile, fields, idx + 1, cb);
                }, true);
            }
        }

        // Универсальное модальное окно с вопросом (да/нет)
        function showModalQuestion(question, onYes, onNo) {
            let oldModal = document.getElementById('modal-question');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'modal-question';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:28px 18px 18px 18px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:18px;font-weight:700;color:#667eea;margin-bottom:16px;">${question}</div>
                    <button class="btn" style="width:100%;font-size:16px;" onclick="closeModalQuestion();window._modalYes()">Да</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeModalQuestion();window._modalNo()">Нет, пропустить</button>
                </div>
            `;
            document.body.appendChild(modal);
            window._modalYes = onYes;
            window._modalNo = onNo;
        }
        function closeModalQuestion() {
            let modal = document.getElementById('modal-question');
            if (modal) modal.remove();
        }
        // Универсальное модальное окно для ввода
        function showModalInput(label, onSubmit, allowSkip) {
            let oldModal = document.getElementById('modal-input');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'modal-input';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2100;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:28px 18px 18px 18px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:18px;font-weight:700;color:#667eea;margin-bottom:16px;">${label}</div>
                    <input id="modalInputField" class="input-field" style="margin-bottom:10px;width:90%;font-size:16px;padding:8px;" autofocus>
                    <button class="btn" style="width:100%;font-size:16px;" onclick="closeModalInput();window._modalInputSubmit()">${allowSkip ? 'Сохранить/Пропустить' : 'Сохранить'}</button>
                </div>
            `;
            document.body.appendChild(modal);
            window._modalInputSubmit = function() {
                const val = document.getElementById('modalInputField').value.trim();
                onSubmit(val);
            };
        }
        function closeModalInput() {
            let modal = document.getElementById('modal-input');
            if (modal) modal.remove();
        }
        // Генерация PDF (AJAX)
        function generatePdfRequest(profile, clientName, reportId) {
            if (!reportId) {
                alert('Ошибка: не удалось получить id отчета для генерации PDF!');
                return;
            }
            console.log('PDF GENERATE: reportId:', reportId, 'profile:', profile, 'clientName:', clientName, 'fullReport:', window._currentFullReport);
            fetch('/api/generate_pdf_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ report: window._currentFullReport, profile, client_name: clientName, report_id: reportId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.pdf_path) {
                    showPdfDownloadModal(data.pdf_path, data.message);
                } else {
                    alert('Ошибка генерации PDF: ' + (data.error || ''));
                    if (data.details) console.log('PDF ERROR DETAILS:', data.details);
                }
            });
        }
        // Модалка для скачивания PDF
        function showPdfDownloadModal(pdfPath, message) {
            let oldModal = document.getElementById('pdf-download-modal');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'pdf-download-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1200;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:28px 18px 18px 18px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:18px;font-weight:700;color:#667eea;margin-bottom:16px;">${message || 'PDF готов'}</div>
                    <a href="/api/download_pdf" onclick="event.preventDefault();window.open('${pdfPath}','_blank');window.location.href='/webapp_saved';" class="btn" style="width:100%;font-size:16px;">Скачать PDF</a>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closePdfDownloadModal()">Закрыть</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        function closePdfDownloadModal() {
            let modal = document.getElementById('pdf-download-modal');
            if (modal) modal.remove();
        }
        // Отправка клиенту
        function sendPdfToClientFlow(reportId) {
            if (!reportId) {
                alert('Ошибка: не удалось получить id отчета для отправки клиенту!');
                return;
            }
            generatePdfRequest(null, null, reportId);
            // После генерации показываем форму для клиента (можно доработать для реального UX)
            setTimeout(() => {
                showSendClientModal();
            }, 1000);
        }
        function showSendClientModal() {
            let oldModal = document.getElementById('send-client-modal');
            if (oldModal) oldModal.remove();
            const modal = document.createElement('div');
            modal.id = 'send-client-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1300;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:28px 18px 18px 18px;max-width:340px;width:90vw;text-align:center;">
                    <div style="font-size:18px;font-weight:700;color:#667eea;margin-bottom:16px;">Отправить клиенту</div>
                    <input id="clientNameInput" class="input-field" placeholder="Имя клиента" style="margin-bottom:10px;width:90%;">
                    <input id="clientTelegramInput" class="input-field" placeholder="Telegram клиента (username)" style="margin-bottom:10px;width:90%;">
                    <button class="btn" style="width:100%;font-size:16px;" onclick="sendPdfToClientConfirm()">Отправить</button>
                    <button class="btn btn-secondary" style="width:100%;margin-top:10px;font-size:16px;" onclick="closeSendClientModal()">Отмена</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        function closeSendClientModal() {
            let modal = document.getElementById('send-client-modal');
            if (modal) modal.remove();
        }
        function sendPdfToClientConfirm() {
            const clientName = document.getElementById('clientNameInput').value.trim();
            const clientTelegram = document.getElementById('clientTelegramInput').value.trim();
            if (!clientName || !clientTelegram) {
                alert('Заполните все поля');
                return;
            }
            // Здесь должен быть путь к PDF (можно хранить в window._lastPdfPath после генерации)
            const pdfPath = window._lastPdfPath || '';
            fetch('/api/send_pdf_to_client', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    realtor_telegram_id: userData.id,
                    client_name: clientName,
                    client_telegram: clientTelegram,
                    pdf_path: pdfPath
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('PDF отправлен клиенту и записан в историю!');
                    closeSendClientModal();
                } else {
                    alert('Ошибка отправки PDF');
                }
            });
        }
        // Удаление отчета
        function confirmDeleteReport(reportId) {
            if (confirm(getText('confirm_delete'))) {
                deleteReport(reportId);
            }
        }
        async function deleteReport(reportId) {
            if (!userData) return;
            const res = await fetch('/api/delete_user_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id, report_id: reportId })
            });
            const data = await res.json();
            if (data.success) {
                loadReports();
            } else {
                alert('Ошибка удаления');
            }
        }
        // Обновление отчета
        async function confirmUpdateReport(reportId) {
            if (confirm(getText('confirm_update'))) {
                const res = await fetch('/api/update_user_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id, report_id: reportId })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Отчет обновлен!');
                    loadReports();
                } else if (data.error === 'Insufficient balance') {
                    alert(`Недостаточно средств. Баланс: $${data.balance}`);
                } else {
                    alert('Ошибка обновления отчета');
                }
            }
        }
        // Сохраняет отчет если нет id, затем вызывает cb(reportId) — для отправки клиенту
        async function saveReportIfNeededAndExportPdf(report, cb) {
            if (report.id) {
                cb(report.id);
                return;
            }
            // Сохраняем отчет в базу
            const res = await fetch('/api/user_reports/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id, full_report: report.full_report, address: report.address, report_type: report.report_type })
            });
            const data = await res.json();
            if (data.success && data.report_id) {
                cb(data.report_id);
            } else {
                alert('Ошибка сохранения отчета (не получен id)');
            }
        }
        async function saveReportIfNeededAndSendToClient(report, cb) {
            if (report.id) {
                cb(report.id);
                return;
            }
            // Сохраняем отчет в базу
            const res = await fetch('/api/user_reports/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id, full_report: report.full_report, address: report.address, report_type: report.report_type })
            });
            const data = await res.json();
            if (data.success && data.report_id) {
                cb(data.report_id);
            } else {
                alert('Ошибка сохранения отчета (не получен id)');
            }
        }
        // Скачивание PDF
        async function downloadPdf(reportId) {
            // Получаем отчет по ID
            const res = await fetch('/api/user_reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            });
            const data = await res.json();
            if (data.success && data.reports) {
                const report = data.reports.find(r => r.id == reportId);
                if (report && report.full_report) {
                    window._currentFullReport = report.full_report;
                    saveReportIfNeededAndExportPdf(report, function(newReportId) {
                        exportPdfFlow(newReportId);
                    });
                } else {
                    alert('Полный отчет недоступен');
                }
            }
        }
        // Отправка клиенту
        async function sendToClient(reportId) {
            // Получаем отчет по ID
            const res = await fetch('/api/user_reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            });
            const data = await res.json();
            if (data.success && data.reports) {
                const report = data.reports.find(r => r.id == reportId);
                if (report && report.full_report) {
                    window._currentFullReport = report.full_report;
                    saveReportIfNeededAndSendToClient(report, function(newReportId) {
                        sendPdfToClientFlow(newReportId);
                    });
                } else {
                    alert('Полный отчет недоступен');
                }
            }
        }
        // Добавляем функцию saveAndExitFullReport
        async function saveAndExitFullReport() {
            if (!userData || !window._currentFullReport) return;
            // Сохраняем отчет в базу (если еще не сохранен)
            const res = await fetch('/api/user_reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id, full_report: window._currentFullReport })
            });
            // После сохранения возвращаем в главное меню
            window.location.href = '/webapp';
        }
        loadReports();
    </script>
</body>
</html> 