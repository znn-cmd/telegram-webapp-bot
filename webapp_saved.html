<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/i18n-manager.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - –ú–æ–∏ –æ—Ç—á–µ—Ç—ã</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 40px 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .logo {
            width: 110px;
            height: auto;
            display: block;
            margin: 0 auto 18px auto;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .logo:hover {
            transform: scale(1.05);
        }
        .title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 24px;
            text-align: center;
        }
        .report-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .report-card {
            background: #f8f9fa;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            padding: 18px 14px 14px 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102,126,234,0.15);
        }
        .report-card.deleting {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .report-address {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 2px;
        }
        .report-meta {
            font-size: 13px;
            color: #555;
        }
        .report-type {
            font-size: 13px;
            color: #764ba2;
            font-weight: 500;
        }
        .btn {
            margin-top: 10px;
            padding: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102,126,234,0.15);
        }
        .btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.25);
        }
        .back-btn {
            margin-top: 30px;
            background: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
        }
        .back-btn:hover {
            background: #e2e2e2;
        }
        .loading {
            text-align: center;
            color: #667eea;
            font-size: 16px;
            margin-top: 30px;
        }
        .empty {
            text-align: center;
            color: #888;
            font-size: 15px;
            margin-top: 40px;
        }
        .icon-btn-row {
            display: flex;
            flex-direction: row;
            gap: 12px;
            margin-top: 12px;
            justify-content: flex-start;
        }
        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102,126,234,0.08);
            position: relative;
        }
        .icon-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            box-shadow: 0 4px 16px rgba(102,126,234,0.18);
            transform: scale(1.05);
        }
        .icon-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .icon-btn .tooltip {
            visibility: hidden;
            width: max-content;
            background: #222;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 13px;
            pointer-events: none;
        }
        .icon-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-report {
            height: 120px;
            margin-bottom: 18px;
            border-radius: 14px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 300px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #28a745;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast.info {
            border-left-color: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 16px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .empty-state-description {
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        /* Undo snackbar */
        .snackbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .snackbar-undo {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Smooth transitions */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive improvements */
        @media (max-width: 480px) {
            .container {
                padding: 20px 15px;
            }
            
            .icon-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .report-card {
                padding: 16px 12px 12px 12px;
            }
        }

        /* Accessibility improvements */
        .icon-btn:focus,
        .btn:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="logo-flt.png" alt="Aaadviser" class="logo" onclick="goToMainMenu()">
        <div class="title" id="pageTitle" data-i18n="reports.title" data-i18n="reports.title" data-i18n="reports.my_reports" data-i18n="reports.my_reports">–ú–æ–∏ –æ—Ç—á–µ—Ç—ã</div>
        
        <!-- Skeleton loading -->
        <div id="skeletonLoading">
            <div class="skeleton skeleton-report"></div>
            <div class="skeleton skeleton-report"></div>
            <div class="skeleton skeleton-report"></div>
        </div>
        
        <div id="loading" class="loading" style="display:none;" data-i18n="common.loading" data-i18n="common.loading" data-i18n="common.loading" data-i18n="common.loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="reportList" class="report-list" style="display:none;"></div>
        
        <!-- Empty state -->
        <div id="empty" style="display:none;" class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <div class="empty-state-title">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤</div>
            <div class="empty-state-description" id="emptyText"></div>
            <button class="btn" onclick="goToMainMenu()">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –æ—Ç—á–µ—Ç</button>
        </div>
        
        <button class="btn back-btn" style="width:100%;" onclick="goToMainMenu()">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Snackbar for undo -->
    <div id="snackbar" class="snackbar" style="display:none;">
        <span id="snackbarMessage"></span>
        <button class="snackbar-undo" id="snackbarUndo">–û—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>

    <script>
        let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        if (tg) {
            tg.ready();
            tg.expand();
        }
        let userData = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
        if (!userData) {
            try {
                userData = JSON.parse(localStorage.getItem('aaadviser_user'));
            } catch (e) {
                userData = null;
            }
        }

        // Toast notification system
        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        // Snackbar for undo functionality
        let lastDeletedReport = null;
        let undoTimeout = null;

        function showSnackbar(message, undoCallback) {
            const snackbar = document.getElementById('snackbar');
            const messageEl = document.getElementById('snackbarMessage');
            const undoBtn = document.getElementById('snackbarUndo');
            
            messageEl.textContent = message;
            snackbar.style.display = 'flex';
            
            // Clear previous timeout
            if (undoTimeout) {
                clearTimeout(undoTimeout);
            }
            
            // Set new timeout
            undoTimeout = setTimeout(() => {
                snackbar.style.display = 'none';
                lastDeletedReport = null;
            }, 5000);
            
            // Set undo callback
            undoBtn.onclick = () => {
                if (undoCallback) {
                    undoCallback();
                }
                snackbar.style.display = 'none';
                if (undoTimeout) {
                    clearTimeout(undoTimeout);
                }
            };
        }

        // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
        const locales = {
            'ru': {
                'pageTitle': '–ú–æ–∏ –æ—Ç—á–µ—Ç—ã',
                'loading': '–ó–∞–≥—Ä—É–∑–∫–∞...',
                'empty': '–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤. –ù–∞—á–Ω–∏—Ç–µ —Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã.',
                'mainMenu': '–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é',
                'view': '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å',
                'full': '–ü–æ–ª–Ω—ã–π',
                'market_analysis': '–ë–∞–∑–æ–≤—ã–π',
                'download_pdf': '–°–∫–∞—á–∞—Ç—å PDF',
                'delete': '–£–¥–∞–ª–∏—Ç—å',
                'update': '–û–±–Ω–æ–≤–∏—Ç—å',
                'confirm_delete': '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç?',
                'confirm_update': '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç? –≠—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç 1$ –∏–∑ –≤–∞—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞.',
                'error': '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram WebApp. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.',
                'report_deleted': '–û—Ç—á–µ—Ç —É–¥–∞–ª–µ–Ω',
                'report_restored': '–û—Ç—á–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
                'error_deleting': '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞',
                'error_loading': '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–æ–≤',
                'success_download': 'PDF —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è...',
            },
            'en': {
                'pageTitle': 'My Reports',
                'loading': 'Loading...',
                'empty': 'You have no saved reports yet. Start by generating your first report and save it for future use.',
                'mainMenu': 'Main menu',
                'view': 'View',
                'full': 'Full',
                'market_analysis': 'Basic',
                'download_pdf': 'Download PDF',
                'delete': 'Delete',
                'update': 'Update',
                'confirm_delete': 'Are you sure you want to delete this report?',
                'confirm_update': 'Are you sure you want to update this report? This will require 1$ from your balance.',
                'error': 'Telegram WebApp initialization error. Please restart the app.',
                'report_deleted': 'Report deleted',
                'report_restored': 'Report restored',
                'error_deleting': 'Error deleting report',
                'error_loading': 'Error loading reports',
                'success_download': 'PDF downloading...',
            }
        };
        
        let currentLanguage = 'ru';
        if (userData && userData.language_code && locales[userData.language_code]) {
            currentLanguage = userData.language_code;
        }
        
        function getText(key) {
            return locales[currentLanguage][key] || key;
        }
        
        document.getElementById('pageTitle').textContent = getText('pageTitle');
        document.getElementById('loading').textContent = getText('loading');
        document.querySelector('.back-btn').textContent = getText('mainMenu');
        
        function showEmptyMessage() {
            document.getElementById('emptyText').textContent = getText('empty');
            document.getElementById('empty').style.display = '';
            document.getElementById('reportList').style.display = 'none';
            document.getElementById('skeletonLoading').style.display = 'none';
        }
        
        async function loadReports() {
            if (!userData) {
                document.getElementById('skeletonLoading').style.display = 'none';
                document.getElementById('emptyText').textContent = getText('error');
                document.getElementById('empty').style.display = '';
                return;
            }
            
            // Show skeleton loading
            document.getElementById('skeletonLoading').style.display = '';
            document.getElementById('reportList').style.display = 'none';
            document.getElementById('empty').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            
            try {
                const res = await fetch('/api/user_reports', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id })
                });
                
                const data = await res.json();
                
                // Hide skeleton
                document.getElementById('skeletonLoading').style.display = 'none';
                
                if (data.success && data.reports && data.reports.length > 0) {
                    renderReports(data.reports);
                    showToast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.reports.length} –æ—Ç—á–µ—Ç–æ–≤`, 'success');
                } else {
                    showEmptyMessage();
                }
            } catch (e) {
                document.getElementById('skeletonLoading').style.display = 'none';
                showEmptyMessage();
                showToast(getText('error_loading'), 'error');
            }
        }
        
        function renderReports(reports) {
            const list = document.getElementById('reportList');
            list.innerHTML = '';
            
            if (!reports || reports.length === 0) {
                showEmptyMessage();
                return;
            }
            
            document.getElementById('empty').style.display = 'none';
            
            reports.forEach((r, index) => {
                const card = document.createElement('div');
                card.className = 'report-card fade-in';
                card.style.animationDelay = `${index * 0.1}s`;
                
                const createdAt = new Date(r.created_at);
                const now = new Date();
                const daysAgo = Math.floor((now - createdAt) / (1000*60*60*24));
                const canUpdate = daysAgo > 30;
                
                card.innerHTML = `
                    <div class="report-address">${r.address || ''}</div>
                    <div class="report-meta">${createdAt.toLocaleString()} | <span class="report-type">${getText(r.report_type) || r.report_type}</span></div>
                    <div class="icon-btn-row">
                        <button class="icon-btn" onclick="viewReport('${r.id || ''}')" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å">
                            <span>üëÅÔ∏è<span class='tooltip'>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</span></span>
                        </button>
                        <button class="icon-btn" onclick="downloadPdf('${r.id || ''}')" title="–°–∫–∞—á–∞—Ç—å PDF">
                            <span>‚¨áÔ∏è<span class='tooltip'>–°–∫–∞—á–∞—Ç—å PDF</span></span>
                        </button>
                        <button class="icon-btn" onclick="confirmDeleteReport('${r.id || ''}')" title="–£–¥–∞–ª–∏—Ç—å">
                            <span>üóëÔ∏è<span class='tooltip' data-i18n="common.delete" data-i18n="common.delete" data-i18n="common.delete" data-i18n="common.delete">–£–¥–∞–ª–∏—Ç—å</span></span>
                        </button>
                        <button class="icon-btn" onclick="confirmUpdateReport('${r.id || ''}')" ${canUpdate ? '' : 'disabled'} title="–û–±–Ω–æ–≤–∏—Ç—å (1$)">
                            <span>‚ôªÔ∏è<span class='tooltip'>–û–±–Ω–æ–≤–∏—Ç—å (1$)</span></span>
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
            
            list.style.display = '';
        }
        
        function goToMainMenu() {
            window.location.href = '/webapp';
        }
        
        function viewReport(id) {
            showToast('–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞...', 'info');
            
            fetch('/api/user_reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.reports) {
                    const report = data.reports.find(r => r.id == id);
                    if (report && report.report_type === 'full') {
                        showFullReportModal(report.full_report);
                        showToast('–û—Ç—á–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                    } else {
                        showToast('–î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞', 'warning');
                    }
                }
            })
            .catch(() => {
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞', 'error');
            });
        }

        // –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞
        function showFullReportModal(report) {
            let oldModal = document.getElementById('full-report-modal');
            if (oldModal) oldModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'full-report-modal';
            modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:1000;display:flex;align-items:center;justify-content:center;overflow:auto;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:18px;box-shadow:0 4px 24px rgba(102,126,234,0.18);padding:32px 18px 24px 18px;max-width:420px;width:96vw;text-align:left;max-height:90vh;overflow-y:auto;">
                    <div id="fullReportContent"></div>
                    <div style='display:flex;gap:10px;margin-top:18px;'>
                        <button class="btn" onclick="exportPdfFlow()">–°–∫–∞—á–∞—Ç—å PDF</button>
                        <button class="btn back-btn" style="background:#f1f1f1;color:#333;" onclick="saveAndExitFullReport()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–π—Ç–∏</button>
                    </div>
                    <button class="btn back-btn" style="margin-top:18px;" onclick="closeFullReportModal()" data-i18n="common.close" data-i18n="common.close" data-i18n="common.close" data-i18n="common.close">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(modal);
            showFullReport(report, 'fullReportContent');
            window._currentFullReport = report; // –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞/–æ—Ç–ø—Ä–∞–≤–∫–∏
        }
        
        function closeFullReportModal() {
            let modal = document.getElementById('full-report-modal');
            if (modal) modal.remove();
        }

        // –î—É–±–ª–∏—Ä—É–µ–º showFullReport —Å webapp_real_data.html (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ –ª—é–±–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
        function showFullReport(report, containerId) {
            let html = '';
            html += `<div style='font-size:22px;font-weight:800;color:#667eea;margin-bottom:10px;text-align:center;'>–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É</div>`;
            html += `<div style='background:#f4f7ff;border-radius:12px;padding:16px 14px 10px 14px;margin-bottom:18px;box-shadow:0 2px 8px rgba(102,126,234,0.08);'>`;
            html += `<div style='font-size:16px;margin-bottom:6px;'><b>–ê–¥—Ä–µ—Å:</b> <span style='color:#333;'>${report.object.address}</span></div>`;
            html += `<div style='font-size:16px;margin-bottom:6px;'><b>–°–ø–∞–ª–µ–Ω:</b> <span style='color:#333;'>${report.object.bedrooms}</span></div>`;
            html += `<div style='font-size:16px;margin-bottom:6px;'><b>–¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞:</b> <span style='color:#333;'>‚Ç¨${Number(report.object.purchase_price).toLocaleString('ru-RU')}</span></div>`;
            html += `<div style='font-size:16px;margin-bottom:0;'><b>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤:</b> <span style='color:#333;'>‚Ç¨${Number(report.object.avg_price_per_sqm).toLocaleString('ru-RU')}</span></div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (ROI)</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞: ROI ${report.roi.short_term.roi}%<br>–ú–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥: ‚Ç¨${report.roi.short_term.monthly_income}, –ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥: ‚Ç¨${report.roi.short_term.net_income}, 5 –ª–µ—Ç: ‚Ç¨${report.roi.short_term.five_year_income}, –†–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏: ‚Ç¨${report.roi.short_term.final_value.toLocaleString('ru-RU')}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞: ROI ${report.roi.long_term.roi}%<br>–ì–æ–¥–æ–≤–æ–π –¥–æ—Ö–æ–¥: ‚Ç¨${report.roi.long_term.annual_income}, –ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥: ‚Ç¨${report.roi.long_term.net_income}, 5 –ª–µ—Ç: ‚Ç¨${report.roi.long_term.five_year_income}, –†–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏: ‚Ç¨${report.roi.long_term.final_value.toLocaleString('ru-RU')}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>–ë–µ–∑ –∞—Ä–µ–Ω–¥—ã (—Ç–æ–ª—å–∫–æ —Ä–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏): ROI ${report.roi.no_rent.roi}%<br>–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ‚Ç¨${report.roi.no_rent.final_value.toLocaleString('ru-RU')}</div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞–º–∏ (5 –ª–µ—Ç)</div>`;
            html += `<table style='width:100%;font-size:14px;margin-bottom:7px;'><tr><th style='text-align:left;'>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th><th style='text-align:right;'>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</th></tr>`;
            report.alternatives.forEach(alt => {
                html += `<tr><td>${alt.name}</td><td style='text-align:right;'>${(alt.yield*100).toFixed(1)}%</td></tr>`;
            });
            html += `</table></div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>–ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>–ò–Ω—Ñ–ª—è—Ü–∏—è: ${report.macro.inflation}%<br>–ö—É—Ä—Å EUR/TRY: ${report.macro.eur_try} (${(report.macro.eur_try_growth*100).toFixed(1)}% –∑–∞ –≥–æ–¥)<br>–ö–ª—é—á–µ–≤–∞—è —Å—Ç–∞–≤–∫–∞: ${report.macro.refi_rate}%<br>–†–æ—Å—Ç –í–í–ü: ${report.macro.gdp_growth}%</div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>–ù–∞–ª–æ–≥–∏ –∏ —Å–±–æ—Ä—ã</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>–ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ: –Ω–∞–ª–æ–≥ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥ ${report.taxes.transfer_tax*100}%<br>–ì–µ—Ä–±–æ–≤—ã–π —Å–±–æ—Ä: ${report.taxes.stamp_duty*100}%<br>–ù–æ—Ç–∞—Ä–∏—É—Å: ‚Ç¨${report.taxes.notary}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>–ï–∂–µ–≥–æ–¥–Ω–æ: –Ω–∞–ª–æ–≥ –Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ ${report.taxes.annual_property_tax*100}% - ${report.taxes.annual_property_tax_max*100}%<br>–ü–æ–¥–æ—Ö–æ–¥–Ω—ã–π –Ω–∞–ª–æ–≥ —Å –∞—Ä–µ–Ω–¥—ã: ${report.taxes.rental_income_tax}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>–ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ: –Ω–∞–ª–æ–≥ –Ω–∞ –ø—Ä–∏—Ä–æ—Å—Ç: ${report.taxes.capital_gains_tax}</div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>Yield: ${(report.yield*100).toFixed(1)}%<br>–ò–Ω–¥–µ–∫—Å —Ü–µ–Ω: ${report.price_index}<br>–ò–ø–æ—Ç–µ—á–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${(report.mortgage_rate*100).toFixed(1)}%<br>–ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Ü–µ–Ω: ${report.global_house_price_index}</div>`;
            html += `</div>`;
            html += `<div style='background:#f8f9fa;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);'>`;
            html += `<div style='font-size:17px;font-weight:700;color:#667eea;margin-bottom:8px;'>–†–∏—Å–∫–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ä–∞–π–æ–Ω–∞</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>${report.risks.join('<br>')}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>${report.liquidity}</div>`;
            html += `<div style='font-size:15px;color:#222;margin-bottom:7px;'>${report.district}</div>`;
            html += `</div>`;
            html += `<div style='background:#f4f7ff;border-radius:12px;padding:14px 12px 10px 12px;margin-bottom:14px;box-shadow:0 2px 8px rgba(102,126,234,0.06);font-size:15px;color:#222;'>${report.summary}</div>`;
            document.getElementById(containerId).innerHTML = html;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF: –ø–æ—à–∞–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
        async function downloadPdf(id) {
            showToast('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF –≤ Telegram...', 'info');
            try {
                const res = await fetch('/api/send_saved_report_pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ report_id: id, telegram_id: userData.id })
                });
                const data = await res.json();
                if (data.success && data.telegram_send_status === 'sent') {
                    showToast('–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!', 'success');
                } else {
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á–µ—Ç–∞: ' + (data.message || data.error), 'error');
                }
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            }
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å undo
        function confirmDeleteReport(id) {
            if (confirm(getText('confirm_delete'))) {
                deleteReportWithUndo(id);
            }
        }

        function deleteReportWithUndo(id) {
            // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –æ—Ç—á–µ—Ç–∞
            const reportCard = document.querySelector(`[onclick*="confirmDeleteReport('${id}')"]`).closest('.report-card');
            if (reportCard) {
                reportCard.classList.add('deleting');
            }

            fetch('/api/delete_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    telegram_id: userData.id, 
                    report_id: id 
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è undo
                    lastDeletedReport = {
                        id: id,
                        card: reportCard,
                        data: data.report_data
                    };
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º snackbar —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω—ã
                    showSnackbar(getText('report_deleted'), () => {
                        restoreReport(id);
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç—á–µ—Ç–æ–≤
                    loadReports();
                } else {
                    showToast(getText('error_deleting'), 'error');
                    if (reportCard) {
                        reportCard.classList.remove('deleting');
                    }
                }
            })
            .catch(() => {
                showToast(getText('error_deleting'), 'error');
                if (reportCard) {
                    reportCard.classList.remove('deleting');
                }
            });
        }

        function restoreReport(id) {
            if (!lastDeletedReport || lastDeletedReport.id !== id) {
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç', 'error');
                return;
            }

            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞
            // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            showToast(getText('report_restored'), 'success');
            loadReports();
            lastDeletedReport = null;
        }

        function confirmUpdateReport(id) {
            if (confirm(getText('confirm_update'))) {
                updateReport(id);
            }
        }

        async function updateReport(id) {
            try {
                const res = await fetch('/api/update_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        telegram_id: userData.id, 
                        report_id: id 
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showToast('–û—Ç—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                    loadReports();
                } else if (data.error === 'Insufficient balance') {
                    showToast(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: $${data.balance}`, 'warning');
                } else {
                    showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞', 'error');
                }
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤
        function saveMarketAnalysisReport(reportData, cb) {
            fetch('/api/save_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    telegram_id: userData.id,
                    report_type: 'market_analysis',
                    address: reportData.address,
                    report_data: reportData
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.report_id) {
                    showToast('–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    cb(data.report_id);
                } else {
                    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ (–Ω–µ –ø–æ–ª—É—á–µ–Ω id)', 'error');
                }
            })
            .catch(() => {
                showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞', 'error');
            });
        }

        function saveFullReport(reportData, cb) {
            fetch('/api/save_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    telegram_id: userData.id,
                    report_type: 'full',
                    address: reportData.object.address,
                    report_data: reportData,
                    full_report: reportData
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.report_id) {
                    showToast('–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    cb(data.report_id);
                } else {
                    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ (–Ω–µ –ø–æ–ª—É—á–µ–Ω id)', 'error');
                }
            })
            .catch(() => {
                showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞', 'error');
            });
        }

                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('DOMContentLoaded', loadReports);
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é saveAndExitFullReport
        async function saveAndExitFullReport() {
            if (!userData || !window._currentFullReport) return;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –≤ –±–∞–∑—É (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω)
            const res = await fetch('/api/user_reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id, full_report: window._currentFullReport })
            });
            // –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            window.location.href = '/webapp';
        }
    </script>
</body>
</html> 