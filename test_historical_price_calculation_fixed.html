<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-description {
            margin-bottom: 15px;
            color: #666;
            line-height: 1.5;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result-area {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .trends-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        .trends-table th {
            background: #28a745;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
        }
        .trends-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }
        .trends-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .current-month-row {
            background-color: #e8f4fd !important;
            font-weight: 500;
        }
        .forecast-row {
            background-color: #f0f8ff !important;
        }
        .historical-row {
            background-color: #f8f9fa !important;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω</h1>
        
        <div class="info-box">
            <strong>–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong>
            <ul>
                <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è <code>calculateHistoricalPrice()</code> –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω</li>
                <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è <code>prepareTrendsWithHistoricalPrices()</code> –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö</li>
                <li>‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è <code>filterTrendsByDateRange()</code> - —É–±—Ä–∞–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º</li>
                <li>‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è <code>generateTrendsTable()</code> –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ü–µ–Ω</li>
                <li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã CSS —Å—Ç–∏–ª–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã</li>
                <li>‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ü–µ–Ω</li>
            </ul>
        </div>
        
        <div class="test-section">
            <div class="test-title">1. –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </div>
            <button class="test-button" onclick="testBasicCalculation()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="basicResult" class="result-area" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">2. –¢–µ—Å—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤ —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Ü–µ–Ω–∞–º–∏
            </div>
            <button class="test-button" onclick="testTrendsPreparation()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="preparationResult" class="result-area" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">3. –¢–µ—Å—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã</div>
            <div class="test-description">
                –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Ü–µ–Ω–∞–º–∏
            </div>
            <button class="test-button" onclick="testTableDisplay()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="tableResult" class="result-area" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç</div>
            <div class="test-description">
                –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            </div>
            <button class="test-button" onclick="runIntegrationTest()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <div id="integrationResult" class="result-area" style="display: none;"></div>
        </div>
    </div>

    <script>
        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥–æ–≤ (–∏–º–∏—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞)
        const testTrends = [
            {
                id: 1,
                property_year: 2025,
                property_month: 9,
                date: '2025-09-01',
                unit_price_for_sale: 38041.00,
                unit_price_for_rent: 245.40,
                price_change_sale: 1.14,
                price_change_rent: 2.98,
                yield: 7.74
            },
            {
                id: 2,
                property_year: 2025,
                property_month: 8,
                date: '2025-08-01',
                unit_price_for_sale: 37613.00,
                unit_price_for_rent: 238.29,
                price_change_sale: 1.66,
                price_change_rent: 2.64,
                yield: 7.60
            },
            {
                id: 3,
                property_year: 2025,
                property_month: 7,
                date: '2025-07-01',
                unit_price_for_sale: 37000.00,
                unit_price_for_rent: 232.16,
                price_change_sale: 1.36,
                price_change_rent: 1.99,
                yield: 7.53
            },
            {
                id: 4,
                property_year: 2025,
                property_month: 6,
                date: '2025-06-01',
                unit_price_for_sale: 36505.00,
                unit_price_for_rent: 227.62,
                price_change_sale: 2.14,
                price_change_rent: 2.44,
                yield: 7.48
            },
            {
                id: 5,
                property_year: 2025,
                property_month: 5,
                date: '2025-05-01',
                unit_price_for_sale: 35740.00,
                unit_price_for_rent: 222.20,
                price_change_sale: 2.30,
                price_change_rent: 1.40,
                yield: 7.46
            },
            {
                id: 6,
                property_year: 2025,
                property_month: 4,
                date: '2025-04-01',
                unit_price_for_sale: 34937.00,
                unit_price_for_rent: 219.14,
                price_change_sale: 3.35,
                price_change_rent: 1.77,
                yield: 7.53
            },
            {
                id: 7,
                property_year: 2025,
                property_month: 3,
                date: '2025-03-01',
                unit_price_for_sale: 33806.00,
                unit_price_for_rent: 215.33,
                price_change_sale: 3.22,
                price_change_rent: 0.98,
                yield: 7.64
            },
            {
                id: 8,
                property_year: 2025,
                property_month: 2,
                date: '2025-02-01',
                unit_price_for_sale: 32752.00,
                unit_price_for_rent: 213.23,
                price_change_sale: 3.95,
                price_change_rent: 2.23,
                yield: 7.81
            }
        ];

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞)
        function calculateHistoricalPrice(basePrice, percentageChange) {
            if (!basePrice || !percentageChange) return basePrice;
            
            const changeMultiplier = 1 + (percentageChange / 100);
            return Math.round(basePrice / changeMultiplier);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Ü–µ–Ω–∞–º–∏ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞)
        function prepareTrendsWithHistoricalPrices(trends) {
            if (!trends || trends.length === 0) return [];
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—Ä–µ–Ω–¥—ã –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
            const sortedTrends = trends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return b.property_year - a.property_year;
                }
                return b.property_month - a.property_month;
            });
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            // –°–æ–∑–¥–∞–µ–º –∫—ç—à –¥–ª—è —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
            const priceCache = new Map();
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–µ–Ω–¥—ã –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
            for (let i = 0; i < sortedTrends.length; i++) {
                const trend = sortedTrends[i];
                const year = trend.property_year;
                const month = trend.property_month;
                const cacheKey = `${year}-${month}`;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ—Å—è—Ü–∞
                const isCurrentMonth = year === currentYear && month === currentMonth;
                const isFutureMonth = year > currentYear || (year === currentYear && month > currentMonth);
                const isHistoricalMonth = year < currentYear || (year === currentYear && month < currentMonth);
                
                if (isCurrentMonth || isFutureMonth) {
                    // –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏ –±—É–¥—É—â–∏—Ö –º–µ—Å—è—Ü–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã
                    priceCache.set(cacheKey, {
                        salePrice: parseFloat(trend.unit_price_for_sale) || 0,
                        rentPrice: parseFloat(trend.unit_price_for_rent) || 0,
                        isCalculated: false
                    });
                } else if (isHistoricalMonth) {
                    // –î–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—è—Ü–µ–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã
                    let calculatedSalePrice = parseFloat(trend.unit_price_for_sale) || 0;
                    let calculatedRentPrice = parseFloat(trend.unit_price_for_rent) || 0;
                    
                    // –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
                    let nextMonthKey = null;
                    if (month === 12) {
                        nextMonthKey = `${year + 1}-1`;
                    } else {
                        nextMonthKey = `${year}-${month + 1}`;
                    }
                    
                    const nextMonthData = priceCache.get(nextMonthKey);
                    if (nextMonthData && trend.price_change_sale && trend.price_change_rent) {
                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
                        calculatedSalePrice = calculateHistoricalPrice(
                            nextMonthData.salePrice, 
                            trend.price_change_sale
                        );
                        calculatedRentPrice = calculateHistoricalPrice(
                            nextMonthData.rentPrice, 
                            trend.price_change_rent
                        );
                        
                        console.log(`üî¢ –†–∞—Å—á–µ—Ç —Ü–µ–Ω –¥–ª—è ${year}-${month}: –ø—Ä–æ–¥–∞–∂–∞ ${calculatedSalePrice} ‚Ç∫/–º¬≤, –∞—Ä–µ–Ω–¥–∞ ${calculatedRentPrice} ‚Ç∫/–º¬≤`);
                    }
                    
                    priceCache.set(cacheKey, {
                        salePrice: calculatedSalePrice,
                        rentPrice: calculatedRentPrice,
                        isCalculated: true
                    });
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–Ω–¥—ã —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
            const updatedTrends = sortedTrends.map(trend => {
                const year = trend.property_year;
                const month = trend.property_month;
                const cacheKey = `${year}-${month}`;
                const cachedData = priceCache.get(cacheKey);
                
                if (cachedData) {
                    return {
                        ...trend,
                        calculated_sale_price: cachedData.salePrice,
                        calculated_rent_price: cachedData.rentPrice,
                        is_price_calculated: cachedData.isCalculated
                    };
                }
                
                return trend;
            });
            
            console.log('üìä –¢—Ä–µ–Ω–¥—ã —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Ü–µ–Ω–∞–º–∏:', updatedTrends.length, '–∑–∞–ø–∏—Å–µ–π');
            return updatedTrends;
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–¥–æ–≤ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞)
        function filterTrendsByDateRange(trends) {
            if (!trends || trends.length === 0) return [];
            
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            console.log(`üîç Filtering trends: current date = ${currentYear}-${currentMonth}`);
            console.log(`üîç Total trends = ${trends.length}`);
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—Ä–µ–Ω–¥—ã –ø–æ property_year –∏ property_month (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
            const sortedTrends = trends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return b.property_year - a.property_year;
                }
                return b.property_month - a.property_month;
            });
            
            // –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï —Ç—Ä–µ–Ω–¥—ã –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –º–µ—Å—è—Ü–∞–º
            console.log(`üîç Showing ALL trends without month restrictions`);
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:
            // 1. –ë—É–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
            // 2. –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
            // 3. –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –º–µ—Å—è—Ü—ã (—Å—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞)
            const sortedForDisplay = sortedTrends.sort((a, b) => {
                const yearA = a.property_year;
                const monthA = a.property_month;
                const yearB = b.property_year;
                const monthB = b.property_month;
                
                // –ï—Å–ª–∏ –æ–±–∞ –º–µ—Å—è—Ü–∞ –≤ –±—É–¥—É—â–µ–º (–±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ)
                if (yearA > currentYear || (yearA === currentYear && monthA > currentMonth)) {
                    if (yearB > currentYear || (yearB === currentYear && monthB > currentMonth)) {
                        // –û–±–∞ –±—É–¥—É—â–∏–µ - —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é (—Å–µ–Ω—Ç—è–±—Ä—å –ø–µ—Ä–µ–¥ –æ–∫—Ç—è–±—Ä–µ–º)
                        if (yearA !== yearB) return yearA - yearB;
                        return monthA - monthB;
                    } else {
                        return -1; // A –≤ –±—É–¥—É—â–µ–º, B –Ω–µ—Ç
                    }
                }
                // –ï—Å–ª–∏ –æ–±–∞ –º–µ—Å—è—Ü–∞ –≤ –ø—Ä–æ—à–ª–æ–º (–º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ)
                else if (yearA < currentYear || (yearA === currentYear && monthA < currentMonth)) {
                    if (yearB < currentYear || (yearB === currentYear && monthB < currentMonth)) {
                        // –û–±–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ - —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é (–∏—é–ª—å –ø–µ—Ä–µ–¥ –∏—é–Ω–µ–º)
                        if (yearA !== yearB) return yearB - yearA;
                        return monthB - monthA;
                    } else {
                        return 1; // A –≤ –ø—Ä–æ—à–ª–æ–º, B –Ω–µ—Ç
                    }
                }
                // –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –º–µ—Å—è—Ü–µ–≤ - —Ç–µ–∫—É—â–∏–π
                else if (yearA === currentYear && monthA === currentMonth) {
                    if (yearB === currentYear && monthB === currentMonth) {
                        return 0; // –û–±–∞ —Ç–µ–∫—É—â–∏–µ
                    } else {
                        return -1; // A —Ç–µ–∫—É—â–∏–π, B –Ω–µ—Ç
                    }
                } else if (yearB === currentYear && monthB === currentMonth) {
                    return 1; // B —Ç–µ–∫—É—â–∏–π, A –Ω–µ—Ç
                }
                
                return 0;
            });
            
            console.log(`‚úÖ Returning all ${sortedForDisplay.length} trends without restrictions`);
            return sortedForDisplay;
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
        function formatTrendValue(value, type) {
            if (value === null || value === undefined) return '-';
            
            if (type && type.includes('price')) {
                return formatValue(value, 'price');
            } else if (type && type.includes('percentage')) {
                return formatValue(value, 'percentage');
            } else if (typeof value === 'number') {
                if (value >= 1000) {
                    return value.toLocaleString('ru-RU');
                } else {
                    return value.toFixed(2);
                }
            } else {
                return value.toString();
            }
        }

        function formatValue(value, type) {
            if (value === null || value === undefined) return '-';
            
            if (type === 'price') {
                if (typeof value === 'number') {
                    return `‚Ç∫${value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
                return value.toString();
            } else if (type === 'percentage') {
                if (typeof value === 'number') {
                    return `${value.toFixed(2)}%`;
                }
                return value.toString();
            }
            
            return value.toString();
        }

        function formatPercentage(value) {
            if (value === null || value === undefined) return '-';
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return '-';
            const sign = numValue >= 0 ? '+' : '';
            return `${sign}${(numValue * 100).toFixed(2)}%`;
        }

        function formatTrendDateShort(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                const monthNames = [
                    '—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω',
                    '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'
                ];
                
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                return `${month}. ${year}`;
            } catch (e) {
                return dateStr;
            }
        }

        // –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞
        function testBasicCalculation() {
            const result = document.getElementById('basicResult');
            result.style.display = 'block';
            
            let output = 'üßÆ –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω\n';
            output += '=' .repeat(50) + '\n\n';
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å—á–µ—Ç –¥–ª—è –∏—é–ª—è 2025
            const augustPrice = 37613.00; // –¶–µ–Ω–∞ –∞–≤–≥—É—Å—Ç–∞
            const julyChange = 1.66; // –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—é–ª—è
            
            const calculatedJulyPrice = calculateHistoricalPrice(augustPrice, julyChange);
            const expectedJulyPrice = 37000.00; // –û–∂–∏–¥–∞–µ–º–∞—è —Ü–µ–Ω–∞ –∏—é–ª—è
            
            output += `üìä –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –∏—é–ª—è 2025:\n`;
            output += `   –¶–µ–Ω–∞ –∞–≤–≥—É—Å—Ç–∞: ${augustPrice.toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
            output += `   –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—é–ª—è: +${julyChange}%\n`;
            output += `   –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –∏—é–ª—è: ${calculatedJulyPrice.toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
            output += `   –û–∂–∏–¥–∞–µ–º–∞—è —Ü–µ–Ω–∞ –∏—é–ª—è: ${expectedJulyPrice.toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
            output += `   –†–∞–∑–Ω–∏—Ü–∞: ${Math.abs(calculatedJulyPrice - expectedJulyPrice).toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
            output += `   –°—Ç–∞—Ç—É—Å: ${Math.abs(calculatedJulyPrice - expectedJulyPrice) < 100 ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ü–†–û–í–ê–õ–ï–ù'}\n\n`;
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å—á–µ—Ç –¥–ª—è –∏—é–Ω—è 2025
            const julyPrice = calculatedJulyPrice; // –¶–µ–Ω–∞ –∏—é–ª—è (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è)
            const juneChange = 1.36; // –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—é–Ω—è
            
            const calculatedJunePrice = calculateHistoricalPrice(julyPrice, juneChange);
            const expectedJunePrice = 36505.00; // –û–∂–∏–¥–∞–µ–º–∞—è —Ü–µ–Ω–∞ –∏—é–Ω—è
            
            output += `üìä –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –∏—é–Ω—è 2025:\n`;
            output += `   –¶–µ–Ω–∞ –∏—é–ª—è: ${julyPrice.toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
            output += `   –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—é–Ω—è: +${juneChange}%\n`;
            output += `   –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –∏—é–Ω—è: ${calculatedJunePrice.toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
            output += `   –û–∂–∏–¥–∞–µ–º–∞—è —Ü–µ–Ω–∞ –∏—é–Ω—è: ${expectedJunePrice.toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
            output += `   –†–∞–∑–Ω–∏—Ü–∞: ${Math.abs(calculatedJunePrice - expectedJunePrice).toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
            output += `   –°—Ç–∞—Ç—É—Å: ${Math.abs(calculatedJunePrice - expectedJunePrice) < 100 ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ü–†–û–í–ê–õ–ï–ù'}\n\n`;
            
            result.textContent = output;
        }

        // –¢–µ—Å—Ç 2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤
        function testTrendsPreparation() {
            const result = document.getElementById('preparationResult');
            result.style.display = 'block';
            
            let output = 'üî¢ –¢–µ—Å—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤ —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º–∏ —Ü–µ–Ω–∞–º–∏\n';
            output += '=' .repeat(50) + '\n\n';
            
            const trendsWithHistoricalPrices = prepareTrendsWithHistoricalPrices(testTrends);
            
            output += `üìä –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ —Ç—Ä–µ–Ω–¥–æ–≤: ${trendsWithHistoricalPrices.length}\n\n`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Ç—Ä–µ–Ω–¥—É
            trendsWithHistoricalPrices.forEach((trend, index) => {
                const monthNames = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫'];
                const monthName = monthNames[trend.property_month - 1];
                
                output += `${index + 1}. ${monthName}. ${trend.property_year}:\n`;
                output += `   –ü—Ä–æ–¥–∞–∂–∞: ${formatTrendValue(trend.calculated_sale_price || trend.unit_price_for_sale, 'price')}`;
                if (trend.is_price_calculated) {
                    output += ` (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ)`;
                }
                output += `\n`;
                
                output += `   –ê—Ä–µ–Ω–¥–∞: ${formatTrendValue(trend.calculated_rent_price || trend.unit_price_for_rent, 'price')}`;
                if (trend.is_price_calculated) {
                    output += ` (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ)`;
                }
                output += `\n`;
                
                output += `   –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏: ${formatPercentage(trend.price_change_sale)}\n`;
                output += `   –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã: ${formatPercentage(trend.price_change_rent)}\n`;
                output += `   –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: ${formatTrendValue(trend.yield, 'percentage')}\n\n`;
            });
            
            result.textContent = output;
        }

        // –¢–µ—Å—Ç 3: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function testTableDisplay() {
            const result = document.getElementById('tableResult');
            result.style.display = 'block';
            
            let output = 'üìã –¢–µ—Å—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏\n';
            output += '=' .repeat(50) + '\n\n';
            
            const trendsWithHistoricalPrices = prepareTrendsWithHistoricalPrices(testTrends);
            const filteredTrends = filterTrendsByDateRange(trendsWithHistoricalPrices);
            
            output += `üìä –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —Ç—Ä–µ–Ω–¥–æ–≤: ${filteredTrends.length}\n\n`;
            
            // –°–æ–∑–¥–∞–µ–º HTML —Ç–∞–±–ª–∏—Ü—É
            let tableHtml = '<table class="trends-table">';
            tableHtml += '<thead><tr>';
            tableHtml += '<th>–î–∞—Ç–∞</th>';
            tableHtml += '<th>–ü—Ä–æ–¥–∞–∂–∞<br>(‚Ç∫/–º¬≤)</th>';
            tableHtml += '<th>–ò–∑–º-–∏–µ —Ü–µ–Ω—ã<br>–ø—Ä–æ–¥–∞–∂–∏</th>';
            tableHtml += '<th>–ê—Ä–µ–Ω–¥–∞<br>(‚Ç∫/–º¬≤)</th>';
            tableHtml += '<th>–ò–∑–º-–∏–µ —Ü–µ–Ω—ã<br>–∞—Ä–µ–Ω–¥—ã</th>';
            tableHtml += '<th>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</th>';
            tableHtml += '</tr></thead><tbody>';
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            filteredTrends.forEach((trend, index) => {
                const isCurrentMonth = trend.property_year === currentYear && trend.property_month === currentMonth;
                const isFutureMonth = trend.property_year > currentYear || (trend.property_year === currentYear && trend.property_month > currentMonth);
                const isHistoricalMonth = trend.property_year < currentYear || (trend.property_year === currentYear && trend.property_month < currentMonth);
                
                let rowClass = '';
                let rowStyle = '';
                
                if (isCurrentMonth) {
                    rowClass = 'current-month-row';
                    rowStyle = 'background-color: #e8f4fd;';
                } else if (isFutureMonth) {
                    rowClass = 'forecast-row';
                    rowStyle = 'background-color: #f0f8ff;';
                } else if (isHistoricalMonth) {
                    rowClass = 'historical-row';
                    rowStyle = 'background-color: #fff3cd;';
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—è—Ü–µ–≤
                const salePrice = trend.is_price_calculated ? trend.calculated_sale_price : trend.unit_price_for_sale;
                const rentPrice = trend.is_price_calculated ? trend.calculated_rent_price : trend.unit_price_for_rent;
                
                tableHtml += `<tr class="${rowClass}" style="${rowStyle}">`;
                tableHtml += `<td>${formatTrendDateShort(trend.date)}</td>`;
                tableHtml += `<td>${formatTrendValue(salePrice, 'price')}</td>`;
                tableHtml += `<td>${formatPercentage(trend.price_change_sale)}</td>`;
                tableHtml += `<td>${formatTrendValue(rentPrice, 'price')}</td>`;
                tableHtml += `<td>${formatPercentage(trend.price_change_rent)}</td>`;
                tableHtml += `<td>${formatTrendValue(trend.yield, 'percentage')}</td>`;
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            
            output += `üé® –¢–∞–±–ª–∏—Ü–∞ —Å —Ü–≤–µ—Ç–æ–≤–æ–π —Å—Ö–µ–º–æ–π:\n`;
            output += `   üîµ –°–∏–Ω–∏–π - —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü\n`;
            output += `   üü° –ñ–µ–ª—Ç—ã–π - –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –º–µ—Å—è—Ü—ã\n`;
            output += `   ‚ö™ –°–≤–µ—Ç–ª–æ-—Å–∏–Ω–∏–π - –±—É–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã\n\n`;
            
            output += `üìã HTML —Ç–∞–±–ª–∏—Ü—ã:\n`;
            output += tableHtml;
            
            result.innerHTML = output;
        }

        // –¢–µ—Å—Ç 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç
        function runIntegrationTest() {
            const result = document.getElementById('integrationResult');
            result.style.display = 'block';
            
            let output = 'üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã\n';
            output += '=' .repeat(50) + '\n\n';
            
            try {
                // –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                output += `üìä –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤...\n`;
                const trendsWithHistoricalPrices = prepareTrendsWithHistoricalPrices(testTrends);
                output += `‚úÖ –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ ${trendsWithHistoricalPrices.length} —Ç—Ä–µ–Ω–¥–æ–≤\n\n`;
                
                // –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                output += `üîç –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç—Ä–µ–Ω–¥–æ–≤...\n`;
                const filteredTrends = filterTrendsByDateRange(trendsWithHistoricalPrices);
                output += `‚úÖ –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${filteredTrends.length} —Ç—Ä–µ–Ω–¥–æ–≤\n\n`;
                
                // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ü–µ–Ω
                output += `üî¢ –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω...\n`;
                let calculatedCount = 0;
                let originalCount = 0;
                
                filteredTrends.forEach(trend => {
                    if (trend.is_price_calculated) {
                        calculatedCount++;
                        output += `   ${formatTrendDateShort(trend.date)}: –ø—Ä–æ–¥–∞–∂–∞ ${formatTrendValue(trend.calculated_sale_price, 'price')}, –∞—Ä–µ–Ω–¥–∞ ${formatTrendValue(trend.calculated_rent_price, 'price')} (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ)\n`;
                    } else {
                        originalCount++;
                        output += `   ${formatTrendDateShort(trend.date)}: –ø—Ä–æ–¥–∞–∂–∞ ${formatTrendValue(trend.unit_price_for_sale, 'price')}, –∞—Ä–µ–Ω–¥–∞ ${formatTrendValue(trend.unit_price_for_rent, 'price')} (–æ—Ä–∏–≥–∏–Ω–∞–ª)\n`;
                    }
                });
                
                output += `\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n`;
                output += `   –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ü–µ–Ω: ${calculatedCount}\n`;
                output += `   –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω: ${originalCount}\n`;
                output += `   –í—Å–µ–≥–æ —Ç—Ä–µ–Ω–¥–æ–≤: ${filteredTrends.length}\n\n`;
                
                // –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏
                output += `üßÆ –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–æ–≤...\n`;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–Ω—ã –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω—ã
                let logicErrors = 0;
                for (let i = 0; i < filteredTrends.length - 1; i++) {
                    const current = filteredTrends[i];
                    const next = filteredTrends[i + 1];
                    
                    if (current.is_price_calculated && next.is_price_calculated) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
                        const expectedCurrentPrice = calculateHistoricalPrice(
                            next.calculated_sale_price, 
                            current.price_change_sale
                        );
                        
                        const difference = Math.abs(current.calculated_sale_price - expectedCurrentPrice);
                        if (difference > 100) {
                            logicErrors++;
                            output += `   ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏ –¥–ª—è ${formatTrendDateShort(current.date)}: —Ä–∞–∑–Ω–∏—Ü–∞ ${difference.toLocaleString('ru-RU')} ‚Ç∫/–º¬≤\n`;
                        }
                    }
                }
                
                if (logicErrors === 0) {
                    output += `‚úÖ –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞\n`;
                } else {
                    output += `‚ùå –ù–∞–π–¥–µ–Ω–æ ${logicErrors} –æ—à–∏–±–æ–∫ –ª–æ–≥–∏–∫–∏\n`;
                }
                
                output += `\nüéØ –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞: ${logicErrors === 0 ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ü–†–û–í–ê–õ–ï–ù'}\n`;
                
            } catch (error) {
                output += `‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞: ${error.message}\n`;
                console.error('Integration test error:', error);
            }
            
            result.textContent = output;
        }
    </script>
</body>
</html>
