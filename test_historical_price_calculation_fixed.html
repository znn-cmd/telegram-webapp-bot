<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест исправленной логики расчета исторических цен</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .test-description {
            margin-bottom: 15px;
            color: #666;
            line-height: 1.5;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .result-area {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .trends-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        .trends-table th {
            background: #28a745;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
        }
        .trends-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
        }
        .trends-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .current-month-row {
            background-color: #e8f4fd !important;
            font-weight: 500;
        }
        .forecast-row {
            background-color: #f0f8ff !important;
        }
        .historical-row {
            background-color: #f8f9fa !important;
        }
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Тест исправленной логики расчета исторических цен</h1>
        
        <div class="info-box">
            <strong>Что исправлено:</strong>
            <ul>
                <li>✅ Добавлена функция <code>calculateHistoricalPrice()</code> для расчета исторических цен</li>
                <li>✅ Добавлена функция <code>prepareTrendsWithHistoricalPrices()</code> для подготовки данных</li>
                <li>✅ Обновлена функция <code>filterTrendsByDateRange()</code> - убраны ограничения по месяцам</li>
                <li>✅ Обновлена функция <code>generateTrendsTable()</code> для использования рассчитанных цен</li>
                <li>✅ Добавлены CSS стили для исторических строк таблицы</li>
                <li>✅ Обновлены функции анализа и графиков для использования рассчитанных цен</li>
            </ul>
        </div>
        
        <div class="test-section">
            <div class="test-title">1. Тест базовой логики расчета</div>
            <div class="test-description">
                Проверяем функцию расчета исторических цен на основе процентов изменения
            </div>
            <button class="test-button" onclick="testBasicCalculation()">Запустить тест</button>
            <div id="basicResult" class="result-area" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">2. Тест подготовки данных трендов</div>
            <div class="test-description">
                Проверяем функцию подготовки трендов с рассчитанными историческими ценами
            </div>
            <button class="test-button" onclick="testTrendsPreparation()">Запустить тест</button>
            <div id="preparationResult" class="result-area" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">3. Тест отображения таблицы</div>
            <div class="test-description">
                Проверяем отображение таблицы с рассчитанными историческими ценами
            </div>
            <button class="test-button" onclick="testTableDisplay()">Запустить тест</button>
            <div id="tableResult" class="result-area" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">4. Интеграционный тест</div>
            <div class="test-description">
                Полный тест всей системы с реальными данными
            </div>
            <button class="test-button" onclick="runIntegrationTest()">Запустить тест</button>
            <div id="integrationResult" class="result-area" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Тестовые данные трендов (имитация данных из скриншота)
        const testTrends = [
            {
                id: 1,
                property_year: 2025,
                property_month: 9,
                date: '2025-09-01',
                unit_price_for_sale: 38041.00,
                unit_price_for_rent: 245.40,
                price_change_sale: 1.14,
                price_change_rent: 2.98,
                yield: 7.74
            },
            {
                id: 2,
                property_year: 2025,
                property_month: 8,
                date: '2025-08-01',
                unit_price_for_sale: 37613.00,
                unit_price_for_rent: 238.29,
                price_change_sale: 1.66,
                price_change_rent: 2.64,
                yield: 7.60
            },
            {
                id: 3,
                property_year: 2025,
                property_month: 7,
                date: '2025-07-01',
                unit_price_for_sale: 37000.00,
                unit_price_for_rent: 232.16,
                price_change_sale: 1.36,
                price_change_rent: 1.99,
                yield: 7.53
            },
            {
                id: 4,
                property_year: 2025,
                property_month: 6,
                date: '2025-06-01',
                unit_price_for_sale: 36505.00,
                unit_price_for_rent: 227.62,
                price_change_sale: 2.14,
                price_change_rent: 2.44,
                yield: 7.48
            },
            {
                id: 5,
                property_year: 2025,
                property_month: 5,
                date: '2025-05-01',
                unit_price_for_sale: 35740.00,
                unit_price_for_rent: 222.20,
                price_change_sale: 2.30,
                price_change_rent: 1.40,
                yield: 7.46
            },
            {
                id: 6,
                property_year: 2025,
                property_month: 4,
                date: '2025-04-01',
                unit_price_for_sale: 34937.00,
                unit_price_for_rent: 219.14,
                price_change_sale: 3.35,
                price_change_rent: 1.77,
                yield: 7.53
            },
            {
                id: 7,
                property_year: 2025,
                property_month: 3,
                date: '2025-03-01',
                unit_price_for_sale: 33806.00,
                unit_price_for_rent: 215.33,
                price_change_sale: 3.22,
                price_change_rent: 0.98,
                yield: 7.64
            },
            {
                id: 8,
                property_year: 2025,
                property_month: 2,
                date: '2025-02-01',
                unit_price_for_sale: 32752.00,
                unit_price_for_rent: 213.23,
                price_change_sale: 3.95,
                price_change_rent: 2.23,
                yield: 7.81
            }
        ];

        // Функция расчета исторических цен (скопирована из основного файла)
        function calculateHistoricalPrice(basePrice, percentageChange) {
            if (!basePrice || !percentageChange) return basePrice;
            
            const changeMultiplier = 1 + (percentageChange / 100);
            return Math.round(basePrice / changeMultiplier);
        }

        // Функция подготовки трендов с историческими ценами (скопирована из основного файла)
        function prepareTrendsWithHistoricalPrices(trends) {
            if (!trends || trends.length === 0) return [];
            
            // Сортируем тренды по дате (новые сначала)
            const sortedTrends = trends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return b.property_year - a.property_year;
                }
                return b.property_month - a.property_month;
            });
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            // Создаем кэш для рассчитанных цен
            const priceCache = new Map();
            
            // Обрабатываем тренды в обратном порядке (от новых к старым)
            for (let i = 0; i < sortedTrends.length; i++) {
                const trend = sortedTrends[i];
                const year = trend.property_year;
                const month = trend.property_month;
                const cacheKey = `${year}-${month}`;
                
                // Определяем тип месяца
                const isCurrentMonth = year === currentYear && month === currentMonth;
                const isFutureMonth = year > currentYear || (year === currentYear && month > currentMonth);
                const isHistoricalMonth = year < currentYear || (year === currentYear && month < currentMonth);
                
                if (isCurrentMonth || isFutureMonth) {
                    // Для текущего и будущих месяцев используем оригинальные цены
                    priceCache.set(cacheKey, {
                        salePrice: parseFloat(trend.unit_price_for_sale) || 0,
                        rentPrice: parseFloat(trend.unit_price_for_rent) || 0,
                        isCalculated: false
                    });
                } else if (isHistoricalMonth) {
                    // Для исторических месяцев рассчитываем цены
                    let calculatedSalePrice = parseFloat(trend.unit_price_for_sale) || 0;
                    let calculatedRentPrice = parseFloat(trend.unit_price_for_rent) || 0;
                    
                    // Ищем следующий месяц для расчета
                    let nextMonthKey = null;
                    if (month === 12) {
                        nextMonthKey = `${year + 1}-1`;
                    } else {
                        nextMonthKey = `${year}-${month + 1}`;
                    }
                    
                    const nextMonthData = priceCache.get(nextMonthKey);
                    if (nextMonthData && trend.price_change_sale && trend.price_change_rent) {
                        // Рассчитываем цены на основе следующего месяца
                        calculatedSalePrice = calculateHistoricalPrice(
                            nextMonthData.salePrice, 
                            trend.price_change_sale
                        );
                        calculatedRentPrice = calculateHistoricalPrice(
                            nextMonthData.rentPrice, 
                            trend.price_change_rent
                        );
                        
                        console.log(`🔢 Расчет цен для ${year}-${month}: продажа ${calculatedSalePrice} ₺/м², аренда ${calculatedRentPrice} ₺/м²`);
                    }
                    
                    priceCache.set(cacheKey, {
                        salePrice: calculatedSalePrice,
                        rentPrice: calculatedRentPrice,
                        isCalculated: true
                    });
                }
            }
            
            // Обновляем тренды с рассчитанными ценами
            const updatedTrends = sortedTrends.map(trend => {
                const year = trend.property_year;
                const month = trend.property_month;
                const cacheKey = `${year}-${month}`;
                const cachedData = priceCache.get(cacheKey);
                
                if (cachedData) {
                    return {
                        ...trend,
                        calculated_sale_price: cachedData.salePrice,
                        calculated_rent_price: cachedData.rentPrice,
                        is_price_calculated: cachedData.isCalculated
                    };
                }
                
                return trend;
            });
            
            console.log('📊 Тренды с рассчитанными историческими ценами:', updatedTrends.length, 'записей');
            return updatedTrends;
        }

        // Функция фильтрации трендов (скопирована из основного файла)
        function filterTrendsByDateRange(trends) {
            if (!trends || trends.length === 0) return [];
            
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            console.log(`🔍 Filtering trends: current date = ${currentYear}-${currentMonth}`);
            console.log(`🔍 Total trends = ${trends.length}`);
            
            // Сортируем тренды по property_year и property_month (новые сначала)
            const sortedTrends = trends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return b.property_year - a.property_year;
                }
                return b.property_month - a.property_month;
            });
            
            // Теперь показываем ВСЕ тренды без ограничений по месяцам
            console.log(`🔍 Showing ALL trends without month restrictions`);
            
            // Сортируем по дате для правильного отображения:
            // 1. Будущие месяцы (новые сначала)
            // 2. Текущий месяц
            // 3. Исторические месяцы (старые сначала)
            const sortedForDisplay = sortedTrends.sort((a, b) => {
                const yearA = a.property_year;
                const monthA = a.property_month;
                const yearB = b.property_year;
                const monthB = b.property_month;
                
                // Если оба месяца в будущем (больше текущего)
                if (yearA > currentYear || (yearA === currentYear && monthA > currentMonth)) {
                    if (yearB > currentYear || (yearB === currentYear && monthB > currentMonth)) {
                        // Оба будущие - сортируем по возрастанию (сентябрь перед октябрем)
                        if (yearA !== yearB) return yearA - yearB;
                        return monthA - monthB;
                    } else {
                        return -1; // A в будущем, B нет
                    }
                }
                // Если оба месяца в прошлом (меньше текущего)
                else if (yearA < currentYear || (yearA === currentYear && monthA < currentMonth)) {
                    if (yearB < currentYear || (yearB === currentYear && monthB < currentMonth)) {
                        // Оба исторические - сортируем по убыванию (июль перед июнем)
                        if (yearA !== yearB) return yearB - yearA;
                        return monthB - monthA;
                    } else {
                        return 1; // A в прошлом, B нет
                    }
                }
                // Если один из месяцев - текущий
                else if (yearA === currentYear && monthA === currentMonth) {
                    if (yearB === currentYear && monthB === currentMonth) {
                        return 0; // Оба текущие
                    } else {
                        return -1; // A текущий, B нет
                    }
                } else if (yearB === currentYear && monthB === currentMonth) {
                    return 1; // B текущий, A нет
                }
                
                return 0;
            });
            
            console.log(`✅ Returning all ${sortedForDisplay.length} trends without restrictions`);
            return sortedForDisplay;
        }

        // Функция форматирования значений
        function formatTrendValue(value, type) {
            if (value === null || value === undefined) return '-';
            
            if (type && type.includes('price')) {
                return formatValue(value, 'price');
            } else if (type && type.includes('percentage')) {
                return formatValue(value, 'percentage');
            } else if (typeof value === 'number') {
                if (value >= 1000) {
                    return value.toLocaleString('ru-RU');
                } else {
                    return value.toFixed(2);
                }
            } else {
                return value.toString();
            }
        }

        function formatValue(value, type) {
            if (value === null || value === undefined) return '-';
            
            if (type === 'price') {
                if (typeof value === 'number') {
                    return `₺${value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
                return value.toString();
            } else if (type === 'percentage') {
                if (typeof value === 'number') {
                    return `${value.toFixed(2)}%`;
                }
                return value.toString();
            }
            
            return value.toString();
        }

        function formatPercentage(value) {
            if (value === null || value === undefined) return '-';
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return '-';
            const sign = numValue >= 0 ? '+' : '';
            return `${sign}${(numValue * 100).toFixed(2)}%`;
        }

        function formatTrendDateShort(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                const monthNames = [
                    'янв', 'фев', 'мар', 'апр', 'май', 'июн',
                    'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'
                ];
                
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                return `${month}. ${year}`;
            } catch (e) {
                return dateStr;
            }
        }

        // Тест 1: Базовая логика расчета
        function testBasicCalculation() {
            const result = document.getElementById('basicResult');
            result.style.display = 'block';
            
            let output = '🧮 Тест базовой логики расчета исторических цен\n';
            output += '=' .repeat(50) + '\n\n';
            
            // Тестируем расчет для июля 2025
            const augustPrice = 37613.00; // Цена августа
            const julyChange = 1.66; // Процент изменения июля
            
            const calculatedJulyPrice = calculateHistoricalPrice(augustPrice, julyChange);
            const expectedJulyPrice = 37000.00; // Ожидаемая цена июля
            
            output += `📊 Расчет цены июля 2025:\n`;
            output += `   Цена августа: ${augustPrice.toLocaleString('ru-RU')} ₺/м²\n`;
            output += `   Процент изменения июля: +${julyChange}%\n`;
            output += `   Рассчитанная цена июля: ${calculatedJulyPrice.toLocaleString('ru-RU')} ₺/м²\n`;
            output += `   Ожидаемая цена июля: ${expectedJulyPrice.toLocaleString('ru-RU')} ₺/м²\n`;
            output += `   Разница: ${Math.abs(calculatedJulyPrice - expectedJulyPrice).toLocaleString('ru-RU')} ₺/м²\n`;
            output += `   Статус: ${Math.abs(calculatedJulyPrice - expectedJulyPrice) < 100 ? '✅ ПРОЙДЕН' : '❌ ПРОВАЛЕН'}\n\n`;
            
            // Тестируем расчет для июня 2025
            const julyPrice = calculatedJulyPrice; // Цена июля (рассчитанная)
            const juneChange = 1.36; // Процент изменения июня
            
            const calculatedJunePrice = calculateHistoricalPrice(julyPrice, juneChange);
            const expectedJunePrice = 36505.00; // Ожидаемая цена июня
            
            output += `📊 Расчет цены июня 2025:\n`;
            output += `   Цена июля: ${julyPrice.toLocaleString('ru-RU')} ₺/м²\n`;
            output += `   Процент изменения июня: +${juneChange}%\n`;
            output += `   Рассчитанная цена июня: ${calculatedJunePrice.toLocaleString('ru-RU')} ₺/м²\n`;
            output += `   Ожидаемая цена июня: ${expectedJunePrice.toLocaleString('ru-RU')} ₺/м²\n`;
            output += `   Разница: ${Math.abs(calculatedJunePrice - expectedJunePrice).toLocaleString('ru-RU')} ₺/м²\n`;
            output += `   Статус: ${Math.abs(calculatedJunePrice - expectedJunePrice) < 100 ? '✅ ПРОЙДЕН' : '❌ ПРОВАЛЕН'}\n\n`;
            
            result.textContent = output;
        }

        // Тест 2: Подготовка данных трендов
        function testTrendsPreparation() {
            const result = document.getElementById('preparationResult');
            result.style.display = 'block';
            
            let output = '🔢 Тест подготовки трендов с историческими ценами\n';
            output += '=' .repeat(50) + '\n\n';
            
            const trendsWithHistoricalPrices = prepareTrendsWithHistoricalPrices(testTrends);
            
            output += `📊 Подготовлено трендов: ${trendsWithHistoricalPrices.length}\n\n`;
            
            // Показываем детали по каждому тренду
            trendsWithHistoricalPrices.forEach((trend, index) => {
                const monthNames = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
                const monthName = monthNames[trend.property_month - 1];
                
                output += `${index + 1}. ${monthName}. ${trend.property_year}:\n`;
                output += `   Продажа: ${formatTrendValue(trend.calculated_sale_price || trend.unit_price_for_sale, 'price')}`;
                if (trend.is_price_calculated) {
                    output += ` (рассчитано)`;
                }
                output += `\n`;
                
                output += `   Аренда: ${formatTrendValue(trend.calculated_rent_price || trend.unit_price_for_rent, 'price')}`;
                if (trend.is_price_calculated) {
                    output += ` (рассчитано)`;
                }
                output += `\n`;
                
                output += `   Изменение продажи: ${formatPercentage(trend.price_change_sale)}\n`;
                output += `   Изменение аренды: ${formatPercentage(trend.price_change_rent)}\n`;
                output += `   Доходность: ${formatTrendValue(trend.yield, 'percentage')}\n\n`;
            });
            
            result.textContent = output;
        }

        // Тест 3: Отображение таблицы
        function testTableDisplay() {
            const result = document.getElementById('tableResult');
            result.style.display = 'block';
            
            let output = '📋 Тест отображения таблицы с рассчитанными ценами\n';
            output += '=' .repeat(50) + '\n\n';
            
            const trendsWithHistoricalPrices = prepareTrendsWithHistoricalPrices(testTrends);
            const filteredTrends = filterTrendsByDateRange(trendsWithHistoricalPrices);
            
            output += `📊 Отфильтровано трендов: ${filteredTrends.length}\n\n`;
            
            // Создаем HTML таблицу
            let tableHtml = '<table class="trends-table">';
            tableHtml += '<thead><tr>';
            tableHtml += '<th>Дата</th>';
            tableHtml += '<th>Продажа<br>(₺/м²)</th>';
            tableHtml += '<th>Изм-ие цены<br>продажи</th>';
            tableHtml += '<th>Аренда<br>(₺/м²)</th>';
            tableHtml += '<th>Изм-ие цены<br>аренды</th>';
            tableHtml += '<th>Доходность</th>';
            tableHtml += '</tr></thead><tbody>';
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            filteredTrends.forEach((trend, index) => {
                const isCurrentMonth = trend.property_year === currentYear && trend.property_month === currentMonth;
                const isFutureMonth = trend.property_year > currentYear || (trend.property_year === currentYear && trend.property_month > currentMonth);
                const isHistoricalMonth = trend.property_year < currentYear || (trend.property_year === currentYear && trend.property_month < currentMonth);
                
                let rowClass = '';
                let rowStyle = '';
                
                if (isCurrentMonth) {
                    rowClass = 'current-month-row';
                    rowStyle = 'background-color: #e8f4fd;';
                } else if (isFutureMonth) {
                    rowClass = 'forecast-row';
                    rowStyle = 'background-color: #f0f8ff;';
                } else if (isHistoricalMonth) {
                    rowClass = 'historical-row';
                    rowStyle = 'background-color: #fff3cd;';
                }
                
                // Используем рассчитанные цены для исторических месяцев
                const salePrice = trend.is_price_calculated ? trend.calculated_sale_price : trend.unit_price_for_sale;
                const rentPrice = trend.is_price_calculated ? trend.calculated_rent_price : trend.unit_price_for_rent;
                
                tableHtml += `<tr class="${rowClass}" style="${rowStyle}">`;
                tableHtml += `<td>${formatTrendDateShort(trend.date)}</td>`;
                tableHtml += `<td>${formatTrendValue(salePrice, 'price')}</td>`;
                tableHtml += `<td>${formatPercentage(trend.price_change_sale)}</td>`;
                tableHtml += `<td>${formatTrendValue(rentPrice, 'price')}</td>`;
                tableHtml += `<td>${formatPercentage(trend.price_change_rent)}</td>`;
                tableHtml += `<td>${formatTrendValue(trend.yield, 'percentage')}</td>`;
                tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            
            output += `🎨 Таблица с цветовой схемой:\n`;
            output += `   🔵 Синий - текущий месяц\n`;
            output += `   🟡 Желтый - исторические месяцы\n`;
            output += `   ⚪ Светло-синий - будущие месяцы\n\n`;
            
            output += `📋 HTML таблицы:\n`;
            output += tableHtml;
            
            result.innerHTML = output;
        }

        // Тест 4: Интеграционный тест
        function runIntegrationTest() {
            const result = document.getElementById('integrationResult');
            result.style.display = 'block';
            
            let output = '🔗 Интеграционный тест всей системы\n';
            output += '=' .repeat(50) + '\n\n';
            
            try {
                // Шаг 1: Подготовка данных
                output += `📊 Шаг 1: Подготовка данных трендов...\n`;
                const trendsWithHistoricalPrices = prepareTrendsWithHistoricalPrices(testTrends);
                output += `✅ Подготовлено ${trendsWithHistoricalPrices.length} трендов\n\n`;
                
                // Шаг 2: Фильтрация
                output += `🔍 Шаг 2: Фильтрация трендов...\n`;
                const filteredTrends = filterTrendsByDateRange(trendsWithHistoricalPrices);
                output += `✅ Отфильтровано ${filteredTrends.length} трендов\n\n`;
                
                // Шаг 3: Проверка рассчитанных цен
                output += `🔢 Шаг 3: Проверка рассчитанных исторических цен...\n`;
                let calculatedCount = 0;
                let originalCount = 0;
                
                filteredTrends.forEach(trend => {
                    if (trend.is_price_calculated) {
                        calculatedCount++;
                        output += `   ${formatTrendDateShort(trend.date)}: продажа ${formatTrendValue(trend.calculated_sale_price, 'price')}, аренда ${formatTrendValue(trend.calculated_rent_price, 'price')} (рассчитано)\n`;
                    } else {
                        originalCount++;
                        output += `   ${formatTrendDateShort(trend.date)}: продажа ${formatTrendValue(trend.unit_price_for_sale, 'price')}, аренда ${formatTrendValue(trend.unit_price_for_rent, 'price')} (оригинал)\n`;
                    }
                });
                
                output += `\n📊 Статистика:\n`;
                output += `   Рассчитанных цен: ${calculatedCount}\n`;
                output += `   Оригинальных цен: ${originalCount}\n`;
                output += `   Всего трендов: ${filteredTrends.length}\n\n`;
                
                // Шаг 4: Проверка логики
                output += `🧮 Шаг 4: Проверка логики расчетов...\n`;
                
                // Проверяем, что цены логически связаны
                let logicErrors = 0;
                for (let i = 0; i < filteredTrends.length - 1; i++) {
                    const current = filteredTrends[i];
                    const next = filteredTrends[i + 1];
                    
                    if (current.is_price_calculated && next.is_price_calculated) {
                        // Проверяем связь между рассчитанными ценами
                        const expectedCurrentPrice = calculateHistoricalPrice(
                            next.calculated_sale_price, 
                            current.price_change_sale
                        );
                        
                        const difference = Math.abs(current.calculated_sale_price - expectedCurrentPrice);
                        if (difference > 100) {
                            logicErrors++;
                            output += `   ⚠️ Ошибка логики для ${formatTrendDateShort(current.date)}: разница ${difference.toLocaleString('ru-RU')} ₺/м²\n`;
                        }
                    }
                }
                
                if (logicErrors === 0) {
                    output += `✅ Логика расчетов корректна\n`;
                } else {
                    output += `❌ Найдено ${logicErrors} ошибок логики\n`;
                }
                
                output += `\n🎯 Результат интеграционного теста: ${logicErrors === 0 ? '✅ ПРОЙДЕН' : '❌ ПРОВАЛЕН'}\n`;
                
            } catch (error) {
                output += `❌ Ошибка выполнения теста: ${error.message}\n`;
                console.error('Integration test error:', error);
            }
            
            result.textContent = output;
        }
    </script>
</body>
</html>
