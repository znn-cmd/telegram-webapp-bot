# Руководство по решению проблем с SSL Timeout

## Описание проблемы

Ошибка `_ssl.c:999: The handshake operation timed out` возникает при проблемах с SSL соединением к Supabase.

## Причины возникновения

1. **Сетевые проблемы** - медленное интернет-соединение
2. **Проблемы с прокси** - корпоративные настройки сети
3. **SSL сертификаты** - проблемы с проверкой сертификатов
4. **Таймауты** - слишком короткие таймауты для медленных соединений

## Внесенные исправления

### 1. Улучшенная обработка SSL соединений

- Добавлены настройки SSL контекста
- Отключены предупреждения о небезопасных SSL соединениях
- Добавлена retry логика для SSL ошибок

### 2. Retry механизм

- Автоматические повторные попытки при SSL ошибках
- Экспоненциальная задержка между попытками
- Максимум 3 попытки для каждого запроса

### 3. Настройки таймаутов

```bash
# В .env файле
SUPABASE_TIMEOUT=30          # Таймаут соединения в секундах
SUPABASE_MAX_RETRIES=3       # Максимум попыток
SUPABASE_RETRY_DELAY=2       # Начальная задержка между попытками
```

### 4. Новые эндпоинты мониторинга

- `/health` - общее состояние приложения
- `/health/supabase` - состояние соединения с Supabase

## Дополнительные решения

### 1. Проверка сетевого соединения

```bash
# Проверка доступности Supabase
curl -v https://your-project.supabase.co

# Проверка SSL соединения
openssl s_client -connect your-project.supabase.co:443
```

### 2. Настройка прокси (если необходимо)

```bash
# В .env файле
HTTP_PROXY=http://proxy.company.com:8080
HTTPS_PROXY=http://proxy.company.com:8080
NO_PROXY=localhost,127.0.0.1
```

### 3. Обновление SSL библиотек

```bash
# Обновление Python SSL
pip install --upgrade pyOpenSSL
pip install --upgrade cryptography

# Проверка версии OpenSSL
python -c "import ssl; print(ssl.OPENSSL_VERSION)"
```

### 4. Альтернативные настройки SSL

```python
# В app.py можно добавить дополнительные настройки
import ssl

# Создание SSL контекста с дополнительными настройками
ssl_context = ssl.create_default_context()
ssl_context.check_hostname = False
ssl_context.verify_mode = ssl.CERT_NONE
ssl_context.set_ciphers('DEFAULT@SECLEVEL=1')

# Настройка для urllib3
import urllib3
urllib3.disable_warnings()
```

## Мониторинг и диагностика

### 1. Логи приложения

Следите за логами для выявления паттернов ошибок:
- SSL handshake timeout
- Connection reset
- Network unreachable

### 2. Метрики соединений

Используйте эндпоинт `/health/supabase` для мониторинга:
```bash
curl http://localhost:5000/health/supabase
```

### 3. Алерты

Настройте алерты при:
- Более 3 SSL ошибок подряд
- Время ответа > 30 секунд
- Статус соединения = unhealthy

## Профилактические меры

1. **Регулярные проверки** - мониторинг состояния соединения
2. **Логирование** - детальное логирование всех сетевых операций
3. **Graceful degradation** - fallback механизмы при сбоях
4. **Кэширование** - кэширование часто запрашиваемых данных

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи приложения
2. Используйте эндпоинты мониторинга
3. Проверьте сетевые настройки
4. Обратитесь к системному администратору
