<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - Аналитика региона</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .logo {
            width: 110px;
            height: auto;
            display: block;
            margin: 0 auto 8px;
            cursor: pointer;
        }

        .slogan {
            font-size: 15px;
            color: #888;
            font-style: italic;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin: 20px 0 10px 0;
            padding: 0 20px;
        }

        .page-description {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin: 0 0 30px 0;
            padding: 0 20px;
            line-height: 1.5;
        }

        .location-section {
            padding: 0 20px 20px 20px;
        }

        .location-group {
            margin-bottom: 20px;
        }

        .location-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .location-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .location-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .location-select:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .confirm-button {
            width: 100%;
            padding: 14px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 20px;
        }

        .confirm-button:hover:not(:disabled) {
            background: #5a6fd8;
        }

        .confirm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .back-button {
            display: block;
            width: 100%;
            padding: 14px 20px;
            background: #28a745;
            color: white;
            text-decoration: none;
            text-align: center;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }

        .back-button:hover {
            background: #218838;
        }

        .selected-location {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }

        .selected-location.show {
            display: block;
        }

        .selected-location-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .selected-location-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .admin-ids {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .admin-ids-title {
            font-size: 16px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 10px;
        }

        .admin-ids-text {
            font-size: 14px;
            color: #856404;
            font-family: monospace;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            color: #721c24;
            text-align: center;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Logo -->
        <div class="header">
            <img src="logo-flt.png" alt="Aaadviser Logo" class="logo" onclick="goToMainMenu()" />
            <div class="slogan" id="slogan">Инсайты рынка недвижимости</div>
        </div>

        <!-- Page Title -->
        <div class="page-title" id="pageTitle">Аналитика региона</div>

        <!-- Page Description -->
        <div class="page-description" id="pageDescription">
            Получите детальный анализ рынка недвижимости в выбранном регионе с прогнозами цен
        </div>

        <!-- Location Selection Section -->
        <div class="location-section">
            <!-- Country Selection -->
            <div class="location-group">
                <label class="location-label" id="countryLabel">Страна:</label>
                <select class="location-select" id="countrySelect" onchange="onCountryChange()">
                    <option value="" id="countryPlaceholder">Выберите страну</option>
                </select>
            </div>

            <!-- City Selection -->
            <div class="location-group">
                <label class="location-label" id="cityLabel">Город:</label>
                <select class="location-select" id="citySelect" onchange="onCityChange()" disabled>
                    <option value="" id="cityPlaceholder">Сначала выберите страну</option>
                </select>
            </div>

            <!-- County Selection -->
            <div class="location-group">
                <label class="location-label" id="countyLabel">Область/Регион:</label>
                <select class="location-select" id="countySelect" onchange="onCountyChange()" disabled>
                    <option value="" id="countyPlaceholder">Сначала выберите город</option>
                </select>
            </div>

            <!-- District Selection -->
            <div class="location-group">
                <label class="location-label" id="districtLabel">Район:</label>
                <select class="location-select" id="districtSelect" onchange="onDistrictChange()" disabled>
                    <option value="" id="districtPlaceholder">Сначала выберите область</option>
                </select>
            </div>

            <!-- Confirm Button -->
            <button class="confirm-button" id="confirmButton" onclick="confirmLocationSelection()" disabled>
                <span id="confirmButtonText">Подтвердить выбор</span>
            </button>
        </div>

        <!-- Selected Location Display -->
        <div class="selected-location" id="selectedLocation">
            <div class="selected-location-title" id="selectedLocationTitle">Выбранная локация:</div>
            <div class="selected-location-text" id="selectedLocationText"></div>
            <div class="admin-ids" id="adminIds" style="display: none;">
                <div class="admin-ids-title" id="adminIdsTitle">ID для админов:</div>
                <div class="admin-ids-text" id="adminIdsText"></div>
            </div>
        </div>

        <!-- Back Button -->
        <a href="/webapp_main" class="back-button" id="backButton">← Вернуться в главное меню</a>
    </div>

    <script>
        // Telegram WebApp initialization
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Current language
        let currentLanguage = 'ru';

        // Selected location data
        let selectedLocation = {
            country_id: null,
            city_id: null,
            county_id: null,
            district_id: null,
            country_name: '',
            city_name: '',
            county_name: '',
            district_name: ''
        };

        // Localization data
        const locales = {
            'ru': {
                'slogan': 'Инсайты рынка недвижимости',
                'pageTitle': 'Аналитика региона',
                'pageDescription': 'Получите детальный анализ рынка недвижимости в выбранном регионе с прогнозами цен',
                'countryLabel': 'Страна:',
                'cityLabel': 'Город:',
                'countyLabel': 'Область/Регион:',
                'districtLabel': 'Район:',
                'countryPlaceholder': 'Выберите страну',
                'cityPlaceholder': 'Сначала выберите страну',
                'countyPlaceholder': 'Сначала выберите город',
                'districtPlaceholder': 'Сначала выберите область',
                'confirmButtonText': 'Подтвердить выбор',
                'backButton': '← Вернуться в главное меню',
                'selectedLocationTitle': 'Выбранная локация:',
                'adminIdsTitle': 'ID для админов:',
                'loading': 'Загрузка...',
                'errorLoading': 'Ошибка загрузки данных'
            },
            'en': {
                'slogan': 'Real Estate Market Insights',
                'pageTitle': 'Region Analytics',
                'pageDescription': 'Get a detailed analysis of the real estate market in the selected region with price forecasts',
                'countryLabel': 'Country:',
                'cityLabel': 'City:',
                'countyLabel': 'Region/Area:',
                'districtLabel': 'District:',
                'countryPlaceholder': 'Select country',
                'cityPlaceholder': 'First select country',
                'countyPlaceholder': 'First select city',
                'districtPlaceholder': 'First select region',
                'confirmButtonText': 'Confirm selection',
                'backButton': '← Back to main menu',
                'selectedLocationTitle': 'Selected location:',
                'adminIdsTitle': 'IDs for admins:',
                'loading': 'Loading...',
                'errorLoading': 'Error loading data'
            },
            'de': {
                'slogan': 'Immobilienmarkt-Einblicke',
                'pageTitle': 'Regionsanalyse',
                'pageDescription': 'Erhalten Sie eine detaillierte Analyse des Immobilienmarkts in der ausgewählten Region mit Preisprognosen',
                'countryLabel': 'Land:',
                'cityLabel': 'Stadt:',
                'countyLabel': 'Region/Bereich:',
                'districtLabel': 'Bezirk:',
                'countryPlaceholder': 'Land auswählen',
                'cityPlaceholder': 'Zuerst Land auswählen',
                'countyPlaceholder': 'Zuerst Stadt auswählen',
                'districtPlaceholder': 'Zuerst Region auswählen',
                'confirmButtonText': 'Auswahl bestätigen',
                'backButton': '← Zurück zum Hauptmenü',
                'selectedLocationTitle': 'Ausgewählte Lage:',
                'adminIdsTitle': 'IDs für Administratoren:',
                'loading': 'Laden...',
                'errorLoading': 'Fehler beim Laden der Daten'
            },
            'fr': {
                'slogan': 'Aperçus du marché immobilier',
                'pageTitle': 'Analyse de région',
                'pageDescription': 'Obtenez une analyse détaillée du marché immobilier dans la région sélectionnée avec des prévisions de prix',
                'countryLabel': 'Pays :',
                'cityLabel': 'Ville :',
                'countyLabel': 'Région/Zone :',
                'districtLabel': 'District :',
                'countryPlaceholder': 'Sélectionner un pays',
                'cityPlaceholder': 'D\'abord sélectionner un pays',
                'countyPlaceholder': 'D\'abord sélectionner une ville',
                'districtPlaceholder': 'D\'abord sélectionner une région',
                'confirmButtonText': 'Confirmer la sélection',
                'backButton': '← Retour au menu principal',
                'selectedLocationTitle': 'Emplacement sélectionné :',
                'adminIdsTitle': 'IDs pour les administrateurs :',
                'loading': 'Chargement...',
                'errorLoading': 'Erreur de chargement des données'
            },
            'tr': {
                'slogan': 'Gayrimenkul Piyasa İçgörüleri',
                'pageTitle': 'Bölge Analizi',
                'pageDescription': 'Seçilen bölgede gayrimenkul piyasasının fiyat tahminleriyle detaylı analizini alın',
                'countryLabel': 'Ülke:',
                'cityLabel': 'Şehir:',
                'countyLabel': 'Bölge/Alan:',
                'districtLabel': 'İlçe:',
                'countryPlaceholder': 'Ülke seçin',
                'cityPlaceholder': 'Önce ülke seçin',
                'countyPlaceholder': 'Önce şehir seçin',
                'districtPlaceholder': 'Önce bölge seçin',
                'confirmButtonText': 'Seçimi onayla',
                'backButton': '← Ana menüye dön',
                'selectedLocationTitle': 'Seçilen konum:',
                'adminIdsTitle': 'Yöneticiler için ID\'ler:',
                'loading': 'Yükleniyor...',
                'errorLoading': 'Veri yükleme hatası'
            }
        };

        // Get localized text
        function getText(key) {
            return locales[currentLanguage][key] || key;
        }

        // Update page text based on current language
        function updatePageText() {
            document.getElementById('slogan').textContent = getText('slogan');
            document.getElementById('pageTitle').textContent = getText('pageTitle');
            document.getElementById('pageDescription').textContent = getText('pageDescription');
            document.getElementById('countryLabel').textContent = getText('countryLabel');
            document.getElementById('cityLabel').textContent = getText('cityLabel');
            document.getElementById('countyLabel').textContent = getText('countyLabel');
            document.getElementById('districtLabel').textContent = getText('districtLabel');
            document.getElementById('countryPlaceholder').textContent = getText('countryPlaceholder');
            document.getElementById('cityPlaceholder').textContent = getText('cityPlaceholder');
            document.getElementById('countyPlaceholder').textContent = getText('countyPlaceholder');
            document.getElementById('districtPlaceholder').textContent = getText('districtPlaceholder');
            document.getElementById('confirmButtonText').textContent = getText('confirmButtonText');
            document.getElementById('backButton').textContent = getText('backButton');
            document.getElementById('selectedLocationTitle').textContent = getText('selectedLocationTitle');
            document.getElementById('adminIdsTitle').textContent = getText('adminIdsTitle');
        }

        // Load countries from API
        async function loadCountries() {
            try {
                const response = await fetch('/api/locations/countries');
                const data = await response.json();
                
                if (data.success) {
                    const countrySelect = document.getElementById('countrySelect');
                    countrySelect.innerHTML = `<option value="">${getText('countryPlaceholder')}</option>`;
                    
                    data.countries.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        countrySelect.appendChild(option);
                    });
                } else {
                    console.error('Failed to load countries:', data.error);
                }
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // Load cities based on selected country
        async function loadCities(countryId) {
            try {
                const response = await fetch('/api/locations/cities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ country_id: countryId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = `<option value="">${getText('cityPlaceholder')}</option>`;
                    
                    data.cities.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        citySelect.appendChild(option);
                    });
                    
                    citySelect.disabled = false;
                } else {
                    console.error('Failed to load cities:', data.error);
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Load counties based on selected city
        async function loadCounties(cityId) {
            try {
                const response = await fetch('/api/locations/counties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ city_id: cityId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const countySelect = document.getElementById('countySelect');
                    countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
                    
                    data.counties.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        countySelect.appendChild(option);
                    });
                    
                    countySelect.disabled = false;
                } else {
                    console.error('Failed to load counties:', data.error);
                }
            } catch (error) {
                console.error('Error loading counties:', error);
            }
        }

        // Load districts based on selected county
        async function loadDistricts(countyId) {
            try {
                const response = await fetch('/api/locations/districts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ county_id: countyId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const districtSelect = document.getElementById('districtSelect');
                    districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
                    
                    // Add "No value" option
                    const noValueOption = document.createElement('option');
                    noValueOption.value = 'none';
                    noValueOption.textContent = 'Не имеет значения';
                    districtSelect.appendChild(noValueOption);
                    
                    data.districts.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        districtSelect.appendChild(option);
                    });
                    
                    districtSelect.disabled = false;
                } else {
                    console.error('Failed to load districts:', data.error);
                }
            } catch (error) {
                console.error('Error loading districts:', error);
            }
        }

        // Handle country selection change
        function onCountryChange() {
            const countrySelect = document.getElementById('countrySelect');
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countryId = countrySelect.value;
            const countryName = countrySelect.options[countrySelect.selectedIndex].text;
            
            // Reset dependent selects
            citySelect.innerHTML = `<option value="">${getText('cityPlaceholder')}</option>`;
            citySelect.disabled = true;
            countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
            countySelect.disabled = true;
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Update selected location
            selectedLocation.country_id = countryId;
            selectedLocation.country_name = countryName;
            selectedLocation.city_id = null;
            selectedLocation.city_name = '';
            selectedLocation.county_id = null;
            selectedLocation.county_name = '';
            selectedLocation.district_id = null;
            selectedLocation.district_name = '';
            
            // Load cities if country is selected
            if (countryId) {
                loadCities(countryId);
            }
            
            updateConfirmButton();
        }

        // Handle city selection change
        function onCityChange() {
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const cityId = citySelect.value;
            const cityName = citySelect.options[citySelect.selectedIndex].text;
            
            // Reset dependent selects
            countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
            countySelect.disabled = true;
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Update selected location
            selectedLocation.city_id = cityId;
            selectedLocation.city_name = cityName;
            selectedLocation.county_id = null;
            selectedLocation.county_name = '';
            selectedLocation.district_id = null;
            selectedLocation.district_name = '';
            
            // Load counties if city is selected
            if (cityId) {
                loadCounties(cityId);
            }
            
            updateConfirmButton();
        }

        // Handle county selection change
        function onCountyChange() {
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countyId = countySelect.value;
            const countyName = countySelect.options[countySelect.selectedIndex].text;
            
            // Reset dependent selects
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Update selected location
            selectedLocation.county_id = countyId;
            selectedLocation.county_name = countyName;
            selectedLocation.district_id = null;
            selectedLocation.district_name = '';
            
            // Load districts if county is selected
            if (countyId) {
                loadDistricts(countyId);
            }
            
            updateConfirmButton();
        }

        // Handle district selection change
        function onDistrictChange() {
            const districtSelect = document.getElementById('districtSelect');
            
            const districtId = districtSelect.value;
            const districtName = districtSelect.options[districtSelect.selectedIndex].text;
            
            // Update selected location
            selectedLocation.district_id = districtId === 'none' ? null : districtId;
            selectedLocation.district_name = districtId === 'none' ? 'Не имеет значения' : districtName;
            
            updateConfirmButton();
        }

        // Update confirm button state
        function updateConfirmButton() {
            const confirmButton = document.getElementById('confirmButton');
            const hasSelection = selectedLocation.country_id && 
                               selectedLocation.city_id && 
                               selectedLocation.county_id;
            
            confirmButton.disabled = !hasSelection;
        }

        // Confirm location selection
        function confirmLocationSelection() {
            if (!selectedLocation.country_id || !selectedLocation.city_id || !selectedLocation.county_id) {
                return;
            }
            
            // Show selected location
            const selectedLocationDiv = document.getElementById('selectedLocation');
            const selectedLocationText = document.getElementById('selectedLocationText');
            const adminIdsDiv = document.getElementById('adminIds');
            const adminIdsText = document.getElementById('adminIdsText');
            
            // Build location text
            let locationText = `${selectedLocation.country_name}`;
            if (selectedLocation.city_name) {
                locationText += `, ${selectedLocation.city_name}`;
            }
            if (selectedLocation.county_name) {
                locationText += `, ${selectedLocation.county_name}`;
            }
            if (selectedLocation.district_name && selectedLocation.district_id !== 'none') {
                locationText += `, ${selectedLocation.district_name}`;
            }
            
            selectedLocationText.textContent = locationText;
            
            // Build admin IDs text
            let adminIdsString = `country_id: ${selectedLocation.country_id}\n`;
            adminIdsString += `city_id: ${selectedLocation.city_id}\n`;
            adminIdsString += `county_id: ${selectedLocation.county_id}\n`;
            if (selectedLocation.district_id && selectedLocation.district_id !== 'none') {
                adminIdsString += `district_id: ${selectedLocation.district_id}`;
            } else {
                adminIdsString += `district_id: none`;
            }
            
            adminIdsText.textContent = adminIdsString;
            
            // Show the selected location section
            selectedLocationDiv.classList.add('show');
            adminIdsDiv.style.display = 'block';
            
            // TODO: Here you would proceed to the next step of report generation
            console.log('Location confirmed:', selectedLocation);
        }

        // Go to main menu
        function goToMainMenu() {
            window.location.href = '/webapp_main';
        }

        // Initialize the page
        function init() {
            // Set language based on Telegram WebApp
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const userLang = tg.initDataUnsafe.user.language_code;
                if (userLang && locales[userLang]) {
                    currentLanguage = userLang;
                }
            }
            
            // Update page text
            updatePageText();
            
            // Load countries
            loadCountries();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
