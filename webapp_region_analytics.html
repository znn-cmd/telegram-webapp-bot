<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title id="pageTitleTag">Aaadviser - Аналитика региона</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .logo {
            width: 110px;
            height: auto;
            display: block;
            margin: 0 auto 8px;
            cursor: pointer;
        }

        .slogan {
            font-size: 15px;
            color: #888;
            font-style: italic;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin: 20px 0 10px 0;
            padding: 0 20px;
        }

        .page-description {
            font-size: 16px;
            color: #666;
            text-align: center;
            margin: 0 0 30px 0;
            padding: 0 20px;
            line-height: 1.5;
        }

        .location-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 0 20px 20px 20px;
            border: 1px solid #e0e0e0;
        }

        .location-group {
            margin-bottom: 15px;
        }

        .location-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .location-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .location-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .location-select:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .confirm-button {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0;
        }

        .confirm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .confirm-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .back-button {
            display: block;
            width: calc(100% - 40px);
            padding: 15px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            text-align: center;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 20px;
            box-sizing: border-box;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .selected-location {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            display: none;
        }

        .selected-location.show {
            display: block;
        }

        .selected-location-title {
            font-size: 16px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .selected-location-text {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .admin-ids {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #4caf50;
        }

        .admin-ids-title {
            font-size: 14px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .admin-ids-text {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px;
            color: #721c24;
            text-align: center;
        }

        /* Region Data Section Styles */
        .region-data-section {
            padding: 0 20px 20px 20px;
        }

        .data-section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }

        /* Mobile-First Card Styles */
        .data-card {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }

        .data-card-header {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }
        
        /* Уменьшаем отступы для всех аккордионов кроме "Общие данные" */
        .data-card-header:not([onclick*="generalDataCard"]) {
            padding: 8px 12px;
            margin-bottom: 6px;
        }

        .data-card-icon {
            font-size: 20px;
            margin-right: 8px;
        }
        
        /* Уменьшаем иконки для всех аккордионов кроме "Общие данные" */
        .data-card-header:not([onclick*="generalDataCard"]) .data-card-icon {
            font-size: 16px;
            margin-right: 6px;
        }

        .data-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }
        
        /* Уменьшаем заголовки для всех аккордионов кроме "Общие данные" */
        .data-card-header:not([onclick*="generalDataCard"]) .data-card-title {
            font-size: 14px;
        }

        .data-card-toggle {
            font-size: 16px;
            color: #666;
            transition: transform 0.3s ease;
        }

        .data-card-toggle.expanded {
            transform: rotate(180deg);
        }

        .data-card-content {
            max-height: 0; /* Collapsed by default */
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .data-card-content.expanded {
            max-height: 2000px; /* Expanded state */
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 10px;
            table-layout: fixed;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .data-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 0;
        }

        .data-table td:first-child {
            font-weight: 500;
            color: #555;
            width: 60%;
            text-align: left;
        }

        .data-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: #333;
            width: 40%;
        }

        /* Sub-card Styles */
        .sub-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }

        .sub-card h3 {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* Footer Styles */
        .data-footer {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #777;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }

        /* Key Metrics Styles */
        .key-metrics-section {
            margin-bottom: 20px;
        }

        .key-metrics-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .key-metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .key-metric-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            color: #333;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metric-content {
            text-align: center;
        }

        .metric-label {
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #666;
            line-height: 1.2;
        }

        .metric-value {
            font-size: 17px;
            font-weight: 600;
            color: #333;
            line-height: 1.1;
        }

        .yield-card {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            color: #333;
        }

        .yield-content {
            text-align: center;
        }

        .yield-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #666;
        }

        .yield-value {
            font-size: 26px;
            font-weight: 700;
            color: #333;
            line-height: 1.1;
        }

        /* Section headers and styling */
        .section-header {
            background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }
        
        .section-header td {
            padding: 8px 4px;
            font-weight: 600;
            color: #495057;
        }
        
        .section-header.collapsible {
            cursor: pointer;
            background-color: #e9ecef;
        }
        
        .section-header.collapsible:hover {
            background-color: #dee2e6;
        }
        
        .yield-row td {
            font-weight: 700 !important;
            color: #333 !important;
            padding: 6px 8px !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 0;
        }
        
        /* Additional section styles removed as requested */

        /* Currency Switcher Styles */
        .currency-switcher {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .currency-switcher-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            text-align: center;
        }

        .currency-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        .currency-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 50px;
        }

        .currency-btn:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .currency-btn.active {
            border-color: #667eea;
            background-color: #667eea;
            color: white;
        }

        .currency-icon {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .currency-code {
            font-size: 10px;
            font-weight: 500;
        }

        .currency-btn.active .currency-code {
            color: white;
        }

        /* Mobile Responsive */
        @media (max-width: 480px) {
            .region-data-section {
                padding: 0 15px 15px 15px;
            }
            
            .key-metrics-grid {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            /* Ensure cards don't get too small on mobile */
            .key-metric-card {
                min-width: 0;
                min-height: 60px;
            }
            
            /* Make text more readable on small screens */
            .metric-label {
                font-size: 9px;
                line-height: 1.1;
            }
            
            .metric-value {
                font-size: 15px;
                line-height: 1.1;
            }
            
            .key-metric-card {
                padding: 10px;
            }
            
            .metric-label {
                font-size: 10px;
            }
            
            .metric-value {
                font-size: 15px;
            }
            
            .yield-card {
                padding: 12px;
            }
            
            .yield-label {
                font-size: 12px;
            }
            
            .yield-value {
                font-size: 21px;
            }
            
            .data-card {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            .data-card-header {
                padding: 10px;
            }
            
            .data-table {
                font-size: 13px;
                table-layout: fixed;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .data-table td {
                padding: 5px 6px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                max-width: 0;
            }
            
            .sub-card {
                padding: 8px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                overflow: hidden;
            }
            
            .data-footer {
                flex-direction: column;
                gap: 5px;
            }
            
            /* Currency switcher mobile styles */
            .currency-switcher {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .currency-buttons {
                gap: 6px;
            }
            
            /* Back button mobile styles */
            .back-button {
                width: calc(100% - 30px);
                margin: 15px;
                padding: 12px 16px;
                font-size: 15px;
                box-sizing: border-box;
            }
            
            .currency-btn {
                padding: 5px 6px;
                min-width: 45px;
            }
            
            .currency-icon {
                font-size: 14px;
            }
            
            .currency-code {
                font-size: 9px;
            }
        }

        /* AI Insights Styles */
        .insights-section {
            margin: 20px 0;
        }
        
        .insights-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .insights-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .insights-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .insights-content {
            min-height: 60px;
        }
        
        .insights-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px;
        }
        
        .insights-loading .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        
        .insights-text {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
            padding: 8px 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            max-width: 100%;
        }
        
        .insights-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            color: #721c24;
        }
        
        .insights-error .error-icon {
            font-size: 24px;
        }
        
        .insights-error .error-text {
            font-size: 14px;
            text-align: center;
        }
        
        /* Mobile responsive for insights */
        @media (max-width: 480px) {
            .insights-card {
                padding: 12px;
            }
            
            .insights-title {
                font-size: 16px;
            }
            
            .insights-text {
                font-size: 14px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
                max-width: 100%;
            }
            
            .insights-section {
                margin: 15px 0;
            }
            
            /* Уменьшаем отступы для всех аккордионов кроме "Общие данные" на мобильных */
            .data-card-header:not([onclick*="generalDataCard"]) {
                padding: 6px 10px;
                margin-bottom: 4px;
            }
            
            .data-card-header:not([onclick*="generalDataCard"]) .data-card-title {
                font-size: 13px;
            }
            
            .data-card-header:not([onclick*="generalDataCard"]) .data-card-icon {
                font-size: 14px;
                margin-right: 4px;
            }
            
            /* Back button mobile styles for insights section */
            .back-button {
                width: calc(100% - 30px);
                margin: 15px;
                padding: 12px 16px;
                font-size: 15px;
                box-sizing: border-box;
            }
        }

        /* Extra small screens */
        @media (max-width: 320px) {
            .back-button {
                width: calc(100% - 20px);
                margin: 10px;
                padding: 10px 14px;
                font-size: 14px;
                box-sizing: border-box;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
        }

        /* Additional Styles */
        .no-data {
            text-align: center;
            padding: 15px;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 6px;
            margin: 10px 0;
        }

        .error-state {
            text-align: center;
            padding: 20px 15px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            margin: 15px 0;
        }

        .error-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .error-text {
            font-size: 14px;
            color: #721c24;
        }

        .loading-state {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: #666;
        }

        .data-content {
            display: none;
        }






    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Logo -->
        <div class="header">
            <img src="logo-flt.png" alt="Aaadviser Logo" class="logo" onclick="goToMainMenu()" />
            <div class="slogan" id="slogan">Инсайты рынка недвижимости</div>
        </div>

        <!-- Page Title -->
        <div class="page-title" id="pageTitle" data-i18n="reports.region_analytics">Аналитика региона</div>

        <!-- Page Description -->
        <div class="page-description" id="pageDescription">
                            Получите детальный анализ рынка недвижимости в выбранном регионе
        </div>

        <!-- Location Selection Section -->
        <div class="location-section">
            <!-- Country Selection -->
            <div class="location-group">
                <label class="location-label" id="countryLabel">Страна:</label>
                <select class="location-select" id="countrySelect" onchange="onCountryChange()">
                    <option value="" id="countryPlaceholder">Выберите страну</option>
                </select>
            </div>

            <!-- City Selection -->
            <div class="location-group">
                <label class="location-label" id="cityLabel">Город:</label>
                <select class="location-select" id="citySelect" onchange="onCityChange()" disabled>
                    <option value="" id="cityPlaceholder">Сначала выберите страну</option>
                </select>
            </div>

            <!-- County Selection -->
            <div class="location-group">
                <label class="location-label" id="countyLabel">Область/Регион:</label>
                <select class="location-select" id="countySelect" onchange="onCountyChange()" disabled>
                    <option value="" id="countyPlaceholder">Сначала выберите город</option>
                </select>
            </div>

            <!-- District Selection -->
            <div class="location-group">
                <label class="location-label" id="districtLabel">Район:</label>
                <select class="location-select" id="districtSelect" onchange="onDistrictChange()" disabled>
                    <option value="" id="districtPlaceholder">Сначала выберите область</option>
                </select>
            </div>

            <!-- Confirm Button -->
            <button class="confirm-button" id="confirmButton" onclick="confirmLocationSelection()" disabled>
                <span id="confirmButtonText">Подтвердить выбор</span>
            </button>
        </div>

        <!-- Selected Location Display -->
        <div class="selected-location" id="selectedLocation">
            <div class="selected-location-title" id="selectedLocationTitle">Выбранная локация:</div>
            <div class="selected-location-text" id="selectedLocationText"></div>
            <div class="admin-ids" id="adminIds" style="display: none;">
                <div class="admin-ids-title" id="adminIdsTitle">ID для админов:</div>
                <div class="admin-ids-text" id="adminIdsText"></div>
            </div>
        </div>

        <!-- Region Data Analysis -->
        <div class="region-data-section" id="regionDataSection" style="display: none;">
            
            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="loading-spinner"></div>
                <div class="loading-text" id="loadingText">Загрузка данных...</div>
            </div>
            
            <!-- Currency Switcher -->
            <div class="currency-switcher" id="currencySwitcher" style="display: none;">
                <div class="currency-switcher-title" id="currencySwitcherTitle">Валюта отображения:</div>
                <div class="currency-buttons">
                    <button class="currency-btn active" data-currency="TRY" onclick="switchCurrency('TRY')">
                        <span class="currency-icon">₺</span>
                        <span class="currency-code">TRY</span>
                    </button>
                    <button class="currency-btn" data-currency="USD" onclick="switchCurrency('USD')">
                        <span class="currency-icon">$</span>
                        <span class="currency-code">USD</span>
                    </button>
                    <button class="currency-btn" data-currency="EUR" onclick="switchCurrency('EUR')">
                        <span class="currency-icon">€</span>
                        <span class="currency-code">EUR</span>
                    </button>
                    <button class="currency-btn" data-currency="RUB" onclick="switchCurrency('RUB')">
                        <span class="currency-icon">₽</span>
                        <span class="currency-code">RUB</span>
                    </button>
                </div>
            </div>

            <!-- Key Metrics Cards -->
            <div class="key-metrics-section" id="keyMetricsSection" style="display: none;">
                <h3 class="key-metrics-title" id="keyMetricsTitle">Ключевые показатели</h3>
                <div class="key-metrics-grid">
                    <!-- Average Sale Price per m² -->
                    <div class="key-metric-card">
                        <div class="metric-content">
                            <div class="metric-label" id="avgSalePriceLabel">Средняя цена продажи за м²</div>
                            <div class="metric-value" id="avgSalePrice">-</div>
                        </div>
                    </div>
                    
                    <!-- Average Rent Price per m² -->
                    <div class="key-metric-card">
                        <div class="metric-content">
                            <div class="metric-label" id="avgRentPriceLabel">Средняя цена аренды за м²</div>
                            <div class="metric-value" id="avgRentPrice">-</div>
                        </div>
                    </div>
                    
                    <!-- Listing Period Sale -->
                    <div class="key-metric-card">
                        <div class="metric-content">
                            <div class="metric-label" id="listingPeriodSaleLabel">Период размещения (продажа)</div>
                            <div class="metric-value" id="listingPeriodSale">-</div>
                        </div>
                    </div>
                    
                    <!-- Listing Period Rent -->
                    <div class="key-metric-card">
                        <div class="metric-content">
                            <div class="metric-label" id="listingPeriodRentLabel">Период размещения (аренда)</div>
                            <div class="metric-value" id="listingPeriodRent">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Yield Card - Full Width -->
                <div class="yield-card">
                    <div class="yield-content">
                        <div class="yield-label" id="yieldLabel">Yield (Доходность)</div>
                        <div class="yield-value" id="yieldValue">-</div>
                    </div>
                </div>
            </div>
            
            <!-- AI Insights Section -->
            <div class="insights-section" id="insightsSection" style="display: none;">
                <div class="insights-card">
                    <div class="insights-header">
                        <div class="insights-title" id="insightsTitle">Саммари</div>
                    </div>
                    <div class="insights-content" id="insightsContent">
                        <div class="insights-loading" id="insightsLoading">
                            <div class="loading-spinner"></div>
                            <div class="loading-text" id="insightsLoadingText"></div>
                        </div>
                        <div class="insights-text" id="insightsText" style="display: none;"></div>
                        <div class="insights-error" id="insightsError" style="display: none;">
                            <div class="error-icon">⚠️</div>
                            <div class="error-text" id="insightsErrorText"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Content -->
            <div class="data-content" id="dataContent" style="display: none;">
                                 <!-- General Data -->
                 <div class="data-card" id="generalDataCard">
                     <div class="data-card-header" onclick="toggleAccordion('generalDataCard')">
                         <div style="display: flex; align-items: center;">
                             <div class="data-card-icon"></div>
                             <div class="data-card-title" id="generalDataTitle">Общие данные</div>
                         </div>
                         <div class="data-card-toggle expanded" id="generalDataToggle">▲</div>
                     </div>
                     <div class="data-card-content expanded" id="generalDataContent">
                         <!-- General data will be populated here - expanded by default -->
                     </div>
                 </div>
                
                                 <!-- House Type Data -->
                 <div class="data-card" id="houseTypeDataCard">
                     <div class="data-card-header" onclick="toggleAccordion('houseTypeDataCard')">
                         <div style="display: flex; align-items: center; gap: 12px;">
                             <div class="data-card-icon"></div>
                             <div class="data-card-title" id="houseTypeDataTitle">Данные по количеству спален</div>
                         </div>
                         <div class="data-card-toggle" id="houseTypeDataToggle">▼</div>
                     </div>
                     <div class="data-card-content" id="houseTypeDataContent">
                         <!-- House type data will be populated here - collapsed by default -->
                     </div>
                 </div>
                
                                 <!-- Floor Segment Data -->
                 <div class="data-card" id="floorSegmentDataCard">
                     <div class="data-card-header" onclick="toggleAccordion('floorSegmentDataCard')">
                         <div style="display: flex; align-items: center; gap: 12px;">
                             <div class="data-card-icon"></div>
                             <div class="data-card-title" id="floorSegmentDataTitle">Данные по этажу</div>
                         </div>
                         <div class="data-card-toggle" id="floorSegmentDataToggle">▼</div>
                     </div>
                     <div class="data-card-content" id="floorSegmentDataContent">
                         <!-- Floor segment data will be populated here - collapsed by default -->
                     </div>
                 </div>
                
                                 <!-- Age Data -->
                 <div class="data-card" id="ageDataCard">
                     <div class="data-card-header" onclick="toggleAccordion('ageDataCard')">
                         <div style="display: flex; align-items: center; gap: 12px;">
                             <div class="data-card-icon"></div>
                             <div class="data-card-title" id="ageDataTitle">Данные по возрасту объектов</div>
                         </div>
                         <div class="data-card-toggle" id="ageDataToggle">▼</div>
                     </div>
                     <div class="data-card-content" id="ageDataContent">
                         <!-- Age data will be populated here - collapsed by default -->
                     </div>
                 </div>

                                 <!-- Heating Data -->
                 <div class="data-card" id="heatingDataCard">
                     <div class="data-card-header" onclick="toggleAccordion('heatingDataCard')">
                         <div style="display: flex; align-items: center; gap: 12px;">
                             <div class="data-card-icon"></div>
                             <div class="data-card-title" id="heatingDataTitle">Данные по типу отопления</div>
                         </div>
                         <div class="data-card-toggle" id="heatingDataToggle">▼</div>
                     </div>
                     <div class="data-card-content" id="heatingDataContent">
                         <!-- Heating data will be populated here - collapsed by default -->
                     </div>
                 </div>
            </div>
            

            
            <!-- Error State -->
            <div class="error-state" id="errorState" style="display: none;">
                <div class="error-icon">❌</div>
                <div class="error-text" id="errorText">Ошибка загрузки данных</div>
            </div>
        </div>

        <!-- Back Button -->
        <a href="/webapp_main" class="back-button" id="backButton">← Вернуться в главное меню</a>
    </div>

    <script>
        // Telegram WebApp initialization
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Current language
        let currentLanguage = 'ru';

        // Selected location data
        let selectedLocation = {
            country_id: null,
            city_id: null,
            county_id: null,
            district_id: null,
            country_name: '',
            city_name: '',
            county_name: '',
            district_name: ''
        };

        // Localization data
        const locales = {
            'ru': {
                'slogan': 'Инсайты рынка недвижимости',
                'pageTitle': 'Аналитика региона',
                'pageDescription': 'Получите детальный анализ рынка недвижимости в выбранном регионе',
                'countryLabel': 'Страна:',
                'cityLabel': 'Город:',
                'countyLabel': 'Область/Регион:',
                'districtLabel': 'Район:',
                'countryPlaceholder': 'Выберите страну',
                'cityPlaceholder': 'Сначала выберите страну',
                'countyPlaceholder': 'Сначала выберите город',
                'districtPlaceholder': 'Сначала выберите область',
                'confirmButtonText': 'Подтвердить выбор',
                'backButton': '← Вернуться в главное меню',
                'selectedLocationTitle': 'Выбранная локация:',
                'adminIdsTitle': 'ID для админов:',
                'loading': 'Загрузка...',
                'errorLoading': 'Ошибка загрузки данных',
                'dataSectionTitle': 'Анализ данных региона',
                'generalDataTitle': 'Общие данные',
                                'houseTypeDataTitle': 'Данные по количеству спален',
                'floorSegmentDataTitle': 'Данные по этажу',
                'ageDataTitle': 'Данные по возрасту объектов',
                'heatingDataTitle': 'Данные по типу отопления',
                'loadingText': 'Загрузка данных...',
                'errorText': 'Ошибка загрузки данных',
                'totalProperties': 'Всего объектов:',
                'averagePrice': 'Средняя цена:',
                'priceRange': 'Диапазон цен:',
                'noDataAvailable': 'Данные недоступны',
                'keyMetricsTitle': 'Ключевые показатели',
                'avgSalePriceLabel': 'Средняя цена продажи за м²',
                'avgRentPriceLabel': 'Средняя цена аренды за м²',
                'listingPeriodSaleLabel': 'Период размещения (продажа)',
                'listingPeriodRentLabel': 'Период размещения (аренда)',
                'yieldLabel': 'Yield (Доходность)',
                'insightsTitle': 'Саммари',
                'insightsLoading': 'Анализируем данные...',
                'insightsError': 'Ошибка при анализе данных'
            },
            'en': {
                'slogan': 'Real Estate Market Insights',
                'pageTitle': 'Region Analytics',
                'pageDescription': 'Get a detailed analysis of the real estate market in the selected region',
                'countryLabel': 'Country:',
                'cityLabel': 'City:',
                'countyLabel': 'Region/Area:',
                'districtLabel': 'District:',
                'countryPlaceholder': 'Select country',
                'cityPlaceholder': 'First select country',
                'countyPlaceholder': 'First select city',
                'districtPlaceholder': 'First select region',
                'confirmButtonText': 'Confirm selection',
                'backButton': '← Back to main menu',
                'selectedLocationTitle': 'Selected location:',
                'adminIdsTitle': 'IDs for admins:',
                'loading': 'Loading...',
                'errorLoading': 'Error loading data',
                'dataSectionTitle': 'Regional Data Analysis',
                'generalDataTitle': 'General Data',
                                'houseTypeDataTitle': 'Bedroom Count Data',
                'floorSegmentDataTitle': 'Floor Data',
                'ageDataTitle': 'Age Data',
                'heatingDataTitle': 'Heating Type Data',
                'loadingText': 'Loading data...',
                'errorText': 'Error loading data',
                'totalProperties': 'Total properties:',
                'averagePrice': 'Average price:',
                'priceRange': 'Price range:',
                'noDataAvailable': 'Data not available',
                'keyMetricsTitle': 'Key Metrics',
                'avgSalePriceLabel': 'Average Sale Price per m²',
                'avgRentPriceLabel': 'Average Rent Price per m²',
                'listingPeriodSaleLabel': 'Listing Period (Sale)',
                'listingPeriodRentLabel': 'Listing Period (Rent)',
                'yieldLabel': 'Yield (Return)',
                'insightsTitle': 'Summary',
                'insightsLoading': 'Analyzing data...',
                'insightsError': 'Error analyzing data'
            },
            'de': {
                'slogan': 'Immobilienmarkt-Einblicke',
                'pageTitle': 'Regionsanalyse',
                'pageDescription': 'Erhalten Sie eine detaillierte Analyse des Immobilienmarkts in der ausgewählten Region',
                'countryLabel': 'Land:',
                'cityLabel': 'Stadt:',
                'countyLabel': 'Region/Bereich:',
                'districtLabel': 'Bezirk:',
                'countryPlaceholder': 'Land auswählen',
                'cityPlaceholder': 'Zuerst Land auswählen',
                'countyPlaceholder': 'Zuerst Stadt auswählen',
                'districtPlaceholder': 'Zuerst Region auswählen',
                'confirmButtonText': 'Auswahl bestätigen',
                'backButton': '← Zurück zum Hauptmenü',
                'selectedLocationTitle': 'Ausgewählte Lage:',
                'adminIdsTitle': 'IDs für Administratoren:',
                'loading': 'Laden...',
                'errorLoading': 'Fehler beim Laden der Daten',
                'dataSectionTitle': 'Regionale Datenanalyse',
                'generalDataTitle': 'Allgemeine Daten',
                                'houseTypeDataTitle': 'Schlafzimmer-Anzahl-Daten',
                'floorSegmentDataTitle': 'Etagen-Daten',
                'ageDataTitle': 'Altersdaten',
                'heatingDataTitle': 'Heizungstyp-Daten',
                'loadingText': 'Daten werden geladen...',
                'errorText': 'Fehler beim Laden der Daten',
                'totalProperties': 'Gesamtobjekte:',
                'averagePrice': 'Durchschnittspreis:',
                'priceRange': 'Preisbereich:',
                'noDataAvailable': 'Daten nicht verfügbar',
                'keyMetricsTitle': 'Wichtige Kennzahlen',
                'avgSalePriceLabel': 'Durchschnittlicher Verkaufspreis pro m²',
                'avgRentPriceLabel': 'Durchschnittlicher Mietpreis pro m²',
                'listingPeriodSaleLabel': 'Angebotsdauer (Verkauf)',
                'listingPeriodRentLabel': 'Angebotsdauer (Vermietung)',
                'yieldLabel': 'Yield (Rendite)',
                'insightsTitle': 'Zusammenfassung',
                'insightsLoading': 'Daten werden analysiert...',
                'insightsError': 'Fehler bei der Datenanalyse'
            },
            'fr': {
                'slogan': 'Aperçus du marché immobilier',
                'pageTitle': 'Analyse de région',
                'pageDescription': 'Obtenez une analyse détaillée du marché immobilier dans la région sélectionnée',
                'countryLabel': 'Pays :',
                'cityLabel': 'Ville :',
                'countyLabel': 'Région/Zone :',
                'districtLabel': 'District :',
                'countryPlaceholder': 'Sélectionner un pays',
                'cityPlaceholder': 'D\'abord sélectionner un pays',
                'countyPlaceholder': 'D\'abord sélectionner une ville',
                'districtPlaceholder': 'D\'abord sélectionner une région',
                'confirmButtonText': 'Confirmer la sélection',
                'backButton': '← Retour au menu principal',
                'selectedLocationTitle': 'Emplacement sélectionné :',
                'adminIdsTitle': 'IDs pour les administrateurs :',
                'loading': 'Chargement...',
                'errorLoading': 'Erreur de chargement des données',
                'dataSectionTitle': 'Analyse des données régionales',
                'generalDataTitle': 'Données générales',
                                'houseTypeDataTitle': 'Données du nombre de chambres',
                'floorSegmentDataTitle': 'Données d\'étage',
                'ageDataTitle': 'Données d\'âge',
                'heatingDataTitle': 'Données du type de chauffage',
                'loadingText': 'Chargement des données...',
                'errorText': 'Erreur de chargement des données',
                'totalProperties': 'Total des propriétés :',
                'averagePrice': 'Prix moyen :',
                'priceRange': 'Fourchette de prix :',
                'noDataAvailable': 'Données non disponibles',
                'keyMetricsTitle': 'Métriques clés',
                'avgSalePriceLabel': 'Prix de vente moyen par m²',
                'avgRentPriceLabel': 'Prix de location moyen par m²',
                'listingPeriodSaleLabel': 'Période d\'inscription (vente)',
                'listingPeriodRentLabel': 'Période d\'inscription (location)',
                'yieldLabel': 'Yield (Rendement)',
                'insightsTitle': 'Résumé',
                'insightsLoading': 'Analyse des données...',
                'insightsError': 'Erreur lors de l\'analyse des données'
            },
            'tr': {
                'slogan': 'Gayrimenkul Piyasa İçgörüleri',
                'pageTitle': 'Bölge Analizi',
                'pageDescription': 'Seçilen bölgede gayrimenkul piyasasının detaylı analizini alın',
                'countryLabel': 'Ülke:',
                'cityLabel': 'Şehir:',
                'countyLabel': 'Bölge/Alan:',
                'districtLabel': 'İlçe:',
                'countryPlaceholder': 'Ülke seçin',
                'cityPlaceholder': 'Önce ülke seçin',
                'countyPlaceholder': 'Önce şehir seçin',
                'districtPlaceholder': 'Önce bölge seçin',
                'confirmButtonText': 'Seçimi onayla',
                'backButton': '← Ana menüye dön',
                'selectedLocationTitle': 'Seçilen konum:',
                'adminIdsTitle': 'Yöneticiler için ID\'ler:',
                'loading': 'Yükleniyor...',
                'errorLoading': 'Veri yükleme hatası',
                'dataSectionTitle': 'Bölgesel Veri Analizi',
                'generalDataTitle': 'Genel Veriler',
                                'houseTypeDataTitle': 'Yatak Odası Sayısı Verileri',
                'floorSegmentDataTitle': 'Kat Verileri',
                'ageDataTitle': 'Yaş Verileri',
                'heatingDataTitle': 'Isıtma Tipi Verileri',
                'loadingText': 'Veriler yükleniyor...',
                'errorText': 'Veri yükleme hatası',
                'totalProperties': 'Toplam mülk:',
                'averagePrice': 'Ortalama fiyat:',
                'priceRange': 'Fiyat aralığı:',
                'noDataAvailable': 'Veri mevcut değil',
                'keyMetricsTitle': 'Ana Metrikler',
                'avgSalePriceLabel': 'm² başına ortalama satış fiyatı',
                'avgRentPriceLabel': 'm² başına ortalama kiralama fiyatı',
                'listingPeriodSaleLabel': 'İlan süresi (satış)',
                'listingPeriodRentLabel': 'İlan süresi (kiralama)',
                'yieldLabel': 'Yield (Getiri)',
                'insightsTitle': 'Özet',
                'insightsLoading': 'Veriler analiz ediliyor...',
                'insightsError': 'Veri analizi hatası'
            }
        };

        // Sort fields by priority for structured data display
        // Order: Sale data → Rent data → Yield → Additional data (hidden by default)
        function sortFieldsByPriority(fields) {
            const priorityOrder = {
                // Priority 1: Sale data (age → period → max/min prices → area → quantity → total price)
                'average_age_for_sale': 1,
                'avg_age_sale': 1,
                'sale_age_avg': 1,
                'age_sale': 1,
                
                'listing_period_for_sale': 2,
                'sale_period': 2,
                'period_sale': 2,
                
                'max_unit_price_for_sale': 3,
                'min_unit_price_for_sale': 4,
                'max_price_sale': 3,
                'min_price_sale': 4,
                
                'comparable_area_for_sale': 5,
                'area_for_sale': 5,
                'sale_area': 5,
                
                'quantity_for_sale': 6,
                'count_for_sale': 6,
                'sale_quantity': 6,
                
                'total_price_for_sale': 7,
                'sale_total_price': 7,
                
                // Priority 2: Rent data (age → period → max/min prices → area → quantity → total price)
                'average_age_for_rent': 8,
                'avg_age_rent': 8,
                'rent_age_avg': 8,
                'age_rent': 8,
                
                'listing_period_for_rent': 9,
                'rent_period': 9,
                'period_rent': 9,
                
                'max_unit_price_for_rent': 10,
                'min_unit_price_for_rent': 11,
                'max_price_rent': 10,
                'min_price_rent': 11,
                
                'comparable_area_for_rent': 12,
                'area_for_rent': 12,
                'rent_area': 12,
                
                'quantity_for_rent': 13,
                'count_for_rent': 13,
                'rent_quantity': 13,
                
                'total_price_for_rent': 14,
                'rent_total_price': 14,
                
                // Priority 3: Yield (highlighted)
                'yield': 15,
                'yield_rate': 15,
                'return_rate': 15,
                
                // Additional data section removed as requested
                
                // Priority 5: Hidden price fields (not shown)
                'price_per_m2_for_rent': 999,
                'price_per_m2_for_sale': 999,
                'average_price_for_rent': 999,
                'average_price_for_sale': 999,
                
                // Priority 6: Other fields (everything else)
                'default': 1000
            };
            
            return fields.sort((a, b) => {
                const priorityA = priorityOrder[a] || priorityOrder['default'];
                const priorityB = priorityOrder[b] || priorityOrder['default'];
                return priorityA - priorityB;
            });
        }

                // Display fields with structured headers and sections
        function displayFieldsWithStructuredHeaders(fields, item, html) {
            let currentSection = '';
            let saleFields = [];
            let rentFields = [];
            let yieldFields = [];

            // Categorize fields by type
            fields.forEach(key => {
                const value = item[key];
                if (value === null || value === undefined) return;

                // Skip Stock Ratio fields and Unit Price fields
                if (key.includes('stock_ratio') || key.includes('Stock_Ratio') ||
                    key.includes('unit_price_for_sale') || key.includes('unit_price_for_rent') ||
                    key.includes('Unit_Price_For_Sale') || key.includes('Unit_Price_For_Rent')) {
                    return;
                }

                if (key.includes('sale') || key.includes('Sale')) {
                    saleFields.push({ key, value });
                } else if (key.includes('rent') || key.includes('Rent')) {
                    rentFields.push({ key, value });
                } else if (key.includes('yield') || key.includes('Yield') || key.includes('return')) {
                    yieldFields.push({ key, value });
                }
                // Additional fields are no longer displayed
            });

            // Sort each category by priority
            saleFields.sort((a, b) => {
                const priorityA = getFieldPriority(a.key);
                const priorityB = getFieldPriority(b.key);
                return priorityA - priorityB;
            });

            rentFields.sort((a, b) => {
                const priorityA = getFieldPriority(a.key);
                const priorityB = getFieldPriority(b.key);
                return priorityA - priorityB;
            });

            // Get localized headers based on user language
            const headers = {
                'ru': {
                    'sale': 'Данные по продаже',
                    'rent': 'Данные по аренде'
                },
                'en': {
                    'sale': 'Sale Data',
                    'rent': 'Rent Data'
                },
                'de': {
                    'sale': 'Verkaufsdaten',
                    'rent': 'Vermietungsdaten'
                },
                'fr': {
                    'sale': 'Données de vente',
                    'rent': 'Données de location'
                },
                'tr': {
                    'sale': 'Satış Verileri',
                    'rent': 'Kiralama Verileri'
                }
            };

            const currentHeaders = headers[userLanguage] || headers['ru'];

            // Display Sale section
            if (saleFields.length > 0) {
                html += `<tr class="section-header"><td colspan="2"><strong>${currentHeaders.sale}</strong></td></tr>`;
                saleFields.forEach(({ key, value }) => {
                    const label = getFieldLabel(key);
                    const displayValue = formatFieldValue(key, value);
                    html += `<tr><td>${label}:</td><td>${displayValue}</td></tr>`;
                });
            }

            // Display Rent section
            if (rentFields.length > 0) {
                html += `<tr class="section-header"><td colspan="2"><strong>${currentHeaders.rent}</strong></td></tr>`;
                rentFields.forEach(({ key, value }) => {
                    const label = getFieldLabel(key);
                    const displayValue = formatFieldValue(key, value);
                    html += `<tr><td>${label}:</td><td>${displayValue}</td></tr>`;
                });
            }

            // Display Yield (highlighted)
            if (yieldFields.length > 0) {
                yieldFields.forEach(({ key, value }) => {
                    const label = getFieldLabel(key);
                    const displayValue = formatFieldValue(key, value);
                    html += `<tr class="yield-row"><td><strong>${label}:</strong></td><td><strong>${displayValue}</strong></td></tr>`;
                });
            }

            // Additional section removed as requested

            return html;
        }
        
        // Get field priority for sorting within sections
        function getFieldPriority(fieldName) {
            const priorityMap = {
                // Sale priority
                'average_age_for_sale': 1, 'avg_age_sale': 1, 'sale_age_avg': 1, 'age_sale': 1,
                'listing_period_for_sale': 2, 'sale_period': 2, 'period_sale': 2,
                'max_unit_price_for_sale': 3, 'min_unit_price_for_sale': 4, 'max_price_sale': 3, 'min_price_sale': 4,
                'comparable_area_for_sale': 5, 'area_for_sale': 5, 'sale_area': 5,
                'quantity_for_sale': 6, 'count_for_sale': 6, 'sale_quantity': 6,
                'total_price_for_sale': 7, 'sale_total_price': 7,
                
                // Rent priority
                'average_age_for_rent': 1, 'avg_age_rent': 1, 'rent_age_avg': 1, 'age_rent': 1,
                'listing_period_for_rent': 2, 'rent_period': 2, 'period_rent': 2,
                'max_unit_price_for_rent': 3, 'min_unit_price_for_rent': 4, 'max_price_rent': 3, 'min_price_rent': 4,
                'comparable_area_for_rent': 5, 'area_for_rent': 5, 'rent_area': 5,
                'quantity_for_rent': 6, 'count_for_rent': 6, 'rent_quantity': 6,
                'total_price_for_rent': 7, 'rent_total_price': 7,
                
                // Default priority
                'default': 999
            };
            
            return priorityMap[fieldName] || priorityMap['default'];
        }
        
        // Additional section toggle function removed as requested

        // User language and currency management
        let userLanguage = 'ru'; // Default language
        let currentCurrency = 'TRY'; // Default currency
        let currencyRates = null;
        
        // Get user language from database
        async function getUserLanguage() {
            try {
                // Get telegram_id from Telegram WebApp
                const telegramId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
                if (!telegramId) {
                    console.log('No telegram_id available, using default language: ru');
                    return 'ru';
                }
                
                const response = await fetch('/api/user/language', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                const data = await response.json();
                if (data.success) {
                    userLanguage = data.language;
                    console.log('User language loaded:', userLanguage);
                    return userLanguage;
                } else {
                    console.log('Failed to get user language, using default: ru');
                    return 'ru';
                }
            } catch (error) {
                console.error('Error getting user language:', error);
                return 'ru';
            }
        }
        
        // Set default currency based on selected country
        function setDefaultCurrency() {
            if (selectedLocation && selectedLocation.country_name) {
                const countryName = selectedLocation.country_name.toLowerCase();
                if (countryName.includes('turkey') || countryName.includes('турция') || 
                    countryName.includes('türkiye') || countryName.includes('türkei') || 
                    countryName.includes('turquie')) {
                    currentCurrency = 'TRY';
                    console.log('🇹🇷 Турция выбрана, устанавливаем валюту TRY');
                } else if (countryName.includes('germany') || countryName.includes('германия') || 
                           countryName.includes('deutschland') || countryName.includes('allemagne')) {
                    currentCurrency = 'EUR';
                    console.log('🇩🇪 Германия выбрана, устанавливаем валюту EUR');
                } else if (countryName.includes('france') || countryName.includes('франция') || 
                           countryName.includes('frankreich')) {
                    currentCurrency = 'EUR';
                    console.log('🇫🇷 Франция выбрана, устанавливаем валюту EUR');
                } else if (countryName.includes('russia') || countryName.includes('россия') || 
                           countryName.includes('russland') || countryName.includes('russie')) {
                    currentCurrency = 'RUB';
                    console.log('🇷🇺 Россия выбрана, устанавливаем валюту RUB');
                } else {
                    currentCurrency = 'USD';
                    console.log('🌍 Другая страна, устанавливаем валюту USD');
                }
                
                // Update active button
                updateCurrencyButton();
            }
        }
        
        // Update currency button to show active state
        function updateCurrencyButton() {
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[data-currency="${currentCurrency}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // Switch currency and recalculate all values
        function switchCurrency(currency) {
            if (currentCurrency === currency) return;
            
            currentCurrency = currency;
            
            // Update active button
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-currency="${currency}"]`).classList.add('active');
            
            // Recalculate and redisplay all data (but don't re-fetch insights)
            recalculateAllValues();
        }

        // Get currency rates from database or API
        async function getCurrencyRates() {
            try {
                console.log('🔄 Fetching currency rates...');
                // First try to get from database
                const response = await fetch('/api/currency/rates');
                console.log('📡 Response status:', response.status);
                const data = await response.json();
                console.log('📊 Response data:', data);
                
                if (data.success && data.rates) {
                    currencyRates = data.rates;
                    console.log('✅ Currency rates loaded from database:', currencyRates);
                    return currencyRates;
                } else {
                    // If no rates in database, fetch from API
                    console.log('⚠️ No currency rates in database, fetching from API...');
                    return await fetchCurrencyFromAPI();
                }
            } catch (error) {
                console.error('❌ Error getting currency rates:', error);
                return await fetchCurrencyFromAPI();
            }
        }

        // Fetch currency rates from external API
        async function fetchCurrencyFromAPI() {
            try {
                const response = await fetch('/api/currency/fetch');
                const data = await response.json();
                
                if (data.success) {
                    currencyRates = data.rates;
                    console.log('Currency rates fetched from API:', currencyRates);
                    return currencyRates;
                } else {
                    throw new Error(data.error || 'Failed to fetch currency rates');
                }
            } catch (error) {
                console.error('Error fetching currency from API:', error);
                return null;
            }
        }

        // Convert value to selected currency
        function convertCurrency(value, fromCurrency = 'TRY') {
            console.log('🔄 Converting currency:', { value, fromCurrency, currentCurrency, currencyRates });
            
            if (!currencyRates || !value || isNaN(value)) {
                console.log('⚠️ Cannot convert: missing rates, value, or invalid value');
                return value;
            }
            
            const numericValue = parseFloat(value);
            if (isNaN(numericValue)) {
                console.log('⚠️ Cannot convert: value is not a valid number');
                return value;
            }
            
            // If converting from TRY (base currency in our system)
            if (fromCurrency === 'TRY') {
                let convertedValue;
                switch (currentCurrency) {
                    case 'USD':
                        // TRY -> EUR -> USD: TRY / TRY_EUR_rate * USD_EUR_rate
                        convertedValue = numericValue / currencyRates.try * currencyRates.usd;
                        console.log(`💰 TRY ${numericValue} -> USD ${convertedValue} (via EUR)`);
                        return convertedValue;
                    case 'EUR':
                        // TRY -> EUR: TRY / TRY_EUR_rate
                        convertedValue = numericValue / currencyRates.try;
                        console.log(`💰 TRY ${numericValue} -> EUR ${convertedValue}`);
                        return convertedValue;
                    case 'RUB':
                        // TRY -> EUR -> RUB: TRY / TRY_EUR_rate * RUB_EUR_rate
                        convertedValue = numericValue / currencyRates.try * currencyRates.rub;
                        console.log(`💰 TRY ${numericValue} -> RUB ${convertedValue} (via EUR)`);
                        return convertedValue;
                    default:
                        console.log(`💰 Keeping in TRY: ${numericValue}`);
                        return numericValue; // TRY
                }
            }
            
            console.log(`💰 No conversion needed for ${fromCurrency}`);
            return numericValue;
        }

        // Recalculate all displayed values
        function recalculateAllValues() {
            console.log('🔄 Пересчет всех значений для валюты:', currentCurrency);
            
            // Update key metrics
            updateKeyMetricsCurrency();
            
            // Update all data tables (but preserve insights)
            updateDataTablesCurrency();
        }

        // Update key metrics with new currency
        function updateKeyMetricsCurrency() {
            console.log('💰 Обновление ключевых метрик для валюты:', currentCurrency);
            
            // Пересчитываем и обновляем ключевые метрики
            if (window.lastGeneralData) {
                console.log('Updating key metrics with lastGeneralData:', window.lastGeneralData);
                fillKeyMetrics(window.lastGeneralData);
            } else {
                console.log('No lastGeneralData available for currency update');
            }
        }

        // Update all data tables with new currency
        function updateDataTablesCurrency() {
            console.log('📊 Обновление всех таблиц данных для валюты:', currentCurrency);
            
            // Пересчитываем и обновляем все таблицы данных (но не перезагружаем insights)
            if (window.lastRegionData) {
                // Store current insights before updating data
                const currentInsights = document.getElementById('insightsText')?.textContent || '';
                const insightsSection = document.getElementById('insightsSection');
                const wasInsightsVisible = insightsSection.style.display !== 'none';
                
                // Update data display without re-fetching insights
                displayRegionDataWithoutInsights(window.lastRegionData);
                
                // Restore insights if they were visible
                if (wasInsightsVisible && currentInsights) {
                    const insightsText = document.getElementById('insightsText');
                    if (insightsText) {
                        insightsText.textContent = currentInsights;
                        insightsSection.style.display = 'block';
                        document.getElementById('insightsLoading').style.display = 'none';
                        document.getElementById('insightsError').style.display = 'none';
                    }
                }
            }
        }

        // Format currency with proper symbol and formatting
        function formatCurrency(value, currency) {
            if (!value || isNaN(value)) return '-';
            
            const numericValue = parseFloat(value);
            let symbol = '';
            let formattedValue = '';
            
            switch (currency) {
                case 'USD':
                    symbol = '$';
                    formattedValue = numericValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    break;
                case 'EUR':
                    symbol = '€';
                    formattedValue = numericValue.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    break;
                case 'RUB':
                    symbol = '₽';
                    formattedValue = numericValue.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    break;
                case 'TRY':
                default:
                    symbol = '₺';
                    formattedValue = numericValue.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    break;
            }
            
            return `${formattedValue} ${symbol}`;
        }

        // Helper function to get human-readable field labels
        function getFieldLabel(key) {
            // Define field labels based on user's language
            const labels = {
                'ru': {
                    'average_age_for_sale': 'Средний возраст для продажи (годы)',
                    'average_age_for_rent': 'Средний возраст для аренды (годы)',
                    'listing_period_for_sale': 'Период размещения для продажи (дни)',
                    'listing_period_for_rent': 'Период размещения для аренды (дни)',
                    'max_unit_price_for_sale': 'Максимальная цена за м² для продажи',
                    'min_unit_price_for_sale': 'Минимальная цена за м² для продажи',
                    'max_unit_price_for_rent': 'Максимальная цена за м² для аренды',
                    'min_unit_price_for_rent': 'Минимальная цена за м² для аренды',
                    'comparable_area_for_sale': 'Сопоставимая площадь для продажи',
                    'comparable_area_for_rent': 'Сопоставимая площадь для аренды',
                    'quantity_for_sale': 'Количество для продажи',
                    'quantity_for_rent': 'Количество для аренды',
                    'total_price_for_sale': 'Общая цена для продажи',
                    'total_price_for_rent': 'Общая цена для аренды',
                    'inventory_coefficient_for_sale': 'Коэффициент запаса для продажи',
                    'inventory_coefficient_for_rent': 'Коэффициент запаса для аренды',
                    'yield': 'Доходность',
                    'trend_date': 'Дата тренда',
                    'heating_type': 'Тип отопления',
                    'house_type': 'Количество спален',
                    'floor_segment': 'Этаж',
                    'age_category': 'Возрастная категория'
                },
                'en': {
                    'average_age_for_sale': 'Average age for sale (years)',
                    'average_age_for_rent': 'Average age for rent (years)',
                    'listing_period_for_sale': 'Listing period for sale (days)',
                    'listing_period_for_rent': 'Listing period for rent (days)',
                    'max_unit_price_for_sale': 'Maximum price per m² for sale',
                    'min_unit_price_for_sale': 'Minimum price per m² for sale',
                    'max_unit_price_for_rent': 'Maximum price per m² for rent',
                    'min_unit_price_for_rent': 'Minimum price per m² for rent',
                    'comparable_area_for_sale': 'Comparable area for sale',
                    'comparable_area_for_rent': 'Comparable area for rent',
                    'quantity_for_sale': 'Quantity for sale',
                    'quantity_for_rent': 'Quantity for rent',
                    'total_price_for_sale': 'Total price for sale',
                    'total_price_for_rent': 'Total price for rent',
                    'inventory_coefficient_for_sale': 'Inventory coefficient for sale',
                    'inventory_coefficient_for_rent': 'Inventory coefficient for rent',
                    'yield': 'Yield',
                    'trend_date': 'Trend date',
                    'heating_type': 'Heating type',
                    'house_type': 'Bedroom count',
                    'floor_segment': 'Floor',
                    'age_category': 'Age category'
                },
                'de': {
                    'average_age_for_sale': 'Durchschnittsalter für Verkauf (Jahre)',
                    'average_age_for_rent': 'Durchschnittsalter für Vermietung (Jahre)',
                    'listing_period_for_sale': 'Einstellungszeitraum für Verkauf (Tage)',
                    'listing_period_for_rent': 'Einstellungszeitraum für Vermietung (Tage)',
                    'max_unit_price_for_sale': 'Maximaler Preis pro m² für Verkauf',
                    'min_unit_price_for_sale': 'Minimaler Preis pro m² für Verkauf',
                    'max_unit_price_for_rent': 'Maximaler Preis pro m² für Vermietung',
                    'min_unit_price_for_rent': 'Minimaler Preis pro m² für Vermietung',
                    'comparable_area_for_sale': 'Vergleichbare Fläche für Verkauf',
                    'comparable_area_for_rent': 'Vergleichbare Fläche für Vermietung',
                    'quantity_for_sale': 'Menge für Verkauf',
                    'quantity_for_rent': 'Menge für Vermietung',
                    'total_price_for_sale': 'Gesamtpreis für Verkauf',
                    'total_price_for_rent': 'Gesamtpreis für Vermietung',
                    'inventory_coefficient_for_sale': 'Lagerkoeffizient für Verkauf',
                    'inventory_coefficient_for_rent': 'Lagerkoeffizient für Vermietung',
                    'yield': 'Rendite',
                    'trend_date': 'Trenddatum',
                    'heating_type': 'Heizungstyp',
                    'house_type': 'Schlafzimmer-Anzahl',
                    'floor_segment': 'Etage',
                    'age_category': 'Alterskategorie'
                },
                'fr': {
                    'average_age_for_sale': 'Âge moyen pour la vente (années)',
                    'average_age_for_rent': 'Âge moyen pour la location (années)',
                    'listing_period_for_sale': 'Période d\'inscription pour la vente (jours)',
                    'listing_period_for_rent': 'Période d\'inscription pour la location (jours)',
                    'max_unit_price_for_sale': 'Prix maximum par m² pour la vente',
                    'min_unit_price_for_sale': 'Prix minimum par m² pour la vente',
                    'max_unit_price_for_rent': 'Prix maximum par m² pour la location',
                    'min_unit_price_for_rent': 'Prix minimum par m² pour la location',
                    'comparable_area_for_sale': 'Zone comparable pour la vente',
                    'comparable_area_for_rent': 'Zone comparable pour la location',
                    'quantity_for_sale': 'Quantité pour la vente',
                    'quantity_for_rent': 'Quantité pour la location',
                    'total_price_for_sale': 'Prix total pour la vente',
                    'total_price_for_rent': 'Prix total pour la location',
                    'inventory_coefficient_for_sale': 'Coefficient d\'inventaire pour la vente',
                    'inventory_coefficient_for_rent': 'Coefficient d\'inventaire pour la location',
                    'yield': 'Rendement',
                    'trend_date': 'Date de tendance',
                    'heating_type': 'Type de chauffage',
                    'house_type': 'Nombre de chambres',
                    'floor_segment': 'Étage',
                    'age_category': 'Catégorie d\'âge'
                },
                'tr': {
                    'average_age_for_sale': 'Satış için ortalama yaş (yıl)',
                    'average_age_for_rent': 'Kiralama için ortalama yaş (yıl)',
                    'listing_period_for_sale': 'Satış için ilan süresi (gün)',
                    'listing_period_for_rent': 'Kiralama için ilan süresi (gün)',
                    'max_unit_price_for_sale': 'Satış için m² başına maksimum fiyat',
                    'min_unit_price_for_sale': 'Satış için m² başına minimum fiyat',
                    'max_unit_price_for_rent': 'Kiralama için m² başına maksimum fiyat',
                    'min_unit_price_for_rent': 'Kiralama için m² başına minimum fiyat',
                    'comparable_area_for_sale': 'Satış için karşılaştırılabilir alan',
                    'comparable_area_for_rent': 'Kiralama için karşılaştırılabilir alan',
                    'quantity_for_sale': 'Satış için miktar',
                    'quantity_for_rent': 'Kiralama için miktar',
                    'total_price_for_sale': 'Satış için toplam fiyat',
                    'total_price_for_rent': 'Kiralama için toplam fiyat',
                    'inventory_coefficient_for_sale': 'Satış için envanter katsayısı',
                    'inventory_coefficient_for_rent': 'Kiralama için envanter katsayısı',
                    'yield': 'Getiri',
                    'trend_date': 'Trend tarihi',
                    'heating_type': 'Isıtma tipi',
                    'house_type': 'Yatak odası sayısı',
                    'floor_segment': 'Kat',
                    'age_category': 'Yaş kategorisi'
                }
            };
            
            // Get label for current language
            const currentLabels = labels[userLanguage] || labels['ru'];
            return currentLabels[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Helper function to get locale based on selected country
        function getLocaleByCountry() {
            const userCountry = selectedLocation.country_name || '';
            const countryLower = userCountry.toLowerCase();
            
            if (countryLower.includes('turkey') || countryLower.includes('турция') || 
                countryLower.includes('türkiye') || countryLower.includes('türkei') || 
                countryLower.includes('turquie')) {
                return 'tr-TR';
            } else if (countryLower.includes('germany') || countryLower.includes('германия') || 
                       countryLower.includes('deutschland') || countryLower.includes('allemagne')) {
                return 'de-DE';
            } else if (countryLower.includes('france') || countryLower.includes('франция') || 
                       countryLower.includes('frankreich')) {
                return 'fr-FR';
            } else if (countryLower.includes('russia') || countryLower.includes('россия') || 
                       countryLower.includes('russland') || countryLower.includes('russie')) {
                return 'ru-RU';
            } else {
                return 'en-US'; // Default to English
            }
        }

        // Helper function to get listing type title
        function getListingTypeTitle(item, dataType, index) {
            // Try different possible field names for listing type
            const listingType = item.listing_type || item.listingType || item.type || item.name;
            
            if (listingType) {
                return listingType;
            }
            
            // If no listing type found, try to get it from the data structure
            if (dataType === 'house_type') {
                return item.house_type || item.house_type_name || getText('houseTypeDataTitle');
            } else if (dataType === 'floor_segment') {
                return item.floor_segment || item.floor_segment_name || getText('floorSegmentDataTitle');
            } else if (dataType === 'age') {
                return item.age_category || item.age_category_name || getText('ageDataTitle');
            } else if (dataType === 'heating') {
                return item.heating_type || item.heating_type_name || getText('heatingDataTitle');
            }
            
            // Fallback to localized index if nothing found
            const userLocale = getLocaleByCountry();
            if (userLocale === 'tr-TR') {
                return `Kayıt ${index + 1}`;
            } else if (userLocale === 'de-DE') {
                return `Eintrag ${index + 1}`;
            } else if (userLocale === 'fr-FR') {
                return `Enregistrement ${index + 1}`;
            } else if (userLocale === 'ru-RU') {
                return `Запись ${index + 1}`;
            } else {
                return `Record ${index + 1}`;
            }
        }

        // Helper function to format field values
        function formatFieldValue(key, value) {
            if (value === null || value === undefined) {
                return 'N/A';
            }
            
            // Get user's selected country for currency and locale formatting
            const userCountry = selectedLocation.country_name || '';
            const isTurkey = userCountry.toLowerCase().includes('turkey') || 
                           userCountry.toLowerCase().includes('турция') || 
                           userCountry.toLowerCase().includes('türkiye') ||
                           userCountry.toLowerCase().includes('türkei') ||
                           userCountry.toLowerCase().includes('turquie');
            
            const userLocale = getLocaleByCountry();
            
            // Format currency values
            if (key.includes('price') || key.includes('Price') || 
                key.includes('unit_price') || key.includes('Unit_Price') ||
                key.includes('avg_price') || key.includes('Avg_Price')) {
                if (typeof value === 'number') {
                    // Convert to selected currency if rates are available
                    const convertedValue = convertCurrency(value);
                    return formatCurrency(convertedValue, currentCurrency);
                }
                return value;
            }
            
            // Format percentage values
            if (key.includes('yield') || key.includes('Yield')) {
                if (typeof value === 'number') {
                    return `${parseFloat(value).toFixed(2)}%`;
                }
                return value;
            }
            
            // Format period values (days)
            if (key.includes('period') || key.includes('Period') || 
                key.includes('duration') || key.includes('Duration') ||
                key.includes('listing_period') || key.includes('Listing_Period')) {
                if (typeof value === 'number') {
                    if (isTurkey) {
                        return `${value} gün`;
                    } else if (userLocale === 'de-DE') {
                        return `${value} Tage`;
                    } else if (userLocale === 'fr-FR') {
                        return `${value} jours`;
                    } else if (userLocale === 'ru-RU') {
                        return `${value} дней`;
                    } else {
                        return `${value} days`;
                    }
                }
                return value;
            }
            
            // Format age values (years)
            if (key.includes('age') || key.includes('Age') ||
                key.includes('average_age') || key.includes('Average_Age')) {
                if (typeof value === 'number') {
                    if (isTurkey) {
                        return `${value} yıl`;
                    } else if (userLocale === 'de-DE') {
                        return `${value} Jahre`;
                    } else if (userLocale === 'fr-FR') {
                        return `${value} ans`;
                    } else if (userLocale === 'ru-RU') {
                        return `${value} лет`;
                    } else {
                        return `${value} years`;
                    }
                }
                return value;
            }
            
            // Format unit price values (price per m²)
            if (key.includes('unit_price') || key.includes('Unit_Price') ||
                key.includes('max_unit_price') || key.includes('Max_Unit_Price') ||
                key.includes('min_unit_price') || key.includes('Min_Unit_Price')) {
                if (typeof value === 'number') {
                    // Convert to selected currency if rates are available
                    const convertedValue = convertCurrency(value);
                    return formatCurrency(convertedValue, currentCurrency) + '/m²';
                }
                return value;
            }
            
            // Format area values (square meters)
            if (key.includes('area') || key.includes('Area') ||
                key.includes('comparable_area') || key.includes('Comparable_Area')) {
                if (typeof value === 'number') {
                    return `${value.toLocaleString(userLocale)} m²`;
                }
                return value;
            }
            
            // Format count values
            if (key.includes('count') || key.includes('Count') ||
                key.includes('count_for_rent') || key.includes('Count_For_Rent') ||
                key.includes('count_for_sale') || key.includes('Count_For_Sale')) {
                if (typeof value === 'number') {
                    return value.toLocaleString(userLocale);
                }
                return value.toString();
            }
            

            
            // Format date values
            if (key.includes('date') || key.includes('Date') || 
                key.includes('trend_date') || key.includes('Trend_Date')) {
                if (key.includes('trend_date') || key.includes('Trend_Date')) {
                    // For trend date, show current date minus 4 days
                    const currentDate = new Date();
                    currentDate.setDate(currentDate.getDate() - 4);
                    
                    if (userLocale === 'tr-TR') {
                        return currentDate.toLocaleDateString('tr-TR', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } else if (userLocale === 'de-DE') {
                        return currentDate.toLocaleDateString('de-DE', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } else if (userLocale === 'fr-FR') {
                        return currentDate.toLocaleDateString('fr-FR', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } else if (userLocale === 'ru-RU') {
                        return currentDate.toLocaleDateString('ru-RU', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    } else {
                        return currentDate.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                } else if (value && typeof value === 'string') {
                    try {
                        const date = new Date(value);
                        if (!isNaN(date.getTime())) {
                            return date.toLocaleDateString(userLocale, {
                                day: 'numeric',
                                month: 'short',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } catch (e) {
                        // If date parsing fails, return original value
                    }
                }
                return value;
            }
            
            return value.toString();
        }

        // Update page text based on current language
        function updatePageText() {
            document.getElementById('slogan').textContent = getText('slogan');
            document.getElementById('pageTitle').textContent = getText('pageTitle');
            document.getElementById('pageDescription').textContent = getText('pageDescription');
            document.getElementById('countryLabel').textContent = getText('countryLabel');
            document.getElementById('cityLabel').textContent = getText('cityLabel');
            document.getElementById('countyLabel').textContent = getText('countyLabel');
            document.getElementById('districtLabel').textContent = getText('districtLabel');
            document.getElementById('countryPlaceholder').textContent = getText('countryPlaceholder');
            document.getElementById('cityPlaceholder').textContent = getText('cityPlaceholder');
            document.getElementById('countyPlaceholder').textContent = getText('countyPlaceholder');
            document.getElementById('districtPlaceholder').textContent = getText('districtPlaceholder');
            document.getElementById('confirmButtonText').textContent = getText('confirmButtonText');
            document.getElementById('backButton').textContent = getText('backButton');
            document.getElementById('selectedLocationTitle').textContent = getText('selectedLocationTitle');
            document.getElementById('adminIdsTitle').textContent = getText('adminIdsTitle');
            
            // Update new data section elements
            const dataSectionTitle = document.getElementById('dataSectionTitle');
            if (dataSectionTitle) {
                dataSectionTitle.textContent = getText('dataSectionTitle');
            }
            
            const generalDataTitle = document.getElementById('generalDataTitle');
            if (generalDataTitle) {
                generalDataTitle.textContent = getText('generalDataTitle');
            }
            
            const houseTypeDataTitle = document.getElementById('houseTypeDataTitle');
            if (houseTypeDataTitle) {
                houseTypeDataTitle.textContent = getText('houseTypeDataTitle');
            }
            
            const floorSegmentDataTitle = document.getElementById('floorSegmentDataTitle');
            if (floorSegmentDataTitle) {
                floorSegmentDataTitle.textContent = getText('floorSegmentDataTitle');
            }
            
                        const ageDataTitle = document.getElementById('ageDataTitle');
            if (ageDataTitle) {
                ageDataTitle.textContent = getText('ageDataTitle');
            }

            const heatingDataTitle = document.getElementById('heatingDataTitle');
            if (heatingDataTitle) {
                heatingDataTitle.textContent = getText('heatingDataTitle');
            }

            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = getText('loadingText');
            }
            
            const errorText = document.getElementById('errorText');
            if (errorText) {
                errorText.textContent = getText('errorText');
            }
            
            // Update key metrics labels
            const keyMetricsTitle = document.getElementById('keyMetricsTitle');
            if (keyMetricsTitle) {
                keyMetricsTitle.textContent = getText('keyMetricsTitle');
            }
            
            const avgSalePriceLabel = document.getElementById('avgSalePriceLabel');
            if (avgSalePriceLabel) {
                avgSalePriceLabel.textContent = getText('avgSalePriceLabel');
            }
            
            const avgRentPriceLabel = document.getElementById('avgRentPriceLabel');
            if (avgRentPriceLabel) {
                avgRentPriceLabel.textContent = getText('avgRentPriceLabel');
            }
            
            const listingPeriodSaleLabel = document.getElementById('listingPeriodSaleLabel');
            if (listingPeriodSaleLabel) {
                listingPeriodSaleLabel.textContent = getText('listingPeriodSaleLabel');
            }
            
            const listingPeriodRentLabel = document.getElementById('listingPeriodRentLabel');
            if (listingPeriodRentLabel) {
                listingPeriodRentLabel.textContent = getText('listingPeriodRentLabel');
            }
            
            const yieldLabel = document.getElementById('yieldLabel');
            if (yieldLabel) {
                yieldLabel.textContent = getText('yieldLabel');
            }
            
            // Update insights title
            const insightsTitle = document.getElementById('insightsTitle');
            if (insightsTitle) {
                insightsTitle.textContent = getText('insightsTitle');
            }
            
            // Update insights loading and error text
            const insightsLoadingText = document.getElementById('insightsLoadingText');
            if (insightsLoadingText) {
                insightsLoadingText.textContent = getText('insightsLoading');
            }
            
            const insightsErrorText = document.getElementById('insightsErrorText');
            if (insightsErrorText) {
                insightsErrorText.textContent = getText('insightsError');
            }
        }

        // Load countries from API
        async function loadCountries() {
            try {
                const response = await fetch('/api/locations/countries');
                const data = await response.json();
                
                if (data.success) {
                    const countrySelect = document.getElementById('countrySelect');
                    countrySelect.innerHTML = `<option value="">${getText('countryPlaceholder')}</option>`;
                    
                    data.countries.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        countrySelect.appendChild(option);
                    });
                } else {
                    console.error('Failed to load countries:', data.error);
                }
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // Load cities based on selected country
        async function loadCities(countryId) {
            try {
                const response = await fetch('/api/locations/cities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ country_id: countryId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = `<option value="">${getText('cityPlaceholder')}</option>`;
                    
                    data.cities.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        citySelect.appendChild(option);
                    });
                    
                    citySelect.disabled = false;
                } else {
                    console.error('Failed to load cities:', data.error);
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Load counties based on selected city
        async function loadCounties(cityId) {
            try {
                const response = await fetch('/api/locations/counties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ city_id: cityId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const countySelect = document.getElementById('countySelect');
                    countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
                    
                    data.counties.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        countySelect.appendChild(option);
                    });
                    
                    countySelect.disabled = false;
                } else {
                    console.error('Failed to load counties:', data.error);
                }
            } catch (error) {
                console.error('Error loading counties:', error);
            }
        }

        // Load districts based on selected county
        async function loadDistricts(countyId) {
            try {
                const response = await fetch('/api/locations/districts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ county_id: countyId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const districtSelect = document.getElementById('districtSelect');
                    districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
                    
                    // Add "No value" option
                    const noValueOption = document.createElement('option');
                    noValueOption.value = 'none';
                    noValueOption.textContent = getText('noDistrictOption');
                    districtSelect.appendChild(noValueOption);
                    
                    data.districts.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        districtSelect.appendChild(option);
                    });
                    
                    districtSelect.disabled = false;
                } else {
                    console.error('Failed to load districts:', data.error);
                }
            } catch (error) {
                console.error('Error loading districts:', error);
            }
        }

        // Handle country selection change
        function onCountryChange() {
            const countrySelect = document.getElementById('countrySelect');
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countryId = countrySelect.value;
            const countryName = countrySelect.options[countrySelect.selectedIndex].text;
            
            // Reset dependent selects
            citySelect.innerHTML = `<option value="">${getText('cityPlaceholder')}</option>`;
            citySelect.disabled = true;
            countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
            countySelect.disabled = true;
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Update selected location
            selectedLocation.country_id = countryId;
            selectedLocation.country_name = countryName;
            selectedLocation.city_id = null;
            selectedLocation.city_name = '';
            selectedLocation.county_id = null;
            selectedLocation.county_name = '';
            selectedLocation.district_id = null;
            selectedLocation.district_name = '';
            
            // Load cities if country is selected
            if (countryId) {
                loadCities(countryId);
            }
            
            updateConfirmButton();
        }

        // Handle city selection change
        function onCityChange() {
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const cityId = citySelect.value;
            const cityName = citySelect.options[citySelect.selectedIndex].text;
            
            // Reset dependent selects
            countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
            countySelect.disabled = true;
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Update selected location
            selectedLocation.city_id = cityId;
            selectedLocation.city_name = cityName;
            selectedLocation.county_id = null;
            selectedLocation.county_name = '';
            selectedLocation.district_id = null;
            selectedLocation.district_name = '';
            
            // Load counties if city is selected
            if (cityId) {
                loadCounties(cityId);
            }
            
            updateConfirmButton();
        }

        // Handle county selection change
        function onCountyChange() {
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countyId = countySelect.value;
            const countyName = countySelect.options[countySelect.selectedIndex].text;
            
            // Reset dependent selects
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Update selected location
            selectedLocation.county_id = countyId;
            selectedLocation.county_name = countyName;
            selectedLocation.district_id = null;
            selectedLocation.district_name = '';
            
            // Load districts if county is selected
            if (countyId) {
                loadDistricts(countyId);
            }
            
            updateConfirmButton();
        }

        // Handle district selection change
        function onDistrictChange() {
            const districtSelect = document.getElementById('districtSelect');
            
            const districtId = districtSelect.value;
            const districtName = districtSelect.options[districtSelect.selectedIndex].text;
            
            // Update selected location
            selectedLocation.district_id = districtId === 'none' ? null : districtId;
                            selectedLocation.district_name = districtId === 'none' ? getText('noDistrictOption') : districtName;
            
            updateConfirmButton();
        }

        // Update confirm button state
        function updateConfirmButton() {
            const confirmButton = document.getElementById('confirmButton');
            const hasSelection = selectedLocation.country_id && 
                               selectedLocation.city_id && 
                               selectedLocation.county_id;
            
            confirmButton.disabled = !hasSelection;
        }

        // Confirm location selection
        function confirmLocationSelection() {
            if (!selectedLocation.country_id || !selectedLocation.city_id || !selectedLocation.county_id) {
                return;
            }
            
            // Show selected location
            const selectedLocationDiv = document.getElementById('selectedLocation');
            const selectedLocationText = document.getElementById('selectedLocationText');
            const adminIdsDiv = document.getElementById('adminIds');
            const adminIdsText = document.getElementById('adminIdsText');
            
            // Build location text
            let locationText = `${selectedLocation.country_name}`;
            if (selectedLocation.city_name) {
                locationText += `, ${selectedLocation.city_name}`;
            }
            if (selectedLocation.county_name) {
                locationText += `, ${selectedLocation.county_name}`;
            }
            if (selectedLocation.district_name && selectedLocation.district_id !== 'none') {
                locationText += `, ${selectedLocation.district_name}`;
            }
            
            selectedLocationText.textContent = locationText;
            
            // Build admin IDs text
            let adminIdsString = `country_id: ${selectedLocation.country_id}\n`;
            adminIdsString += `city_id: ${selectedLocation.city_id}\n`;
            adminIdsString += `county_id: ${selectedLocation.county_id}\n`;
            if (selectedLocation.district_id && selectedLocation.district_id !== 'none') {
                adminIdsString += `district_id: ${selectedLocation.district_id}`;
            } else {
                adminIdsString += `district_id: none`;
            }
            
            adminIdsText.textContent = adminIdsString;
            
            // Show the selected location section
            selectedLocationDiv.classList.add('show');
            adminIdsDiv.style.display = 'block';
            
            // Set default currency based on selected country
            setDefaultCurrency();
            
            // Get user language and load region data
            getUserLanguage().then(() => {
                loadRegionData();
            });
        }

        // Load region data from API
        async function loadRegionData() {
            try {
                // Show data section and loading state
                const regionDataSection = document.getElementById('regionDataSection');
                const loadingState = document.getElementById('loadingState');
                const dataContent = document.getElementById('dataContent');
                const errorState = document.getElementById('errorState');
                
                regionDataSection.style.display = 'block';
                loadingState.style.display = 'block';
                dataContent.style.display = 'none';
                errorState.style.display = 'none';
                
                // Hide currency switcher and key metrics section during loading
                const currencySwitcher = document.getElementById('currencySwitcher');
                const keyMetricsSection = document.getElementById('keyMetricsSection');
                if (currencySwitcher) {
                    currencySwitcher.style.display = 'none';
                }
                if (keyMetricsSection) {
                    keyMetricsSection.style.display = 'none';
                }
                
                // Prepare request data
                const requestData = {
                    country_id: selectedLocation.country_id,
                    city_id: selectedLocation.city_id,
                    county_id: selectedLocation.county_id,
                    district_id: selectedLocation.district_id
                };
                
                // Make API request
                const response = await fetch('/api/region_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log('Raw API response:', data);
                
                if (data.success) {
                    // Hide loading state
                    loadingState.style.display = 'none';
                    
                    // Check if data is a string that needs parsing
                    let processedData = data;
                    if (typeof data.data === 'string') {
                        try {
                            processedData = JSON.parse(data.data);
                            console.log('Parsed data from string:', processedData);
                        } catch (e) {
                            console.log('Failed to parse data string:', e);
                            processedData = data;
                        }
                    } else if (data.data && typeof data.data === 'object') {
                        // If data is in data field
                        processedData = data.data;
                        console.log('Data found in data field:', processedData);
                    } else if (data.result && typeof data.result === 'object') {
                        // If data is in result field
                        processedData = data.result;
                        console.log('Data found in result field:', processedData);
                    } else if (data.response && typeof data.response === 'object') {
                        // If data is in response field
                        processedData = data.response;
                        console.log('Data found in response field:', processedData);
                    }
                    
                    // Save data to global variables for currency recalculation
                    window.lastRegionData = processedData;
                    if (processedData.general_data && processedData.general_data.length > 0) {
                        window.lastGeneralData = processedData.general_data;
                        console.log('Saved general data to window.lastGeneralData:', window.lastGeneralData);
                    } else {
                        console.log('No general data found in processedData:', processedData);
                    }
                    
                    // Display data
                    displayRegionData(processedData);
                    
                    // Show data content
                    dataContent.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Error loading region data:', error);
                
                // Hide loading state
                document.getElementById('loadingState').style.display = 'none';
                
                // Show error state
                const errorState = document.getElementById('errorState');
                const errorText = document.getElementById('errorText');
                errorText.textContent = getText('errorText');
                errorState.style.display = 'block';
            }
        }

        // Fill key metrics with data from general data
        function fillKeyMetrics(generalData) {
            console.log('Filling key metrics with data:', generalData);
            console.log('Type of generalData:', typeof generalData);
            console.log('Is Array:', Array.isArray(generalData));
            
            if (!generalData) {
                console.log('No general data available for key metrics');
                return;
            }
            
            let data;
            if (Array.isArray(generalData)) {
                if (generalData.length === 0) {
                    console.log('General data array is empty');
                    return;
                }
                data = generalData[0];
                console.log('Using first element from array:', data);
            } else {
                data = generalData;
                console.log('Using generalData directly as object:', data);
            }
            console.log('Using general data record for key metrics:', data);
            console.log('Available fields in general data:', Object.keys(data));
            console.log('Looking for price fields...');
            
            // Log all fields that might contain price information
            Object.keys(data).forEach(key => {
                if (key.toLowerCase().includes('price') || key.toLowerCase().includes('цена')) {
                    console.log(`Found price-related field: ${key} = ${data[key]}`);
                }
            });
            
            // Log specific fields we're looking for
            console.log('🔍 Looking for correct price per m² fields from general_data table:');
            console.log('unit_price_for_sale:', data.unit_price_for_sale);
            console.log('unit_price_for_rent:', data.unit_price_for_rent);
            console.log('listing_period_for_sale:', data.listing_period_for_sale);
            console.log('listing_period_for_rent:', data.listing_period_for_rent);
            
            // Extract and display key metrics
            let avgSalePrice = '-';
            let avgRentPrice = '-';
            let listingPeriodSale = '-';
            let listingPeriodRent = '-';
            let yield = '-';
            
            // Use the correct field names from general_data table (Цена за м² для продажи)
            if (data.unit_price_for_sale !== null && data.unit_price_for_sale !== undefined) {
                avgSalePrice = formatFieldValue('unit_price_for_sale', data.unit_price_for_sale);
            }
            
            // Log current currency for debugging
            console.log('Current currency for key metrics:', currentCurrency);
            console.log('Currency rates available:', currencyRates);
            
            // Use the correct field names from general_data table (Цена за м² для аренды)
            if (data.unit_price_for_rent !== null && data.unit_price_for_rent !== undefined) {
                avgRentPrice = formatFieldValue('unit_price_for_rent', data.unit_price_for_rent);
            }
            
            // Log extracted values for debugging
            console.log('📊 Extracted key metrics values:');
            console.log('avgSalePrice:', avgSalePrice);
            console.log('avgRentPrice:', avgRentPrice);
            
            // If we still don't have the right values, try to find them in the data
            if (avgSalePrice === '-' || avgRentPrice === '-') {
                console.log('🔍 Still missing values, searching for price per m² fields...');
                Object.keys(data).forEach(key => {
                    if (key.toLowerCase().includes('m2') || key.toLowerCase().includes('m²') || key.toLowerCase().includes('per_m2')) {
                        console.log(`Found m² field: ${key} = ${data[key]}`);
                    }
                });
            }
            
            // Use the correct field names from general_data table
            if (data.listing_period_for_sale !== null && data.listing_period_for_sale !== undefined) {
                listingPeriodSale = formatFieldValue('listing_period_for_sale', data.listing_period_for_sale);
            }
            
            // Use the correct field names from general_data table
            if (data.listing_period_for_rent !== null && data.listing_period_for_rent !== undefined) {
                listingPeriodRent = formatFieldValue('listing_period_for_rent', data.listing_period_for_rent);
            }
            
            // Try to find yield
            if (data.yield !== null && data.yield !== undefined) {
                yield = formatFieldValue('yield', data.yield);
            } else if (data.yield_rate !== null && data.yield_rate !== undefined) {
                yield = formatFieldValue('yield_rate', data.yield_rate);
            } else if (data.return_rate !== null && data.return_rate !== undefined) {
                yield = formatFieldValue('return_rate', data.return_rate);
            }
            
            // Update the DOM elements
            document.getElementById('avgSalePrice').textContent = avgSalePrice;
            document.getElementById('avgRentPrice').textContent = avgRentPrice;
            document.getElementById('listingPeriodSale').textContent = listingPeriodSale;
            document.getElementById('listingPeriodRent').textContent = listingPeriodRent;
            document.getElementById('yieldValue').textContent = yield;
            
            // Show the currency switcher and key metrics section
            document.getElementById('currencySwitcher').style.display = 'block';
            document.getElementById('keyMetricsSection').style.display = 'block';
            
            // Load currency rates
            getCurrencyRates();
            
            console.log('Key metrics filled:', {
                avgSalePrice,
                avgRentPrice,
                listingPeriodSale,
                listingPeriodRent,
                yield
            });
        }

        // Get AI insights for the region data
        async function getRegionInsights(regionData) {
            try {
                console.log('🧠 Запрашиваем AI-вывод для данных региона');
                
                // Show insights section
                const insightsSection = document.getElementById('insightsSection');
                const insightsLoading = document.getElementById('insightsLoading');
                const insightsText = document.getElementById('insightsText');
                const insightsError = document.getElementById('insightsError');
                
                insightsSection.style.display = 'block';
                insightsLoading.style.display = 'flex';
                insightsText.style.display = 'none';
                insightsError.style.display = 'none';
                
                // Update loading text based on user language
                const loadingText = document.getElementById('insightsLoadingText');
                loadingText.textContent = getText('insightsLoading');
                
                // Prepare data for AI analysis
                const analysisData = {
                    region_data: regionData,
                    language: userLanguage
                };
                
                // Make API request to get AI insights
                const response = await fetch('/api/region_insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(analysisData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Hide loading and show insights
                    insightsLoading.style.display = 'none';
                    insightsText.style.display = 'block';
                    
                    // Update insights text
                    const insightsTextElement = document.getElementById('insightsText');
                    insightsTextElement.textContent = data.insights;
                    
                    console.log('✅ AI-вывод получен:', data.insights);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('❌ Ошибка получения AI-вывода:', error);
                
                // Hide loading and show error
                const insightsLoading = document.getElementById('insightsLoading');
                const insightsError = document.getElementById('insightsError');
                const insightsErrorText = document.getElementById('insightsErrorText');
                
                insightsLoading.style.display = 'none';
                insightsError.style.display = 'flex';
                insightsErrorText.textContent = getText('insightsError');
            }
        }

        // Display region data (all data blocks are automatically sorted for logical display order)
        // Data within each block is structured by priority: key metrics → price ranges → other fields
        function displayRegionData(data) {
            console.log('Received data:', data);
            console.log('General data:', data.general_data);
            console.log('House type data:', data.house_type_data);
            console.log('Floor segment data:', data.floor_segment_data);
            console.log('Age data:', data.age_data);
            console.log('Heating data:', data.heating_data);
            
            // Try different possible key names for data
            const generalData = data.general_data || data.generalData || data.general || data.general_data || [];
            const houseTypeData = data.house_type_data || data.houseTypeData || data.house_types || data.houseTypes || data.house_type_data || [];
            const floorSegmentData = data.floor_segment_data || data.floorSegmentData || data.floor_segments || data.floorSegments || data.floor_segment_data || [];
            const ageData = data.age_data || data.ageData || data.ages || data.age_data || [];
            const heatingData = data.heating_data || data.heatingData || data.heating || data.heating_data || [];
            
            // If no data found in specific fields, try to find any data in the object
            if (!generalData || generalData.length === 0) {
                console.log('No general data found in specific fields, searching in object...');
                for (const key in data) {
                    if (key.includes('general') || key.includes('General')) {
                        console.log(`Found potential general data in key: ${key}`, data[key]);
                    }
                }
            }
            
            if (!houseTypeData || houseTypeData.length === 0) {
                console.log('No house type data found in specific fields, searching in object...');
                for (const key in data) {
                    if (key.includes('house') || key.includes('House') || key.includes('type') || key.includes('Type')) {
                        console.log(`Found potential house type data in key: ${key}`, data[key]);
                    }
                }
            }
            
            if (!floorSegmentData || floorSegmentData.length === 0) {
                console.log('No floor segment data found in specific fields, searching in object...');
                for (const key in data) {
                    if (key.includes('floor') || key.includes('Floor') || key.includes('segment') || key.includes('Segment')) {
                        console.log(`Found potential floor segment data in key: ${key}`, data[key]);
                    }
                }
            }
            
            if (!ageData || ageData.length === 0) {
                console.log('No age data found in specific fields, searching in object...');
                for (const key in data) {
                    if (key.includes('age') || key.includes('Age')) {
                        console.log(`Found potential age data in key: ${key}`, data[key]);
                    }
                }
            }
            
            if (!heatingData || heatingData.length === 0) {
                console.log('No heating data found in specific fields, searching in object...');
                for (const key in data) {
                    if (key.includes('heating') || key.includes('Heating')) {
                        console.log(`Found potential heating data in key: ${key}`, data[key]);
                    }
                }
            }
            
            console.log('Processed general data:', generalData);
            console.log('Processed house type data:', houseTypeData);
            console.log('Processed floor segment data:', floorSegmentData);
            console.log('Processed age data:', ageData);
            console.log('Processed heating data:', heatingData);
            
            // Fill key metrics with data
            if (generalData && generalData.length > 0) {
                fillKeyMetrics(generalData);
            } else {
                console.log('No general data available for key metrics');
            }
            
            // Get AI insights for the region data
            getRegionInsights(data);
            
            // If data is an array, try to categorize it by content
            if (Array.isArray(data) && data.length > 0) {
                console.log('Data is an array, attempting to categorize...');
                const firstItem = data[0];
                console.log('First item in array:', firstItem);
                
                if (firstItem && typeof firstItem === 'object') {
                    const keys = Object.keys(firstItem);
                    console.log('Keys in first item:', keys);
                    
                    // Try to determine the type of data based on keys
                    if (keys.some(key => key.includes('house') || key.includes('type'))) {
                        console.log('Array appears to contain house type data');
                        houseTypeData = data;
                    } else if (keys.some(key => key.includes('floor') || key.includes('segment'))) {
                        console.log('Array appears to contain floor segment data');
                        floorSegmentData = data;
                    } else if (keys.some(key => key.includes('age'))) {
                        console.log('Array appears to contain age data');
                        ageData = data;
                    } else if (keys.some(key => key.includes('heating'))) {
                        console.log('Array appears to contain heating data');
                        heatingData = data;
                    } else {
                        console.log('Array appears to contain general data');
                        generalData = data;
                    }
                }
            }
            
            // Display general data
            displayGeneralData(generalData);
            
            // Display bedroom count data
            displayHouseTypeData(houseTypeData);
            
            // Display floor data
            displayFloorSegmentData(floorSegmentData);
            
            // Display age data
            displayAgeData(ageData);

            // Display heating type data
            displayHeatingData(heatingData);
            
            // All accordions are collapsed by default after data formation
            // No auto-expansion needed
        }

        // Display region data without re-fetching insights (for currency changes)
        function displayRegionDataWithoutInsights(data) {
            console.log('Displaying region data without re-fetching insights:', data);
            
            // Try different possible key names for data
            const generalData = data.general_data || data.generalData || data.general || data.general_data || [];
            const houseTypeData = data.house_type_data || data.houseTypeData || data.house_types || data.houseTypes || data.house_type_data || [];
            const floorSegmentData = data.floor_segment_data || data.floorSegmentData || data.floor_segments || data.floorSegments || data.floor_segment_data || [];
            const ageData = data.age_data || data.ageData || data.ages || data.age_data || [];
            const heatingData = data.heating_data || data.heatingData || data.heating || data.heating_data || [];
            
            // Fill key metrics with data
            if (generalData && generalData.length > 0) {
                fillKeyMetrics(generalData);
            } else {
                console.log('No general data available for key metrics');
            }
            
            // Display all data blocks (but don't call getRegionInsights)
            displayGeneralData(generalData);
            displayHouseTypeData(houseTypeData);
            displayFloorSegmentData(floorSegmentData);
            displayAgeData(ageData);
            displayHeatingData(heatingData);
        }

        // Display general data (structured by priority: sale → rent → yield → other)
        function displayGeneralData(generalData) {
            const content = document.getElementById('generalDataContent');
            
            if (!generalData || generalData.length === 0) {
                content.innerHTML = `<div class="no-data">${getText('noDataAvailable')}</div>`;
                return;
            }
            
            const data = generalData[0]; // Take first record
            
            // Get all available fields and sort them by priority
            const availableFields = Object.keys(data).filter(key => 
                !['country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file', 'updated_at'].includes(key) &&
                data[key] !== null && data[key] !== undefined
            );
            
            const sortedFields = sortFieldsByPriority(availableFields);
            console.log('Sorted general data fields:', sortedFields);
            
            // Create table HTML with structured display
            let tableHtml = '<table class="data-table">';
            tableHtml = displayFieldsWithStructuredHeaders(sortedFields, data, tableHtml);
            tableHtml += '</table>';
            
            // Add footer with trend date if available
            let footerHtml = '';
            if (data.trend_date) {
                footerHtml = '<div class="data-footer">';
                const trendDate = formatFieldValue('trend_date', data.trend_date);
                footerHtml += `<span>Trend Date: ${trendDate}</span>`;
                footerHtml += '</div>';
            }
            
            content.innerHTML = tableHtml + footerHtml;
        }

        // Display bedroom count data (sorted by bedroom count: 1+1, 2+1, 3+1, etc.)
        function displayHouseTypeData(houseTypeData) {
            const content = document.getElementById('houseTypeDataContent');
            
            console.log('House type data:', houseTypeData);
            console.log('House type data type:', typeof houseTypeData);
            console.log('House type data length:', houseTypeData ? houseTypeData.length : 'undefined');
            
            if (!houseTypeData || houseTypeData.length === 0) {
                console.log('No house type data available, showing no data message');
                content.innerHTML = `<div class="no-data">${getText('noDataAvailable')}</div>`;
                return;
            }
            
            // Sort house type data by bedroom count in logical order: 1+1, 2+1, 3+1, 4+1, etc.
            const sortedHouseTypeData = [...houseTypeData].sort((a, b) => {
                // Extract bedroom count from listing_type or type field
                const getBedroomCount = (item) => {
                    const typeField = item.listing_type || item.type || item.house_type || item.house_type_name || item.name || '';
                    // Extract number from strings like "1+1", "2+1", "3+1", etc.
                    const match = typeField.match(/(\d+)\+(\d+)/);
                    if (match) {
                        const bedrooms = parseInt(match[1]);
                        const livingRooms = parseInt(match[2]);
                        return bedrooms * 10 + livingRooms; // Sort by bedrooms first, then living rooms
                    }
                    // For other formats, try to extract just the first number
                    const singleMatch = typeField.match(/(\d+)/);
                    if (singleMatch) {
                        return parseInt(singleMatch[1]);
                    }
                    return 999; // Put unknown formats at the end
                };
                
                return getBedroomCount(a) - getBedroomCount(b);
            });

            console.log('Sorted house type data:', sortedHouseTypeData);

            let html = '';
            
            sortedHouseTypeData.forEach((item, index) => {
                console.log(`House type item ${index}:`, item);
                // Try different possible field names
                const typeField = item.house_type || item.type || item.house_type_name || item.name;
                console.log(`Type field for item ${index}:`, typeField);
                
                if (typeField) {
                    html += `<div class="sub-card">
                        <h3>${typeField}</h3>
                        <table class="data-table">`;
                    
                    // Get all available fields and sort them by priority
                    const availableFields = Object.keys(item).filter(key => 
                        !['house_type', 'type', 'house_type_name', 'name', 'country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file', 'updated_at'].includes(key) &&
                        item[key] !== null && item[key] !== undefined
                    );
                    
                    const sortedFields = sortFieldsByPriority(availableFields);
                    console.log(`Sorted fields for item ${index}:`, sortedFields);
                    
                    // Add fields in priority order with structured headers
                    html = displayFieldsWithStructuredHeaders(sortedFields, item, html);
                    
                    html += '</table></div>';
                } else {
                    console.log(`No type field found for item ${index}, showing all fields`);
                    // If no type field found, show all available fields
                    const fallbackTitle = getListingTypeTitle(item, 'house_type', index);
                    html += `<div class="sub-card">
                        <h3>${fallbackTitle}</h3>
                        <table class="data-table">`;
                    
                    // Get all available fields and sort them by priority
                    const availableFields = Object.keys(item).filter(key => 
                        !['country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file', 'updated_at'].includes(key) &&
                        item[key] !== null && item[key] !== undefined
                    );
                    
                    const sortedFields = sortFieldsByPriority(availableFields);
                    console.log(`Sorted fields for fallback item ${index}:`, sortedFields);
                    
                    // Add fields in priority order with structured headers
                    html = displayFieldsWithStructuredHeaders(sortedFields, item, html);
                    
                    html += '</table></div>';
                }
            });
            
            console.log('Final HTML for house type data:', html);
            content.innerHTML = html;
        }

        // Display floor data (sorted by floor range: Ground, 1-5, 6-10, 11-15, etc.)
        function displayFloorSegmentData(floorSegmentData) {
            const content = document.getElementById('floorSegmentDataContent');
            
            console.log('Floor segment data:', floorSegmentData);
            console.log('Floor segment data type:', typeof floorSegmentData);
            console.log('Floor segment data length:', floorSegmentData ? floorSegmentData.length : 'undefined');
            
            if (!floorSegmentData || floorSegmentData.length === 0) {
                console.log('No floor segment data available, showing no data message');
                content.innerHTML = `<div class="no-data">${getText('noDataAvailable')}</div>`;
                return;
            }
            
            // Sort floor segment data by floor range in logical order: Ground, 1-5, 6-10, 11-15, etc.
            const sortedFloorSegmentData = [...floorSegmentData].sort((a, b) => {
                // Extract floor range from listing_type or type field
                const getFloorRange = (item) => {
                    const segmentField = item.listing_type || item.type || item.floor_segment || item.segment || item.floor_segment_name || item.name || '';
                    if (segmentField.toLowerCase().includes('ground') || segmentField.toLowerCase().includes('земля')) return 1;
                    if (segmentField.includes('1-5')) return 2;
                    if (segmentField.includes('6-10')) return 3;
                    if (segmentField.includes('11-15')) return 4;
                    if (segmentField.includes('16-20')) return 5;
                    if (segmentField.includes('21-25')) return 6;
                    if (segmentField.includes('26-30')) return 7;
                    // For other formats, try to extract just the first number
                    const singleMatch = segmentField.match(/(\d+)/);
                    if (singleMatch) {
                        return parseInt(singleMatch[1]) + 10; // Add offset to put after predefined ranges
                    }
                    return 999; // Put unknown formats at the end
                };
                
                return getFloorRange(a) - getFloorRange(b);
            });

            console.log('Sorted floor segment data:', sortedFloorSegmentData);

            let html = '';
            
            sortedFloorSegmentData.forEach((item, index) => {
                console.log(`Floor segment item ${index}:`, item);
                // Try different possible field names
                const segmentField = item.floor_segment || item.segment || item.floor_segment_name || item.name;
                console.log(`Segment field for item ${index}:`, segmentField);
                
                if (segmentField) {
                    html += `<div class="sub-card">
                        <h3>${segmentField}</h3>
                        <table class="data-table">`;
                    
                    // Get all available fields and sort them by priority
                    const availableFields = Object.keys(item).filter(key => 
                        !['floor_segment', 'segment', 'floor_segment_name', 'name', 'country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file', 'updated_at'].includes(key) &&
                        item[key] !== null && item[key] !== undefined
                    );
                    
                    const sortedFields = sortFieldsByPriority(availableFields);
                    console.log(`Sorted fields for floor segment item ${index}:`, sortedFields);
                    
                    // Add fields in priority order with structured headers
                    html = displayFieldsWithStructuredHeaders(sortedFields, item, html);
                    
                    html += '</table></div>';
                } else {
                    console.log(`No segment field found for item ${index}, showing all fields`);
                    // If no segment field found, show all available fields
                    const fallbackTitle = getListingTypeTitle(item, 'floor_segment', index);
                    html += `<div class="sub-card">
                        <h3>${fallbackTitle}</h3>
                        <table class="data-table">`;
                    
                    // Get all available fields and sort them by priority
                    const availableFields = Object.keys(item).filter(key => 
                        !['country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file', 'updated_at'].includes(key) &&
                        item[key] !== null && item[key] !== undefined
                    );
                    
                    const sortedFields = sortFieldsByPriority(availableFields);
                    console.log(`Sorted fields for floor segment fallback item ${index}:`, sortedFields);
                    
                    // Add fields in priority order with structured headers
                    html = displayFieldsWithStructuredHeaders(sortedFields, item, html);
                    
                    html += '</table></div>';
                }
            });
            
            console.log('Final HTML for floor segment data:', html);
            content.innerHTML = html;
        }

                // Display age data (sorted by age range: 0-4, 5-10, 11-15)
        function displayAgeData(ageData) {
            const content = document.getElementById('ageDataContent');

            console.log('Age data:', ageData);
            console.log('Age data type:', typeof ageData);
            console.log('Age data length:', ageData ? ageData.length : 'undefined');

            if (!ageData || ageData.length === 0) {
                console.log('No age data available, showing no data message');
                content.innerHTML = `<div class="no-data">${getText('noDataAvailable')}</div>`;
                return;
            }

            // Sort age data by age range in correct order: 0-4, 5-10, 11-15
            const sortedAgeData = [...ageData].sort((a, b) => {
                // Extract age range from listing_type or type field
                const getAgeRange = (item) => {
                    const ageField = item.listing_type || item.type || item.age_category || item.age || item.age_category_name || item.name || '';
                    if (ageField.includes('0-4')) return 1;
                    if (ageField.includes('5-10')) return 2;
                    if (ageField.includes('11-15')) return 3;
                    return 4; // For any other values
                };
                
                return getAgeRange(a) - getAgeRange(b);
            });

            console.log('Sorted age data:', sortedAgeData);

            let html = '';

            sortedAgeData.forEach((item, index) => {
                console.log(`Age item ${index}:`, item);
                // Try different possible field names
                const ageField = item.age_category || item.age || item.age_category_name || item.name;
                console.log(`Age field for item ${index}:`, ageField);
                
                if (ageField) {
                    html += `<div class="sub-card">
                        <h3>${ageField}</h3>
                        <table class="data-table">`;
                    
                    // Get all available fields and sort them by priority
                    const availableFields = Object.keys(item).filter(key => 
                        !['age_category', 'age', 'age_category_name', 'name', 'country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file'].includes(key) &&
                        item[key] !== null && item[key] !== undefined
                    );
                    
                    const sortedFields = sortFieldsByPriority(availableFields);
                    console.log(`Sorted fields for age item ${index}:`, sortedFields);
                    
                    // Add fields in priority order with structured headers
                    html = displayFieldsWithStructuredHeaders(sortedFields, item, html);
                    
                    html += '</table></div>';
                } else {
                    console.log(`No age field found for item ${index}, showing all fields`);
                    // If no age field found, show all available fields
                    const fallbackTitle = getListingTypeTitle(item, 'age', index);
                    html += `<div class="sub-card">
                        <h3>${fallbackTitle}</h3>
                        <table class="data-table">`;
                    
                    // Get all available fields and sort them by priority
                    const availableFields = Object.keys(item).filter(key => 
                        !['country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file', 'updated_at'].includes(key) &&
                        item[key] !== null && item[key] !== undefined
                    );
                    
                    const sortedFields = sortFieldsByPriority(availableFields);
                    console.log(`Sorted fields for age fallback item ${index}:`, sortedFields);
                    
                    // Add fields in priority order with structured headers
                    html = displayFieldsWithStructuredHeaders(sortedFields, item, html);
                    
                    html += '</table></div>';
                }
            });

            console.log('Final HTML for age data:', html);
            content.innerHTML = html;
        }

        // Display heating type data (sorted by priority: Central, Individual, Natural Gas, etc.)
        function displayHeatingData(heatingData) {
            const content = document.getElementById('heatingDataContent');

            console.log('Heating data:', heatingData);
            console.log('Heating data type:', typeof heatingData);
            console.log('Heating data length:', heatingData ? heatingData.length : 'undefined');

            if (!heatingData || heatingData.length === 0) {
                console.log('No heating data available, showing no data message');
                content.innerHTML = `<div class="no-data">${getText('noDataAvailable')}</div>`;
                return;
            }

            // Sort heating data by type in logical order: Central, Individual, Natural Gas, etc.
            const sortedHeatingData = [...heatingData].sort((a, b) => {
                // Extract heating type from listing_type or type field
                const getHeatingPriority = (item) => {
                    const heatingField = item.listing_type || item.type || item.heating_type || item.heating || item.heating_type_name || item.name || '';
                    const fieldLower = heatingField.toLowerCase();
                    if (fieldLower.includes('central') || fieldLower.includes('центральное')) return 1;
                    if (fieldLower.includes('individual') || fieldLower.includes('индивидуальное')) return 2;
                    if (fieldLower.includes('natural gas') || fieldLower.includes('газ') || fieldLower.includes('газовое')) return 3;
                    if (fieldLower.includes('electric') || fieldLower.includes('электрическое')) return 4;
                    if (fieldLower.includes('solar') || fieldLower.includes('солнечное')) return 5;
                    if (fieldLower.includes('wood') || fieldLower.includes('дровяное')) return 6;
                    return 999; // Put unknown types at the end
                };
                
                return getHeatingPriority(a) - getHeatingPriority(b);
            });

            console.log('Sorted heating data:', sortedHeatingData);

            let html = '';

            sortedHeatingData.forEach((item, index) => {
                console.log(`Heating item ${index}:`, item);
                // Try different possible field names
                const heatingField = item.heating_type || item.heating || item.heating_type_name || item.name;
                console.log(`Heating field for item ${index}:`, heatingField);
                
                if (heatingField) {
                    html += `<div class="sub-card">
                        <h3>${heatingField}</h3>
                        <table class="data-table">`;
                    
                    // Get all available fields and sort them by priority
                    const availableFields = Object.keys(item).filter(key => 
                        !['heating_type', 'heating', 'heating_type_name', 'name', 'country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file', 'updated_at'].includes(key) &&
                        item[key] !== null && item[key] !== undefined
                    );
                    
                    const sortedFields = sortFieldsByPriority(availableFields);
                    console.log(`Sorted fields for heating item ${index}:`, sortedFields);
                    
                    // Add fields in priority order with structured headers
                    html = displayFieldsWithStructuredHeaders(sortedFields, item, html);
                    
                    html += '</table></div>';
                } else {
                    console.log(`No heating field found for item ${index}, showing all fields`);
                    // If no heating field found, show all available fields
                    const fallbackTitle = getListingTypeTitle(item, 'heating', index);
                    html += `<div class="sub-card">
                        <h3>${fallbackTitle}</h3>
                        <table class="data-table">`;
                    
                    // Get all available fields and sort them by priority
                    const availableFields = Object.keys(item).filter(key => 
                        !['country_id', 'city_id', 'county_id', 'district_id', 'id', 'created_at', 'source_file', 'updated_at'].includes(key) &&
                        item[key] !== null && item[key] !== undefined
                    );
                    
                    const sortedFields = sortFieldsByPriority(availableFields);
                    console.log(`Sorted fields for heating fallback item ${index}:`, sortedFields);
                    
                    // Add fields in priority order with structured headers
                    html = displayFieldsWithStructuredHeaders(sortedFields, item, html);
                    
                    html += '</table></div>';
                }
            });

            console.log('Final HTML for heating data:', html);
            content.innerHTML = html;
        }

        // Go to main menu
        function goToMainMenu() {
            window.location.href = '/webapp_main';
        }

        // Toggle accordion functionality
        function toggleAccordion(cardId) {
            const card = document.getElementById(cardId);
            const content = card.querySelector('.data-card-content');
            const toggle = card.querySelector('.data-card-toggle');
            
            if (content.classList.contains('expanded')) {
                // Collapse
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = '▼';
            } else {
                // Expand
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = '▲';
            }
        }

        // Инициализация
        async function init() {
            const userData = getUserData();
            if (!userData) {
                updatePageText();
                loadCountries();
                return;
            }

            try {
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: userData.id,
                        username: userData.username,
                        tg_name: userData.tg_name,
                        last_name: userData.last_name,
                        language_code: userData.language_code || 'ru'
                    })
                });

                if (response.ok) {
                    const userInfo = await response.json();
                    
                    // Устанавливаем язык в зависимости от статуса пользователя
                    if (userInfo.user_status === 'admin' && userInfo.language) {
                        // Для админов используем язык из базы данных
                        currentLanguage = userInfo.language;
                    } else if (userData.language_code) {
                        // Для обычных пользователей используем язык из Telegram
                        currentLanguage = userData.language_code;
                    }
                }
            } catch (error) {
                // В случае ошибки используем язык из Telegram
                if (userData.language_code) {
                    currentLanguage = userData.language_code;
                }
            }
            
            updatePageText();
            loadCountries();
        }

        // Локализации
        const locales = {
            'ru': {
                'pageTitleTag': 'Aaadviser - Аналитика региона',
                'slogan': 'Инсайты рынка недвижимости',
                'pageTitle': 'Аналитика региона',
                'countryLabel': 'Страна:',
                'countryPlaceholder': 'Выберите страну',
                'cityLabel': 'Город:',
                'cityPlaceholder': 'Сначала выберите страну',
                'countyLabel': 'Область/Регион:',
                'countyPlaceholder': 'Сначала выберите город',
                'districtLabel': 'Район:',
                'districtPlaceholder': 'Сначала выберите область',
                'confirmButtonText': 'Подтвердить выбор',
                'selectedLocationTitle': 'Выбранная локация:',
                'adminIdsTitle': 'ID для админов:',
                'loadingText': 'Загрузка данных...',
                'currencySwitcherTitle': 'Валюта отображения:',
                'keyMetricsTitle': 'Ключевые показатели',
                'avgSalePriceLabel': 'Средняя цена продажи за м²',
                'avgRentPriceLabel': 'Средняя цена аренды за м²',
                'listingPeriodSaleLabel': 'Период размещения (продажа)',
                'listingPeriodRentLabel': 'Период размещения (аренда)',
                'yieldLabel': 'Yield (Доходность)',
                'insightsTitle': 'Саммари',
                'generalDataTitle': 'Общие данные',
                'houseTypeDataTitle': 'Данные по количеству спален',
                'floorSegmentDataTitle': 'Данные по этажу',
                'ageDataTitle': 'Данные по возрасту объектов',
                'heatingDataTitle': 'Данные по типу отопления',
                'errorText': 'Ошибка загрузки данных',
                'backButton': '← Вернуться в главное меню',
                'noDistrictOption': 'Не имеет значения'
            },
            'en': {
                'pageTitleTag': 'Aaadviser - Region Analytics',
                'slogan': 'Real Estate Market Insights',
                'pageTitle': 'Region Analytics',
                'countryLabel': 'Country:',
                'countryPlaceholder': 'Select country',
                'cityLabel': 'City:',
                'cityPlaceholder': 'Select country first',
                'countyLabel': 'Region/State:',
                'countyPlaceholder': 'Select city first',
                'districtLabel': 'District:',
                'districtPlaceholder': 'Select region first',
                'confirmButtonText': 'Confirm selection',
                'selectedLocationTitle': 'Selected location:',
                'adminIdsTitle': 'IDs for admins:',
                'loadingText': 'Loading data...',
                'currencySwitcherTitle': 'Display currency:',
                'keyMetricsTitle': 'Key Metrics',
                'avgSalePriceLabel': 'Average sale price per m²',
                'avgRentPriceLabel': 'Average rent price per m²',
                'listingPeriodSaleLabel': 'Listing period (sale)',
                'listingPeriodRentLabel': 'Listing period (rent)',
                'yieldLabel': 'Yield (Return)',
                'insightsTitle': 'Summary',
                'generalDataTitle': 'General Data',
                'houseTypeDataTitle': 'Bedroom Data',
                'floorSegmentDataTitle': 'Floor Data',
                'ageDataTitle': 'Property Age Data',
                'heatingDataTitle': 'Heating Type Data',
                'errorText': 'Error loading data',
                'backButton': '← Back to main menu',
                'noDistrictOption': 'No preference'
            },
            'de': {
                'pageTitleTag': 'Aaadviser - Regionalanalytik',
                'slogan': 'Immobilienmarkt-Einblicke',
                'pageTitle': 'Regionalanalytik',
                'countryLabel': 'Land:',
                'countryPlaceholder': 'Land auswählen',
                'cityLabel': 'Stadt:',
                'cityPlaceholder': 'Zuerst Land auswählen',
                'countyLabel': 'Region/Bundesland:',
                'countyPlaceholder': 'Zuerst Stadt auswählen',
                'districtLabel': 'Bezirk:',
                'districtPlaceholder': 'Zuerst Region auswählen',
                'confirmButtonText': 'Auswahl bestätigen',
                'selectedLocationTitle': 'Ausgewählter Standort:',
                'adminIdsTitle': 'IDs für Administratoren:',
                'loadingText': 'Daten werden geladen...',
                'currencySwitcherTitle': 'Anzeigewährung:',
                'keyMetricsTitle': 'Schlüsselmetriken',
                'avgSalePriceLabel': 'Durchschnittlicher Verkaufspreis pro m²',
                'avgRentPriceLabel': 'Durchschnittlicher Mietpreis pro m²',
                'listingPeriodSaleLabel': 'Anzeigedauer (Verkauf)',
                'listingPeriodRentLabel': 'Anzeigedauer (Vermietung)',
                'yieldLabel': 'Rendite (Ertrag)',
                'insightsTitle': 'Zusammenfassung',
                'generalDataTitle': 'Allgemeine Daten',
                'houseTypeDataTitle': 'Schlafzimmer-Daten',
                'floorSegmentDataTitle': 'Etagen-Daten',
                'ageDataTitle': 'Immobilienalter-Daten',
                'heatingDataTitle': 'Heizungstyp-Daten',
                'errorText': 'Fehler beim Laden der Daten',
                'backButton': '← Zurück zum Hauptmenü',
                'noDistrictOption': 'Keine Präferenz'
            },
            'fr': {
                'pageTitleTag': 'Aaadviser - Analytique régionale',
                'slogan': 'Aperçus du marché immobilier',
                'pageTitle': 'Analytique régionale',
                'countryLabel': 'Pays:',
                'countryPlaceholder': 'Sélectionner le pays',
                'cityLabel': 'Ville:',
                'cityPlaceholder': 'Sélectionner d\'abord le pays',
                'countyLabel': 'Région/État:',
                'countyPlaceholder': 'Sélectionner d\'abord la ville',
                'districtLabel': 'Quartier:',
                'districtPlaceholder': 'Sélectionner d\'abord la région',
                'confirmButtonText': 'Confirmer la sélection',
                'selectedLocationTitle': 'Emplacement sélectionné:',
                'adminIdsTitle': 'IDs pour les administrateurs:',
                'loadingText': 'Chargement des données...',
                'currencySwitcherTitle': 'Devise d\'affichage:',
                'keyMetricsTitle': 'Métriques clés',
                'avgSalePriceLabel': 'Prix de vente moyen par m²',
                'avgRentPriceLabel': 'Prix de location moyen par m²',
                'listingPeriodSaleLabel': 'Période d\'annonce (vente)',
                'listingPeriodRentLabel': 'Période d\'annonce (location)',
                'yieldLabel': 'Rendement (Retour)',
                'insightsTitle': 'Résumé',
                'generalDataTitle': 'Données générales',
                'houseTypeDataTitle': 'Données des chambres',
                'floorSegmentDataTitle': 'Données des étages',
                'ageDataTitle': 'Données d\'âge des propriétés',
                'heatingDataTitle': 'Données du type de chauffage',
                'errorText': 'Erreur de chargement des données',
                'backButton': '← Retour au menu principal',
                'noDistrictOption': 'Aucune préférence'
            },
            'tr': {
                'pageTitleTag': 'Aaadviser - Bölge Analizi',
                'slogan': 'Gayrimenkul Piyasası İçgörüleri',
                'pageTitle': 'Bölge Analizi',
                'countryLabel': 'Ülke:',
                'countryPlaceholder': 'Ülke seçin',
                'cityLabel': 'Şehir:',
                'cityPlaceholder': 'Önce ülke seçin',
                'countyLabel': 'Bölge/Eyalet:',
                'countyPlaceholder': 'Önce şehir seçin',
                'districtLabel': 'İlçe:',
                'districtPlaceholder': 'Önce bölge seçin',
                'confirmButtonText': 'Seçimi onayla',
                'selectedLocationTitle': 'Seçilen konum:',
                'adminIdsTitle': 'Yöneticiler için ID\'ler:',
                'loadingText': 'Veriler yükleniyor...',
                'currencySwitcherTitle': 'Görüntüleme para birimi:',
                'keyMetricsTitle': 'Temel Metrikler',
                'avgSalePriceLabel': 'Ortalama satış fiyatı m² başına',
                'avgRentPriceLabel': 'Ortalama kiralama fiyatı m² başına',
                'listingPeriodSaleLabel': 'İlan süresi (satış)',
                'listingPeriodRentLabel': 'İlan süresi (kiralama)',
                'yieldLabel': 'Getiri (Kazanç)',
                'insightsTitle': 'Özet',
                'generalDataTitle': 'Genel Veriler',
                'houseTypeDataTitle': 'Yatak Odası Verileri',
                'floorSegmentDataTitle': 'Kat Verileri',
                'ageDataTitle': 'Gayrimenkul Yaşı Verileri',
                'heatingDataTitle': 'Isıtma Türü Verileri',
                'errorText': 'Veri yükleme hatası',
                'backButton': '← Ana menüye dön',
                'noDistrictOption': 'Tercih yok'
            }
        };

        // Функция для получения данных пользователя из Telegram WebApp
        function getUserData() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                return window.Telegram.WebApp.initDataUnsafe.user;
            }
            return null;
        }

        // Функция для получения локализованного текста
        function getText(key) {
            const locale = locales[currentLanguage] || locales['ru'];
            return locale[key] || key;
        }

        // Обновление текста на странице
        function updatePageText() {
            // Обновляем заголовок страницы
            document.title = getText('pageTitleTag');
            
            // Обновляем основные элементы
            const elements = [
                'slogan', 'pageTitle', 'countryLabel', 'countryPlaceholder', 'cityLabel', 'cityPlaceholder',
                'countyLabel', 'countyPlaceholder', 'districtLabel', 'districtPlaceholder', 'confirmButtonText',
                'selectedLocationTitle', 'adminIdsTitle', 'loadingText', 'currencySwitcherTitle', 'keyMetricsTitle',
                'avgSalePriceLabel', 'avgRentPriceLabel', 'listingPeriodSaleLabel', 'listingPeriodRentLabel',
                'yieldLabel', 'insightsTitle', 'generalDataTitle', 'houseTypeDataTitle', 'floorSegmentDataTitle',
                'ageDataTitle', 'heatingDataTitle', 'errorText', 'backButton', 'noDistrictOption'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = getText(id);
                }
            });
        }

        // Запускаем инициализацию
        init();
    </script>
</body>
</html>
