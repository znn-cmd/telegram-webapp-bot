<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оценка объекта - Aaadviser</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="design-system.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="ux-utils.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #667eea;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin: 0 0 10px 0;
            font-weight: 700;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
            margin: 0;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .address-confirmation {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .address-confirmation p {
            margin: 0 0 15px 0;
            color: #856404;
        }
        
        .address-confirmation .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(102, 126, 234, 0.2);
            z-index: 1000;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1001;
        }
        
        .report-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .report-actions {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border: 1px solid #e9ecef;
        }
        
        .language-selector-block {
            margin-bottom: 20px;
        }
        
        .language-selector-header {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .language-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .lang-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 80px;
        }
        
        .lang-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .lang-btn.selected {
            background: #667eea;
            transform: translateY(-1px);
        }
        
        .lang-btn.selected:hover {
            background: #5a6fd8;
        }
        
        .save-report-section {
            text-align: center;
            border-top: 1px solid #dee2e6;
            padding-top: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 18px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .back-button:hover {
            background: rgba(0,0,0,0.9);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .language-buttons {
                flex-direction: column;
            }
            
            .lang-btn {
                width: 100%;
            }
            
            .address-confirmation .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <button class="back-button" onclick="goToMainMenu()" data-i18n="common.back">←</button>
    
    <div class="progress-bar hidden" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-text hidden" id="progressText">Загрузка...</div>
    
    <div class="container">
        <div class="header">
            <h1 data-i18n="menu.object_evaluation">Оценка объекта</h1>
            <p data-i18n="menu.object_evaluation_desc">Оценка недвижимости</p>
        </div>
        
        <!-- Форма ввода данных -->
        <div class="form-section" id="inputForm">
            <div class="form-group">
                <label for="addressInput" data-i18n="new_report.enter_address">Введите адрес объекта:</label>
                <input type="text" id="addressInput" placeholder="Например: Alanya, Mahmutlar, Barbaros Cd. No:15">
            </div>
            
            <div class="address-confirmation hidden" id="addressConfirmation">
                <p data-i18n="new_report.address_correct">Этот адрес корректный?</p>
                <div class="address-display" id="addressDisplay"></div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="confirmAddress()" data-i18n="new_report.yes">Да</button>
                    <button class="btn btn-secondary" onclick="rejectAddress()" data-i18n="new_report.no">Нет</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="bedroomsInput" data-i18n="new_report.enter_bedrooms">Введите количество спален:</label>
                <input type="number" id="bedroomsInput" min="1" max="10" placeholder="1-10">
            </div>
            
            <div class="form-group">
                <label for="priceInput" data-i18n="new_report.enter_price">Введите цену покупки в евро:</label>
                <input type="number" id="priceInput" min="1" placeholder="Например: 150000">
            </div>
            
            <button class="btn" onclick="generateReport()" id="generateBtn">
                <span data-i18n="new_report.generating_report">Сформировать отчет</span>
            </button>
        </div>
        
        <!-- Контейнер для отчета -->
        <div class="report-container hidden" id="reportContainer">
            <div id="reportContent"></div>
        </div>
        
        <!-- Действия с отчетом -->
        <div class="report-actions hidden" id="reportActions">
            <div class="language-selector-block">
                <div class="language-selector-header" data-i18n="object_evaluation.select_report_language">
                    Выберите язык отчета перед сохранением
                </div>
                <div class="language-buttons">
                    <button class="lang-btn selected" data-lang="ru" onclick="selectReportLanguage('ru')">Русский</button>
                    <button class="lang-btn" data-lang="en" onclick="selectReportLanguage('en')">English</button>
                    <button class="lang-btn" data-lang="de" onclick="selectReportLanguage('de')">Deutsch</button>
                    <button class="lang-btn" data-lang="fr" onclick="selectReportLanguage('fr')">Français</button>
                    <button class="lang-btn" data-lang="tr" onclick="selectReportLanguage('tr')">Türkçe</button>
                </div>
            </div>
            
            <div class="save-report-section">
                <button class="btn btn-success" onclick="saveReport()" id="saveReportBtn">
                    <span data-i18n="reports.save_report">Сохранить отчет</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let userData = null;
        let currentLanguage = 'ru';
        let selectedReportLanguage = 'ru'; // Язык отчета (отдельно от языка пользователя)
        let currentReportData = null;
        let geocodedAddress = null;
        let coordinates = null;

        // Локализация для страницы оценки объекта
        const objectEvaluationLocales = {
            'ru': {
                'menu.object_evaluation': 'Оценка объекта',
                'menu.object_evaluation_desc': 'Оценка недвижимости',
                'new_report.enter_address': 'Введите адрес объекта:',
                'new_report.address_correct': 'Этот адрес корректный?',
                'new_report.yes': 'Да',
                'new_report.no': 'Нет',
                'new_report.enter_bedrooms': 'Введите количество спален:',
                'new_report.enter_price': 'Введите цену покупки в евро:',
                'new_report.generating_report': 'Сформировать отчет',
                'new_report.address_not_found': 'Адрес не распознан, попробуйте ввести его еще раз.',
                'new_report.invalid_bedrooms': 'Количество спален должно быть числом от 1 до 10.',
                'new_report.invalid_price': 'Цена должна быть положительным числом.',
                'object_evaluation.select_report_language': 'Выберите язык отчета перед сохранением',
                'reports.save_report': 'Сохранить отчет',
                'common.back': 'Назад',
                'progress.generating_report': 'Формируем отчет...',
                'progress.processing_request': 'Обрабатываем запрос...',
                'notifications.report_generated': 'Отчет сформирован!',
                'notifications.report_saved': 'Отчет сохранен!',
                'notifications.connection_error': 'Ошибка соединения'
            },
            'en': {
                'menu.object_evaluation': 'Object Evaluation',
                'menu.object_evaluation_desc': 'Property Evaluation',
                'new_report.enter_address': 'Enter property address:',
                'new_report.address_correct': 'Is this address correct?',
                'new_report.yes': 'Yes',
                'new_report.no': 'No',
                'new_report.enter_bedrooms': 'Enter number of bedrooms:',
                'new_report.enter_price': 'Enter purchase price in euros:',
                'new_report.generating_report': 'Generate Report',
                'new_report.address_not_found': 'Address not recognized, please try entering it again.',
                'new_report.invalid_bedrooms': 'Number of bedrooms must be between 1 and 10.',
                'new_report.invalid_price': 'Price must be a positive number.',
                'object_evaluation.select_report_language': 'Select report language before saving',
                'reports.save_report': 'Save Report',
                'common.back': 'Back',
                'progress.generating_report': 'Generating report...',
                'progress.processing_request': 'Processing request...',
                'notifications.report_generated': 'Report generated!',
                'notifications.report_saved': 'Report saved!',
                'notifications.connection_error': 'Connection error'
            },
            'de': {
                'menu.object_evaluation': 'Objektbewertung',
                'menu.object_evaluation_desc': 'Immobilienbewertung',
                'new_report.enter_address': 'Geben Sie die Immobilienadresse ein:',
                'new_report.address_correct': 'Ist diese Adresse korrekt?',
                'new_report.yes': 'Ja',
                'new_report.no': 'Nein',
                'new_report.enter_bedrooms': 'Geben Sie die Anzahl der Schlafzimmer ein:',
                'new_report.enter_price': 'Geben Sie den Kaufpreis in Euro ein:',
                'new_report.generating_report': 'Bericht erstellen',
                'new_report.address_not_found': 'Adresse nicht erkannt, versuchen Sie es erneut einzugeben.',
                'new_report.invalid_bedrooms': 'Anzahl der Schlafzimmer muss zwischen 1 und 10 liegen.',
                'new_report.invalid_price': 'Preis muss eine positive Zahl sein.',
                'object_evaluation.select_report_language': 'Berichtssprache vor dem Speichern auswählen',
                'reports.save_report': 'Bericht speichern',
                'common.back': 'Zurück',
                'progress.generating_report': 'Bericht wird erstellt...',
                'progress.processing_request': 'Anfrage wird verarbeitet...',
                'notifications.report_generated': 'Bericht erstellt!',
                'notifications.report_saved': 'Bericht gespeichert!',
                'notifications.connection_error': 'Verbindungsfehler'
            },
            'fr': {
                'menu.object_evaluation': 'Évaluation d\'Objet',
                'menu.object_evaluation_desc': 'Évaluation immobilière',
                'new_report.enter_address': 'Entrez l\'adresse du bien :',
                'new_report.address_correct': 'Cette adresse est-elle correcte ?',
                'new_report.yes': 'Oui',
                'new_report.no': 'Non',
                'new_report.enter_bedrooms': 'Entrez le nombre de chambres :',
                'new_report.enter_price': 'Entrez le prix d\'achat en euros :',
                'new_report.generating_report': 'Générer le rapport',
                'new_report.address_not_found': 'Adresse non reconnue, veuillez essayer de la saisir à nouveau.',
                'new_report.invalid_bedrooms': 'Le nombre de chambres doit être entre 1 et 10.',
                'new_report.invalid_price': 'Le prix doit être un nombre positif.',
                'object_evaluation.select_report_language': 'Sélectionnez la langue du rapport avant de sauvegarder',
                'reports.save_report': 'Enregistrer le rapport',
                'common.back': 'Retour',
                'progress.generating_report': 'Génération du rapport...',
                'progress.processing_request': 'Traitement de la demande...',
                'notifications.report_generated': 'Rapport généré !',
                'notifications.report_saved': 'Rapport enregistré !',
                'notifications.connection_error': 'Erreur de connexion'
            },
            'tr': {
                'menu.object_evaluation': 'Nesne Değerlendirmesi',
                'menu.object_evaluation_desc': 'Gayrimenkul değerlendirmesi',
                'new_report.enter_address': 'Mülk adresini girin:',
                'new_report.address_correct': 'Bu adres doğru mu?',
                'new_report.yes': 'Evet',
                'new_report.no': 'Hayır',
                'new_report.enter_bedrooms': 'Yatak odası sayısını girin:',
                'new_report.enter_price': 'Satın alma fiyatını euro cinsinden girin:',
                'new_report.generating_report': 'Rapor Oluştur',
                'new_report.address_not_found': 'Adres tanınmadı, lütfen tekrar girmeyi deneyin.',
                'new_report.invalid_bedrooms': 'Yatak odası sayısı 1 ile 10 arasında olmalıdır.',
                'new_report.invalid_price': 'Fiyat pozitif bir sayı olmalıdır.',
                'object_evaluation.select_report_language': 'Kaydetmeden önce rapor dilini seçin',
                'reports.save_report': 'Raporu Kaydet',
                'common.back': 'Geri',
                'progress.generating_report': 'Rapor oluşturuluyor...',
                'progress.processing_request': 'İstek işleniyor...',
                'notifications.report_generated': 'Rapor oluşturuldu!',
                'notifications.report_saved': 'Rapor kaydedildi!',
                'notifications.connection_error': 'Bağlantı hatası'
            }
        };

        // Получаем данные пользователя
        function getUserData() {
            let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                return tg.initDataUnsafe.user;
            }
            // Fallback: localStorage
            try {
                const stored = localStorage.getItem('aaadviser_user');
                if (stored) return JSON.parse(stored);
            } catch (e) {}
            return null;
        }

        // Получение локализованного текста
        function getText(key) {
            return objectEvaluationLocales[currentLanguage]?.[key] || key;
        }

        // Обновление текстов на странице
        function updatePageText() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                const text = getText(key);
                if (element.tagName === 'INPUT') {
                    element.placeholder = text;
                } else {
                    element.textContent = text;
                }
            });
        }

        // Показать прогресс-бар
        function showProgressBar(text, progress) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressBar.classList.remove('hidden');
            progressText.classList.remove('hidden');
            progressText.textContent = text;
            progressFill.style.width = progress + '%';
        }

        // Скрыть прогресс-бар
        function hideProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.classList.add('hidden');
            progressText.classList.add('hidden');
        }

        // Показать уведомление
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = type === 'success' ? 'success-message' : 'error-message';
            notification.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(notification, container.firstChild);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Генерация отчета
        async function generateReport() {
            const address = document.getElementById('addressInput').value.trim();
            const bedrooms = parseInt(document.getElementById('bedroomsInput').value);
            const price = parseFloat(document.getElementById('priceInput').value);

            // Валидация
            if (!address) {
                showNotification(getText('new_report.address_not_found'), 'error');
                return;
            }

            if (!bedrooms || bedrooms < 1 || bedrooms > 10) {
                showNotification(getText('new_report.invalid_bedrooms'), 'error');
                return;
            }

            if (!price || price <= 0) {
                showNotification(getText('new_report.invalid_price'), 'error');
                return;
            }

            try {
                showProgressBar(getText('progress.processing_request'), 20);

                // Геокодирование адреса
                const geocodeResponse = await fetch('/api/geocode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });

                if (!geocodeResponse.ok) {
                    throw new Error('Geocoding failed');
                }

                const geocodeData = await geocodeResponse.json();
                if (!geocodeData.success) {
                    showNotification(getText('new_report.address_not_found'), 'error');
                    hideProgressBar();
                    return;
                }

                geocodedAddress = geocodeData.formatted_address;
                coordinates = { lat: geocodeData.lat, lng: geocodeData.lng };

                showProgressBar(getText('progress.generating_report'), 60);

                // Генерация отчета
                const reportResponse = await fetch('/api/full_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: geocodedAddress,
                        bedrooms,
                        price,
                        lat: coordinates.lat,
                        lng: coordinates.lng,
                        telegram_id: userData?.id,
                        language: selectedReportLanguage
                    })
                });

                if (!reportResponse.ok) {
                    throw new Error('Report generation failed');
                }

                const reportData = await reportResponse.json();
                
                hideProgressBar();
                
                if (reportData.full_report) {
                    currentReportData = {
                        address: geocodedAddress,
                        bedrooms,
                        price,
                        coordinates,
                        report: reportData.full_report
                    };
                    
                    displayReport(reportData.full_report);
                    showNotification(getText('notifications.report_generated'));
                } else {
                    showNotification(getText('notifications.connection_error'), 'error');
                }

            } catch (error) {
                console.error('Error generating report:', error);
                hideProgressBar();
                showNotification(getText('notifications.connection_error'), 'error');
            }
        }

        // Отображение отчета
        function displayReport(reportHtml) {
            const reportContainer = document.getElementById('reportContainer');
            const reportContent = document.getElementById('reportContent');
            const reportActions = document.getElementById('reportActions');
            
            reportContent.innerHTML = reportHtml;
            reportContainer.classList.remove('hidden');
            reportActions.classList.remove('hidden');
        }

        // Выбор языка отчета
        function selectReportLanguage(lang) {
            selectedReportLanguage = lang;
            
            // Обновляем активную кнопку
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-lang="${lang}"]`).classList.add('selected');
            
            // Перегенерируем отчет на выбранном языке, если отчет уже сформирован
            if (currentReportData) {
                regenerateReportInLanguage(lang);
            }
        }

        // Перегенерация отчета на выбранном языке
        async function regenerateReportInLanguage(lang) {
            if (!currentReportData) return;
            
            try {
                showProgressBar(getText('progress.generating_report'), 50);
                
                const reportResponse = await fetch('/api/full_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: currentReportData.address,
                        bedrooms: currentReportData.bedrooms,
                        price: currentReportData.price,
                        lat: currentReportData.coordinates.lat,
                        lng: currentReportData.coordinates.lng,
                        telegram_id: userData?.id,
                        language: lang
                    })
                });

                if (reportResponse.ok) {
                    const reportData = await reportResponse.json();
                    if (reportData.full_report) {
                        currentReportData.report = reportData.full_report;
                        displayReport(reportData.full_report);
                    }
                }
                
                hideProgressBar();
                
            } catch (error) {
                console.error('Error regenerating report:', error);
                hideProgressBar();
            }
        }

        // Сохранение отчета
        async function saveReport() {
            if (!currentReportData) {
                showNotification('Нет отчета для сохранения', 'error');
                return;
            }

            try {
                showProgressBar('Сохраняем отчет...', 80);

                const saveResponse = await fetch('/api/save_html_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: userData?.id,
                        address: currentReportData.address,
                        bedrooms: currentReportData.bedrooms,
                        price: currentReportData.price,
                        report_html: currentReportData.report,
                        language: selectedReportLanguage
                    })
                });

                if (saveResponse.ok) {
                    const saveData = await saveResponse.json();
                    if (saveData.success) {
                        showNotification(getText('notifications.report_saved'));
                    }
                }
                
                hideProgressBar();
                
            } catch (error) {
                console.error('Error saving report:', error);
                hideProgressBar();
                showNotification(getText('notifications.connection_error'), 'error');
            }
        }

        // Переход в главное меню
        function goToMainMenu() {
            window.location.href = '/webapp_main';
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            userData = getUserData();
            if (userData && userData.id) {
                localStorage.setItem('telegram_id', userData.id);
            }
            
            // Загружаем язык пользователя
            if (userData?.id) {
                fetch('/api/get_user_language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: userData.id })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        currentLanguage = data.language || 'ru';
                        updatePageText();
                    }
                })
                .catch(() => {
                    currentLanguage = 'ru';
                    updatePageText();
                });
            } else {
                updatePageText();
            }
        });
    </script>
</body>
</html>
