<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - Оценка объекта</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Header Styles */
        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin: 20px 0 10px 0;
        }

        .page-description {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        /* Form Styles */
        .location-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
        }

        .form-group select:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .confirm-button {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .confirm-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Listing Type Selection Styles */
        .listing-type-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #e0e0e0;
        }

        .listing-type-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            text-align: center;
        }

        .listing-type-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .listing-type-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .listing-type-select:hover {
            border-color: #667eea;
        }

        .listing-type-group {
            margin-bottom: 15px;
        }

        .listing-type-subtitle {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        /* Selected Location Styles */
        .selected-location {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .location-title {
            font-size: 16px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .location-details {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .selected-property-types {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #4caf50;
        }

        .property-types-title {
            font-size: 14px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .property-types-details {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }

        .property-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #e8f5e8;
        }

        .property-type-item:last-child {
            border-bottom: none;
        }

        .property-type-label {
            font-weight: 500;
            color: #2e7d32;
        }

        .property-type-value {
            color: #333;
            font-weight: 600;
        }

        .admin-ids {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #4caf50;
        }

        .admin-title {
            font-size: 14px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .admin-details {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }

        /* Key Metrics Styles */
        .key-metrics-section {
            margin-bottom: 20px;
        }

        .key-metrics-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .metric-card.yield-card {
            grid-column: 1 / -1;
            background: #f0f0f0;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .yield-label {
            font-size: 17px;
        }

        .yield-value {
            font-size: 17px;
        }

        /* Insights Styles */
        .insights-section {
            margin: 20px 0;
        }

        .insights-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .insights-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .insights-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .insights-content {
            padding: 15px;
        }

        .insights-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        .insights-text {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
            padding: 8px 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            max-width: 100%;
        }

        .insights-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            color: #721c24;
        }

        .insights-error .error-icon {
            font-size: 24px;
        }

        .insights-error .error-text {
            font-size: 14px;
            text-align: center;
        }

        /* Data Card Styles */
        .data-content {
            margin-bottom: 20px;
        }

        .data-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .data-section-content {
            padding: 0;
        }
        
        .data-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .data-item-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0 0 12px 0;
        }
        
        .data-available {
            padding: 15px;
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 6px;
            color: #2e7d32;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .summary-table {
            margin-top: 20px;
        }
        
        .summary-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            font-weight: 600;
            text-align: center;
        }
        
        .summary-table td {
            padding: 10px 8px;
            text-align: center;
        }
        
        .summary-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .section-header {
            background: #f8f9fa !important;
            color: #495057;
            font-weight: 700;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .sale-header {
            background: #f8f9fa !important;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .rent-header {
            background: #f8f9fa !important;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .yield-header {
            background: #f8f9fa !important;
            color: #495057;
            font-weight: 800;
            font-size: 18px;
            border: 1px solid #dee2e6;
        }
        
        .yield-data {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6;
        }
        
        .yield-label {
            font-weight: 700;
            color: #856404;
        }
        
        .yield-value {
            font-weight: 700;
            color: #856404;
        }
        
        /* Analytical Summary Styles */
        .analytical-summary {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .analytical-summary p {
            font-size: 14px;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 12px;
        }
        
        .analytical-summary strong {
            color: #333;
            font-weight: 600;
        }
        
        /* Property Trends Styles */
        .trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .trend-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .trend-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .trend-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .trend-value {
            font-size: 18px;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 5px;
        }
        
        .trend-period {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }
        
        .trend-details {
            margin-top: 8px;
        }
        
        .trend-change {
            font-size: 11px;
            color: #495057;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .trend-date {
            font-size: 10px;
            color: #6c757d;
            font-style: italic;
        }
        
        .trend-card-price_trend {
            border-left: 4px solid #28a745;
        }
        
        .trend-card-yield_trend {
            border-left: 4px solid #ffc107;
        }
        
        .trend-card-count_trend {
            border-left: 4px solid #17a2b8;
        }
        
        /* Trends Table Styles */
        .trends-table-section {
            margin-top: 25px;
        }
        
        .trends-table-title {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .trends-table-container {
            overflow-x: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 20px 0;
            background: white;
        }
        
        .trends-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
            table-layout: fixed;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .trends-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            line-height: 1.2;
            word-wrap: break-word;
            border-right: 1px solid rgba(255,255,255,0.2);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .trends-table th:last-child {
            border-right: none;
        }
        
        .trends-table td {
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #f0f0f0;
            word-wrap: break-word;
            vertical-align: middle;
        }
        
        .trends-table td:last-child {
            border-right: none;
        }
        
        .trends-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .trends-table tr:nth-child(odd) {
            background: #ffffff;
        }
        
        .trends-table tr:hover {
            background: #e3f2fd;
            transform: scale(1.01);
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .trends-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Улучшенное разделение строк */
        .trends-table tr {
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }
        
        .trends-table tr:hover td {
            background: #e3f2fd !important;
        }
        
        /* Специальные стили для ширины столбцов */
        .trends-table th:nth-child(1) { width: 15%; } /* Дата */
        .trends-table th:nth-child(2) { width: 18%; } /* Продажа */
        .trends-table th:nth-child(3) { width: 18%; } /* Изм-ие цены продажи */
        .trends-table th:nth-child(4) { width: 18%; } /* Аренда */
        .trends-table th:nth-child(5) { width: 18%; } /* Изм-ие цены аренды */
        .trends-table th:nth-child(6) { width: 13%; } /* Доходность */
        
        /* Мобильные устройства */
        @media (max-width: 768px) {
            .trends-table {
                font-size: 11px;
            }
            
            .trends-table th,
            .trends-table td {
                padding: 4px 2px;
            }
            
            .trends-table th:nth-child(1) { width: 18%; }
            .trends-table th:nth-child(2) { width: 17%; }
            .trends-table th:nth-child(3) { width: 17%; }
            .trends-table th:nth-child(4) { width: 17%; }
            .trends-table th:nth-child(5) { width: 17%; }
            .trends-table th:nth-child(6) { width: 14%; }
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 10px;
            table-layout: fixed;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .data-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 0;
        }

        .data-table td:first-child {
            font-weight: 500;
            color: #555;
            width: 60%;
            text-align: left;
        }

        .data-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: #333;
            width: 40%;
        }

        /* Sub-card Styles */
        .sub-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }

        .sub-card h3 {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sub-card h4 {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin: 8px 0 6px 0;
        }

        /* Error State Styles */
        .error-state {
            text-align: center;
            padding: 20px 15px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            margin: 15px 0;
        }

        .error-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .error-text {
            font-size: 14px;
            color: #721c24;
        }

        /* Back Button Styles */
        .back-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile responsive for insights */
        @media (max-width: 480px) {
            .insights-card {
                padding: 12px;
            }
            
            .insights-title {
                font-size: 16px;
            }
            
            .insights-text {
                font-size: 14px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
                max-width: 100%;
            }
            
            .insights-section {
                margin: 15px 0;
            }
            
            /* Мобильные стили для секций данных */
            .data-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .data-section-title {
                font-size: 16px;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            .data-item {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .data-item-title {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .summary-table th,
            .summary-table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .section-header td {
                font-size: 13px;
                padding: 10px 6px;
            }
            
            .yield-header {
                font-size: 16px;
            }
            
            .trends-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .trend-card {
                padding: 12px;
            }
            
            .trend-title {
                font-size: 13px;
            }
            
            .trend-value {
                font-size: 16px;
            }
            
            .trend-period {
                font-size: 11px;
            }
            
            .trend-details {
                margin-top: 6px;
            }
            
            .trend-change {
                font-size: 10px;
                margin-bottom: 3px;
            }
            
            .trend-date {
                font-size: 9px;
            }
            
            .trends-table-title {
                font-size: 14px;
                margin-bottom: 12px;
            }
            
            .trends-table {
                font-size: 11px;
            }
            
            .trends-table th,
            .trends-table td {
                padding: 6px 4px;
            }
            
            .data-available {
                padding: 12px;
                font-size: 13px;
            }
        }

        /* Price and Area Input Styles */
        .listing-type-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            margin-bottom: 10px;
        }

        .listing-type-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* Currency Buttons Styles */
        .currency-buttons-container {
            margin-bottom: 15px;
        }

        .currency-buttons-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .currency-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .currency-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px;
        }

        .currency-button:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .currency-button.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .currency-button.active .currency-symbol {
            color: white;
        }

        .currency-symbol {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        /* Mobile responsive for listing type selection */
        @media (max-width: 480px) {
            .listing-type-section {
                padding: 12px;
                margin: 12px 0;
            }
            
            .listing-type-title {
                font-size: 13px;
                margin-bottom: 10px;
            }
            
            .listing-type-subtitle {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .listing-type-select {
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .listing-type-input {
                padding: 8px 10px;
                font-size: 13px;
                margin-bottom: 8px;
            }
            
            .currency-buttons {
                gap: 4px;
            }
            
            .currency-button {
                width: 45px;
                height: 35px;
                padding: 3px;
            }
            
            .currency-symbol {
                font-size: 16px;
            }
            
            .selected-property-types {
                margin-top: 12px;
                padding-top: 12px;
            }
            
            .property-types-title {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .property-types-details {
                font-size: 12px;
            }
            
            .property-type-item {
                padding: 3px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Логотип -->
        <div style="display:flex;flex-direction:column;align-items:center;margin-top:18px;margin-bottom:10px;">
            <img src="logo-flt.png" alt="Aaadviser Logo" style="width:110px;height:auto;display:block;margin-bottom:8px;cursor:pointer;" onclick="goToMainMenu()" />
            <div style="font-size:15px;color:#888;font-style:italic;" id="slogan">Инсайты рынка недвижимости</div>
        </div>

        <!-- Заголовок страницы -->
        <div class="page-title" id="pageTitle">Оценка объекта</div>
        <div class="page-description" id="pageDescription">Получите профессиональную оценку стоимости недвижимости в выбранном регионе</div>

        <!-- Форма выбора локации -->
        <div class="location-form" id="locationForm">
            <div class="form-group">
                <label for="countrySelect" id="countryLabel">Страна:</label>
                <select id="countrySelect" onchange="onCountryChange()">
                    <option value="" id="countryPlaceholder">Выберите страну</option>
                </select>
            </div>

            <div class="form-group">
                <label for="citySelect" id="cityLabel">Город:</label>
                <select id="citySelect" disabled onchange="onCityChange()">
                    <option value="" id="cityPlaceholder">Сначала выберите страну</option>
                </select>
            </div>

            <div class="form-group">
                <label for="countySelect" id="countyLabel">Область/Регион:</label>
                <select id="countySelect" disabled onchange="onCountyChange()">
                    <option value="" id="countyPlaceholder">Сначала выберите город</option>
                </select>
            </div>

            <div class="form-group">
                <label for="districtSelect" id="districtLabel">Район:</label>
                <select id="districtSelect" disabled onchange="onDistrictChange()">
                    <option value="" id="districtPlaceholder">Сначала выберите область</option>
                </select>
            </div>

                            <!-- Listing Type Selection -->
                <div class="listing-type-section" id="listingTypeSection" style="display: none;">
                    <div class="listing-type-title" id="listingTypeTitle">Выберите тип недвижимости для анализа:</div>
                    
                    <!-- House Type Listing Types -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="houseTypeSubtitle">Количество спален:</div>
                        <select class="listing-type-select" id="houseTypeSelect">
                            <option value="" id="houseTypePlaceholder">Выберите количество спален</option>
                        </select>
                    </div>

                    <!-- Floor Segment Listing Types -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="floorSegmentSubtitle">Этаж:</div>
                        <select class="listing-type-select" id="floorSegmentSelect">
                            <option value="" id="floorSegmentPlaceholder">Выберите этаж</option>
                        </select>
                    </div>

                    <!-- Age Data Listing Types -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="ageDataSubtitle">Возраст объекта:</div>
                        <select class="listing-type-select" id="ageDataSelect">
                            <option value="" id="ageDataPlaceholder">Выберите возраст объекта</option>
                        </select>
                    </div>

                    <!-- Heating Data Listing Types -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="heatingDataSubtitle">Тип отопления:</div>
                        <select class="listing-type-select" id="heatingDataSelect">
                            <option value="" id="heatingDataPlaceholder">Выберите тип отопления</option>
                        </select>
                    </div>

                    <!-- Price Object -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="priceObjectSubtitle">Цена объекта:</div>
                        <input type="number" id="priceObjectInput" class="listing-type-input" placeholder="Введите цену">
                        
                        <!-- Currency Selection -->
                        <div class="currency-buttons-container">
                            <div class="currency-buttons-title" id="currencyTitle">Выберите валюту:</div>
                            <div class="currency-buttons">
                                <button type="button" class="currency-button" data-currency="TRY">
                                    <span class="currency-symbol">₺</span>
                                </button>
                                <button type="button" class="currency-button" data-currency="EUR">
                                    <span class="currency-symbol">€</span>
                                </button>
                                <button type="button" class="currency-button" data-currency="USD">
                                    <span class="currency-symbol">$</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Area Object -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="areaObjectSubtitle">Площадь объекта (м²):</div>
                        <input type="number" id="areaObjectInput" class="listing-type-input" placeholder="Введите площадь" min="10" max="1000">
                    </div>
                </div>

            <button class="confirm-button" id="confirmButton" onclick="confirmLocation()" disabled>
                <span id="confirmButtonText">Подтвердить выбор</span>
            </button>
        </div>

        <!-- Выбранная локация -->
        <div class="selected-location" id="selectedLocation" style="display: none;">
            <div class="location-title" id="selectedLocationTitle">Выбранная локация:</div>
            <div class="location-details" id="locationDetails"></div>
            
            <!-- Выбранные характеристики недвижимости -->
            <div class="selected-property-types" id="selectedPropertyTypes" style="display: none;">
                <div class="property-types-title" id="propertyTypesTitle">Выбранные характеристики недвижимости:</div>
                <div class="property-types-details" id="propertyTypesDetails"></div>
            </div>
            
            <div class="admin-ids" id="adminIds" style="display: none;">
                <div class="admin-title" id="adminIdsTitle">ID для админов:</div>
                <div class="admin-details" id="adminDetails"></div>
            </div>
        </div>

        <!-- Ключевые метрики - скрыты -->
        <div class="key-metrics-section" id="keyMetricsSection" style="display: none;">
            <!-- Ключевые метрики скрыты, показывается только таблица "Средние значения" -->
        </div>

        <!-- AI Insights Section -->
        <div class="insights-section" id="insightsSection" style="display: none;">
            <div class="insights-card">
                <div class="insights-header">
                    <div class="insights-title" id="insightsTitle">Саммари</div>
                </div>
                <div class="insights-content" id="insightsContent">
                    <div class="insights-loading" id="insightsLoading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" id="insightsLoadingText"></div>
                    </div>
                    <div class="insights-text" id="insightsText" style="display: none;"></div>
                    <div class="insights-error" id="insightsError" style="display: none;">
                        <div class="error-icon">⚠️</div>
                        <div class="error-text" id="insightsErrorText"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Content -->
        <div class="data-content" id="dataContent" style="display: none;">
            <!-- Market Indicators Table -->
            <div class="data-section" id="summaryDataSection">
                <h3 class="data-section-title" id="summaryDataTitle"></h3>
                <div class="data-section-content" id="summaryDataContent">
                    <!-- Market indicators data will be populated here -->
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-icon">❌</div>
            <div class="error-text" id="errorText">Ошибка загрузки данных</div>
        </div>

        <!-- Back Button -->
        <a href="/webapp_main" class="back-button" id="backButton">← Вернуться в главное меню</a>
    </div>

    <script>
        // Telegram WebApp initialization
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Current language
        let currentLanguage = 'ru';

        // Selected location data
        let selectedLocation = {
            country_id: null,
            city_id: null,
            county_id: null,
            district_id: null,
            country_name: '',
            city_name: '',
            county_name: '',
            district_name: ''
        };

        // User language
        let userLanguage = 'ru';

        // Selected listing types
        let selectedListingTypes = {
            house_type: null,
            floor_segment: null,
            age: null,
            heating: null
        };

        // Localization data
        const locales = {
            'ru': {
                'slogan': 'Инсайты рынка недвижимости',
                'pageTitle': 'Оценка объекта',
                'pageDescription': 'Получите профессиональную оценку стоимости недвижимости в выбранном регионе',
                'countryLabel': 'Страна:',
                'cityLabel': 'Город:',
                'countyLabel': 'Область/Регион:',
                'districtLabel': 'Район:',
                'countryPlaceholder': 'Выберите страну',
                'cityPlaceholder': 'Сначала выберите страну',
                'countyPlaceholder': 'Сначала выберите город',
                'districtPlaceholder': 'Сначала выберите область',
                'confirmButtonText': 'Подтвердить выбор',
                'backButton': '← Вернуться в главное меню',
                'selectedLocationTitle': 'Выбранная локация:',
                'adminIdsTitle': 'ID для админов:',
                'loading': 'Загрузка...',
                'errorLoading': 'Ошибка загрузки данных',
                'dataSectionTitle': 'Анализ данных региона',
                'loadingText': 'Загрузка данных...',
                'errorText': 'Ошибка загрузки данных',
                'totalProperties': 'Всего объектов:',
                'averagePrice': 'Средняя цена:',
                'priceRange': 'Диапазон цен:',
                'noDataAvailable': 'Данные недоступны',
                'keyMetricsTitle': 'Ключевые показатели',
                'avgSalePriceLabel': 'Средняя цена продажи за м²',
                'avgRentPriceLabel': 'Средняя цена аренды за м²',
                'listingPeriodSaleLabel': 'Период размещения (продажа)',
                'listingPeriodRentLabel': 'Период размещения (аренда)',
                'yieldLabel': 'Доходность',
                'insightsTitle': 'Саммари',
                'insightsLoading': 'Анализируем данные...',
                'insightsError': 'Ошибка при анализе данных',
                'listingTypeTitle': 'Выберите тип недвижимости для анализа:',
                'houseTypeSubtitle': 'Количество спален:',
                'floorSegmentSubtitle': 'Этаж:',
                'ageDataSubtitle': 'Возраст объекта:',
                'heatingDataSubtitle': 'Тип отопления:',
                'priceObjectSubtitle': 'Цена объекта:',
                'areaObjectSubtitle': 'Площадь объекта (м²):',
                'selectBedrooms': 'количество спален',
                'selectFloor': 'этаж',
                'selectAge': 'возраст объекта',
                'selectHeating': 'тип отопления',
                'propertyTypesTitle': 'Выбранные характеристики недвижимости:',
                'bedroomsLabel': 'Количество спален',
                'floorLabel': 'Этаж',
                'ageLabel': 'Возраст объекта',
                'heatingLabel': 'Тип отопления',
                'marketIndicatorsTitle': 'Показатели рынка',
                'marketTrendsTitle': 'Тренды рынка',
                'saleHeader': 'Продажа',
                'rentHeader': 'Аренда',
                'currencyTitle': 'Выберите валюту:',
                'pricePlaceholder': 'Введите цену',
                'areaPlaceholder': 'Введите площадь'
            },
            'en': {
                'slogan': 'Real Estate Market Insights',
                'pageTitle': 'Object Evaluation',
                'pageDescription': 'Get a professional property valuation in the selected region',
                'countryLabel': 'Country:',
                'cityLabel': 'City:',
                'countyLabel': 'Region/Area:',
                'districtLabel': 'District:',
                'countryPlaceholder': 'Select country',
                'cityPlaceholder': 'First select country',
                'countyPlaceholder': 'First select city',
                'districtPlaceholder': 'First select region',
                'confirmButtonText': 'Confirm selection',
                'backButton': '← Back to main menu',
                'selectedLocationTitle': 'Selected location:',
                'adminIdsTitle': 'IDs for admins:',
                'loading': 'Loading...',
                'errorLoading': 'Error loading data',
                'dataSectionTitle': 'Regional Data Analysis',
                'loadingText': 'Loading data...',
                'errorText': 'Error loading data',
                'totalProperties': 'Total properties:',
                'averagePrice': 'Average price:',
                'priceRange': 'Price range:',
                'noDataAvailable': 'Data not available',
                'keyMetricsTitle': 'Key Metrics',
                'avgSalePriceLabel': 'Average Sale Price per m²',
                'avgRentPriceLabel': 'Average Rent Price per m²',
                'listingPeriodSaleLabel': 'Listing Period (Sale)',
                'listingPeriodRentLabel': 'Listing Period (Rent)',
                'yieldLabel': 'Yield',
                'insightsTitle': 'Summary',
                'insightsLoading': 'Analyzing data...',
                'insightsError': 'Error analyzing data',
                'listingTypeTitle': 'Select property type for analysis:',
                'houseTypeSubtitle': 'Bedroom count:',
                'floorSegmentSubtitle': 'Floor:',
                'ageDataSubtitle': 'Property age:',
                'heatingDataSubtitle': 'Heating type:',
                'priceObjectSubtitle': 'Property price:',
                'areaObjectSubtitle': 'Property area (m²):',
                'selectBedrooms': 'bedroom count',
                'selectFloor': 'floor',
                'selectAge': 'property age',
                'selectHeating': 'heating type',
                'propertyTypesTitle': 'Selected property characteristics:',
                'bedroomsLabel': 'Bedroom count',
                'floorLabel': 'Floor',
                'ageLabel': 'Property age',
                'heatingLabel': 'Heating type',
                'marketIndicatorsTitle': 'Market Indicators',
                'marketTrendsTitle': 'Market Trends',
                'saleHeader': 'Sale',
                'rentHeader': 'Rent',
                'currencyTitle': 'Select currency:',
                'pricePlaceholder': 'Enter price',
                'areaPlaceholder': 'Enter area'
            },
            'de': {
                'slogan': 'Immobilienmarkt-Einblicke',
                'pageTitle': 'Objektbewertung',
                'pageDescription': 'Erhalten Sie eine professionelle Immobilienbewertung in der ausgewählten Region',
                'countryLabel': 'Land:',
                'cityLabel': 'Stadt:',
                'countyLabel': 'Region/Bereich:',
                'districtLabel': 'Bezirk:',
                'countryPlaceholder': 'Land auswählen',
                'cityPlaceholder': 'Zuerst Land auswählen',
                'countyPlaceholder': 'Zuerst Stadt auswählen',
                'districtPlaceholder': 'Zuerst Region auswählen',
                'confirmButtonText': 'Auswahl bestätigen',
                'backButton': '← Zurück zum Hauptmenü',
                'selectedLocationTitle': 'Ausgewählte Lage:',
                'adminIdsTitle': 'IDs für Administratoren:',
                'loading': 'Laden...',
                'errorLoading': 'Fehler beim Laden der Daten',
                'dataSectionTitle': 'Regionale Datenanalyse',
                'generalDataTitle': 'Allgemeine Daten',
                'houseTypeDataTitle': 'Schlafzimmer-Anzahl-Daten',
                'floorSegmentDataTitle': 'Etagen-Daten',
                'ageDataTitle': 'Altersdaten',
                'heatingDataTitle': 'Heizungstyp-Daten',
                'loadingText': 'Daten werden geladen...',
                'errorText': 'Fehler beim Laden der Daten',
                'totalProperties': 'Gesamtobjekte:',
                'averagePrice': 'Durchschnittspreis:',
                'priceRange': 'Preisbereich:',
                'noDataAvailable': 'Daten nicht verfügbar',
                'keyMetricsTitle': 'Wichtige Kennzahlen',
                'avgSalePriceLabel': 'Durchschnittlicher Verkaufspreis pro m²',
                'avgRentPriceLabel': 'Durchschnittlicher Mietpreis pro m²',
                'listingPeriodSaleLabel': 'Angebotsdauer (Verkauf)',
                'listingPeriodRentLabel': 'Angebotsdauer (Vermietung)',
                'yieldLabel': 'Rendite',
                'insightsTitle': 'Zusammenfassung',
                'insightsLoading': 'Daten werden analysiert...',
                'insightsError': 'Fehler bei der Datenanalyse'
            },
            'fr': {
                'slogan': 'Aperçus du marché immobilier',
                'pageTitle': 'Évaluation d\'objet',
                'pageDescription': 'Obtenez une évaluation professionnelle de propriété dans la région sélectionnée',
                'countryLabel': 'Pays :',
                'cityLabel': 'Ville :',
                'countyLabel': 'Région/Zone :',
                'districtLabel': 'District :',
                'countryPlaceholder': 'Sélectionner un pays',
                'cityPlaceholder': 'D\'abord sélectionner un pays',
                'countyPlaceholder': 'D\'abord sélectionner une ville',
                'districtPlaceholder': 'D\'abord sélectionner une région',
                'confirmButtonText': 'Confirmer la sélection',
                'backButton': '← Retour au menu principal',
                'selectedLocationTitle': 'Emplacement sélectionné :',
                'adminIdsTitle': 'IDs pour les administrateurs :',
                'loading': 'Chargement...',
                'errorLoading': 'Erreur de chargement des données',
                'dataSectionTitle': 'Analyse des données régionales',
                'generalDataTitle': 'Données générales',
                'houseTypeDataTitle': 'Données du nombre de chambres',
                'floorSegmentDataTitle': 'Données d\'étage',
                'ageDataTitle': 'Données d\'âge',
                'heatingDataTitle': 'Données du type de chauffage',
                'loadingText': 'Chargement des données...',
                'errorText': 'Erreur de chargement des données',
                'totalProperties': 'Total des propriétés :',
                'averagePrice': 'Prix moyen :',
                'priceRange': 'Fourchette de prix :',
                'noDataAvailable': 'Données non disponibles',
                'keyMetricsTitle': 'Métriques clés',
                'avgSalePriceLabel': 'Prix de vente moyen par m²',
                'avgRentPriceLabel': 'Prix de location moyen par m²',
                'listingPeriodSaleLabel': 'Période d\'inscription (vente)',
                'listingPeriodRentLabel': 'Période d\'inscription (location)',
                'yieldLabel': 'Rendement',
                'insightsTitle': 'Résumé',
                'insightsLoading': 'Analyse des données...',
                'insightsError': 'Erreur lors de l\'analyse des données'
            },
            'tr': {
                'slogan': 'Gayrimenkul Piyasa İçgörüleri',
                'pageTitle': 'Nesne Değerlendirmesi',
                'pageDescription': 'Seçilen bölgede profesyonel gayrimenkul değerlendirmesi alın',
                'countryLabel': 'Ülke:',
                'cityLabel': 'Şehir:',
                'countyLabel': 'Bölge/Alan:',
                'districtLabel': 'İlçe:',
                'countryPlaceholder': 'Ülke seçin',
                'cityPlaceholder': 'Önce ülke seçin',
                'countyPlaceholder': 'Önce şehir seçin',
                'districtPlaceholder': 'Önce bölge seçin',
                'confirmButtonText': 'Seçimi onayla',
                'backButton': '← Ana menüye dön',
                'selectedLocationTitle': 'Seçilen konum:',
                'adminIdsTitle': 'Yöneticiler için ID\'ler:',
                'loading': 'Yükleniyor...',
                'errorLoading': 'Veri yükleme hatası',
                'dataSectionTitle': 'Bölgesel Veri Analizi',
                'generalDataTitle': 'Genel Veriler',
                'houseTypeDataTitle': 'Yatak Odası Sayısı Verileri',
                'floorSegmentDataTitle': 'Kat Verileri',
                'ageDataTitle': 'Yaş Verileri',
                'heatingDataTitle': 'Isıtma Tipi Verileri',
                'loadingText': 'Veriler yükleniyor...',
                'errorText': 'Veri yükleme hatası',
                'totalProperties': 'Toplam mülk:',
                'averagePrice': 'Ortalama fiyat:',
                'priceRange': 'Fiyat aralığı:',
                'noDataAvailable': 'Veri mevcut değil',
                'keyMetricsTitle': 'Ana Metrikler',
                'avgSalePriceLabel': 'm² başına ortalama satış fiyatı',
                'avgRentPriceLabel': 'm² başına ortalama kiralama fiyatı',
                'listingPeriodSaleLabel': 'İlan süresi (satış)',
                'listingPeriodRentLabel': 'İlan süresi (kiralama)',
                'yieldLabel': 'Getiri',
                'insightsTitle': 'Özet',
                'insightsLoading': 'Veriler analiz ediliyor...',
                'insightsError': 'Veri analizi hatası'
            },
            'de': {
                'slogan': 'Immobilienmarkt-Einblicke',
                'pageTitle': 'Objektbewertung',
                'pageDescription': 'Erhalten Sie eine professionelle Immobilienbewertung in der ausgewählten Region',
                'countryLabel': 'Land:',
                'cityLabel': 'Stadt:',
                'countyLabel': 'Region/Bereich:',
                'districtLabel': 'Bezirk:',
                'countryPlaceholder': 'Land auswählen',
                'cityPlaceholder': 'Zuerst Land auswählen',
                'countyPlaceholder': 'Zuerst Stadt auswählen',
                'districtPlaceholder': 'Zuerst Region auswählen',
                'confirmButtonText': 'Auswahl bestätigen',
                'backButton': '← Zurück zum Hauptmenü',
                'selectedLocationTitle': 'Ausgewählte Lage:',
                'adminIdsTitle': 'IDs für Administratoren:',
                'loading': 'Laden...',
                'errorLoading': 'Fehler beim Laden der Daten',
                'dataSectionTitle': 'Regionale Datenanalyse',
                'generalDataTitle': 'Allgemeine Daten',
                'houseTypeDataTitle': 'Schlafzimmer-Anzahl-Daten',
                'floorSegmentDataTitle': 'Etagen-Daten',
                'ageDataTitle': 'Altersdaten',
                'heatingDataTitle': 'Heizungstyp-Daten',
                'loadingText': 'Daten werden geladen...',
                'errorText': 'Fehler beim Laden der Daten',
                'totalProperties': 'Gesamtobjekte:',
                'averagePrice': 'Durchschnittspreis:',
                'priceRange': 'Preisbereich:',
                'noDataAvailable': 'Daten nicht verfügbar',
                'keyMetricsTitle': 'Wichtige Kennzahlen',
                'avgSalePriceLabel': 'Durchschnittlicher Verkaufspreis pro m²',
                'avgRentPriceLabel': 'Durchschnittlicher Mietpreis pro m²',
                'listingPeriodSaleLabel': 'Angebotsdauer (Verkauf)',
                'listingPeriodRentLabel': 'Angebotsdauer (Vermietung)',
                'yieldLabel': 'Rendite',
                'insightsTitle': 'Zusammenfassung',
                'insightsLoading': 'Daten werden analysiert...',
                'insightsError': 'Fehler bei der Datenanalyse'
            },
            'fr': {
                'slogan': 'Aperçus du marché immobilier',
                'pageTitle': 'Évaluation d\'objet',
                'pageDescription': 'Obtenez une évaluation professionnelle de propriété dans la région sélectionnée',
                'countryLabel': 'Pays :',
                'cityLabel': 'Ville :',
                'countyLabel': 'Région/Zone :',
                'districtLabel': 'District :',
                'countryPlaceholder': 'Sélectionner un pays',
                'cityPlaceholder': 'D\'abord sélectionner un pays',
                'countyPlaceholder': 'D\'abord sélectionner une ville',
                'districtPlaceholder': 'D\'abord sélectionner une région',
                'confirmButtonText': 'Confirmer la sélection',
                'backButton': '← Retour au menu principal',
                'selectedLocationTitle': 'Emplacement sélectionné :',
                'adminIdsTitle': 'IDs pour les administrateurs :',
                'loading': 'Chargement...',
                'errorLoading': 'Erreur de chargement des données',
                'dataSectionTitle': 'Analyse des données régionales',
                'generalDataTitle': 'Données générales',
                'houseTypeDataTitle': 'Données du nombre de chambres',
                'floorSegmentDataTitle': 'Données d\'étage',
                'ageDataTitle': 'Données d\'âge',
                'heatingDataTitle': 'Données du type de chauffage',
                'loadingText': 'Chargement des données...',
                'errorText': 'Erreur de chargement des données',
                'totalProperties': 'Total des propriétés :',
                'averagePrice': 'Prix moyen :',
                'priceRange': 'Fourchette de prix :',
                'noDataAvailable': 'Données non disponibles',
                'keyMetricsTitle': 'Métriques clés',
                'avgSalePriceLabel': 'Prix de vente moyen par m²',
                'avgRentPriceLabel': 'Prix de location moyen par m²',
                'listingPeriodSaleLabel': 'Période d\'inscription (vente)',
                'listingPeriodRentLabel': 'Période d\'inscription (location)',
                'yieldLabel': 'Rendement',
                'insightsTitle': 'Résumé',
                'insightsLoading': 'Analyse des données...',
                'insightsError': 'Erreur lors de l\'analyse des données'
            },
            'tr': {
                'slogan': 'Gayrimenkul Piyasa İçgörüleri',
                'pageTitle': 'Nesne Değerlendirmesi',
                'pageDescription': 'Seçilen bölgede profesyonel gayrimenkul değerlendirmesi alın',
                'countryLabel': 'Ülke:',
                'cityLabel': 'Şehir:',
                'countyLabel': 'Bölge/Alan:',
                'districtLabel': 'İlçe:',
                'countryPlaceholder': 'Ülke seçin',
                'cityPlaceholder': 'Önce ülke seçin',
                'countyPlaceholder': 'Önce şehir seçin',
                'districtPlaceholder': 'Önce bölge seçin',
                'confirmButtonText': 'Seçimi onayla',
                'backButton': '← Ana menüye dön',
                'selectedLocationTitle': 'Seçilen konum:',
                'adminIdsTitle': 'Yöneticiler için ID\'ler:',
                'loading': 'Yükleniyor...',
                'errorLoading': 'Veri yükleme hatası',
                'dataSectionTitle': 'Bölgesel Veri Analizi',
                'generalDataTitle': 'Genel Veriler',
                'houseTypeDataTitle': 'Yatak Odası Sayısı Verileri',
                'floorSegmentDataTitle': 'Kat Verileri',
                'ageDataTitle': 'Yaş Verileri',
                'heatingDataTitle': 'Isıtma Tipi Verileri',
                'loadingText': 'Veriler yükleniyor...',
                'errorText': 'Veri yükleme hatası',
                'totalProperties': 'Toplam mülk:',
                'averagePrice': 'Ortalama fiyat:',
                'priceRange': 'Fiyat aralığı:',
                'noDataAvailable': 'Veri mevcut değil',
                'keyMetricsTitle': 'Ana Metrikler',
                'avgSalePriceLabel': 'm² başına ortalama satış fiyatı',
                'avgRentPriceLabel': 'm² başına ortalama kiralama fiyatı',
                'listingPeriodSaleLabel': 'İlan süresi (satış)',
                'listingPeriodRentLabel': 'İlan süresi (kiralama)',
                'yieldLabel': 'Getiri',
                'insightsTitle': 'Özet',
                'insightsLoading': 'Veriler analiz ediliyor...',
                'insightsError': 'Veri analizi hatası'
            }
        };

        // Get localized text
        function getText(key) {
            return locales[currentLanguage][key] || key;
        }

        // Update page text based on current language
        function updatePageText() {
            document.getElementById('slogan').textContent = getText('slogan');
            document.getElementById('pageTitle').textContent = getText('pageTitle');
            document.getElementById('pageDescription').textContent = getText('pageDescription');
            document.getElementById('countryLabel').textContent = getText('countryLabel');
            document.getElementById('cityLabel').textContent = getText('cityLabel');
            document.getElementById('countyLabel').textContent = getText('countyLabel');
            document.getElementById('districtLabel').textContent = getText('districtLabel');
            document.getElementById('countryPlaceholder').textContent = getText('countryPlaceholder');
            document.getElementById('cityPlaceholder').textContent = getText('cityPlaceholder');
            document.getElementById('countyPlaceholder').textContent = getText('countyPlaceholder');
            document.getElementById('districtPlaceholder').textContent = getText('districtPlaceholder');
            document.getElementById('confirmButtonText').textContent = getText('confirmButtonText');
            document.getElementById('backButton').textContent = getText('backButton');
            document.getElementById('selectedLocationTitle').textContent = getText('selectedLocationTitle');
            document.getElementById('adminIdsTitle').textContent = getText('adminIdsTitle');
            
            // Update new data section elements
            const dataSectionTitle = document.getElementById('dataSectionTitle');
            if (dataSectionTitle) {
                dataSectionTitle.textContent = getText('dataSectionTitle');
            }
            
            const summaryDataTitle = document.getElementById('summaryDataTitle');
            if (summaryDataTitle) {
                summaryDataTitle.textContent = getText('marketIndicatorsTitle');
            }

            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = getText('loadingText');
            }
            
            const errorText = document.getElementById('errorText');
            if (errorText) {
                errorText.textContent = getText('errorText');
            }
            
            // Update key metrics labels
            const keyMetricsTitle = document.getElementById('keyMetricsTitle');
            if (keyMetricsTitle) {
                keyMetricsTitle.textContent = getText('keyMetricsTitle');
            }
            
            const avgSalePriceLabel = document.getElementById('avgSalePriceLabel');
            if (avgSalePriceLabel) {
                avgSalePriceLabel.textContent = getText('avgSalePriceLabel');
            }
            
            const avgRentPriceLabel = document.getElementById('avgRentPriceLabel');
            if (avgRentPriceLabel) {
                avgRentPriceLabel.textContent = getText('avgRentPriceLabel');
            }
            
            const listingPeriodSaleLabel = document.getElementById('listingPeriodSaleLabel');
            if (listingPeriodSaleLabel) {
                listingPeriodSaleLabel.textContent = getText('listingPeriodSaleLabel');
            }
            
            const listingPeriodRentLabel = document.getElementById('listingPeriodRentLabel');
            if (listingPeriodRentLabel) {
                listingPeriodRentLabel.textContent = getText('listingPeriodRentLabel');
            }
            
            const yieldLabel = document.getElementById('yieldLabel');
            if (yieldLabel) {
                yieldLabel.textContent = getText('yieldLabel');
            }
            
            // Update insights title
            const insightsTitle = document.getElementById('insightsTitle');
            if (insightsTitle) {
                insightsTitle.textContent = getText('insightsTitle');
            }
            
            // Update insights loading and error text
            const insightsLoadingText = document.getElementById('insightsLoadingText');
            if (insightsLoadingText) {
                insightsLoadingText.textContent = getText('insightsLoading');
            }
            
            // Update listing type selection elements
            const listingTypeTitle = document.getElementById('listingTypeTitle');
            if (listingTypeTitle) { listingTypeTitle.textContent = getText('listingTypeTitle'); }
            const houseTypeSubtitle = document.getElementById('houseTypeSubtitle');
            if (houseTypeSubtitle) { houseTypeSubtitle.textContent = getText('houseTypeSubtitle'); }
            const floorSegmentSubtitle = document.getElementById('floorSegmentSubtitle');
            if (floorSegmentSubtitle) { floorSegmentSubtitle.textContent = getText('floorSegmentSubtitle'); }
            const ageDataSubtitle = document.getElementById('ageDataSubtitle');
            if (ageDataSubtitle) { ageDataSubtitle.textContent = getText('ageDataSubtitle'); }
            const heatingDataSubtitle = document.getElementById('heatingDataSubtitle');
            if (heatingDataSubtitle) { heatingDataSubtitle.textContent = getText('heatingDataSubtitle'); }
            
            // Update new fields
            const priceObjectSubtitle = document.getElementById('priceObjectSubtitle');
            if (priceObjectSubtitle) { priceObjectSubtitle.textContent = getText('priceObjectSubtitle'); }
            const areaObjectSubtitle = document.getElementById('areaObjectSubtitle');
            if (areaObjectSubtitle) { areaObjectSubtitle.textContent = getText('areaObjectSubtitle'); }
            
            // Update currency title
            const currencyTitle = document.getElementById('currencyTitle');
            if (currencyTitle) { currencyTitle.textContent = getText('currencyTitle'); }
            
            // Update placeholders
            const priceObjectInput = document.getElementById('priceObjectInput');
            if (priceObjectInput) { priceObjectInput.placeholder = getText('pricePlaceholder'); }
            const areaObjectInput = document.getElementById('areaObjectInput');
            if (areaObjectInput) { areaObjectInput.placeholder = getText('areaPlaceholder'); }
            
            // Update placeholder texts
            const houseTypePlaceholder = document.getElementById('houseTypePlaceholder');
            if (houseTypePlaceholder) { houseTypePlaceholder.textContent = getText('selectBedrooms'); }
            const floorSegmentPlaceholder = document.getElementById('floorSegmentPlaceholder');
            if (floorSegmentPlaceholder) { floorSegmentPlaceholder.textContent = getText('selectFloor'); }
            const ageDataPlaceholder = document.getElementById('ageDataPlaceholder');
            if (ageDataPlaceholder) { ageDataPlaceholder.textContent = getText('selectAge'); }
            const heatingDataPlaceholder = document.getElementById('heatingDataPlaceholder');
            if (heatingDataPlaceholder) { heatingDataPlaceholder.textContent = getText('selectHeating'); }
            
            // Update property types section
            const propertyTypesTitle = document.getElementById('propertyTypesTitle');
            if (propertyTypesTitle) { propertyTypesTitle.textContent = getText('propertyTypesTitle'); }
            
            const insightsErrorText = document.getElementById('insightsErrorText');
            if (insightsErrorText) {
                insightsErrorText.textContent = getText('insightsError');
            }
        }

        // Load countries from API
        async function loadCountries() {
            try {
                const response = await fetch('/api/locations/countries');
                const data = await response.json();
                
                if (data.success) {
                    const countrySelect = document.getElementById('countrySelect');
                    countrySelect.innerHTML = `<option value="">${getText('countryPlaceholder')}</option>`;
                    
                    data.countries.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        countrySelect.appendChild(option);
                    });
                } else {
                    console.error('Failed to load countries:', data.error);
                }
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // Load cities based on selected country
        async function loadCities(countryId) {
            try {
                const response = await fetch('/api/locations/cities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ country_id: countryId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = `<option value="">${getText('cityPlaceholder')}</option>`;
                    
                    data.cities.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        citySelect.appendChild(option);
                    });
                    
                    citySelect.disabled = false;
                } else {
                    console.error('Failed to load cities:', data.error);
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Load counties based on selected city
        async function loadCounties(cityId) {
            try {
                const response = await fetch('/api/locations/counties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ city_id: cityId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const countySelect = document.getElementById('countySelect');
                    countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
                    
                    data.counties.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        countySelect.appendChild(option);
                    });
                    
                    countySelect.disabled = false;
                } else {
                    console.error('Failed to load cities:', data.error);
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Load available listing types for each data category
        async function loadListingTypes() {
            try {
                console.log('🔄 Загружаем доступные listing_type для выбранной локации...');
                
                // Get current location values
                const countrySelect = document.getElementById('countrySelect');
                const citySelect = document.getElementById('citySelect');
                const countySelect = document.getElementById('countySelect');
                const districtSelect = document.getElementById('districtSelect');
                
                // Check if all required location fields are filled
                if (!countrySelect.value || !citySelect.value || !countySelect.value) {
                    console.log('❌ Не все обязательные поля локации заполнены, пропускаем загрузку listing_type');
                    return;
                }
                
                const locationData = {
                    country_id: countrySelect.value,
                    city_id: citySelect.value,
                    county_id: countySelect.value,
                    district_id: districtSelect.value || 'none'
                };
                
                console.log('📍 Location data for listing types:', locationData);
                
                // Load house type listing types
                const houseTypeResponse = await fetch('/api/listing_types/house_type_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });
                const houseTypeData = await houseTypeResponse.json();
                if (houseTypeData.success) {
                    console.log('✅ House type listing types loaded:', houseTypeData.listing_types);
                    populateListingTypeSelect('houseTypeSelect', houseTypeData.listing_types, 'house_type');
                } else {
                    console.error('❌ Failed to load house type listing types:', houseTypeData.error);
                }

                // Load floor segment listing types
                const floorSegmentResponse = await fetch('/api/listing_types/floor_segment_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });
                const floorSegmentData = await floorSegmentResponse.json();
                if (floorSegmentData.success) {
                    console.log('✅ Floor segment listing types loaded:', floorSegmentData.listing_types);
                    populateListingTypeSelect('floorSegmentSelect', floorSegmentData.listing_types, 'floor_segment');
                } else {
                    console.error('❌ Failed to load floor segment listing types:', floorSegmentData.error);
                }

                // Load age data listing types
                const ageDataResponse = await fetch('/api/listing_types/age_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });
                const ageDataData = await ageDataResponse.json();
                if (ageDataData.success) {
                    console.log('✅ Age data listing types loaded:', ageDataData.listing_types);
                    populateListingTypeSelect('ageDataSelect', ageDataData.listing_types, 'age');
                } else {
                    console.error('❌ Failed to load age data listing types:', ageDataData.error);
                }

                // Load heating data listing types
                const heatingDataResponse = await fetch('/api/listing_types/heating_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });
                const heatingDataData = await heatingDataResponse.json();
                if (heatingDataData.success) {
                    console.log('✅ Heating data listing types loaded:', heatingDataData.listing_types);
                    populateListingTypeSelect('heatingDataSelect', heatingDataData.listing_types, 'heating');
                } else {
                    console.error('❌ Failed to load heating data listing types:', heatingDataData.error);
                }
                
                console.log('✅ Все listing_type загружены для выбранной локации');
            } catch (error) {
                console.error('❌ Error loading listing types:', error);
            }
        }

        // Populate listing type select with options
        function populateListingTypeSelect(selectId, listingTypes, category) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.error(`❌ Select element not found: ${selectId}`);
                return;
            }

            console.log(`🔄 Populating select ${selectId} with ${listingTypes.length} types for category ${category}:`, listingTypes);
            
            // Clear existing options except the first placeholder
            select.innerHTML = '<option value="">' + getSelectPlaceholder(category) + '</option>';
            
            listingTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
            
            // Add change event listener
            select.onchange = () => selectListingType(category, select.value);
            
            console.log(`✅ Select ${selectId} populated with ${listingTypes.length} items`);
        }
        
        // Get placeholder text for select dropdowns
        function getSelectPlaceholder(category) {
            const placeholders = {
                'house_type': 'количество спален',
                'floor_segment': 'этаж',
                'age': 'возраст объекта',
                'heating': 'тип отопления'
            };
            return placeholders[category] || 'тип недвижимости';
        }

        // Reset listing type selection
        function resetListingTypeSelection() {
            selectedListingTypes = {
                house_type: null,
                floor_segment: null,
                age: null,
                heating: null,
                price: null,
                currency: 'EUR',
                area: 50
            };
            
            // Hide listing type section
            const listingTypeSection = document.getElementById('listingTypeSection');
            if (listingTypeSection) {
                listingTypeSection.style.display = 'none';
            }
            
            // Reset all select dropdowns
            const selects = ['houseTypeSelect', 'floorSegmentSelect', 'ageDataSelect', 'heatingDataSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.value = '';
                }
            });
            
            // Reset price and area fields
            const priceInput = document.getElementById('priceObjectInput');
            const areaInput = document.getElementById('areaObjectInput');
            
            if (priceInput) priceInput.value = '';
            if (areaInput) areaInput.value = '';
            
            // Reset currency buttons
            const currencyButtons = document.querySelectorAll('.currency-button');
            currencyButtons.forEach(button => {
                button.classList.remove('active');
            });
            // Set EUR as default active
            const eurButton = document.querySelector('.currency-button[data-currency="EUR"]');
            if (eurButton) eurButton.classList.add('active');
            
            // Hide selected property types section
            const selectedPropertyTypes = document.getElementById('selectedPropertyTypes');
            if (selectedPropertyTypes) {
                selectedPropertyTypes.style.display = 'none';
            }
        }

        // Handle listing type selection
        function selectListingType(category, type) {
            console.log(`🎯 Selecting listing type: ${category} = ${type}`);
            
            if (type && type !== '') {
                selectedListingTypes[category] = type;
                console.log(`✅ Selected: ${category} = ${type}`);
            } else {
                selectedListingTypes[category] = null;
                console.log(`❌ Deselected: ${category}`);
            }
            
            // Update the display of selected property types
            updateSelectedPropertyTypesDisplay();
            
            updateConfirmButton();
            
            // Check if all listing types are selected
            const allTypesSelected = selectedListingTypes.house_type && 
                                   selectedListingTypes.floor_segment && 
                                   selectedListingTypes.age && 
                                   selectedListingTypes.heating &&
                                   selectedListingTypes.price &&
                                   selectedListingTypes.area;
            
            console.log('🔍 All listing types selected:', allTypesSelected, selectedListingTypes);
            
            // If all types are selected, automatically load region data
            if (allTypesSelected) {
                console.log('🚀 All listing types selected, automatically loading region data...');
                // Small delay to ensure UI updates are complete
                setTimeout(() => {
                    confirmLocation();
                }, 100);
            }
        }

        // Load districts based on selected county
        async function loadDistricts(countyId) {
            console.log('🔄 Loading districts for county_id:', countyId);
            
            try {
                const response = await fetch('/api/locations/districts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ county_id: countyId })
                });
                
                const data = await response.json();
                console.log('📊 Districts API response:', data);
                
                if (data.success) {
                    const districtSelect = document.getElementById('districtSelect');
                    districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
                    
                    // Add "не имеет значения" option
                    const noDistrictOption = document.createElement('option');
                    noDistrictOption.value = 'none';
                    noDistrictOption.textContent = 'Не имеет значения';
                    districtSelect.appendChild(noDistrictOption);
                    
                    console.log('📍 Adding districts:', data.districts);
                    data.districts.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        districtSelect.appendChild(option);
                    });
                    
                    districtSelect.disabled = false;
                    console.log('✅ Districts loaded, district select enabled');
                } else {
                    console.error('❌ Failed to load districts:', data.error);
                }
            } catch (error) {
                console.error('❌ Error loading districts:', error);
            }
        }

        // Event handlers for location changes
        function onCountryChange() {
            const countrySelect = document.getElementById('countrySelect');
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countryId = countrySelect.value;
            
            // Reset dependent selects
            citySelect.innerHTML = `<option value="">${getText('cityPlaceholder')}</option>`;
            citySelect.disabled = true;
            countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
            countySelect.disabled = true;
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Reset listing type selection and hide section
            resetListingTypeSelection();
            const listingTypeSection = document.getElementById('listingTypeSection');
            if (listingTypeSection) {
                listingTypeSection.style.display = 'none';
            }
            
            if (countryId) {
                loadCities(countryId);
            }
            
            updateConfirmButton();
        }

        function onCityChange() {
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const cityId = citySelect.value;
            
            // Reset dependent selects
            countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
            countySelect.disabled = true;
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Reset listing type selection and hide section
            resetListingTypeSelection();
            const listingTypeSection = document.getElementById('listingTypeSection');
            if (listingTypeSection) {
                listingTypeSection.style.display = 'none';
            }
            
            if (cityId) {
                loadCounties(cityId);
            }
            
            updateConfirmButton();
        }

        function onCountyChange() {
            console.log('🔄 County changed, starting onCountyChange function...');
            
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countyId = countySelect.value;
            console.log('📍 Selected county_id:', countyId);
            
            // Reset dependent selects
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            console.log('🔄 Reset district select');
            
            // Reset listing type selection and hide section
            resetListingTypeSelection();
            const listingTypeSection = document.getElementById('listingTypeSection');
            if (listingTypeSection) {
                listingTypeSection.style.display = 'none';
            }
            
            if (countyId) {
                console.log('✅ County selected, loading districts for county_id:', countyId);
                loadDistricts(countyId);
            } else {
                console.log('❌ No county selected');
            }
            
            updateConfirmButton();
        }

        function onDistrictChange() {
            console.log('🔄 District changed, updating confirm button...');
            updateConfirmButton();
            
            // Show listing type selection section when district is selected
            const districtSelect = document.getElementById('districtSelect');
            const listingTypeSection = document.getElementById('listingTypeSection');
            
            console.log('📍 District value:', districtSelect.value);
            
            if (districtSelect.value && districtSelect.value !== 'none') {
                console.log('✅ District selected, showing listing type section and loading types...');
                listingTypeSection.style.display = 'block';
                // Load available listing types for the selected location
                loadListingTypes();
            } else {
                console.log('❌ No district selected, hiding listing type section...');
                listingTypeSection.style.display = 'none';
                // Reset listing type selection when district is cleared
                resetListingTypeSelection();
            }
        }

        // Update selected property types display
        function updateSelectedPropertyTypesDisplay() {
            const selectedPropertyTypes = document.getElementById('selectedPropertyTypes');
            const propertyTypesDetails = document.getElementById('propertyTypesDetails');
            
            if (!selectedPropertyTypes || !propertyTypesDetails) return;
            
            // Check if any property types are selected
            const hasSelectedTypes = selectedListingTypes.house_type || 
                                   selectedListingTypes.floor_segment || 
                                   selectedListingTypes.age || 
                                   selectedListingTypes.heating ||
                                   selectedListingTypes.price ||
                                   selectedListingTypes.area;
            
            if (hasSelectedTypes) {
                selectedPropertyTypes.style.display = 'block';
                
                let html = '';
                
                if (selectedListingTypes.house_type) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">${getText('bedroomsLabel')}:</span>
                            <span class="property-type-value">${selectedListingTypes.house_type}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.floor_segment) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">${getText('floorLabel')}:</span>
                            <span class="property-type-value">${selectedListingTypes.floor_segment}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.age) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">${getText('ageLabel')}:</span>
                            <span class="property-type-value">${selectedListingTypes.age}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.heating) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">${getText('heatingLabel')}:</span>
                            <span class="property-type-value">${selectedListingTypes.heating}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.price) {
                    const currencySymbols = {
                        'TRY': '₺',
                        'EUR': '€',
                        'USD': '$'
                    };
                    const currencySymbol = currencySymbols[selectedListingTypes.currency] || '';
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">Цена объекта:</span>
                            <span class="property-type-value">${currencySymbol}${selectedListingTypes.price}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.area) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">Площадь объекта:</span>
                            <span class="property-type-value">${selectedListingTypes.area} м²</span>
                        </div>
                    `;
                }
                
                propertyTypesDetails.innerHTML = html;
            } else {
                selectedPropertyTypes.style.display = 'none';
            }
        }

        // Update confirm button state
        function updateConfirmButton() {
            const countrySelect = document.getElementById('countrySelect');
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            const confirmButton = document.getElementById('confirmButton');
            
            const hasCountry = countrySelect.value;
            const hasCity = citySelect.value;
            const hasCounty = countySelect.value;
            const hasDistrict = districtSelect.value && districtSelect.value !== '';
            
            // Check if all listing types are selected (only if district is selected and not "none")
            let hasAllListingTypes = true;
            if (hasDistrict && districtSelect.value !== 'none') {
                hasAllListingTypes = selectedListingTypes.house_type && 
                                   selectedListingTypes.floor_segment && 
                                   selectedListingTypes.age && 
                                   selectedListingTypes.heating &&
                                   selectedListingTypes.price &&
                                   selectedListingTypes.area;
                
                console.log('🔍 Checking listing types:', {
                    house_type: selectedListingTypes.house_type,
                    floor_segment: selectedListingTypes.floor_segment,
                    age: selectedListingTypes.age,
                    heating: selectedListingTypes.heating,
                    price: selectedListingTypes.price,
                    area: selectedListingTypes.area,
                    hasAllListingTypes: hasAllListingTypes
                });
            }
            
            // Button is enabled if all location fields are filled
            // For listing types: if district is "none", no listing types required
            // If district is selected, all listing types are required
            const isDisabled = !(hasCountry && hasCity && hasCounty && hasDistrict) || 
                              (hasDistrict && districtSelect.value !== 'none' && !hasAllListingTypes);
            
            confirmButton.disabled = isDisabled;
            
            console.log('🔘 Confirm button state:', {
                hasCountry, hasCity, hasCounty, hasDistrict,
                districtValue: districtSelect.value,
                hasAllListingTypes,
                isDisabled
            });
        }

        // Confirm location selection
        async function confirmLocation() {
            console.log('🎯 confirmLocation function called');
            
            const countrySelect = document.getElementById('countrySelect');
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countryId = countrySelect.value;
            const cityId = citySelect.value;
            const countyId = countySelect.value;
            const districtId = districtSelect.value === 'none' ? null : districtSelect.value;
            
            // Get names for display
            const countryName = countrySelect.options[countrySelect.selectedIndex].text;
            const cityName = citySelect.options[citySelect.selectedIndex].text;
            const countyName = countySelect.options[countySelect.selectedIndex].text;
            const districtName = districtSelect.value === 'none' ? 'Не имеет значения' : districtSelect.options[districtSelect.selectedIndex].text;
            
            // Convert price to EUR if needed
            let priceInEUR = null;
            if (selectedListingTypes.price && selectedListingTypes.currency !== 'EUR') {
                priceInEUR = await convertToEUR(selectedListingTypes.price, selectedListingTypes.currency);
                console.log(`💰 Price converted: ${selectedListingTypes.price} ${selectedListingTypes.currency} → ${priceInEUR} EUR`);
            } else if (selectedListingTypes.price) {
                priceInEUR = selectedListingTypes.price;
            }
            
            // Update selected location
            selectedLocation = {
                country_id: countryId,
                city_id: cityId,
                county_id: countyId,
                district_id: districtId,
                country_name: countryName,
                city_name: cityName,
                county_name: countyName,
                district_name: districtName,
                // Add property details
                property_price: selectedListingTypes.price,
                property_price_currency: selectedListingTypes.currency,
                property_price_eur: priceInEUR,
                property_area: selectedListingTypes.area
            };
            
            console.log('📍 Selected location for data loading:', {
                country_id: countryId,
                city_id: cityId,
                county_id: countyId,
                district_id: districtId,
                country_name: countryName,
                city_name: cityName,
                county_name: countyName,
                district_name: districtName,
                property_price: selectedListingTypes.price,
                property_price_currency: selectedListingTypes.currency,
                property_price_eur: priceInEUR,
                property_area: selectedListingTypes.area
            });
            
            // Display selected location
            displaySelectedLocation();
            
            // Get user language
            await getUserLanguage();
            
            // Load region data with selected listing types
            await loadRegionData();
        }

        // Display selected location
        function displaySelectedLocation() {
            const selectedLocationDiv = document.getElementById('selectedLocation');
            const locationDetails = document.getElementById('locationDetails');
            const adminIds = document.getElementById('adminIds');
            const adminDetails = document.getElementById('adminDetails');
            
            // Build location string
            let locationString = selectedLocation.country_name;
            if (selectedLocation.city_name) {
                locationString += `, ${selectedLocation.city_name}`;
            }
            if (selectedLocation.county_name) {
                locationString += `, ${selectedLocation.county_name}`;
            }
            if (selectedLocation.district_name && selectedLocation.district_name !== 'Не имеет значения') {
                locationString += `, ${selectedLocation.district_name}`;
            }
            
            locationDetails.textContent = locationString;
            
            // Update selected property types display
            updateSelectedPropertyTypesDisplay();
            
            // Show admin IDs if user is admin
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user && user.id) {
                    // Check if user is admin (you can implement your own admin check logic)
                    const isAdmin = true; // Placeholder - implement your admin check
                    
                    if (isAdmin) {
                        adminDetails.innerHTML = `
                            country_id: ${selectedLocation.country_id}<br>
                            city_id: ${selectedLocation.city_id}<br>
                            county_id: ${selectedLocation.county_id}<br>
                            district_id: ${selectedLocation.district_id || 'null'}
                        `;
                        adminIds.style.display = 'block';
                    }
                }
            }
            
            selectedLocationDiv.style.display = 'block';
        }

        // Get user language
        async function getUserLanguage() {
            try {
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                    const user = window.Telegram.WebApp.initDataUnsafe.user;
                    if (user && user.id) {
                        const response = await fetch('/api/user/language', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ telegram_id: user.id })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            userLanguage = data.language;
                            currentLanguage = data.language;
                            updatePageText();
                        }
                    }
                }
            } catch (error) {
                console.error('Error getting user language:', error);
            }
        }

        // Load region data
        async function loadRegionData() {
            console.log('🚀 loadRegionData function called');
            
            try {
                const requestBody = {
                    country_id: selectedLocation.country_id,
                    city_id: selectedLocation.city_id,
                    county_id: selectedLocation.county_id,
                    district_id: selectedLocation.district_id,
                    listing_types: selectedListingTypes
                };
                
                console.log('🔄 Loading region data with request:', requestBody);
                
                const response = await fetch('/api/region_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                console.log('📊 API response:', data);
                
                if (data.success) {
                    displayRegionData(data);
                } else {
                    throw new Error(data.error || 'Failed to load region data');
                }
            } catch (error) {
                console.error('Error loading region data:', error);
                showError('Ошибка загрузки данных региона');
            }
        }

        // Display region data
        function displayRegionData(data) {
            console.log('📊 Processing received data:', data);
            console.log('🔍 Data structure:', {
                hasGeneralData: !!data.general_data,
                hasHouseTypeData: !!data.house_type_data,
                hasFloorSegmentData: !!data.floor_segment_data,
                hasAgeData: !!data.age_data,
                hasHeatingData: !!data.heating_data
            });
            
            // Try different possible key names for data
            const generalData = data.general_data || data.generalData || data.general || [];
            const houseTypeData = data.house_type_data || data.houseTypeData || data.house_types || data.houseTypes || [];
            const floorSegmentData = data.floor_segment_data || data.floorSegmentData || data.floor_segments || data.floorSegments || [];
            const ageData = data.age_data || data.ageData || data.ages || [];
            const heatingData = data.heating_data || data.heatingData || data.heating || [];
            
            console.log('🔍 Extracted data arrays:', {
                general: generalData.length,
                houseType: houseTypeData.length,
                floorSegment: floorSegmentData.length,
                age: ageData.length,
                heating: heatingData.length
            });
            
            // Data sections removed - only market indicators table is shown
            
            // Generate and display summary table
            generateSummaryTable(data);
            
            // Show data content
            document.getElementById('dataContent').style.display = 'block';
            
            // Get AI insights
            getRegionInsights(data);
        }









        // Format field name
        function formatFieldName(field) {
            // Convert snake_case to readable text
            return field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Format field value
        function formatFieldValue(value, field) {
            if (value === null || value === undefined) return '-';
            
            // Format based on field type
            if (typeof value === 'number') {
                if (field.includes('price') || field.includes('Price')) {
                    return formatValue(value, 'price');
                } else if (field.includes('yield') || field.includes('Yield')) {
                    // For yield, don't multiply by 100, just add % symbol
                    return `${parseFloat(value).toFixed(2)}%`;
                } else if (field.includes('rate')) {
                    return formatValue(value, 'percentage');
                } else if (field.includes('age') || field.includes('Age')) {
                    return formatValue(value, 'years');
                } else if (field.includes('period') || field.includes('Period')) {
                    return formatValue(value, 'days');
                } else {
                    return value.toLocaleString();
                }
            }
            
            return value.toString();
        }

        // Format value based on type
        function formatValue(value, type) {
            if (value === null || value === undefined || value === '-') return '-';
            
            switch (type) {
                case 'price':
                    return `₺${parseFloat(value).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                case 'percentage':
                    return `${parseFloat(value).toFixed(2)}%`;
                case 'years':
                    return `${value} лет`;
                case 'days':
                    return `${value} дней`;
                default:
                    return value.toString();
            }
        }

        // Generate analytical summary based on market data
        function generateAnalyticalSummary(summary) {
            let analysis = '<div class="analytical-summary">';
            analysis += '<h4 class="summary-title">Анализ рынка</h4>';
            
            // Age analysis
            if (summary.average_age_for_sale || summary.average_age_for_rent) {
                const saleAge = summary.average_age_for_sale;
                const rentAge = summary.average_age_for_rent;
                
                if (saleAge && rentAge) {
                    const minAge = Math.min(saleAge.min, rentAge.min);
                    const maxAge = Math.max(saleAge.max, rentAge.max);
                    analysis += `<p>В локации наиболее востребованы объекты возраста ${minAge}–${maxAge} года.</p>`;
                } else if (saleAge) {
                    analysis += `<p>В локации наиболее востребованы объекты возраста ${saleAge.min}–${saleAge.max} года.</p>`;
                } else if (rentAge) {
                    analysis += `<p>В локации наиболее востребованы объекты возраста ${rentAge.min}–${rentAge.max} года.</p>`;
                }
            }
            
            // Sale analysis
            if (summary.comparable_area_for_sale && summary.listing_period_for_sale && summary.min_unit_price_for_sale) {
                const area = summary.comparable_area_for_sale;
                const period = summary.listing_period_for_sale;
                const price = summary.min_unit_price_for_sale;
                
                analysis += `<p><strong>Продажа:</strong> востребованная площадь ${area.min}–${area.max} м², `;
                analysis += `срок экспозиции ${period.min}–${period.max} дней, `;
                analysis += `цена за м² ${formatValue(price.min, 'price')} – ${formatValue(price.max, 'price')}.</p>`;
            }
            
            // Rent analysis
            if (summary.comparable_area_for_rent && summary.listing_period_for_rent && summary.min_unit_price_for_rent) {
                const area = summary.comparable_area_for_rent;
                const period = summary.listing_period_for_rent;
                const price = summary.min_unit_price_for_rent;
                
                analysis += `<p><strong>Аренда:</strong> самая востребованная площадь ${area.min}–${area.max} м², `;
                analysis += `срок экспозиции ${period.min}–${period.max} дней, `;
                analysis += `ставка ${formatValue(price.min, 'price')} – ${formatValue(price.max, 'price')} за м².</p>`;
            }
            
            // Yield analysis
            if (summary.yield) {
                const yieldMin = summary.yield.min;
                const yieldMax = summary.yield.max;
                
                analysis += `<p><strong>Доходность</strong> составляет ${yieldMin.toFixed(2)}% – ${yieldMax.toFixed(2)}%.</p>`;
            }
            
            analysis += '</div>';
            return analysis;
        }

        // Generate market indicators table with organized structure
        function generateSummaryTable(data) {
            const summaryContainer = document.getElementById('summaryDataContent');
            if (!summaryContainer) return;
            
            // Collect all data from all tables
            const allData = [];
            const tables = ['general_data', 'house_type_data', 'floor_segment_data', 'age_data', 'heating_data'];
            
            tables.forEach(tableName => {
                const tableData = data[tableName] || [];
                if (Array.isArray(tableData)) {
                    allData.push(...tableData);
                }
            });
            
            if (allData.length === 0) {
                summaryContainer.innerHTML = `<div class="no-data">${getText('noDataAvailable')}</div>`;
                return;
            }
            
            // Define fields for summary with new structure
            const saleFields = [
                'average_age_for_sale', 'comparable_area_for_sale', 'count_for_sale', 
                'listing_period_for_sale', 'min_unit_price_for_sale'
            ];
            
            const rentFields = [
                'average_age_for_rent', 'comparable_area_for_rent', 'count_for_rent', 
                'listing_period_for_rent', 'min_unit_price_for_rent'
            ];
            
            // Calculate min/max values for all fields
            const summary = {};
            const allFields = [...saleFields, ...rentFields, 'yield'];
            
            allFields.forEach(field => {
                const values = allData
                    .map(item => item[field])
                    .filter(val => val !== null && val !== undefined && !isNaN(parseFloat(val)));
                
                if (values.length > 0) {
                    summary[field] = {
                        min: Math.min(...values),
                        max: Math.max(...values)
                    };
                }
            });
            
            // Generate market indicators table
            let html = '<table class="data-table summary-table">';
            html += '<thead><tr><th>Показатель</th><th>Минимальное значение</th><th>Максимальное значение</th></tr></thead><tbody>';
            
            // Add Sale section header
            html += `<tr class="section-header"><td colspan="3" class="sale-header">${getText('saleHeader')}</td></tr>`;
            
            // Add Sale fields
            saleFields.forEach(field => {
                if (summary[field]) {
                    const fieldName = field === 'min_unit_price_for_sale' ? 'Unit Price For Sale' : formatFieldName(field);
                    html += `
                        <tr>
                            <td>${fieldName}</td>
                            <td>${formatFieldValue(summary[field].min, field)}</td>
                            <td>${formatFieldValue(summary[field].max, field)}</td>
                        </tr>
                    `;
                }
            });
            
            // Add Rent section header
            html += `<tr class="section-header"><td colspan="3" class="rent-header">${getText('rentHeader')}</td></tr>`;
            
            // Add Rent fields
            rentFields.forEach(field => {
                if (summary[field]) {
                    const fieldName = field === 'min_unit_price_for_rent' ? 'Unit Price For Rent' : formatFieldName(field);
                    html += `
                        <tr>
                            <td>${fieldName}</td>
                            <td>${formatFieldValue(summary[field].min, field)}</td>
                            <td>${formatFieldValue(summary[field].max, field)}</td>
                        </tr>
                    `;
                }
            });
            
            // Add Yield with bold styling
            if (summary.yield) {
                html += '<tr class="yield-row"><td colspan="3" class="yield-header">Yield</td></tr>';
                html += `
                    <tr class="yield-data">
                        <td class="yield-label">Yield</td>
                        <td class="yield-value">${formatFieldValue(summary.yield.min, 'yield')}</td>
                        <td class="yield-value">${formatFieldValue(summary.yield.max, 'yield')}</td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            
            // Add analytical summary below the table
            if (Object.keys(summary).length > 0) {
                html += generateAnalyticalSummary(summary);
            }
            
            summaryContainer.innerHTML = html;
            
            // Load property trends data
            loadPropertyTrends(data);
        }

        // Load property trends data for selected location
        async function loadPropertyTrends(data) {
            try {
                // Use selected location data instead of searching through tables
                if (!selectedLocation.country_id || !selectedLocation.city_id || 
                    !selectedLocation.county_id || !selectedLocation.district_id) {
                    console.log('⚠️ No location selected for property trends');
                    return;
                }
                
                const locationIds = {
                    country_id: selectedLocation.country_id,
                    city_id: selectedLocation.city_id,
                    county_id: selectedLocation.county_id,
                    district_id: selectedLocation.district_id
                };
                
                console.log('🔄 Loading property trends for location:', locationIds);
                
                // Make API request to get property trends
                const response = await fetch('/api/property_trends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationIds)
                });
                
                const trendsData = await response.json();
                console.log('📊 Property trends response:', trendsData);
                
                if (trendsData.success && trendsData.trends && trendsData.trends.length > 0) {
                    console.log('✅ Property trends data received:', trendsData.trends);
                    console.log('🔍 First trend record:', trendsData.trends[0]);
                    
                    // Add property trends section below the summary table
                    addPropertyTrendsSection(trendsData.trends);
                } else {
                    console.log('⚠️ No property trends data available');
                    console.log('trendsData:', trendsData);
                }
                
            } catch (error) {
                console.error('❌ Error loading property trends:', error);
            }
        }
        
        // Find trend data for current month and year
        function findCurrentMonthTrend(typeTrends) {
            if (!typeTrends || typeTrends.length === 0) return null;
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() returns 0-11
            
            // Ищем тренд за текущий месяц и год
            const currentTrend = typeTrends.find(trend => {
                return trend.property_year === currentYear && trend.property_month === currentMonth;
            });
            
            // Если не нашли за текущий месяц, ищем за последний доступный месяц текущего года
            if (!currentTrend) {
                const currentYearTrends = typeTrends.filter(trend => trend.property_year === currentYear);
                if (currentYearTrends.length > 0) {
                    // Сортируем по месяцу и берем последний
                    currentYearTrends.sort((a, b) => b.property_month - a.property_month);
                    return currentYearTrends[0];
                }
            }
            
            // Если не нашли за текущий год, возвращаем последний доступный тренд
            return currentTrend || typeTrends[0];
        }

        // Format date for current month trends
        function formatCurrentMonthDate(trend) {
            if (trend.property_year && trend.property_month) {
                const monthNames = {
                    1: 'январь', 2: 'февраль', 3: 'март', 4: 'апрель', 5: 'май', 6: 'июнь',
                    7: 'июль', 8: 'август', 9: 'сентябрь', 10: 'октябрь', 11: 'ноябрь', 12: 'декабрь'
                };
                const monthName = monthNames[trend.property_month] || trend.property_month;
                return `${monthName} ${trend.property_year}`;
            }
            // Fallback to regular date formatting
            return formatTrendDateShort(trend.date);
        }

        // Add property trends section to the page
        function addPropertyTrendsSection(trends) {
            // Проверяем, не существует ли уже секция трендов
            if (document.getElementById('propertyTrendsSection')) {
                console.log('⚠️ Property trends section already exists, skipping...');
                return;
            }
            
            const summarySection = document.getElementById('summaryDataSection');
            if (!summarySection) return;
            
            // Create property trends section
            const trendsSection = document.createElement('div');
            trendsSection.className = 'data-section';
            trendsSection.id = 'propertyTrendsSection';
            
            // Группируем тренды по типам
            const groupedTrends = groupTrendsByType(trends);
            
            trendsSection.innerHTML = `
                <h3 class="data-section-title">${getText('marketTrendsTitle')}</h3>
                <div class="data-section-content">
                    <div class="trends-grid">
                        ${Object.entries(groupedTrends).map(([type, typeTrends]) => {
                            // Найти тренд за текущий месяц и год
                            const currentTrend = findCurrentMonthTrend(typeTrends);
                            if (!currentTrend) return '';
                            
                            return `
                                <div class="trend-card trend-card-${type}">
                                    <div class="trend-title">${formatTrendType(type)}</div>
                                    <div class="trend-value">${formatTrendValue(currentTrend.trend_value, type)}</div>
                                    <div class="trend-details">
                                        <div class="trend-change">
                                            ${currentTrend.price_change_sale ? `Продажа: ${formatPercentage(currentTrend.price_change_sale)}` : ''}
                                            ${currentTrend.price_change_rent ? `Аренда: ${formatPercentage(currentTrend.price_change_rent)}` : ''}
                                        </div>
                                        <div class="trend-date">${formatCurrentMonthDate(currentTrend)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Таблица со всеми записями трендов -->
                    <div class="trends-table-section">
                        <h4 class="trends-table-title">Детальные данные трендов</h4>
                        <div class="trends-table-container">
                            ${generateTrendsTable(trends)}
                        </div>
                    </div>
                </div>
            `;
            
            // Insert after summary section
            summarySection.parentNode.insertBefore(trendsSection, summarySection.nextSibling);
        }
        
        // Group trends by type for better display
        function groupTrendsByType(trends) {
            const grouped = {};
            trends.forEach(trend => {
                const key = trend.trend_type || 'general';
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(trend);
            });
            return grouped;
        }
        
        // Format trend type for display
        function formatTrendType(type) {
            const typeMap = {
                'price_trend': 'Тренд цен',
                'yield_trend': 'Тренд доходности',
                'count_trend': 'Тренд количества',
                'general': 'Общий тренд'
            };
            return typeMap[type] || type;
        }
        
        // Format percentage values
        function formatPercentage(value) {
            if (value === null || value === undefined) return '-';
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return '-';
            const sign = numValue >= 0 ? '+' : '';
            return `${sign}${(numValue * 100).toFixed(2)}%`;
        }
        
        // Format trend date
        function formatTrendDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ru-RU', { 
                    year: 'numeric', 
                    month: 'short' 
                });
            } catch (e) {
                return dateStr;
            }
        }
        
        // Format trend date without "г." for shorter display
        function formatTrendDateShort(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ru-RU', { 
                    year: 'numeric', 
                    month: 'short' 
                });
            } catch (e) {
                return dateStr;
            }
        }

        // Generate detailed trends table
        function generateTrendsTable(trends) {
            if (!trends || trends.length === 0) {
                return '<div class="no-data">Нет данных для отображения</div>';
            }
            
            console.log('🔍 generateTrendsTable called with trends:', trends);
            
            let html = '<table class="trends-table">';
            html += '<thead><tr>';
            html += '<th>Дата</th>';
            html += '<th>Продажа<br>(₺/м²)</th>';
            html += '<th>Изм-ие цены<br>продажи</th>';
            html += '<th>Аренда<br>(₺/м²)</th>';
            html += '<th>Изм-ие цены<br>аренды</th>';
            html += '<th>Доходность</th>';
            html += '</tr></thead><tbody>';
            
            trends.forEach((trend, index) => {
                // Логируем данные для отладки
                console.log(`🔍 Trend ${index + 1} data:`, {
                    date: trend.date,
                    unit_price_for_sale: trend.unit_price_for_sale,
                    unit_price_for_rent: trend.unit_price_for_rent,
                    trend_value: trend.trend_value,
                    price_change_sale: trend.price_change_sale,
                    price_change_rent: trend.price_change_rent,
                    yield: trend.yield
                });
                
                // Логируем результаты форматирования
                const formattedSalePrice = formatTrendValue(trend.unit_price_for_sale, 'price');
                const formattedRentPrice = formatTrendValue(trend.unit_price_for_rent, 'price');
                const formattedYield = formatTrendValue(trend.yield, 'percentage');
                
                console.log(`🔍 Formatted values for trend ${index + 1}:`, {
                    salePrice: formattedSalePrice,
                    rentPrice: formattedRentPrice,
                    yield: formattedYield
                });
                
                html += '<tr>';
                html += `<td>${formatTrendDateShort(trend.date)}</td>`;
                html += `<td>${formattedSalePrice}</td>`;
                html += `<td>${formatPercentage(trend.price_change_sale)}</td>`;
                html += `<td>${formattedRentPrice}</td>`;
                html += `<td>${formatPercentage(trend.price_change_rent)}</td>`;
                html += `<td>${formattedYield}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // Format trend value based on type
        function formatTrendValue(value, type) {
            console.log(`🔍 formatTrendValue called with:`, { value, type, valueType: typeof value });
            
            if (value === null || value === undefined) {
                console.log(`  ❌ Value is null/undefined, returning '-'`);
                return '-';
            }
            
            if (type && type.includes('price')) {
                console.log(`  💰 Processing as price`);
                return formatValue(value, 'price');
            } else if (type && type.includes('percentage')) {
                console.log(`  📊 Processing as percentage`);
                return formatValue(value, 'percentage');
            } else if (typeof value === 'number') {
                console.log(`  🔢 Processing as number`);
                // Если это число, форматируем его
                if (value >= 1000) {
                    return value.toLocaleString('ru-RU');
                } else {
                    return value.toFixed(2);
                }
            } else {
                console.log(`  📝 Processing as string`);
                return value.toString();
            }
        }
        
        // Helper function to format values consistently
        function formatValue(value, type) {
            console.log(`🔍 formatValue called with:`, { value, type, valueType: typeof value });
            
            if (value === null || value === undefined) {
                console.log(`  ❌ Value is null/undefined, returning '-'`);
                return '-';
            }
            
            if (type === 'price') {
                console.log(`  💰 Processing as price`);
                if (typeof value === 'number') {
                    const result = `₺${value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    console.log(`  ✅ Price formatted: ${result}`);
                    return result;
                }
                console.log(`  ⚠️ Value is not a number, converting to string`);
                return value.toString();
            } else if (type === 'percentage') {
                console.log(`  📊 Processing as percentage`);
                if (typeof value === 'number') {
                    const result = `${value.toFixed(2)}%`;
                    console.log(`  ✅ Percentage formatted: ${result}`);
                    return result;
                }
                console.log(`  ⚠️ Value is not a number, converting to string`);
                return value.toString();
            }
            
            console.log(`  📝 Default processing, converting to string`);
            return value.toString();
        }
        
        // Format trend period
        function formatTrendPeriod(period) {
            if (!period) return '';
            
            // Convert period to readable format
            const periodMap = {
                'monthly': 'Месячный',
                'quarterly': 'Квартальный',
                'yearly': 'Годовой',
                'weekly': 'Недельный'
            };
            
            return periodMap[period] || period;
        }

        // Get AI insights for the region data
        async function getRegionInsights(regionData) {
            try {
                console.log('🧠 Запрашиваем AI-вывод для данных региона');
                
                // Show insights section
                const insightsSection = document.getElementById('insightsSection');
                const insightsLoading = document.getElementById('insightsLoading');
                const insightsText = document.getElementById('insightsText');
                const insightsError = document.getElementById('insightsError');
                
                insightsSection.style.display = 'block';
                insightsLoading.style.display = 'flex';
                insightsText.style.display = 'none';
                insightsError.style.display = 'none';
                
                // Update loading text based on user language
                const loadingText = document.getElementById('insightsLoadingText');
                loadingText.textContent = getText('insightsLoading');
                
                // Prepare data for AI analysis
                const analysisData = {
                    region_data: regionData,
                    language: userLanguage
                };
                
                // Make API request to get AI insights
                const response = await fetch('/api/region_insights', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(analysisData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Hide loading and show insights
                    insightsLoading.style.display = 'none';
                    insightsText.style.display = 'block';
                    
                    // Update insights text
                    const insightsTextElement = document.getElementById('insightsText');
                    insightsTextElement.textContent = data.insights;
                    
                    console.log('✅ AI-вывод получен:', data.insights);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('❌ Ошибка получения AI-вывода:', error);
                
                // Hide loading and show error
                const insightsLoading = document.getElementById('insightsLoading');
                const insightsError = document.getElementById('insightsError');
                const insightsErrorText = document.getElementById('insightsErrorText');
                
                insightsLoading.style.display = 'none';
                insightsError.style.display = 'flex';
                insightsErrorText.textContent = getText('insightsError');
            }
        }



        // Show error
        function showError(message) {
            const errorState = document.getElementById('errorState');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorState.style.display = 'block';
        }

        // Function to go to main menu
        function goToMainMenu() {
            window.location.href = '/webapp_main';
        }

        // Function to convert currency to EUR (base currency)
        async function convertToEUR(amount, fromCurrency) {
            if (fromCurrency === 'EUR') {
                return amount;
            }
            
            try {
                // Get current exchange rates from currency table
                const response = await fetch('/api/currency/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        from_currency: fromCurrency,
                        to_currency: 'EUR'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    return data.converted_amount;
                } else {
                    console.error('Currency conversion error:', data.error);
                    return amount; // Return original amount if conversion fails
                }
            } catch (error) {
                console.error('Error converting currency:', error);
                return amount; // Return original amount if conversion fails
            }
        }

        // Initialize page
        function init() {
            updatePageText();
            loadCountries();
            
            // Initialize price input
            const priceInput = document.getElementById('priceObjectInput');
            if (priceInput) {
                priceInput.addEventListener('input', function() {
                    selectedListingTypes.price = this.value ? parseFloat(this.value) : null;
                    updateConfirmButton();
                });
            }
            
            // Initialize area input
            const areaInput = document.getElementById('areaObjectInput');
            if (areaInput) {
                areaInput.addEventListener('input', function() {
                    selectedListingTypes.area = this.value ? parseInt(this.value) : null;
                    updateConfirmButton();
                });
            }
            
            // Initialize currency buttons
            const currencyButtons = document.querySelectorAll('.currency-button');
            currencyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const selectedCurrency = this.dataset.currency;
                    
                    // Remove active class from all buttons
                    currencyButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update selected currency
                    selectedListingTypes.currency = selectedCurrency;
                });
            });
            
            // Set EUR as default active currency
            const eurButton = document.querySelector('.currency-button[data-currency="EUR"]');
            if (eurButton) {
                eurButton.classList.add('active');
                selectedListingTypes.currency = 'EUR';
            }
        }

        // Start initialization when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
