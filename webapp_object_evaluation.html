<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - Оценка объекта</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Header Styles */
        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin: 20px 0 10px 0;
        }

        .page-description {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 25px;
            line-height: 1.4;
        }

        /* Form Styles */
        .location-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
        }

        .form-group select:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .confirm-button {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .confirm-button:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Listing Type Selection Styles */
        .listing-type-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #e0e0e0;
        }

        .listing-type-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            text-align: center;
        }

        .listing-type-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .listing-type-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .listing-type-select:hover {
            border-color: #667eea;
        }

        .listing-type-group {
            margin-bottom: 15px;
        }

        .listing-type-subtitle {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            padding-left: 4px;
        }

        /* Selected Location Styles */
        .selected-location {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .location-title {
            font-size: 16px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .location-details {
            font-size: 14px;
            color: #333;
            line-height: 1.4;
        }

        .selected-property-types {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #4caf50;
        }

        .property-types-title {
            font-size: 14px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .property-types-details {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }

        .property-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #e8f5e8;
        }

        .property-type-item:last-child {
            border-bottom: none;
        }

        .property-type-label {
            font-weight: 500;
            color: #2e7d32;
        }

        .property-type-value {
            color: #333;
            font-weight: 600;
        }

        .admin-ids {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #4caf50;
        }

        .admin-title {
            font-size: 14px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .admin-details {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }
        
        /* Стили для отдельного блока с ID для админов */
        .admin-ids-block {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .admin-ids-title {
            font-size: 16px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .admin-ids-details {
            font-size: 12px;
            color: #666;
            font-family: monospace;
            line-height: 1.6;
        }
        
        /* Стили для сообщения об ограниченном доступе */
        .admin-restricted-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .admin-restricted-message p {
            margin: 0;
            color: #856404;
            font-size: 14px;
            font-weight: 500;
        }

        /* Key Metrics Styles */
        .key-metrics-section {
            margin-bottom: 20px;
        }

        .key-metrics-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .metric-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .metric-card.yield-card {
            grid-column: 1 / -1;
            background: #f0f0f0;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .yield-label {
            font-size: 17px;
        }

        .yield-value {
            font-size: 17px;
        }





        /* Data Card Styles */
        .data-content {
            margin-bottom: 20px;
        }

        .data-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .data-section-content {
            padding: 0;
        }
        
        .data-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .data-item-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin: 0 0 12px 0;
        }
        
        .data-available {
            padding: 15px;
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 6px;
            color: #2e7d32;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }
        
        .summary-table-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            padding-bottom: 12px;
        }
        
        .summary-table-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        .summary-table {
            margin-top: 0;
        }
        
        .summary-table-container {
            overflow-x: hidden;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-table th {
            background: #28a745;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            line-height: 1.2;
            word-wrap: break-word;
        }
        
        .summary-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            word-wrap: break-word;
        }
        
        .summary-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .summary-table tr:hover {
            background: #e9ecef;
        }
        
        .section-header {
            background: #f0f8ff !important;
            color: #495057;
            font-weight: 600;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 14px;
        }
        
        .sale-header {
            background: #f0f8ff !important;
            color: #495057;
            border: 1px solid #dee2e6;
            font-weight: 600;
        }
        
        .rent-header {
            background: #f0f8ff !important;
            color: #495057;
            border: 1px solid #dee2e6;
            font-weight: 600;
        }
        
        .yield-header {
            background: #f0f8ff !important;
            color: #495057;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #dee2e6;
        }
        
        .yield-data {
            background: #f8f9fa !important;
            border: 1px solid #dee2e6;
        }
        
        .yield-label {
            font-weight: 600;
            color: #495057;
        }
        
        .yield-value {
            font-weight: 600;
            color: #495057;
        }
        
        /* Стили для объединенной карточки показателей рынка в стиле консолидированной оценки */
        .market-indicators-unified {
            margin-top: 20px;
        }
        
        .unified-indicator-card {
            background: #f8f9fa;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .unified-indicator-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #28a745;
        }
        
        .indicator-section {
            padding: 25px 30px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .indicator-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #333333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .indicator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .indicator-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .indicator-label {
            color: #333333;
            font-weight: 500;
            font-size: 15px;
        }
        
        .indicator-value {
            color: #4CAF50;
            font-weight: 600;
            font-size: 15px;
        }
        
        /* Мобильные устройства для объединенной карточки показателей рынка */
        @media (max-width: 768px) {
            .market-indicators-unified {
                margin-top: 16px;
            }
            
            .unified-indicator-card {
                border-radius: 12px;
            }
            
            .indicator-section {
                padding: 16px 20px 16px 26px;
            }
            
            .section-title {
                font-size: 15px;
                margin-bottom: 14px;
            }
            
            .indicator-item {
                padding: 10px 0;
                margin-bottom: 6px;
            }
            
            .indicator-label,
            .indicator-value {
                font-size: 13px;
            }
            
            /* Мобильные стили для блока "Анализ рынка" */
            .market-analysis-text-block {
                margin: 24px 0;
                padding: 22px;
                border-radius: 14px;
            }
            
            .market-analysis-text-title {
                font-size: 17px;
                margin-bottom: 18px;
            }
            
            .market-analysis-text-content {
                font-size: 13px;
            }
            
            /* Мобильные стили для блока с ID для админов */
            .admin-ids-block {
                padding: 14px;
                border-radius: 7px;
                margin-bottom: 18px;
            }
            
            .admin-ids-title {
                font-size: 15px;
                margin-bottom: 9px;
            }
            
            .admin-ids-details {
                font-size: 11px;
            }
            
            /* Мобильные стили для сообщения об ограниченном доступе */
            .admin-restricted-message {
                padding: 12px;
                margin: 16px 0;
                border-radius: 6px;
            }
            
            .admin-restricted-message p {
                font-size: 13px;
            }
            
            /* Мобильные стили для блока "Вывод по объекту" */
            .object-summary-section {
                margin: 24px 0;
                padding: 22px;
                border-radius: 14px;
            }
            
            .object-summary-title {
                font-size: 17px;
                margin-bottom: 18px;
            }
            
            .object-summary-content {
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .market-indicators-unified {
                margin-top: 14px;
            }
            
            .unified-indicator-card {
                border-radius: 10px;
            }
            
            .indicator-section {
                padding: 14px 18px 14px 24px;
            }
            
            .section-title {
                font-size: 14px;
                margin-bottom: 12px;
            }
            
            .indicator-item {
                padding: 8px 0;
                margin-bottom: 4px;
            }
            
            .indicator-label,
            .indicator-value {
                font-size: 12px;
            }
            
            /* Мобильные стили для блока "Анализ рынка" */
            .market-analysis-text-block {
                margin: 20px 0;
                padding: 20px;
                border-radius: 12px;
            }
            
            .market-analysis-text-title {
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .market-analysis-text-content {
                font-size: 13px;
            }
            
            /* Мобильные стили для блока с ID для админов */
            .admin-ids-block {
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 14px;
            }
            
            .admin-ids-title {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .admin-ids-details {
                font-size: 10px;
            }
            
            /* Мобильные стили для сообщения об ограниченном доступе */
            .admin-restricted-message {
                padding: 10px;
                margin: 14px 0;
                border-radius: 5px;
            }
            
            .admin-restricted-message p {
                font-size: 12px;
            }
            
            /* Мобильные стили для блока "Вывод по объекту" */
            .object-summary-section {
                margin: 20px 0;
                padding: 20px;
                border-radius: 12px;
            }
            
            .object-summary-title {
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .object-summary-content {
                font-size: 13px;
            }
        }
        
        /* Пустое место между блоками */
        .block-spacing {
            height: 40px;
            margin: 0;
            padding: 0;
        }
        
        /* Стили для блока "Вывод по объекту" в стиле "Вывод по тренду" */
        .object-summary-section {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .object-summary-title {
            font-size: 18px;
            font-weight: 700;
            color: #333333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .object-summary-content {
            line-height: 1.6;
            color: #333333;
            font-size: 14px;
        }
        
        .object-summary-content p {
            margin: 0 0 15px 0;
            padding: 0;
        }
        
        .object-summary-content p:last-child {
            margin-bottom: 0;
        }
        
        .object-summary-content strong {
            color: #1a202c;
            font-weight: 700;
        }
        
        /* Стили для блока "Анализ рынка" в стиле "Вывод по тренду" */
        .market-analysis-text-block {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .market-analysis-text-title {
            font-size: 18px;
            font-weight: 700;
            color: #333333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .market-analysis-text-content {
            line-height: 1.6;
            color: #333333;
            font-size: 14px;
        }
        
        .market-analysis-text-content p {
            margin: 0 0 15px 0;
            padding: 0;
        }
        
        .market-analysis-text-content p:last-child {
            margin-bottom: 0;
        }
        
        .market-analysis-text-content strong {
            color: #1a202c;
            font-weight: 700;
        }
        
        /* Стили для объединенного анализа рынка в стиле "Вывод прогноза" */
        .market-analysis-unified {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .analysis-title {
            font-size: 18px;
            font-weight: 700;
            color: #333333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .analysis-content {
            line-height: 1.6;
        }
        
        .analysis-section {
            margin: 0 0 20px 0;
            padding: 0;
            color: #333333;
            font-size: 14px;
        }
        
        .analysis-section:last-child {
            margin-bottom: 0;
        }
        
        .analysis-section strong {
            color: #1a202c;
            font-weight: 700;
        }
        
        /* Разделитель между секциями анализа */
        .section-spacing {
            height: 20px;
            margin: 0;
            padding: 0;
        }
        
        /* Стили для аккордеона администратора */
        .admin-data-accordion {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .accordion-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            padding-bottom: 12px;
        }
        
        .accordion-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 1px;
        }
        
        .accordion-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .accordion-item {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .accordion-header {
            padding: 18px 22px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .accordion-header:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        
        .accordion-header.active {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        
        .accordion-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            padding: 0;
        }
        
        .accordion-icon {
            font-size: 14px;
            transition: transform 0.2s ease;
        }
        
        .accordion-content {
            display: none;
            padding: 0;
        }
        
        .accordion-table-container {
            padding: 20px;
            overflow-x: auto;
        }
        
        .accordion-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .accordion-table th,
        .accordion-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .accordion-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2d3748;
        }
        
        .accordion-table td.field-name {
            font-weight: 500;
            color: #4a5568;
        }
        
        .accordion-table td.field-value {
            color: #2d3748;
        }
        
        /* Мобильные устройства для объединенного анализа рынка */
        @media (max-width: 768px) {
            .market-analysis-unified {
                margin: 25px 0;
                padding: 20px;
                border-radius: 12px;
            }
            
            .analysis-title {
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .analysis-section {
                margin-bottom: 14px;
                font-size: 13px;
            }
            
            .block-spacing {
                height: 30px;
            }
            
            .section-spacing {
                height: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .market-analysis-unified {
                margin: 20px 0;
                padding: 16px;
                border-radius: 10px;
            }
            
            .analysis-title {
                font-size: 15px;
                margin-bottom: 14px;
            }
            
            .analysis-section {
                margin-bottom: 12px;
                font-size: 12px;
            }
            
            .block-spacing {
                height: 25px;
            }
            
            .section-spacing {
                height: 14px;
            }
        }
        
        /* Мобильные устройства для аккордеона */
        @media (max-width: 768px) {
            .admin-data-accordion {
                margin: 25px 0;
                padding: 20px;
                border-radius: 12px;
            }
            
            .accordion-title {
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .accordion-header {
                padding: 16px 20px;
            }
            
            .accordion-table-container {
                padding: 16px;
            }
            
            .accordion-table th,
            .accordion-table td {
                padding: 10px 12px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .admin-data-accordion {
                margin: 20px 0;
                padding: 16px;
                border-radius: 10px;
            }
            
            .accordion-title {
                font-size: 15px;
                margin-bottom: 14px;
            }
            
            .accordion-header {
                padding: 14px 18px;
            }
            
            .accordion-table-container {
                padding: 14px;
            }
            
            .accordion-table th,
            .accordion-table td {
                padding: 8px 10px;
                font-size: 12px;
            }
        }
        
        /* Мобильные устройства для таблицы показателей рынка */
        @media (max-width: 768px) {
            .summary-table-title {
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .summary-table {
                font-size: 10px;
            }
            
            .summary-table th,
            .summary-table td {
                padding: 4px 2px;
            }
        }
        
        /* Detailed Data Tables Styles */
        .detailed-data-section {
            margin-top: 25px;
            margin-bottom: 20px;
        }
        
        .detailed-data-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .detailed-data-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background: white;
        }
        
        .detailed-data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 12px;
            min-width: 600px;
        }
        
        .detailed-data-table th {
            background: #28a745;
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            line-height: 1.2;
            word-wrap: break-word;
            border: 1px solid #dee2e6;
        }
        
        .detailed-data-table td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #dee2e6;
            word-wrap: break-word;
            vertical-align: middle;
        }
        
        .detailed-data-table .field-name {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            text-align: left;
            padding-left: 12px;
            min-width: 150px;
        }
        
        .detailed-data-table .field-value {
            background: white;
            color: #333;
        }
        
        .detailed-data-table tr:nth-child(even) .field-value {
            background: #f8f9fa;
        }
        
        .detailed-data-table tr:hover .field-value {
            background: #e9ecef;
        }
        
        /* Mobile responsive for detailed data tables */
        @media (max-width: 768px) {
            .detailed-data-section {
                margin-top: 20px;
                margin-bottom: 15px;
            }
            
            .detailed-data-title {
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .detailed-data-table {
                font-size: 11px;
                min-width: 500px;
            }
            
            .detailed-data-table th,
            .detailed-data-table td {
                padding: 6px 4px;
            }
            
            .detailed-data-table .field-name {
                min-width: 120px;
                padding-left: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .detailed-data-table {
                font-size: 10px;
                min-width: 400px;
            }
            
            .detailed-data-table th,
            .detailed-data-table td {
                padding: 4px 2px;
            }
            
            .detailed-data-table .field-name {
                min-width: 100px;
                padding-left: 6px;
            }
        }
        
        /* Consolidated Assessment Styles */
        .consolidated-assessment-section {
            margin-top: 25px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            overflow: hidden;
        }
        
        .consolidated-assessment-title {
            font-size: 18px;
            font-weight: 600;
            color: #495057;
            margin: 0;
            padding: 20px 20px 15px 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .consolidated-assessment-content {
            padding: 20px;
        }
        
        .assessment-category {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .assessment-category:last-child {
            margin-bottom: 0;
        }
        
        .assessment-category-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin: 0 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .assessment-items {
            margin-bottom: 15px;
        }
        
        .assessment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .assessment-item:last-child {
            border-bottom: none;
        }
        
        .assessment-label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        .assessment-value {
            font-weight: 600;
            color: #28a745;
            font-size: 14px;
        }
        
        .assessment-consolidated {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #e8f5e8;
            border-radius: 6px;
            border: 1px solid #4caf50;
        }
        
        .assessment-consolidated-label {
            font-weight: 600;
            color: #2e7d32;
            font-size: 14px;
        }
        
        .assessment-consolidated-value {
            font-weight: 700;
            color: #2e7d32;
            font-size: 16px;
        }
        
        /* Mobile responsive for consolidated assessment */
        @media (max-width: 768px) {
            .consolidated-assessment-section {
                margin-top: 20px;
                margin-bottom: 15px;
            }
            
            .consolidated-assessment-title {
                font-size: 16px;
                padding: 15px 15px 12px 15px;
            }
            
            .consolidated-assessment-content {
                padding: 15px;
            }
            
            .assessment-category {
                padding: 12px;
                margin-bottom: 20px;
            }
            
            .assessment-category-title {
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .assessment-item {
                padding: 6px 0;
            }
            
            .assessment-label,
            .assessment-value {
                font-size: 13px;
            }
            
            .assessment-consolidated {
                padding: 10px 12px;
            }
            
            .assessment-consolidated-label,
            .assessment-consolidated-value {
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .consolidated-assessment-title {
                font-size: 15px;
                padding: 12px 12px 10px 12px;
            }
            
            .consolidated-assessment-content {
                padding: 12px;
            }
            
            .assessment-category {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .assessment-category-title {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .assessment-item {
                padding: 5px 0;
            }
            
            .assessment-label,
            .assessment-value {
                font-size: 12px;
            }
            
            .assessment-consolidated {
                padding: 8px 10px;
            }
            
            .assessment-consolidated-label,
            .assessment-consolidated-value {
                font-size: 12px;
            }
        }
        
        /* Market Comparison Block Styles */
        .market-comparison-block {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            overflow: hidden;
        }
        
        .market-comparison-content {
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .market-comparison-content::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #28a745;
        }
        
        .market-comparison-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
        }
        
        .market-comparison-value {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 15px;
        }
        
        .market-comparison-details {
            margin-bottom: 15px;
        }
        
        .market-comparison-price,
        .market-comparison-area {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .market-comparison-analysis {
            text-align: left;
        }
        
        .market-comparison-analysis p {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 8px;
        }
        
        .market-comparison-analysis p:last-child {
            margin-bottom: 0;
        }
        
        .market-comparison-analysis strong {
            color: #495057;
            font-weight: 600;
        }
        
        /* Мобильные устройства для блока сравнения с рынком */
        @media (max-width: 768px) {
            .market-comparison-block {
                margin-top: 15px;
            }
            
            .market-comparison-content {
                padding: 15px;
            }
            
            .market-comparison-title {
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .market-comparison-value {
                font-size: 20px;
                margin-bottom: 12px;
            }
            
            .market-comparison-price,
            .market-comparison-area {
                font-size: 13px;
            }
            
            .market-comparison-analysis p {
                font-size: 13px;
                line-height: 1.5;
            }
        }
        
        /* Analytical Summary Styles */
        .analytical-summary {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .analytical-summary p {
            font-size: 14px;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 12px;
        }
        
        .analytical-summary strong {
            color: #333;
            font-weight: 600;
        }
        
        /* Property Trends Styles */
        .trends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .trend-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .trend-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .trend-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .trend-value {
            font-size: 18px;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 5px;
        }
        
        .trend-period {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }
        
        .trend-details {
            margin-top: 8px;
        }
        
        .trend-change {
            font-size: 11px;
            color: #495057;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .trend-date {
            font-size: 10px;
            color: #6c757d;
            font-style: italic;
        }
        
        .trend-card-price_trend {
            border-left: 4px solid #28a745;
        }
        
        .trend-card-yield_trend {
            border-left: 4px solid #ffc107;
        }
        
        .trend-card-count_trend {
            border-left: 4px solid #17a2b8;
        }
        
        /* Trends Table Styles */
        .trends-table-section {
            margin-top: 25px;
        }
        
        .trends-table-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .trends-table-container {
            overflow-x: hidden;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .trends-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 11px;
            table-layout: fixed;
        }
        
        .trends-table th {
            background: #28a745;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            line-height: 1.2;
            word-wrap: break-word;
        }
        
        .trends-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            word-wrap: break-word;
        }
        
        .trends-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .trends-table tr:hover {
            background: #e9ecef;
        }
        
        /* Специальные стили для ширины столбцов трендов */
        .trends-table th:nth-child(1) { width: 15%; } /* Дата */
        .trends-table th:nth-child(2) { width: 18%; } /* Продажа */
        .trends-table th:nth-child(3) { width: 18%; } /* Изм-ие цены продажи */
        .trends-table th:nth-child(4) { width: 18%; } /* Аренда */
        .trends-table th:nth-child(5) { width: 18%; } /* Изм-ие цены аренды */
        .trends-table th:nth-child(6) { width: 13%; } /* Доходность */
        
        /* Стили для информационной строки о фильтрации */
        .trends-table .filter-info td {
            border: none;
            font-style: italic;
        }
        
        /* Стили для выделения текущего месяца */
        .trends-table .current-month-row {
            background-color: #e8f4fd !important;
            font-weight: 500;
        }
        
        .trends-table .current-month-row td {
            border-top: 2px solid #007bff;
            border-bottom: 2px solid #007bff;
        }
        
        /* Стили для строк прогноза в таблице трендов */
        .trends-table .forecast-row {
            background-color: #f0f8ff;
        }
        
        /* Мобильные устройства */
        @media (max-width: 768px) {
            .trends-table {
                font-size: 10px;
            }
            
            .trends-table th,
            .trends-table td {
                padding: 4px 2px;
            }
            
            .trends-table th:nth-child(1) { width: 18%; }
            .trends-table th:nth-child(2) { width: 17%; }
            .trends-table th:nth-child(3) { width: 17%; }
            .trends-table th:nth-child(4) { width: 17%; }
            .trends-table th:nth-child(5) { width: 17%; }
            .trends-table th:nth-child(6) { width: 14%; }
                }
        
        /* Trends Analysis Styles */
        .trends-analysis-section {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        /* Forecast Table Styles */
        .forecast-table-section {
            margin-top: 20px;
        }
        
        .forecast-table-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .forecast-table-container {
            overflow-x: hidden;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 11px;
            table-layout: fixed;
        }
        
        .forecast-table th {
            background: #28a745;
            color: white;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            line-height: 1.2;
            word-wrap: break-word;
        }
        
        .forecast-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            word-wrap: break-word;
        }
        
        .forecast-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .forecast-table tr:hover {
            background: #e9ecef;
        }
        
        /* Специальные стили для ширины столбцов прогноза */
        .forecast-table th:nth-child(1) { width: 20%; } /* Дата */
        .forecast-table th:nth-child(2) { width: 30%; } /* Прогноз продажи */
        .forecast-table th:nth-child(3) { width: 30%; } /* Прогноз аренды */
        .forecast-table th:nth-child(4) { width: 20%; } /* Прогноз доходности */
        
        /* Стили для информационной строки о прогнозе */
        .forecast-table .forecast-info td {
            border: none;
            font-style: italic;
        }
        
        /* Стили для выделения текущего месяца в прогнозе */
        .forecast-table .current-month-row {
            background-color: #e8f4fd !important;
            font-weight: 500;
        }
        
        .forecast-table .current-month-row td {
            border-top: 2px solid #007bff;
            border-bottom: 2px solid #007bff;
        }
        
        /* Стили для строк прогноза */
        .forecast-table .forecast-row {
            background-color: #f0f8ff;
        }
        
        /* Мобильные устройства для таблицы прогноза */
        @media (max-width: 768px) {
            .forecast-table {
                font-size: 10px;
            }
            
            .forecast-table th,
            .forecast-table td {
                padding: 4px 2px;
            }
            
            .forecast-table th:nth-child(1) { width: 22%; }
            .forecast-table th:nth-child(2) { width: 28%; }
            .forecast-table th:nth-child(3) { width: 28%; }
            .forecast-table th:nth-child(4) { width: 22%; }
        }
        
        .trends-analysis-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .trends-analysis-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        /* Мобильные устройства для блока анализа */
        @media (max-width: 768px) {
            .trends-analysis-section {
                padding: 15px;
                margin-top: 15px;
            }
            
            .trends-analysis-title {
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .trends-analysis-content {
                font-size: 13px;
                line-height: 1.5;
            }
        }
        
        /* Forecast Analysis Styles */
        .forecast-analysis-section {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .forecast-analysis-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .forecast-analysis-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            text-align: justify;
        }
        
        .forecast-analysis-content p {
            margin-bottom: 12px;
        }
        
        .forecast-analysis-content p:last-child {
            margin-bottom: 0;
        }
        
        /* Мобильные устройства для блока анализа прогноза */
        @media (max-width: 768px) {
            .forecast-analysis-section {
                padding: 15px;
                margin-top: 15px;
            }
            
            .forecast-analysis-title {
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .forecast-analysis-content {
                font-size: 13px;
                line-height: 1.5;
            }
        }
        
        /* Price Forecast Block Styles - в стиле "Тренд цен" */
        .price-forecast-block {
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
            position: relative;
        }
        
        .price-forecast-content {
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        .price-forecast-content::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #28a745;
        }
        
        .price-forecast-title {
            font-size: 18px;
            font-weight: 700;
            color: #333333;
            margin-bottom: 20px;
        }
        
        .price-forecast-sale-section,
        .price-forecast-rent-section {
            margin-bottom: 16px;
        }
        
        .price-forecast-sale-label,
        .price-forecast-rent-label {
            font-size: 15px;
            color: #333333;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .price-forecast-sale-value,
        .price-forecast-rent-value {
            font-size: 20px;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 8px;
        }
        
        .price-forecast-date {
            font-size: 14px;
            color: #666666;
            margin-bottom: 8px;
        }
        
        .price-forecast-currency-info {
            font-size: 12px;
            color: #999999;
            font-style: italic;
        }
        
        /* Мобильные устройства для блока прогноза цен */
        @media (max-width: 768px) {
            .price-forecast-block {
                margin-top: 15px;
            }
            
            .price-forecast-content {
                padding: 20px 24px;
            }
            
            .price-forecast-title {
                font-size: 16px;
                margin-bottom: 16px;
            }
            
            .price-forecast-sale-value,
            .price-forecast-rent-value {
                font-size: 18px;
                margin-bottom: 6px;
            }
            
            .price-forecast-sale-label,
            .price-forecast-rent-label {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            .price-forecast-date {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .price-forecast-currency-info {
                font-size: 11px;
            }
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 10px;
            table-layout: fixed;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .data-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 0;
        }

        .data-table td:first-child {
            font-weight: 500;
            color: #555;
            width: 60%;
            text-align: left;
        }

        .data-table td:last-child {
            text-align: right;
            font-weight: 600;
            color: #333;
            width: 40%;
        }

        /* Sub-card Styles */
        .sub-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }

        .sub-card h3 {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sub-card h4 {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin: 8px 0 6px 0;
        }

        /* Error State Styles */
        .error-state {
            text-align: center;
            padding: 20px 15px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            margin: 15px 0;
        }

        .error-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .error-text {
            font-size: 14px;
            color: #721c24;
        }

        /* Back Button Styles */
        .back-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile responsive styles */
        @media (max-width: 480px) {
            
            /* Мобильные стили для секций данных */
            .data-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .data-section-title {
                font-size: 16px;
                margin-bottom: 12px;
                padding-bottom: 8px;
            }
            
            .data-item {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .data-item-title {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .summary-table th,
            .summary-table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .section-header td {
                font-size: 13px;
                padding: 10px 6px;
            }
            
            .yield-header {
                font-size: 16px;
            }
            
            .trends-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .trend-card {
                padding: 12px;
            }
            
            .trend-title {
                font-size: 13px;
            }
            
            .trend-value {
                font-size: 16px;
            }
            
            .trend-period {
                font-size: 11px;
            }
            
            .trend-details {
                margin-top: 6px;
            }
            
            .trend-change {
                font-size: 10px;
                margin-bottom: 3px;
            }
            
            .trend-date {
                font-size: 9px;
            }
            
            .trends-table-title {
                font-size: 14px;
                margin-bottom: 12px;
            }
            
            .trends-table {
                font-size: 11px;
            }
            
            .trends-table th,
            .trends-table td {
                padding: 6px 4px;
            }
            
            .data-available {
                padding: 12px;
                font-size: 13px;
            }
        }

        /* Price and Area Input Styles */
        .listing-type-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #333;
            margin-bottom: 10px;
        }

        .listing-type-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* Currency Buttons Styles */
        .currency-buttons-container {
            margin-bottom: 15px;
        }

        .currency-buttons-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .currency-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .currency-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px;
        }

        .currency-button:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .currency-button.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .currency-button.active .currency-symbol {
            color: white;
        }

        .currency-symbol {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        /* Mobile responsive for listing type selection */
        @media (max-width: 480px) {
            .listing-type-section {
                padding: 12px;
                margin: 12px 0;
            }
            
            .listing-type-title {
                font-size: 13px;
                margin-bottom: 10px;
            }
            
            .listing-type-subtitle {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .listing-type-select {
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .listing-type-input {
                padding: 8px 10px;
                font-size: 13px;
                margin-bottom: 8px;
            }
            
            .currency-buttons {
                gap: 4px;
            }
            
            .currency-button {
                width: 45px;
                height: 35px;
                padding: 3px;
            }
            
            .currency-symbol {
                font-size: 16px;
            }
            
            .selected-property-types {
                margin-top: 12px;
                padding-top: 12px;
            }
            
            .property-types-title {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .property-types-details {
                font-size: 12px;
            }
            
            .property-type-item {
                padding: 3px 0;
            }
        }
        
        /* Subscription required message styles */
        .subscription-required-section {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border-left: 6px solid #dc3545;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .subscription-required-title {
            color: #dc3545;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .subscription-required-content {
            color: #495057;
            line-height: 1.6;
        }
        
        .subscription-benefits-title {
            font-weight: 600;
            color: #212529;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .subscription-benefits-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 15px 0;
        }
        
        .subscription-benefits-list li {
            padding: 5px 0;
            position: relative;
            padding-left: 20px;
        }
        
        .subscription-benefits-list li:before {
            content: "✓";
            color: #28a745;
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        .subscription-how-title {
            font-weight: 600;
            color: #212529;
            margin: 20px 0 10px 0;
            font-size: 16px;
        }
        
        .subscription-instructions {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .subscription-follow {
            margin: 10px 0;
            font-style: italic;
            color: #6c757d;
        }
        
        .subscription-help {
            font-weight: 600;
            color: #212529;
            margin: 20px 0 10px 0;
        }
        
        .subscription-support {
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
        }
        
        .subscription-support a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .subscription-support a:hover {
            text-decoration: underline;
        }
        
        /* Mobile responsiveness for subscription message */
        @media (max-width: 768px) {
            .subscription-required-section {
                margin: 15px 0;
                padding: 15px;
            }
            
            .subscription-required-title {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .subscription-benefits-title,
            .subscription-how-title,
            .subscription-help {
                font-size: 14px;
            }
            
            .subscription-benefits-list li {
                font-size: 13px;
                padding: 4px 0;
                padding-left: 18px;
            }
            
            .subscription-instructions,
            .subscription-support {
                padding: 8px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Логотип -->
        <div style="display:flex;flex-direction:column;align-items:center;margin-top:18px;margin-bottom:10px;">
            <img src="logo-flt.png" alt="Aaadviser Logo" style="width:110px;height:auto;display:block;margin-bottom:8px;cursor:pointer;" onclick="goToMainMenu()" />
            <div style="font-size:15px;color:#888;font-style:italic;" id="slogan">Инсайты рынка недвижимости</div>
        </div>

        <!-- Заголовок страницы -->
        <div class="page-title" id="pageTitle">Оценка объекта</div>
        <div class="page-description" id="pageDescription">Получите профессиональную оценку стоимости недвижимости в выбранном регионе</div>

        <!-- Форма выбора локации -->
        <div class="location-form" id="locationForm">
            <div class="form-group">
                <label for="countrySelect" id="countryLabel">Страна:</label>
                <select id="countrySelect" onchange="onCountryChange()">
                    <option value="" id="countryPlaceholder">Выберите страну</option>
                </select>
            </div>

            <div class="form-group">
                <label for="citySelect" id="cityLabel">Город:</label>
                <select id="citySelect" disabled onchange="onCityChange()">
                    <option value="" id="cityPlaceholder">Сначала выберите страну</option>
                </select>
            </div>

            <div class="form-group">
                <label for="countySelect" id="countyLabel">Область/Регион:</label>
                <select id="countySelect" disabled onchange="onCountyChange()">
                    <option value="" id="countyPlaceholder">Сначала выберите город</option>
                </select>
            </div>

            <div class="form-group">
                <label for="districtSelect" id="districtLabel">Район:</label>
                <select id="districtSelect" disabled onchange="onDistrictChange()">
                    <option value="" id="districtPlaceholder">Сначала выберите область</option>
                </select>
            </div>

                            <!-- Listing Type Selection -->
                <div class="listing-type-section" id="listingTypeSection" style="display: none;">
                    <div class="listing-type-title" id="listingTypeTitle">Выберите тип недвижимости для анализа:</div>
                    
                    <!-- House Type Listing Types -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="houseTypeSubtitle">Количество спален:</div>
                        <select class="listing-type-select" id="houseTypeSelect">
                            <option value="" id="houseTypePlaceholder">Выберите количество спален</option>
                        </select>
                    </div>

                    <!-- Floor Segment Listing Types -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="floorSegmentSubtitle">Этаж:</div>
                        <select class="listing-type-select" id="floorSegmentSelect">
                            <option value="" id="floorSegmentPlaceholder">Выберите этаж</option>
                        </select>
                    </div>

                    <!-- Age Data Listing Types -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="ageDataSubtitle">Возраст объекта:</div>
                        <select class="listing-type-select" id="ageDataSelect">
                            <option value="" id="ageDataPlaceholder">Выберите возраст объекта</option>
                        </select>
                    </div>

                    <!-- Heating Data Listing Types -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="heatingDataSubtitle">Тип отопления:</div>
                        <select class="listing-type-select" id="heatingDataSelect">
                            <option value="" id="heatingDataPlaceholder">Выберите тип отопления</option>
                        </select>
                    </div>

                    <!-- Price Object -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="priceObjectSubtitle">Цена объекта:</div>
                        <input type="number" id="priceObjectInput" class="listing-type-input" placeholder="Введите цену">
                        
                        <!-- Currency Selection -->
                        <div class="currency-buttons-container">
                            <div class="currency-buttons-title" id="currencyTitle">Выберите валюту:</div>
                            <div class="currency-buttons">
                                <button type="button" class="currency-button" data-currency="TRY">
                                    <span class="currency-symbol">₺</span>
                                </button>
                                <button type="button" class="currency-button" data-currency="EUR">
                                    <span class="currency-symbol">€</span>
                                </button>
                                <button type="button" class="currency-button" data-currency="USD">
                                    <span class="currency-symbol">$</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Area Object -->
                    <div class="listing-type-group">
                        <div class="listing-type-subtitle" id="areaObjectSubtitle">Площадь объекта (м²):</div>
                        <input type="number" id="areaObjectInput" class="listing-type-input" placeholder="Введите площадь" min="10" max="1000">
                    </div>
                </div>

            <button class="confirm-button" id="confirmButton" onclick="confirmLocation()" disabled>
                <span id="confirmButtonText">Подтвердить выбор</span>
            </button>
        </div>

        <!-- Выбранная локация -->
        <div class="selected-location" id="selectedLocation" style="display: none;">
            <div class="location-title" id="selectedLocationTitle">Выбранная локация:</div>
            <div class="location-details" id="locationDetails"></div>
            
            <!-- Выбранные характеристики недвижимости -->
            <div class="selected-property-types" id="selectedPropertyTypes" style="display: none;">
                <div class="property-types-title" id="propertyTypesTitle">Выбранные характеристики недвижимости:</div>
                <div class="property-types-details" id="propertyTypesDetails"></div>
            </div>
            
        </div>
        
        <!-- Блок с ID для админов (отдельный) -->
        <div class="admin-ids-block" id="adminIdsBlock" style="display: none;">
            <div class="admin-ids-title" id="adminIdsTitle">ID для админов:</div>
            <div class="admin-ids-details" id="adminIdsDetails"></div>
        </div>

        <!-- Ключевые метрики - скрыты -->
        <div class="key-metrics-section" id="keyMetricsSection" style="display: none;">
            <!-- Ключевые метрики скрыты, показывается только таблица "Средние значения" -->
        </div>



        <!-- Data Content -->
        <div class="data-content" id="dataContent" style="display: none;">
            <!-- Market Indicators Table -->
            <div class="data-section" id="summaryDataSection">
                <h3 class="data-section-title" id="summaryDataTitle"></h3>
                <div class="data-section-content" id="summaryDataContent">
                    <!-- Market indicators data will be populated here -->
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-icon">❌</div>
            <div class="error-text" id="errorText">Ошибка загрузки данных</div>
        </div>

        <!-- Back Button -->
        <a href="/webapp_main" class="back-button" id="backButton">← Вернуться в главное меню</a>
    </div>

    <script>
        // Telegram WebApp initialization
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Current language
        let currentLanguage = 'ru';

        // Selected location data
        let selectedLocation = {
            country_id: null,
            city_id: null,
            county_id: null,
            district_id: null,
            country_name: '',
            city_name: '',
            county_name: '',
            district_name: ''
        };

        // User language
        let userLanguage = 'ru';

        // Selected listing types
        let selectedListingTypes = {
            house_type: null,
            floor_segment: null,
            age: null,
            heating: null
        };

        // Localization data
        const locales = {
            'ru': {
                'slogan': 'Инсайты рынка недвижимости',
                'pageTitle': 'Оценка объекта',
                'pageDescription': 'Получите профессиональную оценку стоимости недвижимости в выбранном регионе',
                'countryLabel': 'Страна:',
                'cityLabel': 'Город:',
                'countyLabel': 'Область/Регион:',
                'districtLabel': 'Район:',
                'countryPlaceholder': 'Выберите страну',
                'cityPlaceholder': 'Сначала выберите страну',
                'countyPlaceholder': 'Сначала выберите город',
                'districtPlaceholder': 'Сначала выберите область',
                'confirmButtonText': 'Подтвердить выбор',
                'backButton': '← Вернуться в главное меню',
                'selectedLocationTitle': 'Выбранная локация:',
                'adminIdsTitle': 'ID для админов:',
                'loading': 'Загрузка...',
                'errorLoading': 'Ошибка загрузки данных',
                'dataSectionTitle': 'Анализ данных региона',
                'loadingText': 'Загрузка данных...',
                'errorText': 'Ошибка загрузки данных',
                'totalProperties': 'Всего объектов:',
                'averagePrice': 'Средняя цена:',
                'priceRange': 'Диапазон цен:',
                'noDataAvailable': 'Данные недоступны',
                'keyMetricsTitle': 'Ключевые показатели',
                'avgSalePriceLabel': 'Средняя цена продажи за м²',
                'avgRentPriceLabel': 'Средняя цена аренды за м²',
                'listingPeriodSaleLabel': 'Период размещения (продажа)',
                'listingPeriodRentLabel': 'Период размещения (аренда)',
                'yieldLabel': 'Доходность',

                'listingTypeTitle': 'Выберите тип недвижимости для анализа:',
                'houseTypeSubtitle': 'Количество спален:',
                'floorSegmentSubtitle': 'Этаж:',
                'ageDataSubtitle': 'Возраст объекта:',
                'heatingDataSubtitle': 'Тип отопления:',
                'priceObjectSubtitle': 'Цена объекта:',
                'areaObjectSubtitle': 'Площадь объекта (м²):',
                'selectBedrooms': 'количество спален',
                'selectFloor': 'этаж',
                'selectAge': 'возраст объекта',
                'selectHeating': 'тип отопления',
                'propertyTypesTitle': 'Выбранные характеристики недвижимости:',
                'bedroomsLabel': 'Количество спален',
                'floorLabel': 'Этаж',
                'ageLabel': 'Возраст объекта',
                'heatingLabel': 'Тип отопления',
                'marketIndicatorsTitle': 'Показатели рынка',
                'marketTrendsTitle': 'Тренды рынка',
                'saleHeader': 'Продажа',
                'rentHeader': 'Аренда',
                'currencyTitle': 'Выберите валюту:',
                'pricePlaceholder': 'Введите цену',
                'areaPlaceholder': 'Введите площадь',
                'trendsFilterInfo': 'Показано ${filteredCount} из ${totalCount} трендов',
                'marketComparisonTitle': 'Сравнение с рынком',
                'pricePerM2Label': 'Цена за м²',
                'areaLabel': 'Площадь',
                'priceComparisonLabel': 'Цена за м²:',
                'areaComparisonLabel': 'Площадь:',
                'priceCloseToMarket': 'Ваш объект (${userPrice}) близок к рыночной (${marketMin} – ${marketMax}).',
                'priceAboveMarket': 'Ваш объект (${userPrice}) выше рынка на ${percent}%.',
                'priceBelowMarket': 'Ваш объект (${userPrice}) ниже рынка на ${percent}%.',
                'areaMatchesMarket': 'Ваш объект (${userArea} м²) соответствует рыночному спросу (${marketMin}–${marketMax} м²).',
                'areaBelowMarket': 'Ваш объект (${userArea} м²) меньше востребованной на рынке (${marketMin}–${marketMax} м²).',
                'areaAboveMarket': 'Ваш объект (${userArea} м²) больше востребованной на рынке (${marketMin}–${marketMax} м²).',
                'houseTypeDataTitle': 'Данные по количеству спален',
                'floorSegmentDataTitle': 'Данные по этажу',
                'ageDataTitle': 'Данные по возрасту объектов',
                'heatingDataTitle': 'Данные по типу отопления',
                'consolidatedAssessmentTitle': 'Консолидированная оценка',
                'salePriceTitle': 'Цена за м² (Unit Price For Sale):',
                'rentPriceTitle': 'Цена аренды за м² (Unit Price For Rent):',
                'yieldTitle': 'Доходность (Yield):',
                'consolidatedAverageLabel': 'Консолидированная средняя:',
                'bedroomsLabel': 'Спальни',
                'floorLabel': 'Этаж',
                'ageLabel': 'Возраст',
                'heatingLabel': 'Отопление',
                
                // Ключи локализации для таблицы "Показатели рынка"
                'indicatorLabel': 'Показатель',
                'minValueLabel': 'Минимальное значение',
                'maxValueLabel': 'Максимальное значение',
                'comparableAreaForSaleLabel': 'Сопоставимая площадь',
                'countForSaleLabel': 'Количество для продажи',
                'listingPeriodForSaleLabel': 'Срок до продажи',
                'unitPriceForSaleLabel': 'Цена за м²',
                'comparableAreaForRentLabel': 'Сопоставимая площадь',
                'countForRentLabel': 'Количество для аренды',
                'listingPeriodForRentLabel': 'Срок до аренды',
                'unitPriceForRentLabel': 'Цена за м²',
                
                // Ключи для текстового анализа рынка
                'marketAnalysisTitle': 'Анализ рынка',
                'saleAnalysisText': 'Продажа: при площади {area} м² (среднее значение по проданным объектам) и минимальной цене {minPrice}/м² срок продажи составляет ~{minDays} дней; при максимальной цене {maxPrice}/м² - срок продажи до {maxDays} дней.',
                'rentAnalysisText': 'Аренда: при площади {area} м² (среднее значение по сданным в аренду объектам) минимальная цена {minPrice}/м² срок сдачи ~{minDays} дней; при максимальной цене {maxPrice}/м² срок до {maxDays} дней.',
                
                // Ключи для блока "Вывод по объекту"
                'objectSummaryTitle': 'Вывод по объекту',
                'objectPricePerM2Label': 'Цена за м² вашего объекта:',
                'objectCurrencyLabel': 'Валюта объекта:',
                'objectAreaLabel': 'Площадь объекта:',
                'exchangeRateLabel': 'Курс конвертации:',
                
                // Ключи для сообщения о подписке
                'subscriptionRequiredTitle': 'Функция долгосрочного прогноза стоимости объекта доступна только для пользователей с активной подпиской.',
                'subscriptionBenefits': 'Что даёт подписка:',
                'subscriptionBenefit1': 'Прогноз цены объекта на 12 месяцев вперёд',
                'subscriptionBenefit2': 'Дополнительные аналитические данные',
                'subscriptionBenefit3': 'Дополнительные возможности сервиса',
                'howToSubscribe': 'Как оформить подписку:',
                'subscribeInstructions': 'Перейдите к боту @Aaadviser_pay_bot',
                'followInstructions': 'Следуйте инструкциям для подключения',
                'needHelp': 'Нужна помощь?',
                'contactSupport': 'Свяжитесь с нашей поддержкой: @Aaadviser_support_bot'
            },
            'en': {
                'slogan': 'Real Estate Market Insights',
                'pageTitle': 'Object Evaluation',
                'pageDescription': 'Get a professional property valuation in the selected region',
                'countryLabel': 'Country:',
                'cityLabel': 'City:',
                'countyLabel': 'Region/Area:',
                'districtLabel': 'District:',
                'countryPlaceholder': 'Select country',
                'cityPlaceholder': 'First select country',
                'countyPlaceholder': 'First select city',
                'districtPlaceholder': 'First select region',
                'confirmButtonText': 'Confirm selection',
                'backButton': '← Back to main menu',
                'selectedLocationTitle': 'Selected location:',
                'adminIdsTitle': 'IDs for admins:',
                'loading': 'Loading...',
                'errorLoading': 'Error loading data',
                'dataSectionTitle': 'Regional Data Analysis',
                'loadingText': 'Loading data...',
                'errorText': 'Error loading data',
                'totalProperties': 'Total properties:',
                'averagePrice': 'Average price:',
                'priceRange': 'Price range:',
                'noDataAvailable': 'Data not available',
                'keyMetricsTitle': 'Key Metrics',
                'avgSalePriceLabel': 'Average Sale Price per m²',
                'avgRentPriceLabel': 'Average Rent Price per m²',
                'listingPeriodSaleLabel': 'Listing Period (Sale)',
                'listingPeriodRentLabel': 'Listing Period (Rent)',
                'yieldLabel': 'Yield',

                'listingTypeTitle': 'Select property type for analysis:',
                'houseTypeSubtitle': 'Bedroom count:',
                'floorSegmentSubtitle': 'Floor:',
                'ageDataSubtitle': 'Property age:',
                'heatingDataSubtitle': 'Heating type:',
                'priceObjectSubtitle': 'Property price:',
                'areaObjectSubtitle': 'Property area (m²):',
                'selectBedrooms': 'bedroom count',
                'selectFloor': 'floor',
                'selectAge': 'property age',
                'selectHeating': 'heating type',
                'propertyTypesTitle': 'Selected property characteristics:',
                'bedroomsLabel': 'Bedroom count',
                'floorLabel': 'Floor',
                'ageLabel': 'Property age',
                'heatingLabel': 'Heating type',
                'marketIndicatorsTitle': 'Market Indicators',
                'marketTrendsTitle': 'Market Trends',
                'saleHeader': 'Sale',
                'rentHeader': 'Rent',
                'currencyTitle': 'Select currency:',
                'pricePlaceholder': 'Enter price',
                'areaPlaceholder': 'Enter area',
                'trendsFilterInfo': 'Showing ${filteredCount} of ${totalCount} trends',
                'marketComparisonTitle': 'Market Comparison',
                'pricePerM2Label': 'Price per m²',
                'areaLabel': 'Area',
                'priceComparisonLabel': 'Price per m²:',
                'areaComparisonLabel': 'Area:',
                'priceCloseToMarket': 'Your object (${userPrice}) is close to market (${marketMin} – ${marketMax}).',
                'priceAboveMarket': 'Your object (${userPrice}) is above market by ${percent}%.',
                'priceBelowMarket': 'Your object (${userPrice}) is below market by ${percent}%.',
                'areaMatchesMarket': 'Your object (${userArea} m²) matches market demand (${marketMin}–${marketMax} m²).',
                'areaBelowMarket': 'Your object (${userArea} m²) is smaller than market demand (${marketMin}–${marketMax} m²).',
                'areaAboveMarket': 'Your object (${userArea} m²) is larger than market demand (${marketMin}–${marketMax} m²).',
                'houseTypeDataTitle': 'Bedroom Count Data',
                'floorSegmentDataTitle': 'Floor Data',
                'ageDataTitle': 'Property Age Data',
                'heatingDataTitle': 'Heating Type Data',
                'consolidatedAssessmentTitle': 'Consolidated Assessment',
                'salePriceTitle': 'Price per m² (Unit Price For Sale):',
                'rentPriceTitle': 'Rent Price per m² (Unit Price For Rent):',
                'yieldTitle': 'Yield:',
                'consolidatedAverageLabel': 'Consolidated Average:',
                'bedroomsLabel': 'Bedrooms',
                
                // Market analysis text localization keys
                'marketAnalysisTitle': 'Market Analysis',
                'saleAnalysisText': 'Sale: with an area of {area} m² (average value for sold properties) and a minimum price of {minPrice}/m², the sale period is ~{minDays} days; with a maximum price of {maxPrice}/m² - the sale period is up to {maxDays} days.',
                'rentAnalysisText': 'Rent: with an area of {area} m² (average value for rented properties) minimum price {minPrice}/m², rental period ~{minDays} days; with a maximum price of {maxPrice}/m² period up to {maxDays} days.',
                
                // Object summary localization keys
                'objectSummaryTitle': 'Object Summary',
                'objectPricePerM2Label': 'Price per m² of your object:',
                'objectCurrencyLabel': 'Object currency:',
                'objectAreaLabel': 'Object area:',
                'exchangeRateLabel': 'Exchange rate:',
                'floorLabel': 'Floor',
                'ageLabel': 'Age',
                'heatingLabel': 'Heating',
                
                // Keys for "Market Indicators" table
                'indicatorLabel': 'Indicator',
                'minValueLabel': 'Minimum Value',
                'maxValueLabel': 'Maximum Value',
                'comparableAreaForSaleLabel': 'Comparable Area',
                'countForSaleLabel': 'Count for Sale',
                'listingPeriodForSaleLabel': 'Time to Sale',
                'unitPriceForSaleLabel': 'Unit Price',
                'comparableAreaForRentLabel': 'Comparable Area',
                'countForRentLabel': 'Count for Rent',
                'listingPeriodForRentLabel': 'Time to Rent',
                'unitPriceForRentLabel': 'Unit Price',
                
                // Keys for market analysis text
                'marketAnalysisTitle': 'Market Analysis',
                'saleAnalysisText': 'Sale: with an area of {area} m² (average value for sold properties) and minimum price {minPrice}/m², the sale period is ~{minDays} days; with maximum price {maxPrice}/m² - sale period up to {maxDays} days.',
                'rentAnalysisText': 'Rent: with an area of {area} m² (average value for rented properties) minimum price {minPrice}/m², rental period ~{minDays} days; with maximum price {maxPrice}/m², period up to {maxDays} days.',
                
                // Keys for subscription message
                'subscriptionRequiredTitle': 'Long-term property value forecasting is only available for users with an active subscription.',
                'subscriptionBenefits': 'What subscription gives you:',
                'subscriptionBenefit1': 'Property price forecast for 12 months ahead',
                'subscriptionBenefit2': 'Additional analytical data',
                'subscriptionBenefit3': 'Additional service capabilities',
                'howToSubscribe': 'How to subscribe:',
                'subscribeInstructions': 'Go to bot @Aaadviser_pay_bot',
                'followInstructions': 'Follow the connection instructions',
                'needHelp': 'Need help?',
                'contactSupport': 'Contact our support: @Aaadviser_support_bot'
            },
            'de': {
                'slogan': 'Immobilienmarkt-Einblicke',
                'pageTitle': 'Objektbewertung',
                'pageDescription': 'Erhalten Sie eine professionelle Immobilienbewertung in der ausgewählten Region',
                'countryLabel': 'Land:',
                'cityLabel': 'Stadt:',
                'countyLabel': 'Region/Bereich:',
                'districtLabel': 'Bezirk:',
                'countryPlaceholder': 'Land auswählen',
                'cityPlaceholder': 'Zuerst Land auswählen',
                'countyPlaceholder': 'Zuerst Stadt auswählen',
                'districtPlaceholder': 'Zuerst Region auswählen',
                'confirmButtonText': 'Auswahl bestätigen',
                'backButton': '← Zurück zum Hauptmenü',
                'selectedLocationTitle': 'Ausgewählte Lage:',
                'adminIdsTitle': 'IDs für Administratoren:',
                'loading': 'Laden...',
                'errorLoading': 'Fehler beim Laden der Daten',
                'dataSectionTitle': 'Regionale Datenanalyse',
                'generalDataTitle': 'Allgemeine Daten',
                'houseTypeDataTitle': 'Schlafzimmer-Anzahl-Daten',
                'floorSegmentDataTitle': 'Etagen-Daten',
                'ageDataTitle': 'Altersdaten',
                'heatingDataTitle': 'Heizungstyp-Daten',
                'loadingText': 'Daten werden geladen...',
                'errorText': 'Fehler beim Laden der Daten',
                'totalProperties': 'Gesamtobjekte:',
                'averagePrice': 'Durchschnittspreis:',
                'priceRange': 'Preisbereich:',
                'noDataAvailable': 'Daten nicht verfügbar',
                'keyMetricsTitle': 'Wichtige Kennzahlen',
                'avgSalePriceLabel': 'Durchschnittlicher Verkaufspreis pro m²',
                'avgRentPriceLabel': 'Durchschnittlicher Mietpreis pro m²',
                'listingPeriodSaleLabel': 'Angebotsdauer (Verkauf)',
                'listingPeriodRentLabel': 'Angebotsdauer (Vermietung)',
                'yieldLabel': 'Rendite',
                'insightsTitle': 'Zusammenfassung',
                'insightsLoading': 'Daten werden analysiert...',
                'insightsError': 'Fehler bei der Datenanalyse'
            },
            'fr': {
                'slogan': 'Aperçus du marché immobilier',
                'pageTitle': 'Évaluation d\'objet',
                'pageDescription': 'Obtenez une évaluation professionnelle de propriété dans la région sélectionnée',
                'countryLabel': 'Pays :',
                'cityLabel': 'Ville :',
                'countyLabel': 'Région/Zone :',
                'districtLabel': 'District :',
                'countryPlaceholder': 'Sélectionner un pays',
                'cityPlaceholder': 'D\'abord sélectionner un pays',
                'countyPlaceholder': 'D\'abord sélectionner une ville',
                'districtPlaceholder': 'D\'abord sélectionner une région',
                'confirmButtonText': 'Confirmer la sélection',
                'backButton': '← Retour au menu principal',
                'selectedLocationTitle': 'Emplacement sélectionné :',
                'adminIdsTitle': 'IDs pour les administrateurs :',
                'loading': 'Chargement...',
                'errorLoading': 'Erreur de chargement des données',
                'dataSectionTitle': 'Analyse des données régionales',
                'generalDataTitle': 'Données générales',
                'houseTypeDataTitle': 'Données du nombre de chambres',
                'floorSegmentDataTitle': 'Données d\'étage',
                'ageDataTitle': 'Données d\'âge',
                'heatingDataTitle': 'Données du type de chauffage',
                'loadingText': 'Chargement des données...',
                'errorText': 'Erreur de chargement des données',
                'totalProperties': 'Total des propriétés :',
                'averagePrice': 'Prix moyen :',
                'priceRange': 'Fourchette de prix :',
                'noDataAvailable': 'Données non disponibles',
                'keyMetricsTitle': 'Métriques clés',
                'avgSalePriceLabel': 'Prix de vente moyen par m²',
                'avgRentPriceLabel': 'Prix de location moyen par m²',
                'listingPeriodSaleLabel': 'Période d\'inscription (vente)',
                'listingPeriodRentLabel': 'Période d\'inscription (location)',
                'yieldLabel': 'Rendement',
                'insightsTitle': 'Résumé',
                'insightsLoading': 'Analyse des données...',
                'insightsError': 'Erreur lors de l\'analyse des données'
            },
            'tr': {
                'slogan': 'Gayrimenkul Piyasa İçgörüleri',
                'pageTitle': 'Nesne Değerlendirmesi',
                'pageDescription': 'Seçilen bölgede profesyonel gayrimenkul değerlendirmesi alın',
                'countryLabel': 'Ülke:',
                'cityLabel': 'Şehir:',
                'countyLabel': 'Bölge/Alan:',
                'districtLabel': 'İlçe:',
                'countryPlaceholder': 'Ülke seçin',
                'cityPlaceholder': 'Önce ülke seçin',
                'countyPlaceholder': 'Önce şehir seçin',
                'districtPlaceholder': 'Önce bölge seçin',
                'confirmButtonText': 'Seçimi onayla',
                'backButton': '← Ana menüye dön',
                'selectedLocationTitle': 'Seçilen konum:',
                'adminIdsTitle': 'Yöneticiler için ID\'ler:',
                'loading': 'Yükleniyor...',
                'errorLoading': 'Veri yükleme hatası',
                'dataSectionTitle': 'Bölgesel Veri Analizi',
                'generalDataTitle': 'Genel Veriler',
                'houseTypeDataTitle': 'Yatak Odası Sayısı Verileri',
                'floorSegmentDataTitle': 'Kat Verileri',
                'ageDataTitle': 'Yaş Verileri',
                'heatingDataTitle': 'Isıtma Tipi Verileri',
                'loadingText': 'Veriler yükleniyor...',
                'errorText': 'Veri yükleme hatası',
                'totalProperties': 'Toplam mülk:',
                'averagePrice': 'Ortalama fiyat:',
                'priceRange': 'Fiyat aralığı:',
                'noDataAvailable': 'Veri mevcut değil',
                'keyMetricsTitle': 'Ana Metrikler',
                'avgSalePriceLabel': 'm² başına ortalama satış fiyatı',
                'avgRentPriceLabel': 'm² başına ortalama kiralama fiyatı',
                'listingPeriodSaleLabel': 'İlan süresi (satış)',
                'listingPeriodRentLabel': 'İlan süresi (kiralama)',
                'yieldLabel': 'Getiri',

                'marketComparisonTitle': 'Piyasa Karşılaştırması',
                'pricePerM2Label': 'm² başına fiyat',
                'areaLabel': 'Alan',
                'priceComparisonLabel': 'm² başına fiyat:',
                'areaComparisonLabel': 'Alan:',
                'priceCloseToMarket': 'Nesneniz (${userPrice}) piyasaya yakın (${marketMin} – ${marketMax}).',
                'priceAboveMarket': 'Nesneniz (${userPrice}) piyasadan ${percent}% yüksek.',
                'priceBelowMarket': 'Nesneniz (${userPrice}) piyasadan ${percent}% düşük.',
                'areaMatchesMarket': 'Nesneniz (${userArea} m²) piyasa talebine uygun (${marketMin}–${marketMax} m²).',
                'areaBelowMarket': 'Nesneniz (${userArea} m²) piyasa talebinden küçük (${marketMin}–${marketMax} m²).',
                'areaAboveMarket': 'Nesneniz (${userArea} m²) piyasa talebinden büyük (${marketMin}–${marketMax} m²).',
                'consolidatedAssessmentTitle': 'Konsolide Değerlendirme',
                'salePriceTitle': 'm² başına fiyat (Satış Birim Fiyatı):',
                'rentPriceTitle': 'm² başına kiralama fiyatı (Kiralama Birim Fiyatı):',
                'yieldTitle': 'Getiri:',
                'consolidatedAverageLabel': 'Konsolide ortalama:',
                'bedroomsLabel': 'Yatak Odası',
                'floorLabel': 'Kat',
                'ageLabel': 'Yaş',
                'heatingLabel': 'Isıtma',
                
                // "Piyasa Analizi" metni için anahtarlar
                'marketAnalysisTitle': 'Piyasa Analizi',
                'saleAnalysisText': 'Satış: {area} m² alan (satılan mülklerin ortalama değeri) ve {minPrice}/m² minimum fiyat ile satış süresi ~{minDays} gün; {maxPrice}/m² maksimum fiyat ile satış süresi {maxDays} güne kadar.',
                'rentAnalysisText': 'Kiralama: {area} m² alan (kiralanan mülklerin ortalama değeri) {minPrice}/m² minimum fiyat, kiralama süresi ~{minDays} gün; {maxPrice}/m² maksimum fiyat ile süre {maxDays} güne kadar.'
            },
            'de': {
                'slogan': 'Immobilienmarkt-Einblicke',
                'pageTitle': 'Objektbewertung',
                'pageDescription': 'Erhalten Sie eine professionelle Immobilienbewertung in der ausgewählten Region',
                'countryLabel': 'Land:',
                'cityLabel': 'Stadt:',
                'countyLabel': 'Region/Bereich:',
                'districtLabel': 'Bezirk:',
                'countryPlaceholder': 'Land auswählen',
                'cityPlaceholder': 'Zuerst Land auswählen',
                'countyPlaceholder': 'Zuerst Stadt auswählen',
                'districtPlaceholder': 'Zuerst Region auswählen',
                'confirmButtonText': 'Auswahl bestätigen',
                'backButton': '← Zurück zum Hauptmenü',
                'selectedLocationTitle': 'Ausgewählte Lage:',
                'adminIdsTitle': 'IDs für Administratoren:',
                'loading': 'Laden...',
                'errorLoading': 'Fehler beim Laden der Daten',
                'dataSectionTitle': 'Regionale Datenanalyse',
                'generalDataTitle': 'Allgemeine Daten',
                'houseTypeDataTitle': 'Schlafzimmer-Anzahl-Daten',
                'floorSegmentDataTitle': 'Etagen-Daten',
                'ageDataTitle': 'Altersdaten',
                'heatingDataTitle': 'Heizungstyp-Daten',
                'loadingText': 'Daten werden geladen...',
                'errorText': 'Fehler beim Laden der Daten',
                'totalProperties': 'Gesamtobjekte:',
                'averagePrice': 'Durchschnittspreis:',
                'priceRange': 'Preisbereich:',
                'noDataAvailable': 'Daten nicht verfügbar',
                'keyMetricsTitle': 'Wichtige Kennzahlen',
                'avgSalePriceLabel': 'Durchschnittlicher Verkaufspreis pro m²',
                'avgRentPriceLabel': 'Durchschnittlicher Mietpreis pro m²',
                'listingPeriodSaleLabel': 'Angebotsdauer (Verkauf)',
                'listingPeriodRentLabel': 'Angebotsdauer (Vermietung)',
                'yieldLabel': 'Rendite',
                'insightsTitle': 'Zusammenfassung',
                'insightsLoading': 'Daten werden analysiert...',
                'insightsError': 'Fehler bei der Datenanalyse'
            },
            'fr': {
                'slogan': 'Aperçus du marché immobilier',
                'pageTitle': 'Évaluation d\'objet',
                'pageDescription': 'Obtenez une évaluation professionnelle de propriété dans la région sélectionnée',
                'countryLabel': 'Pays :',
                'cityLabel': 'Ville :',
                'countyLabel': 'Région/Zone :',
                'districtLabel': 'District :',
                'countryPlaceholder': 'Sélectionner un pays',
                'cityPlaceholder': 'D\'abord sélectionner un pays',
                'countyPlaceholder': 'D\'abord sélectionner une ville',
                'districtPlaceholder': 'D\'abord sélectionner une région',
                'confirmButtonText': 'Confirmer la sélection',
                'backButton': '← Retour au menu principal',
                'selectedLocationTitle': 'Emplacement sélectionné :',
                'adminIdsTitle': 'IDs pour les administrateurs :',
                'loading': 'Chargement...',
                'errorLoading': 'Erreur de chargement des données',
                'dataSectionTitle': 'Analyse des données régionales',
                'generalDataTitle': 'Données générales',
                'houseTypeDataTitle': 'Données du nombre de chambres',
                'floorSegmentDataTitle': 'Données d\'étage',
                'ageDataTitle': 'Données d\'âge',
                'heatingDataTitle': 'Données du type de chauffage',
                'loadingText': 'Chargement des données...',
                'errorText': 'Erreur de chargement des données',
                'totalProperties': 'Total des propriétés :',
                'averagePrice': 'Prix moyen :',
                'priceRange': 'Fourchette de prix :',
                'noDataAvailable': 'Données non disponibles',
                'keyMetricsTitle': 'Métriques clés',
                'avgSalePriceLabel': 'Prix de vente moyen par m²',
                'avgRentPriceLabel': 'Prix de location moyen par m²',
                'listingPeriodSaleLabel': 'Période d\'inscription (vente)',
                'listingPeriodRentLabel': 'Période d\'inscription (location)',
                'yieldLabel': 'Rendement',
                'insightsTitle': 'Résumé',
                'insightsLoading': 'Analyse des données...',
                'insightsError': 'Erreur lors de l\'analyse des données'
            },
            'tr': {
                'slogan': 'Gayrimenkul Piyasa İçgörüleri',
                'pageTitle': 'Nesne Değerlendirmesi',
                'pageDescription': 'Seçilen bölgede profesyonel gayrimenkul değerlendirmesi alın',
                'countryLabel': 'Ülke:',
                'cityLabel': 'Şehir:',
                'countyLabel': 'Bölge/Alan:',
                'districtLabel': 'İlçe:',
                'countryPlaceholder': 'Ülke seçin',
                'cityPlaceholder': 'Önce ülke seçin',
                'countyPlaceholder': 'Önce şehir seçin',
                'districtPlaceholder': 'Önce bölge seçin',
                'confirmButtonText': 'Seçimi onayla',
                'backButton': '← Ana menüye dön',
                'selectedLocationTitle': 'Seçilen konum:',
                'adminIdsTitle': 'Yöneticiler için ID\'ler:',
                'loading': 'Yükleniyor...',
                'errorLoading': 'Veri yükleme hatası',
                'dataSectionTitle': 'Bölgesel Veri Analizi',
                'generalDataTitle': 'Genel Veriler',
                'houseTypeDataTitle': 'Yatak Odası Sayısı Verileri',
                'floorSegmentDataTitle': 'Kat Verileri',
                'ageDataTitle': 'Yaş Verileri',
                'heatingDataTitle': 'Isıtma Tipi Verileri',
                'loadingText': 'Veriler yükleniyor...',
                'errorText': 'Veri yükleme hatası',
                'totalProperties': 'Toplam mülk:',
                'averagePrice': 'Ortalama fiyat:',
                'priceRange': 'Fiyat aralığı:',
                'noDataAvailable': 'Veri mevcut değil',
                'keyMetricsTitle': 'Ana Metrikler',
                'avgSalePriceLabel': 'm² başına ortalama satış fiyatı',
                'avgRentPriceLabel': 'm² başına ortalama kiralama fiyatı',
                'listingPeriodSaleLabel': 'İlan süresi (satış)',
                'listingPeriodRentLabel': 'İlan süresi (kiralama)',
                'yieldLabel': 'Getiri',
                'insightsTitle': 'Özet',
                'insightsLoading': 'Veriler analiz ediliyor...',
                'insightsError': 'Veri analizi hatası',
                
                // Abonelik mesajı için anahtarlar
                'subscriptionRequiredTitle': 'Uzun vadeli mülk değeri tahmin fonksiyonu yalnızca aktif aboneliği olan kullanıcılar için kullanılabilir.',
                'subscriptionBenefits': 'Abonelik size ne verir:',
                'subscriptionBenefit1': '12 ay öncesine kadar mülk fiyat tahmini',
                'subscriptionBenefit2': 'Ek analitik veriler',
                'subscriptionBenefit3': 'Ek servis özellikleri',
                'howToSubscribe': 'Nasıl abone olunur:',
                'subscribeInstructions': '@Aaadviser_pay_bot botuna gidin',
                'followInstructions': 'Bağlantı talimatlarını takip edin',
                'needHelp': 'Yardıma mı ihtiyacınız var?',
                'contactSupport': 'Destek ekibimizle iletişime geçin: @Aaadviser_support_bot',
                
                // "Piyasa Göstergeleri" tablosu için anahtarlar
                'marketIndicatorsTitle': 'Piyasa Göstergeleri',
                'saleHeader': 'Satış',
                'rentHeader': 'Kiralama',
                'indicatorLabel': 'Gösterge',
                'minValueLabel': 'Minimum değer',
                'maxValueLabel': 'Maksimum değer',
                'comparableAreaForSaleLabel': 'Karşılaştırılabilir alan',
                'countForSaleLabel': 'Satış için sayı',
                'listingPeriodForSaleLabel': 'Satışa kadar süre',
                'unitPriceForSaleLabel': 'Birim fiyat',
                'comparableAreaForRentLabel': 'Karşılaştırılabilir alan',
                'countForRentLabel': 'Kiralama için sayı',
                'listingPeriodForRentLabel': 'Kiralamaya kadar süre',
                'unitPriceForRentLabel': 'Birim fiyat'
            }
        };

        // Get localized text
        function getText(key) {
            return locales[currentLanguage][key] || key;
        }

        // Update page text based on current language
        function updatePageText() {
            document.getElementById('slogan').textContent = getText('slogan');
            document.getElementById('pageTitle').textContent = getText('pageTitle');
            document.getElementById('pageDescription').textContent = getText('pageDescription');
            document.getElementById('countryLabel').textContent = getText('countryLabel');
            document.getElementById('cityLabel').textContent = getText('cityLabel');
            document.getElementById('countyLabel').textContent = getText('countyLabel');
            document.getElementById('districtLabel').textContent = getText('districtLabel');
            document.getElementById('countryPlaceholder').textContent = getText('countryPlaceholder');
            document.getElementById('cityPlaceholder').textContent = getText('cityPlaceholder');
            document.getElementById('countyPlaceholder').textContent = getText('countyPlaceholder');
            document.getElementById('districtPlaceholder').textContent = getText('districtPlaceholder');
            document.getElementById('confirmButtonText').textContent = getText('confirmButtonText');
            document.getElementById('backButton').textContent = getText('backButton');
            document.getElementById('selectedLocationTitle').textContent = getText('selectedLocationTitle');
            document.getElementById('adminIdsTitle').textContent = getText('adminIdsTitle');
            
            // Update new data section elements
            const dataSectionTitle = document.getElementById('dataSectionTitle');
            if (dataSectionTitle) {
                dataSectionTitle.textContent = getText('dataSectionTitle');
            }
            
            const summaryDataTitle = document.getElementById('summaryDataTitle');
            if (summaryDataTitle) {
                summaryDataTitle.textContent = getText('marketIndicatorsTitle');
            }

            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = getText('loadingText');
            }
            
            const errorText = document.getElementById('errorText');
            if (errorText) {
                errorText.textContent = getText('errorText');
            }
            
            // Update key metrics labels
            const keyMetricsTitle = document.getElementById('keyMetricsTitle');
            if (keyMetricsTitle) {
                keyMetricsTitle.textContent = getText('keyMetricsTitle');
            }
            
            const avgSalePriceLabel = document.getElementById('avgSalePriceLabel');
            if (avgSalePriceLabel) {
                avgSalePriceLabel.textContent = getText('avgSalePriceLabel');
            }
            
            const avgRentPriceLabel = document.getElementById('avgRentPriceLabel');
            if (avgRentPriceLabel) {
                avgRentPriceLabel.textContent = getText('avgRentPriceLabel');
            }
            
            const listingPeriodSaleLabel = document.getElementById('listingPeriodSaleLabel');
            if (listingPeriodSaleLabel) {
                listingPeriodSaleLabel.textContent = getText('listingPeriodSaleLabel');
            }
            
            const listingPeriodRentLabel = document.getElementById('listingPeriodRentLabel');
            if (listingPeriodRentLabel) {
                listingPeriodRentLabel.textContent = getText('listingPeriodRentLabel');
            }
            
            const yieldLabel = document.getElementById('yieldLabel');
            if (yieldLabel) {
                yieldLabel.textContent = getText('yieldLabel');
            }
            

            
            // Update listing type selection elements
            const listingTypeTitle = document.getElementById('listingTypeTitle');
            if (listingTypeTitle) { listingTypeTitle.textContent = getText('listingTypeTitle'); }
            const houseTypeSubtitle = document.getElementById('houseTypeSubtitle');
            if (houseTypeSubtitle) { houseTypeSubtitle.textContent = getText('houseTypeSubtitle'); }
            const floorSegmentSubtitle = document.getElementById('floorSegmentSubtitle');
            if (floorSegmentSubtitle) { floorSegmentSubtitle.textContent = getText('floorSegmentSubtitle'); }
            const ageDataSubtitle = document.getElementById('ageDataSubtitle');
            if (ageDataSubtitle) { ageDataSubtitle.textContent = getText('ageDataSubtitle'); }
            const heatingDataSubtitle = document.getElementById('heatingDataSubtitle');
            if (heatingDataSubtitle) { heatingDataSubtitle.textContent = getText('heatingDataSubtitle'); }
            
            // Update new fields
            const priceObjectSubtitle = document.getElementById('priceObjectSubtitle');
            if (priceObjectSubtitle) { priceObjectSubtitle.textContent = getText('priceObjectSubtitle'); }
            const areaObjectSubtitle = document.getElementById('areaObjectSubtitle');
            if (areaObjectSubtitle) { areaObjectSubtitle.textContent = getText('areaObjectSubtitle'); }
            
            // Update currency title
            const currencyTitle = document.getElementById('currencyTitle');
            if (currencyTitle) { currencyTitle.textContent = getText('currencyTitle'); }
            
            // Update placeholders
            const priceObjectInput = document.getElementById('priceObjectInput');
            if (priceObjectInput) { priceObjectInput.placeholder = getText('pricePlaceholder'); }
            const areaObjectInput = document.getElementById('areaObjectInput');
            if (areaObjectInput) { areaObjectInput.placeholder = getText('areaPlaceholder'); }
            
            // Update placeholder texts
            const houseTypePlaceholder = document.getElementById('houseTypePlaceholder');
            if (houseTypePlaceholder) { houseTypePlaceholder.textContent = getText('selectBedrooms'); }
            const floorSegmentPlaceholder = document.getElementById('floorSegmentPlaceholder');
            if (floorSegmentPlaceholder) { floorSegmentPlaceholder.textContent = getText('selectFloor'); }
            const ageDataPlaceholder = document.getElementById('ageDataPlaceholder');
            if (ageDataPlaceholder) { ageDataPlaceholder.textContent = getText('selectAge'); }
            const heatingDataPlaceholder = document.getElementById('heatingDataPlaceholder');
            if (heatingDataPlaceholder) { heatingDataPlaceholder.textContent = getText('selectHeating'); }
            
            // Update property types section
            const propertyTypesTitle = document.getElementById('propertyTypesTitle');
            if (propertyTypesTitle) { propertyTypesTitle.textContent = getText('propertyTypesTitle'); }
            
            // Update detailed data table titles
            const detailedDataTitles = document.querySelectorAll('.detailed-data-title');
            detailedDataTitles.forEach(titleElement => {
                const titleText = titleElement.textContent;
                if (titleText.includes('количество спален') || titleText.includes('Bedroom Count') || titleText.includes('Schlafzimmer') || titleText.includes('chambres') || titleText.includes('Yatak Odası')) {
                    titleElement.textContent = getText('houseTypeDataTitle');
                } else if (titleText.includes('этажу') || titleText.includes('Floor') || titleText.includes('Etagen') || titleText.includes('étage') || titleText.includes('Kat')) {
                    titleElement.textContent = getText('floorSegmentDataTitle');
                } else if (titleText.includes('возрасту') || titleText.includes('Age') || titleText.includes('Alters') || titleText.includes('âge') || titleText.includes('Yaş')) {
                    titleElement.textContent = getText('ageDataTitle');
                } else if (titleText.includes('отопления') || titleText.includes('Heating') || titleText.includes('Heizung') || titleText.includes('chauffage') || titleText.includes('Isıtma')) {
                    titleElement.textContent = getText('heatingDataTitle');
                }
            });
            

        }

        // Load countries from API
        async function loadCountries() {
            try {
                const response = await fetch('/api/locations/countries');
                const data = await response.json();
                
                if (data.success) {
                    const countrySelect = document.getElementById('countrySelect');
                    countrySelect.innerHTML = `<option value="">${getText('countryPlaceholder')}</option>`;
                    
                    data.countries.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        countrySelect.appendChild(option);
                    });
                } else {
                    console.error('Failed to load countries:', data.error);
                }
            } catch (error) {
                console.error('Error loading countries:', error);
            }
        }

        // Load cities based on selected country
        async function loadCities(countryId) {
            try {
                const response = await fetch('/api/locations/cities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ country_id: countryId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const citySelect = document.getElementById('citySelect');
                    citySelect.innerHTML = `<option value="">${getText('cityPlaceholder')}</option>`;
                    
                    data.cities.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        citySelect.appendChild(option);
                    });
                    
                    citySelect.disabled = false;
                } else {
                    console.error('Failed to load cities:', data.error);
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Load counties based on selected city
        async function loadCounties(cityId) {
            try {
                const response = await fetch('/api/locations/counties', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ city_id: cityId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const countySelect = document.getElementById('countySelect');
                    countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
                    
                    data.counties.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        countySelect.appendChild(option);
                    });
                    
                    countySelect.disabled = false;
                } else {
                    console.error('Failed to load cities:', data.error);
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Load available listing types for each data category
        async function loadListingTypes() {
            try {
                console.log('🔄 Загружаем доступные listing_type для выбранной локации...');
                
                // Get current location values
                const countrySelect = document.getElementById('countrySelect');
                const citySelect = document.getElementById('citySelect');
                const countySelect = document.getElementById('countySelect');
                const districtSelect = document.getElementById('districtSelect');
                
                // Check if all required location fields are filled
                if (!countrySelect.value || !citySelect.value || !countySelect.value) {
                    console.log('❌ Не все обязательные поля локации заполнены, пропускаем загрузку listing_type');
                    return;
                }
                
                const locationData = {
                    country_id: countrySelect.value,
                    city_id: citySelect.value,
                    county_id: countySelect.value,
                    district_id: districtSelect.value || 'none'
                };
                
                console.log('📍 Location data for listing types:', locationData);
                
                // Load house type listing types
                const houseTypeResponse = await fetch('/api/listing_types/house_type_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });
                const houseTypeData = await houseTypeResponse.json();
                if (houseTypeData.success) {
                    console.log('✅ House type listing types loaded:', houseTypeData.listing_types);
                    populateListingTypeSelect('houseTypeSelect', houseTypeData.listing_types, 'house_type');
                } else {
                    console.error('❌ Failed to load house type listing types:', houseTypeData.error);
                }

                // Load floor segment listing types
                const floorSegmentResponse = await fetch('/api/listing_types/floor_segment_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });
                const floorSegmentData = await floorSegmentResponse.json();
                if (floorSegmentData.success) {
                    console.log('✅ Floor segment listing types loaded:', floorSegmentData.listing_types);
                    populateListingTypeSelect('floorSegmentSelect', floorSegmentData.listing_types, 'floor_segment');
                } else {
                    console.error('❌ Failed to load floor segment listing types:', floorSegmentData.error);
                }

                // Load age data listing types
                const ageDataResponse = await fetch('/api/listing_types/age_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });
                const ageDataData = await ageDataResponse.json();
                if (ageDataData.success) {
                    console.log('✅ Age data listing types loaded:', ageDataData.listing_types);
                    populateListingTypeSelect('ageDataSelect', ageDataData.listing_types, 'age');
                } else {
                    console.error('❌ Failed to load age data listing types:', ageDataData.error);
                }

                // Load heating data listing types
                const heatingDataResponse = await fetch('/api/listing_types/heating_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationData)
                });
                const heatingDataData = await heatingDataResponse.json();
                if (heatingDataData.success) {
                    console.log('✅ Heating data listing types loaded:', heatingDataData.listing_types);
                    populateListingTypeSelect('heatingDataSelect', heatingDataData.listing_types, 'heating');
                } else {
                    console.error('❌ Failed to load heating data listing types:', heatingDataData.error);
                }
                
                console.log('✅ Все listing_type загружены для выбранной локации');
                
                // Load property trends for the selected location
                const trendsLocationData = {
                    country_id: document.getElementById('countrySelect').value,
                    city_id: document.getElementById('citySelect').value,
                    county_id: document.getElementById('countySelect').value,
                    district_id: document.getElementById('districtSelect').value || 'none'
                };
                loadPropertyTrends(trendsLocationData);
            } catch (error) {
                console.error('❌ Error loading listing types:', error);
            }
        }

        // Populate listing type select with options
        function populateListingTypeSelect(selectId, listingTypes, category) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.error(`❌ Select element not found: ${selectId}`);
                return;
            }

            console.log(`🔄 Populating select ${selectId} with ${listingTypes.length} types for category ${category}:`, listingTypes);
            
            // Clear existing options except the first placeholder
            select.innerHTML = '<option value="">' + getSelectPlaceholder(category) + '</option>';
            
            listingTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
            
            // Add change event listener
            select.onchange = () => selectListingType(category, select.value);
            
            console.log(`✅ Select ${selectId} populated with ${listingTypes.length} items`);
        }
        
        // Get placeholder text for select dropdowns
        function getSelectPlaceholder(category) {
            const placeholders = {
                'house_type': 'количество спален',
                'floor_segment': 'этаж',
                'age': 'возраст объекта',
                'heating': 'тип отопления'
            };
            return placeholders[category] || 'тип недвижимости';
        }

        // Reset listing type selection
        function resetListingTypeSelection() {
            selectedListingTypes = {
                house_type: null,
                floor_segment: null,
                age: null,
                heating: null,
                price: null,
                currency: 'EUR',
                area: 50
            };
            
            // Hide listing type section
            const listingTypeSection = document.getElementById('listingTypeSection');
            if (listingTypeSection) {
                listingTypeSection.style.display = 'none';
            }
            
            // Reset all select dropdowns
            const selects = ['houseTypeSelect', 'floorSegmentSelect', 'ageDataSelect', 'heatingDataSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.value = '';
                }
            });
            
            // Reset price and area fields
            const priceInput = document.getElementById('priceObjectInput');
            const areaInput = document.getElementById('areaObjectInput');
            
            if (priceInput) priceInput.value = '';
            if (areaInput) areaInput.value = '';
            
            // Reset currency buttons
            const currencyButtons = document.querySelectorAll('.currency-button');
            currencyButtons.forEach(button => {
                button.classList.remove('active');
            });
            // Set EUR as default active
            const eurButton = document.querySelector('.currency-button[data-currency="EUR"]');
            if (eurButton) eurButton.classList.add('active');
            
            // Hide selected property types section
            const selectedPropertyTypes = document.getElementById('selectedPropertyTypes');
            if (selectedPropertyTypes) {
                selectedPropertyTypes.style.display = 'none';
            }
        }

        // Handle listing type selection
        function selectListingType(category, type) {
            console.log(`🎯 Selecting listing type: ${category} = ${type}`);
            
            if (type && type !== '') {
                selectedListingTypes[category] = type;
                console.log(`✅ Selected: ${category} = ${type}`);
            } else {
                selectedListingTypes[category] = null;
                console.log(`❌ Deselected: ${category}`);
            }
            
            // Update the display of selected property types
            updateSelectedPropertyTypesDisplay();
            
            updateConfirmButton();
            
            // Check if all listing types are selected
            const allTypesSelected = selectedListingTypes.house_type && 
                                   selectedListingTypes.floor_segment && 
                                   selectedListingTypes.age && 
                                   selectedListingTypes.heating &&
                                   selectedListingTypes.price &&
                                   selectedListingTypes.area;
            
            console.log('🔍 All listing types selected:', allTypesSelected, selectedListingTypes);
            
            // If all types are selected, automatically load region data
            if (allTypesSelected) {
                console.log('🚀 All listing types selected, automatically loading region data...');
                // Small delay to ensure UI updates are complete
                setTimeout(() => {
                    confirmLocation();
                }, 100);
            }
        }

        // Load districts based on selected county
        async function loadDistricts(countyId) {
            console.log('🔄 Loading districts for county_id:', countyId);
            
            try {
                const response = await fetch('/api/locations/districts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ county_id: countyId })
                });
                
                const data = await response.json();
                console.log('📊 Districts API response:', data);
                
                if (data.success) {
                    const districtSelect = document.getElementById('districtSelect');
                    districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
                    
                    // Add "не имеет значения" option
                    const noDistrictOption = document.createElement('option');
                    noDistrictOption.value = 'none';
                    noDistrictOption.textContent = 'Не имеет значения';
                    districtSelect.appendChild(noDistrictOption);
                    
                    console.log('📍 Adding districts:', data.districts);
                    data.districts.forEach(([id, name]) => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = name;
                        districtSelect.appendChild(option);
                    });
                    
                    districtSelect.disabled = false;
                    console.log('✅ Districts loaded, district select enabled');
                } else {
                    console.error('❌ Failed to load districts:', data.error);
                }
            } catch (error) {
                console.error('❌ Error loading districts:', error);
            }
        }

        // Event handlers for location changes
        function onCountryChange() {
            const countrySelect = document.getElementById('countrySelect');
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countryId = countrySelect.value;
            
            // Reset dependent selects
            citySelect.innerHTML = `<option value="">${getText('cityPlaceholder')}</option>`;
            citySelect.disabled = true;
            countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
            countySelect.disabled = true;
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Reset listing type selection and hide section
            resetListingTypeSelection();
            const listingTypeSection = document.getElementById('listingTypeSection');
            if (listingTypeSection) {
                listingTypeSection.style.display = 'none';
            }
            
            // Clear existing property trends
            clearPropertyTrends();
            
            if (countryId) {
                loadCities(countryId);
            }
            
            updateConfirmButton();
        }

        function onCityChange() {
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const cityId = citySelect.value;
            
            // Reset dependent selects
            countySelect.innerHTML = `<option value="">${getText('countyPlaceholder')}</option>`;
            countySelect.disabled = true;
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            
            // Reset listing type selection and hide section
            resetListingTypeSelection();
            const listingTypeSection = document.getElementById('listingTypeSection');
            if (listingTypeSection) {
                listingTypeSection.style.display = 'none';
            }
            
            // Clear existing property trends
            clearPropertyTrends();
            
            if (cityId) {
                loadCounties(cityId);
            }
            
            updateConfirmButton();
        }

        function onCountyChange() {
            console.log('🔄 County changed, starting onCountyChange function...');
            
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countyId = countySelect.value;
            console.log('📍 Selected county_id:', countyId);
            
            // Reset dependent selects
            districtSelect.innerHTML = `<option value="">${getText('districtPlaceholder')}</option>`;
            districtSelect.disabled = true;
            console.log('🔄 Reset district select');
            
            // Reset listing type selection and hide section
            resetListingTypeSelection();
            const listingTypeSection = document.getElementById('listingTypeSection');
            if (listingTypeSection) {
                listingTypeSection.style.display = 'none';
            }
            
            // Clear existing property trends
            clearPropertyTrends();
            
            if (countyId) {
                console.log('✅ County selected, loading districts for county_id:', countyId);
                loadDistricts(countyId);
            } else {
                console.log('❌ No county selected');
            }
            
            updateConfirmButton();
        }

        function onDistrictChange() {
            console.log('🔄 District changed, updating confirm button...');
            updateConfirmButton();
            
            // Show listing type selection section when district is selected
            const districtSelect = document.getElementById('districtSelect');
            const listingTypeSection = document.getElementById('listingTypeSection');
            
            console.log('📍 District value:', districtSelect.value);
            
            if (districtSelect.value && districtSelect.value !== 'none') {
                console.log('✅ District selected, showing listing type section and loading types...');
                listingTypeSection.style.display = 'block';
                // Load available listing types for the selected location
                loadListingTypes();
                
                // Load property trends for the new location
                const districtLocationData = {
                    country_id: document.getElementById('countrySelect').value,
                    city_id: document.getElementById('citySelect').value,
                    county_id: document.getElementById('countySelect').value,
                    district_id: districtSelect.value
                };
                loadPropertyTrends(districtLocationData);
            } else {
                console.log('❌ No district selected, hiding listing type section...');
                listingTypeSection.style.display = 'none';
                // Reset listing type selection when district is cleared
                resetListingTypeSelection();
                // Clear existing property trends
                clearPropertyTrends();
            }
        }

        // Update selected property types display
        function updateSelectedPropertyTypesDisplay() {
            const selectedPropertyTypes = document.getElementById('selectedPropertyTypes');
            const propertyTypesDetails = document.getElementById('propertyTypesDetails');
            
            if (!selectedPropertyTypes || !propertyTypesDetails) return;
            
            // Check if any property types are selected
            const hasSelectedTypes = selectedListingTypes.house_type || 
                                   selectedListingTypes.floor_segment || 
                                   selectedListingTypes.age || 
                                   selectedListingTypes.heating ||
                                   selectedListingTypes.price ||
                                   selectedListingTypes.area;
            
            if (hasSelectedTypes) {
                selectedPropertyTypes.style.display = 'block';
                
                let html = '';
                
                if (selectedListingTypes.house_type) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">${getText('bedroomsLabel')}:</span>
                            <span class="property-type-value">${selectedListingTypes.house_type}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.floor_segment) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">${getText('floorLabel')}:</span>
                            <span class="property-type-value">${selectedListingTypes.floor_segment}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.age) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">${getText('ageLabel')}:</span>
                            <span class="property-type-value">${selectedListingTypes.age}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.heating) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">${getText('heatingLabel')}:</span>
                            <span class="property-type-value">${selectedListingTypes.heating}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.price) {
                    const currencySymbols = {
                        'TRY': '₺',
                        'EUR': '€',
                        'USD': '$'
                    };
                    const currencySymbol = currencySymbols[selectedListingTypes.currency] || '';
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">Цена объекта:</span>
                            <span class="property-type-value">${currencySymbol}${selectedListingTypes.price}</span>
                        </div>
                    `;
                }
                
                if (selectedListingTypes.area) {
                    html += `
                        <div class="property-type-item">
                            <span class="property-type-label">Площадь объекта:</span>
                            <span class="property-type-value">${selectedListingTypes.area} м²</span>
                        </div>
                    `;
                }
                
                propertyTypesDetails.innerHTML = html;
            } else {
                selectedPropertyTypes.style.display = 'none';
            }
        }

        // Update confirm button state
        function updateConfirmButton() {
            const countrySelect = document.getElementById('countrySelect');
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            const confirmButton = document.getElementById('confirmButton');
            
            const hasCountry = countrySelect.value;
            const hasCity = citySelect.value;
            const hasCounty = countySelect.value;
            const hasDistrict = districtSelect.value && districtSelect.value !== '';
            
            // Check if all listing types are selected (only if district is selected and not "none")
            let hasAllListingTypes = true;
            if (hasDistrict && districtSelect.value !== 'none') {
                hasAllListingTypes = selectedListingTypes.house_type && 
                                   selectedListingTypes.floor_segment && 
                                   selectedListingTypes.age && 
                                   selectedListingTypes.heating &&
                                   selectedListingTypes.price &&
                                   selectedListingTypes.area;
                
                console.log('🔍 Checking listing types:', {
                    house_type: selectedListingTypes.house_type,
                    floor_segment: selectedListingTypes.floor_segment,
                    age: selectedListingTypes.age,
                    heating: selectedListingTypes.heating,
                    price: selectedListingTypes.price,
                    area: selectedListingTypes.area,
                    hasAllListingTypes: hasAllListingTypes
                });
            }
            
            // Button is enabled if all location fields are filled
            // For listing types: if district is "none", no listing types required
            // If district is selected, all listing types are required
            const isDisabled = !(hasCountry && hasCity && hasCounty && hasDistrict) || 
                              (hasDistrict && districtSelect.value !== 'none' && !hasAllListingTypes);
            
            confirmButton.disabled = isDisabled;
            
            console.log('🔘 Confirm button state:', {
                hasCountry, hasCity, hasCounty, hasDistrict,
                districtValue: districtSelect.value,
                hasAllListingTypes,
                isDisabled
            });
        }

        // Confirm location selection
        async function confirmLocation() {
            console.log('🎯 confirmLocation function called');
            
            const countrySelect = document.getElementById('countrySelect');
            const citySelect = document.getElementById('citySelect');
            const countySelect = document.getElementById('countySelect');
            const districtSelect = document.getElementById('districtSelect');
            
            const countryId = countrySelect.value;
            const cityId = citySelect.value;
            const countyId = countySelect.value;
            const districtId = districtSelect.value === 'none' ? null : districtSelect.value;
            
            // Get names for display
            const countryName = countrySelect.options[countrySelect.selectedIndex].text;
            const cityName = citySelect.options[citySelect.selectedIndex].text;
            const countyName = countySelect.options[countySelect.selectedIndex].text;
            const districtName = districtSelect.value === 'none' ? 'Не имеет значения' : districtSelect.options[districtSelect.selectedIndex].text;
            
            // Convert price to EUR if needed
            let priceInEUR = null;
            if (selectedListingTypes.price && selectedListingTypes.currency !== 'EUR') {
                priceInEUR = await convertToEUR(selectedListingTypes.price, selectedListingTypes.currency);
                console.log(`💰 Price converted: ${selectedListingTypes.price} ${selectedListingTypes.currency} → ${priceInEUR} EUR`);
            } else if (selectedListingTypes.price) {
                priceInEUR = selectedListingTypes.price;
            }
            
            // Update selected location
            selectedLocation = {
                country_id: countryId,
                city_id: cityId,
                county_id: countyId,
                district_id: districtId,
                country_name: countryName,
                city_name: cityName,
                county_name: countyName,
                district_name: districtName,
                // Add property details
                property_price: selectedListingTypes.price,
                property_price_currency: selectedListingTypes.currency,
                property_price_eur: priceInEUR,
                property_area: selectedListingTypes.area
            };
            
            console.log('📍 Selected location for data loading:', {
                country_id: countryId,
                city_id: cityId,
                county_id: countyId,
                district_id: districtId,
                country_name: countryName,
                city_name: cityName,
                county_name: countyName,
                district_name: districtName,
                property_price: selectedListingTypes.price,
                property_price_currency: selectedListingTypes.currency,
                property_price_eur: priceInEUR,
                property_area: selectedListingTypes.area
            });
            
            // Display selected location
            displaySelectedLocation();
            
            // Get user language
            await getUserLanguage();
            
            // Load region data with selected listing types
            await loadRegionData();
        }

        // Display selected location
        // Check and display admin IDs if user is admin
        async function checkAndDisplayAdminIds(adminIdsBlock, adminIdsDetails) {
            try {
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                    const user = window.Telegram.WebApp.initDataUnsafe.user;
                    if (user && user.id) {
                        // Check if user is admin via API
                        const response = await fetch('/api/check_admin_status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ telegram_id: user.id })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.is_admin) {
                                // User is admin, show admin IDs
                                adminIdsDetails.innerHTML = `
                                    country_id: ${selectedLocation.country_id}<br>
                                    city_id: ${selectedLocation.city_id}<br>
                                    county_id: ${selectedLocation.county_id}<br>
                                    district_id: ${selectedLocation.district_id || 'null'}
                                `;
                                adminIdsBlock.style.display = 'block';
                                return;
                            }
                        }
                    }
                }
                
                // Hide admin IDs block if user is not admin
                adminIdsBlock.style.display = 'none';
            } catch (error) {
                console.error('Error checking admin status:', error);
                // Hide admin IDs block on error
                adminIdsBlock.style.display = 'none';
            }
        }

        // Display selected location
        async function displaySelectedLocation() {
            const selectedLocationDiv = document.getElementById('selectedLocation');
            const locationDetails = document.getElementById('locationDetails');
            const adminIdsBlock = document.getElementById('adminIdsBlock');
            const adminIdsDetails = document.getElementById('adminIdsDetails');
            
            // Build location string
            let locationString = selectedLocation.country_name;
            if (selectedLocation.city_name) {
                locationString += `, ${selectedLocation.city_name}`;
            }
            if (selectedLocation.county_name) {
                locationString += `, ${selectedLocation.county_name}`;
            }
            if (selectedLocation.district_name && selectedLocation.district_name !== 'Не имеет значения') {
                locationString += `, ${selectedLocation.district_name}`;
            }
            
            locationDetails.textContent = locationString;
            
            // Update selected property types display
            updateSelectedPropertyTypesDisplay();
            
            // Check if user is admin and show admin IDs block
            await checkAndDisplayAdminIds(adminIdsBlock, adminIdsDetails);
            
            selectedLocationDiv.style.display = 'block';
        }

        // Get user language
        async function getUserLanguage() {
            try {
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                    const user = window.Telegram.WebApp.initDataUnsafe.user;
                    if (user && user.id) {
                        const response = await fetch('/api/user/language', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ telegram_id: user.id })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            userLanguage = data.language;
                            currentLanguage = data.language;
                            updatePageText();
                        }
                    }
                }
            } catch (error) {
                console.error('Error getting user language:', error);
            }
        }

        // Load region data
        async function loadRegionData() {
            console.log('🚀 loadRegionData function called');
            
            try {
                const requestBody = {
                    country_id: selectedLocation.country_id,
                    city_id: selectedLocation.city_id,
                    county_id: selectedLocation.county_id,
                    district_id: selectedLocation.district_id,
                    listing_types: selectedListingTypes
                };
                
                console.log('🔄 Loading region data with request:', requestBody);
                
                const response = await fetch('/api/region_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                console.log('📊 API response:', data);
                
                if (data.success) {
                    displayRegionData(data);
                } else {
                    throw new Error(data.error || 'Failed to load region data');
                }
            } catch (error) {
                console.error('Error loading region data:', error);
                showError('Ошибка загрузки данных региона');
            }
        }

        // Display region data
        function displayRegionData(data) {
            console.log('📊 Processing received data:', data);
            console.log('🔍 Data structure:', {
                hasGeneralData: !!data.general_data,
                hasHouseTypeData: !!data.house_type_data,
                hasFloorSegmentData: !!data.floor_segment_data,
                hasAgeData: !!data.age_data,
                hasHeatingData: !!data.heating_data
            });
            
            // Try different possible key names for data
            const generalData = data.general_data || data.generalData || data.general || [];
            const houseTypeData = data.house_type_data || data.houseTypeData || data.house_types || data.houseTypes || [];
            const floorSegmentData = data.floor_segment_data || data.floorSegmentData || data.floor_segments || data.floorSegments || [];
            const ageData = data.age_data || data.ageData || data.ages || [];
            const heatingData = data.heating_data || data.heatingData || data.heating || [];
            
            console.log('🔍 Extracted data arrays:', {
                general: generalData.length,
                houseType: houseTypeData.length,
                floorSegment: floorSegmentData.length,
                age: ageData.length,
                heating: heatingData.length
            });
            
            // Data sections removed - only market indicators table is shown
            
            // Generate and display summary table
            generateSummaryTable(data);
            
            // Show data content
            document.getElementById('dataContent').style.display = 'block';
        }









        // Format field name
        function formatFieldName(field) {
            // Convert snake_case to readable text
            return field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // Get localized field label
        function getFieldLabel(field, type) {
            const fieldLabels = {
                'comparable_area_for_sale': 'comparableAreaForSaleLabel',
                'listing_period_for_sale': 'listingPeriodForSaleLabel',
                'unit_price_for_sale': 'unitPriceForSaleLabel',
                'comparable_area_for_rent': 'comparableAreaForRentLabel',
                'listing_period_for_rent': 'listingPeriodForRentLabel',
                'unit_price_for_rent': 'unitPriceForRentLabel'
            };
            
            const labelKey = fieldLabels[field];
            return labelKey ? getText(labelKey) : formatFieldName(field);
        }

        // Format field value
        function formatFieldValue(value, field) {
            if (value === null || value === undefined) return '-';
            
            // Format based on field type
            if (typeof value === 'number') {
                if (field.includes('price') || field.includes('Price')) {
                    return formatValue(value, 'price');
                } else if (field.includes('yield') || field.includes('Yield')) {
                    // For yield, don't multiply by 100, just add % symbol
                    return `${parseFloat(value).toFixed(2)}%`;
                } else if (field.includes('rate')) {
                    return formatValue(value, 'percentage');
                } else if (field.includes('period') || field.includes('Period')) {
                    return formatValue(value, 'days');
                } else if (field.includes('area') || field.includes('Area')) {
                    return `${value} м²`;
                } else {
                    return value.toLocaleString();
                }
            }
            
            return value.toString();
        }

        // Format value based on type
        function formatValue(value, type) {
            if (value === null || value === undefined || value === '-') return '-';
            
            switch (type) {
                case 'price':
                    return `₺${parseFloat(value).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                case 'percentage':
                    return `${parseFloat(value).toFixed(2)}%`;
                case 'days':
                    return `${value} дней`;
                default:
                    return value.toString();
            }
        }

        // Generate market comparison block
        function generateMarketComparison(summary) {
            // Get user's object data
            const userPrice = selectedListingTypes.price || 0;
            const userArea = selectedListingTypes.area || 0;
            const userCurrency = selectedListingTypes.currency || 'EUR';
            
            if (!userPrice || !userArea) {
                return '';
            }
            
            // Calculate user's price per m²
            const userPricePerM2 = userPrice / userArea;
            
            // Get market data for comparison
            const marketPricePerM2 = summary.min_unit_price_for_sale;
            const marketArea = summary.comparable_area_for_sale;
            
            if (!marketPricePerM2 || !marketArea) {
                return '';
            }
            
            // Determine target currency based on country
            const targetCurrency = getCurrentCountry() === 'Turkey' ? 'TRY' : 'EUR';
            
            // Convert user's price to target currency for comparison
            let userPriceInTargetCurrency = userPricePerM2;
            if (userCurrency !== targetCurrency) {
                // Use the same conversion logic as in price forecast
                const conversionRate = getCurrencyRate(userCurrency, targetCurrency);
                userPriceInTargetCurrency = userPricePerM2 * conversionRate;
            }
            
            // Calculate price comparison
            const priceDifference = userPriceInTargetCurrency - marketPricePerM2.min;
            const priceDifferencePercent = marketPricePerM2.min > 0 ? (priceDifference / marketPricePerM2.min * 100) : 0;
            
            // Calculate area comparison
            const areaDifference = userArea - marketArea.min;
            const areaDifferencePercent = marketArea.min > 0 ? (areaDifference / marketArea.min * 100) : 0;
            
            // Generate comparison text
            let comparisonText = '';
            
            // Price comparison
            if (Math.abs(priceDifferencePercent) < 5) {
                comparisonText += `<p><strong>${getText('priceComparisonLabel')}</strong> ${getText('priceCloseToMarket').replace('${userPrice}', formatValue(userPriceInTargetCurrency, 'price')).replace('${marketMin}', formatValue(marketPricePerM2.min, 'price')).replace('${marketMax}', formatValue(marketPricePerM2.max, 'price'))}</p>`;
            } else if (priceDifferencePercent > 0) {
                comparisonText += `<p><strong>${getText('priceComparisonLabel')}</strong> ${getText('priceAboveMarket').replace('${userPrice}', formatValue(userPriceInTargetCurrency, 'price')).replace('${percent}', Math.abs(priceDifferencePercent).toFixed(1))}</p>`;
            } else {
                comparisonText += `<p><strong>${getText('priceComparisonLabel')}</strong> ${getText('priceBelowMarket').replace('${userPrice}', formatValue(userPriceInTargetCurrency, 'price')).replace('${percent}', Math.abs(priceDifferencePercent).toFixed(1))}</p>`;
            }
            
            // Area comparison
            if (userArea >= marketArea.min && userArea <= marketArea.max) {
                comparisonText += `<p><strong>${getText('areaLabel')}:</strong> ${getText('areaMatchesMarket').replace('${userArea}', userArea).replace('${marketMin}', marketArea.min).replace('${marketMax}', marketArea.max)}</p>`;
            } else if (userArea < marketArea.min) {
                comparisonText += `<p><strong>${getText('areaLabel')}:</strong> ${getText('areaBelowMarket').replace('${userArea}', userArea).replace('${marketMin}', marketArea.min).replace('${marketMax}', marketArea.max)}</p>`;
            } else {
                comparisonText += `<p><strong>${getText('areaLabel')}:</strong> ${getText('areaAboveMarket').replace('${userArea}', userArea).replace('${marketMin}', marketArea.min).replace('${marketMax}', marketArea.max)}</p>`;
            }
            
            // Generate HTML
            let html = '<div class="market-comparison-block">';
            html += '<div class="market-comparison-content">';
            html += `<h4 class="market-comparison-title">${getText('marketComparisonTitle')}</h4>`;
            html += `<div class="market-comparison-value">${formatValue(userPricePerM2, 'price')}/м²</div>`;
            html += '<div class="market-comparison-details">';
            html += `<div class="market-comparison-price">${getText('priceComparisonLabel')} ${formatValue(userPriceInTargetCurrency, 'price')}</div>`;
            html += `<div class="market-comparison-area">${getText('areaLabel')}: ${userArea} м²</div>`;
            html += '</div>';
            html += '<div class="market-comparison-analysis">';
            html += comparisonText;
            html += '</div>';
            html += '</div></div>';
            
            return html;
        }
        
        // Helper function to get current country
        function getCurrentCountry() {
            // Get country from selected location
            if (selectedLocation && selectedLocation.country_name) {
                const countryName = selectedLocation.country_name.toLowerCase();
                if (countryName.includes('türkiye') || countryName.includes('turkey') || countryName.includes('турция')) {
                    return 'Turkey';
                }
            }
            return 'Other'; // Default to other countries
        }
        
        // Helper function to get currency conversion rate
        function getCurrencyRate(fromCurrency, toCurrency) {
            // This should get the actual rate from the currency table
            // For now, we'll use approximate rates
            const rates = {
                'EUR': { 'TRY': 30, 'USD': 1.18 },
                'USD': { 'TRY': 25.4, 'EUR': 0.85 },
                'TRY': { 'EUR': 0.033, 'USD': 0.039 }
            };
            
            if (fromCurrency === toCurrency) return 1;
            return rates[fromCurrency]?.[toCurrency] || 1;
        }
        
        // Generate analytical summary based on market data
        function generateAnalyticalSummary(summary) {
            let analysis = '<div class="analytical-summary">';
            analysis += '<h4 class="summary-title">Анализ рынка</h4>';
            

            
            // Sale analysis
            if (summary.comparable_area_for_sale && summary.listing_period_for_sale && summary.min_unit_price_for_sale) {
                const area = summary.comparable_area_for_sale;
                const period = summary.listing_period_for_sale;
                const price = summary.min_unit_price_for_sale;
                
                analysis += `<p><strong>Продажа:</strong> востребованная площадь ${area.min}–${area.max} м², `;
                analysis += `срок экспозиции ${period.min}–${period.max} дней, `;
                analysis += `цена за м² ${formatValue(price.min, 'price')} – ${formatValue(price.max, 'price')}.</p>`;
            }
            
            // Rent analysis
            if (summary.comparable_area_for_rent && summary.listing_period_for_rent && summary.min_unit_price_for_rent) {
                const area = summary.comparable_area_for_rent;
                const period = summary.listing_period_for_rent;
                const price = summary.min_unit_price_for_rent;
                
                analysis += `<p><strong>Аренда:</strong> самая востребованная площадь ${area.min}–${area.max} м², `;
                analysis += `срок экспозиции ${period.min}–${period.max} дней, `;
                analysis += `ставка ${formatValue(price.min, 'price')} – ${formatValue(price.max, 'price')} за м².</p>`;
            }
            
            // Yield analysis
            if (summary.yield) {
                const yieldMin = summary.yield.min;
                const yieldMax = summary.yield.max;
                
                analysis += `<p><strong>Доходность</strong> составляет ${yieldMin.toFixed(2)}% – ${yieldMax.toFixed(2)}%.</p>`;
            }
            
            analysis += '</div>';
            return analysis;
        }
        
        // Calculate consolidated data for market analysis (для всех пользователей)
        function calculateConsolidatedDataForAnalysis(data) {
            if (!data) return null;
            
            // Define coefficients for each category
            const coefficients = {
                house_type: 0.40,      // 40% - спальни
                age: 0.30,             // 30% - возраст
                floor_segment: 0.20,   // 20% - этаж
                heating: 0.10          // 10% - отопление
            };
            
            const categories = ['house_type_data', 'floor_segment_data', 'age_data', 'heating_data'];
            const consolidatedResults = {
                salePrice: { calculated: false, value: 0 },
                rentPrice: { calculated: false, value: 0 },
                yield: { calculated: false, value: 0 }
            };
            
            // Calculate consolidated sale price
            const saleItems = [];
            const rentItems = [];
            const yieldItems = [];
            
            for (const categoryName of categories) {
                if (data[categoryName] && data[categoryName].length > 0) {
                    const categoryData = data[categoryName][0];
                    const coefficient = coefficients[categoryName.replace('_data', '')];
                    
                    if (categoryData.unit_price_for_sale && categoryData.unit_price_for_sale > 0) {
                        saleItems.push({
                            value: parseFloat(categoryData.unit_price_for_sale),
                            coefficient: coefficient
                        });
                    }
                    
                    if (categoryData.unit_price_for_rent && categoryData.unit_price_for_rent > 0) {
                        rentItems.push({
                            value: parseFloat(categoryData.unit_price_for_rent),
                            coefficient: coefficient
                        });
                    }
                    
                    if (categoryData.yield_percentage && categoryData.yield_percentage > 0) {
                        yieldItems.push({
                            value: parseFloat(categoryData.yield_percentage),
                            coefficient: coefficient
                        });
                    }
                }
            }
            
            // Calculate weighted averages
            if (saleItems.length > 0) {
                const result = calculateConsolidatedValue(saleItems);
                if (result.calculated) {
                    consolidatedResults.salePrice = result;
                }
            }
            
            if (rentItems.length > 0) {
                const result = calculateConsolidatedValue(rentItems);
                if (result.calculated) {
                    consolidatedResults.rentPrice = result;
                }
            }
            
            if (yieldItems.length > 0) {
                const result = calculateConsolidatedValue(yieldItems);
                if (result.calculated) {
                    consolidatedResults.yield = result;
                }
            }
            
            return consolidatedResults;
        }
        
        // Generate market analysis text in unified format (like "Вывод прогноза")
        function generateMarketAnalysisText(summary, consolidatedData = null) {
            let analysis = '<div class="market-analysis-content">';
            
            // Если есть данные консолидированной оценки, показываем их
            if (consolidatedData) {
                // Консолидированная средняя цена продажи
                if (consolidatedData.salePrice && consolidatedData.salePrice.calculated) {
                    analysis += `<div class="analysis-section">
                        <strong>Консолидированная средняя цена продажи:</strong> ≈ ${formatValue(consolidatedData.salePrice.value, 'price')}/м²
                    </div>`;
                }
                
                // Консолидированная средняя цена аренды
                if (consolidatedData.rentPrice && consolidatedData.rentPrice.calculated) {
                    analysis += `<div class="analysis-section">
                        <strong>Консолидированная средняя цена аренды:</strong> ≈ ${formatValue(consolidatedData.rentPrice.value, 'price')}/м²
                    </div>`;
                }
                
                // Консолидированная средняя доходность
                if (consolidatedData.yield && consolidatedData.yield.calculated) {
                    analysis += `<div class="analysis-section">
                        <strong>Консолидированная средняя доходность:</strong> ≈ ${formatValue(consolidatedData.yield.value, 'percentage')}
                    </div>`;
                }
            } else {
                // Sale analysis text (оригинальный код)
                if (summary.comparable_area_for_sale && summary.listing_period_for_sale && summary.unit_price_for_sale) {
                    const area = summary.comparable_area_for_sale;
                    const period = summary.listing_period_for_sale;
                    const price = summary.unit_price_for_sale;
                    
                    // Calculate average area
                    const avgArea = Math.round((area.min + area.max) / 2);
                    
                    const saleText = getText('saleAnalysisText')
                        .replace('{area}', avgArea)
                        .replace('{minPrice}', formatValue(price.min, 'price'))
                        .replace('{maxPrice}', formatValue(price.max, 'price'))
                        .replace('{minDays}', period.min)
                        .replace('{maxDays}', period.max);
                    
                    analysis += `<div class="analysis-section">
                        <strong>${getText('saleHeader')}:</strong> ${saleText}
                    </div>`;
                }
                
                // Add spacing between sections
                if ((summary.comparable_area_for_sale && summary.listing_period_for_sale && summary.unit_price_for_sale) &&
                    (summary.comparable_area_for_rent && summary.listing_period_for_rent && summary.unit_price_for_rent)) {
                    analysis += '<div class="section-spacing"></div>';
                }
                
                // Rent analysis text
                if (summary.comparable_area_for_rent && summary.listing_period_for_rent && summary.unit_price_for_rent) {
                    const area = summary.comparable_area_for_rent;
                    const period = summary.listing_period_for_rent;
                    const price = summary.unit_price_for_rent;
                    
                    // Calculate average area
                    const avgArea = Math.round((area.min + area.max) / 2);
                    
                    const rentTextFinal = getText('rentAnalysisText')
                        .replace('{area}', avgArea)
                        .replace('{minPrice}', formatValue(price.min, 'price'))
                        .replace('{maxPrice}', formatValue(price.max, 'price'))
                        .replace('{minDays}', period.min)
                        .replace('{maxDays}', period.max);
                    
                    analysis += `<div class="analysis-section">
                        <strong>${getText('rentHeader')}:</strong> ${rentTextFinal}
                    </div>`;
                }
            }
            
            analysis += '</div></div>';
            return analysis;
        }

        // Generate market analysis text block
        function generateMarketAnalysisText(summary) {
            if (!summary || Object.keys(summary).length === 0) {
                return '';
            }
            
            // Calculate average values for areas
            const avgSaleArea = summary.comparable_area_for_sale ? 
                Math.round((summary.comparable_area_for_sale.min + summary.comparable_area_for_sale.max) / 2) : 60;
            const avgRentArea = summary.comparable_area_for_rent ? 
                Math.round((summary.comparable_area_for_rent.min + summary.comparable_area_for_rent.max) / 2) : 65;
            
            // Get min/max prices and periods
            const saleMinPrice = summary.unit_price_for_sale ? summary.unit_price_for_sale.min : 31061;
            const saleMaxPrice = summary.unit_price_for_sale ? summary.unit_price_for_sale.max : 45385;
            const saleMinPeriod = summary.listing_period_for_sale ? summary.listing_period_for_sale.min : 62;
            const saleMaxPeriod = summary.listing_period_for_sale ? summary.listing_period_for_sale.max : 90;
            
            const rentMinPrice = summary.unit_price_for_rent ? summary.unit_price_for_rent.min : 196.24;
            const rentMaxPrice = summary.unit_price_for_rent ? summary.unit_price_for_rent.max : 250;
            const rentMinPeriod = summary.listing_period_for_rent ? summary.listing_period_for_rent.min : 65;
            const rentMaxPeriod = summary.listing_period_for_rent ? summary.listing_period_for_rent.max : 96;
            
            let html = '<div class="market-analysis-text-block">';
            html += `<h4 class="market-analysis-text-title">${getText('marketAnalysisTitle')}</h4>`;
            html += '<div class="market-analysis-text-content">';
            
            // Sale analysis
            const saleText = getText('saleAnalysisText')
                .replace('{area}', avgSaleArea)
                .replace('{minPrice}', formatValue(saleMinPrice, 'price'))
                .replace('{minDays}', saleMinPeriod)
                .replace('{maxPrice}', formatValue(saleMaxPrice, 'price'))
                .replace('{maxDays}', saleMaxPeriod);
            html += `<p>${saleText}</p>`;
            
            // Rent analysis
            const rentText = getText('rentAnalysisText')
                .replace('{area}', avgRentArea)
                .replace('{minPrice}', formatValue(rentMinPrice, 'price'))
                .replace('{minDays}', rentMinPeriod)
                .replace('{maxPrice}', formatValue(rentMaxPrice, 'price'))
                .replace('{maxDays}', rentMaxPeriod);
            html += `<p>${rentText}</p>`;
            
            html += '</div></div>';
            
            return html;
        }

        // Generate market indicators table with organized structure
        async function generateSummaryTable(data) {
            const summaryContainer = document.getElementById('summaryDataContent');
            if (!summaryContainer) return;
            
            // Collect all data from all tables
            const allData = [];
            const tables = ['general_data', 'house_type_data', 'floor_segment_data', 'age_data', 'heating_data'];
            
            tables.forEach(tableName => {
                const tableData = data[tableName] || [];
                if (Array.isArray(tableData)) {
                    allData.push(...tableData);
                }
            });
            
            if (allData.length === 0) {
                summaryContainer.innerHTML = `<div class="no-data">${getText('noDataAvailable')}</div>`;
                return;
            }
            
            // Define fields for summary with new structure
            const saleFields = [
                'comparable_area_for_sale', 
                'listing_period_for_sale', 'unit_price_for_sale'
            ];
            
            const rentFields = [
                'comparable_area_for_rent', 
                'listing_period_for_rent', 'unit_price_for_rent'
            ];
            
            // Calculate min/max values for all fields
            const summary = {};
            const allFields = [...saleFields, ...rentFields, 'yield'];
            
            // Special handling for comparable_area fields - only use house_type_data
            const houseTypeData = data.house_type_data || [];
            
            allFields.forEach(field => {
                if (field === 'comparable_area_for_sale' || field === 'comparable_area_for_rent') {
                    // For area fields, only use house_type_data
                    const values = houseTypeData
                        .map(item => item[field])
                        .filter(val => val !== null && val !== undefined && !isNaN(parseFloat(val)));
                    
                    if (values.length > 0) {
                        summary[field] = {
                            min: Math.min(...values),
                            max: Math.max(...values)
                        };
                    }
                } else {
                    // For other fields, use all data
                    const values = allData
                        .map(item => item[field])
                        .filter(val => val !== null && val !== undefined && !isNaN(parseFloat(val)));
                    
                    if (values.length > 0) {
                        summary[field] = {
                            min: Math.min(...values),
                            max: Math.max(...values)
                        };
                    }
                }
            });
            
            // Generate market indicators in unified card format (like "Тренд цен")
            let html = '<div class="market-indicators-unified">';
            html += '<div class="unified-indicator-card">';
            
            // Sale Section
            if (summary.comparable_area_for_sale || summary.listing_period_for_sale || summary.unit_price_for_sale) {
                html += '<div class="indicator-section sale-section">';
                html += `<div class="section-title">${getText('saleHeader')}</div>`;
                
                if (summary.comparable_area_for_sale) {
                    const area = summary.comparable_area_for_sale;
                    html += `<div class="indicator-item">
                        <span class="indicator-label">${getText('comparableAreaForSaleLabel')}:</span>
                        <span class="indicator-value">${area.min} – ${area.max} м²</span>
                    </div>`;
                }
                
                if (summary.listing_period_for_sale) {
                    const period = summary.listing_period_for_sale;
                    html += `<div class="indicator-item">
                        <span class="indicator-label">${getText('listingPeriodForSaleLabel')}:</span>
                        <span class="indicator-value">${period.min} – ${period.max} дней</span>
                </div>`;
                }
                
                if (summary.unit_price_for_sale) {
                    const price = summary.unit_price_for_sale;
                    html += `<div class="indicator-item">
                        <span class="indicator-label">${getText('unitPriceForSaleLabel')}:</span>
                        <span class="indicator-value">${formatValue(price.min, 'price')} – ${formatValue(price.max, 'price')}</span>
                    </div>`;
                }
                
                html += '</div>';
            }
            
            // Rent Section
            if (summary.comparable_area_for_rent || summary.listing_period_for_rent || summary.unit_price_for_rent) {
                html += '<div class="indicator-section rent-section">';
                html += `<div class="section-title">${getText('rentHeader')}</div>`;
                
                if (summary.comparable_area_for_rent) {
                    const area = summary.comparable_area_for_rent;
                    html += `<div class="indicator-item">
                        <span class="indicator-label">${getText('comparableAreaForRentLabel')}:</span>
                        <span class="indicator-value">${area.min} – ${area.max} м²</span>
                    </div>`;
                }
                
                if (summary.listing_period_for_rent) {
                    const period = summary.listing_period_for_rent;
                    html += `<div class="indicator-item">
                        <span class="indicator-label">${getText('listingPeriodForRentLabel')}:</span>
                        <span class="indicator-value">${period.min} – ${period.max} дней</span>
                    </div>`;
                }
                
                if (summary.unit_price_for_rent) {
                    const price = summary.unit_price_for_rent;
                    html += `<div class="indicator-item">
                        <span class="indicator-label">${getText('unitPriceForRentLabel')}:</span>
                        <span class="indicator-value">${formatValue(price.min, 'price')} – ${formatValue(price.max, 'price')}</span>
                    </div>`;
                }
                
                html += '</div>';
            }
            
            html += '</div></div>';
            
            // Add spacing between blocks
            html += '<div class="block-spacing"></div>';
            
            // Add market analysis text block
            const marketAnalysisTextHtml = generateMarketAnalysisText(summary);
            html += marketAnalysisTextHtml;
            
            // Add spacing after market analysis
            html += '<div class="block-spacing"></div>';
            
            // Add detailed data tables for each category (admin only)
            const detailedTablesHtml = await generateDetailedDataTables(data);
            html += detailedTablesHtml;
            
            // Add consolidated assessment block
            const consolidatedAssessmentHtml = await generateConsolidatedAssessment(data);
            html += consolidatedAssessmentHtml;
            
            // Add market comparison block below the detailed tables
            if (Object.keys(summary).length > 0) {
                html += generateMarketComparison(summary);
            }
            
            // Add analytical summary below the comparison block
            if (Object.keys(summary).length > 0) {
                html += generateAnalyticalSummary(summary);
            }
            
            summaryContainer.innerHTML = html;
            
            // Load property trends data
            loadPropertyTrends(data);
        }

        // Generate detailed data tables as accordion for admin users only
        async function generateDetailedDataTables(data) {
            // Check if user is admin
            const telegramId = getTelegramId();
            if (!telegramId) {
                console.log('⚠️ No telegram_id found');
                return '';
            }
            
            const isAdmin = await checkAdminStatus(telegramId);
            if (!isAdmin) {
                console.log('⚠️ User is not admin');
                return '';
            }
            
            let html = '<div class="admin-data-accordion">';
            html += '<h4 class="accordion-title">Детальные данные (только для администраторов)</h4>';
            html += '<div class="accordion-container">';
            
            // House Type Data Accordion
            if (data.house_type_data && data.house_type_data.length > 0) {
                html += generateCategoryAccordion('house_type_data', 'Данные по количеству спален', data.house_type_data);
            }
            
            // Floor Segment Data Accordion
            if (data.floor_segment_data && data.floor_segment_data.length > 0) {
                html += generateCategoryAccordion('floor_segment_data', 'Данные по этажу', data.floor_segment_data);
            }
            
            // Age Data Accordion
            if (data.age_data && data.age_data.length > 0) {
                html += generateCategoryAccordion('age_data', 'Данные по возрасту объектов', data.age_data);
            }
            
            // Heating Data Accordion
            if (data.heating_data && data.heating_data.length > 0) {
                html += generateCategoryAccordion('heating_data', 'Данные по типу отопления', data.heating_data);
            }
            
            html += '</div></div>';
            return html;
        }

                // Generate accordion for specific category
        function generateCategoryAccordion(category, title, tableData) {
            if (!tableData || tableData.length === 0) return '';
            
            // Get all unique fields from the data
            const allFields = new Set();
            tableData.forEach(item => {
                Object.keys(item).forEach(key => {
                    if (key !== 'id' && key !== 'created_at' && key !== 'updated_at' && 
                        key !== 'country_id' && key !== 'city_id' && key !== 'county_id' && key !== 'district_id') {
                        allFields.add(key);
                    }
                });
            });
            
            const fields = Array.from(allFields).sort();
            const accordionId = `accordion-${category}`;
            
            let html = '<div class="accordion-item">';
            html += `<div class="accordion-header" onclick="toggleAccordion('${accordionId}')">`;
            html += `<span class="accordion-title">${title}</span>`;
            html += '<span class="accordion-icon">▼</span>';
            html += '</div>';
            html += `<div class="accordion-content" id="${accordionId}">`;
            html += '<div class="accordion-table-container">';
            html += '<table class="accordion-table">';
            html += '<thead><tr>';
            
            // Add headers
            html += '<th>Параметр</th>';
            tableData.forEach((item, index) => {
                const listingType = item.listing_type || `Запись ${index + 1}`;
                html += `<th>${listingType}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Add data rows
            fields.forEach(field => {
                if (field !== 'listing_type') {
                    html += '<tr>';
                    html += `<td class="field-name">${formatFieldName(field)}</td>`;
                    
                    tableData.forEach(item => {
                        const value = item[field];
                        html += `<td class="field-value">${formatFieldValue(value, field)}</td>`;
                    });
                    
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table>';
            html += '</div></div></div>';
            
            return html;
        }
        
        // Get telegram_id from Telegram WebApp
        function getTelegramId() {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                return window.Telegram.WebApp.initDataUnsafe.user.id;
            }
            return null;
        }
        
        // Toggle accordion content
        function toggleAccordion(accordionId) {
            const content = document.getElementById(accordionId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.accordion-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.textContent = '▼';
                header.classList.add('active');
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
                header.classList.remove('active');
            }
        }
        
        // Check if user is admin by telegram_id
        async function checkAdminStatus(telegramId) {
            try {
                const response = await fetch('/api/check_admin_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                return result.is_admin === true;
                
            } catch (error) {
                console.error('❌ Error checking admin status:', error);
                return false;
            }
        }
        
        // Clear existing property trends section
        function clearPropertyTrends() {
            const existingTrendsSection = document.getElementById('propertyTrendsSection');
            if (existingTrendsSection) {
                existingTrendsSection.remove();
                console.log('🗑️ Property trends section cleared (including forecast)');
            }
        }
        
        // Load property trends data for selected location
        async function loadPropertyTrends(data) {
            try {
                // Use selected location data instead of searching through tables
                if (!selectedLocation.country_id || !selectedLocation.city_id || 
                    !selectedLocation.county_id || !selectedLocation.district_id) {
                    console.log('⚠️ No location selected for property trends');
                    return;
                }
                
                const locationIds = {
                    country_id: selectedLocation.country_id,
                    city_id: selectedLocation.city_id,
                    county_id: selectedLocation.county_id,
                    district_id: selectedLocation.district_id
                };
                
                console.log('🔄 Loading property trends for location:', locationIds);
                console.log('📍 Selected location object:', selectedLocation);
                
                // Make API request to get property trends
                const response = await fetch('/api/property_trends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(locationIds)
                });
                
                const trendsData = await response.json();
                console.log('📊 Property trends response:', trendsData);
                console.log('🔍 API response details:');
                console.log('  - success:', trendsData.success);
                console.log('  - trends count:', trendsData.trends ? trendsData.trends.length : 'undefined');
                console.log('  - first trend:', trendsData.trends ? trendsData.trends[0] : 'undefined');
                
                if (trendsData.success && trendsData.trends && trendsData.trends.length > 0) {
                    console.log('✅ Property trends data received:', trendsData.trends);
                    console.log('🔍 First trend record:', trendsData.trends[0]);
                    
                    // Add property trends section below the summary table
                    addPropertyTrendsSection(trendsData.trends);
                } else {
                    console.log('⚠️ No property trends data available');
                    console.log('trendsData:', trendsData);
                }
                
            } catch (error) {
                console.error('❌ Error loading property trends:', error);
            }
        }
        
        // Find trend data for current month and year
        function findCurrentMonthTrend(typeTrends) {
            if (!typeTrends || typeTrends.length === 0) return null;
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1; // getMonth() returns 0-11
            
            // Ищем тренд за текущий месяц и год
            const currentTrend = typeTrends.find(trend => {
                return trend.property_year === currentYear && trend.property_month === currentMonth;
            });
            
            // Если не нашли за текущий месяц, ищем за последний доступный месяц текущего года
            if (!currentTrend) {
                const currentYearTrends = typeTrends.filter(trend => trend.property_year === currentYear);
                if (currentYearTrends.length > 0) {
                    // Сортируем по месяцу и берем последний
                    currentYearTrends.sort((a, b) => b.property_month - a.property_month);
                    return currentYearTrends[0];
                }
            }
            
            // Если не нашли за текущий год, возвращаем последний доступный тренд
            return currentTrend || typeTrends[0];
        }

        // Format date for current month trends
        function formatCurrentMonthDate(trend) {
            if (trend.property_year && trend.property_month) {
                const monthNames = {
                    1: 'январь', 2: 'февраль', 3: 'март', 4: 'апрель', 5: 'май', 6: 'июнь',
                    7: 'июль', 8: 'август', 9: 'сентябрь', 10: 'октябрь', 11: 'ноябрь', 12: 'декабрь'
                };
                const monthName = monthNames[trend.property_month] || trend.property_month;
                return `${monthName} ${trend.property_year}`;
            }
            // Fallback to regular date formatting
            return formatTrendDate(trend.date);
        }

        // Add property trends section to the page
        async function addPropertyTrendsSection(trends) {
            console.log('📊 Adding property trends section with trends:', trends.length, 'records');
            console.log('🔍 First trend record:', trends[0]);
            
            // Проверяем, не существует ли уже секция трендов
            if (document.getElementById('propertyTrendsSection')) {
                console.log('⚠️ Property trends section already exists, skipping...');
                return;
            }
            
            const summarySection = document.getElementById('summaryDataSection');
            if (!summarySection) return;
            
            // Create property trends section
            const trendsSection = document.createElement('div');
            trendsSection.className = 'data-section';
            trendsSection.id = 'propertyTrendsSection';
            
            // Группируем тренды по типам
            const groupedTrends = groupTrendsByType(trends);
            
            trendsSection.innerHTML = `
                <h3 class="data-section-title">${getText('marketTrendsTitle')}</h3>
                <div class="data-section-content">
                    <div class="trends-grid">
                        ${Object.entries(groupedTrends).map(([type, typeTrends]) => {
                            // Найти тренд за текущий месяц и год
                            const currentTrend = findCurrentMonthTrend(typeTrends);
                            if (!currentTrend) return '';
                            
                            return `
                                <div class="trend-card trend-card-${type}">
                                    <div class="trend-title">${formatTrendType(type)}</div>
                                    <div class="trend-value">${formatTrendValue(currentTrend.trend_value, type)}</div>
                                    <div class="trend-details">
                                        <div class="trend-change">
                                            ${currentTrend.price_change_sale ? `Продажа: ${formatPercentage(currentTrend.price_change_sale)}` : ''}
                                            ${currentTrend.price_change_rent ? `Аренда: ${formatPercentage(currentTrend.price_change_rent)}` : ''}
                                        </div>
                                        <div class="trend-date">${formatCurrentMonthDate(currentTrend)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Таблица со всеми записями трендов -->
                    <div class="trends-table-section">
                        <h4 class="trends-table-title">Детальные данные трендов</h4>
                        <div class="trends-table-container" id="trendsTableContainer">
                            <!-- Тренды будут загружены асинхронно -->
                        </div>
                    </div>
                </div>
            `;
            
            // Insert after summary section
            summarySection.parentNode.insertBefore(trendsSection, summarySection.nextSibling);
            
            // Асинхронно загружаем таблицу трендов
            const trendsTableContainer = document.getElementById('trendsTableContainer');
            if (trendsTableContainer) {
                const trendsTableHtml = await generateTrendsTable(trends);
                trendsTableContainer.innerHTML = trendsTableHtml;
            }
        }
        
        // Group trends by type for better display
        function groupTrendsByType(trends) {
            const grouped = {};
            trends.forEach(trend => {
                const key = trend.trend_type || 'general';
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(trend);
            });
            return grouped;
        }
        
        // Format trend type for display
        function formatTrendType(type) {
            const typeMap = {
                'price_trend': 'Тренд цен',
                'yield_trend': 'Тренд доходности',
                'count_trend': 'Тренд количества',
                'general': 'Общий тренд'
            };
            return typeMap[type] || type;
        }
        
        // Format percentage values
        function formatPercentage(value) {
            if (value === null || value === undefined) return '-';
            const numValue = parseFloat(value);
            if (isNaN(numValue)) return '-';
            const sign = numValue >= 0 ? '+' : '';
            return `${sign}${(numValue * 100).toFixed(2)}%`;
        }
        
        // Format trend date
        function formatTrendDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ru-RU', { 
                    year: 'numeric', 
                    month: 'short' 
                });
            } catch (e) {
                return dateStr;
            }
        }
        
        // Format trend date without "г." for shorter display
        function formatTrendDateShort(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                const monthNames = [
                    'янв', 'фев', 'мар', 'апр', 'май', 'июн',
                    'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'
                ];
                
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                
                return `${month}. ${year}`;
            } catch (e) {
                return dateStr;
            }
        }

                // Filter trends to show 6 months before current month and 1 month after
        function filterTrendsByDateRange(trends) {
            if (!trends || trends.length === 0) return [];
            
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1; // getMonth() returns 0-11
            
            console.log(`🔍 Filtering trends: current date = ${currentYear}-${currentMonth}`);
            console.log(`🔍 Total trends = ${trends.length}`);
            
            // Сортируем тренды по property_year и property_month (новые сначала)
            const sortedTrends = trends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return b.property_year - a.property_year;
                }
                return b.property_month - a.property_month;
            });
            
            console.log(`🔍 Sorted trends by property_year/property_month (newest first):`);
            sortedTrends.forEach((trend, index) => {
                console.log(`  ${index}: ${trend.property_year}-${trend.property_month} (${trend.date})`);
            });
            
            // Фильтруем тренды за текущий год (2025)
            const currentYearTrends = sortedTrends.filter(trend => trend.property_year === currentYear);
            console.log(`🔍 Current year trends: ${currentYearTrends.length}`);
            
            if (currentYearTrends.length === 0) {
                console.log(`⚠️ No trends for current year ${currentYear}, returning first 8 from all`);
                return sortedTrends.slice(0, 8);
            }
            
            // Вычисляем диапазон месяцев: 6 месяцев назад от текущего + 1 месяц вперед
            const startMonth = currentMonth - 6;
            const endMonth = currentMonth + 1;
            
            console.log(`🔍 Target month range: ${startMonth} to ${endMonth}`);
            
            // Фильтруем тренды по диапазону месяцев
            const filteredTrends = currentYearTrends.filter(trend => {
                const month = trend.property_month;
                
                // Обрабатываем переход через год (например, если текущий месяц август, то февраль = -4)
                if (startMonth <= 0) {
                    // Если startMonth отрицательный, берем месяцы с конца предыдущего года
                    return month >= (12 + startMonth) || month <= endMonth;
                } else {
                    // Обычный случай
                    return month >= startMonth && month <= endMonth;
                }
            });
            
            console.log(`🔍 Filtered trends by month range: ${filteredTrends.length}`);
            
            // Сортируем по месяцу (будущие месяцы сверху, текущий в середине, прошедшие снизу)
            filteredTrends.sort((a, b) => {
                const monthA = a.property_month;
                const monthB = b.property_month;
                
                // Если оба месяца в будущем (больше текущего)
                if (monthA > currentMonth && monthB > currentMonth) {
                    return monthA - monthB; // По возрастанию (сентябрь перед октябрем)
                }
                // Если оба месяца в прошлом (меньше текущего)
                else if (monthA < currentMonth && monthB < currentMonth) {
                    return monthB - monthA; // По убыванию (июль перед июнем)
                }
                // Если один в будущем, а другой - текущий
                else if (monthA > currentMonth && monthB === currentMonth) {
                    return -1; // Будущий месяц идет перед текущим
                }
                else if (monthA === currentMonth && monthB > currentMonth) {
                    return 1; // Текущий месяц идет после будущего
                }
                // Если один в будущем, а другой в прошлом
                else if (monthA > currentMonth && monthB < currentMonth) {
                    return -1; // Будущий месяц идет первым
                }
                else if (monthA < currentMonth && monthB > currentMonth) {
                    return 1; // Прошедший месяц идет последним
                }
                // Если один из месяцев - текущий, а другой в прошлом
                else if (monthA === currentMonth && monthB < currentMonth) {
                    return -1; // Текущий месяц идет перед прошедшим
                }
                else if (monthA < currentMonth && monthB === currentMonth) {
                    return 1; // Прошедший месяц идет после текущего
                }
                
                return 0;
            });
            
            if (filteredTrends.length >= 8) {
                // Берем первые 8 трендов из отфильтрованного диапазона
                const selectedTrends = filteredTrends.slice(0, 8);
                console.log(`✅ Selected ${selectedTrends.length} trends from month range`);
                return selectedTrends;
            } else {
                // Если мало трендов в диапазоне, возвращаем все отфильтрованные
                console.log(`⚠️ Few trends in month range, returning all ${filteredTrends.length}`);
                return filteredTrends;
            }
        }

        // Generate detailed trends table
        async function generateTrendsTable(trends) {
            console.log('📊 Generating trends table with trends:', trends.length, 'records');
            
            if (!trends || trends.length === 0) {
                console.log('⚠️ No trends data for trends table');
                return '<div class="no-data">Нет данных для отображения</div>';
            }
            
            // Фильтруем тренды по диапазону дат
            const filteredTrends = filterTrendsByDateRange(trends);
            console.log('🔍 Filtered trends for table:', filteredTrends.length, 'records');
            
            if (filteredTrends.length === 0) {
                console.log('⚠️ No trends in date range for trends table');
                return '<div class="no-data">Нет данных для отображения в выбранном диапазоне</div>';
            }
            
            let html = '<table class="trends-table">';
            html += '<thead><tr>';
            html += '<th>Дата</th>';
            html += '<th>Продажа<br>(₺/м²)</th>';
            html += '<th>Изм-ие цены<br>продажи</th>';
            html += '<th>Аренда<br>(₺/м²)</th>';
            html += '<th>Изм-ие цены<br>аренды</th>';
            html += '<th>Доходность</th>';
            html += '</tr></thead><tbody>';
            
            // Добавляем информацию о фильтрации
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            html += `<tr class="filter-info"><td colspan="6" style="text-align: center; font-size: 11px; color: #666; background: #f8f9fa; padding: 4px;">
                Показано ${filteredTrends.length} из ${trends.length} трендов
            </td></tr>`;
            
            filteredTrends.forEach((trend, index) => {
                // Проверяем, является ли этот тренд текущим месяцем
                const isCurrentMonth = trend.property_year === currentYear && trend.property_month === currentMonth;
                const isFutureMonth = trend.property_year > currentYear || (trend.property_year === currentYear && trend.property_month > currentMonth);
                
                let rowClass = '';
                let rowStyle = '';
                
                if (isCurrentMonth) {
                    rowClass = 'current-month-row';
                    rowStyle = 'background-color: #e8f4fd;';
                } else if (isFutureMonth) {
                    rowClass = 'forecast-row';
                    rowStyle = 'background-color: #f0f8ff;';
                }
                
                html += `<tr class="${rowClass}" style="${rowStyle}">`;
                html += `<td>${formatTrendDateShort(trend.date)}</td>`;
                html += `<td>${formatTrendValue(trend.unit_price_for_sale, 'price')}</td>`;
                html += `<td>${formatPercentage(trend.price_change_sale)}</td>`;
                html += `<td>${formatTrendValue(trend.unit_price_for_rent, 'price')}</td>`;
                html += `<td>${formatPercentage(trend.price_change_rent)}</td>`;
                html += `<td>${formatTrendValue(trend.yield, 'percentage')}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // Добавляем блок "Вывод по тренду"
            html += await generateTrendsAnalysis(trends);
            
            return html;
        }
        
        // Generate trends analysis based on table data
        async function generateTrendsAnalysis(trends) {
            console.log('📊 Generating trends analysis with trends:', trends.length, 'records');
            
            if (!trends || trends.length === 0) {
                console.log('⚠️ No trends data for trends analysis');
                return '';
            }
            
            // Сортируем тренды по дате для правильного анализа
            const sortedTrends = trends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return a.property_year - b.property_year;
                }
                return a.property_month - b.property_month;
            });
            
            console.log('🔍 Sorted trends for analysis:', sortedTrends.length, 'records');
            
            // Находим первый и последний месяц для анализа
            const firstMonth = sortedTrends[0];
            const lastMonth = sortedTrends[sortedTrends.length - 1];
            
            if (!firstMonth || !lastMonth) {
                return '';
            }
            
            // Рассчитываем общий рост цен на продажу
            const firstSalePrice = parseFloat(firstMonth.unit_price_for_sale) || 0;
            const lastSalePrice = parseFloat(lastMonth.unit_price_for_sale) || 0;
            const salePriceGrowth = firstSalePrice > 0 ? ((lastSalePrice - firstSalePrice) / firstSalePrice * 100) : 0;
            
            // Рассчитываем общий рост цен на аренду
            const firstRentPrice = parseFloat(firstMonth.unit_price_for_rent) || 0;
            const lastRentPrice = parseFloat(lastMonth.unit_price_for_rent) || 0;
            const rentPriceGrowth = firstRentPrice > 0 ? ((lastRentPrice - firstRentPrice) / firstRentPrice * 100) : 0;
            
            // Анализируем диапазон доходности
            const yields = trends.map(t => parseFloat(t.yield) || 0).filter(y => y > 0);
            const minYield = yields.length > 0 ? Math.min(...yields) : 0;
            const maxYield = yields.length > 0 ? Math.max(...yields) : 0;
            
            // Определяем тренд доходности (растет, падает или стабилен)
            let yieldTrend = '';
            if (yields.length >= 2) {
                const firstYield = yields[0];
                const lastYield = yields[yields.length - 1];
                const yieldChange = lastYield - firstYield;
                
                if (Math.abs(yieldChange) < 0.5) {
                    yieldTrend = 'стабильна';
                } else if (yieldChange > 0.5) {
                    yieldTrend = 'растет';
                } else {
                    yieldTrend = 'снижается';
                }
            }
            
            // Форматируем названия месяцев
            const monthNames = [
                'январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
                'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'
            ];
            
            const firstMonthName = monthNames[firstMonth.property_month - 1] || '';
            const lastMonthName = monthNames[lastMonth.property_month - 1] || '';
            
            // Формируем аналитический вывод
            let analysis = '<div class="trends-analysis-section">';
            analysis += '<h4 class="trends-analysis-title">Вывод по тренду</h4>';
            analysis += '<div class="trends-analysis-content">';
            
            if (salePriceGrowth > 0 && rentPriceGrowth > 0) {
                analysis += `Рынок недвижимости демонстрирует устойчивый рост как в продажах, так и в аренде. `;
                analysis += `С ${firstMonthName} по ${lastMonthName} ${firstMonth.property_year} года `;
                analysis += `цены на продажу выросли примерно на ${salePriceGrowth.toFixed(1)}%, `;
                analysis += `аренда — на ${rentPriceGrowth.toFixed(1)}%. `;
                analysis += `Доходность держится в диапазоне ${minYield.toFixed(1)}–${maxYield.toFixed(1)}%, `;
                analysis += `показывая привлекательность инвестиций. `;
                
                if (yieldTrend) {
                    analysis += `Текущий тренд указывает на ${yieldTrend === 'стабильна' ? 'стабильность' : yieldTrend === 'растет' ? 'постепенное увеличение' : 'постепенное снижение'} `;
                    analysis += `доходности, но сохраняется положительная динамика.`;
                } else {
                    analysis += `Текущий тренд указывает на постепенное замедление роста цен и доходности, но сохраняется положительная динамика.`;
                }
            } else if (salePriceGrowth > 0 || rentPriceGrowth > 0) {
                analysis += `Рынок недвижимости показывает смешанную динамику. `;
                if (salePriceGrowth > 0) {
                    analysis += `Цены на продажу выросли на ${salePriceGrowth.toFixed(1)}%, `;
                }
                if (rentPriceGrowth > 0) {
                    analysis += `аренда выросла на ${rentPriceGrowth.toFixed(1)}%. `;
                }
                analysis += `Доходность в диапазоне ${minYield.toFixed(1)}–${maxYield.toFixed(1)}% `;
                analysis += `сохраняет привлекательность для инвесторов.`;
            } else {
                analysis += `Рынок недвижимости демонстрирует стабильность. `;
                analysis += `Доходность в диапазоне ${minYield.toFixed(1)}–${maxYield.toFixed(1)}% `;
                analysis += `показывает устойчивость инвестиционного потенциала.`;
            }
            
            analysis += '</div></div>';
            
            // Добавляем блок "Вывод по объекту"
            analysis += await generateObjectSummary();
            
            // Добавляем таблицу "Прогноз цены и аренды"
            analysis += await generateForecastTable(trends);
            
            return analysis;
        }
        
        // Get exchange rate from currency table or API
        async function getExchangeRate(fromCurrency, toCurrency) {
            try {
                // Сначала пытаемся получить курс из таблицы currency на текущую дату
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                const response = await fetch('/api/currency/rate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        from_currency: fromCurrency,
                        to_currency: toCurrency,
                        date: today
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.rate) {
                        console.log(`✅ Exchange rate from DB: ${fromCurrency} to ${toCurrency} = ${data.rate}`);
                        return data.rate;
                    }
                }
                
                // Если курс не найден в БД, получаем его через API
                console.log(`🔄 Getting exchange rate from API: ${fromCurrency} to ${toCurrency}`);
                const apiResponse = await fetch('/api/currency/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        from_currency: fromCurrency,
                        to_currency: toCurrency
                    })
                });
                
                if (apiResponse.ok) {
                    const apiData = await apiResponse.json();
                    if (apiData.success && apiData.rate) {
                        console.log(`✅ Exchange rate from API: ${fromCurrency} to ${toCurrency} = ${apiData.rate}`);
                        return apiData.rate;
                    }
                }
                
                console.log(`⚠️ Failed to get exchange rate for ${fromCurrency} to ${toCurrency}`);
                return 1; // Возвращаем 1 как fallback
                
            } catch (error) {
                console.error('Error getting exchange rate:', error);
                return 1; // Возвращаем 1 как fallback
            }
        }

        // Generate object summary block
        async function generateObjectSummary() {
            try {
                // Получаем данные объекта из формы
                const objectPrice = parseFloat(document.getElementById('priceObjectInput')?.value) || 0;
                const objectArea = parseFloat(document.getElementById('objectArea')?.value) || 0;
                const selectedCountry = selectedLocation.country_name || '';
                const objectCurrency = selectedListingTypes.currency || 'EUR';
                
                if (!objectPrice || !objectArea || !selectedCountry) {
                    return '';
                }
                
                // Рассчитываем цену за м²
                const pricePerM2 = objectPrice / objectArea;
                
                // Определяем валюту объекта из формы
                
                // Получаем курс валюты
                let exchangeRate = 1; // По умолчанию 1 (если валюта уже в нужной)
                let targetCurrency = '';
                
                if (selectedCountry.toLowerCase().includes('türkiye') || selectedCountry.toLowerCase().includes('turkey')) {
                    targetCurrency = 'TRY'; // Турецкая лира
                } else {
                    targetCurrency = 'EUR'; // Евро для других стран
                }
                
                if (objectCurrency !== targetCurrency) {
                    // Получаем курс валюты
                    exchangeRate = await getExchangeRate(objectCurrency, targetCurrency);
                }
                
                // Конвертируем цену
                const convertedPricePerM2 = pricePerM2 * exchangeRate;
                
                // Форматируем валюту для отображения
                const currencySymbol = targetCurrency === 'TRY' ? '₺' : '€';
                
                let html = '<div class="object-summary-section">';
                html += `<h4 class="object-summary-title">${getText('objectSummaryTitle')}</h4>`;
                html += '<div class="object-summary-content">';
                html += `<p>${getText('objectPricePerM2Label')} <strong>${currencySymbol}${convertedPricePerM2.toFixed(2)}</strong></p>`;
                html += `<p>${getText('objectCurrencyLabel')} <strong>${objectCurrency}</strong></p>`;
                html += `<p>${getText('objectAreaLabel')} <strong>${objectArea} м²</strong></p>`;
                
                if (objectCurrency !== targetCurrency) {
                    html += `<p>${getText('exchangeRateLabel')} <strong>1 ${objectCurrency} = ${exchangeRate.toFixed(4)} ${targetCurrency}</strong></p>`;
                }
                
                html += '</div></div>';
                
                return html;
            } catch (error) {
                console.error('Error generating object summary:', error);
                return '';
            }
        }

        // Generate forecast table for current and future months
        async function generateForecastTable(trends) {
            if (!trends || trends.length === 0) {
                console.log('⚠️ No trends data for forecast table');
                return '';
            }
            
            console.log('📊 Generating forecast table with trends:', trends.length, 'records');
            
            // Проверяем доступ пользователя к премиум функциям
            const userAccess = await checkUserAccess();
            console.log('🔍 User access check for forecast:', userAccess);
            
            if (!userAccess.hasAccess) {
                console.log('⚠️ User does not have access to forecast features');
                return generateSubscriptionMessage();
            }
            
            // Получаем текущую дату
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1; // getMonth() returns 0-11
            
            console.log('📅 Current date:', currentYear, currentMonth);
            
            // Фильтруем тренды: текущий месяц и все последующие
            const forecastTrends = trends.filter(trend => {
                if (trend.property_year > currentYear) {
                    return true; // Будущие годы
                } else if (trend.property_year === currentYear) {
                    return trend.property_month >= currentMonth; // Текущий месяц и будущие
                }
                return false;
            });
            
            console.log('🔮 Filtered forecast trends:', forecastTrends.length, 'records');
            
            if (forecastTrends.length === 0) {
                return '';
            }
            
            // Сортируем по дате (от текущего к будущему)
            forecastTrends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return a.property_year - b.property_year;
                }
                return a.property_month - b.property_month;
            });
            
            // Формируем таблицу прогноза
            let forecastHtml = '<div class="forecast-table-section">';
            forecastHtml += '<h4 class="forecast-table-title">Прогноз цены и аренды</h4>';
            forecastHtml += '<div class="forecast-table-container">';
            forecastHtml += '<table class="forecast-table">';
            forecastHtml += '<thead><tr>';
            forecastHtml += '<th>Дата</th>';
            forecastHtml += '<th>Прогноз продажи<br>(₺/м²)</th>';
            forecastHtml += '<th>Прогноз аренды<br>(₺/м²)</th>';
            forecastHtml += '<th>Прогноз доходности</th>';
            forecastHtml += '</tr></thead><tbody>';
            
            // Добавляем информацию о прогнозе
            forecastHtml += `<tr class="forecast-info"><td colspan="4" style="text-align: center; font-size: 11px; color: #666; background: #f8f9fa; padding: 4px;">
                Прогноз на основе ${forecastTrends.length} месяцев (текущий и будущие)
            </td></tr>`;
            
            forecastTrends.forEach((trend, index) => {
                const isCurrentMonth = trend.property_year === currentYear && trend.property_month === currentMonth;
                const rowClass = isCurrentMonth ? 'current-month-row' : 'forecast-row';
                const rowStyle = isCurrentMonth ? 'background-color: #e8f4fd;' : '';
                
                forecastHtml += `<tr class="${rowClass}" style="${rowStyle}">`;
                forecastHtml += `<td>${formatTrendDateShort(trend.date)}</td>`;
                forecastHtml += `<td>${formatTrendValue(trend.unit_price_for_sale, 'price')}</td>`;
                forecastHtml += `<td>${formatTrendValue(trend.unit_price_for_rent, 'price')}</td>`;
                forecastHtml += `<td>${formatTrendValue(trend.yield, 'percentage')}</td>`;
                forecastHtml += '</tr>';
            });
            
            forecastHtml += '</tbody></table>';
            forecastHtml += '</div></div>';
            
            // Добавляем блок "Вывод прогноза"
            forecastHtml += await generateForecastAnalysis(forecastTrends);
            
            return forecastHtml;
        }
        
        // Generate forecast analysis based on forecast table data
        async function generateForecastAnalysis(forecastTrends) {
            if (!forecastTrends || forecastTrends.length === 0) {
                return '';
            }
            
            // Проверяем доступ пользователя к премиум функциям
            const userAccess = await checkUserAccess();
            console.log('🔍 User access check for forecast analysis:', userAccess);
            
            if (!userAccess.hasAccess) {
                console.log('⚠️ User does not have access to forecast analysis features');
                return generateSubscriptionMessage();
            }
            
            // Сортируем тренды по дате для правильного анализа
            const sortedTrends = forecastTrends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return a.property_year - b.property_year;
                }
                return a.property_month - b.property_month;
            });
            
            // Находим первый и последний месяц для анализа
            const firstMonth = sortedTrends[0];
            const lastMonth = sortedTrends[sortedTrends.length - 1];
            
            if (!firstMonth || !lastMonth) {
                return '';
            }
            
            // Рассчитываем рост цен на продажу
            const firstSalePrice = parseFloat(firstMonth.unit_price_for_sale) || 0;
            const lastSalePrice = parseFloat(lastMonth.unit_price_for_sale) || 0;
            const salePriceGrowth = firstSalePrice > 0 ? ((lastSalePrice - firstSalePrice) / firstSalePrice * 100) : 0;
            
            // Рассчитываем рост цен на аренду
            const firstRentPrice = parseFloat(firstMonth.unit_price_for_rent) || 0;
            const lastRentPrice = parseFloat(lastMonth.unit_price_for_rent) || 0;
            const rentPriceGrowth = firstRentPrice > 0 ? ((lastRentPrice - firstRentPrice) / firstRentPrice * 100) : 0;
            
            // Анализируем диапазон доходности
            const yields = forecastTrends.map(t => parseFloat(t.yield) || 0).filter(y => y > 0);
            const minYield = yields.length > 0 ? Math.min(...yields) : 0;
            const maxYield = yields.length > 0 ? Math.max(...yields) : 0;
            
            // Определяем тренд доходности
            let yieldTrend = '';
            if (yields.length >= 2) {
                const firstYield = yields[0];
                const lastYield = yields[yields.length - 1];
                const yieldChange = lastYield - firstYield;
                
                if (Math.abs(yieldChange) < 0.5) {
                    yieldTrend = 'стабильность';
                } else if (yieldChange > 0.5) {
                    yieldTrend = 'рост';
                } else {
                    yieldTrend = 'снижение';
                }
            }
            
            // Форматируем названия месяцев
            const monthNames = {
                'ru': ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
                       'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'],
                'en': ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'],
                'de': ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
                       'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'],
                'fr': ['janvier', 'février', 'mars', 'avril', 'mai', 'juin',
                       'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'],
                'tr': ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                       'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık']
            };
            
            const firstMonthName = monthNames[userLanguage] ? monthNames[userLanguage][firstMonth.property_month - 1] : monthNames['ru'][firstMonth.property_month - 1];
            const lastMonthName = monthNames[userLanguage] ? monthNames[userLanguage][lastMonth.property_month - 1] : monthNames['ru'][lastMonth.property_month - 1];
            
            // Формируем аналитический вывод на разных языках
            const analysisTexts = {
                'ru': {
                    'title': 'Вывод прогноза',
                    'sale': `Продажа: ожидается стабильный рост цен с ${formatValue(firstSalePrice, 'price')}/м² в ${firstMonthName} ${firstMonth.property_year} до ${formatValue(lastSalePrice, 'price')}/м² в ${lastMonthName} ${lastMonth.property_year} (+${salePriceGrowth.toFixed(1)}% за ${forecastTrends.length} месяцев).`,
                    'rent': `Аренда: прогнозируется увеличение с ${formatValue(firstRentPrice, 'price')}/м² до ${formatValue(lastRentPrice, 'price')}/м² (+${rentPriceGrowth.toFixed(1)}%).`,
                    'yield': `Доходность: остаётся на уровне ${minYield.toFixed(1)}–${maxYield.toFixed(1)}%, с лёгким ${yieldTrend === 'снижение' ? 'снижением' : yieldTrend === 'рост' ? 'ростом' : 'изменением'} к ${lastMonthName} ${lastMonth.property_year} года.`
                },
                'en': {
                    'title': 'Forecast Analysis',
                    'sale': `Sales: stable price growth is expected from ${formatValue(firstSalePrice, 'price')}/m² in ${firstMonthName} ${firstMonth.property_year} to ${formatValue(lastSalePrice, 'price')}/m² in ${lastMonthName} ${lastMonth.property_year} (+${salePriceGrowth.toFixed(1)}% over ${forecastTrends.length} months).`,
                    'rent': `Rent: increase is forecasted from ${formatValue(firstRentPrice, 'price')}/m² to ${formatValue(lastRentPrice, 'price')}/m² (+${rentPriceGrowth.toFixed(1)}%).`,
                    'yield': `Yield: remains at ${minYield.toFixed(1)}–${maxYield.toFixed(1)}%, with a slight ${yieldTrend === 'снижение' ? 'decrease' : yieldTrend === 'рост' ? 'increase' : 'change'} by ${lastMonthName} ${lastMonth.property_year}.`
                },
                'de': {
                    'title': 'Prognose-Analyse',
                    'sale': `Verkauf: Stabile Preiserhöhung wird erwartet von ${formatValue(firstSalePrice, 'price')}/m² im ${firstMonthName} ${firstMonth.property_year} bis ${formatValue(lastSalePrice, 'price')}/m² im ${lastMonthName} ${lastMonth.property_year} (+${salePriceGrowth.toFixed(1)}% über ${forecastTrends.length} Monate).`,
                    'rent': `Miete: Anstieg wird prognostiziert von ${formatValue(firstRentPrice, 'price')}/m² auf ${formatValue(lastRentPrice, 'price')}/m² (+${rentPriceGrowth.toFixed(1)}%).`,
                    'yield': `Rendite: bleibt bei ${minYield.toFixed(1)}–${maxYield.toFixed(1)}%, mit leichter ${yieldTrend === 'снижение' ? 'Abnahme' : yieldTrend === 'рост' ? 'Zunahme' : 'Änderung'} bis ${lastMonthName} ${lastMonth.property_year}.`
                },
                'fr': {
                    'title': 'Analyse des prévisions',
                    'sale': `Vente: une croissance stable des prix est attendue de ${formatValue(firstSalePrice, 'price')}/m² en ${firstMonthName} ${firstMonth.property_year} à ${formatValue(lastSalePrice, 'price')}/m² en ${lastMonthName} ${lastMonth.property_year} (+${salePriceGrowth.toFixed(1)}% sur ${forecastTrends.length} mois).`,
                    'rent': `Location: une augmentation est prévue de ${formatValue(firstRentPrice, 'price')}/m² à ${formatValue(lastRentPrice, 'price')}/m² (+${rentPriceGrowth.toFixed(1)}%).`,
                    'yield': `Rendement: reste à ${minYield.toFixed(1)}–${maxYield.toFixed(1)}%, avec une légère ${yieldTrend === 'снижение' ? 'diminution' : yieldTrend === 'рост' ? 'augmentation' : 'variation'} d'ici ${lastMonthName} ${lastMonth.property_year}.`
                },
                'tr': {
                    'title': 'Tahmin Analizi',
                    'sale': `Satış: ${firstMonthName} ${firstMonth.property_year}'de ${formatValue(firstSalePrice, 'price')}/m²'den ${lastMonthName} ${lastMonth.property_year}'de ${formatValue(lastSalePrice, 'price')}/m²'ye kararlı fiyat artışı bekleniyor (+${salePriceGrowth.toFixed(1)}% ${forecastTrends.length} ay boyunca).`,
                    'rent': `Kiralama: ${formatValue(firstRentPrice, 'price')}/m²'den ${formatValue(lastRentPrice, 'price')}/m²'ye artış öngörülüyor (+${rentPriceGrowth.toFixed(1)}%).`,
                    'yield': `Getiri: ${minYield.toFixed(1)}–${maxYield.toFixed(1)}% seviyesinde kalıyor, ${lastMonthName} ${lastMonth.property_year}'ye kadar hafif ${yieldTrend === 'снижение' ? 'azalma' : yieldTrend === 'рост' ? 'artış' : 'değişim'} ile.`
                }
            };
            
            // Получаем текст для текущего языка
            const currentLanguage = userLanguage || 'ru';
            const texts = analysisTexts[currentLanguage] || analysisTexts['ru'];
            
            // Формируем HTML для блока анализа прогноза
            let analysisHtml = '<div class="forecast-analysis-section">';
            analysisHtml += `<h4 class="forecast-analysis-title">${texts.title}</h4>`;
            analysisHtml += '<div class="forecast-analysis-content">';
            analysisHtml += `<p><strong>${texts.sale.split(':')[0]}:</strong> ${texts.sale.split(':')[1]}</p>`;
            analysisHtml += `<p><strong>${texts.rent.split(':')[0]}:</strong> ${texts.rent.split(':')[1]}</p>`;
            analysisHtml += `<p><strong>${texts.yield.split(':')[0]}:</strong> ${texts.yield.split(':')[1]}</p>`;
            analysisHtml += '</div></div>';
            
            // Добавляем блок "Прогноз цен"
            analysisHtml += await generatePriceForecastBlock(forecastTrends);
            
            return analysisHtml;
        }
        
        // Generate price forecast block for user's property
        async function generatePriceForecastBlock(forecastTrends) {
            if (!forecastTrends || forecastTrends.length === 0) {
                return '';
            }
            
            // Проверяем доступ пользователя к премиум функциям
            const userAccess = await checkUserAccess();
            console.log('🔍 User access check for price forecast:', userAccess);
            
            if (!userAccess.hasAccess) {
                console.log('⚠️ User does not have access to price forecast features');
                return generateSubscriptionMessage();
            }
            
            // Получаем данные пользователя
            const userPrice = selectedListingTypes.price || 0;
            const userArea = selectedListingTypes.area || 0;
            const userCurrency = selectedListingTypes.currency || 'EUR';
            
            if (!userPrice || !userArea) {
                return '';
            }
            
            // Сортируем тренды по дате для правильного анализа
            const sortedTrends = forecastTrends.sort((a, b) => {
                if (a.property_year !== b.property_year) {
                    return a.property_year - b.property_year;
                }
                return a.property_month - b.property_month;
            });
            
            // Находим текущий месяц (первый в отсортированном списке) и последний месяц
            const currentMonthTrend = sortedTrends[0];
            const lastMonthTrend = sortedTrends[sortedTrends.length - 1];
            
            if (!currentMonthTrend || !lastMonthTrend) {
                return '';
            }
            
            // Получаем текущую дату для определения текущего месяца
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            // Проверяем, является ли первый тренд текущим месяцем
            const isFirstTrendCurrentMonth = currentMonthTrend.property_year === currentYear && currentMonthTrend.property_month === currentMonth;
            
            // Определяем тренды для расчетов
            const baseTrend = isFirstTrendCurrentMonth ? currentMonthTrend : sortedTrends.find(t => t.property_year === currentYear && t.property_month === currentMonth) || currentMonthTrend;
            const futureTrend = lastMonthTrend;
            
            if (!baseTrend || !futureTrend) {
                return '';
            }
            
            // Рассчитываем прогнозную цену продажи для объекта пользователя
            // Цена продажи = площадь объекта × прогноз цены продажи последнего месяца
            const futureSalePricePerM2 = parseFloat(futureTrend.unit_price_for_sale) || 0;
            const forecastSalePrice = userArea * futureSalePricePerM2;
            
            // Рассчитываем прогнозную ставку аренды
            // Ставка аренды = площадь объекта × прогноз аренды последнего месяца
            const futureRentPricePerM2 = parseFloat(futureTrend.unit_price_for_rent) || 0;
            const forecastRentPriceInTRY = userArea * futureRentPricePerM2; // В лирах
            
            // Получаем актуальный курс валют из таблицы currency
            let tryToEurRate = 1; // По умолчанию 1:1
            try {
                // Получаем курс TRY к EUR из таблицы currency
                const currencyResponse = await fetch('/api/currency/latest', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (currencyResponse.ok) {
                    const currencyData = await currencyResponse.json();
                    if (currencyData.success && currencyData.data) {
                        // В таблице currency базовая валюта - EUR, курс TRY хранится в поле try
                        // Курс TRY к EUR = 1 / try (так как try показывает сколько TRY за 1 EUR)
                        tryToEurRate = 1 / parseFloat(currencyData.data.try || 1);
                    }
                }
            } catch (error) {
                console.log('⚠️ Не удалось получить курс валют, используем примерные значения');
                // Используем примерный курс TRY к EUR как fallback
                tryToEurRate = 0.03; // Примерно 1 TRY = 0.03 EUR
            }
            
            // Конвертируем ставку аренды из лир в евро
            const forecastRentPriceInEUR = forecastRentPriceInTRY * tryToEurRate;
            
            // Форматируем названия месяцев
            const monthNames = {
                'ru': ['январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
                       'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'],
                'en': ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'],
                'de': ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni',
                       'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'],
                'fr': ['janvier', 'février', 'mars', 'avril', 'mai', 'juin',
                       'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'],
                'tr': ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                       'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık']
            };
            
            const currentLanguage = userLanguage || 'ru';
            const monthNamesList = monthNames[currentLanguage] || monthNames['ru'];
            
            const futureMonthName = monthNamesList[futureTrend.property_month - 1] || '';
            
            // Формируем тексты на разных языках
            const forecastTexts = {
                'ru': {
                    'title': 'Прогноз цен',
                    'saleLabel': 'Цена продажи',
                    'rentLabel': 'Ставка аренды',
                    'date': `${futureMonthName} ${futureTrend.property_year}`,
                    'currencyInfo': `Курс: 1 TRY = €${tryToEurRate.toFixed(4)}`
                },
                'en': {
                    'title': 'Price Forecast',
                    'saleLabel': 'Sale Price',
                    'rentLabel': 'Rent Rate',
                    'date': `${futureMonthName} ${futureTrend.property_year}`,
                    'currencyInfo': `Rate: 1 TRY = €${tryToEurRate.toFixed(4)}`
                },
                'de': {
                    'title': 'Preisprognose',
                    'saleLabel': 'Verkaufspreis',
                    'rentLabel': 'Mietpreis',
                    'date': `${futureMonthName} ${futureTrend.property_year}`,
                    'currencyInfo': `Kurs: 1 TRY = €${tryToEurRate.toFixed(4)}`
                },
                'fr': {
                    'title': 'Prévision des prix',
                    'saleLabel': 'Prix de vente',
                    'rentLabel': 'Taux de location',
                    'date': `${futureMonthName} ${futureTrend.property_year}`,
                    'currencyInfo': `Taux: 1 TRY = €${tryToEurRate.toFixed(4)}`
                },
                'tr': {
                    'title': 'Fiyat Tahmini',
                    'saleLabel': 'Satış Fiyatı',
                    'rentLabel': 'Kiralama Oranı',
                    'date': `${futureMonthName} ${futureTrend.property_year}`,
                    'currencyInfo': `Kur: 1 TRY = €${tryToEurRate.toFixed(4)}`
                }
            };
            
            const texts = forecastTexts[currentLanguage] || forecastTexts['ru'];
            
            // Формируем HTML для блока прогноза цен
            let forecastHtml = '<div class="price-forecast-block">';
            forecastHtml += '<div class="price-forecast-content">';
            forecastHtml += `<h4 class="price-forecast-title">${texts.title}</h4>`;
            
            // Блок с ценой продажи
            forecastHtml += '<div class="price-forecast-sale-section">';
            forecastHtml += `<div class="price-forecast-sale-label">${texts.saleLabel}</div>`;
            forecastHtml += `<div class="price-forecast-sale-value">€${forecastSalePrice.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>`;
            forecastHtml += '</div>';
            
            // Блок со ставкой аренды
            forecastHtml += '<div class="price-forecast-rent-section">';
            forecastHtml += `<div class="price-forecast-rent-label">${texts.rentLabel}</div>`;
            forecastHtml += `<div class="price-forecast-rent-value">€${forecastRentPriceInEUR.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}/мес</div>`;
            forecastHtml += '</div>';
            
            // Дата прогноза и курс валют
            forecastHtml += `<div class="price-forecast-date">${texts.date}</div>`;
            forecastHtml += `<div class="price-forecast-currency-info">${texts.currencyInfo}</div>`;
            forecastHtml += '</div></div>';
            
            return forecastHtml;
        }
        
        // Format trend value based on type
        function formatTrendValue(value, type) {
            if (value === null || value === undefined) return '-';
            
            if (type && type.includes('price')) {
                return formatValue(value, 'price');
            } else if (type && type.includes('percentage')) {
                return formatValue(value, 'percentage');
            } else if (typeof value === 'number') {
                // Если это число, форматируем его
                if (value >= 1000) {
                    return value.toLocaleString('ru-RU');
                } else {
                    return value.toFixed(2);
                }
            } else {
                return value.toString();
            }
        }
        
        // Helper function to format values consistently
        function formatValue(value, type) {
            if (value === null || value === undefined) return '-';
            
            if (type === 'price') {
                if (typeof value === 'number') {
                    return `₺${value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
                return value.toString();
            } else if (type === 'percentage') {
                if (typeof value === 'number') {
                    return `${value.toFixed(2)}%`;
                }
                return value.toString();
            }
            
            return value.toString();
        }
        
        // Format trend period
        function formatTrendPeriod(period) {
            if (!period) return '';
            
            // Convert period to readable format
            const periodMap = {
                'monthly': 'Месячный',
                'quarterly': 'Квартальный',
                'yearly': 'Годовой',
                'weekly': 'Недельный'
            };
            
            return periodMap[period] || period;
        }

        // Get AI insights for the region data




        // Show error
        function showError(message) {
            const errorState = document.getElementById('errorState');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorState.style.display = 'block';
        }

        // Function to go to main menu
        function goToMainMenu() {
            window.location.href = '/webapp_main';
        }

        // Function to convert currency to EUR (base currency)
        async function convertToEUR(amount, fromCurrency) {
            if (fromCurrency === 'EUR') {
                return amount;
            }
            
            try {
                // Get current exchange rates from currency table
                const response = await fetch('/api/currency/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        from_currency: fromCurrency,
                        to_currency: 'EUR'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    return data.converted_amount;
                } else {
                    console.error('Currency conversion error:', data.error);
                    return amount; // Return original amount if conversion fails
                }
            } catch (error) {
                console.error('Error converting currency:', error);
                return amount; // Return original amount if conversion fails
            }
        }

        // Initialize page
        function init() {
            updatePageText();
            loadCountries();
            
            // Initialize price input
            const priceInput = document.getElementById('priceObjectInput');
            if (priceInput) {
                priceInput.addEventListener('input', function() {
                    selectedListingTypes.price = this.value ? parseFloat(this.value) : null;
                    updateConfirmButton();
                });
            }
            
            // Initialize area input
            const areaInput = document.getElementById('areaObjectInput');
            if (areaInput) {
                areaInput.addEventListener('input', function() {
                    selectedListingTypes.area = this.value ? parseInt(this.value) : null;
                    updateConfirmButton();
                });
            }
            
            // Initialize currency buttons
            const currencyButtons = document.querySelectorAll('.currency-button');
            currencyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const selectedCurrency = this.dataset.currency;
                    
                    // Remove active class from all buttons
                    currencyButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update selected currency
                    selectedListingTypes.currency = selectedCurrency;
                });
            });
            
            // Set EUR as default active currency
            const eurButton = document.querySelector('.currency-button[data-currency="EUR"]');
            if (eurButton) {
                eurButton.classList.add('active');
                selectedListingTypes.currency = 'EUR';
            }
        }

        // Start initialization when page loads
        document.addEventListener('DOMContentLoaded', init);

        // Generate consolidated assessment block with market analysis (только для админов)
        async function generateConsolidatedAssessment(data) {
            if (!data) return '';
            
            // Check if user is admin
            try {
                const userAccess = await checkUserAccess();
                if (!userAccess.hasAccess || userAccess.reason !== 'admin') {
                    // User is not admin, return message about restricted access
                    return '<div class="admin-restricted-message">' +
                           '<p>Блок "Анализ рынка" доступен только администраторам</p>' +
                           '</div>';
                }
            } catch (error) {
                console.error('Error checking user access:', error);
                // On error, show restricted message
                return '<div class="admin-restricted-message">' +
                       '<p>Ошибка проверки доступа</p>' +
                       '</div>';
            }
            
            // Define coefficients for each category
            const coefficients = {
                house_type: 0.40,      // 40% - спальни
                age: 0.30,             // 30% - возраст
                floor_segment: 0.20,   // 20% - этаж
                heating: 0.10          // 10% - отопление
            };
            
            // Extract data for each category
            const houseTypeData = data.house_type_data && data.house_type_data.length > 0 ? data.house_type_data[0] : null;
            const floorSegmentData = data.floor_segment_data && data.floor_segment_data.length > 0 ? data.floor_segment_data[0] : null;
            const ageData = data.age_data && data.age_data.length > 0 ? data.age_data[0] : null;
            const heatingData = data.heating_data && data.heating_data.length > 0 ? data.heating_data[0] : null;
            
            // Calculate consolidated values
            const salePrice = calculateConsolidatedValue([
                { value: houseTypeData?.unit_price_for_sale, coefficient: coefficients.house_type, name: 'Спальни' },
                { value: floorSegmentData?.unit_price_for_sale, coefficient: coefficients.floor_segment, name: 'Этаж' },
                { value: ageData?.unit_price_for_sale, coefficient: coefficients.age, name: 'Возраст' },
                { value: heatingData?.unit_price_for_sale, coefficient: coefficients.heating, name: 'Отопление' }
            ]);
            
            const rentPrice = calculateConsolidatedValue([
                { value: houseTypeData?.unit_price_for_rent, coefficient: coefficients.house_type, name: 'Спальни' },
                { value: floorSegmentData?.unit_price_for_rent, coefficient: coefficients.floor_segment, name: 'Этаж' },
                { value: ageData?.unit_price_for_rent, coefficient: coefficients.age, name: 'Возраст' },
                { value: heatingData?.unit_price_for_rent, coefficient: coefficients.heating, name: 'Отопление' }
            ]);
            
            const yield = calculateConsolidatedValue([
                { value: houseTypeData?.yield, coefficient: coefficients.house_type, name: 'Спальни' },
                { value: floorSegmentData?.yield, coefficient: coefficients.floor_segment, name: 'Этаж' },
                { value: ageData?.yield, coefficient: coefficients.age, name: 'Возраст' },
                { value: heatingData?.yield, coefficient: coefficients.heating, name: 'Отопление' }
            ]);
            
            // Generate HTML for consolidated assessment
            let html = '<div class="consolidated-assessment-section">';
            html += `<h4 class="consolidated-assessment-title">${getText('marketAnalysisTitle')}</h4>`;
            html += '<div class="consolidated-assessment-content">';
            
            // Sale Price Section
            html += '<div class="assessment-category">';
            html += `<h5 class="assessment-category-title">${getText('salePriceTitle')}</h5>`;
            html += '<div class="assessment-items">';
            
            if (houseTypeData?.unit_price_for_sale) {
                const listingType = houseTypeData.listing_type || '1+1';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('bedroomsLabel')} ${listingType}:</span>
                    <span class="assessment-value">${formatValue(houseTypeData.unit_price_for_sale, 'price')}</span>
                </div>`;
            }
            
            if (floorSegmentData?.unit_price_for_sale) {
                const listingType = floorSegmentData.listing_type || 'Giriş';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('floorLabel')} ${listingType}:</span>
                    <span class="assessment-value">${formatValue(floorSegmentData.unit_price_for_sale, 'price')}</span>
                </div>`;
            }
            
            if (ageData?.unit_price_for_sale) {
                const listingType = ageData.listing_type || '0–4';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('ageLabel')} ${listingType}:</span>
                    <span class="assessment-value">${formatValue(ageData.unit_price_for_sale, 'price')}</span>
                </div>`;
            }
            
            if (heatingData?.unit_price_for_sale) {
                const listingType = heatingData.listing_type || 'Yok';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('heatingLabel')} ${listingType}:</span>
                    <span class="assessment-value">${formatValue(heatingData.unit_price_for_sale, 'price')}</span>
                </div>`;
            }
            
            html += '</div>';
            if (salePrice.calculated) {
                html += `<div class="assessment-consolidated">
                    <span class="assessment-consolidated-label">${getText('consolidatedAverageLabel')}</span>
                    <span class="assessment-consolidated-value">≈ ${formatValue(salePrice.value, 'price')}/м²</span>
                </div>`;
            }
            html += '</div>';
            
            // Rent Price Section
            html += '<div class="assessment-category">';
            html += `<h5 class="assessment-category-title">${getText('rentPriceTitle')}</h5>`;
            html += '<div class="assessment-items">';
            
            if (houseTypeData?.unit_price_for_rent) {
                const listingType = houseTypeData.listing_type || '1+1';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('bedroomsLabel')} ${listingType}:</span>
                    <span class="assessment-value">${formatValue(houseTypeData.unit_price_for_rent, 'price')}</span>
                </div>`;
            }
            
            if (floorSegmentData?.unit_price_for_rent) {
                const listingType = floorSegmentData.listing_type || 'Giriş';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('floorLabel')} ${listingType}:</span>
                    <span class="assessment-value">${formatValue(floorSegmentData.unit_price_for_rent, 'price')}</span>
                </div>`;
            }
            
            if (ageData?.unit_price_for_rent) {
                const listingType = ageData.listing_type || '0–4';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('ageLabel')} ${listingType}:</span>
                    <span class="assessment-value">${formatValue(ageData.unit_price_for_rent, 'price')}</span>
                </div>`;
            }
            
            if (heatingData?.unit_price_for_rent) {
                const listingType = heatingData.listing_type || 'Yok';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('heatingLabel')} ${listingType}:</span>
                    <span class="assessment-value">${formatValue(heatingData.unit_price_for_rent, 'price')}</span>
                </div>`;
            }
            
            html += '</div>';
            if (rentPrice.calculated) {
                html += `<div class="assessment-consolidated">
                    <span class="assessment-consolidated-label">${getText('consolidatedAverageLabel')}</span>
                    <span class="assessment-consolidated-value">≈ ${formatValue(rentPrice.value, 'price')}/м²</span>
                </div>`;
            }
            html += '</div>';
            
            // Yield Section
            html += '<div class="assessment-category">';
            html += `<h5 class="assessment-category-title">${getText('yieldTitle')}</h5>`;
            html += '<div class="assessment-items">';
            
            if (houseTypeData?.yield) {
                const listingType = houseTypeData.listing_type || '1+1';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('bedroomsLabel')}:</span>
                    <span class="assessment-value">${formatValue(houseTypeData.yield, 'percentage')}</span>
                </div>`;
            }
            
            if (floorSegmentData?.yield) {
                const listingType = floorSegmentData.listing_type || 'Giriş';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('floorLabel')}:</span>
                    <span class="assessment-value">${formatValue(floorSegmentData.yield, 'percentage')}</span>
                </div>`;
            }
            
            if (ageData?.yield) {
                const listingType = ageData.listing_type || '0–4';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('ageLabel')}:</span>
                    <span class="assessment-value">${formatValue(ageData.yield, 'percentage')}</span>
                </div>`;
            }
            
            if (heatingData?.yield) {
                const listingType = heatingData.listing_type || 'Yok';
                html += `<div class="assessment-item">
                    <span class="assessment-label">${getText('heatingLabel')}:</span>
                    <span class="assessment-value">${formatValue(heatingData.yield, 'percentage')}</span>
                </div>`;
            }
            
            html += '</div>';
            if (yield.calculated) {
                html += `<div class="assessment-consolidated">
                    <span class="assessment-consolidated-label">${getText('consolidatedAverageLabel')}</span>
                    <span class="assessment-consolidated-value">≈ ${formatValue(yield.value, 'percentage')}</span>
                </div>`;
            }
            html += '</div>';
            
            html += '</div></div>';
            
            return html;
        }

        // Check if user has access to premium features
        async function checkUserAccess() {
            try {
                const telegramId = getTelegramId();
                if (!telegramId) {
                    console.log('⚠️ No Telegram ID found');
                    return { hasAccess: false, reason: 'no_telegram_id' };
                }
                
                const response = await fetch('/api/check_admin_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ telegram_id: telegramId })
                });
                
                if (!response.ok) {
                    console.log('⚠️ Failed to check user access');
                    return { hasAccess: false, reason: 'api_error' };
                }
                
                const data = await response.json();
                console.log('🔍 User access check result:', data);
                console.log('🔍 Raw period_end value:', data.period_end);
                console.log('🔍 Type of period_end:', typeof data.period_end);
                
                if (data.success) {
                    // Check if user is admin
                    if (data.is_admin) {
                        return { hasAccess: true, reason: 'admin' };
                    }
                    
                    // Check if user has active subscription
                    if (data.period_end) {
                        const today = new Date();
                        // Set time to start of day to avoid timezone issues
                        today.setHours(0, 0, 0, 0);
                        
                        const periodEnd = new Date(data.period_end);
                        // Set time to end of day to include the full subscription day
                        periodEnd.setHours(23, 59, 59, 999);
                        
                        console.log('🔍 Date comparison debug:');
                        console.log('  Today:', today.toISOString(), '(', today.toDateString(), ')');
                        console.log('  Period end:', periodEnd.toISOString(), '(', periodEnd.toDateString(), ')');
                        console.log('  Raw period_end from API:', data.period_end);
                        
                        const hasActiveSubscription = today <= periodEnd;
                        console.log('  Has active subscription:', hasActiveSubscription);
                        
                        return { 
                            hasAccess: hasActiveSubscription, 
                            reason: hasActiveSubscription ? 'active_subscription' : 'expired_subscription',
                            periodEnd: data.period_end
                        };
                    }
                    
                    return { hasAccess: false, reason: 'no_subscription' };
                }
                
                return { hasAccess: false, reason: 'api_failed' };
            } catch (error) {
                console.error('❌ Error checking user access:', error);
                return { hasAccess: false, reason: 'error' };
            }
        }
        
        // Generate subscription required message
        function generateSubscriptionMessage() {
            const currentLanguage = userLanguage || 'ru';
            const texts = {
                'ru': {
                    title: 'subscriptionRequiredTitle',
                    benefits: 'subscriptionBenefits',
                    benefit1: 'subscriptionBenefit1',
                    benefit2: 'subscriptionBenefit2',
                    benefit3: 'subscriptionBenefit3',
                    howToSubscribe: 'howToSubscribe',
                    subscribeInstructions: 'subscribeInstructions',
                    followInstructions: 'followInstructions',
                    needHelp: 'needHelp',
                    contactSupport: 'contactSupport'
                },
                'en': {
                    title: 'subscriptionRequiredTitle',
                    benefits: 'subscriptionBenefits',
                    benefit1: 'subscriptionBenefit1',
                    benefit2: 'subscriptionBenefit2',
                    benefit3: 'subscriptionBenefit3',
                    howToSubscribe: 'howToSubscribe',
                    subscribeInstructions: 'subscribeInstructions',
                    followInstructions: 'followInstructions',
                    needHelp: 'needHelp',
                    contactSupport: 'contactSupport'
                },
                'de': {
                    title: 'subscriptionRequiredTitle',
                    benefits: 'subscriptionBenefits',
                    benefit1: 'subscriptionBenefit1',
                    benefit2: 'subscriptionBenefit2',
                    benefit3: 'subscriptionBenefit3',
                    howToSubscribe: 'howToSubscribe',
                    subscribeInstructions: 'subscribeInstructions',
                    followInstructions: 'followInstructions',
                    needHelp: 'needHelp',
                    contactSupport: 'contactSupport'
                },
                'fr': {
                    title: 'subscriptionRequiredTitle',
                    benefits: 'subscriptionBenefits',
                    benefit1: 'subscriptionBenefit1',
                    benefit2: 'subscriptionBenefit2',
                    benefit3: 'subscriptionBenefit3',
                    howToSubscribe: 'howToSubscribe',
                    subscribeInstructions: 'subscribeInstructions',
                    followInstructions: 'followInstructions',
                    needHelp: 'needHelp',
                    contactSupport: 'contactSupport'
                },
                'tr': {
                    title: 'subscriptionRequiredTitle',
                    benefits: 'subscriptionBenefits',
                    benefit1: 'subscriptionBenefit1',
                    benefit2: 'subscriptionBenefit2',
                    benefit3: 'subscriptionBenefit3',
                    howToSubscribe: 'howToSubscribe',
                    subscribeInstructions: 'subscribeInstructions',
                    followInstructions: 'followInstructions',
                    needHelp: 'needHelp',
                    contactSupport: 'contactSupport'
                }
            };
            
            const langTexts = texts[currentLanguage] || texts['ru'];
            
            let messageHtml = '<div class="subscription-required-section">';
            messageHtml += `<h4 class="subscription-required-title">${getText(langTexts.title)}</h4>`;
            messageHtml += '<div class="subscription-required-content">';
            messageHtml += `<p class="subscription-benefits-title">${getText(langTexts.benefits)}</p>`;
            messageHtml += '<ul class="subscription-benefits-list">';
            messageHtml += `<li>${getText(langTexts.benefit1)}</li>`;
            messageHtml += `<li>${getText(langTexts.benefit2)}</li>`;
            messageHtml += `<li>${getText(langTexts.benefit3)}</li>`;
            messageHtml += '</ul>';
            messageHtml += `<p class="subscription-how-title">${getText(langTexts.howToSubscribe)}</p>`;
            messageHtml += `<p class="subscription-instructions">${getText(langTexts.subscribeInstructions)}</p>`;
            messageHtml += `<p class="subscription-follow">${getText(langTexts.followInstructions)}</p>`;
            messageHtml += `<p class="subscription-help">${getText(langTexts.needHelp)}</p>`;
            messageHtml += `<p class="subscription-support">${getText(langTexts.contactSupport)}</p>`;
            messageHtml += '</div></div>';
            
            // Заменяем @username на ссылки
            messageHtml = messageHtml.replace(
                /@Aaadviser_pay_bot/g, 
                '<a href="http://t.me/Aaadviser_pay_bot" target="_blank">@Aaadviser_pay_bot</a>'
            );
            messageHtml = messageHtml.replace(
                /@Aaadviser_support_bot/g, 
                '<a href="http://t.me/Aaadviser_support_bot" target="_blank">@Aaadviser_support_bot</a>'
            );
            
            return messageHtml;
        }
        
        // Calculate consolidated value with coefficients
        function calculateConsolidatedValue(items) {
            const validItems = items.filter(item => item.value !== null && item.value !== undefined && item.value !== 0 && !isNaN(parseFloat(item.value)));
            
            if (validItems.length === 0) {
                return { calculated: false, value: 0 };
            }
            
            // If some items are missing, redistribute coefficients proportionally
            let totalCoefficient = 0;
            validItems.forEach(item => {
                totalCoefficient += item.coefficient;
            });
            
            let weightedSum = 0;
            validItems.forEach(item => {
                const adjustedCoefficient = item.coefficient / totalCoefficient;
                weightedSum += parseFloat(item.value) * adjustedCoefficient;
            });
            
            return {
                calculated: true,
                value: weightedSum
            };
        }
    </script>
</body>
</html>
