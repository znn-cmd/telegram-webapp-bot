<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaadviser - <span data-i18n="reports.property_evaluation">Оценка объекта</span></title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="design-system.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #f0f0f0;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .slogan {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .report-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .report-title {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .report-content {
            margin-bottom: 20px;
        }

        .language-selection-section {
            background: #e8f4fd;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .language-selection-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }

        .language-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .lang-btn {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .lang-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .lang-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .save-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-save {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            font-weight: 600;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .back-btn {
            background: #6c757d;
            color: white;
            margin-top: 10px;
        }

        .back-btn:hover {
            background: #545b62;
        }

        .hidden {
            display: none;
        }

        .table-container {
            margin: 20px 0;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
        }

        .data-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 12px;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e3f2fd;
        }

        .consolidated-assessment {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .assessment-title {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }

        .assessment-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .assessment-item:last-child {
            border-bottom: none;
        }

        .assessment-label {
            font-weight: 500;
            color: #495057;
        }

        .assessment-value {
            font-weight: 600;
            color: #28a745;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .language-buttons {
                flex-direction: column;
            }
            
            .lang-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Aaadviser</div>
            <div class="slogan" data-i18n="reports.property_evaluation">Оценка объекта</div>
        </div>

        <!-- Форма ввода данных -->
        <div id="input-form" class="form-section">
            <div class="form-group">
                <label class="form-label" data-i18n="reports.property_address">Адрес объекта</label>
                <input type="text" id="property-address" class="form-input" placeholder="Введите адрес объекта">
            </div>

            <div class="form-group">
                <label class="form-label" data-i18n="reports.property_type">Тип недвижимости</label>
                <select id="property-type" class="form-select">
                    <option value="" data-i18n="common.loading">Загрузка...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" data-i18n="reports.property_area">Площадь (м²)</label>
                <input type="number" id="property-area" class="form-input" placeholder="Введите площадь">
            </div>

            <div class="form-group">
                <label class="form-label" data-i18n="reports.property_price">Цена</label>
                <input type="number" id="property-price" class="form-input" placeholder="Введите цену">
            </div>

            <button id="analyze-btn" class="btn btn-primary" data-i18n="reports.create_report">Создать отчет</button>
        </div>

        <!-- Загрузка -->
        <div id="loading" class="loading hidden">
            <div data-i18n="common.loading">Загрузка...</div>
        </div>

        <!-- Ошибка -->
        <div id="error" class="error hidden"></div>

        <!-- Отчет -->
        <div id="report-section" class="report-section hidden">
            <div class="report-title" data-i18n="reports.property_evaluation">Отчет по оценке объекта</div>
            
            <div id="report-content" class="report-content">
                <!-- Здесь будет содержимое отчета -->
            </div>

            <!-- Выбор языка отчета -->
            <div id="language-selection" class="language-selection-section">
                <div class="language-selection-title" data-i18n="reports.select_report_language">Выберите язык отчета перед сохранением</div>
                
                <div class="language-buttons">
                    <button class="lang-btn" data-lang="ru" onclick="setReportLanguage('ru')">🇷🇺 Русский</button>
                    <button class="lang-btn" data-lang="en" onclick="setReportLanguage('en')">🇺🇸 English</button>
                    <button class="lang-btn" data-lang="de" onclick="setReportLanguage('de')">🇩🇪 Deutsch</button>
                    <button class="lang-btn" data-lang="fr" onclick="setReportLanguage('fr')">🇫🇷 Français</button>
                    <button class="lang-btn" data-lang="tr" onclick="setReportLanguage('tr')">🇹🇷 Türkçe</button>
                </div>

                <div class="save-section">
                    <button id="save-report-btn" class="btn btn-save" data-i18n="reports.save_report">Сохранить отчет</button>
                    <button id="back-to-form-btn" class="btn back-btn" data-i18n="common.back">Назад к форме</button>
                </div>
            </div>
        </div>
    </div>

    <script src="i18n-manager.js"></script>
    <script>
        // Глобальные переменные
        let currentReportLanguage = 'ru';
        let reportData = null;
        let isReportGenerated = false;

        // Переводы для отчета
        const reportTranslations = {
            'ru': {
                'property_evaluation': 'Оценка объекта',
                'property_address': 'Адрес объекта',
                'property_type': 'Тип недвижимости',
                'property_area': 'Площадь (м²)',
                'property_price': 'Цена',
                'create_report': 'Создать отчет',
                'save_report': 'Сохранить отчет',
                'select_report_language': 'Выберите язык отчета перед сохранением',
                'market_analysis': 'Анализ рынка',
                'price_forecast': 'Прогноз цен',
                'investment_recommendations': 'Инвестиционные рекомендации',
                'consolidated_assessment': 'Консолидированная оценка',
                'unit_price_sale': 'Цена за м² (продажа)',
                'unit_price_rent': 'Цена за м² (аренда)',
                'yield': 'Доходность',
                'bedrooms': 'Спальни',
                'floor': 'Этаж',
                'age': 'Возраст',
                'heating': 'Отопление',
                'consolidated_average': 'Консолидированная средняя',
                'average_market_price': 'Средняя рыночная цена',
                'one_year_forecast': 'Прогноз на 1 год',
                'three_year_forecast': 'Прогноз на 3 года',
                'market_comparison': 'Сравнение с рынком',
                'investment_potential': 'Инвестиционный потенциал',
                'risk_assessment': 'Оценка рисков',
                'location_analysis': 'Анализ локации',
                'property_features': 'Характеристики объекта',
                'neighborhood_data': 'Данные о районе',
                'transport_access': 'Транспортная доступность',
                'infrastructure': 'Инфраструктура',
                'schools_nearby': 'Школы поблизости',
                'hospitals_nearby': 'Больницы поблизости',
                'shopping_centers': 'Торговые центры',
                'parks_recreation': 'Парки и отдых',
                'crime_rate': 'Уровень преступности',
                'population_density': 'Плотность населения',
                'average_income': 'Средний доход',
                'employment_rate': 'Уровень занятости',
                'property_taxes': 'Налоги на недвижимость',
                'maintenance_costs': 'Расходы на содержание',
                'utilities': 'Коммунальные услуги',
                'insurance_costs': 'Страхование',
                'legal_fees': 'Юридические расходы',
                'total_monthly_costs': 'Общие месячные расходы',
                'net_yield': 'Чистая доходность',
                'gross_yield': 'Валовая доходность',
                'payback_period': 'Срок окупаемости',
                'recommendation': 'Рекомендация',
                'buy': 'Покупать',
                'sell': 'Продавать',
                'hold': 'Держать',
                'avoid': 'Избегать',
                'excellent': 'Отлично',
                'good': 'Хорошо',
                'average': 'Средне',
                'poor': 'Плохо',
                'very_poor': 'Очень плохо',
                'high': 'Высокий',
                'medium': 'Средний',
                'low': 'Низкий',
                'very_low': 'Очень низкий'
            },
            'en': {
                'property_evaluation': 'Property Evaluation',
                'property_address': 'Property Address',
                'property_type': 'Property Type',
                'property_area': 'Area (m²)',
                'property_price': 'Price',
                'create_report': 'Create Report',
                'save_report': 'Save Report',
                'select_report_language': 'Select report language before saving',
                'market_analysis': 'Market Analysis',
                'price_forecast': 'Price Forecast',
                'investment_recommendations': 'Investment Recommendations',
                'consolidated_assessment': 'Consolidated Assessment',
                'unit_price_sale': 'Price per m² (sale)',
                'unit_price_rent': 'Price per m² (rent)',
                'yield': 'Yield',
                'bedrooms': 'Bedrooms',
                'floor': 'Floor',
                'age': 'Age',
                'heating': 'Heating',
                'consolidated_average': 'Consolidated Average',
                'average_market_price': 'Average Market Price',
                'one_year_forecast': '1 Year Forecast',
                'three_year_forecast': '3 Year Forecast',
                'market_comparison': 'Market Comparison',
                'investment_potential': 'Investment Potential',
                'risk_assessment': 'Risk Assessment',
                'location_analysis': 'Location Analysis',
                'property_features': 'Property Features',
                'neighborhood_data': 'Neighborhood Data',
                'transport_access': 'Transport Access',
                'infrastructure': 'Infrastructure',
                'schools_nearby': 'Schools Nearby',
                'hospitals_nearby': 'Hospitals Nearby',
                'shopping_centers': 'Shopping Centers',
                'parks_recreation': 'Parks & Recreation',
                'crime_rate': 'Crime Rate',
                'population_density': 'Population Density',
                'average_income': 'Average Income',
                'employment_rate': 'Employment Rate',
                'property_taxes': 'Property Taxes',
                'maintenance_costs': 'Maintenance Costs',
                'utilities': 'Utilities',
                'insurance_costs': 'Insurance Costs',
                'legal_fees': 'Legal Fees',
                'total_monthly_costs': 'Total Monthly Costs',
                'net_yield': 'Net Yield',
                'gross_yield': 'Gross Yield',
                'payback_period': 'Payback Period',
                'recommendation': 'Recommendation',
                'buy': 'Buy',
                'sell': 'Sell',
                'hold': 'Hold',
                'avoid': 'Avoid',
                'excellent': 'Excellent',
                'good': 'Good',
                'average': 'Average',
                'poor': 'Poor',
                'very_poor': 'Very Poor',
                'high': 'High',
                'medium': 'Medium',
                'low': 'Low',
                'very_low': 'Very Low'
            },
            'de': {
                'property_evaluation': 'Immobilienbewertung',
                'property_address': 'Immobilienadresse',
                'property_type': 'Immobilientyp',
                'property_area': 'Fläche (m²)',
                'property_price': 'Preis',
                'create_report': 'Bericht erstellen',
                'save_report': 'Bericht speichern',
                'select_report_language': 'Berichtssprache vor dem Speichern auswählen',
                'market_analysis': 'Marktanalyse',
                'price_forecast': 'Preisprognose',
                'investment_recommendations': 'Investitionsempfehlungen',
                'consolidated_assessment': 'Konsolidierte Bewertung',
                'unit_price_sale': 'Preis pro m² (Verkauf)',
                'unit_price_rent': 'Preis pro m² (Miete)',
                'yield': 'Rendite',
                'bedrooms': 'Schlafzimmer',
                'floor': 'Etage',
                'age': 'Alter',
                'heating': 'Heizung',
                'consolidated_average': 'Konsolidierter Durchschnitt',
                'average_market_price': 'Durchschnittlicher Marktpreis',
                'one_year_forecast': '1-Jahres-Prognose',
                'three_year_forecast': '3-Jahres-Prognose',
                'market_comparison': 'Marktvergleich',
                'investment_potential': 'Investitionspotenzial',
                'risk_assessment': 'Risikobewertung',
                'location_analysis': 'Standortanalyse',
                'property_features': 'Immobilienmerkmale',
                'neighborhood_data': 'Nachbarschaftsdaten',
                'transport_access': 'Verkehrsanbindung',
                'infrastructure': 'Infrastruktur',
                'schools_nearby': 'Schulen in der Nähe',
                'hospitals_nearby': 'Krankenhäuser in der Nähe',
                'shopping_centers': 'Einkaufszentren',
                'parks_recreation': 'Parks & Erholung',
                'crime_rate': 'Kriminalitätsrate',
                'population_density': 'Bevölkerungsdichte',
                'average_income': 'Durchschnittseinkommen',
                'employment_rate': 'Beschäftigungsquote',
                'property_taxes': 'Grundsteuern',
                'maintenance_costs': 'Instandhaltungskosten',
                'utilities': 'Nebenkosten',
                'insurance_costs': 'Versicherungskosten',
                'legal_fees': 'Rechtskosten',
                'total_monthly_costs': 'Gesamte monatliche Kosten',
                'net_yield': 'Nettorendite',
                'gross_yield': 'Bruttorendite',
                'payback_period': 'Amortisationszeit',
                'recommendation': 'Empfehlung',
                'buy': 'Kaufen',
                'sell': 'Verkaufen',
                'hold': 'Halten',
                'avoid': 'Vermeiden',
                'excellent': 'Ausgezeichnet',
                'good': 'Gut',
                'average': 'Durchschnittlich',
                'poor': 'Schlecht',
                'very_poor': 'Sehr schlecht',
                'high': 'Hoch',
                'medium': 'Mittel',
                'low': 'Niedrig',
                'very_low': 'Sehr niedrig'
            },
            'fr': {
                'property_evaluation': 'Évaluation immobilière',
                'property_address': 'Adresse de la propriété',
                'property_type': 'Type de propriété',
                'property_area': 'Surface (m²)',
                'property_price': 'Prix',
                'create_report': 'Créer un rapport',
                'save_report': 'Enregistrer le rapport',
                'select_report_language': 'Sélectionnez la langue du rapport avant de sauvegarder',
                'market_analysis': 'Analyse de marché',
                'price_forecast': 'Prévision des prix',
                'investment_recommendations': 'Recommandations d\'investissement',
                'consolidated_assessment': 'Évaluation consolidée',
                'unit_price_sale': 'Prix par m² (vente)',
                'unit_price_rent': 'Prix par m² (location)',
                'yield': 'Rendement',
                'bedrooms': 'Chambres',
                'floor': 'Étage',
                'age': 'Âge',
                'heating': 'Chauffage',
                'consolidated_average': 'Moyenne consolidée',
                'average_market_price': 'Prix moyen du marché',
                'one_year_forecast': 'Prévision 1 an',
                'three_year_forecast': 'Prévision 3 ans',
                'market_comparison': 'Comparaison de marché',
                'investment_potential': 'Potentiel d\'investissement',
                'risk_assessment': 'Évaluation des risques',
                'location_analysis': 'Analyse de localisation',
                'property_features': 'Caractéristiques de la propriété',
                'neighborhood_data': 'Données du quartier',
                'transport_access': 'Accès aux transports',
                'infrastructure': 'Infrastructure',
                'schools_nearby': 'Écoles à proximité',
                'hospitals_nearby': 'Hôpitaux à proximité',
                'shopping_centers': 'Centres commerciaux',
                'parks_recreation': 'Parcs & Loisirs',
                'crime_rate': 'Taux de criminalité',
                'population_density': 'Densité de population',
                'average_income': 'Revenu moyen',
                'employment_rate': 'Taux d\'emploi',
                'property_taxes': 'Taxes foncières',
                'maintenance_costs': 'Coûts d\'entretien',
                'utilities': 'Services publics',
                'insurance_costs': 'Coûts d\'assurance',
                'legal_fees': 'Frais juridiques',
                'total_monthly_costs': 'Coûts mensuels totaux',
                'net_yield': 'Rendement net',
                'gross_yield': 'Rendement brut',
                'payback_period': 'Période de récupération',
                'recommendation': 'Recommandation',
                'buy': 'Acheter',
                'sell': 'Vendre',
                'hold': 'Conserver',
                'avoid': 'Éviter',
                'excellent': 'Excellent',
                'good': 'Bon',
                'average': 'Moyen',
                'poor': 'Mauvais',
                'very_poor': 'Très mauvais',
                'high': 'Élevé',
                'medium': 'Moyen',
                'low': 'Faible',
                'very_low': 'Très faible'
            },
            'tr': {
                'property_evaluation': 'Emlak Değerlendirmesi',
                'property_address': 'Emlak Adresi',
                'property_type': 'Emlak Türü',
                'property_area': 'Alan (m²)',
                'property_price': 'Fiyat',
                'create_report': 'Rapor Oluştur',
                'save_report': 'Raporu Kaydet',
                'select_report_language': 'Kaydetmeden önce rapor dilini seçin',
                'market_analysis': 'Pazar Analizi',
                'price_forecast': 'Fiyat Tahmini',
                'investment_recommendations': 'Yatırım Önerileri',
                'consolidated_assessment': 'Konsolide Değerlendirme',
                'unit_price_sale': 'm² Fiyatı (satış)',
                'unit_price_rent': 'm² Fiyatı (kira)',
                'yield': 'Getiri',
                'bedrooms': 'Yatak Odası',
                'floor': 'Kat',
                'age': 'Yaş',
                'heating': 'Isıtma',
                'consolidated_average': 'Konsolide Ortalama',
                'average_market_price': 'Ortalama Piyasa Fiyatı',
                'one_year_forecast': '1 Yıl Tahmini',
                'three_year_forecast': '3 Yıl Tahmini',
                'market_comparison': 'Pazar Karşılaştırması',
                'investment_potential': 'Yatırım Potansiyeli',
                'risk_assessment': 'Risk Değerlendirmesi',
                'location_analysis': 'Konum Analizi',
                'property_features': 'Emlak Özellikleri',
                'neighborhood_data': 'Mahalle Verileri',
                'transport_access': 'Ulaşım Erişimi',
                'infrastructure': 'Altyapı',
                'schools_nearby': 'Yakındaki Okullar',
                'hospitals_nearby': 'Yakındaki Hastaneler',
                'shopping_centers': 'Alışveriş Merkezleri',
                'parks_recreation': 'Parklar & Rekreasyon',
                'crime_rate': 'Suç Oranı',
                'population_density': 'Nüfus Yoğunluğu',
                'average_income': 'Ortalama Gelir',
                'employment_rate': 'İstihdam Oranı',
                'property_taxes': 'Emlak Vergileri',
                'maintenance_costs': 'Bakım Maliyetleri',
                'utilities': 'Kamu Hizmetleri',
                'insurance_costs': 'Sigorta Maliyetleri',
                'legal_fees': 'Hukuki Ücretler',
                'total_monthly_costs': 'Toplam Aylık Maliyetler',
                'net_yield': 'Net Getiri',
                'gross_yield': 'Brüt Getiri',
                'payback_period': 'Geri Ödeme Süresi',
                'recommendation': 'Öneri',
                'buy': 'Satın Al',
                'sell': 'Sat',
                'hold': 'Tut',
                'avoid': 'Kaçın',
                'excellent': 'Mükemmel',
                'good': 'İyi',
                'average': 'Ortalama',
                'poor': 'Kötü',
                'very_poor': 'Çok Kötü',
                'high': 'Yüksek',
                'medium': 'Orta',
                'low': 'Düşük',
                'very_low': 'Çok Düşük'
            }
        };

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // Инициализация страницы
        async function initializePage() {
            try {
                // Загружаем типы недвижимости
                await loadPropertyTypes();
                
                // Инициализируем обработчики событий
                initializeEventHandlers();
                
                // Инициализируем кнопки языка
                initializeLanguageButtons();
                
                console.log('Страница инициализирована');
            } catch (error) {
                console.error('Ошибка инициализации:', error);
                showError('Ошибка инициализации страницы');
            }
        }

        // Загрузка типов недвижимости
        async function loadPropertyTypes() {
            try {
                const response = await fetch('/api/property_types');
                if (response.ok) {
                    const types = await response.json();
                    const select = document.getElementById('property-type');
                    select.innerHTML = '<option value="">Выберите тип недвижимости</option>';
                    
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки типов недвижимости:', error);
            }
        }

        // Инициализация обработчиков событий
        function initializeEventHandlers() {
            // Кнопка создания отчета
            document.getElementById('analyze-btn').addEventListener('click', createReport);
            
            // Кнопка сохранения отчета
            document.getElementById('save-report-btn').addEventListener('click', saveReport);
            
            // Кнопка возврата к форме
            document.getElementById('back-to-form-btn').addEventListener('click', backToForm);
        }

        // Создание отчета
        async function createReport() {
            const address = document.getElementById('property-address').value.trim();
            const type = document.getElementById('property-type').value;
            const area = document.getElementById('property-area').value;
            const price = document.getElementById('property-price').value;

            // Валидация
            if (!address || !type || !area || !price) {
                showError('Пожалуйста, заполните все поля');
                return;
            }

            try {
                showLoading(true);
                hideError();

                // Симуляция создания отчета (замените на реальный API вызов)
                await simulateReportGeneration(address, type, area, price);
                
                showLoading(false);
                showReport();
                
            } catch (error) {
                console.error('Ошибка создания отчета:', error);
                showLoading(false);
                showError('Ошибка создания отчета. Попробуйте еще раз.');
            }
        }

        // Симуляция генерации отчета
        async function simulateReportGeneration(address, type, area, price) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Создаем тестовые данные отчета
                    reportData = {
                        address: address,
                        type: type,
                        area: parseFloat(area),
                        price: parseFloat(price),
                        marketAnalysis: {
                            averagePrice: parseFloat(price) * 0.95,
                            priceRange: {
                                min: parseFloat(price) * 0.85,
                                max: parseFloat(price) * 1.15
                            }
                        },
                        forecast: {
                            oneYear: parseFloat(price) * 1.08,
                            threeYear: parseFloat(price) * 1.25
                        },
                        recommendations: [
                            'Объект имеет хороший инвестиционный потенциал',
                            'Рекомендуется рассмотреть возможность аренды',
                            'Цена соответствует рыночным показателям'
                        ]
                    };
                    
                    isReportGenerated = true;
                    resolve();
                }, 2000);
            });
        }

        // Показать отчет
        function showReport() {
            document.getElementById('input-form').classList.add('hidden');
            document.getElementById('report-section').classList.remove('hidden');
            document.getElementById('language-selection').classList.remove('hidden');
            
            generateReportContent();
        }

        // Генерация содержимого отчета
        function generateReportContent() {
            if (!reportData) return;

            const content = document.getElementById('report-content');
            const translations = reportTranslations[currentReportLanguage];

            content.innerHTML = `
                <div class="consolidated-assessment">
                    <div class="assessment-title">${translations.market_analysis}</div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.property_address}:</span>
                        <span class="assessment-value">${reportData.address}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.property_area}:</span>
                        <span class="assessment-value">${reportData.area} м²</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.property_price}:</span>
                        <span class="assessment-value">₺${reportData.price.toLocaleString()}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.average_market_price}:</span>
                        <span class="assessment-value">₺${reportData.marketAnalysis.averagePrice.toLocaleString()}</span>
                    </div>
                </div>

                <div class="consolidated-assessment">
                    <div class="assessment-title">${translations.price_forecast}</div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.one_year_forecast}:</span>
                        <span class="assessment-value">₺${reportData.forecast.oneYear.toLocaleString()}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.three_year_forecast}:</span>
                        <span class="assessment-value">₺${reportData.forecast.threeYear.toLocaleString()}</span>
                    </div>
                </div>

                <div class="consolidated-assessment">
                    <div class="assessment-title">${translations.investment_recommendations}</div>
                    ${reportData.recommendations.map(rec => `
                        <div class="assessment-item">
                            <span class="assessment-label">•</span>
                            <span class="assessment-value">${rec}</span>
                        </div>
                    `).join('')}
                </div>

                <div class="consolidated-assessment">
                    <div class="assessment-title">${translations.investment_potential}</div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.recommendation}:</span>
                        <span class="assessment-value" style="color: #28a745; font-weight: bold;">${translations.buy}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.risk_assessment}:</span>
                        <span class="assessment-value" style="color: #ffc107;">${translations.medium}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.net_yield}:</span>
                        <span class="assessment-value">6.8%</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.payback_period}:</span>
                        <span class="assessment-value">14.7 ${translations.unit_days || 'лет'}</span>
                    </div>
                </div>

                <div class="consolidated-assessment">
                    <div class="assessment-title">${translations.location_analysis}</div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.transport_access}:</span>
                        <span class="assessment-value" style="color: #28a745;">${translations.excellent}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.infrastructure}:</span>
                        <span class="assessment-value" style="color: #28a745;">${translations.good}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.schools_nearby}:</span>
                        <span class="assessment-value">3 ${translations.unit_days || 'школы'}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.hospitals_nearby}:</span>
                        <span class="assessment-value">1 ${translations.unit_days || 'больница'}</span>
                    </div>
                    <div class="assessment-item">
                        <span class="assessment-label">${translations.shopping_centers}:</span>
                        <span class="assessment-value">2 ${translations.unit_days || 'центра'}</span>
                    </div>
                </div>
            `;
        }

        // Установка языка отчета
        function setReportLanguage(language) {
            currentReportLanguage = language;
            
            // Обновляем активную кнопку
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-lang="${language}"]`).classList.add('active');
            
            // Перегенерируем содержимое отчета
            if (isReportGenerated) {
                generateReportContent();
            }
        }

        // Инициализация активной кнопки языка
        function initializeLanguageButtons() {
            // Устанавливаем русский язык как активный по умолчанию
            setReportLanguage('ru');
        }

        // Сохранение отчета
        async function saveReport() {
            if (!reportData) {
                showError('Нет данных для сохранения');
                return;
            }

            try {
                showLoading(true);
                
                // Здесь будет реальный API вызов для сохранения отчета
                await simulateSaveReport();
                
                showLoading(false);
                showSuccess('Отчет успешно сохранен!');
                
                // Можно добавить переход к списку отчетов
                setTimeout(() => {
                    window.location.href = 'webapp_my_reports.html';
                }, 2000);
                
            } catch (error) {
                console.error('Ошибка сохранения отчета:', error);
                showLoading(false);
                showError('Ошибка сохранения отчета. Попробуйте еще раз.');
            }
        }

        // Симуляция сохранения отчета
        async function simulateSaveReport() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('Отчет сохранен:', {
                        ...reportData,
                        language: currentReportLanguage,
                        savedAt: new Date().toISOString()
                    });
                    resolve();
                }, 1000);
            });
        }

        // Возврат к форме
        function backToForm() {
            document.getElementById('input-form').classList.remove('hidden');
            document.getElementById('report-section').classList.add('hidden');
            document.getElementById('language-selection').classList.add('hidden');
            
            // Сбрасываем состояние
            isReportGenerated = false;
            reportData = null;
            currentReportLanguage = 'ru';
            
            // Сбрасываем активную кнопку языка
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Устанавливаем русский язык как активный
            setReportLanguage('ru');
        }

        // Показать загрузку
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }

        // Показать ошибку
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.classList.remove('hidden');
        }

        // Скрыть ошибку
        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        // Показать успех
        function showSuccess(message) {
            // Создаем временное уведомление об успехе
            const success = document.createElement('div');
            success.className = 'success';
            success.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(success, container.firstChild);
            
            setTimeout(() => {
                success.remove();
            }, 3000);
        }
    </script>
</body>
</html>
