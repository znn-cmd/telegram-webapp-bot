<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="profile.referral_program">Реферальная программа — Aaadviser</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; margin: 0; }
        .container { max-width: 400px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(102,126,234,0.10); padding: 32px 20px 24px 20px; text-align: center; }
        .title { font-size: 1.3em; font-weight: bold; margin-bottom: 18px; color: #333; }
        .ref-code-block { background: #f8f9fa; border-radius: 12px; padding: 18px; margin: 20px 0 18px 0; text-align: center; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(102,126,234,0.10); }
        .ref-code-label { font-size: 16px; color: #333; margin-bottom: 6px; }
        .ref-code-value { font-size: 1.2em; font-weight: bold; color: #764ba2; letter-spacing: 2px; margin-bottom: 10px; }
        .ref-link-block { margin: 12px 0; }
        .ref-link { font-size: 1em; color: #667eea; word-break: break-all; }
        .copy-btn { margin-left: 8px; background: #667eea; color: #fff; border: none; border-radius: 8px; padding: 6px 14px; font-size: 0.98em; cursor: pointer; transition: background 0.2s; margin-bottom: 10px; }
        .copy-btn:hover { background: #764ba2; }
        .ref-terms { background: #f1f1f1; border-radius: 10px; padding: 14px 12px; margin: 18px 0 18px 0; color: #444; font-size: 0.98em; text-align: left; }
        .invited-list { margin-top: 18px; text-align: left; }
        .invited-title { font-weight: bold; margin-bottom: 8px; color: #333; }
        .invited-item { background: #f8f9fa; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .invited-name { font-weight: 500; color: #333; }
        .invited-status { font-size: 0.98em; font-weight: 500; }
        .status-done { color: #2eaf4a; }
        .status-pending { color: #c33; }
        .back-btn { margin-top: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 10px; padding: 14px 28px; font-size: 1em; font-weight: 500; cursor: pointer; transition: background 0.2s; width: 100%; }
        .back-btn:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
    </style>
</head>
<body>
    <div class="container">
        <div class="title" data-i18n="profile.referral_program">Реферальная программа</div>
        <div class="ref-code-block">
            <div class="ref-code-label" data-i18n="referral.your_code">Ваш реферальный код:</div>
            <div class="ref-code-value" id="inviteCode">...</div>
            <div class="ref-link-block">
                <span class="ref-link" id="refLink">...</span>
                <button class="copy-btn" onclick="copyRefLink()" data-i18n="common.copy">Копировать</button>
            </div>
        </div>
        <div class="ref-terms" id="refTerms" data-i18n="referral.loading_terms">Загрузка условий...</div>
        <div class="invited-list">
            <div class="invited-title" data-i18n="referral.invited_users">Приглашённые пользователи:</div>
            <div id="invitedUsers" data-i18n="common.loading">Загрузка...</div>
        </div>
        <button class="back-btn" onclick="goToProfile()" data-i18n="referral.back_to_profile">Назад в профиль</button>
    </div>
    <script>
        // Локализация
        let currentLanguage = 'en';
        
        const locales = {
            'ru': {
                'profile.referral_program': 'Реферальная программа',
                'referral.your_code': 'Ваш реферальный код:',
                'common.copy': 'Копировать',
                'referral.loading_terms': 'Загрузка условий...',
                'referral.invited_users': 'Приглашённые пользователи:',
                'common.loading': 'Загрузка...',
                'referral.back_to_profile': 'Назад в профиль',
                'referral.link_copied': 'Ссылка скопирована!',
                'referral.copy_error': 'Ошибка копирования',
                'referral.user_not_defined': 'Пользователь не определён',
                'referral.open_from_telegram': 'Пожалуйста, откройте WebApp из Telegram.',
                'referral.completed': 'Выполнил',
                'referral.not_completed': 'Не выполнил',
                'referral.no_invited_users': 'Пока нет приглашённых пользователей.',
                'referral.terms_error': 'Ошибка загрузки условий.'
            },
            'en': {
                'profile.referral_program': 'Referral Program',
                'referral.your_code': 'Your referral code:',
                'common.copy': 'Copy',
                'referral.loading_terms': 'Loading terms...',
                'referral.invited_users': 'Invited users:',
                'common.loading': 'Loading...',
                'referral.back_to_profile': 'Back to profile',
                'referral.link_copied': 'Link copied!',
                'referral.copy_error': 'Copy error',
                'referral.user_not_defined': 'User not defined',
                'referral.open_from_telegram': 'Please open WebApp from Telegram.',
                'referral.completed': 'Completed',
                'referral.not_completed': 'Not completed',
                'referral.no_invited_users': 'No invited users yet.',
                'referral.terms_error': 'Error loading terms.'
            },
            'de': {
                'profile.referral_program': 'Empfehlungsprogramm',
                'referral.your_code': 'Ihr Empfehlungscode:',
                'common.copy': 'Kopieren',
                'referral.loading_terms': 'Bedingungen werden geladen...',
                'referral.invited_users': 'Eingeladene Benutzer:',
                'common.loading': 'Laden...',
                'referral.back_to_profile': 'Zurück zum Profil',
                'referral.link_copied': 'Link kopiert!',
                'referral.copy_error': 'Kopierfehler',
                'referral.user_not_defined': 'Benutzer nicht definiert',
                'referral.open_from_telegram': 'Bitte öffnen Sie WebApp aus Telegram.',
                'referral.completed': 'Abgeschlossen',
                'referral.not_completed': 'Nicht abgeschlossen',
                'referral.no_invited_users': 'Noch keine eingeladenen Benutzer.',
                'referral.terms_error': 'Fehler beim Laden der Bedingungen.'
            },
            'fr': {
                'profile.referral_program': 'Programme de Parrainage',
                'referral.your_code': 'Votre code de parrainage:',
                'common.copy': 'Copier',
                'referral.loading_terms': 'Chargement des conditions...',
                'referral.invited_users': 'Utilisateurs invités:',
                'common.loading': 'Chargement...',
                'referral.back_to_profile': 'Retour au profil',
                'referral.link_copied': 'Lien copié!',
                'referral.copy_error': 'Erreur de copie',
                'referral.user_not_defined': 'Utilisateur non défini',
                'referral.open_from_telegram': 'Veuillez ouvrir WebApp depuis Telegram.',
                'referral.completed': 'Terminé',
                'referral.not_completed': 'Non terminé',
                'referral.no_invited_users': 'Aucun utilisateur invité pour le moment.',
                'referral.terms_error': 'Erreur lors du chargement des conditions.'
            },
            'tr': {
                'profile.referral_program': 'Referans Programı',
                'referral.your_code': 'Referans kodunuz:',
                'common.copy': 'Kopyala',
                'referral.loading_terms': 'Şartlar yükleniyor...',
                'referral.invited_users': 'Davet edilen kullanıcılar:',
                'common.loading': 'Yükleniyor...',
                'referral.back_to_profile': 'Profile geri dön',
                'referral.link_copied': 'Bağlantı kopyalandı!',
                'referral.copy_error': 'Kopyalama hatası',
                'referral.user_not_defined': 'Kullanıcı tanımlanmamış',
                'referral.open_from_telegram': 'Lütfen WebApp\'i Telegram\'dan açın.',
                'referral.completed': 'Tamamlandı',
                'referral.not_completed': 'Tamamlanmadı',
                'referral.no_invited_users': 'Henüz davet edilen kullanıcı yok.',
                'referral.terms_error': 'Şartlar yüklenirken hata.'
            }
        };
        
        function getText(key) {
            return locales[currentLanguage][key] || key;
        }
        
        // Получение языка пользователя
        async function getUserLanguage() {
            try {
                const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
                if (telegramUser) {
                    const response = await fetch('/api/user/language', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            telegram_id: telegramUser.id,
                            language_code: telegramUser.language_code || 'en'
                        })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        currentLanguage = data.language || 'en';
                    }
                }
            } catch (error) {
                console.error('Error getting user language:', error);
                currentLanguage = 'en';
            }
        }
        
        // Обновление текста на странице
        function updatePageText() {
            document.querySelector('[data-i18n="profile.referral_program"]').textContent = getText('profile.referral_program');
            document.querySelector('[data-i18n="referral.your_code"]').textContent = getText('referral.your_code');
            document.querySelector('[data-i18n="common.copy"]').textContent = getText('common.copy');
            document.querySelector('[data-i18n="referral.invited_users"]').textContent = getText('referral.invited_users');
            document.querySelector('[data-i18n="referral.back_to_profile"]').textContent = getText('referral.back_to_profile');
        }
        
        // Инициализация страницы
        async function init() {
            await getUserLanguage();
            updatePageText();
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', init);
        
        function goToProfile() {
            window.location.href = '/webapp_profile';
        }
        function copyRefLink() {
            const refLink = document.getElementById('refLink').textContent;
            navigator.clipboard.writeText(refLink).then(() => {
                alert(getText('referral.link_copied'));
            }, () => {
                alert(getText('referral.copy_error'));
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (tg) { tg.ready(); tg.expand && tg.expand(); }
            let userData = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
            if (!userData) {
                try { userData = JSON.parse(localStorage.getItem('aaadviser_user')); } catch (e) { userData = null; }
            }
            if (!userData || !userData.id) {
                document.getElementById('inviteCode').textContent = getText('referral.user_not_defined');
                document.getElementById('refLink').textContent = '-';
                document.getElementById('refTerms').textContent = getText('referral.open_from_telegram');
                document.getElementById('invitedUsers').textContent = '-';
                return;
            }
            fetch('/api/referral_info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('inviteCode').textContent = data.invite_code || '-';
                document.getElementById('refLink').textContent = data.bot_link || '-';
                document.getElementById('refTerms').textContent = data.referral_terms || '-';
                if (Array.isArray(data.invited) && data.invited.length > 0) {
                    document.getElementById('invitedUsers').innerHTML = data.invited.map(u =>
                        `<div class='invited-item'><span class='invited-name'>${u.tg_name || u.username || u.telegram_id}</span><span class='invited-status ${u.completed ? 'status-done' : 'status-pending'}'>${u.completed ? getText('referral.completed') : getText('referral.not_completed')}</span></div>`
                    ).join('');
                } else {
                    document.getElementById('invitedUsers').textContent = getText('referral.no_invited_users');
                }
            })
            .catch(() => {
                document.getElementById('inviteCode').textContent = '-';
                document.getElementById('refLink').textContent = '-';
                document.getElementById('refTerms').textContent = getText('referral.terms_error');
                document.getElementById('invitedUsers').textContent = '-';
            });
        });
    </script>
</body>
</html> 