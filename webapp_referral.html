<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/i18n-manager.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="profile.referral_program">Реферальная программа — Aaadviser</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; margin: 0; }
        .container { max-width: 400px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(102,126,234,0.10); padding: 32px 20px 24px 20px; text-align: center; }
        .title { font-size: 1.3em; font-weight: bold; margin-bottom: 18px; color: #333; }
        .ref-code-block { background: #f8f9fa; border-radius: 12px; padding: 18px; margin: 20px 0 18px 0; text-align: center; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(102,126,234,0.10); }
        .ref-code-label { font-size: 16px; color: #333; margin-bottom: 6px; }
        .ref-code-value { font-size: 1.2em; font-weight: bold; color: #764ba2; letter-spacing: 2px; margin-bottom: 10px; }
        .ref-link-block { margin: 12px 0; }
        .ref-link { font-size: 1em; color: #667eea; word-break: break-all; }
        .copy-btn { margin-left: 8px; background: #667eea; color: #fff; border: none; border-radius: 8px; padding: 6px 14px; font-size: 0.98em; cursor: pointer; transition: background 0.2s; margin-bottom: 10px; }
        .copy-btn:hover { background: #764ba2; }
        .ref-terms { background: #f1f1f1; border-radius: 10px; padding: 14px 12px; margin: 18px 0 18px 0; color: #444; font-size: 0.98em; text-align: left; }
        .invited-list { margin-top: 18px; text-align: left; }
        .invited-title { font-weight: bold; margin-bottom: 8px; color: #333; }
        .invited-item { background: #f8f9fa; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .invited-name { font-weight: 500; color: #333; }
        .invited-status { font-size: 0.98em; font-weight: 500; }
        .status-done { color: #2eaf4a; }
        .status-pending { color: #c33; }
        .back-btn { margin-top: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 10px; padding: 14px 28px; font-size: 1em; font-weight: 500; cursor: pointer; transition: background 0.2s; width: 100%; }
        .back-btn:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
    </style>
</head>
<body>
    <div class="container">
        <div class="title" id="referralTitle">Реферальная программа</div>
        <div class="ref-code-block">
            <div class="ref-code-label" id="refCodeLabel">Ваш реферальный код:</div>
            <div class="ref-code-value" id="inviteCode">...</div>
            <div class="ref-link-block">
                <span class="ref-link" id="refLink">...</span>
                <button class="copy-btn" onclick="copyRefLink()" id="copyBtn">Копировать</button>
            </div>
        </div>
        <div class="ref-terms" id="refTerms">Загрузка условий...</div>
        <div class="invited-list">
            <div class="invited-title" id="invitedTitle">Приглашённые пользователи:</div>
            <div id="invitedUsers">Загрузка...</div>
        </div>
        <button class="back-btn" onclick="goToProfile()" id="backBtn">Назад в профиль</button>
    </div>
    <script>
        let currentLanguage = 'ru';

        // Получаем данные пользователя
        function getUserData() {
            let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                return tg.initDataUnsafe.user;
            }
            try {
                const stored = localStorage.getItem('aaadviser_user');
                if (stored) return JSON.parse(stored);
            } catch (e) {}
            return null;
        }

        // Локализации
        const locales = {
            'ru': {
                'referralTitle': 'Реферальная программа',
                'refCodeLabel': 'Ваш реферальный код:',
                'copyBtn': 'Копировать',
                'backBtn': 'Назад в профиль',
                'invitedTitle': 'Приглашённые пользователи:',
                'loading': 'Загрузка...',
                'loadingTerms': 'Загрузка условий...',
                'userNotDefined': 'Пользователь не определён',
                'openFromTelegram': 'Пожалуйста, откройте WebApp из Telegram.',
                'errorLoadingTerms': 'Ошибка загрузки условий.',
                'noInvitedUsers': 'Пока нет приглашённых пользователей.',
                'completed': 'Выполнил',
                'notCompleted': 'Не выполнил',
                'linkCopied': 'Ссылка скопирована!',
                'copyError': 'Ошибка копирования'
            },
            'en': {
                'referralTitle': 'Referral Program',
                'refCodeLabel': 'Your referral code:',
                'copyBtn': 'Copy',
                'backBtn': 'Back to Profile',
                'invitedTitle': 'Invited users:',
                'loading': 'Loading...',
                'loadingTerms': 'Loading terms...',
                'userNotDefined': 'User not defined',
                'openFromTelegram': 'Please open WebApp from Telegram.',
                'errorLoadingTerms': 'Error loading terms.',
                'noInvitedUsers': 'No invited users yet.',
                'completed': 'Completed',
                'notCompleted': 'Not completed',
                'linkCopied': 'Link copied!',
                'copyError': 'Copy error'
            },
            'de': {
                'referralTitle': 'Empfehlungsprogramm',
                'refCodeLabel': 'Ihr Empfehlungscode:',
                'copyBtn': 'Kopieren',
                'backBtn': 'Zurück zum Profil',
                'invitedTitle': 'Eingeladene Benutzer:',
                'loading': 'Laden...',
                'loadingTerms': 'Bedingungen laden...',
                'userNotDefined': 'Benutzer nicht definiert',
                'openFromTelegram': 'Bitte öffnen Sie WebApp aus Telegram.',
                'errorLoadingTerms': 'Fehler beim Laden der Bedingungen.',
                'noInvitedUsers': 'Noch keine eingeladenen Benutzer.',
                'completed': 'Abgeschlossen',
                'notCompleted': 'Nicht abgeschlossen',
                'linkCopied': 'Link kopiert!',
                'copyError': 'Kopierfehler'
            },
            'fr': {
                'referralTitle': 'Programme de parrainage',
                'refCodeLabel': 'Votre code de parrainage:',
                'copyBtn': 'Copier',
                'backBtn': 'Retour au profil',
                'invitedTitle': 'Utilisateurs invités:',
                'loading': 'Chargement...',
                'loadingTerms': 'Chargement des conditions...',
                'userNotDefined': 'Utilisateur non défini',
                'openFromTelegram': 'Veuillez ouvrir WebApp depuis Telegram.',
                'errorLoadingTerms': 'Erreur de chargement des conditions.',
                'noInvitedUsers': 'Aucun utilisateur invité pour le moment.',
                'completed': 'Terminé',
                'notCompleted': 'Non terminé',
                'linkCopied': 'Lien copié!',
                'copyError': 'Erreur de copie'
            },
            'tr': {
                'referralTitle': 'Referans Programı',
                'refCodeLabel': 'Referans kodunuz:',
                'copyBtn': 'Kopyala',
                'backBtn': 'Profile Dön',
                'invitedTitle': 'Davet edilen kullanıcılar:',
                'loading': 'Yükleniyor...',
                'loadingTerms': 'Şartlar yükleniyor...',
                'userNotDefined': 'Kullanıcı tanımlanmadı',
                'openFromTelegram': 'Lütfen WebApp\'i Telegram\'dan açın.',
                'errorLoadingTerms': 'Şartlar yüklenirken hata.',
                'noInvitedUsers': 'Henüz davet edilen kullanıcı yok.',
                'completed': 'Tamamlandı',
                'notCompleted': 'Tamamlanmadı',
                'linkCopied': 'Bağlantı kopyalandı!',
                'copyError': 'Kopyalama hatası'
            }
        };

        // Функция для получения локализованного текста
        function getText(key) {
            const locale = locales[currentLanguage] || locales['ru'];
            return locale[key] || key;
        }

        // Обновление текста на странице
        function updatePageText() {
            document.getElementById('referralTitle').textContent = getText('referralTitle');
            document.getElementById('refCodeLabel').textContent = getText('refCodeLabel');
            document.getElementById('copyBtn').textContent = getText('copyBtn');
            document.getElementById('backBtn').textContent = getText('backBtn');
            document.getElementById('invitedTitle').textContent = getText('invitedTitle');
        }

        // Инициализация
        function init() {
            const userData = getUserData();
            if (userData && userData.language_code) {
                currentLanguage = userData.language_code;
            }
            updatePageText();
        }

        function goToProfile() {
            window.location.href = '/webapp_profile';
        }
        function copyRefLink() {
            const refLink = document.getElementById('refLink').textContent;
            navigator.clipboard.writeText(refLink).then(() => {
                alert(getText('linkCopied'));
            }, () => {
                alert(getText('copyError'));
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (tg) { tg.ready(); tg.expand && tg.expand(); }
            let userData = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
            if (!userData) {
                try { userData = JSON.parse(localStorage.getItem('aaadviser_user')); } catch (e) { userData = null; }
            }
            if (!userData || !userData.id) {
                document.getElementById('inviteCode').textContent = getText('userNotDefined');
                document.getElementById('refLink').textContent = '-';
                document.getElementById('refTerms').textContent = getText('openFromTelegram');
                document.getElementById('invitedUsers').textContent = '-';
                return;
            }
            fetch('/api/referral_info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegram_id: userData.id })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('inviteCode').textContent = data.invite_code || '-';
                document.getElementById('refLink').textContent = data.bot_link || '-';
                document.getElementById('refTerms').textContent = data.referral_terms || '-';
                if (Array.isArray(data.invited) && data.invited.length > 0) {
                    document.getElementById('invitedUsers').innerHTML = data.invited.map(u =>
                        `<div class='invited-item'><span class='invited-name'>${u.tg_name || u.username || u.telegram_id}</span><span class='invited-status ${u.completed ? 'status-done' : 'status-pending'}'>${u.completed ? getText('completed') : getText('notCompleted')}</span></div>`
                    ).join('');
                } else {
                    document.getElementById('invitedUsers').textContent = getText('noInvitedUsers');
                }
            })
            .catch(() => {
                document.getElementById('inviteCode').textContent = '-';
                document.getElementById('refLink').textContent = '-';
                document.getElementById('refTerms').textContent = getText('errorLoadingTerms');
                document.getElementById('invitedUsers').textContent = '-';
            });
        });
    </script>
</body>
</html> 