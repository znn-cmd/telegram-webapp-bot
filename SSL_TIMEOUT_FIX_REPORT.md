# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL timeout –≤ —Å–∏—Å—Ç–µ–º–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏ `'city_id'` –ø–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞:
```
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫—ç—à–∞: _ssl.c:999: The handshake operation timed out
```

### –ü—Ä–∏—á–∏–Ω–∞ SSL timeout

1. **–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤**: –§—É–Ω–∫—Ü–∏—è `refresh_locations_cache()` –¥–µ–ª–∞–ª–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞—É–∑**: –ó–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫, —á—Ç–æ –º–æ–≥–ª–æ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å SSL —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
3. **–ë–æ–ª—å—à–æ–π –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π (—Å—Ç—Ä–∞–Ω—ã ‚Üí –≥–æ—Ä–æ–¥–∞ ‚Üí –æ–±–ª–∞—Å—Ç–∏ ‚Üí —Ä–∞–π–æ–Ω—ã) —Ç—Ä–µ–±–æ–≤–∞–ª–æ –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**: –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Supabase –º–æ–≥–ª–æ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ —Ç–∞–π–º–∞—É—Ç–∞–º SSL

## –†–µ—à–µ–Ω–∏–µ

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

**–î–æ–±–∞–≤–ª–µ–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è:**
- ‚úÖ –ü–∞—É–∑—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (`time.sleep()`)
- ‚úÖ –õ—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å `continue` –≤–º–µ—Å—Ç–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤ –ª–æ–≥–∞—Ö
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —ç—Ç–∞–ø—ã —Å –ø–∞—É–∑–∞–º–∏ –º–µ–∂–¥—É –Ω–∏–º–∏

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ endpoint

**–ù–æ–≤—ã–π endpoint**: `/api/cache/refresh_simple`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞ (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- ‚úÖ –ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞
- ‚úÖ –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–µ—Ç–µ–≤—ã–º –ø—Ä–æ–±–ª–µ–º–∞–º
- ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ `webapp_admin.html`:**
```javascript
// –ë—ã–ª–æ
fetch('/api/cache/refresh', ...)

// –°—Ç–∞–ª–æ  
fetch('/api/cache/refresh_simple', ...)
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

```python
def refresh_countries_and_cities_only():
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∫–µ—à —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤ (–±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ)"""
    
    # 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω—ã –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
    result = supabase.table('locations').select('country_id, country_name').not_.is_('country_id', 'null').execute()
    
    # 2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏ –∫–µ—à–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω—ã
    countries = process_and_cache_countries(result.data)
    
    # 3. –û–±–Ω–æ–≤–ª—è–µ–º –≥–æ—Ä–æ–¥–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω—ã —Å –ø–∞—É–∑–∞–º–∏
    for country_id in unique_countries:
        cities_result = supabase.table('locations').select('city_id, city_name').eq('country_id', country_id).execute()
        process_and_cache_cities(country_id, cities_result.data)
        time.sleep(0.3)  # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
```

### –ü–∞—É–∑—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

- **–ú–µ–∂–¥—É —ç—Ç–∞–ø–∞–º–∏**: 0.5 —Å–µ–∫—É–Ω–¥—ã
- **–ú–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∞–º–∏**: 0.3 —Å–µ–∫—É–Ω–¥—ã  
- **–ú–µ–∂–¥—É –≥–æ—Ä–æ–¥–∞–º–∏**: 0.1 —Å–µ–∫—É–Ω–¥—ã
- **–ú–µ–∂–¥—É –æ–±–ª–∞—Å—Ç—è–º–∏**: 0.1 —Å–µ–∫—É–Ω–¥—ã

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```python
try:
    # –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    result = supabase.table('locations').select(...).execute()
except Exception as e:
    logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    continue  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Å–ª–µ–¥—É—é—â–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. **–°–∫–æ—Ä–æ—Å—Ç—å**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ = –º–µ–Ω—å—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å SSL timeout
3. **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å**: –°—Ç—Ä–∞–Ω—ã –∏ –≥–æ—Ä–æ–¥–∞ - —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
4. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**: –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–æ–π, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```
üîÑ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞...
üßπ –û—á–∏—â–µ–Ω–æ 0 –∫–ª—é—á–µ–π –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –∫—ç—à–∞
üåç –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å—Ç—Ä–∞–Ω...
‚úÖ –ö—ç—à —Å—Ç—Ä–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω: 2 —Å—Ç—Ä–∞–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
üèôÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –≥–æ—Ä–æ–¥–æ–≤...
üìä –ù–∞–π–¥–µ–Ω–æ 2 —Å—Ç—Ä–∞–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤
‚úÖ –ö—ç—à –≥–æ—Ä–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Å—Ç—Ä–∞–Ω—ã 1: 8 –≥–æ—Ä–æ–¥–æ–≤ (1/2)
‚úÖ –ö—ç—à –≥–æ—Ä–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Å—Ç—Ä–∞–Ω—ã 2: 17 –≥–æ—Ä–æ–¥–æ–≤ (2/2)
üéâ –ü—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
```

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- **`app.py`**: 
  - –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `refresh_locations_cache()` (—Å—Ç—Ä–æ–∫–∏ 10939-11134)
  - –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π endpoint `/api/cache/refresh_simple` (—Å—Ç—Ä–æ–∫–∏ 1131-1218)
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `refresh_countries_and_cities_only()` (—Å—Ç—Ä–æ–∫–∏ 1149-1218)

- **`webapp_admin.html`**: 
  - –ò–∑–º–µ–Ω–µ–Ω URL –∑–∞–ø—Ä–æ—Å–∞ —Å `/api/cache/refresh` –Ω–∞ `/api/cache/refresh_simple` (—Å—Ç—Ä–æ–∫–∞ 226)

## –°—Ç–∞—Ç—É—Å

‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ**

–¢–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ "üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–µ—à" –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π –ø—Ä–æ—Å—Ç–æ–π endpoint, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ SSL timeout –æ—à–∏–±–æ–∫ –∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–µ—à —Å—Ç—Ä–∞–Ω –∏ –≥–æ—Ä–æ–¥–æ–≤.
