# Обновление таблицы "Детальные данные трендов"

## Описание изменений

Обновлена логика работы таблицы "Детальные данные трендов" в файле `webapp_object_evaluation.html` и API endpoint в `api_server.py` для корректного расчета цен текущего месяца.

## Основные изменения

### 1. API Endpoint (`/api/property_data/average_prices`)

**Файл:** `api_server.py`

- **Улучшена SQL логика:** Теперь корректно рассчитываются средние цены как среднее арифметическое между минимальной и максимальной ценой из всех таблиц данных
- **Добавлена проверка данных:** Фильтрация только валидных цен (> 0) перед расчетом
- **Улучшено логирование:** Добавлена информация о методе расчета
- **Возвращается дополнительная информация:** Метод расчета включен в ответ API

**Структура SQL запроса:**
```sql
WITH all_sale_prices AS (
    -- Цены продажи из всех таблиц (age_data, floor_segment_data, heating_data, house_type_data)
    SELECT min_unit_price_for_sale, max_unit_price_for_sale
    FROM age_data WHERE country_id = ? AND city_id = ? AND county_id = ? AND district_id = ?
    AND min_unit_price_for_sale > 0 AND max_unit_price_for_sale > 0
    
    UNION ALL
    -- ... аналогично для других таблиц
),
all_rent_prices AS (
    -- Цены аренды из всех таблиц
    SELECT min_unit_price_for_rent, max_unit_price_for_rent
    FROM age_data WHERE country_id = ? AND city_id = ? AND county_id = ? AND district_id = ?
    AND min_unit_price_for_rent > 0 AND max_unit_price_for_rent > 0
    
    UNION ALL
    -- ... аналогично для других таблиц
)
SELECT 
    (AVG(min_sale) + AVG(max_sale)) / 2 as avg_sale_price,
    (AVG(min_rent) + AVG(max_rent)) / 2 as avg_rent_price
FROM all_sale_prices, all_rent_prices
```

### 2. Функция `getAveragePricesFromDataTables()`

**Файл:** `webapp_object_evaluation.html`

- **Добавлена дополнительная информация:** Возвращается метод расчета цен
- **Улучшено логирование:** Добавлена информация о методе расчета в консоль

### 3. Функция `generateTrendsTable()`

**Файл:** `webapp_object_evaluation.html`

- **Улучшена логика проверки:** Добавлена проверка валидности полученных средних цен
- **Добавлена информационная строка:** Показывает, когда используются рассчитанные средние цены
- **Улучшено логирование:** Добавлена информация о том, какие цены используются для текущего месяца

### 4. CSS стили

**Файл:** `webapp_object_evaluation.html`

- **Добавлены стили для информационной строки:** `.calculation-info` для отображения информации о методе расчета цен

## Логика работы

### Расчет цен для текущего месяца

1. **Определение текущего месяца:** Система определяет текущий месяц и год
2. **Получение средних цен:** Вызывается API endpoint для получения средних цен из всех таблиц данных
3. **Расчет средних цен:** API рассчитывает средние цены как среднее арифметическое между минимальной и максимальной ценой из всех таблиц:
   - `age_data`
   - `floor_segment_data` 
   - `heating_data`
   - `house_type_data`
4. **Применение к таблице:** Для строки текущего месяца используются рассчитанные средние цены вместо данных из трендов
5. **Визуальное выделение:** Текущий месяц выделяется синим фоном и информационной строкой

### Отображение в таблице

- **Текущий месяц:** Выделяется синим фоном (`#e8f4fd`)
- **Информационная строка:** Показывает метод расчета цен текущего месяца
- **Остальные месяцы:** Отображаются без изменений с данными из трендов

## Тестирование

Создан тестовый скрипт `test_average_prices.py` для проверки работы API endpoint:

```bash
python test_average_prices.py
```

## Результат

Теперь таблица "Детальные данные трендов" корректно:

1. ✅ Рассчитывает цены продажи и аренды текущего месяца как среднее арифметическое между минимальной и максимальной ценой из всех таблиц данных
2. ✅ Отображает информацию о методе расчета для пользователя
3. ✅ Сохраняет все остальные данные без изменений
4. ✅ Визуально выделяет текущий месяц и метод расчета

## Файлы изменений

- `api_server.py` - улучшен API endpoint
- `webapp_object_evaluation.html` - обновлена логика таблицы трендов
- `test_average_prices.py` - тестовый скрипт (новый файл)
- `TRENDS_TABLE_UPDATE_SUMMARY.md` - данная документация (новый файл)
