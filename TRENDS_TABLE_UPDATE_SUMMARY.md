# Обновление таблицы "Детальные данные трендов"

## Описание изменений

Обновлена логика отображения таблицы "Детальные данные трендов" в файле `webapp_object_evaluation.html`. Теперь для текущего месяца цены продажи и аренды рассчитываются как средние значения из глобальных переменных, а для исторических месяцев отображаются ВСЕ доступные данные без ограничений.

## Детали изменений

### 1. Обновлена функция `generateTrendsTable`

- **Приоритет глобальных переменных**: Сначала пытаемся получить средние цены из глобальных переменных `window.avgMinSalePrice`, `window.avgMaxSalePrice`, `window.avgMinRentPrice`, `window.avgMaxRentPrice`
- **Fallback на API**: Если глобальные переменные недоступны, используем API эндпоинт `/api/property_data/average_prices`
- **Расчет средних цен**: Для текущего месяца цены рассчитываются как `(avgMin + avgMax) / 2`

### 2. Полностью переработана функция `filterTrendsByDateRange`

- **Обновлены ограничения по диапазону месяцев**: Теперь отображаем 24 месяца назад вместо 6 месяцев назад
- **Отображение расширенных исторических данных**: Теперь отображаются тренды за 24 месяца назад (2 года истории)
- **Новая логика категоризации**:
  - **Будущие месяцы**: Все месяцы после текущего (включая следующий год)
  - **Текущий месяц**: Текущий месяц + 1 месяц вперед
  - **Исторические месяцы**: ВСЕ данные за предыдущие годы без ограничений

### 3. Улучшено определение текущего месяца

- **Использование поля `date`**: Вместо полей `property_year` и `property_month` используется поле `date` для корректного определения текущего месяца
- **Логика определения**: Тренд считается текущим месяцем, если его год и месяц совпадают с текущей датой

### 4. Добавлено логирование для отладки

- **Логирование глобальных переменных**: Выводится информация о доступности и значениях глобальных переменных
- **Логирование обновления цен**: При обновлении цен для текущего месяца выводится детальная информация
- **Логирование анализа дат**: Показывается процесс определения текущего месяца для каждого тренда
- **Логирование категоризации**: Отображается разбивка трендов по категориям

## Формулы расчета

### Цена продажи для текущего месяца
```
avgSalePrice = Math.round((avgMinSalePrice + avgMaxSalePrice) / 2)
```

### Цена аренды для текущего месяца
```
avgRentPrice = Math.round((avgMinRentPrice + avgMaxRentPrice) / 2)
```

## Новая логика работы

### До изменений:
- Отображались только тренды за текущий год
- Ограничение: 24 месяца назад + 1 месяц вперед
- Максимум 8 трендов
- Исторические данные за предыдущие годы не отображались

### После изменений:
- Отображаются тренды за текущий год
- Ограничение: 24 месяца назад + 1 месяц вперед
- Максимум 25 трендов
- Исторические данные за предыдущие годы отображаются в рамках 24-месячного диапазона

### После изменений:
1. **Исторические месяцы**: Отображаются данные за 24 месяца назад от текущего месяца (старые сначала)
2. **Текущий месяц**: Отображается текущий месяц + 1 месяц вперед (с обновленными ценами)
3. **Будущие месяцы**: Отображаются все месяцы после текущего (новые сначала)
4. **Ограничение по диапазону**: Отображается максимум 25 трендов (24 месяца назад + текущий + 1 вперед)
5. **Правильный порядок**: Исторические (старые сначала) → Текущий месяц → Будущие (новые сначала)

## Файлы изменений

- `webapp_object_evaluation.html` - основная логика таблицы трендов
- `test_trends_calculation.html` - обновленный тестовый файл для проверки новой логики

## Тестирование

Обновлен тестовый файл `test_trends_calculation.html` для проверки:
- Глобальных переменных
- Расчетов средних цен
- Новой логики фильтрации (все исторические данные)
- Отображения данных трендов с новой логикой

## Результат

Теперь таблица "Детальные данные трендов" корректно отображает:

- **ВСЕ исторические данные** за предыдущие годы без ограничений
- **Обновленные цены для текущего месяца** на основе средних значений
- **Прогнозные данные** без изменений
- **Правильный порядок отображения**:
  - Исторические данные (старые годы/месяцы сначала)
  - Текущий месяц (с обновленными ценами)
  - Будущие данные (новые годы/месяцы сначала)
- **Визуальное выделение**:
  - Текущий месяц: синий фон (`#e8f4fd`)
  - Будущие месяцы: светло-синий фон (`#f0f8ff`)
  - Исторические месяцы: серый фон (`#f9f9f9`)
- **Нет ограничений по количеству** отображаемых трендов

## Преимущества новой логики

1. **Расширенная история**: Пользователи видят тренды за 24 месяца назад (2 года истории)
2. **Актуальность**: Текущий месяц использует реальные средние цены из данных
3. **Прогнозирование**: Будущие месяцы отображаются корректно
4. **Оптимизированная производительность**: Ограничение в 25 трендов обеспечивает быструю загрузку
5. **Прозрачность**: Четкое разделение на категории с визуальным выделением
