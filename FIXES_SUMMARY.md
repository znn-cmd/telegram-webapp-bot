# –†–µ–∑—é–º–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç –≤ –±–∞–∑—É
**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `currency` - –æ—à–∏–±–∫–∞ `duplicate key value violates unique constraint "currency_pkey"`

**–†–µ—à–µ–Ω–∏–µ**: 
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
- –£–±—Ä–∞–Ω–æ –ø–æ–ª–µ `id` –∏–∑ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏, —á—Ç–æ–±—ã Supabase —Å–∞–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –µ–≥–æ
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- **–ù–û–í–û–ï**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª**: `currency_functions.py`

### 2. –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞
**–ü—Ä–æ–±–ª–µ–º–∞**: `'list' object has no attribute 'get'` –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö —Ä—ã–Ω–∫–∞

**–ü—Ä–∏—á–∏–Ω–∞**: –§—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä—ã–Ω–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ `None` –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–µ–∫—Ü–∏–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–∞–º –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—ã–∑–≤–∞—Ç—å `.get()` –Ω–∞ `None`

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ `None` –¥–ª—è –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π –¥–∞–Ω–Ω—ã—Ö —Ä—ã–Ω–∫–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–∞—Ç –≤ `trend_date` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ `None`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π `None` –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–µ–∫—Ü–∏–π
- **–ù–û–í–û–ï**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ `market_data` (—Å–ø–∏—Å–æ–∫ vs —Å–ª–æ–≤–∞—Ä—å)
- **–ù–û–í–û–ï**: –î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

**–§–∞–π–ª**: `app.py` - —Ñ—É–Ω–∫—Ü–∏—è `get_market_data_by_location_ids` –∏ `format_simple_report`

### 3. –ù–û–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: RLS –ø–æ–ª–∏—Ç–∏–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—Ç–∞–≤–∫—É –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç
**–ü—Ä–æ–±–ª–µ–º–∞**: `new row violates row-level security policy for table "currency"`

**–ü—Ä–∏—á–∏–Ω–∞**: –í Supabase –≤–∫–ª—é—á–µ–Ω–∞ RLS (Row Level Security) –ø–æ–ª–∏—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—Ç–∞–≤–∫—É –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω fallback –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–µ—Ç—Å—è
- –ü—Ä–∏ –æ—à–∏–±–∫–µ RLS –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É
- –û—Ç—á–µ—Ç –≤—Å–µ —Ä–∞–≤–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –∫—É—Ä—Å–∞–º–∏

**–§–∞–π–ª**: `currency_functions.py`

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ**: –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `RLS_FIX_INSTRUCTIONS.md` —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é RLS –ø–æ–ª–∏—Ç–∏–∫–∏

### 4. –ù–û–í–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ID –≤ —Ç–∞–±–ª–∏—Ü–µ currency
**–ü—Ä–æ–±–ª–µ–º–∞**: `Key (id)=(39) already exists` - –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–º

**–ü—Ä–∏—á–∏–Ω–∞**: –¢–∞–±–ª–∏—Ü–∞ `currency` –∏–º–µ–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é ID

**–†–µ—à–µ–Ω–∏–µ**:
- –°–æ–∑–¥–∞–Ω SQL —Å–∫—Ä–∏–ø—Ç `fix_currency_sequence.sql` –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π

## –î–µ—Ç–∞–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –í `currency_functions.py`:
```python
# –£–±–∏—Ä–∞–µ–º –ø–æ–ª–µ id –∏–∑ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã Supabase —Å–∞–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –µ–≥–æ
if 'id' in currency_data:
    del currency_data['id']

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
check_query = supabase.table('currency').select('*').gte('created_at', f'{date_str} 00:00:00').lt('created_at', f'{date_str} 23:59:59').order('created_at', desc=True).limit(1)
check_result = check_query.execute()
if check_result.data and len(check_result.data) > 0:
    logger.info(f"‚úÖ –ó–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ—ë: {check_result.data[0]}")
    return check_result.data[0]

# Fallback –¥–ª—è RLS –æ—à–∏–±–æ–∫
if 'row-level security policy' in str(insert_error):
    logger.warning("üîí –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫–∏...")
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É
    return currency_data
```

### –í `app.py`:
```python
# –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ format_simple_report
logger.info(f"üîç –û—Ç–ª–∞–¥–∫–∞ –ø–µ—Ä–µ–¥ format_simple_report:")
logger.info(f"  - market_data: {type(market_data)} = {market_data}")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
if market_data is None:
    market_data = {}
elif isinstance(market_data, list):
    logger.warning(f"‚ö†Ô∏è market_data —è–≤–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–∫–æ–º, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ª–æ–≤–∞—Ä—å: {market_data}")
    market_data = {}

# –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏
valid_records = [r for r in result.data if r.get('trend_date')]
if valid_records:
    # –ë–µ—Ä–µ–º —Å–∞–º—É—é —Å–≤–µ–∂—É—é –∑–∞–ø–∏—Å—å
    latest_record = max(valid_records, key=lambda x: x.get('trend_date', ''))
    # ...
else:
    logger.warning("–í—Å–µ –∑–∞–ø–∏—Å–∏ –∏–º–µ—é—Ç –ø—É—Å—Ç—ã–µ –¥–∞—Ç—ã")
    market_data['section'] = result.data[0] if result.data else None
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –í—Å–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã  
‚úÖ –õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—É—Ä—Å–∞ –≤–∞–ª—é—Ç —É–ª—É—á—à–µ–Ω–∞  
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä—ã–Ω–∫–∞ —Å—Ç–∞–ª–∞ –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤–æ–π –∫ –æ—à–∏–±–∫–∞–º  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω fallback –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è RLS –æ—à–∏–±–æ–∫  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è market_data  
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  
‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç—ã –±–µ–∑ –æ—à–∏–±–æ–∫  

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û**: –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL –∫–æ–º–∞–Ω–¥—É –≤ Supabase –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è RLS:
   ```sql
   ALTER TABLE currency DISABLE ROW LEVEL SECURITY;
   ```
2. **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û**: –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç `fix_currency_sequence.sql` –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞ —Å —Ç—É—Ä–µ—Ü–∫–∏–º –∞–¥—Ä–µ—Å–æ–º
5. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É

## –§–∞–π–ª—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `RLS_FIX_INSTRUCTIONS.md` - –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ RLS
- `fix_currency_rls.sql` - SQL —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è RLS
- `fix_currency_sequence.sql` - SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ 