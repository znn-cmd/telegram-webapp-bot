# Обновление блока "Анализ динамики цен"

## Описание изменений

Внесены изменения для переименования блока "Анализ цен на рынке" в "Анализ динамики цен" и реализации функционала для получения данных о динамике цен из таблицы `property_trends` с построением графика и прогнозом.

## Основные изменения

### 1. Переименование блока

- **Файл**: `webapp_full_report.html`
- **Изменение**: Блок "Анализ цен на рынке" переименован в "Анализ динамики цен"
- **Причина**: Более точное отражение функционала анализа трендов цен

### 2. Обновление содержимого блока

#### 2.1 Новые поля для отображения
- **Тренд цен**: Общее направление изменения цен (Растущий/Падающий/Стабильный)
- **Изменение за 3 года**: Процент изменения цены за последние 3 года
- **Прогноз на 3 месяца**: Прогнозируемое изменение цены на ближайшие 3 месяца

#### 2.2 График динамики цен
- **Canvas элемент**: Интеграция с Chart.js для построения графиков
- **Период анализа**: 3 года назад + прогноз на 3 месяца вперед
- **Тип графика**: Линейный график с заливкой

#### 2.3 Анализ тренда
- **Анализ тренда**: Детальное описание текущей ситуации с ценами
- **Рекомендация**: Практические советы на основе анализа

### 3. Новые CSS стили

#### 3.1 Стили для графика
```css
.price-chart-container {
    background: white;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #e9ecef;
}
```

#### 3.2 Стили для анализа тренда
```css
.trend-item {
    margin-bottom: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}
```

### 4. Интеграция с Chart.js

- **CDN**: Подключение Chart.js для построения графиков
- **Адаптивность**: График автоматически подстраивается под размер экрана
- **Интерактивность**: Поддержка hover эффектов и легенды

### 5. Новые JavaScript функции

#### 5.1 `loadPriceTrendsData()`
- Асинхронная загрузка данных о трендах цен
- Вызов API endpoint `/api/price_trends`
- Обработка ошибок и отображение статуса

#### 5.2 `fillPriceTrendsData()`
- Заполнение HTML элементов данными о трендах
- Форматирование процентов с учетом знака
- Обработка отсутствующих данных

#### 5.3 `buildPriceChart()`
- Построение графика на основе полученных данных
- Уничтожение предыдущего графика при обновлении
- Настройка внешнего вида и осей

### 6. Новые Python функции

#### 6.1 `get_price_trends_data()`
- Основная функция получения данных о трендах
- Запрос к таблице `property_trends`
- Фильтрация по локации и периоду

#### 6.2 `analyze_price_trend()`
- Анализ тренда на основе линейной регрессии
- Определение направления тренда (растущий/падающий/стабильный)
- Формирование рекомендаций

#### 6.3 `calculate_3year_change()`
- Вычисление изменения цены за 3 года в процентах
- Сравнение первой и последней цены в периоде

#### 6.4 `calculate_3month_forecast()`
- Прогноз изменения цены на 3 месяца вперед
- Экстраполяция тренда на основе последних данных

#### 6.5 `format_chart_data()`
- Форматирование данных для отображения на графике
- Подготовка меток и значений

### 7. Новый API endpoint

#### 7.1 `/api/price_trends`
- **Метод**: POST
- **Параметры**: `location_codes`, `area`
- **Возвращает**: Данные о трендах цен, анализ и данные для графика

### 8. Логика работы с данными

#### 8.1 Источник данных
- **Таблица**: `property_trends`
- **Поля**: `country_id`, `city_id`, `county_id`, `district_id`, `property_year`, `property_month`, `unit_price_for_sale`

#### 8.2 Период анализа
- **Исторические данные**: 3 года назад до текущего момента
- **Прогноз**: 3 месяца вперед
- **Частота**: По месяцам

#### 8.3 Расчеты
- **Общая цена объекта**: `unit_price_for_sale * area`
- **Тренд**: Линейная регрессия по всем точкам
- **Изменение за 3 года**: `(последняя_цена - первая_цена) / первая_цена * 100`
- **Прогноз**: Экстраполяция тренда на 3 месяца

## Технические детали

### Структура данных API

```json
{
    "trend": "Растущий",
    "change_3y": 15.5,
    "forecast_3m": 2.1,
    "analysis": "Цены демонстрируют устойчивый рост",
    "recommendation": "Рекомендуется покупка в ближайшее время",
    "chart_data": [
        {
            "year": 2021,
            "month": 1,
            "unit_price": 1500,
            "total_price": 82500,
            "label": "01/2021"
        }
    ],
    "raw_data_count": 36
}
```

### Алгоритм анализа тренда

1. **Сбор данных**: Получение цен за последние 3 года
2. **Линейная регрессия**: Вычисление коэффициента наклона
3. **Классификация тренда**:
   - `|slope| < 1% от средней цены` → Стабильный
   - `slope > 0` → Растущий
   - `slope < 0` → Падающий
4. **Формирование рекомендаций** на основе тренда

### Обработка ошибок

- **Отсутствие кодов локации**: Возврат ошибки с описанием
- **Недостаток данных**: Минимум 2 точки для анализа тренда
- **Ошибки базы данных**: Логирование и возврат fallback данных

## Файлы изменений

1. **`webapp_full_report.html`** - обновление HTML и CSS, добавление JavaScript функций
2. **`price_trends_functions.py`** - новые функции для анализа трендов (новый файл)
3. **`app.py`** - добавление API endpoint `/api/price_trends`
4. **`PRICE_TRENDS_ANALYSIS_UPDATE.md`** - документация по изменениям (новый файл)

## Статус

✅ **Завершено**: Переименование блока в "Анализ динамики цен"  
✅ **Завершено**: Обновление содержимого блока  
✅ **Завершено**: Добавление CSS стилей для графика и анализа  
✅ **Завершено**: Интеграция с Chart.js  
✅ **Завершено**: JavaScript функции для работы с трендами  
✅ **Завершено**: Python функции для анализа данных  
✅ **Завершено**: API endpoint для получения трендов  
✅ **Завершено**: Создание документации  

## Тестирование

Рекомендуется протестировать:

1. **API endpoint**: `/api/price_trends` с различными параметрами
2. **Отображение графика**: Проверка корректности построения
3. **Анализ трендов**: Проверка логики классификации трендов
4. **Обработка ошибок**: Тестирование с некорректными данными
5. **Адаптивность**: Проверка на различных размерах экранов

## Пример использования

```javascript
// Загрузка данных о трендах
const trendsData = await fetch('/api/price_trends', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        location_codes: { country_id: 1, city_id: 2, county_id: 3, district_id: 4 },
        area: 55
    })
});

const trends = await trendsData.json();
console.log('Тренд:', trends.trend);
console.log('Изменение за 3 года:', trends.change_3y + '%');
```
