<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/i18n-manager.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-title="reports.full_report">Полный отчет - Aaadviser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px 25px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #495057;
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h3 {
            color: #6c757d;
            font-size: 18px;
            margin-bottom: 15px;
            margin-top: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }

        .highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .highlight h3 {
            color: white;
            margin-bottom: 15px;
        }

        .highlight .value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .highlight .description {
            opacity: 0.9;
            font-size: 14px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            margin: 20px 0;
        }

        .chart-placeholder {
            height: 200px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 16px;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 150px;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #721c24;
            text-align: center;
        }

        .additional-data-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .price-comparison-section {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .price-comparison-section h3 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }

        .comparison-item, .final-comparison, .price-conclusion {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .comparison-label, .conclusion-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .comparison-values, .conclusion-value {
            color: #333;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.4;
        }

        .final-comparison {
            background: #e8f4fd;
            border-left-color: #17a2b8;
        }

        .price-conclusion {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .currency-info {
            background: #fff3e0;
            border-left-color: #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Стили для анализа динамики цен */
        .price-chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .price-chart-container h3 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        .trend-analysis {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .trend-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .trend-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .trend-value {
            color: #333;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.4;
        }
        
        /* Компактные стили для блока "Информация об объекте" */
        .section.object-info {
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .section.object-info h2 {
            font-size: 20px;
            margin-bottom: 15px;
            gap: 8px;
        }
        
        .section.object-info h2::before {
            font-size: 18px;
        }
        
        .section.object-info .info-grid {
            gap: 12px;
            margin-bottom: 15px;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        
        /* На больших экранах делаем более компактное расположение */
        @media (min-width: 1200px) {
            .section.object-info .info-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
        }
        
        /* На очень больших экранах делаем 5 колонок */
        @media (min-width: 1400px) {
            .section.object-info .info-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }
        }
        
        /* На средних экранах делаем 3 колонки */
        @media (min-width: 768px) and (max-width: 1199px) {
            .section.object-info .info-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
        }
        
        .section.object-info .info-item {
            padding: 12px;
            border-radius: 8px;
        }
        
        .section.object-info .info-label {
            font-size: 12px;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .section.object-info .info-value {
            font-size: 14px;
            line-height: 1.3;
        }
        
        /* Дополнительные компактные стили для значений */
        .section.object-info .info-value:empty::before {
            content: '-';
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 25px 20px;
            }
            
            .content {
                padding: 25px 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .section.object-info {
                padding: 15px;
            }
            
            .section.object-info .info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .section.object-info .info-item {
                padding: 10px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Дополнительные компактные стили для очень маленьких экранов */
        @media (max-width: 480px) {
            .section.object-info {
                padding: 12px;
                margin-bottom: 20px;
            }
            
            .section.object-info h2 {
                font-size: 18px;
                margin-bottom: 12px;
            }
            
            .section.object-info .info-grid {
                gap: 8px;
            }
            
            .section.object-info .info-item {
                padding: 8px;
            }
            
            .section.object-info .info-label {
                font-size: 11px;
                margin-bottom: 3px;
            }
            
            .section.object-info .info-value {
                font-size: 13px;
            }
        }
        
        /* Стили для портретной ориентации на мобильных устройствах */
        @media (max-width: 480px) and (orientation: portrait) {
            .section.object-info .info-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .section.object-info .info-item {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Полный отчет</h1>
            <p>Детальный анализ объекта недвижимости</p>
        </div>

        <div class="content">
            <div id="loading" class="loading">
                <h3>🔄 Формируем полный отчет...</h3>
                <p>Пожалуйста, подождите</p>
            </div>

            <div id="error" class="error" style="display: none;">
                <h3>❌ Ошибка загрузки отчета</h3>
                <p id="error-message">Произошла ошибка при формировании отчета</p>
            </div>

            <div id="report-content" style="display: none;">
                <!-- Основная информация об объекте -->
                <div class="section object-info">
                    <h2>🏠 Информация об объекте</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Адрес</div>
                            <div class="info-value" id="object-address">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Спальни</div>
                            <div class="info-value" id="object-bedrooms">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label" data-i18n="reports.property_price">Цена</div>
                            <div class="info-value" id="object-price">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Возраст объекта</div>
                            <div class="info-value" id="object-age">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Этаж</div>
                            <div class="info-value" id="object-floor">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Отопление</div>
                            <div class="info-value" id="object-heating">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Площадь объекта</div>
                            <div class="info-value" id="object-area">-</div>
                        </div>
                    </div>
                </div>

                <!-- Рыночный анализ -->
                <div class="section">
                    <h2>📊 Рыночный анализ</h2>
                    
                    <!-- Сравнение цен по критериям -->
                    <div class="price-comparison-section">
                        <h3>📊 Сравнение с рыночными ценами</h3>
                        
                        <!-- Возраст объекта -->
                        <div class="comparison-item">
                            <div class="comparison-label">По возрасту объекта:</div>
                            <div class="comparison-values" id="age-comparison">-</div>
                        </div>
                        
                        <!-- Этаж -->
                        <div class="comparison-item">
                            <div class="comparison-label">По этажу:</div>
                            <div class="comparison-values" id="floor-comparison">-</div>
                        </div>
                        
                        <!-- Тип отопления -->
                        <div class="comparison-item">
                            <div class="comparison-label">По типу отопления:</div>
                            <div class="comparison-values" id="heating-comparison">-</div>
                        </div>
                        
                        <!-- Тип дома - УБРАНО по требованию -->
                        
                        <!-- Итоговое сравнение -->
                        <div class="final-comparison">
                            <div class="comparison-label">Итоговое сравнение:</div>
                            <div class="comparison-values" id="final-comparison">-</div>
                        </div>
                        
                        <!-- Вывод по цене -->
                        <div class="price-conclusion">
                            <div class="conclusion-label">Вывод по цене:</div>
                            <div class="conclusion-value" id="price-conclusion">-</div>
                        </div>
                        
                        <!-- Информация о конвертации валют -->
                        <div class="currency-info" id="currency-info" style="display: none;">
                            <div class="info-label">💱 Конвертация валют:</div>
                            <div class="info-value" id="currency-info-value">-</div>
                        </div>
                    </div>
                </div>

                <!-- Анализ динамики цен -->
                <div class="section">
                    <h2>📊 Анализ динамики цен</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Тренд цен</div>
                            <div class="info-value" id="price-trend">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Изменение за 3 года</div>
                            <div class="info-value" id="price-change-3y">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Прогноз на 3 месяца</div>
                            <div class="info-value" id="price-forecast">-</div>
                        </div>
                    </div>
                    
                    <!-- График динамики цен -->
                    <div class="price-chart-container" style="margin-top: 20px;">
                        <h3>📈 График изменения цен</h3>
                        <div class="chart-wrapper">
                            <canvas id="priceChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <!-- Анализ тренда -->
                    <div class="trend-analysis" style="margin-top: 20px;">
                        <div class="trend-item">
                            <div class="trend-label">Анализ тренда:</div>
                            <div class="trend-value" id="trend-analysis">-</div>
                        </div>
                        <div class="trend-item">
                            <div class="trend-label">Рекомендация:</div>
                            <div class="trend-value" id="trend-recommendation">-</div>
                        </div>
                    </div>
                </div>

                <!-- Анализ аренды -->
                <div class="section">
                    <h2>🏠 Анализ аренды</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Максимальная ставка аренды</div>
                            <div class="info-value" id="max-rental-rate">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Годовая доходность</div>
                            <div class="info-value" id="annual-rental-yield">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Рекомендация по аренде</div>
                            <div class="info-value" id="rental-recommendation">-</div>
                        </div>
                    </div>
                </div>

                <!-- ROI анализ -->
                <div class="section">
                    <h2>💰 ROI анализ</h2>
                    
                    <div class="highlight">
                        <h3>Краткосрочная аренда (Airbnb)</h3>
                        <div class="value" id="short-term-income">-</div>
                        <div class="description">Доход в месяц</div>
                    </div>

                    <div class="highlight">
                        <h3>Долгосрочная аренда</h3>
                        <div class="value" id="long-term-income">-</div>
                        <div class="description">Доход в год</div>
                    </div>

                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Рост цены (5 лет)</div>
                            <div class="info-value" id="price-growth">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ROI с арендой</div>
                            <div class="info-value" id="roi-with-rent">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ROI без аренды</div>
                            <div class="info-value" id="roi-without-rent">-</div>
                        </div>
                    </div>
                </div>

                <!-- Альтернативные инвестиции -->
                <div class="section">
                    <h2>📈 Альтернативные инвестиции</h2>
                    <div class="info-grid" id="alternatives-grid">
                        <!-- Альтернативы будут добавлены динамически -->
                    </div>
                </div>

                <!-- Макроэкономические данные -->
                <div class="section">
                    <h2>🌍 Макроэкономические данные</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Инфляция</div>
                            <div class="info-value" id="inflation">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Курс EUR/TRY</div>
                            <div class="info-value" id="eur-try">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Рост ВВП</div>
                            <div class="info-value" id="gdp-growth">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Ставка рефинансирования</div>
                            <div class="info-value" id="refi-rate">-</div>
                        </div>
                    </div>
                </div>

                <!-- Налоги и сборы -->
                <div class="section">
                    <h2>🏛️ Налоги и сборы</h2>
                    <div class="info-grid" id="taxes-grid">
                        <!-- Налоги будут добавлены динамически -->
                    </div>
                </div>

                <!-- Риски и ликвидность -->
                <div class="section">
                    <h2>⚠️ Риски и ликвидность</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label" data-i18n="reports.liquidity">Ликвидность</div>
                            <div class="info-value" id="liquidity">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Район</div>
                            <div class="info-value" id="district">-</div>
                        </div>
                    </div>
                    <div id="risks-list">
                        <!-- Риски будут добавлены динамически -->
                    </div>
                </div>

                <!-- Экономические графики -->
                <div class="section">
                    <h2>📊 Экономические тренды</h2>
                    <div class="chart-container">
                        <div class="chart-placeholder">
                            📈 График экономических показателей
                        </div>
                    </div>
                </div>

                <!-- Кнопки действий -->
                <div class="buttons">
                    <button class="btn btn-primary" onclick="downloadPDF()">
                        📥 Скачать PDF
                    </button>
                    <button class="btn btn-secondary" onclick="saveReport()">
                        💾 Сохранить отчет
                    </button>
                    <button class="btn btn-secondary" onclick="goBack()">
                        ← Назад
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js для построения графиков -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Получаем данные из URL параметров
        const urlParams = new URLSearchParams(window.location.search);
        console.log('🔍 URL параметры:', Object.fromEntries(urlParams));
        
        const reportData = {
            address: urlParams.get('address') || 'Не указано',
            bedrooms: urlParams.get('bedrooms') || 'Не указано',
            price: urlParams.get('price') || 'Не указано',
            age: urlParams.get('age') || 'Не указано',
            floor: urlParams.get('floor') || 'Не указано',
            heating: urlParams.get('heating') || 'Не указано',
            area: urlParams.get('area') || 'Не указано',
            telegram_id: urlParams.get('telegram_id') || '',
            lat: urlParams.get('lat') || '',
            lng: urlParams.get('lng') || '',
            location_codes: JSON.parse(urlParams.get('location_codes') || '{}')
        };
        
        console.log('📋 reportData создан:', reportData);

        // Загружаем полный отчет
        async function loadFullReport() {
            console.log('🚀 Функция loadFullReport вызвана');
            try {
                // Проверяем, что reportData определен
                if (!reportData) {
                    throw new Error('Данные отчета не загружены');
                }
                
                console.log('📋 Данные для загрузки отчета:', reportData);
                
                // Проверяем наличие необходимых элементов DOM
                const loadingElement = document.getElementById('loading');
                const errorElement = document.getElementById('error');
                const reportContentElement = document.getElementById('report-content');
                
                if (!loadingElement || !errorElement || !reportContentElement) {
                    throw new Error('Не найдены необходимые элементы интерфейса');
                }
                
                // Показываем загрузку
                loadingElement.style.display = 'block';
                errorElement.style.display = 'none';
                reportContentElement.style.display = 'none';

                // Проверяем наличие необходимых параметров
                const requiredParams = ['address', 'bedrooms', 'price', 'location_codes'];
                for (const param of requiredParams) {
                    if (!reportData[param]) {
                        throw new Error(`Отсутствует обязательный параметр: ${param}`);
                    }
                }
                
                console.log('📤 Отправляем запрос на /api/full_report с параметрами:', {
                    address: reportData.address,
                    bedrooms: reportData.bedrooms,
                    price: reportData.price,
                    area: reportData.area,
                    lat: reportData.lat,
                    lng: reportData.lng,
                    telegram_id: reportData.telegram_id,
                    location_codes: reportData.location_codes,
                    additional_data: {
                        age: reportData.age,
                        floor: reportData.floor,
                        heating: reportData.heating
                    }
                });

                // Вызываем API для получения полного отчета
                const response = await fetch('/api/full_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: reportData.address,
                        bedrooms: reportData.bedrooms,
                        price: reportData.price,
                        area: reportData.area,
                        lat: reportData.lat,
                        lng: reportData.lng,
                        telegram_id: reportData.telegram_id,
                        location_codes: reportData.location_codes,
                        additional_data: {
                            age: reportData.age,
                            floor: reportData.floor,
                            heating: reportData.heating
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ HTTP ошибка full_report:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('📊 Ответ API full_report:', data);

                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (!data.full_report) {
                    throw new Error('Сервер не вернул данные полного отчета');
                }

                // Скрываем загрузку и показываем отчет
                loadingElement.style.display = 'none';
                reportContentElement.style.display = 'block';

                // Отладочная информация
                console.log('📊 Получены данные от сервера:', data);
                console.log('🔍 Структура full_report:', data.full_report);

                // Заполняем данные отчета
                try {
                fillReportData(data);
                    console.log('✅ Основной отчет заполнен успешно');
                } catch (error) {
                    console.error('❌ Ошибка заполнения основного отчета:', error);
                    // Показываем сообщение об ошибке
                    const errorElement = document.getElementById('error');
                    if (errorElement) {
                        errorElement.style.display = 'block';
                        document.getElementById('error-message').textContent = `Ошибка заполнения отчета: ${error.message}`;
                    }
                    return;
                }
                
                // Загружаем данные о динамике цен (не блокируем основной отчет)
                if (reportData && reportData.location_codes && reportData.area) {
                    try {
                        await loadPriceTrendsData();
            } catch (error) {
                    console.error('❌ Ошибка загрузки данных о трендах, но отчет продолжает загружаться:', error);
                    // Показываем сообщение об ошибке в блоке трендов
                    const trendAnalysisElement = document.getElementById('trend-analysis');
                    if (trendAnalysisElement) {
                        trendAnalysisElement.textContent = `Ошибка загрузки данных о трендах: ${error.message}`;
                    }
                    
                    // Заполняем остальные поля значением "Недоступно"
                    const priceTrendElement = document.getElementById('price-trend');
                    if (priceTrendElement) {
                        priceTrendElement.textContent = 'Недоступно';
                    }
                    
                    const priceChangeElement = document.getElementById('price-change-3y');
                    if (priceChangeElement) {
                        priceChangeElement.textContent = 'Недоступно';
                    }
                    
                    const priceForecastElement = document.getElementById('price-forecast');
                    if (priceForecastElement) {
                        priceForecastElement.textContent = 'Недоступно';
                    }
                }
                } else {
                    console.log('⚠️ Отсутствуют необходимые данные для загрузки трендов:', {
                        hasLocationCodes: !!reportData?.location_codes,
                        hasArea: !!reportData?.area
                    });
                    // Показываем сообщение об отсутствии данных
                    const trendAnalysisElement = document.getElementById('trend-analysis');
                    if (trendAnalysisElement) {
                        trendAnalysisElement.textContent = 'Недостаточно данных для анализа трендов';
                    }
                    
                    // Заполняем остальные поля значением "Недоступно"
                    const priceTrendElement = document.getElementById('price-trend');
                    if (priceTrendElement) {
                        priceTrendElement.textContent = 'Недоступно';
                    }
                    
                    const priceChangeElement = document.getElementById('price-change-3y');
                    if (priceChangeElement) {
                        priceChangeElement.textContent = 'Недоступно';
                    }
                    
                    const priceForecastElement = document.getElementById('price-forecast');
                    if (priceForecastElement) {
                        priceForecastElement.textContent = 'Недоступно';
                    }
                }

            } catch (error) {
                console.error('❌ Ошибка загрузки отчета:', error);
                
                // Показываем ошибку, если элементы найдены
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                if (errorElement) {
                    errorElement.style.display = 'block';
                    const errorMessageElement = document.getElementById('error-message');
                    if (errorMessageElement) {
                        errorMessageElement.textContent = error.message || 'Неизвестная ошибка';
                    }
                }
            }
        }
        
        // Загружаем данные о динамике цен
        async function loadPriceTrendsData() {
            // Объявляем переменные в начале функции
            let timeoutId = null;
            let controller = null;
            
            try {
                // Проверяем, что reportData существует и содержит необходимые данные
                if (!reportData || !reportData.location_codes || !reportData.area) {
                    throw new Error('Отсутствуют необходимые данные для загрузки трендов');
                }
                
                console.log('📈 Загружаем данные о динамике цен...');
                console.log('📋 Отправляем данные:', {
                    location_codes: reportData.location_codes,
                    area: reportData.area
                });
                
                // Показываем индикатор загрузки в блоке трендов
                const trendAnalysisElement = document.getElementById('trend-analysis');
                if (trendAnalysisElement) {
                    trendAnalysisElement.textContent = 'Загружаем данные о трендах...';
                }
                
                // Создаем AbortController для таймаута
                controller = new AbortController();
                timeoutId = setTimeout(() => {
                    console.log('⏰ Таймаут запроса price_trends (10 секунд)');
                    controller.abort();
                }, 10000); // 10 секунд таймаут
                
                const response = await fetch('/api/price_trends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        location_codes: reportData.location_codes,
                        area: reportData.area
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                console.log('⏰ Таймаут очищен, ответ получен');

                console.log('📡 Ответ сервера получен, статус:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ HTTP ошибка price_trends:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const trendsData = await response.json();
                console.log('📊 Данные о динамике цен получены:', trendsData);

                if (trendsData.error) {
                    console.error('❌ API вернул ошибку:', trendsData.error);
                    throw new Error(trendsData.error);
                }
                
                if (!trendsData.trend && !trendsData.chart_data) {
                    console.log('⚠️ Сервер вернул пустые данные о трендах');
                    // Показываем сообщение об отсутствии данных
                    const trendAnalysisElement = document.getElementById('trend-analysis');
                    if (trendAnalysisElement) {
                        trendAnalysisElement.textContent = 'Данные о трендах цен для данной локации отсутствуют';
                    }
                    
                    // Заполняем остальные поля значением "Недоступно"
                    const priceTrendElement = document.getElementById('price-trend');
                    if (priceTrendElement) {
                        priceTrendElement.textContent = 'Недоступно';
                    }
                    
                    const priceChangeElement = document.getElementById('price-change-3y');
                    if (priceChangeElement) {
                        priceChangeElement.textContent = 'Недоступно';
                    }
                    
                    const priceForecastElement = document.getElementById('price-forecast');
                    if (priceForecastElement) {
                        priceForecastElement.textContent = 'Недоступно';
                    }
                    
                    return;
                }

                // Проверяем, есть ли данные для отображения
                if (!trendsData.chart_data || trendsData.chart_data.length === 0) {
                    console.log('⚠️ Данные о трендах цен отсутствуют');
                    // Показываем сообщение об отсутствии данных
                    const trendAnalysisElement = document.getElementById('trend-analysis');
                    if (trendAnalysisElement) {
                        trendAnalysisElement.textContent = 'Данные о трендах цен для данной локации отсутствуют';
                    }
                    
                    // Заполняем остальные поля значением "Недоступно"
                    const priceTrendElement = document.getElementById('price-trend');
                    if (priceTrendElement) {
                        priceTrendElement.textContent = 'Недоступно';
                    }
                    
                    const priceChangeElement = document.getElementById('price-change-3y');
                    if (priceChangeElement) {
                        priceChangeElement.textContent = 'Недоступно';
                    }
                    
                    const priceForecastElement = document.getElementById('price-forecast');
                    if (priceForecastElement) {
                        priceForecastElement.textContent = 'Недоступно';
                    }
                    
                    return;
                }

                // Заполняем данные о трендах
                fillPriceTrendsData(trendsData);
                
                // Строим график
                buildPriceChart(trendsData);
                
                console.log('✅ Загрузка данных о динамике цен завершена успешно');
                
            } catch (error) {
                console.error('❌ Ошибка загрузки данных о динамике цен:', error);
                
                // Очищаем таймаут в случае ошибки
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                
                let errorMessage = 'Ошибка загрузки данных о трендах';
                if (error.name === 'AbortError') {
                    errorMessage = 'Превышено время ожидания ответа сервера';
                } else if (error.message) {
                    errorMessage = `Ошибка: ${error.message}`;
                }
                
                // Показываем сообщение об ошибке в блоке трендов
                const trendAnalysisElement = document.getElementById('trend-analysis');
                if (trendAnalysisElement) {
                    trendAnalysisElement.textContent = errorMessage;
                }
                
                // Также показываем ошибку в других элементах
                const priceTrendElement = document.getElementById('price-trend');
                if (priceTrendElement) {
                    priceTrendElement.textContent = 'Недоступно';
                }
                
                const priceChangeElement = document.getElementById('price-change-3y');
                if (priceChangeElement) {
                    priceChangeElement.textContent = 'Недоступно';
                }
                
                const priceForecastElement = document.getElementById('price-forecast');
                if (priceForecastElement) {
                    priceForecastElement.textContent = 'Недоступно';
                }
            }
        }
        
        // Заполняем данные о трендах цен
        function fillPriceTrendsData(trendsData) {
            try {
                console.log('🔧 Заполняем данные о трендах цен...');
                console.log('📊 Данные для заполнения:', trendsData);
                
                // Тренд цен
                const trendElement = document.getElementById('price-trend');
                if (trendElement && trendsData.trend) {
                    trendElement.textContent = trendsData.trend;
                } else {
                    console.warn('⚠️ Элемент price-trend не найден или данные тренда отсутствуют');
                }
                
                // Изменение за 3 года
                const change3yElement = document.getElementById('price-change-3y');
                if (change3yElement && trendsData.change_3y !== undefined) {
                    const changePercent = trendsData.change_3y;
                    const changeText = changePercent >= 0 ? 
                        `+${changePercent.toFixed(1)}%` : 
                        `${changePercent.toFixed(1)}%`;
                    change3yElement.textContent = changeText;
                } else {
                    console.warn('⚠️ Элемент price-change-3y не найден или данные изменения отсутствуют');
                }
                
                // Прогноз на 3 месяца
                const forecastElement = document.getElementById('price-forecast');
                if (forecastElement && trendsData.forecast_3m !== undefined) {
                    const forecastPercent = trendsData.forecast_3m;
                    const forecastText = forecastPercent >= 0 ? 
                        `+${forecastPercent.toFixed(1)}%` : 
                        `${forecastPercent.toFixed(1)}%`;
                    forecastElement.textContent = forecastText;
                } else {
                    console.warn('⚠️ Элемент price-forecast не найден или данные прогноза отсутствуют');
                }
                
                // Анализ тренда
                const analysisElement = document.getElementById('trend-analysis');
                if (analysisElement && trendsData.analysis) {
                    analysisElement.textContent = trendsData.analysis;
                } else {
                    console.warn('⚠️ Элемент trend-analysis не найден или данные анализа отсутствуют');
                }
                
                // Рекомендация по тренду
                const recommendationElement = document.getElementById('trend-recommendation');
                if (recommendationElement && trendsData.recommendation) {
                    recommendationElement.textContent = trendsData.recommendation;
                } else {
                    console.warn('⚠️ Элемент trend-recommendation не найден или данные рекомендации отсутствуют');
                }
                
                console.log('✅ Данные о трендах цен заполнены');
                
            } catch (error) {
                console.error('❌ Ошибка заполнения данных о трендах цен:', error);
                // Показываем сообщение об ошибке
                const trendAnalysisElement = document.getElementById('trend-analysis');
                if (trendAnalysisElement) {
                    trendAnalysisElement.textContent = `Ошибка заполнения данных: ${error.message}`;
                }
            }
        }
        
        // Строим график динамики цен
        function buildPriceChart(trendsData) {
            try {
                console.log('📊 Строим график динамики цен...');
                
                const ctx = document.getElementById('priceChart');
                if (!ctx) {
                    console.error('Canvas элемент не найден');
                    return;
                }
                
                // Уничтожаем предыдущий график, если он существует
                if (window.priceChart) {
                    window.priceChart.destroy();
                }
                
                const chartData = trendsData.chart_data || [];
                
                if (chartData.length === 0) {
                    console.warn('⚠️ Данные для графика отсутствуют');
                    return;
                }
                
                const labels = chartData.map(item => `${item.month}/${item.year}`);
                const prices = chartData.map(item => item.total_price);
                
                window.priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Цена объекта (€)',
                            data: prices,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Динамика цен за 3 года + прогноз на 3 месяца'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Цена (€)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Период'
                                }
                            }
                        }
                    }
                });
                
                console.log('✅ График динамики цен построен');
                
            } catch (error) {
                console.error('❌ Ошибка построения графика:', error);
                // Показываем сообщение об ошибке в блоке трендов
                const trendAnalysisElement = document.getElementById('trend-analysis');
                if (trendAnalysisElement) {
                    trendAnalysisElement.textContent = `Ошибка построения графика: ${error.message}`;
                }
            }
        }

        // Заполняем данные отчета
        function fillReportData(data) {
            console.log('🔧 Начинаем заполнение отчета...');
            console.log('📊 Структура данных:', Object.keys(data));
            console.log('📋 Данные full_report:', data.full_report);
            
            // Проверяем существование элементов
            const elements = {
                'object-address': document.getElementById('object-address'),
                'object-bedrooms': document.getElementById('object-bedrooms'),
                'object-price': document.getElementById('object-price'),
                'object-age': document.getElementById('object-age'),
                'object-floor': document.getElementById('object-floor'),
                'object-heating': document.getElementById('object-heating')
            };
            
            // Проверяем, что все элементы найдены
            for (const [id, element] of Object.entries(elements)) {
                if (!element) {
                    console.error(`❌ Элемент ${id} не найден в DOM`);
                    return;
                }
            }
            
            // Основная информация об объекте
            elements['object-address'].textContent = reportData.address;
            elements['object-bedrooms'].textContent = reportData.bedrooms;
            elements['object-price'].textContent = `€${Number(reportData.price).toLocaleString('ru-RU')}`;
            
            // Площадь объекта
            const areaElement = document.getElementById('object-area');
            if (areaElement) {
                const areaValue = reportData.area && reportData.area !== 'unknown' ? 
                    `${reportData.area} м²` : 'Не указано';
                areaElement.textContent = areaValue;
            }
            
            // Дополнительные данные - используем новую структуру из full_report
            if (data.full_report && data.full_report.detailed_characteristics) {
                const characteristics = data.full_report.detailed_characteristics;
                console.log('🔍 Найдены характеристики:', characteristics);
                
                // Возраст объекта
                const ageText = characteristics.age && characteristics.age.name ? 
                    characteristics.age.name : 
                    (reportData.age === 'unknown' ? 'Не известно' : 'Не указано');
                elements['object-age'].textContent = ageText;
                
                // Этаж
                const floorText = characteristics.floor && characteristics.floor.name ? 
                    characteristics.floor.name : 
                    (reportData.floor === 'unknown' ? 'Не известно' : 'Не указано');
                elements['object-floor'].textContent = floorText;
                
                // Отопление
                const heatingText = characteristics.heating && characteristics.heating.name ? 
                    characteristics.heating.name : 
                    (reportData.heating === 'unknown' ? 'Не известно' : 'Не указано');
                elements['object-heating'].textContent = heatingText;
                
                console.log('✅ Характеристики объекта загружены:', { ageText, floorText, heatingText });
            } else {
                // Fallback на старые данные
                const ageText = reportData.age === 'unknown' ? 'Не известно' : reportData.age;
                const floorText = reportData.floor === 'unknown' ? 'Не известно' : reportData.floor;
                const heatingText = reportData.heating === 'unknown' ? 'Не известно' : reportData.heating;
                
                elements['object-age'].textContent = ageText;
                elements['object-floor'].textContent = floorText;
                elements['object-heating'].textContent = heatingText;
                
                console.log('⚠️ Используются fallback данные:', { ageText, floorText, heatingText });
            }

            // Рыночный анализ - рыночные данные для сравнения цен
            if (data.full_report && data.full_report.simple_report) {
                const simpleReport = data.full_report.simple_report;
                console.log('📊 Рыночный анализ:', simpleReport);
            }
            
            // Рыночные данные для сравнения цен
            if (data.full_report && data.full_report.market_comparison) {
                const marketComparison = data.full_report.market_comparison;
                console.log('📊 Рыночные данные для сравнения:', marketComparison);
                
                // Заполняем сравнение по возрасту
                if (marketComparison.age) {
                    const ageComparison = marketComparison.age;
                    const ageText = `€${ageComparison.min_price.toLocaleString('ru-RU')} - €${Number(reportData.price).toLocaleString('ru-RU')} - €${ageComparison.max_price.toLocaleString('ru-RU')} (отклонение: ${ageComparison.deviation_min.toFixed(1)}% до ${ageComparison.deviation_max.toFixed(1)}%)`;
                    document.getElementById('age-comparison').textContent = ageText;
                }
                
                // Заполняем сравнение по этажу
                if (marketComparison.floor) {
                    const floorComparison = marketComparison.floor;
                    const floorText = `€${floorComparison.min_price.toLocaleString('ru-RU')} - €${Number(reportData.price).toLocaleString('ru-RU')} - €${floorComparison.max_price.toLocaleString('ru-RU')} (отклонение: ${floorComparison.deviation_min.toFixed(1)}% до ${floorComparison.deviation_max.toFixed(1)}%)`;
                    document.getElementById('floor-comparison').textContent = floorText;
                }
                
                // Заполняем сравнение по отоплению
                if (marketComparison.heating) {
                    const heatingComparison = marketComparison.heating;
                    const heatingText = `€${heatingComparison.min_price.toLocaleString('ru-RU')} - €${Number(reportData.price).toLocaleString('ru-RU')} - €${heatingComparison.max_price.toLocaleString('ru-RU')} (отклонение: ${heatingComparison.deviation_min.toFixed(1)}% до ${heatingComparison.deviation_max.toFixed(1)}%)`;
                    document.getElementById('heating-comparison').textContent = heatingText;
                }
                
                // Заполняем сравнение по типу дома - УБРАНО по требованию
                
                // Заполняем итоговое сравнение
                if (marketComparison.final) {
                    const finalComparison = marketComparison.final;
                    const finalText = `€${finalComparison.avg_min_price.toLocaleString('ru-RU')} - €${Number(reportData.price).toLocaleString('ru-RU')} - €${finalComparison.avg_max_price.toLocaleString('ru-RU')} (отклонение: ${finalComparison.deviation_min.toFixed(1)}% до ${finalComparison.deviation_max.toFixed(1)}%)`;
                    document.getElementById('final-comparison').textContent = finalText;
                }
                
                // Заполняем вывод по цене
                if (marketComparison.price_conclusion) {
                    document.getElementById('price-conclusion').textContent = marketComparison.price_conclusion;
                }
                
                // Показываем информацию о конвертации валют, если она применялась
                if (data.full_report && data.full_report.currency_info) {
                    const currencyInfo = data.full_report.currency_info;
                    if (currencyInfo.conversion_applied) {
                        const currencyElement = document.getElementById('currency-info');
                        const currencyValueElement = document.getElementById('currency-info-value');
                        
                        if (currencyInfo.currency_rate && currencyInfo.currency_rate.try) {
                            const tryRate = currencyInfo.currency_rate.try;
                            const date = new Date(currencyInfo.currency_rate.created_at).toLocaleDateString('ru-RU');
                            currencyValueElement.textContent = `Курс на ${date}: 1 EUR = ${tryRate.toFixed(4)} TRY. Все цены конвертированы в евро.`;
                        } else {
                            currencyValueElement.textContent = 'Все цены конвертированы в евро.';
                        }
                        
                        currencyElement.style.display = 'block';
                    }
                }
            }

            // Анализ динамики цен - теперь загружается отдельно через loadPriceTrendsData()

            // Анализ аренды
            if (data.full_report && data.full_report.rental_analysis) {
                const rentalAnalysis = data.full_report.rental_analysis;
                document.getElementById('max-rental-rate').textContent = rentalAnalysis.rental_recommendation || 'Не определен';
                document.getElementById('annual-rental-yield').textContent = rentalAnalysis.annual_yield || 'Не определен';
                document.getElementById('rental-recommendation').textContent = rentalAnalysis.rental_recommendation || 'Не определен';
            }

            // ROI данные
            if (data.full_report && data.full_report.roi) {
                const roiData = data.full_report.roi;
                if (roiData.short_term) {
                    document.getElementById('short-term-income').textContent = `€${roiData.short_term.monthly_income?.toLocaleString('ru-RU') || '-'}`;
                }
                if (roiData.long_term) {
                    document.getElementById('long-term-income').textContent = `€${roiData.long_term.annual_income?.toLocaleString('ru-RU') || '-'}`;
                }
                if (roiData.price_growth) {
                    document.getElementById('price-growth').textContent = `${(roiData.price_growth * 100).toFixed(1)}%`;
                }
                if (roiData.short_term?.roi) {
                    document.getElementById('roi-with-rent').textContent = `${roiData.short_term.roi.toFixed(1)}%`;
                }
                if (roiData.no_rent?.roi) {
                    document.getElementById('roi-without-rent').textContent = `${roiData.no_rent.roi.toFixed(1)}%`;
                }
            }

            // Альтернативные инвестиции
            if (data.full_report && data.full_report.alternatives) {
                const alternativesGrid = document.getElementById('alternatives-grid');
                alternativesGrid.innerHTML = '';
                
                data.full_report.alternatives.forEach(alt => {
                    const altItem = document.createElement('div');
                    altItem.className = 'info-item';
                    altItem.innerHTML = `
                        <div class="info-label">${alt.name}</div>
                        <div class="info-value">${(alt.yield * 100).toFixed(1)}%</div>
                    `;
                    alternativesGrid.appendChild(altItem);
                });
            }

            // Макроэкономические данные
            if (data.full_report && data.full_report.macro) {
                const macroData = data.full_report.macro;
                if (macroData.inflation !== undefined) {
                    document.getElementById('inflation').textContent = `${macroData.inflation.toFixed(1)}%`;
                }
                if (macroData.eur_try !== undefined) {
                    document.getElementById('eur-try').textContent = macroData.eur_try.toFixed(2);
                }
                if (macroData.gdp_growth !== undefined) {
                    document.getElementById('gdp-growth').textContent = `${macroData.gdp_growth.toFixed(1)}%`;
                }
                if (macroData.refi_rate !== undefined) {
                    document.getElementById('refi-rate').textContent = `${macroData.refi_rate.toFixed(1)}%`;
                }
            }

            // Налоги
            if (data.full_report && data.full_report.taxes) {
                const taxesGrid = document.getElementById('taxes-grid');
                taxesGrid.innerHTML = '';
                
                Object.entries(data.full_report.taxes).forEach(([key, value]) => {
                    const taxItem = document.createElement('div');
                    taxItem.className = 'info-item';
                    taxItem.innerHTML = `
                        <div class="info-label">${getTaxLabel(key)}</div>
                        <div class="info-value">${formatTaxValue(value)}</div>
                    `;
                    taxesGrid.appendChild(taxItem);
                });
            }

            // Риски и ликвидность
            if (data.full_report && data.full_report.liquidity) {
                document.getElementById('liquidity').textContent = data.full_report.liquidity;
            }
            if (data.full_report && data.full_report.district) {
                document.getElementById('district').textContent = data.full_report.district;
            }

            // Список рисков
            if (data.full_report && data.full_report.risks && Array.isArray(data.full_report.risks)) {
                const risksList = document.getElementById('risks-list');
                risksList.innerHTML = '';
                
                data.full_report.risks.forEach(risk => {
                    const riskItem = document.createElement('div');
                    riskItem.className = 'info-item';
                    riskItem.style.marginBottom = '10px';
                    riskItem.innerHTML = `
                        <div class="info-value">⚠️ ${risk}</div>
                    `;
                    risksList.appendChild(riskItem);
                });
            }
            
            console.log('✅ Заполнение отчета завершено успешно');
        }

        // Получаем читаемые названия налогов
        function getTaxLabel(key) {
            const labels = {
                'transfer_tax': 'Налог на передачу',
                'stamp_duty': 'Гербовый сбор',
                'notary': 'Услуги нотариуса',
                'annual_property_tax': 'Годовой налог на недвижимость',
                'rental_income_tax': 'Налог на доход от аренды',
                'capital_gains_tax': 'Налог на прирост капитала'
            };
            return labels[key] || key;
        }

        // Форматируем значения налогов
        function formatTaxValue(value) {
            if (typeof value === 'number') {
                if (value < 1) {
                    return `${(value * 100).toFixed(1)}%`;
                } else {
                    return `€${value.toLocaleString('ru-RU')}`;
                }
            }
            return value;
        }

        // Скачать PDF
        function downloadPDF() {
            // Здесь будет логика скачивания PDF
            alert('Функция скачивания PDF будет добавлена позже');
        }

        // Сохранить отчет
        function saveReport() {
            // Здесь будет логика сохранения отчета
            alert('Функция сохранения отчета будет добавлена позже');
        }

        // Вернуться назад
        function goBack() {
            window.history.back();
        }

        // Загружаем отчет при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM загружен, вызываем loadFullReport');
            loadFullReport();
        });
    </script>
</body>
</html>
