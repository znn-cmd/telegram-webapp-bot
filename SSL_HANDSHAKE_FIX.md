# Решение проблемы SSL Handshake Timeout

## Описание проблемы
Ошибка `_ssl.c:999: The handshake operation timed out` возникает при попытке установить SSL соединение с Supabase. Это может быть вызвано несколькими причинами:

1. Сетевые проблемы (медленное соединение, высокая задержка)
2. Проблемы с SSL сертификатами
3. Неправильная конфигурация клиента
4. Ограничения файрвола или прокси

## Внесенные изменения

### 1. Улучшенная конфигурация Supabase клиента (app.py)

Добавлены следующие улучшения:
- Увеличен таймаут подключения до 30 секунд
- Настроены лимиты подключений для предотвращения перегрузки
- Включена поддержка HTTP/2 для лучшей производительности
- Добавлена возможность отключения SSL проверки через переменную окружения

```python
client_options = ClientOptions(
    timeout=30,
    httpx_client=httpx.Client(
        timeout=httpx.Timeout(30.0, connect=10.0),
        verify=ssl_verify,
        follow_redirects=True,
        limits=httpx.Limits(max_keepalive_connections=5, max_connections=10),
        http2=True,
    )
)
```

### 2. Функция повторных попыток

Добавлена функция `execute_with_retry()` для автоматического повтора запросов при SSL ошибках:
- До 3 попыток с экспоненциальной задержкой
- Специальная обработка SSL ошибок
- Подробное логирование для диагностики

### 3. Обновлены зависимости

В `requirements.txt` добавлена библиотека `httpx==0.25.0` для улучшенной работы с HTTP/2 и SSL.

### 4. Диагностические инструменты

Созданы два вспомогательных скрипта:

- `test_ssl_connection.py` - для тестирования различных аспектов подключения
- `fix_ssl_issues.sh` - для автоматического исправления распространенных проблем

## Как использовать

### Быстрое решение

1. Запустите скрипт для исправления SSL проблем:
   ```bash
   sudo ./fix_ssl_issues.sh
   ```

2. Перезапустите приложение:
   ```bash
   python app.py
   ```

### Диагностика

Если проблема сохраняется, запустите диагностический скрипт:
```bash
python test_ssl_connection.py
```

### Временное отключение SSL проверки (НЕ для продакшена!)

Если ничего не помогает, можно временно отключить SSL проверку:
```bash
export SUPABASE_SSL_VERIFY=false
python app.py
```

⚠️ **ВАЖНО**: Это небезопасно и должно использоваться только для отладки!

## Дополнительные рекомендации

1. **Проверьте сетевое соединение**:
   ```bash
   ping supabase.com
   curl -I https://supabase.com
   ```

2. **Обновите системные сертификаты**:
   ```bash
   sudo apt-get update
   sudo apt-get install ca-certificates
   sudo update-ca-certificates
   ```

3. **Проверьте настройки прокси**:
   Если используется прокси, убедитесь что переменные окружения настроены правильно:
   ```bash
   export HTTP_PROXY=http://proxy.example.com:8080
   export HTTPS_PROXY=http://proxy.example.com:8080
   ```

4. **Используйте VPN или другое сетевое подключение**:
   Иногда проблема может быть связана с блокировкой на уровне провайдера.

## Мониторинг

После применения исправлений следите за логами:
- SSL ошибки теперь будут автоматически повторяться до 3 раз
- В логах будет видна детальная информация о каждой попытке
- При успешном подключении появится сообщение "✅ Supabase клиент успешно инициализирован"

## Контакты для поддержки

Если проблема не решается:
1. Проверьте статус Supabase: https://status.supabase.com/
2. Обратитесь в поддержку Supabase с логами из `test_ssl_connection.py`
3. Проверьте настройки файрвола и сетевой инфраструктуры